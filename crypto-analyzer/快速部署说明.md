# 交易控制功能 - 快速部署说明

## 当前状态

代码已经全部推送到GitHub仓库，包括：
- ✅ 前端交易控制按钮 (futures_trading.html, coin_futures_trading.html)
- ✅ API接口 (app/api/trading_control_api.py)
- ✅ 后端服务集成 (smart_trader_service.py, coin_futures_trader_service.py)
- ✅ 数据库迁移脚本 (scripts/migrations/023_create_trading_control_table.sql)
- ✅ 美观的自定义对话框

## 部署步骤

### 在服务器 13.212.252.171 上执行：

#### 1. 拉取最新代码
```bash
cd /path/to/crypto-analyzer
git pull
```

#### 2. 创建数据库表
```bash
python3 -c "
import pymysql
from dotenv import load_dotenv
import os

load_dotenv()

db_config = {
    'host': os.getenv('DB_HOST'),
    'port': int(os.getenv('DB_PORT', 3306)),
    'user': os.getenv('DB_USER'),
    'password': os.getenv('DB_PASSWORD'),
    'database': os.getenv('DB_NAME'),
    'charset': 'utf8mb4'
}

conn = pymysql.connect(**db_config)
cursor = conn.cursor()

# 读取并执行SQL
with open('scripts/migrations/023_create_trading_control_table.sql', 'r', encoding='utf-8') as f:
    sql = f.read()
    statements = [s.strip() for s in sql.split(';') if s.strip()]
    for stmt in statements:
        cursor.execute(stmt)

conn.commit()
cursor.close()
conn.close()
print('交易控制表创建成功')
"
```

#### 3. 重启服务

**如果使用 supervisor:**
```bash
supervisorctl restart crypto-api
supervisorctl restart smart-trader
supervisorctl restart coin-futures-trader
```

**如果使用 pm2:**
```bash
pm2 restart crypto-api
pm2 restart smart-trader
pm2 restart coin-futures-trader
```

**如果手动运行:**
```bash
# 停止旧进程
pkill -f "python.*main.py"
pkill -f "python.*smart_trader_service.py"
pkill -f "python.*coin_futures_trader_service.py"

# 启动新进程
nohup python app/main.py > logs/api.log 2>&1 &
nohup python smart_trader_service.py > logs/smart_trader.log 2>&1 &
nohup python coin_futures_trader_service.py > logs/coin_futures.log 2>&1 &
```

## 验证部署

### 1. 检查API是否正常
```bash
curl http://localhost:9020/api/trading-control/status/2/usdt_futures
```

预期响应：
```json
{
  "account_id": 2,
  "trading_type": "usdt_futures",
  "trading_enabled": true,
  "updated_by": "system",
  "updated_at": "2026-02-02 13:10:27"
}
```

### 2. 测试切换功能
```bash
curl -X POST http://localhost:9020/api/trading-control/toggle \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": 2,
    "trading_type": "usdt_futures",
    "trading_enabled": false,
    "updated_by": "test"
  }'
```

### 3. 访问前端页面

打开浏览器访问：
- U本位合约: http://13.212.252.171:9020/futures_trading
- 币本位合约: http://13.212.252.171:9020/coin_futures_trading

点击右上角的交易控制按钮测试功能。

## 功能说明

### 交易控制按钮

**位置**: 页面右上角，刷新按钮左边

**状态显示**:
- 🔴 红色按钮 "停止交易" = 交易启用中
- 🟢 绿色按钮 "启动交易" = 交易已停止

**点击效果**:
1. 弹出美观的确认对话框
2. 确认后发送API请求
3. 按钮状态和颜色更新
4. 显示成功/失败提示

### 后端集成

**U本位合约服务** (smart_trader_service.py):
- 主循环第5.5步检查交易开关
- 停止时跳过开仓，继续持仓管理
- 日志: `[TRADING-DISABLED] ⏸️ U本位合约交易已停止`

**币本位合约服务** (coin_futures_trader_service.py):
- 主循环第5.5步检查交易开关
- 停止时跳过开仓，继续持仓管理
- 日志: `[TRADING-DISABLED] ⏸️ 币本位合约交易已停止`

### 数据库查询

查看当前状态:
```sql
SELECT * FROM trading_control;
```

手动修改状态:
```sql
-- 停止U本位合约交易
UPDATE trading_control
SET trading_enabled = FALSE
WHERE account_id = 2 AND trading_type = 'usdt_futures';

-- 启动U本位合约交易
UPDATE trading_control
SET trading_enabled = TRUE
WHERE account_id = 2 AND trading_type = 'usdt_futures';
```

## 故障排查

### 问题1: 点击按钮没有反应

**检查**:
```bash
# 查看API日志
tail -f logs/api.log | grep trading-control

# 查看浏览器控制台
# F12 -> Console 查看JavaScript错误
```

**可能原因**:
- API服务未重启
- 路由未注册
- 数据库连接失败

### 问题2: 切换后服务仍在开仓

**检查**:
```bash
# 查看交易服务日志
tail -f logs/smart_trader.log | grep TRADING-DISABLED

# 检查数据库状态
mysql -h 13.212.252.171 -u admin -p binance-data \
  -e "SELECT * FROM trading_control;"
```

**可能原因**:
- 交易服务未重启
- 数据库查询失败
- 缓存未更新

### 问题3: 数据库表不存在

**解决**:
```bash
# 手动执行SQL
mysql -h 13.212.252.171 -u admin -p binance-data \
  < scripts/migrations/023_create_trading_control_table.sql
```

## 回滚方案

如果部署出现问题，可以回滚：

```bash
# 回滚到上一个版本
git reset --hard db6defa^

# 删除数据库表
mysql -h 13.212.252.171 -u admin -p binance-data \
  -e "DROP TABLE IF EXISTS trading_control;"

# 重启服务
supervisorctl restart all
```

## 联系方式

如有问题，请联系：
- GitHub Issues: https://github.com/shanglily01-lab/test2/issues
- 提供详细的错误日志和复现步骤

---

**部署时间**: 2026-02-02
**Git Commit**: db6defa
**部署人**: Claude Sonnet 4.5
