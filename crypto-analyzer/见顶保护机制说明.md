# 见顶保护机制说明

## 当前状态: ✅ 已实现

用户需求: "先实现见顶不开多单的逻辑，见顶反转 这个或许没那么急迫"

**结论**: 见顶保护机制已经在 `big4_trend_detector.py` 中实现，无需额外开发。

---

## 工作原理

### 1. 触顶检测逻辑 (big4_trend_detector.py:511-516)

```python
# 判断触顶 (剧烈上涨后可能回调)
rise_pct = (period_high - period_low) / period_low * 100
if rise_pct >= self.TOP_RISE_THRESHOLD and drop_from_high < 0:
    top_detected = True
    trigger_symbols.append(f"{symbol.split('/')[0]}触顶(+{rise_pct:.1f}%→{drop_from_high:.1f}%)")
    max_rise = max(max_rise, rise_pct)
```

### 2. 检测条件

```python
EMERGENCY_DETECTION_HOURS = 4   # 检测最近4小时
TOP_RISE_THRESHOLD = 5.0        # 涨幅超过5%
```

**触发条件**:
- 最近4小时内，Big4币种有剧烈上涨 >= 5%
- 当前价格已经从最高点回落 (drop_from_high < 0)

### 3. 保护机制 (big4_trend_detector.py:737-738)

```python
block_long = top_detected    # 触顶时禁止做多
block_short = bottom_detected  # 触底时禁止做空
```

### 4. 执行层面 (smart_trader_service.py:3123-3125)

```python
emergency = big4_result.get('emergency_intervention', {})
if emergency.get('block_long') and new_side == 'LONG':
    logger.warning(f"🚨 [EMERGENCY-BLOCK] {symbol} 触顶反转风险,禁止做多 | {emergency.get('details', '')}")
    continue  # 跳过该做多信号
```

### 5. 持续时长

```python
BLOCK_DURATION_HOURS = 2  # 触发后阻止交易2小时
```

一旦检测到触顶，系统会：
1. 保存到 `emergency_intervention` 数据库表
2. 在接下来2小时内，禁止开新的做多仓位
3. 已有的多单不受影响，可以正常平仓

---

## 对称设计: 触顶 vs 触底

| 类型 | 触底 (Bottom) | 触顶 (Top) |
|------|--------------|-----------|
| **检测条件** | 4H内跌幅 >= -5% | 4H内涨幅 >= 5% |
| **保护动作** | 禁止做空 (block_short) | 禁止做多 (block_long) |
| **持续时长** | 2小时 | 2小时 |
| **反弹交易** | ✅ 开45分钟反弹窗口 | ❌ 暂不开做空窗口 |

---

## 与反弹交易的区别

### 触底 = 紧急保护 + 反弹机会

**紧急保护** (4H跌幅 >= 5%):
- 触发条件: 宽松 (5%)
- 目的: 快速反应，防止追空
- 时长: 2小时

**反弹交易** (1H长下影线 >= 3% + 大周期过滤):
- 触发条件: 严格 (下影3% + 72H跌8% + 24H跌4% + 首次触底 + Big4)
- 目的: 精准捕捉真深V反转的反弹机会
- 时长: 45分钟窗口

### 触顶 = 仅保护

**当前实现**:
- 触发条件: 4H涨幅 >= 5%
- 保护动作: 禁止做多2小时
- 无反弹交易: 不开做空窗口 (用户决定暂不急迫)

---

## 数据验证

### 实际案例分析 (analyze_top_reversal.py)

检查了2月5-7日的Big4数据，发现触顶案例：

```
ETH 2月8日 00:00:
  上影线: 3.6%
  72H涨幅: 22.4%
  24H涨幅: 6.6%
  首次触顶: ✅

  后续回调: 仅 -0.59% ❌
  结论: 触顶后回调力度弱于触底后反弹
```

**分析结论**:
1. 触顶信号相对较少 (7天内仅1次)
2. 回调力度不如触底反弹可靠 (-0.59% vs 4.5%平均反弹)
3. 用户决策: 先实现保护机制，做空策略暂缓

---

## 参数调整建议

### 当前参数 (触顶保护)

```python
TOP_RISE_THRESHOLD = 5.0  # 涨幅超过5%触发
BLOCK_DURATION_HOURS = 2  # 禁止做多2小时
```

### 是否需要调整？

**选项1: 保持现状 (5%)**
- 优点: 快速反应，防止追涨
- 缺点: 可能过于敏感

**选项2: 对称调整 (8%)**
- 优点: 与反弹交易对称 (72H跌8% vs 72H涨8%)
- 缺点: 可能反应稍慢

**建议**: 保持5%，因为：
1. 保护机制应该更敏感 (宁可错杀)
2. 反弹交易有45分钟窗口补偿
3. 做多追涨风险更高

---

## 未来扩展: 做空反弹策略 (暂不实现)

如果未来要实现"见顶做空"，可以参考反弹交易的对称逻辑：

### 触发条件 (对称于深V反弹)

```python
真见顶反转 = {
    1. 长上影线 >= 3% (当前1H K线)
    AND
    2. 72H持续上涨 >= 8% (前3天从低点)
    AND
    3. 24H加速上涨 >= 4% (最近1天)
    AND
    4. 首次触顶 (24H内首次出现长上影线)
    AND
    5. Big4币种
}
```

### 参数设置 (对称于反弹交易)

```python
position_size_pct = 70    # 仓位70%
take_profit_pct = 3.5     # 止盈3.5%
stop_loss_pct = 2.5       # 止损2.5%
window_duration = 45      # 45分钟窗口
```

---

## 总结

✅ **已实现**: 见顶保护机制 (禁止做多)
- 触发: 4H涨幅 >= 5%
- 保护: 禁止做多2小时
- 位置: big4_trend_detector.py:511-516

⏳ **暂不实现**: 见顶做空策略
- 原因: 数据显示回调力度弱 (-0.59%)
- 用户决策: 保护优先，做空暂缓

📊 **对比数据**:
- 触底反弹: 平均4.5%反弹，值得交易 ✅
- 触顶回调: 仅-0.59%回调，不够理想 ⚠️

---

## 部署状态

**当前代码已包含完整功能:**
1. ✅ 触顶检测逻辑
2. ✅ 禁止做多机制
3. ✅ 数据库记录 (emergency_intervention表)
4. ✅ 交易层面拦截 (smart_trader_service.py)

**无需额外部署，系统已生效！**

如需调整参数，修改 `big4_trend_detector.py` 第42行:
```python
self.TOP_RISE_THRESHOLD = 5.0  # 可调整触发阈值
```

---

**文档版本**: v1.0
**更新时间**: 2026-02-09
**用户需求**: "先实现见顶不开多单的逻辑" ✅ 已满足
