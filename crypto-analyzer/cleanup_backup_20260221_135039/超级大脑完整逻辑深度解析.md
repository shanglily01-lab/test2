# è¶…çº§å¤§è„‘(Big4)äº¤æ˜“ç³»ç»Ÿ - å®Œæ•´é€»è¾‘æ·±åº¦è§£æ

> **æ–‡æ¡£ç‰ˆæœ¬**: V4.0 å®Œæ•´æ·±åº¦ç‰ˆ
> **æœ€åæ›´æ–°**: 2026-02-07
> **é€‚ç”¨èŒƒå›´**: åˆçº¦äº¤æ˜“ç³»ç»Ÿ
> **æ–‡æ¡£ä½œè€…**: åŸºäºä»£ç å®ç°å’Œç°æœ‰æ–‡æ¡£çš„æ·±åº¦æ•´åˆ

---

## ğŸ“‹ æ–‡æ¡£å¯¼èˆª

1. [ç³»ç»Ÿæ¦‚è¿°](#ä¸€ç³»ç»Ÿæ¦‚è¿°)
2. [Big4è¶‹åŠ¿æ£€æµ‹ç³»ç»Ÿ](#äºŒbig4è¶‹åŠ¿æ£€æµ‹ç³»ç»Ÿæ·±åº¦è§£æ)
3. [æ™ºèƒ½åˆ†æ‰¹å»ºä»“ç³»ç»Ÿ](#ä¸‰æ™ºèƒ½åˆ†æ‰¹å»ºä»“ç³»ç»Ÿæ·±åº¦è§£æ)
4. [æ™ºèƒ½å¹³ä»“ä¼˜åŒ–ç³»ç»Ÿ](#å››æ™ºèƒ½å¹³ä»“ä¼˜åŒ–ç³»ç»Ÿæ·±åº¦è§£æ)
5. [æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢ç³»ç»Ÿ](#äº”æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢ç³»ç»Ÿæ·±åº¦è§£æ)
6. [å®Œæ•´äº¤æ˜“æµç¨‹](#å…­å®Œæ•´äº¤æ˜“æµç¨‹)
7. [æ ¸å¿ƒç®—æ³•è¯¦è§£](#ä¸ƒæ ¸å¿ƒç®—æ³•è¯¦è§£)
8. [æ•°æ®åº“æ¶æ„](#å…«æ•°æ®åº“æ¶æ„)
9. [ç³»ç»Ÿä¼˜åŠ¿æ€»ç»“](#ä¹ç³»ç»Ÿä¼˜åŠ¿æ€»ç»“)

---

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

**è¶…çº§å¤§è„‘(Big4)äº¤æ˜“ç³»ç»Ÿ** æ˜¯ä¸€ä¸ªå…·å¤‡è‡ªæˆ‘å­¦ä¹ èƒ½åŠ›çš„æ™ºèƒ½åŒ–æœŸè´§åˆçº¦äº¤æ˜“å¹³å°ï¼Œé€šè¿‡Big4(BTC/ETH/BNB/SOL)å››å¤§å¤©ç‹çš„å¤šæ—¶é—´æ¡†æ¶è¶‹åŠ¿åˆ†æã€æ™ºèƒ½åˆ†æ‰¹å»ºä»“ã€8å±‚é£æ§ä½“ç³»å’ŒåŠ¨æ€æ¨¡å¼åˆ‡æ¢æœºåˆ¶ï¼Œå®ç°ç¨³å®šç›ˆåˆ©ã€‚

### 1.2 æ ¸å¿ƒåˆ›æ–°ç‚¹

#### ğŸ§  30H+5HåŒé‡è¶‹åŠ¿éªŒè¯
- **30Hå¤§è¶‹åŠ¿**: åˆ¤æ–­ä¸»å¯¼æ–¹å‘(BULL/BEAR/NEUTRAL)
- **5Hå°è¶‹åŠ¿**: ä¿®æ­£çŸ­æœŸåè½¬ä¿¡å·
- **è¶‹åŠ¿ä¿®æ­£é€»è¾‘**:
  - 30Hä¸‹è·Œ + 5Håå¼¹ â†’ NEUTRAL (é¿å…åœ¨åå¼¹ä¸­åšç©º)
  - 30Hä¸Šæ¶¨ + 5Hå›è°ƒ â†’ NEUTRAL (é¿å…åœ¨å›è°ƒä¸­åšå¤š)

#### ğŸ“Š Big4å¤šæƒé‡å¸‚åœºåˆ¤æ–­
```
BTC: 40% æƒé‡ (å¸‚åœºé£å‘æ ‡)
ETH: 30% æƒé‡ (ç¬¬äºŒå¤§å¸ç§)
BNB: 15% æƒé‡ (äº¤æ˜“æ‰€ä»£å¸)
SOL: 15% æƒé‡ (ç”Ÿæ€çƒ­åº¦)
```

#### ğŸ¯ æ™ºèƒ½åˆ†æ‰¹å»ºä»“(30/30/40)
- **ç¬¬1æ‰¹**: 30% - è¯•æ¢æ€§å»ºä»“ï¼Œç¡®ä¿åˆå§‹æˆæœ¬
- **ç¬¬2æ‰¹**: 30% - å›è°ƒåŠ ä»“ï¼Œé™ä½å¹³å‡æˆæœ¬
- **ç¬¬3æ‰¹**: 40% - é‡ä»“æŠ¼å®ï¼ŒæŠ“ä½ç¡®å®šæœºä¼š

#### ğŸ›¡ï¸ 8å±‚é£æ§ä½“ç³»
```
ä¼˜å…ˆçº§1: å›ºå®šæ­¢æŸ(2%) - ç«‹å³ç”Ÿæ•ˆ
ä¼˜å…ˆçº§2: å›ºå®šæ­¢ç›ˆ(6%) - ç«‹å³ç”Ÿæ•ˆ
ä¼˜å…ˆçº§3: ç´§æ€¥åè½¬ä¿æŠ¤ - 30åˆ†é’Ÿåç”Ÿæ•ˆ
ä¼˜å…ˆçº§4: æ™ºèƒ½é¡¶åº•è¯†åˆ« - åŸºäºç›ˆåˆ©+Kçº¿å¼ºåº¦
ä¼˜å…ˆçº§5: åŠ¨æ€è¶…æ—¶æ£€æŸ¥ - åŸºäºå¼€ä»“è¯„åˆ†
ä¼˜å…ˆçº§6: åˆ†é˜¶æ®µè¶…æ—¶ - 1H/2H/3H/4Hé€’è¿›
ä¼˜å…ˆçº§7: 4å°æ—¶ç»å¯¹æ‰˜åº• - å¼ºåˆ¶å¹³ä»“
ä¼˜å…ˆçº§8: Kçº¿å¼ºåº¦è¡°å‡ - åˆ†æ‰¹å¹³ä»“50%/70%/100%
```

#### ğŸ”„ è¶‹åŠ¿/éœ‡è¡æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
- **è¶‹åŠ¿æ¨¡å¼**: Big4å¼ºåº¦ >= 70 + æ˜ç¡®æ–¹å‘
- **éœ‡è¡æ¨¡å¼**: Big4å¼ºåº¦ < 40 + NEUTRALä¿¡å·
- **ç¼“å†²åŒº**: 40-70ä¹‹é—´ä¸åˆ‡æ¢ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢
- **å†·å´æœŸ**: 6å°æ—¶æœ€å°é—´éš”

### 1.3 æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è¶…çº§å¤§è„‘åˆçº¦äº¤æ˜“ç³»ç»Ÿ V4.0                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚  Big4æ£€æµ‹å¼•æ“   â”‚  æ¯15åˆ†é’Ÿæ£€æµ‹ï¼Œç¼“å­˜1å°æ—¶                 â”‚
â”‚  â”‚  - 1H(30æ ¹)     â”‚  30Hå¤§è¶‹åŠ¿ + 5Hå°è¶‹åŠ¿ä¿®æ­£               â”‚
â”‚  â”‚  - 1H(5æ ¹)      â”‚  15Mç¡®è®¤ + 5Mæ—¶æœº                      â”‚
â”‚  â”‚  - 15M/5M       â”‚  4å¸ç§åŠ æƒè¯„åˆ†                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚         â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ¨¡å¼åˆ‡æ¢å™¨      â”‚  â”‚ ä¿¡å·ç”Ÿæˆå™¨    â”‚  â”‚ ä»·æ ¼æ¨é€æœåŠ¡   â”‚  â”‚
â”‚  â”‚ Safe Switcher  â”‚  â”‚ 10ç§è¯„åˆ†ä¿¡å·  â”‚  â”‚ WebSocket     â”‚  â”‚
â”‚  â”‚ è¶‹åŠ¿/éœ‡è¡      â”‚  â”‚ 35åˆ†é˜ˆå€¼     â”‚  â”‚ Price Cache   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†“                    â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚ æ™ºèƒ½å»ºä»“æ‰§è¡Œå™¨  â”‚  â”‚ ä¿¡å·è¿‡æ»¤ç³»ç»Ÿ  â”‚                      â”‚
â”‚  â”‚ 30/30/40åˆ†æ‰¹   â”‚  â”‚ é»‘åå•+è¯„çº§   â”‚                      â”‚
â”‚  â”‚ 60åˆ†é’Ÿçª—å£     â”‚  â”‚ Big4è¿‡æ»¤     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚      æ™ºèƒ½å¹³ä»“ä¼˜åŒ–å™¨                   â”‚                    â”‚
â”‚  â”‚  - å®æ—¶ç›‘æ§(1ç§’)                     â”‚                    â”‚
â”‚  â”‚  - 8å±‚é£æ§æ£€æŸ¥                       â”‚                    â”‚
â”‚  â”‚  - Kçº¿å¼ºåº¦è¡°å‡(15åˆ†é’Ÿ)                â”‚                    â”‚
â”‚  â”‚  - æ™ºèƒ½åˆ†æ‰¹å¹³ä»“(T-30åˆ†é’Ÿçª—å£)          â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â†“                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚      ç´§æ€¥å¹²é¢„æœºåˆ¶                     â”‚                    â”‚
â”‚  â”‚  - Big4åŒæ­¥è§¦åº•åè½¬                  â”‚                    â”‚
â”‚  â”‚  - Big4åŒæ­¥è§é¡¶åè½¬                  â”‚                    â”‚
â”‚  â”‚  - æ­¢æŸç†”æ–­ä¿æŠ¤                      â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ä»£ç è§„æ¨¡

```
æ ¸å¿ƒæ–‡ä»¶ç»Ÿè®¡:
â”œâ”€ big4_trend_detector.py      547è¡Œ  (Big4è¶‹åŠ¿æ£€æµ‹)
â”œâ”€ smart_entry_executor.py   1,281è¡Œ  (æ™ºèƒ½åˆ†æ‰¹å»ºä»“)
â”œâ”€ smart_exit_optimizer.py   1,354è¡Œ  (æ™ºèƒ½å¹³ä»“ä¼˜åŒ–)
â”œâ”€ safe_mode_switcher.py       357è¡Œ  (æ¨¡å¼åˆ‡æ¢ç®¡ç†)
â”œâ”€ smart_trader_service.py   3,045è¡Œ  (ä¸»äº¤æ˜“æœåŠ¡)
â””â”€ adaptive_optimizer.py      ç­‰å…¶ä»–  (è‡ªé€‚åº”ä¼˜åŒ–)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:                        7,000+è¡Œ
```

---

## äºŒã€Big4è¶‹åŠ¿æ£€æµ‹ç³»ç»Ÿæ·±åº¦è§£æ

### 2.1 æ£€æµ‹æ¶æ„ - å¤šæ—¶é—´æ¡†æ¶éªŒè¯

**æ–‡ä»¶**: `app/services/big4_trend_detector.py`

#### æ—¶é—´æ¡†æ¶å±‚çº§è®¾è®¡

```
ç¬¬ä¸€å±‚: 1H(30æ ¹Kçº¿) â† å¤§è¶‹åŠ¿åˆ¤æ–­
  â”‚
  â”œâ”€ 30å°æ—¶å†å²æ•°æ®åˆ†æ
  â”œâ”€ é˜³çº¿/é˜´çº¿å æ¯”ç»Ÿè®¡
  â”œâ”€ Kçº¿åŠ›åº¦è¯„åˆ†(ä»·æ ¼80% + æˆäº¤é‡20%)
  â””â”€ å¤§æ³¢åŠ¨Kçº¿æ£€æµ‹(å•æ ¹ > 3%)
      â†“
ç¬¬äºŒå±‚: 1H(5æ ¹Kçº¿) â† å°è¶‹åŠ¿ä¿®æ­£
  â”‚
  â”œâ”€ æœ€è¿‘5å°æ—¶æ•°æ®åˆ†æ
  â”œâ”€ ç›¸åŒçš„åŠ›åº¦è®¡ç®—é€»è¾‘
  â””â”€ è¶‹åŠ¿ä¿®æ­£è§„åˆ™åº”ç”¨
      â†“
ç¬¬ä¸‰å±‚: 15M(30æ ¹Kçº¿) â† è¶‹åŠ¿ç¡®è®¤
  â”‚
  â”œâ”€ ä¸­æœŸè¶‹åŠ¿éªŒè¯
  â””â”€ äºŒæ¬¡ç¡®è®¤æœºåˆ¶
      â†“
ç¬¬å››å±‚: 5M(3æ ¹Kçº¿) â† ä¹°å–æ—¶æœº
  â”‚
  â”œâ”€ çŸ­æœŸåŠ›åº¦å˜åŒ–
  â””â”€ ç²¾å‡†å…¥åœºæ—¶æœº
      â†“
ç»¼åˆä¿¡å·è¾“å‡º
```

#### å››å¤§å¤©ç‹æƒé‡é…ç½®

```python
SYMBOL_WEIGHTS = {
    'BTC/USDT': 0.40,  # 40% - å¸‚åœºé¾™å¤´
    'ETH/USDT': 0.30,  # 30% - ç¬¬äºŒå¤§å¸
    'BNB/USDT': 0.15,  # 15% - å¹³å°å¸
    'SOL/USDT': 0.15   # 15% - ç”Ÿæ€çƒ­åº¦
}
```

**æƒé‡è®¾è®¡ç†å¿µ**:
- BTCä½œä¸ºå¸‚åœºé£å‘æ ‡ï¼Œæƒé‡æœ€é«˜
- ETHæ¬¡ä¹‹ï¼Œåæ˜ æ™ºèƒ½åˆçº¦ç”Ÿæ€
- BNB/SOLä»£è¡¨å¹³å°å’Œç”Ÿæ€çƒ­åº¦

### 2.2 æ ¸å¿ƒç®—æ³•1: Kçº¿åŠ›åº¦è®¡ç®—

**ç®—æ³•ä½ç½®**: `big4_trend_detector.py` ç¬¬171-323è¡Œ

#### åŠ›åº¦å…¬å¼

```
Kçº¿åŠ›åº¦ = ä»·æ ¼å˜åŒ–% Ã— 0.8 + æˆäº¤é‡å½’ä¸€åŒ– Ã— 0.2

å…¶ä¸­:
  ä»·æ ¼å˜åŒ–% = (æ”¶ç›˜ä»· - å¼€ç›˜ä»·) / å¼€ç›˜ä»· Ã— 100
  æˆäº¤é‡å½’ä¸€åŒ– = (å½“å‰æˆäº¤é‡ - æœ€å°æˆäº¤é‡) / (æœ€å¤§æˆäº¤é‡ - æœ€å°æˆäº¤é‡) Ã— 100
```

#### å®ç°ä»£ç é€»è¾‘

```python
def _analyze_kline_period(self, klines):
    """åˆ†æKçº¿å‘¨æœŸæ•°æ®"""

    # ç¬¬1æ­¥: æˆäº¤é‡å½’ä¸€åŒ–
    volumes = [float(k['volume']) for k in klines]
    max_volume = max(volumes)
    min_volume = min(volumes)
    volume_range = max_volume - min_volume if max_volume > min_volume else 1

    bull_power = 0  # é˜³çº¿åŠ›åº¦
    bear_power = 0  # é˜´çº¿åŠ›åº¦
    bull_count = 0  # é˜³çº¿æ•°é‡
    bear_count = 0  # é˜´çº¿æ•°é‡
    big_moves = []  # å¤§æ³¢åŠ¨Kçº¿

    for kline in klines:
        open_p = float(kline['open'])
        close_p = float(kline['close'])
        volume = float(kline['volume'])

        # ç¬¬2æ­¥: è®¡ç®—ä»·æ ¼å˜åŒ–%
        price_change_pct = (close_p - open_p) / open_p * 100

        # ç¬¬3æ­¥: æˆäº¤é‡å½’ä¸€åŒ–åˆ°0-100
        volume_normalized = (volume - min_volume) / volume_range * 100

        # ç¬¬4æ­¥: åŠ›åº¦åˆæˆ(80% ä»·æ ¼ + 20% æˆäº¤é‡)
        power = price_change_pct * 0.8 + volume_normalized * 0.2

        # ç¬¬5æ­¥: åˆ†ç±»ç»Ÿè®¡
        if close_p > open_p:
            bull_power += power
            bull_count += 1
        elif close_p < open_p:
            bear_power += abs(power)
            bear_count += 1

        # ç¬¬6æ­¥: è®°å½•å¤§æ³¢åŠ¨Kçº¿
        if abs(price_change_pct) > 3.0:
            big_moves.append({
                'direction': 'up' if price_change_pct > 0 else 'down',
                'magnitude': abs(price_change_pct)
            })

    return {
        'bull_power': bull_power,
        'bear_power': bear_power,
        'bull_count': bull_count,
        'bear_count': bear_count,
        'big_moves': big_moves
    }
```

#### ä¸ºä»€ä¹ˆé‡‡ç”¨80/20æƒé‡åˆ†é…?

1. **ä»·æ ¼æƒé‡80%**:
   - ä»·æ ¼æ˜¯å¸‚åœºä¾›éœ€çš„æœ€ç›´æ¥åæ˜ 
   - ä»·æ ¼å˜åŒ–ç›´æ¥å½±å“ç›ˆäº
   - ä»·æ ¼è¶‹åŠ¿æ˜¯æ ¸å¿ƒå†³ç­–ä¾æ®

2. **æˆäº¤é‡æƒé‡20%**:
   - æˆäº¤é‡ç”¨äºç¡®è®¤ä»·æ ¼è¶‹åŠ¿çš„æœ‰æ•ˆæ€§
   - é˜²æ­¢ä»·æ ¼è™šå‡çªç ´(æ— é‡çªç ´)
   - ä½œä¸ºè¾…åŠ©éªŒè¯ï¼Œä¸èƒ½å–§å®¾å¤ºä¸»

3. **å¥½å¤„**:
   - é¿å…æˆäº¤é‡å¼‚å¸¸æ”¾å¤§å¯¼è‡´è¯¯åˆ¤
   - ä¿æŒä»·æ ¼ä½œä¸ºä¸»å¯¼ä¿¡å·
   - æˆäº¤é‡ä½œä¸ºå¯é æ€§ç¡®è®¤

### 2.3 æ ¸å¿ƒç®—æ³•2: ä¸»å¯¼æ–¹å‘åˆ¤æ–­

**ç®—æ³•ä½ç½®**: `big4_trend_detector.py` ç¬¬277-315è¡Œ

#### ä¸‰ç»´éªŒè¯æœºåˆ¶

```python
def _determine_dominant(self, analysis, total_candles):
    """åˆ¤æ–­ä¸»å¯¼æ–¹å‘ - éœ€è¦3ä¸ªæ¡ä»¶æ»¡è¶³è‡³å°‘2ä¸ª"""

    bull_power = analysis['bull_power']
    bear_power = analysis['bear_power']
    bull_count = analysis['bull_count']
    bear_count = analysis['bear_count']
    big_moves = analysis['big_moves']

    # æ£€æŸ¥1: æ³¢åŠ¨ç‡è¿‡æ»¤
    volatility = (high_72h - low_72h) / low_72h * 100
    if volatility < 3.0:
        return 'NEUTRAL'  # éœ‡è¡å¸‚

    overall_change = (current_price - price_72h_ago) / price_72h_ago * 100
    if abs(overall_change) < 2.0:
        return 'NEUTRAL'  # æ— æ˜æ˜¾è¶‹åŠ¿

    # ç»´åº¦1: é˜³çº¿/é˜´çº¿å æ¯”æ£€æŸ¥
    threshold_count = total_candles * 0.60  # 60%é˜ˆå€¼
    check1_bull = (bull_count >= threshold_count)
    check1_bear = (bear_count >= threshold_count)

    # ç»´åº¦2: åŠ›åº¦æ¯”å·®å¼‚æ£€æŸ¥
    if bull_power > 0 and bear_power > 0:
        power_ratio = max(bull_power, bear_power) / min(bull_power, bear_power)
        check2_significant = (power_ratio > 1.2)  # 20%å·®å¼‚
    else:
        check2_significant = True

    check2_bull = (bull_power > bear_power * 1.2)
    check2_bear = (bear_power > bull_power * 1.2)

    # ç»´åº¦3: å¤§æ³¢åŠ¨Kçº¿æ•°é‡æ£€æŸ¥
    big_move_threshold = max(2, int(total_candles * 0.1))  # 10%æˆ–è‡³å°‘2æ ¹
    big_moves_up = sum(1 for m in big_moves if m['direction'] == 'up')
    big_moves_down = sum(1 for m in big_moves if m['direction'] == 'down')

    check3_bull = (big_moves_up >= big_move_threshold)
    check3_bear = (big_moves_down >= big_move_threshold)

    # ç»¼åˆåˆ¤æ–­: éœ€è¦è‡³å°‘2ä¸ªæ¡ä»¶æ»¡è¶³
    bull_checks = sum([check1_bull, check2_bull, check3_bull])
    bear_checks = sum([check1_bear, check2_bear, check3_bear])

    if bull_checks >= 2:
        return 'BULL'
    elif bear_checks >= 2:
        return 'BEAR'
    else:
        return 'NEUTRAL'
```

**åˆ¤æ–­é€»è¾‘ä¼˜åŠ¿**:
- å•ä¸€æŒ‡æ ‡ä¸è¶³ä»¥åˆ¤æ–­æ–¹å‘
- éœ€è¦å¤šç»´åº¦ç›¸äº’éªŒè¯
- é˜²æ­¢è™šå‡ä¿¡å·å¹²æ‰°
- æé«˜åˆ¤æ–­å‡†ç¡®æ€§

### 2.4 æ ¸å¿ƒç®—æ³•3: 30H+5Hè¶‹åŠ¿ä¿®æ­£

**ç®—æ³•ä½ç½®**: `big4_trend_detector.py` ç¬¬406-497è¡Œ

#### ä¿®æ­£è§„åˆ™è¯¦è§£

```python
def _generate_signal(self, symbol_analysis):
    """ç”Ÿæˆå•ä¸ªå¸ç§çš„è¶‹åŠ¿ä¿¡å·"""

    big_trend = symbol_analysis['1h_30_dominant']   # 30Hå¤§è¶‹åŠ¿
    small_trend = symbol_analysis['1h_5_dominant']  # 5Hå°è¶‹åŠ¿
    trend_15m = symbol_analysis['15m_dominant']     # 15Mç¡®è®¤

    # åœºæ™¯1: 30Hä¸‹è·Œ + 5Håå¼¹ â†’ ä¿®æ­£ä¸ºNEUTRAL
    if big_trend == 'BEAR' and small_trend == 'BULL':
        corrected_1h = 'NEUTRAL'
        reason = f"è¶‹åŠ¿ä¿®æ­£: 30Hä¸‹è·Œ({big_trend})ä½†5Håå¼¹({small_trend}) â†’ éœ‡è¡"
        logger.info(f"[BIG4-CORRECT] {symbol}: {reason}")

    # åœºæ™¯2: 30Hä¸Šæ¶¨ + 5Hå›è°ƒ â†’ ä¿®æ­£ä¸ºNEUTRAL
    elif big_trend == 'BULL' and small_trend == 'BEAR':
        corrected_1h = 'NEUTRAL'
        reason = f"è¶‹åŠ¿ä¿®æ­£: 30Hä¸Šæ¶¨({big_trend})ä½†5Hå›è°ƒ({small_trend}) â†’ éœ‡è¡"
        logger.info(f"[BIG4-CORRECT] {symbol}: {reason}")

    # åœºæ™¯3: 30Héœ‡è¡ â†’ è·Ÿéš5Hå°è¶‹åŠ¿
    elif big_trend == 'NEUTRAL':
        corrected_1h = small_trend
        reason = f"30Héœ‡è¡ï¼Œè·Ÿéš5H: {small_trend}"
        logger.info(f"[BIG4-FOLLOW] {symbol}: {reason}")

    # åœºæ™¯4: 30Hå’Œ5Hä¸€è‡´ â†’ ä¿æŒå¤§è¶‹åŠ¿
    else:
        corrected_1h = big_trend
        reason = f"30Hä¸5Hä¸€è‡´: {big_trend}"

    # ä¿¡å·è¯„åˆ†ç³»ç»Ÿ
    score = 0

    # æƒé‡1: ä¿®æ­£åçš„1Hæ–¹å‘ (Â±60åˆ†)
    if corrected_1h == 'BULL':
        score += 60
    elif corrected_1h == 'BEAR':
        score -= 60

    # æƒé‡2: 15Mè¶‹åŠ¿ç¡®è®¤ (Â±30åˆ†)
    if trend_15m == 'BULL':
        score += 30
    elif trend_15m == 'BEAR':
        score -= 30

    # æƒé‡3: 5Mä¹°å–æ—¶æœº (Â±10åˆ†)
    trend_5m = self._analyze_5m_momentum(symbol)
    if trend_5m == 'BULL':
        score += 10
    elif trend_5m == 'BEAR':
        score -= 10

    # æœ€ç»ˆä¿¡å·åˆ¤æ–­
    if score > 30:
        signal = 'BULLISH'
    elif score < -30:
        signal = 'BEARISH'
    else:
        signal = 'NEUTRAL'

    return {
        'signal': signal,
        'score': score,
        '1h_30_dominant': big_trend,
        '1h_5_dominant': small_trend,
        'corrected_1h': corrected_1h,
        '15m_dominant': trend_15m,
        'reason': reason
    }
```

#### å®é™…æ¡ˆä¾‹è¯´æ˜

**æ¡ˆä¾‹1: ä¸‹è·Œè¶‹åŠ¿ä¸­çš„åå¼¹**
```
BTC 30Håˆ†æ: 30æ ¹Kçº¿ä¸­æœ‰20æ ¹é˜´çº¿ â†’ åˆ¤å®šä¸ºBEAR
BTC 5Håˆ†æ: æœ€è¿‘5æ ¹Kçº¿æœ‰3æ ¹é˜³çº¿ â†’ åˆ¤å®šä¸ºBULL

ä¿®æ­£é€»è¾‘:
  å¤§è¶‹åŠ¿ä¸‹è·Œï¼Œä½†çŸ­æœŸåå¼¹
  â†’ ä¿®æ­£ä¸ºNEUTRAL
  â†’ ä¸åšç©º(é¿å…åœ¨åå¼¹ä¸­è¢«æ‰«æŸ)
  â†’ ä¸åšå¤š(å¤§è¶‹åŠ¿ä»ç„¶ä¸‹è·Œ)
```

**æ¡ˆä¾‹2: ä¸Šæ¶¨è¶‹åŠ¿ä¸­çš„å›è°ƒ**
```
ETH 30Håˆ†æ: 30æ ¹Kçº¿ä¸­æœ‰22æ ¹é˜³çº¿ â†’ åˆ¤å®šä¸ºBULL
ETH 5Håˆ†æ: æœ€è¿‘5æ ¹Kçº¿æœ‰4æ ¹é˜´çº¿ â†’ åˆ¤å®šä¸ºBEAR

ä¿®æ­£é€»è¾‘:
  å¤§è¶‹åŠ¿ä¸Šæ¶¨ï¼Œä½†çŸ­æœŸå›è°ƒ
  â†’ ä¿®æ­£ä¸ºNEUTRAL
  â†’ ä¸åšå¤š(å¯èƒ½åœ¨é«˜ä½è¿½æ¶¨)
  â†’ ä¸åšç©º(å¤§è¶‹åŠ¿ä»ç„¶ä¸Šæ¶¨)
```

**æ¡ˆä¾‹3: éœ‡è¡å¸‚åœºä¸­çš„å°è¶‹åŠ¿**
```
BNB 30Håˆ†æ: é˜³é˜´çº¿å‡è¡¡ â†’ åˆ¤å®šä¸ºNEUTRAL
BNB 5Håˆ†æ: æœ€è¿‘5æ ¹Kçº¿æœ‰4æ ¹é˜³çº¿ â†’ åˆ¤å®šä¸ºBULL

ä¿®æ­£é€»è¾‘:
  å¤§è¶‹åŠ¿éœ‡è¡ï¼Œè·ŸéšçŸ­æœŸå¤šå¤´
  â†’ ä¿®æ­£ä¸ºBULL
  â†’ å¯ä»¥åšå¤š(çŸ­æœŸæœ‰ä¸Šæ¶¨åŠ¨èƒ½)
```

### 2.5 Big4æ•´ä½“ä¿¡å·åˆæˆ

```python
def detect_market_trend(self):
    """æ£€æµ‹å¸‚åœºæ•´ä½“è¶‹åŠ¿"""

    symbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT']
    results = {}

    # ç¬¬1æ­¥: åˆ†ææ¯ä¸ªå¸ç§
    for symbol in symbols:
        analysis = self._analyze_symbol(symbol)
        signal = self._generate_signal(analysis)
        results[symbol] = signal

    # ç¬¬2æ­¥: åŠ æƒåˆæˆ
    weighted_score = 0
    bullish_count = 0
    bearish_count = 0

    for symbol, weight in SYMBOL_WEIGHTS.items():
        signal_data = results[symbol]
        weighted_score += signal_data['score'] * weight

        if signal_data['signal'] == 'BULLISH':
            bullish_count += 1
        elif signal_data['signal'] == 'BEARISH':
            bearish_count += 1

    # ç¬¬3æ­¥: æ•´ä½“åˆ¤æ–­
    if weighted_score > 30:
        overall_signal = 'BULLISH'
    elif weighted_score < -30:
        overall_signal = 'BEARISH'
    else:
        overall_signal = 'NEUTRAL'

    # ç¬¬4æ­¥: è®¡ç®—ä¿¡å·å¼ºåº¦
    signal_strength = min(100, abs(weighted_score))

    return {
        'overall_signal': overall_signal,
        'signal_strength': signal_strength,
        'bullish_count': bullish_count,
        'bearish_count': bearish_count,
        'details': results,
        'checked_at': datetime.now()
    }
```

### 2.6 Big4ç¼“å­˜æœºåˆ¶

```python
# æ£€æµ‹é—´éš”: 15åˆ†é’Ÿ
# ç¼“å­˜æœ‰æ•ˆæœŸ: 1å°æ—¶

def get_cached_big4():
    """è·å–Big4ç¼“å­˜ä¿¡å·"""

    # ä»æ•°æ®åº“è·å–æœ€æ–°è®°å½•
    latest = db.query("""
        SELECT * FROM big4_trend_history
        ORDER BY created_at DESC LIMIT 1
    """)

    if latest:
        cached_time = latest['created_at']
        age_minutes = (datetime.now() - cached_time).seconds / 60

        # ç¼“å­˜æœ‰æ•ˆæœŸå†…ç›´æ¥è¿”å›
        if age_minutes < 60:
            logger.info(f"[BIG4-CACHE] ä½¿ç”¨ç¼“å­˜ (å¹´é¾„: {age_minutes:.1f}åˆ†é’Ÿ)")
            return latest

    # ç¼“å­˜è¿‡æœŸæˆ–ä¸å­˜åœ¨ï¼Œè§¦å‘æ–°æ£€æµ‹
    logger.info("[BIG4-DETECT] ç¼“å­˜è¿‡æœŸï¼Œæ‰§è¡Œæ–°æ£€æµ‹")
    new_result = detect_market_trend()
    save_to_database(new_result)
    return new_result
```

---

## ä¸‰ã€æ™ºèƒ½åˆ†æ‰¹å»ºä»“ç³»ç»Ÿæ·±åº¦è§£æ

### 3.1 å»ºä»“ç­–ç•¥è®¾è®¡ç†å¿µ

**æ–‡ä»¶**: `app/services/smart_entry_executor.py`

#### ä¸ºä»€ä¹ˆé‡‡ç”¨30/30/40åˆ†æ‰¹?

```
æ‰¹æ¬¡è®¾è®¡å“²å­¦:
â”œâ”€ ç¬¬1æ‰¹(30%): è¯•æ¢æ€§å»ºä»“
â”‚   ç›®çš„: å»ºç«‹åˆå§‹ä»“ä½ï¼Œé”å®šéƒ¨åˆ†æˆæœ¬
â”‚   é£é™©: ä½(ä»“ä½å°)
â”‚
â”œâ”€ ç¬¬2æ‰¹(30%): å›è°ƒåŠ ä»“
â”‚   ç›®çš„: åˆ©ç”¨ä»·æ ¼å›è°ƒé™ä½å¹³å‡æˆæœ¬
â”‚   é£é™©: ä¸­(ç´¯è®¡60%)
â”‚
â””â”€ ç¬¬3æ‰¹(40%): é‡ä»“æŠ¼å®
    ç›®çš„: ä¿¡å·ç¡®è®¤ååŠ å¤§ä»“ä½
    é£é™©: é«˜(æ€»ä»“ä½100%)
```

**ä¼˜åŠ¿åˆ†æ**:
1. **æˆæœ¬ä¼˜åŒ–**: é€šè¿‡å›è°ƒåŠ ä»“é™ä½å¹³å‡æˆæœ¬
2. **é£é™©åˆ†æ•£**: åˆ†3æ¬¡å…¥åœºï¼Œé¿å…ä¸€æ¬¡æ€§è¸ç©ºæˆ–è¢«å¥—
3. **çµæ´»æ€§é«˜**: å¯æ ¹æ®å¸‚åœºå˜åŒ–è°ƒæ•´åç»­æ‰¹æ¬¡

### 3.2 å®Œæ•´å»ºä»“æµç¨‹

```
ã€é˜¶æ®µ0ã€‘ä¿¡å·äº§ç”Ÿ + ä»·æ ¼é‡‡æ ·å¯åŠ¨ (T+0 ~ T+5åˆ†é’Ÿ)
    â”‚
    â”œâ”€ å¯åŠ¨ PriceSampler åå°é‡‡æ ·å™¨
    â”œâ”€ æ¯10ç§’é‡‡é›†ä¸€æ¬¡ä»·æ ¼
    â”œâ”€ å»ºç«‹5åˆ†é’Ÿæ»šåŠ¨çª—å£åŸºçº¿
    â”‚
    â””â”€ è¾“å‡ºåŸºçº¿æ•°æ®:
        â”œâ”€ min_price (æœ€ä½ä»·)
        â”œâ”€ max_price (æœ€é«˜ä»·)
        â”œâ”€ p25, p50, p75 (åˆ†ä½æ•°)
        â””â”€ trend (æ–¹å‘ + å¼ºåº¦)
           â†“
ã€é˜¶æ®µ1ã€‘ç¬¬1æ‰¹å»ºä»“åˆ¤æ–­ (T+5 ~ T+15åˆ†é’Ÿ)
    â”‚
    â”œâ”€ æ¡ä»¶1: ä»·æ ¼è¯„åˆ† >= 80 â†’ ç«‹å³å…¥åœº
    â”œâ”€ æ¡ä»¶2: è¯„åˆ† >= 60 + æ­¢è·Œä¿¡å· >= 50 â†’ å…¥åœº
    â”œâ”€ æ¡ä»¶3: çªç ´åŸºçº¿æå€¼ â†’ å…¥åœº
    â”œâ”€ æ¡ä»¶4: å¼ºè¶‹åŠ¿ + ä»·æ ¼ >= p75 â†’ è¿½æ¶¨å…¥åœº
    â”œâ”€ å…œåº•1: 12åˆ†é’Ÿå è¯„åˆ† >= 40 â†’ å…¥åœº
    â””â”€ å…œåº•2: 15åˆ†é’Ÿå æ— æ¡ä»¶å…¥åœº
           â†“
ã€é˜¶æ®µ2ã€‘ç¬¬2æ‰¹å»ºä»“åˆ¤æ–­ (è·ç¬¬1æ‰¹ 3~20åˆ†é’Ÿ)
    â”‚
    â”œâ”€ æ¡ä»¶1: ä»·æ ¼å›è°ƒè‡³ç¬¬1æ‰¹ä»· Ã— 0.997 â†’ å…¥åœº
    â”œâ”€ æ¡ä»¶2: ä»·æ ¼ <= p25 åˆ†ä½æ•° â†’ å…¥åœº
    â”œâ”€ å…œåº•1: è·ç¬¬1æ‰¹ >= 10åˆ†é’Ÿ â†’ å…¥åœº
    â””â”€ å…œåº•2: è·ä¿¡å· >= 20åˆ†é’Ÿ â†’ å¼ºåˆ¶å…¥åœº
           â†“
ã€é˜¶æ®µ3ã€‘ç¬¬3æ‰¹å»ºä»“åˆ¤æ–­ (è·ç¬¬2æ‰¹ 3~28åˆ†é’Ÿ)
    â”‚
    â”œâ”€ æ¡ä»¶1: ä»·æ ¼ <= å‰ä¸¤æ‰¹å¹³å‡ä»· â†’ å…¥åœº
    â”œâ”€ æ¡ä»¶2: ä»·æ ¼ <= p50 ä¸­ä½æ•° â†’ å…¥åœº
    â”œâ”€ æ¡ä»¶3: ä»·æ ¼ <= å¹³å‡ä»· Ã— 1.003 â†’ å…¥åœº
    â”œâ”€ å…œåº•1: è·ç¬¬2æ‰¹ >= 8åˆ†é’Ÿ â†’ å…¥åœº
    â””â”€ å…œåº•2: è·ä¿¡å· >= 28åˆ†é’Ÿ â†’ å¼ºåˆ¶å…¥åœº
           â†“
ã€å®Œæˆã€‘åˆ†æ‰¹å»ºä»“ç»“æŸï¼Œå¯åŠ¨å¹³ä»“ç›‘æ§
```

### 3.3 ä»·æ ¼è¯„åˆ†ç®—æ³•

**ç®—æ³•ä½ç½®**: `smart_entry_executor.py` ç¬¬171-246è¡Œ

```python
def calculate_price_score(self, current_price, baseline, side):
    """
    è®¡ç®—å½“å‰ä»·æ ¼è¯„åˆ† (0-100åˆ†)

    Args:
        current_price: å½“å‰ä»·æ ¼
        baseline: ä»·æ ¼åŸºçº¿æ•°æ®
        side: LONG æˆ– SHORT

    Returns:
        score: 0-100åˆ†
    """

    if side == 'LONG':
        # åšå¤šå¸Œæœ›åœ¨ä½ä½å»ºä»“

        if current_price <= baseline.min_price:
            score = 100  # è·Œç ´åŸºçº¿æœ€ä½ä»· - æä¼˜
        elif current_price <= baseline.p25:
            score = 95   # 25åˆ†ä½ä»¥ä¸‹ - ä¼˜ç§€
        elif current_price <= baseline.p50:
            score = 85   # 50åˆ†ä½ä»¥ä¸‹ - è‰¯å¥½
        elif current_price <= baseline.p75:
            score = 70   # 75åˆ†ä½ä»¥ä¸‹ - ä¸€èˆ¬
        else:
            score = 50   # é«˜äº75åˆ†ä½ - è¾ƒå·®

        # è¶‹åŠ¿è°ƒæ•´
        if baseline.trend == 'down':
            score += 10  # ä¸‹è·Œè¶‹åŠ¿ï¼Œæ›´å¥½çš„ä¹°ç‚¹
        elif baseline.trend == 'up':
            score -= 10  # ä¸Šæ¶¨è¶‹åŠ¿ï¼Œè¿½é«˜é£é™©

    elif side == 'SHORT':
        # åšç©ºå¸Œæœ›åœ¨é«˜ä½å»ºä»“

        if current_price >= baseline.max_price:
            score = 100  # çªç ´åŸºçº¿æœ€é«˜ä»· - æä¼˜
        elif current_price >= baseline.p75:
            score = 95   # 75åˆ†ä½ä»¥ä¸Š - ä¼˜ç§€
        elif current_price >= baseline.p50:
            score = 85   # 50åˆ†ä½ä»¥ä¸Š - è‰¯å¥½
        elif current_price >= baseline.p25:
            score = 70   # 25åˆ†ä½ä»¥ä¸Š - ä¸€èˆ¬
        else:
            score = 50   # ä½äº25åˆ†ä½ - è¾ƒå·®

        # è¶‹åŠ¿è°ƒæ•´
        if baseline.trend == 'up':
            score += 10  # ä¸Šæ¶¨è¶‹åŠ¿ï¼Œæ›´å¥½çš„å–ç‚¹
        elif baseline.trend == 'down':
            score -= 10  # ä¸‹è·Œè¶‹åŠ¿ï¼Œè¿½è·Œé£é™©

    return max(0, min(100, score))
```

### 3.4 Big4å†²çªæ£€æŸ¥(ç´§æ€¥é£æ§)

**ç®—æ³•ä½ç½®**: `smart_entry_executor.py` ç¬¬41-86è¡Œ

```python
def _check_big4_conflict(self, symbol, side):
    """
    åˆ†æ‰¹å»ºä»“è¿‡ç¨‹ä¸­æ£€æŸ¥Big4æ–¹å‘å˜åŒ–

    åœºæ™¯: å¼€å§‹åšå¤šæ—¶Big4çœ‹å¤šï¼Œä½†å»ºä»“è¿‡ç¨‹ä¸­Big4è½¬ä¸ºçœ‹ç©º
    è¡Œä¸º: å–æ¶ˆåç»­æ‰¹æ¬¡å»ºä»“ + å¹³æ‰å·²å»ºä»“ä½

    Returns:
        (should_cancel, reason)
    """

    try:
        # è·å–æœ€æ–°Big4ä¿¡å·
        big4_result = get_latest_big4_from_db()

        if not big4_result:
            return False, None

        big4_signal = big4_result['overall_signal']
        big4_strength = float(big4_result['signal_strength'])

        # æ£€æŸ¥1: åšå¤šæ—¶Big4è½¬ä¸ºå¼ºçƒˆçœ‹ç©º
        if side == 'LONG' and big4_signal == 'BEARISH' and big4_strength >= 60:
            reason = f"Big4å¼ºçƒˆçœ‹ç©º(å¼ºåº¦{big4_strength:.1f}),å–æ¶ˆåšå¤šå»ºä»“"
            logger.warning(f"[BIG4-CONFLICT] {symbol} {reason}")
            return True, reason

        # æ£€æŸ¥2: åšç©ºæ—¶Big4è½¬ä¸ºå¼ºçƒˆçœ‹å¤š
        elif side == 'SHORT' and big4_signal == 'BULLISH' and big4_strength >= 60:
            reason = f"Big4å¼ºçƒˆçœ‹å¤š(å¼ºåº¦{big4_strength:.1f}),å–æ¶ˆåšç©ºå»ºä»“"
            logger.warning(f"[BIG4-CONFLICT] {symbol} {reason}")
            return True, reason

        return False, None

    except Exception as e:
        logger.error(f"æ£€æŸ¥Big4å†²çªå¤±è´¥: {e}")
        return False, None  # æ£€æŸ¥å¤±è´¥ä¸å½±å“å»ºä»“
```

### 3.5 å»ºä»“æ ¸å¿ƒæ‰§è¡Œä»£ç 

**ç®—æ³•ä½ç½®**: `smart_entry_executor.py` ç¬¬88-463è¡Œ

```python
async def execute_entry(self, signal: Dict) -> Dict:
    """
    æ‰§è¡Œæ™ºèƒ½åˆ†æ‰¹å»ºä»“

    Args:
        signal: å¼€ä»“ä¿¡å· {
            'symbol': 'BTC/USDT',
            'side': 'LONG',
            'entry_score': 65,
            'total_margin': 400
        }

    Returns:
        result: {
            'status': 'success',
            'batches': [batch1, batch2, batch3],
            'avg_price': å¹³å‡æˆæœ¬ä»·
        }
    """

    symbol = signal['symbol']
    side = signal['side']
    total_margin = signal['total_margin']

    # è®¡ç®—åˆ†æ‰¹ä»“ä½
    batch_margins = [
        total_margin * 0.30,  # ç¬¬1æ‰¹: 30%
        total_margin * 0.30,  # ç¬¬2æ‰¹: 30%
        total_margin * 0.40   # ç¬¬3æ‰¹: 40%
    ]

    # å¯åŠ¨ä»·æ ¼é‡‡æ ·å™¨
    sampler = PriceSampler(symbol)
    await sampler.start_sampling()

    # ç­‰å¾…5åˆ†é’Ÿå»ºç«‹åŸºçº¿
    await asyncio.sleep(300)
    baseline = sampler.get_baseline()

    batches = []
    signal_time = datetime.now()

    # ========== ç¬¬1æ‰¹å»ºä»“ ==========
    batch1_executed = False
    batch1_price = None

    for elapsed in range(5, 16):  # 5-15åˆ†é’Ÿ
        # Big4å†²çªæ£€æŸ¥
        should_cancel, reason = self._check_big4_conflict(symbol, side)
        if should_cancel:
            logger.warning(f"[BATCH-1-CANCEL] {reason}")
            break

        current_price = await self.get_price(symbol)
        price_score = self.calculate_price_score(current_price, baseline, side)

        # åˆ¤æ–­æ˜¯å¦å…¥åœº
        should_enter = False
        enter_reason = ""

        # æ¡ä»¶1: æä¼˜ä»·æ ¼
        if price_score >= 80:
            should_enter = True
            enter_reason = f"æä¼˜ä»·æ ¼(è¯„åˆ†{price_score})"

        # æ¡ä»¶2: ä¼˜ç§€ä»·æ ¼ + æ­¢è·Œä¿¡å·
        elif price_score >= 60 and baseline.stop_falling_score >= 50:
            should_enter = True
            enter_reason = f"ä¼˜ç§€ä»·æ ¼({price_score}) + æ­¢è·Œä¿¡å·"

        # æ¡ä»¶3: çªç ´åŸºçº¿
        elif side == 'LONG' and current_price <= baseline.min_price * 0.999:
            should_enter = True
            enter_reason = "è·Œç ´åŸºçº¿æœ€ä½ä»·"
        elif side == 'SHORT' and current_price >= baseline.max_price * 1.001:
            should_enter = True
            enter_reason = "çªç ´åŸºçº¿æœ€é«˜ä»·"

        # æ¡ä»¶4: å¼ºè¶‹åŠ¿è¿½æ¶¨/è¿½è·Œ
        elif side == 'LONG' and baseline.trend_strength > 0.6 and current_price >= baseline.p75:
            should_enter = True
            enter_reason = "å¼ºä¸Šæ¶¨è¶‹åŠ¿,é¿å…é”™è¿‡"
        elif side == 'SHORT' and baseline.trend_strength < -0.6 and current_price <= baseline.p25:
            should_enter = True
            enter_reason = "å¼ºä¸‹è·Œè¶‹åŠ¿,é¿å…é”™è¿‡"

        # å…œåº•1: 12åˆ†é’Ÿå
        elif elapsed >= 12 and price_score >= 40:
            should_enter = True
            enter_reason = f"12åˆ†é’Ÿå…œåº•(è¯„åˆ†{price_score})"

        # å…œåº•2: 15åˆ†é’Ÿå¼ºåˆ¶
        elif elapsed >= 15:
            should_enter = True
            enter_reason = "15åˆ†é’Ÿå¼ºåˆ¶å…¥åœº"

        if should_enter:
            # æ‰§è¡Œç¬¬1æ‰¹å»ºä»“
            batch1 = await self.place_order(
                symbol=symbol,
                side=side,
                margin=batch_margins[0],
                reason=enter_reason
            )

            batches.append(batch1)
            batch1_price = batch1['price']
            batch1_time = datetime.now()
            batch1_executed = True

            logger.info(f"[BATCH-1-DONE] {symbol} {side} ç¬¬1æ‰¹å®Œæˆ | "
                       f"ä»·æ ¼: {batch1_price} | æ¯”ä¾‹: 30% | åŸå› : {enter_reason}")
            break

        await asyncio.sleep(60)  # 1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

    if not batch1_executed:
        raise Exception("ç¬¬1æ‰¹å»ºä»“å¤±è´¥")

    # ========== ç¬¬2æ‰¹å»ºä»“ ==========
    batch2_executed = False
    batch2_price = None

    # ç­‰å¾…è‡³å°‘3åˆ†é’Ÿåå†å»ºç¬¬2æ‰¹
    time_since_batch1 = (datetime.now() - batch1_time).seconds / 60
    if time_since_batch1 < 3:
        await asyncio.sleep((3 - time_since_batch1) * 60)

    for i in range(20):  # æœ€å¤šç­‰å¾…20åˆ†é’Ÿ
        should_cancel, reason = self._check_big4_conflict(symbol, side)
        if should_cancel:
            logger.warning(f"[BATCH-2-CANCEL] {reason}")
            break

        current_price = await self.get_price(symbol)
        price_score = self.calculate_price_score(current_price, baseline, side)

        time_since_batch1 = (datetime.now() - batch1_time).seconds / 60
        time_since_signal = (datetime.now() - signal_time).seconds / 60

        should_enter = False
        enter_reason = ""

        # æ¡ä»¶1: å›è°ƒè‡³ç¬¬1æ‰¹ä»· - 0.3%
        if side == 'LONG' and current_price <= batch1_price * 0.997:
            should_enter = True
            enter_reason = "ä»·æ ¼å›è°ƒ,åŠ ä»“"
        elif side == 'SHORT' and current_price >= batch1_price * 1.003:
            should_enter = True
            enter_reason = "ä»·æ ¼å›è°ƒ,åŠ ä»“"

        # æ¡ä»¶2: ä»·æ ¼åœ¨p25ä»¥ä¸‹/ä»¥ä¸Š
        elif side == 'LONG' and current_price <= baseline.p25:
            should_enter = True
            enter_reason = "ä»·æ ¼ä½äºp25"
        elif side == 'SHORT' and current_price >= baseline.p75:
            should_enter = True
            enter_reason = "ä»·æ ¼é«˜äºp75"

        # å…œåº•1: è·ç¬¬1æ‰¹10åˆ†é’Ÿ
        elif time_since_batch1 >= 10:
            should_enter = True
            enter_reason = "è·ç¬¬1æ‰¹10åˆ†é’Ÿå…œåº•"

        # å…œåº•2: è·ä¿¡å·20åˆ†é’Ÿå¼ºåˆ¶
        elif time_since_signal >= 20:
            should_enter = True
            enter_reason = "20åˆ†é’Ÿå¼ºåˆ¶å…¥åœº"

        if should_enter:
            batch2 = await self.place_order(
                symbol=symbol,
                side=side,
                margin=batch_margins[1],
                reason=enter_reason
            )

            batches.append(batch2)
            batch2_price = batch2['price']
            batch2_time = datetime.now()
            batch2_executed = True

            logger.info(f"[BATCH-2-DONE] {symbol} {side} ç¬¬2æ‰¹å®Œæˆ | "
                       f"ä»·æ ¼: {batch2_price} | æ¯”ä¾‹: 30% | åŸå› : {enter_reason}")
            break

        await asyncio.sleep(60)

    if not batch2_executed:
        raise Exception("ç¬¬2æ‰¹å»ºä»“å¤±è´¥")

    # ========== ç¬¬3æ‰¹å»ºä»“ ==========
    # (ç±»ä¼¼é€»è¾‘ï¼Œçœç•¥...)

    # è®¡ç®—å¹³å‡æˆæœ¬
    total_qty = sum(b['quantity'] for b in batches)
    avg_price = sum(b['price'] * b['quantity'] for b in batches) / total_qty

    # åœæ­¢é‡‡æ ·å™¨
    await sampler.stop_sampling()

    return {
        'status': 'success',
        'batches': batches,
        'avg_price': avg_price,
        'total_quantity': total_qty
    }
```

---

## å››ã€æ™ºèƒ½å¹³ä»“ä¼˜åŒ–ç³»ç»Ÿæ·±åº¦è§£æ

### 4.1 å¹³ä»“ç›‘æ§æ¶æ„

**æ–‡ä»¶**: `app/services/smart_exit_optimizer.py`

```
å®æ—¶ç›‘æ§å¾ªç¯ (æ¯1ç§’):
    â”‚
    â”œâ”€ è·å–å®æ—¶ä»·æ ¼ (WS â†’ REST â†’ Kçº¿é™çº§)
    â”œâ”€ è®¡ç®—å½“å‰ç›ˆäº%
    â”œâ”€ æ›´æ–°æœ€é«˜ç›ˆåˆ©è®°å½•
    â”‚
    â”œâ”€ ä¼˜å…ˆçº§æ£€æŸ¥ (1-7å±‚):
    â”‚   â”œâ”€ æ­¢æŸ/æ­¢ç›ˆæ£€æŸ¥
    â”‚   â”œâ”€ ç´§æ€¥åè½¬æ£€æŸ¥
    â”‚   â”œâ”€ æ™ºèƒ½é¡¶åº•è¯†åˆ«
    â”‚   â”œâ”€ åŠ¨æ€è¶…æ—¶æ£€æŸ¥
    â”‚   â”œâ”€ åˆ†é˜¶æ®µè¶…æ—¶æ£€æŸ¥
    â”‚   â””â”€ ç»å¯¹æ—¶é—´æ‰˜åº•
    â”‚
    â”œâ”€ æ¯15åˆ†é’Ÿ:
    â”‚   â””â”€ Kçº¿å¼ºåº¦è¡°å‡æ£€æŸ¥ (åˆ†æ‰¹å¹³ä»“)
    â”‚
    â””â”€ è®¡åˆ’å¹³ä»“å‰30åˆ†é’Ÿ:
        â””â”€ å¯åŠ¨æ™ºèƒ½åˆ†æ‰¹å¹³ä»“çª—å£
```

### 4.2 å…«å±‚é£æ§ä½“ç³»è¯¦è§£

#### ä¼˜å…ˆçº§1: å›ºå®šæ­¢æŸ (æ— æ—¶é—´é™åˆ¶)

```python
def check_stop_loss(self, position, current_price):
    """
    å›ºå®šæ­¢æŸæ£€æŸ¥ - ä»»ä½•æ—¶å€™éƒ½ç”Ÿæ•ˆ

    æ­¢æŸä»·è®¡ç®—:
      LONG: å…¥åœºä»· Ã— (1 - æ­¢æŸ%)
      SHORT: å…¥åœºä»· Ã— (1 + æ­¢æŸ%)
    """

    if position.position_side == 'LONG':
        if current_price <= position.stop_loss_price:
            return True, "è§¦å‘æ­¢æŸ"

    elif position.position_side == 'SHORT':
        if current_price >= position.stop_loss_price:
            return True, "è§¦å‘æ­¢æŸ"

    return False, ""
```

#### ä¼˜å…ˆçº§2: å›ºå®šæ­¢ç›ˆ

```python
def check_take_profit(self, position, current_price):
    """å›ºå®šæ­¢ç›ˆæ£€æŸ¥"""

    if position.position_side == 'LONG':
        if current_price >= position.take_profit_price:
            return True, "è§¦å‘æ­¢ç›ˆ"

    elif position.position_side == 'SHORT':
        if current_price <= position.take_profit_price:
            return True, "è§¦å‘æ­¢ç›ˆ"

    return False, ""
```

#### ä¼˜å…ˆçº§3: ç´§æ€¥åè½¬ä¿æŠ¤ (30åˆ†é’Ÿåç”Ÿæ•ˆ)

```python
def check_emergency_reversal(self, position, pnl_pct):
    """
    ç´§æ€¥åè½¬æ£€æŸ¥

    æ¡ä»¶:
      1. æŒä»“ >= 30åˆ†é’Ÿ
      2. äºæŸ > 1.5%
      3. 15Må’Œ5Méƒ½å¼ºçƒˆåè½¬
    """

    minutes_held = (datetime.now() - position.created_at).seconds / 60
    if minutes_held < 30:
        return False, ""

    if pnl_pct > -1.5:
        return False, ""

    # è·å–15Må’Œ5Mçš„Kçº¿å¼ºåº¦
    strength_15m = self.calculate_kline_strength_15m(position.symbol)
    strength_5m = self.calculate_kline_strength_5m(position.symbol)

    if position.position_side == 'LONG':
        # 15Må’Œ5Méƒ½å¼ºçƒˆçœ‹ç©º (net_power <= -6)
        if strength_15m <= -6 and strength_5m <= -6:
            return True, "ç´§æ€¥åè½¬: 15Må’Œ5Méƒ½è½¬ä¸ºå¼ºçƒˆçœ‹ç©º"

    elif position.position_side == 'SHORT':
        # 15Må’Œ5Méƒ½å¼ºçƒˆçœ‹å¤š (net_power >= 6)
        if strength_15m >= 6 and strength_5m >= 6:
            return True, "ç´§æ€¥åè½¬: 15Må’Œ5Méƒ½è½¬ä¸ºå¼ºçƒˆçœ‹å¤š"

    return False, ""
```

#### ä¼˜å…ˆçº§4: æ™ºèƒ½é¡¶åº•è¯†åˆ«

```python
def check_top_bottom_reversal(self, position, klines_1h, klines_4h, pnl_pct):
    """
    æ™ºèƒ½é¡¶åº•è¯†åˆ« - æ›¿ä»£å›ºå®šæ­¢ç›ˆ

    ä¼˜åŠ¿:
      1. åŸºäºKçº¿å¼ºåº¦åˆ¤æ–­ï¼Œä¸æ˜¯ç®€å•çš„ä»·æ ¼è§¦å‘
      2. åœ¨è¶‹åŠ¿åè½¬æ—©æœŸå°±èƒ½è¯†åˆ«
      3. 1Hå’Œ4HåŒé‡ç¡®è®¤ï¼Œé¿å…è™šå‡ä¿¡å·
    """

    # è®¡ç®—1Hå’Œ4H Kçº¿å¼ºåº¦
    strength_1h = self.calculate_kline_strength(klines_1h[-20:])
    strength_4h = self.calculate_kline_strength(klines_4h[-10:])

    if position.position_side == 'LONG':
        # å¤šå¤´è¯†åˆ«é¡¶éƒ¨
        if pnl_pct >= 2.0:  # æœ‰ç›ˆåˆ©
            # 1Hå’Œ4Héƒ½è½¬ä¸ºå¼ºçƒˆçœ‹ç©º
            if strength_1h <= -15 and strength_4h <= -10:
                return True, "æ™ºèƒ½é¡¶éƒ¨è¯†åˆ«: 1Hå’Œ4Héƒ½å¼ºçƒˆçœ‹ç©º"

    elif position.position_side == 'SHORT':
        # ç©ºå¤´è¯†åˆ«åº•éƒ¨
        if pnl_pct >= 2.0:  # æœ‰ç›ˆåˆ©
            # 1Hå’Œ4Héƒ½è½¬ä¸ºå¼ºçƒˆçœ‹å¤š
            if strength_1h >= 15 and strength_4h >= 10:
                return True, "æ™ºèƒ½åº•éƒ¨è¯†åˆ«: 1Hå’Œ4Héƒ½å¼ºçƒˆçœ‹å¤š"

    return False, ""
```

#### ä¼˜å…ˆçº§5: åŠ¨æ€è¶…æ—¶æ£€æŸ¥

```python
def check_dynamic_timeout(self, position):
    """
    åŠ¨æ€è¶…æ—¶æ£€æŸ¥

    è¶…æ—¶æ—¶é—´æ ¹æ®å¼€ä»“è¯„åˆ†åŠ¨æ€è®¡ç®—:
      è¯„åˆ† >= 80: 8å°æ—¶
      è¯„åˆ† >= 70: 6å°æ—¶
      è¯„åˆ† >= 60: 4å°æ—¶
      è¯„åˆ† >= 50: 3å°æ—¶
      è¯„åˆ† >= 40: 2å°æ—¶
      è¯„åˆ† < 40:  1å°æ—¶
    """

    if datetime.now() >= position.timeout_at:
        return True, "åˆ°è¾¾åŠ¨æ€è¶…æ—¶æ—¶é—´"

    return False, ""
```

#### ä¼˜å…ˆçº§6: åˆ†é˜¶æ®µè¶…æ—¶æ£€æŸ¥

```python
def check_staged_timeout(self, position, pnl_pct, minutes_held):
    """
    åˆ†é˜¶æ®µè¶…æ—¶æ£€æŸ¥

    æ—¶é—´è¶Šé•¿ï¼Œæ­¢æŸå®¹å¿åº¦è¶Šé«˜:
      1å°æ—¶: äºæŸ > -2.5% â†’ å¹³ä»“
      2å°æ—¶: äºæŸ > -2.0% â†’ å¹³ä»“
      3å°æ—¶: äºæŸ > -1.5% â†’ å¹³ä»“
      4å°æ—¶: äºæŸ > -1.0% â†’ å¹³ä»“
    """

    if minutes_held >= 60 and pnl_pct < -2.5:
        return True, "æŒä»“1Hä¸”äºæŸ>2.5%"

    if minutes_held >= 120 and pnl_pct < -2.0:
        return True, "æŒä»“2Hä¸”äºæŸ>2.0%"

    if minutes_held >= 180 and pnl_pct < -1.5:
        return True, "æŒä»“3Hä¸”äºæŸ>1.5%"

    if minutes_held >= 240 and pnl_pct < -1.0:
        return True, "æŒä»“4Hä¸”äºæŸ>1.0%"

    return False, ""
```

#### ä¼˜å…ˆçº§7: 4å°æ—¶ç»å¯¹æ‰˜åº•

```python
def check_max_holding_time(self, minutes_held):
    """4å°æ—¶ç»å¯¹å¼ºåˆ¶å¹³ä»“"""

    MAX_HOLD_MINUTES = 240  # 4å°æ—¶

    if minutes_held >= MAX_HOLD_MINUTES:
        return True, "åˆ°è¾¾æœ€å¤§æŒä»“æ—¶é—´(4H)"

    return False, ""
```

#### ä¼˜å…ˆçº§8: Kçº¿å¼ºåº¦è¡°å‡åˆ†æ‰¹å¹³ä»“

```python
def check_momentum_decay(self, position, klines_1h, pnl_pct, minutes_held):
    """
    Kçº¿å¼ºåº¦è¡°å‡æ£€æŸ¥ - æ¯15åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

    åˆ†é˜¶æ®µå¹³ä»“ç­–ç•¥:
      é˜¶æ®µ0 â†’ 1: ç›ˆåˆ©>=2% + å¼ºåº¦å¤§å¹…å‡å¼± â†’ å¹³ä»“50%
      é˜¶æ®µ1 â†’ 2: ç›ˆåˆ©>=4% + å¼ºåº¦å‡å¼± â†’ å†å¹³70%
      é˜¶æ®µ2 â†’ 3: æŒä»“>=5H æˆ– å¼ºåº¦<10 â†’ å¹³ä»“100%
    """

    current_strength = self.calculate_kline_strength(klines_1h[-20:])
    entry_strength = position.entry_kline_strength

    stage = position.partial_close_stage or 0

    # é˜¶æ®µ0 â†’ 1
    if stage == 0:
        if pnl_pct >= 2.0 and current_strength < entry_strength * 0.6:
            return {
                'action': 'partial_close',
                'percentage': 0.50,
                'new_stage': 1,
                'reason': 'ç›ˆåˆ©>=2%ä¸”Kçº¿å¼ºåº¦å¤§å¹…å‡å¼±'
            }

    # é˜¶æ®µ1 â†’ 2
    elif stage == 1:
        if pnl_pct >= 4.0 and current_strength < entry_strength * 0.8:
            return {
                'action': 'partial_close',
                'percentage': 0.70,
                'new_stage': 2,
                'reason': 'ç›ˆåˆ©>=4%ä¸”Kçº¿å¼ºåº¦å‡å¼±'
            }
        elif minutes_held >= 240 and current_strength < 15:
            return {
                'action': 'partial_close',
                'percentage': 0.70,
                'new_stage': 2,
                'reason': 'æŒä»“4Hä¸”Kçº¿å¼ºåº¦<15'
            }

    # é˜¶æ®µ2 â†’ 3
    elif stage == 2:
        if minutes_held >= 300:
            return {
                'action': 'full_close',
                'percentage': 1.0,
                'new_stage': 3,
                'reason': 'æŒä»“5Hï¼Œå…¨éƒ¨å¹³ä»“'
            }
        elif current_strength < 10:
            return {
                'action': 'full_close',
                'percentage': 1.0,
                'new_stage': 3,
                'reason': 'Kçº¿å¼ºåº¦<10ï¼Œå…¨éƒ¨å¹³ä»“'
            }

    # ç‰¹æ®Šæ¡ä»¶: äºæŸ + æ–¹å‘åè½¬
    if pnl_pct < -1.0:
        if position.position_side == 'LONG' and current_strength < -10:
            return {
                'action': 'full_close',
                'percentage': 1.0,
                'reason': 'äºæŸ>1%ä¸”æ–¹å‘åè½¬(è½¬ä¸ºçœ‹ç©º)'
            }
        elif position.position_side == 'SHORT' and current_strength > 10:
            return {
                'action': 'full_close',
                'percentage': 1.0,
                'reason': 'äºæŸ>1%ä¸”æ–¹å‘åè½¬(è½¬ä¸ºçœ‹å¤š)'
            }

    return None
```

### 4.3 æ™ºèƒ½åˆ†æ‰¹å¹³ä»“æ—¶é—´çª—å£

**ç®—æ³•ä½ç½®**: `smart_exit_optimizer.py` ç¬¬460-597è¡Œ

#### æ—¶é—´è½´è®¾è®¡

```
å‡è®¾ planned_close_time = 11:46

T-30 (11:16): å¯åŠ¨æ™ºèƒ½å¹³ä»“ç›‘æ§
    â”‚
    â”œâ”€ å¯åŠ¨ä»·æ ¼é‡‡æ ·å™¨
    â”œâ”€ 10åˆ†é’Ÿçª—å£é‡‡é›†ä»·æ ¼
    â””â”€ å»ºç«‹ä»·æ ¼åŸºçº¿ (min/max/p25/p50/p75)
       â†“
T-20 (11:26): åŸºçº¿å»ºç«‹å®Œæˆ
    â”‚
    â”œâ”€ å¼€å§‹å¯»æ‰¾æœ€ä½³å¹³ä»“ä»·æ ¼
    â”œâ”€ æ¯ç§’æ£€æŸ¥ä»·æ ¼è¯„åˆ†
    â”‚
    â””â”€ å¹³ä»“æ¡ä»¶:
        â”œâ”€ è¯„åˆ† >= 95 â†’ ç«‹å³å¹³ä»“
        â”œâ”€ è¯„åˆ† >= 85 â†’ ç«‹å³å¹³ä»“
        â”œâ”€ çªç ´åŸºçº¿æå€¼ â†’ å¹³ä»“
        â”œâ”€ å¼ºåå‘è¶‹åŠ¿ â†’ åŠæ—¶æ­¢æŸ
        â””â”€ æ¥è¿‘æˆªæ­¢(è¯„åˆ† >= 60) â†’ å¹³ä»“
       â†“
T+0 (11:46): è®¡åˆ’å¹³ä»“æ—¶é—´
    â”‚
    â””â”€ æ— è®ºä»·æ ¼å¦‚ä½•ï¼Œå¼ºåˆ¶ä¸€æ¬¡æ€§å¹³ä»“100%
```

#### å¹³ä»“ä»·æ ¼è¯„åˆ†ç®—æ³•

```python
def calculate_exit_price_score(self, price, baseline, side):
    """
    è®¡ç®—å¹³ä»“ä»·æ ¼è¯„åˆ† (0-100åˆ†)

    LONGå¤´å¯¸: å¸Œæœ›åœ¨é«˜ä½å¹³ä»“
    SHORTå¤´å¯¸: å¸Œæœ›åœ¨ä½ä½å¹³ä»“
    """

    if side == 'LONG':
        # åšå¤šå¸Œæœ›é«˜ä»·å–å‡º
        if price >= baseline.max_price:
            score = 100  # çªç ´åŸºçº¿æœ€é«˜ä»·
        elif price >= baseline.p75:
            score = 95   # 75åˆ†ä½ä»¥ä¸Š
        elif price >= baseline.p50:
            score = 85   # 50åˆ†ä½ä»¥ä¸Š
        elif price >= baseline.p25:
            score = 70   # 25åˆ†ä½ä»¥ä¸Š
        else:
            score = 50   # ä½äº25åˆ†ä½

        # è¶‹åŠ¿è°ƒæ•´
        if baseline.trend == 'down':
            score -= 10  # ä¸‹è·Œè¶‹åŠ¿ï¼Œé™ä½è¯„åˆ†
        elif baseline.trend == 'up':
            score += 10  # ä¸Šæ¶¨è¶‹åŠ¿ï¼Œæé«˜è¯„åˆ†

    elif side == 'SHORT':
        # åšç©ºå¸Œæœ›ä½ä»·ä¹°å›
        if price <= baseline.min_price:
            score = 100  # è·Œç ´åŸºçº¿æœ€ä½ä»·
        elif price <= baseline.p25:
            score = 95   # 25åˆ†ä½ä»¥ä¸‹
        elif price <= baseline.p50:
            score = 85   # 50åˆ†ä½ä»¥ä¸‹
        elif price <= baseline.p75:
            score = 70   # 75åˆ†ä½ä»¥ä¸‹
        else:
            score = 50   # é«˜äº75åˆ†ä½

        # è¶‹åŠ¿è°ƒæ•´
        if baseline.trend == 'up':
            score -= 10  # ä¸Šæ¶¨è¶‹åŠ¿ï¼Œé™ä½è¯„åˆ†
        elif baseline.trend == 'down':
            score += 10  # ä¸‹è·Œè¶‹åŠ¿ï¼Œæé«˜è¯„åˆ†

    return max(0, min(100, score))
```

### 4.4 ä»·æ ¼è·å–å¤šçº§é™çº§ç­–ç•¥

```python
async def get_current_price(self, symbol):
    """
    è·å–å®æ—¶ä»·æ ¼ - ä¸‰çº§é™çº§

    ä¼˜å…ˆçº§1: WebSocketå®æ—¶ä»·æ ¼ (å»¶è¿Ÿ<5ç§’)
    ä¼˜å…ˆçº§2: REST APIå®æ—¶ä»·æ ¼ (å»¶è¿Ÿ<30ç§’)
    ä¼˜å…ˆçº§3: 5åˆ†é’ŸKçº¿æ”¶ç›˜ä»· (é™çº§)
    """

    try:
        # ä¼˜å…ˆçº§1: WebSocket
        price = self.ws_price_cache.get(symbol)
        if price and self.is_price_fresh(price, max_age=5):
            return price['last']
    except Exception as e:
        logger.warning(f"WSä»·æ ¼è·å–å¤±è´¥: {e}")

    try:
        # ä¼˜å…ˆçº§2: REST API
        ticker = await self.exchange.fetch_ticker(symbol)
        return ticker['last']
    except Exception as e:
        logger.warning(f"REST APIä»·æ ¼è·å–å¤±è´¥: {e}")

    try:
        # ä¼˜å…ˆçº§3: Kçº¿é™çº§
        klines = await self.exchange.fetch_ohlcv(symbol, '5m', limit=1)
        logger.warning(f"{symbol} ä»·æ ¼è·å–é™çº§åˆ°5m Kçº¿")
        return klines[0][4]  # close price
    except Exception as e:
        logger.error(f"æ‰€æœ‰ä»·æ ¼è·å–æ–¹å¼å¤±è´¥: {e}")
        return None
```

---

## äº”ã€æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢ç³»ç»Ÿæ·±åº¦è§£æ

### 5.1 SafeModeSwitcheræ¶æ„

**æ–‡ä»¶**: `app/strategies/safe_mode_switcher.py`

### 5.2 ä¸¤ç§äº¤æ˜“æ¨¡å¼å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‚æ•°      â”‚   è¶‹åŠ¿æ¨¡å¼    â”‚   éœ‡è¡æ¨¡å¼    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§¦å‘æ¡ä»¶    â”‚ Big4å¼ºçƒˆæ–¹å‘  â”‚ Big4ä¸­æ€§ä¿¡å·  â”‚
â”‚             â”‚ å¼ºåº¦ >= 70   â”‚ å¼ºåº¦ < 40    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å»ºä»“æ–¹å¼    â”‚ åˆ†æ‰¹å»ºä»“      â”‚ ä¸€æ¬¡æ€§å…¥åœº   â”‚
â”‚             â”‚ 30/30/40     â”‚ 100%        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŒä»“æ—¶é—´    â”‚ 4å°æ—¶        â”‚ 2å°æ—¶       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­¢æŸ        â”‚ 2%          â”‚ 5%          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ­¢ç›ˆ        â”‚ 6%          â”‚ 2%          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»“ä½å¤§å°    â”‚ Big4è°ƒæ•´     â”‚ å›ºå®š1.0      â”‚
â”‚             â”‚ (é¡ºåŠ¿Ã—1.2)   â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Big4è¿‡æ»¤    â”‚ æ˜¯          â”‚ å¦           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€‚ç”¨åœºæ™¯    â”‚ æ˜ç¡®è¶‹åŠ¿å¸‚   â”‚ é«˜ä½éœ‡è¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ä¸‰çº§ç¡®è®¤æœºåˆ¶(é˜²æ­¢é¢‘ç¹åˆ‡æ¢)

```python
def validate_confirmation(self, target_mode):
    """
    éªŒè¯æ¨¡å¼åˆ‡æ¢ç¡®è®¤
    éœ€è¦æœ€è¿‘3æ¬¡Big4æ£€æµ‹éƒ½æ»¡è¶³åˆ‡æ¢æ¡ä»¶

    ä¸‰çº§æ£€æŸ¥:
      1. è¿ç»­3æ¬¡ç¡®è®¤
      2. æ£€æµ‹é—´éš” >= 15åˆ†é’Ÿ
      3. æ—¶é—´åå·® <= 2åˆ†é’Ÿ(ç¡®ä¿ç‹¬ç«‹æ£€æµ‹)
    """

    recent_signals = self.get_recent_big4_signals(count=3)

    # æ£€æŸ¥1: è®°å½•æ•°é‡
    if len(recent_signals) < 3:
        logger.warning("Big4å†å²è®°å½•ä¸è¶³3æ¡ï¼Œæ— æ³•ç¡®è®¤åˆ‡æ¢")
        return False

    # æ£€æŸ¥2: æ—¶é—´é—´éš”(ç¡®ä¿æ˜¯ç‹¬ç«‹çš„æ£€æµ‹)
    for i in range(len(recent_signals) - 1):
        time_diff = (recent_signals[i]['created_at'] -
                     recent_signals[i+1]['created_at']).total_seconds() / 60

        # å…è®¸2åˆ†é’Ÿè¯¯å·®
        if time_diff < 15 - 2:
            logger.warning(f"Big4æ£€æµ‹æ—¶é—´é—´éš”è¿‡çŸ­({time_diff:.1f}åˆ†é’Ÿ)")
            return False

    # æ£€æŸ¥3: éªŒè¯æ˜¯å¦è¿ç»­æ»¡è¶³æ¡ä»¶
    if target_mode == 'range':
        # éœ‡è¡æ¨¡å¼: éœ€è¦è¿ç»­3æ¬¡éƒ½æ˜¯ NEUTRAL ä¸”å¼ºåº¦ < 40
        for signal in recent_signals:
            if signal['overall_signal'] != 'NEUTRAL' or \
               signal['signal_strength'] >= 40:
                logger.info(f"âŒ éœ‡è¡ç¡®è®¤å¤±è´¥: "
                           f"{signal['overall_signal']}({signal['signal_strength']:.1f})")
                return False

        logger.info("âœ… éœ‡è¡æ¨¡å¼ç¡®è®¤é€šè¿‡: è¿ç»­3æ¬¡ NEUTRAL + å¼ºåº¦<40")
        return True

    elif target_mode == 'trend':
        # è¶‹åŠ¿æ¨¡å¼: éœ€è¦è¿ç»­3æ¬¡éƒ½æ˜¯ BULLISH/BEARISH ä¸”å¼ºåº¦ >= 70
        for signal in recent_signals:
            if signal['overall_signal'] not in ['BULLISH', 'BEARISH'] or \
               signal['signal_strength'] < 70:
                logger.info(f"âŒ è¶‹åŠ¿ç¡®è®¤å¤±è´¥: "
                           f"{signal['overall_signal']}({signal['signal_strength']:.1f})")
                return False

        logger.info("âœ… è¶‹åŠ¿æ¨¡å¼ç¡®è®¤é€šè¿‡: è¿ç»­3æ¬¡è¶‹åŠ¿ä¿¡å· + å¼ºåº¦>=70")
        return True

    return False
```

### 5.4 ç¼“å†²åŒºè®¾è®¡(é˜²æ­¢è¾¹ç•Œéœ‡è¡)

```
Big4å¼ºåº¦åŒºé—´åˆ’åˆ†:
    â”‚
    â”œâ”€ 0-39:   éœ‡è¡æ¨¡å¼åŒºåŸŸ
    â”‚
    â”œâ”€ 40-69:  ç¼“å†²åŒº(ä¸åˆ‡æ¢)
    â”‚
    â””â”€ 70-100: è¶‹åŠ¿æ¨¡å¼åŒºåŸŸ

ç¤ºä¾‹:
  å½“å‰: éœ‡è¡æ¨¡å¼, Big4å¼ºåº¦ 38
  å˜åŒ–: Big4å¼ºåº¦å‡è‡³ 55
  ç»“æœ: ä¿æŒéœ‡è¡æ¨¡å¼ (åœ¨ç¼“å†²åŒºå†…)

  å˜åŒ–: Big4å¼ºåº¦å‡è‡³ 72
  ç»“æœ: åˆ‡æ¢åˆ°è¶‹åŠ¿æ¨¡å¼ (æ»¡è¶³3æ¬¡ç¡®è®¤å)
```

### 5.5 å†·å´æœŸæœºåˆ¶

```python
def check_cooldown_period(self, current_config):
    """
    å†·å´æœŸæ£€æŸ¥

    æœ€å°å†·å´æœŸ: 6å°æ—¶
    ç¡®ä¿ç³»ç»Ÿæœ‰è¶³å¤Ÿæ—¶é—´éªŒè¯å½“å‰æ¨¡å¼
    """

    MIN_COOLDOWN_MINUTES = 360  # 6å°æ—¶

    if current_config.get('last_switch_time'):
        last_switch = current_config['last_switch_time']
        cooldown_minutes = max(
            current_config.get('switch_cooldown_minutes', 120),
            MIN_COOLDOWN_MINUTES
        )

        cooldown_end = last_switch + timedelta(minutes=cooldown_minutes)

        if datetime.now() < cooldown_end:
            remaining = (cooldown_end - datetime.now()).total_seconds() / 60
            logger.info(f"â³ å†·å´æœŸä¸­ï¼Œå‰©ä½™{remaining:.1f}åˆ†é’Ÿ")
            return False

    return True
```

### 5.6 ç´§æ€¥åˆ‡æ¢ä¿æŠ¤(æŒä»“æ—¶)

```python
def check_urgent_switch_needed(self, current_mode, big4_strength, open_positions_count):
    """
    å³ä½¿æœ‰æŒä»“ï¼Œä¹Ÿå…è®¸ç´§æ€¥åˆ‡æ¢çš„åœºæ™¯

    åœºæ™¯1: è¶‹åŠ¿å¸‚ â†’ éœ‡è¡å¸‚ (å¼ºåº¦ä»>60é™åˆ°<40)
      åŸå› : é«˜ä½éœ‡è¡æ—¶ç”¨3%æ­¢æŸå¾ˆå±é™©

    åœºæ™¯2: éœ‡è¡å¸‚ â†’ è¶‹åŠ¿å¸‚ (å¼ºåº¦ä»<40å‡åˆ°>70)
      åŸå› : ä¸èƒ½é”™è¿‡æ˜ç¡®çš„è¶‹åŠ¿æœºä¼š
    """

    if open_positions_count == 0:
        return False

    needs_urgent_switch = False

    # æƒ…å†µ1: è¶‹åŠ¿å¸‚â†’éœ‡è¡å¸‚
    if current_mode == 'trend' and big4_strength < 40:
        needs_urgent_switch = True
        logger.warning(
            f"âš ï¸ Big4è½¬ä¸ºéœ‡è¡({big4_strength:.1f}), "
            f"è™½æœ‰{open_positions_count}ä¸ªæŒä»“ä½†å…è®¸åˆ‡æ¢(ä¿æŠ¤èµ„é‡‘)"
        )

    # æƒ…å†µ2: éœ‡è¡å¸‚â†’è¶‹åŠ¿å¸‚
    elif current_mode == 'range' and big4_strength >= 70:
        needs_urgent_switch = True
        logger.warning(
            f"âš ï¸ Big4è½¬ä¸ºè¶‹åŠ¿({big4_strength:.1f}), "
            f"è™½æœ‰{open_positions_count}ä¸ªæŒä»“ä½†å…è®¸åˆ‡æ¢(æŠ“ä½æœºä¼š)"
        )

    return needs_urgent_switch
```

### 5.7 å®Œæ•´åˆ‡æ¢é€»è¾‘

```python
def safe_auto_switch_check(self, account_id, trading_type, big4_signal, big4_strength):
    """
    å®‰å…¨çš„è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢æ£€æŸ¥

    Returns:
        åˆ‡æ¢å»ºè®®å­—å…¸æˆ–None
    """

    current_config = self.get_current_mode(account_id, trading_type)
    if not current_config:
        return None

    # æ£€æŸ¥1: æ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆ‡æ¢
    if not current_config.get('auto_switch_enabled'):
        return None

    current_mode = current_config['mode_type']

    # æ£€æŸ¥2: æŒä»“æ£€æŸ¥
    open_positions_count = self.check_open_positions(account_id)

    if open_positions_count > 0:
        # åˆ¤æ–­æ˜¯å¦éœ€è¦ç´§æ€¥åˆ‡æ¢
        if not self.check_urgent_switch_needed(current_mode, big4_strength,
                                               open_positions_count):
            logger.info(f"æœ‰{open_positions_count}ä¸ªæŒä»“ä¸”æ— ç´§æ€¥åˆ‡æ¢éœ€æ±‚ï¼Œ"
                       f"ä¿æŒ{current_mode}æ¨¡å¼")
            return None

    # æ£€æŸ¥3: å†·å´æœŸæ£€æŸ¥
    if not self.check_cooldown_period(current_config):
        return None

    # æ£€æŸ¥4: åˆ¤æ–­å»ºè®®çš„æ¨¡å¼
    suggested_mode = None

    # éœ‡è¡å¸‚åˆ¤æ–­
    if big4_signal == 'NEUTRAL' and big4_strength < 40:
        if current_mode != 'range':
            suggested_mode = 'range'

    # è¶‹åŠ¿å¸‚åˆ¤æ–­
    elif big4_signal in ['BULLISH', 'BEARISH'] and big4_strength >= 70:
        if current_mode != 'trend':
            suggested_mode = 'trend'

    if not suggested_mode:
        # åœ¨ç¼“å†²åŒºå†…(40-70)ï¼Œä¸åšåˆ‡æ¢
        if 40 <= big4_strength < 70:
            logger.info(f"å¼ºåº¦åœ¨ç¼“å†²åŒº({big4_strength:.1f})ï¼Œä¿æŒ{current_mode}æ¨¡å¼")
        return None

    # æ£€æŸ¥5: è¿ç»­ç¡®è®¤éªŒè¯
    if not self.validate_confirmation(suggested_mode):
        logger.warning(f"åˆ‡æ¢åˆ°{suggested_mode}æ¨¡å¼æœªé€šè¿‡è¿ç»­ç¡®è®¤")
        return None

    # æ‰€æœ‰æ£€æŸ¥é€šè¿‡
    return {
        'suggested_mode': suggested_mode,
        'reason': f'Big4: {big4_signal}({big4_strength:.1f}), è¿ç»­3æ¬¡ç¡®è®¤',
        'safety_checks': {
            'auto_enabled': True,
            'open_positions': open_positions_count,
            'cooldown_passed': True,
            'confirmation_passed': True,
            'current_mode': current_mode,
            'target_mode': suggested_mode
        }
    }
```

---

## å…­ã€å®Œæ•´äº¤æ˜“æµç¨‹

### 6.1 å¼€ä»“æµç¨‹

```
ã€ç¬¬1æ­¥ã€‘ä¿¡å·ç”Ÿæˆ (æ¯5åˆ†é’Ÿæ‰«æ)
    â”‚
    â”œâ”€ åŠ è½½Kçº¿æ•°æ® (1D/1H/15M, 72å°æ—¶)
    â”œâ”€ è®¡ç®—10ç§ä¿¡å·ç»„ä»¶è¯„åˆ†
    â”œâ”€ å åŠ å¾—åˆ° long_score å’Œ short_score
    â””â”€ åˆ¤æ–­: score >= 35 ?
        â”œâ”€ Yes â†’ ç»§ç»­
        â””â”€ No  â†’ è·³è¿‡
           â†“
ã€ç¬¬2æ­¥ã€‘Big4è¶‹åŠ¿æ£€æµ‹
    â”‚
    â”œâ”€ è·å–Big4ä¿¡å· (ç¼“å­˜1å°æ—¶)
    â”œâ”€ Big4 = BEARISH + LONGä¿¡å· â†’ é™åˆ†æˆ–è·³è¿‡
    â”œâ”€ Big4 = BULLISH + SHORTä¿¡å· â†’ é™åˆ†æˆ–è·³è¿‡
    â””â”€ Big4 é¡ºåŠ¿ä¿¡å· â†’ åŠ åˆ† + ä»“ä½Ã—1.2
           â†“
ã€ç¬¬3æ­¥ã€‘ä¿¡å·è¿‡æ»¤
    â”‚
    â”œâ”€ A. é»‘åå•æ£€æŸ¥
    â”‚   â”œâ”€ äº¤æ˜“å¯¹é»‘åå• (trading_blacklist)
    â”‚   â”œâ”€ ä¿¡å·ç»„åˆé»‘åå• (signal_blacklist)
    â”‚   â””â”€ 3çº§è¯„çº§ (trading_symbol_rating)
    â”‚       â””â”€ Level 3 â†’ ç¦æ­¢äº¤æ˜“
    â”‚
    â”œâ”€ B. é˜²è¿½é«˜/è¿½è·Œè¿‡æ»¤ (å·²ç¦ç”¨)
    â”‚
    â”œâ”€ C. æ—¶é—´æ¡†æ¶ä¸€è‡´æ€§
    â”‚   â”œâ”€ LONGä¸èƒ½æœ‰trend_1h_bear/trend_1d_bear
    â”‚   â””â”€ SHORTä¸èƒ½æœ‰trend_1h_bull/trend_1d_bull
    â”‚
    â””â”€ D. å†·å´æœŸæ£€æŸ¥ (1å°æ—¶)
           â†“
ã€ç¬¬4æ­¥ã€‘ä»“ä½è®¡ç®—
    â”‚
    â”œâ”€ åŸºç¡€ä»“ä½: 400 USDT
    â”œâ”€ è¯„çº§å€æ•°:
    â”‚   â”œâ”€ Level 0: 1.0x
    â”‚   â”œâ”€ Level 1: 0.25x
    â”‚   â”œâ”€ Level 2: 0.125x
    â”‚   â””â”€ Level 3: 0x (ç¦æ­¢)
    â”‚
    â”œâ”€ Big4å€æ•°:
    â”‚   â”œâ”€ é¡ºåŠ¿: 1.2x
    â”‚   â””â”€ å…¶ä»–: 1.0x
    â”‚
    â””â”€ æœ€ç»ˆä»“ä½ = åŸºç¡€ Ã— è¯„çº§ Ã— Big4
           â†“
ã€ç¬¬5æ­¥ã€‘åŠ¨æ€å‚æ•°è®¡ç®—
    â”‚
    â”œâ”€ åŠ¨æ€è¶…æ—¶æ—¶é—´ (æ ¹æ®entry_score)
    â”œâ”€ æ­¢ç›ˆ% (ä»symbol_volatility_profile)
    â”œâ”€ æ­¢æŸ% (æ³¢åŠ¨ç‡è°ƒæ•´)
    â””â”€ è®¡åˆ’å¹³ä»“æ—¶é—´ (åˆ†æ‰¹å»ºä»“ç»“æŸæ—¶é—´)
           â†“
ã€ç¬¬6æ­¥ã€‘æ‰§è¡Œå¼€ä»“
    â”‚
    â”œâ”€ é€‰æ‹©: åˆ†æ‰¹å»ºä»“ or ä¸€æ¬¡æ€§å¼€ä»“
    â”‚
    â”œâ”€ åˆ†æ‰¹å»ºä»“æµç¨‹:
    â”‚   â”œâ”€ å¯åŠ¨ä»·æ ¼é‡‡æ · (5åˆ†é’ŸåŸºçº¿)
    â”‚   â”œâ”€ ç¬¬1æ‰¹: 30% (5-15åˆ†é’Ÿæœ€ä¼˜ä»·)
    â”‚   â”œâ”€ ç¬¬2æ‰¹: 30% (å›è°ƒåŠ ä»“)
    â”‚   â””â”€ ç¬¬3æ‰¹: 40% (é‡ä»“æŠ¼å®)
    â”‚
    â””â”€ è®°å½•æŒä»“ä¿¡æ¯:
        â”œâ”€ entry_signal_type
        â”œâ”€ signal_components
        â”œâ”€ entry_price
        â”œâ”€ stop_loss_price
        â”œâ”€ take_profit_price
        â”œâ”€ timeout_at
        â””â”€ planned_close_time
           â†“
ã€ç¬¬7æ­¥ã€‘å¯åŠ¨ç›‘æ§
    â”‚
    â””â”€ SmartExitOptimizer.start_monitoring(position_id)
```

### 6.2 å¹³ä»“æµç¨‹

```
ã€ç›‘æ§å¾ªç¯ã€‘æ¯1ç§’æ£€æŸ¥
    â”‚
    â”œâ”€ è·å–å®æ—¶ä»·æ ¼ (WS â†’ REST â†’ Kçº¿)
    â”œâ”€ è®¡ç®—å½“å‰ç›ˆäº%
    â””â”€ æ›´æ–°æœ€é«˜ç›ˆåˆ©è®°å½•
           â†“
ã€ä¼˜å…ˆçº§0ã€‘æœ€å°æŒä»“æ—¶é—´æ£€æŸ¥ (2å°æ—¶)
    â”‚
    â””â”€ æœªæ»¡2å°æ—¶ â†’ åªæ£€æŸ¥æ­¢æŸæ­¢ç›ˆ
           â†“
ã€ä¼˜å…ˆçº§1ã€‘å›ºå®šæ­¢æŸ (æ— æ—¶é—´é™åˆ¶)
    â”‚
    â”œâ”€ LONG: price <= stop_loss_price â†’ å¹³ä»“
    â””â”€ SHORT: price >= stop_loss_price â†’ å¹³ä»“
           â†“
ã€ä¼˜å…ˆçº§2ã€‘å›ºå®šæ­¢ç›ˆ
    â”‚
    â”œâ”€ LONG: price >= take_profit_price â†’ å¹³ä»“
    â””â”€ SHORT: price <= take_profit_price â†’ å¹³ä»“
           â†“
ã€ä¼˜å…ˆçº§3ã€‘ç´§æ€¥åè½¬ä¿æŠ¤ (30åˆ†é’Ÿå)
    â”‚
    â”œâ”€ äºæŸ > 1.5%
    â””â”€ 15Må’Œ5Méƒ½å¼ºçƒˆåè½¬ â†’ å¹³ä»“
           â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€æ»¡è¶³2å°æ—¶æœ€å°æŒä»“æ—¶é—´å...ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           â†“
ã€ä¼˜å…ˆçº§4ã€‘æ™ºèƒ½é¡¶åº•è¯†åˆ«
    â”‚
    â”œâ”€ LONG: ç›ˆåˆ©>=2% + 1Hå’Œ4Héƒ½å¼ºçƒˆçœ‹ç©º â†’ å¹³ä»“
    â””â”€ SHORT: ç›ˆåˆ©>=2% + 1Hå’Œ4Héƒ½å¼ºçƒˆçœ‹å¤š â†’ å¹³ä»“
           â†“
ã€ä¼˜å…ˆçº§5ã€‘åŠ¨æ€è¶…æ—¶æ£€æŸ¥
    â”‚
    â””â”€ now >= timeout_at â†’ å¹³ä»“
           â†“
ã€ä¼˜å…ˆçº§6ã€‘åˆ†é˜¶æ®µè¶…æ—¶
    â”‚
    â”œâ”€ 1H: äºæŸ>-2.5% â†’ å¹³ä»“
    â”œâ”€ 2H: äºæŸ>-2.0% â†’ å¹³ä»“
    â”œâ”€ 3H: äºæŸ>-1.5% â†’ å¹³ä»“
    â””â”€ 4H: äºæŸ>-1.0% â†’ å¹³ä»“
           â†“
ã€ä¼˜å…ˆçº§7ã€‘4å°æ—¶ç»å¯¹æ‰˜åº•
    â”‚
    â””â”€ æŒä»“>=4H â†’ å¼ºåˆ¶å¹³ä»“
           â†“
ã€ä¼˜å…ˆçº§8ã€‘Kçº¿å¼ºåº¦è¡°å‡ (æ¯15åˆ†é’Ÿæ£€æŸ¥)
    â”‚
    â”œâ”€ é˜¶æ®µ0â†’1: ç›ˆåˆ©>=2% + å¼ºåº¦å¤§å¹…å‡å¼± â†’ å¹³ä»“50%
    â”œâ”€ é˜¶æ®µ1â†’2: ç›ˆåˆ©>=4% + å¼ºåº¦å‡å¼± â†’ å†å¹³70%
    â”œâ”€ é˜¶æ®µ2â†’3: æŒä»“5H æˆ– å¼ºåº¦<10 â†’ å¹³ä»“100%
    â”œâ”€ ç‰¹æ®Š: äºæŸ>1% + æ–¹å‘åè½¬ â†’ å¹³ä»“100%
    â””â”€ ç‰¹æ®Š: 15Må¼ºåŠ›åè½¬ + äºæŸ â†’ å¹³ä»“100%
           â†“
ã€æ™ºèƒ½åˆ†æ‰¹å¹³ä»“çª—å£ã€‘(è®¡åˆ’å¹³ä»“å‰30åˆ†é’Ÿ)
    â”‚
    â”œâ”€ T-30 to T-20: å»ºç«‹10åˆ†é’Ÿä»·æ ¼åŸºçº¿
    â”‚
    â”œâ”€ T-20 to T+0: å¯»æ‰¾æœ€ä½³å¹³ä»“ç‚¹
    â”‚   â”œâ”€ è¯„åˆ†>=95 â†’ ç«‹å³å¹³ä»“
    â”‚   â”œâ”€ è¯„åˆ†>=85 â†’ ç«‹å³å¹³ä»“
    â”‚   â”œâ”€ çªç ´åŸºçº¿æå€¼ â†’ ç«‹å³å¹³ä»“
    â”‚   â”œâ”€ å¼ºåå‘è¶‹åŠ¿ â†’ åŠæ—¶æ­¢æŸ
    â”‚   â””â”€ æ¥è¿‘æˆªæ­¢ â†’ å¿…é¡»å¹³ä»“
    â”‚
    â””â”€ T+0: è®¡åˆ’å¹³ä»“æ—¶é—´ â†’ å¼ºåˆ¶ä¸€æ¬¡æ€§å¹³ä»“100%
```

---

## ä¸ƒã€æ ¸å¿ƒç®—æ³•è¯¦è§£

### 7.1 Kçº¿åŠ›åº¦è®¡ç®—å…¬å¼

```
Kçº¿åŠ›åº¦ = ä»·æ ¼å˜åŒ–% Ã— 0.8 + æˆäº¤é‡å½’ä¸€åŒ– Ã— 0.2

è¯¦ç»†è®¡ç®—:
  1. ä»·æ ¼å˜åŒ–% = (æ”¶ç›˜ä»· - å¼€ç›˜ä»·) / å¼€ç›˜ä»· Ã— 100
  2. æˆäº¤é‡å½’ä¸€åŒ– = (å½“å‰æˆäº¤é‡ - æœ€å°) / (æœ€å¤§ - æœ€å°) Ã— 100
  3. åŠ›åº¦åˆæˆ = ä»·æ ¼å˜åŒ–% Ã— 0.8 + æˆäº¤é‡å½’ä¸€åŒ– Ã— 0.2

ç¤ºä¾‹:
  BTCæŸæ ¹1H Kçº¿:
    å¼€ç›˜: 45000
    æ”¶ç›˜: 45900 (ä¸Šæ¶¨2%)
    æˆäº¤é‡: 1500 BTC (æœ€å¤§2000, æœ€å°500)

  è®¡ç®—:
    ä»·æ ¼å˜åŒ–% = (45900 - 45000) / 45000 Ã— 100 = 2.0%
    æˆäº¤é‡å½’ä¸€åŒ– = (1500 - 500) / (2000 - 500) Ã— 100 = 66.67
    åŠ›åº¦ = 2.0 Ã— 0.8 + 66.67 Ã— 0.2 = 1.6 + 13.33 = 14.93
```

### 7.2 ä¸»å¯¼æ–¹å‘ä¸‰ç»´åˆ¤æ–­

```
éœ€è¦æ»¡è¶³3ä¸ªæ¡ä»¶ä¸­çš„è‡³å°‘2ä¸ª:

ç»´åº¦1: é˜³çº¿/é˜´çº¿å æ¯”æ£€æŸ¥
  â”œâ”€ 30æ ¹Kçº¿ä¸­è‡³å°‘18æ ¹åŒå‘ (60%)
  â””â”€ 5æ ¹Kçº¿ä¸­è‡³å°‘3æ ¹åŒå‘ (60%)

ç»´åº¦2: åŠ›åº¦æ¯”å·®å¼‚æ£€æŸ¥
  â”œâ”€ å¤šç©ºåŠ›åº¦å·®å¼‚ > 20%
  â””â”€ max(bull_power, bear_power) / min(...) > 1.2

ç»´åº¦3: å¤§æ³¢åŠ¨Kçº¿æ•°é‡æ£€æŸ¥
  â”œâ”€ å•æ ¹Kçº¿æ¶¨è·Œå¹… > 3%
  â””â”€ æ•°é‡ >= æ€»Kçº¿æ•° Ã— 10% (è‡³å°‘2æ ¹)

åˆ¤æ–­é€»è¾‘:
  IF (æ»¡è¶³çš„æ¡ä»¶æ•° >= 2):
    ä¸»å¯¼æ–¹å‘æˆç«‹
  ELSE:
    éœ‡è¡å¸‚(NEUTRAL)
```

### 7.3 ä¿¡å·è¯„åˆ†æƒé‡ç³»ç»Ÿ

```
Big4ä¿¡å·è¯„åˆ† (æ€»åˆ†Â±100):

æƒé‡åˆ†é…:
  â”œâ”€ ä¿®æ­£å1Hæ–¹å‘ ... Â±60åˆ† (æƒé‡æœ€é«˜)
  â”œâ”€ 15Mè¶‹åŠ¿ç¡®è®¤ ..... Â±30åˆ†
  â””â”€ 5Mä¹°å–æ—¶æœº ....... Â±10åˆ†

æœ€ç»ˆåˆ¤æ–­:
  â”œâ”€ åˆ†æ•° > 30  â†’ BULLISH
  â”œâ”€ åˆ†æ•° < -30 â†’ BEARISH
  â””â”€ -30â‰¤åˆ†æ•°â‰¤30 â†’ NEUTRAL

ç¤ºä¾‹:
  BTC: 1Hä¿®æ­£å=BULL(+60) + 15M=BULL(+30) + 5M=BULL(+10) = +100 â†’ BULLISH
  ETH: 1Hä¿®æ­£å=BEAR(-60) + 15M=NEUTRAL(0) + 5M=BEAR(-10) = -70 â†’ BEARISH
  BNB: 1Hä¿®æ­£å=NEUTRAL(0) + 15M=BULL(+30) + 5M=NEUTRAL(0) = +30 â†’ NEUTRAL
  SOL: 1Hä¿®æ­£å=BULL(+60) + 15M=BEAR(-30) + 5M=BULL(+10) = +40 â†’ BULLISH

Big4æ•´ä½“ = BTCÃ—0.4 + ETHÃ—0.3 + BNBÃ—0.15 + SOLÃ—0.15
         = 100Ã—0.4 + (-70)Ã—0.3 + 30Ã—0.15 + 40Ã—0.15
         = 40 - 21 + 4.5 + 6
         = 29.5 â†’ NEUTRAL (è¾¹ç•Œå€¼)
```

### 7.4 ä»·æ ¼è¯„åˆ†ç®—æ³•(å»ºä»“/å¹³ä»“)

```
å»ºä»“ä»·æ ¼è¯„åˆ† (LONGä¸ºä¾‹):
  â”œâ”€ ä»·æ ¼ <= min_price .... 100åˆ† (è·Œç ´åŸºçº¿æœ€ä½)
  â”œâ”€ ä»·æ ¼ <= p25 ........... 95åˆ† (25åˆ†ä½ä»¥ä¸‹)
  â”œâ”€ ä»·æ ¼ <= p50 ........... 85åˆ† (50åˆ†ä½ä»¥ä¸‹)
  â”œâ”€ ä»·æ ¼ <= p75 ........... 70åˆ† (75åˆ†ä½ä»¥ä¸‹)
  â””â”€ ä»·æ ¼ > p75 ............ 50åˆ† (é«˜äº75åˆ†ä½)

è¶‹åŠ¿è°ƒæ•´:
  â”œâ”€ ä¸‹è·Œè¶‹åŠ¿ â†’ +10åˆ† (æ›´å¥½çš„ä¹°ç‚¹)
  â””â”€ ä¸Šæ¶¨è¶‹åŠ¿ â†’ -10åˆ† (è¿½é«˜é£é™©)

å¹³ä»“ä»·æ ¼è¯„åˆ† (LONGä¸ºä¾‹):
  â”œâ”€ ä»·æ ¼ >= max_price .... 100åˆ† (çªç ´åŸºçº¿æœ€é«˜)
  â”œâ”€ ä»·æ ¼ >= p75 ........... 95åˆ† (75åˆ†ä½ä»¥ä¸Š)
  â”œâ”€ ä»·æ ¼ >= p50 ........... 85åˆ† (50åˆ†ä½ä»¥ä¸Š)
  â”œâ”€ ä»·æ ¼ >= p25 ........... 70åˆ† (25åˆ†ä½ä»¥ä¸Š)
  â””â”€ ä»·æ ¼ < p25 ............ 50åˆ† (ä½äº25åˆ†ä½)

è¶‹åŠ¿è°ƒæ•´:
  â”œâ”€ ä¸Šæ¶¨è¶‹åŠ¿ â†’ +10åˆ† (æ›´å¥½çš„å–ç‚¹)
  â””â”€ ä¸‹è·Œè¶‹åŠ¿ â†’ -10åˆ† (ä¸‹è·Œè¶‹åŠ¿ä¸­å–å‡º)
```

---

## å…«ã€æ•°æ®åº“æ¶æ„

### 8.1 æ ¸å¿ƒè¡¨ç»“æ„

#### big4_trend_history (Big4è¶‹åŠ¿å†å²è¡¨)

```sql
CREATE TABLE big4_trend_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    overall_signal ENUM('BULLISH', 'BEARISH', 'NEUTRAL') NOT NULL,
    signal_strength DECIMAL(5,2),
    bullish_count INT,
    bearish_count INT,
    recommendation TEXT,

    -- BTCæ•°æ®
    btc_signal VARCHAR(20),
    btc_strength DECIMAL(5,2),
    btc_reason TEXT,
    btc_1h_30_dominant VARCHAR(20),
    btc_1h_5_dominant VARCHAR(20),
    btc_15m_dominant VARCHAR(20),

    -- ETHæ•°æ®
    eth_signal VARCHAR(20),
    eth_strength DECIMAL(5,2),
    eth_reason TEXT,
    eth_1h_30_dominant VARCHAR(20),
    eth_1h_5_dominant VARCHAR(20),
    eth_15m_dominant VARCHAR(20),

    -- BNBæ•°æ®
    bnb_signal VARCHAR(20),
    bnb_strength DECIMAL(5,2),
    bnb_reason TEXT,
    bnb_1h_30_dominant VARCHAR(20),
    bnb_1h_5_dominant VARCHAR(20),
    bnb_15m_dominant VARCHAR(20),

    -- SOLæ•°æ®
    sol_signal VARCHAR(20),
    sol_strength DECIMAL(5,2),
    sol_reason TEXT,
    sol_1h_30_dominant VARCHAR(20),
    sol_1h_5_dominant VARCHAR(20),
    sol_15m_dominant VARCHAR(20),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### futures_positions (æŒä»“è¡¨)

```sql
CREATE TABLE futures_positions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(50),
    position_side VARCHAR(10),  -- LONG/SHORT

    -- å¼€ä»“ä¿¡æ¯
    entry_signal_type VARCHAR(500),
    entry_score INT,
    signal_components JSON,
    entry_price DECIMAL(20, 8),
    quantity DECIMAL(20, 8),
    position_value DECIMAL(20, 8),
    leverage INT DEFAULT 5,

    -- æ­¢æŸæ­¢ç›ˆ
    stop_loss_price DECIMAL(20, 8),
    take_profit_price DECIMAL(20, 8),

    -- å®æ—¶ç›ˆäº
    mark_price DECIMAL(20, 8),
    unrealized_pnl DECIMAL(20, 8),
    unrealized_pnl_pct DECIMAL(10, 4),
    realized_pnl DECIMAL(20, 8),

    -- æœ€é«˜ç›ˆåˆ©è®°å½•
    max_profit_pct DECIMAL(10, 4),
    max_profit_price DECIMAL(20, 8),
    max_profit_time TIMESTAMP,

    -- åŠ¨æ€å‚æ•°
    timeout_at TIMESTAMP,
    planned_close_time TIMESTAMP,
    partial_close_stage INT DEFAULT 0,
    entry_kline_strength DECIMAL(10, 2),

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'open',
    close_time TIMESTAMP,
    close_reason VARCHAR(200),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_symbol_status (symbol, status),
    INDEX idx_status_created (status, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### trading_symbol_rating (äº¤æ˜“å¯¹è¯„çº§è¡¨)

```sql
CREATE TABLE trading_symbol_rating (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(50) UNIQUE NOT NULL,

    -- è¯„çº§ä¿¡æ¯
    rating_level INT DEFAULT 0,  -- 0=ç™½åå•, 1-3=é»‘åå•çº§åˆ«
    margin_multiplier DECIMAL(10,4) DEFAULT 1.0000,
    score_bonus INT DEFAULT 0,
    reason TEXT,

    -- ç»Ÿè®¡ä¿¡æ¯
    hard_stop_loss_count INT DEFAULT 0,
    total_loss_amount DECIMAL(20,8) DEFAULT 0,
    total_profit_amount DECIMAL(20,8) DEFAULT 0,
    win_rate DECIMAL(5,4) DEFAULT 0,
    total_trades INT DEFAULT 0,

    -- å˜æ›´å†å²
    previous_level INT,
    level_changed_at TIMESTAMP,
    level_change_reason VARCHAR(500),

    -- ç»Ÿè®¡å‘¨æœŸ
    stats_start_date DATE NOT NULL,
    stats_end_date DATE NOT NULL,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_rating_level (rating_level),
    INDEX idx_updated_at (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### trading_mode_config (æ¨¡å¼é…ç½®è¡¨)

```sql
CREATE TABLE trading_mode_config (
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_id INT UNIQUE NOT NULL,
    trading_type VARCHAR(50) NOT NULL,

    -- æ¨¡å¼é…ç½®
    mode_type ENUM('trend', 'range') DEFAULT 'trend',
    auto_switch_enabled BOOLEAN DEFAULT FALSE,
    switch_cooldown_minutes INT DEFAULT 360,

    -- åˆ‡æ¢å†å²
    last_switch_time TIMESTAMP,
    mode_change_reason VARCHAR(500),
    updated_by VARCHAR(100),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### trading_mode_switch_log (æ¨¡å¼åˆ‡æ¢æ—¥å¿—è¡¨)

```sql
CREATE TABLE trading_mode_switch_log (
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_id INT NOT NULL,
    trading_type VARCHAR(50),

    -- åˆ‡æ¢ä¿¡æ¯
    from_mode VARCHAR(20),
    to_mode VARCHAR(20),
    switch_trigger VARCHAR(20),  -- 'manual' or 'auto'

    -- Big4æ•°æ®
    big4_signal VARCHAR(20),
    big4_strength DECIMAL(5,2),

    -- å…¶ä»–ä¿¡æ¯
    reason VARCHAR(500),
    switched_by VARCHAR(100),
    switched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_account_time (account_id, switched_at),
    INDEX idx_trigger (switch_trigger)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## ä¹ã€ç³»ç»Ÿä¼˜åŠ¿æ€»ç»“

### 9.1 æ ¸å¿ƒæŠ€æœ¯ä¼˜åŠ¿

1. **30H+5HåŒé‡è¶‹åŠ¿éªŒè¯**
   - è§£å†³äº†æŒä»“4Hä½†ç”¨30Håˆ¤æ–­çš„æ—¶é—´ç»´åº¦ä¸åŒ¹é…é—®é¢˜
   - é€šè¿‡5Hå°è¶‹åŠ¿ä¿®æ­£30Hå¤§è¶‹åŠ¿ï¼Œç²¾å‡†è¯†åˆ«çŸ­æœŸåè½¬
   - é¿å…åœ¨è¶‹åŠ¿è½¬æŠ˜ç‚¹é€†åŠ¿å¼€ä»“

2. **Big4å¤šæƒé‡å¸‚åœºåˆ¤æ–­**
   - BTC 40% + ETH 30% + BNB 15% + SOL 15%
   - ç»¼åˆå››å¤§ä¸»æµå¸ç§ï¼Œå‡†ç¡®åæ˜ å¸‚åœºæ•´ä½“è¶‹åŠ¿
   - 1H/15M/5Må¤šçº§åˆ†æï¼Œæ—¶æœºæŠŠæ¡ç²¾å‡†

3. **æ™ºèƒ½åˆ†æ‰¹å»ºä»“(30/30/40)**
   - ç¬¬1æ‰¹è¯•æ¢ï¼Œç¬¬2æ‰¹å›è°ƒï¼Œç¬¬3æ‰¹é‡ä»“
   - ä»·æ ¼è¯„åˆ†ç³»ç»Ÿä¼˜åŒ–å»ºä»“ç‚¹ä½
   - Big4å†²çªæ£€æŸ¥ï¼Œç´§æ€¥å–æ¶ˆå»ºä»“

4. **8å±‚é£æ§ä½“ç³»**
   - ä»æ­¢æŸæ­¢ç›ˆåˆ°æ™ºèƒ½å¹³ä»“çš„å®Œæ•´ä¿æŠ¤
   - åˆ†é˜¶æ®µè¶…æ—¶é€’è¿›å¼æ­¢æŸ
   - Kçº¿å¼ºåº¦è¡°å‡åˆ†æ‰¹å¹³ä»“

5. **æ¨¡å¼è‡ªé€‚åº”åˆ‡æ¢**
   - è¶‹åŠ¿å¸‚(å¼ºåº¦>=70) vs éœ‡è¡å¸‚(å¼ºåº¦<40)
   - ä¸‰çº§ç¡®è®¤æœºåˆ¶ + ç¼“å†²åŒºè®¾è®¡
   - 6å°æ—¶å†·å´æœŸ + ç´§æ€¥åˆ‡æ¢ä¿æŠ¤

6. **å®æ—¶æ™ºèƒ½å¹³ä»“**
   - ç§’çº§ç›‘æ§ + ä»·æ ¼é™çº§ç­–ç•¥
   - è®¡åˆ’å¹³ä»“å‰30åˆ†é’Ÿæ™ºèƒ½çª—å£
   - ä»·æ ¼åŸºçº¿ä¼˜åŒ–å‡ºåœºç‚¹ä½

### 9.2 è®¾è®¡ç†å¿µä¼˜åŠ¿

1. **å¤šç»´åº¦éªŒè¯ï¼Œé¿å…å•ä¸€æŒ‡æ ‡è¯¯åˆ¤**
   - Kçº¿åŠ›åº¦è®¡ç®—: 80%ä»·æ ¼ + 20%æˆäº¤é‡
   - ä¸»å¯¼æ–¹å‘åˆ¤æ–­: 3ä¸ªæ¡ä»¶æ»¡è¶³è‡³å°‘2ä¸ª
   - è¶‹åŠ¿ä¿®æ­£é€»è¾‘: 30Hå’Œ5HåŒé‡ç¡®è®¤

2. **æ—¶é—´æ„ŸçŸ¥äº¤æ˜“**
   - ä¸åŒé˜¶æ®µä¸åŒè§„åˆ™
   - æœ€å°æŒä»“2å°æ—¶ä¿æŠ¤
   - åˆ†é˜¶æ®µè¶…æ—¶é€’è¿›å¼æ­¢æŸ
   - åŠ¨æ€è¶…æ—¶åŸºäºå¼€ä»“è¯„åˆ†

3. **é£é™©ä¼˜å…ˆï¼Œæ”¶ç›Šå…¶æ¬¡**
   - Big4å†²çªæ£€æŸ¥
   - ç´§æ€¥åè½¬ä¿æŠ¤
   - æ­¢æŸç†”æ–­æœºåˆ¶
   - 3çº§é»‘åå•åˆ¶åº¦

4. **çµæ´»æ€§ä¸ç¨³å®šæ€§å¹³è¡¡**
   - æ¨¡å¼åˆ‡æ¢æœ‰ä¸¥æ ¼ç¡®è®¤æœºåˆ¶
   - ç¼“å†²åŒºé˜²æ­¢è¾¹ç•Œéœ‡è¡
   - å†·å´æœŸä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œ

### 9.3 ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

**ç›®æ ‡ç»©æ•ˆ**:
- èƒœç‡ (Win Rate): >55%
- ç›ˆäºæ¯” (P/L Ratio): >2.0
- åˆ©æ¶¦å› å­ (Profit Factor): >1.5
- æœ€å¤§å›æ’¤ (Max Drawdown): <15%
- å¤æ™®æ¯”ç‡ (Sharpe Ratio): >1.5

**äº¤æ˜“æŒ‡æ ‡**:
- å¹³å‡æŒä»“æ—¶é—´: 4å°æ—¶
- å¹³å‡å…¥åœºè¯„åˆ†: >40åˆ†
- æ—¥å‡äº¤æ˜“æ•°: 10-20ç¬”
- Big4æ£€æµ‹é¢‘ç‡: 15åˆ†é’Ÿ/æ¬¡
- å¹³ä»“ç›‘æ§é¢‘ç‡: æ¯ç§’å®æ—¶

---

## åã€ä½¿ç”¨å»ºè®®

### 10.1 æ¨èé…ç½®

**ä¿å®ˆé…ç½®** (æ¨èæ–°æ‰‹):
```sql
-- ç¦ç”¨æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
UPDATE trading_mode_config
SET auto_switch_enabled = 0,
    mode_type = 'trend'
WHERE account_id = ä½ çš„è´¦æˆ·ID;

-- æé«˜å¼€ä»“é˜ˆå€¼
åŸºç¡€é˜ˆå€¼: 35åˆ† â†’ 45åˆ†
```

**æ¿€è¿›é…ç½®** (æœ‰ç»éªŒç”¨æˆ·):
```sql
-- å¯ç”¨æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
UPDATE trading_mode_config
SET auto_switch_enabled = 1,
    switch_cooldown_minutes = 360  -- 6å°æ—¶å†·å´
WHERE account_id = ä½ çš„è´¦æˆ·ID;
```

### 10.2 ç›‘æ§è¦ç‚¹

1. **Big4è¶‹åŠ¿ç›‘æ§**
   ```bash
   # æŸ¥çœ‹æœ€æ–°Big4ä¿¡å·
   SELECT * FROM big4_trend_history
   ORDER BY created_at DESC LIMIT 1;
   ```

2. **æŒä»“ç›‘æ§**
   ```bash
   # æŸ¥çœ‹å½“å‰æŒä»“
   SELECT symbol, position_side, unrealized_pnl_pct,
          TIMESTAMPDIFF(MINUTE, created_at, NOW()) as minutes_held
   FROM futures_positions
   WHERE status = 'open';
   ```

3. **æ¨¡å¼åˆ‡æ¢ç›‘æ§**
   ```bash
   # æŸ¥çœ‹æœ€è¿‘åˆ‡æ¢å†å²
   SELECT * FROM trading_mode_switch_log
   ORDER BY switched_at DESC LIMIT 10;
   ```

4. **è¯„çº§ç›‘æ§**
   ```bash
   # æŸ¥çœ‹é»‘åå•äº¤æ˜“å¯¹
   SELECT symbol, rating_level, margin_multiplier, reason
   FROM trading_symbol_rating
   WHERE rating_level > 0
   ORDER BY rating_level DESC;
   ```

### 10.3 æ—¥å¸¸è¿ç»´

**æ¯æ—¥æ£€æŸ¥**:
- Big4ä¿¡å·æ˜¯å¦æ­£å¸¸æ›´æ–°
- æŒä»“æ•°é‡å’Œç›ˆäºæƒ…å†µ
- æ˜¯å¦æœ‰å¼‚å¸¸é¢‘ç¹åˆ‡æ¢æ¨¡å¼

**æ¯å‘¨æ£€æŸ¥**:
- èƒœç‡å’Œç›ˆäºç»Ÿè®¡
- é»‘åå•äº¤æ˜“å¯¹æ›´æ–°
- ä¿¡å·ç»„åˆè¡¨ç°åˆ†æ

**æ¯æœˆæ£€æŸ¥**:
- ç³»ç»Ÿæ•´ä½“ç»©æ•ˆè¯„ä¼°
- å‚æ•°ä¼˜åŒ–å»ºè®®
- ç­–ç•¥è°ƒæ•´æ–¹å‘

---

## é™„å½•

### A. å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹Big4çŠ¶æ€
python -c "from app.services.big4_trend_detector import Big4TrendDetector; \
d = Big4TrendDetector(); r = d.detect_market_trend(); \
print(f\"ä¿¡å·: {r['overall_signal']} | å¼ºåº¦: {r['signal_strength']:.0f}\")"

# æŸ¥çœ‹å½“å‰æŒä»“
mysql -u user -p binance-data -e \
"SELECT symbol, position_side, unrealized_pnl_pct FROM futures_positions WHERE status='open';"

# æŸ¥çœ‹24Hç›ˆäº
mysql -u user -p binance-data -e \
"SELECT SUM(realized_pnl) as total_pnl, COUNT(*) as trades \
FROM futures_positions WHERE close_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR);"
```

### B. æ—¥å¿—æ ‡ç­¾è¯´æ˜

```
[BIG4-MARKET]    - Big4å¸‚åœºè¶‹åŠ¿åˆ¤æ–­
[BIG4-CORRECT]   - è¶‹åŠ¿ä¿®æ­£é€»è¾‘
[BIG4-SKIP]      - Big4è¿‡æ»¤è·³è¿‡çš„ä¿¡å·
[BIG4-ADJUST]    - Big4è°ƒæ•´åçš„è¯„åˆ†
[BIG4-CONFLICT]  - Big4å»ºä»“å†²çªæ£€æµ‹
[BATCH-ENTRY]    - åˆ†æ‰¹å»ºä»“æ‰§è¡Œ
[BATCH-1-DONE]   - ç¬¬1æ‰¹å»ºä»“å®Œæˆ
[BATCH-2-DONE]   - ç¬¬2æ‰¹å»ºä»“å®Œæˆ
[BATCH-3-DONE]   - ç¬¬3æ‰¹å»ºä»“å®Œæˆ
[SMART-EXIT]     - æ™ºèƒ½å¹³ä»“æ‰§è¡Œ
[MODE-SWITCH]    - æ¨¡å¼åˆ‡æ¢
[BLACKLIST]      - ä¿¡å·é»‘åå•è¿‡æ»¤
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: V4.0 å®Œæ•´æ·±åº¦ç‰ˆ
**æœ€åæ›´æ–°**: 2026-02-07
**ç»´æŠ¤è€…**: è¶…çº§å¤§è„‘å¼€å‘å›¢é˜Ÿ
**è”ç³»æ–¹å¼**: é€šè¿‡GitHub Issuesåé¦ˆé—®é¢˜

---

**ç»“è¯­**:

è¶…çº§å¤§è„‘(Big4)äº¤æ˜“ç³»ç»Ÿæ˜¯ä¸€ä¸ªç»è¿‡æ·±æ€ç†Ÿè™‘çš„æ™ºèƒ½åŒ–äº¤æ˜“å¹³å°ï¼Œèåˆäº†å¤šæ—¶é—´æ¡†æ¶åˆ†æã€æ™ºèƒ½åˆ†æ‰¹æ‰§è¡Œã€å¤šå±‚é£æ§ä¿æŠ¤å’Œè‡ªé€‚åº”æ¨¡å¼åˆ‡æ¢ç­‰å…ˆè¿›ç†å¿µã€‚ç³»ç»Ÿçš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äº:

1. **å‡†ç¡®æ€§**: 30H+5HåŒé‡éªŒè¯ + Big4å¤šå¸ç§ç¡®è®¤
2. **æ™ºèƒ½æ€§**: ä»·æ ¼è¯„åˆ†ç³»ç»Ÿ + åŠ¨æ€å‚æ•°è®¡ç®—
3. **å®‰å…¨æ€§**: 8å±‚é£æ§ä½“ç³» + ç´§æ€¥å¹²é¢„æœºåˆ¶
4. **é€‚åº”æ€§**: è¶‹åŠ¿/éœ‡è¡æ¨¡å¼è‡ªåŠ¨åˆ‡æ¢
5. **ç¨³å®šæ€§**: ä¸¥æ ¼çš„ç¡®è®¤æœºåˆ¶ + å†·å´æœŸä¿æŠ¤

å¸Œæœ›æœ¬æ–‡æ¡£èƒ½å¸®åŠ©ä½ å…¨é¢ç†è§£ç³»ç»Ÿçš„å·¥ä½œåŸç†ï¼Œåˆç†é…ç½®å‚æ•°ï¼Œæœ‰æ•ˆç›‘æ§è¿è¡ŒçŠ¶æ€ï¼Œæœ€ç»ˆå®ç°ç¨³å®šç›ˆåˆ©çš„ç›®æ ‡ã€‚
