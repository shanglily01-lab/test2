# 系统时间配置总结

## 破位系统时间配置

### 1. 开仓窗口：30分钟

**配置文件**：`app/services/breakout_convergence.py`

```python
config = {
    'max_duration': 4 * 3600,      # 4小时失效
    'opening_window': 30 * 60,     # 30分钟窗口 ✅
    'max_openings': 5,             # 每个币种最多5次
    'reversal_threshold': 0.01,    # 1%反转失效
    'trend_end_threshold': 0.02    # 2%趋势结束
}
```

**说明**：
- 破位检测后，有30分钟的时间可以开仓
- 超过30分钟，即使破位还有效，也不再生成新的开仓信号
- 破位信号最长有效4小时

### 2. 最大有效期：4小时

破位信号从检测到完全失效的最长时间：4小时

**时间线**：
```
T+0分钟：检测到破位
↓
T+30分钟：开仓窗口关闭（不再接受新开仓）
↓
T+4小时：破位信号失效（所有加权失效）
```

## 分批建仓时间配置

### 1. 默认窗口：30分钟

**配置文件**：`app/services/smart_entry_executor.py`

```python
# 第39行
self.time_window = 30  # 30分钟建仓窗口 ✅
```

**说明**：
- 如果没有K线强度评分，使用默认的30分钟窗口
- 分3批建仓：30% / 30% / 40%

### 2. 智能动态窗口：15/30/45分钟

**配置文件**：`app/analyzers/kline_strength_scorer.py`

```python
def get_entry_strategy(self, total_score: int):
    if total_score >= 30:
        # 极强信号 - 快速建仓
        return {
            'mode': 'aggressive',
            'window_minutes': 15,  # 15分钟 ✅
            'batch_ratio': [0.4, 0.3, 0.3],
            'max_hold_minutes': 360
        }
    elif total_score >= 20:
        # 标准信号 - 正常建仓
        return {
            'mode': 'standard',
            'window_minutes': 30,  # 30分钟 ✅
            'batch_ratio': [0.3, 0.3, 0.4],
            'max_hold_minutes': 240
        }
    else:
        # 弱信号 - 谨慎建仓
        return {
            'mode': 'conservative',
            'window_minutes': 45,  # 45分钟 ✅
            'batch_ratio': [0.2, 0.3, 0.5],
            'max_hold_minutes': 180
        }
```

**说明**：
- K线强度30+分：15分钟快速建仓（强势信号）
- K线强度20-29分：30分钟标准建仓（正常信号）
- K线强度20分以下：45分钟谨慎建仓（弱信号）

## 时间配置对比

| 类型 | 窗口时间 | 用途 | 配置文件 |
|------|---------|------|---------|
| **破位开仓窗口** | 30分钟 | 破位后可以开仓的时间 | breakout_convergence.py |
| **破位最大有效期** | 4小时 | 破位信号完全失效的时间 | breakout_convergence.py |
| **分批建仓(激进)** | 15分钟 | K线强度30+分 | kline_strength_scorer.py |
| **分批建仓(标准)** | 30分钟 | K线强度20-29分 | kline_strength_scorer.py |
| **分批建仓(保守)** | 45分钟 | K线强度<20分 | kline_strength_scorer.py |
| **分批建仓(默认)** | 30分钟 | 无K线评分时 | smart_entry_executor.py |

## 实际使用场景

### 场景1：破位 + 分批建仓配合

**例子**：检测到Big4向下破位

```python
# T+0分钟：检测到破位
breakout_result = brain.check_breakout()
# 结果：SHORT破位，强度85

# T+2分钟：生成DOGE信号
signal = generate_signal('DOGE/USDT')
# 包含K线强度评分：25分（标准强度）

# 启动分批建仓（30分钟窗口）
entry_result = await smart_entry_executor.execute_entry({
    'symbol': 'DOGE/USDT',
    'direction': 'SHORT',
    'amount': 1000,
    'kline_strength': {...},  # 25分 → 使用30分钟窗口
    'entry_strategy': {
        'mode': 'standard',
        'window_minutes': 30,
        'batch_ratio': [0.3, 0.3, 0.4]
    }
})

# 实际执行：
# T+2~5分钟：采样建立基线
# T+10分钟：第1批 30%
# T+20分钟：第2批 30%
# T+30分钟：第3批 40%
```

**时间关系**：
- 破位开仓窗口：30分钟（T+0 到 T+30）
- 分批建仓窗口：30分钟（T+2 到 T+32）
- 两个窗口基本重合

### 场景2：破位窗口内多次开仓

```python
# T+0分钟：检测到破位 (SHORT, 强度85)

# T+5分钟：DOGE第1次信号
result = brain.should_trade('DOGE/USDT', 80, 'SHORT')
# ✅ 开仓 (DOGE 1/5)
# 启动30分钟分批建仓

# T+12分钟：DOGE第2次信号
result = brain.should_trade('DOGE/USDT', 85, 'SHORT')
# ✅ 开仓 (DOGE 2/5)
# 启动30分钟分批建仓

# T+28分钟：DOGE第3次信号
result = brain.should_trade('DOGE/USDT', 88, 'SHORT')
# ✅ 开仓 (DOGE 3/5)
# 启动30分钟分批建仓

# T+35分钟：DOGE第4次信号
result = brain.should_trade('DOGE/USDT', 90, 'SHORT')
# ❌ 拒绝：超过破位开仓窗口(30分钟)
```

### 场景3：K线强度影响建仓速度

**强势信号（K线强度35分）**：

```python
entry_strategy = {
    'mode': 'aggressive',
    'window_minutes': 15,  # 快速建仓
    'batch_ratio': [0.4, 0.3, 0.3]
}

# T+0~3分钟：采样
# T+5分钟：第1批 40%
# T+10分钟：第2批 30%
# T+15分钟：第3批 30%
# 15分钟完成建仓 ✅
```

**弱势信号（K线强度12分）**：

```python
entry_strategy = {
    'mode': 'conservative',
    'window_minutes': 45,  # 谨慎建仓
    'batch_ratio': [0.2, 0.3, 0.5]
}

# T+0~5分钟：采样
# T+15分钟：第1批 20%
# T+30分钟：第2批 30%
# T+45分钟：第3批 50%
# 45分钟完成建仓 ✅
```

## 优化建议

### 当前配置的优点

1. ✅ **破位窗口30分钟**：与分批建仓窗口一致，协调性好
2. ✅ **分批建仓15-45分钟**：覆盖不同信号强度，灵活性高
3. ✅ **破位有效期4小时**：足够长，可以捕捉持续趋势
4. ✅ **每个币种可开5次**：给予足够的加仓机会

### 可能的问题

1. ⚠️ **窗口重叠**：破位开仓窗口和分批建仓窗口重叠
   - 解决方案：优先使用分批建仓，避免重复开仓

2. ⚠️ **快速建仓冲突**：15分钟建仓可能在破位窗口内多次触发
   - 解决方案：限制同一币种在30分钟内最多开2次

3. ⚠️ **资金占用**：多个币种同时分批建仓，资金压力大
   - 解决方案：限制同时进行的分批建仓数量（最多3个）

### 推荐的风控参数

```python
# 破位系统
max_openings_per_symbol = 5       # 每个币种最多5个仓位
opening_window = 30 * 60          # 30分钟开仓窗口
max_duration = 4 * 3600           # 4小时最大有效期

# 分批建仓
aggressive_window = 15            # 强势信号：15分钟
standard_window = 30              # 标准信号：30分钟
conservative_window = 45          # 弱势信号：45分钟

# 额外风控
max_concurrent_batches = 3        # 最多3个并发分批建仓
min_batch_interval = 15           # 同一币种两次建仓最少间隔15分钟
max_total_margin = 5000           # 最大总保证金5000 USDT
```

## 配置文件清单

需要修改的文件：

1. ✅ **breakout_convergence.py** - 已修改
   - opening_window: 30分钟
   - max_openings: 5次

2. ✅ **smart_entry_executor.py** - 已修改
   - time_window: 30分钟（默认）

3. ✅ **kline_strength_scorer.py** - 无需修改
   - 已有15/30/45分钟配置

## 总结

### 当前时间配置

| 参数 | 值 | 状态 |
|------|---|------|
| 破位开仓窗口 | 30分钟 | ✅ 已优化 |
| 破位最大有效期 | 4小时 | ✅ 合理 |
| 分批建仓（激进） | 15分钟 | ✅ 已优化 |
| 分批建仓（标准） | 30分钟 | ✅ 已优化 |
| 分批建仓（保守） | 45分钟 | ✅ 已优化 |
| 每币种最多开仓 | 5次 | ✅ 已优化 |

### 关键改动

1. ✅ 破位系统：同一币种可开5个仓位（而非1个）
2. ✅ 破位系统：开仓窗口固定为30分钟
3. ✅ 分批建仓：默认窗口从60分钟改为30分钟
4. ✅ 分批建仓：已有15/30/45分钟智能配置

### 使用建议

1. **破位 + 分批建仓**：检测到破位后，使用分批建仓执行开仓
2. **智能窗口选择**：让K线强度评分自动选择15/30/45分钟窗口
3. **避免重复开仓**：同一币种在30分钟内最多开2次
4. **监控资金占用**：限制并发分批建仓数量

所有时间配置已优化完成！✅
