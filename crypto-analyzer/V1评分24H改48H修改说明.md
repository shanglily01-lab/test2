# V1信号评分 24H→48H 修改说明

## 📝 修改概述

将V1信号评分系统的时间窗口从24小时扩展到48小时，保持原有的评分标准和阈值比例。

---

## 🔧 修改详情

### 文件：`smart_trader_service.py`

#### 1. 位置评分（第436-442行）

**修改前**：
```python
# 1. 位置评分 - 使用24小时(1天)高低点
high_24h = max(k['high'] for k in klines_1h[-24:])
low_24h = min(k['low'] for k in klines_1h[-24:])

if high_24h == low_24h:
    position_pct = 50
else:
    position_pct = (current - low_24h) / (high_24h - low_24h) * 100
```

**修改后**：
```python
# 1. 位置评分 - 使用48小时(2天)高低点
high_48h = max(k['high'] for k in klines_1h[-48:])
low_48h = min(k['low'] for k in klines_1h[-48:])

if high_48h == low_48h:
    position_pct = 50
else:
    position_pct = (current - low_48h) / (high_48h - low_48h) * 100
```

**影响**：位置判断基于更长的时间窗口，更稳定可靠

---

#### 2. 1H量能分析（第445-460行）

**修改前**：
```python
# 提前计算1H量能（在位置判断之前）
volumes_1h = [k['volume'] for k in klines_1h[-24:]]
avg_volume_1h = sum(volumes_1h) / len(volumes_1h) if volumes_1h else 1

strong_bull_1h = 0  # 有力量的阳线
strong_bear_1h = 0  # 有力量的阴线

for k in klines_1h[-24:]:
    is_bull = k['close'] > k['open']
    is_high_volume = k['volume'] > avg_volume_1h * 1.2

    if is_bull and is_high_volume:
        strong_bull_1h += 1
    elif not is_bull and is_high_volume:
        strong_bear_1h += 1
```

**修改后**：
```python
# 提前计算1H量能（在位置判断之前）
volumes_1h = [k['volume'] for k in klines_1h[-48:]]
avg_volume_1h = sum(volumes_1h) / len(volumes_1h) if volumes_1h else 1

strong_bull_1h = 0  # 有力量的阳线
strong_bear_1h = 0  # 有力量的阴线

for k in klines_1h[-48:]:
    is_bull = k['close'] > k['open']
    is_high_volume = k['volume'] > avg_volume_1h * 1.2

    if is_bull and is_high_volume:
        strong_bull_1h += 1
    elif not is_bull and is_high_volume:
        strong_bear_1h += 1
```

**影响**：量能分析基于48根K线，更能反映真实趋势强度

---

#### 3. 短期动量（第484-494行）

**修改前**：
```python
# 2. 短期动量 - 最近24小时涨幅
gain_24h = (current - klines_1h[-24]['close']) / klines_1h[-24]['close'] * 100
if gain_24h < -3:  # 24小时跌超过3%
    ...
elif gain_24h > 3:  # 24小时涨超过3%
    ...
```

**修改后**：
```python
# 2. 短期动量 - 最近48小时涨幅
gain_48h = (current - klines_1h[-48]['close']) / klines_1h[-48]['close'] * 100
if gain_48h < -3:  # 48小时跌超过3%
    ...
elif gain_48h > 3:  # 48小时涨超过3%
    ...
```

**影响**：动量评分基于2天涨跌幅，过滤短期波动

---

#### 4. 1H趋势评分（第497-509行）⭐ 关键修改

**修改前**：
```python
# 3. 1小时趋势评分 - 最近24根K线(1天)
bullish_1h = sum(1 for k in klines_1h[-24:] if k['close'] > k['open'])
bearish_1h = 24 - bullish_1h

if bullish_1h >= 13:  # 阳线>=13根(54.2%)
    weight = self.scoring_weights.get('trend_1h_bull', {'long': 20, 'short': 0})
    long_score += weight['long']
    ...
elif bearish_1h >= 13:  # 阴线>=13根(54.2%)
    weight = self.scoring_weights.get('trend_1h_bear', {'long': 0, 'short': 20})
    short_score += weight['short']
    ...
```

**修改后**：
```python
# 3. 1小时趋势评分 - 最近48根K线(2天)
bullish_1h = sum(1 for k in klines_1h[-48:] if k['close'] > k['open'])
bearish_1h = 48 - bullish_1h

if bullish_1h >= 26:  # 阳线>=26根(54.2%)
    weight = self.scoring_weights.get('trend_1h_bull', {'long': 20, 'short': 0})
    long_score += weight['long']
    ...
elif bearish_1h >= 26:  # 阴线>=26根(54.2%)
    weight = self.scoring_weights.get('trend_1h_bear', {'long': 0, 'short': 20})
    short_score += weight['short']
    ...
```

**影响**：
- 阈值从13根调整为26根，保持54.2%比例
- 趋势判断更严格，需要2天内持续趋势

---

#### 5. 波动率评分（第512-525行）

**修改前**：
```python
# 4. 波动率评分 - 最近24小时
recent_24h = klines_1h[-24:]
volatility = (max(k['high'] for k in recent_24h) - min(k['low'] for k in recent_24h)) / current * 100

if volatility > 5:  # 波动超过5%
    ...
```

**修改后**：
```python
# 4. 波动率评分 - 最近48小时
recent_48h = klines_1h[-48:]
volatility = (max(k['high'] for k in recent_48h) - min(k['low'] for k in recent_48h)) / current * 100

if volatility > 5:  # 波动超过5%
    ...
```

**影响**：波动率基于2天范围，更准确反映市场波动

---

## 📊 保持不变的部分

以下评分组件保持原有时间窗口，未修改：

1. **连续趋势强化**（第527-547行）
   - 仍使用最近10根1H K线
   - 原因：这是短期加速信号，不需要扩展

2. **15分钟量能分析**（第553-569行）
   - 仍使用最近24根15M K线（6小时）
   - 原因：15M是短期辅助指标，保持原有窗口

3. **破位追空信号**（第584行及以后）
   - 仍使用前面计算的net_power_1h和net_power_15m
   - 原因：基于已更新的48H量能数据

---

## 🎯 修改目的

### 为什么改为48H？

1. **降低噪音**
   - 24H容易受短期波动影响
   - 48H更能反映真实趋势

2. **提高信号质量**
   - 更长的时间窗口 = 更稳定的趋势
   - 减少虚假突破信号

3. **保持比例一致**
   - 阳线阈值从13→26（保持54.2%）
   - 其他评分标准保持不变

---

## 📈 预期效果

### 改进前（24H窗口）
- 信号频率：较高
- 虚假信号：较多
- 趋势确认：较快但不稳定

### 改进后（48H窗口）
- 信号频率：适中
- 虚假信号：减少
- 趋势确认：更可靠

---

## ✅ 验证清单

修改后需要验证：

- [ ] 位置评分计算正确（基于48H高低点）
- [ ] 动量评分计算正确（基于48H涨跌幅）
- [ ] 趋势评分阈值正确（26根阳线/阴线）
- [ ] 量能分析正确（48根K线）
- [ ] 波动率计算正确（48H范围）
- [ ] 其他信号组件未受影响

---

## 🔍 日志示例

### 修改前
```
SOMI/USDT: 24H阳线15/24 (62.5%) → trend_1h_bull +20分
```

### 修改后
```
SOMI/USDT: 48H阳线32/48 (66.7%) → trend_1h_bull +20分
```

---

## 📝 总结

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 位置评分窗口 | 24H | 48H |
| 动量评分窗口 | 24H | 48H |
| 趋势评分窗口 | 24根K线 | 48根K线 |
| 趋势阈值 | 13根(54.2%) | 26根(54.2%) |
| 量能分析窗口 | 24根K线 | 48根K线 |
| 波动率窗口 | 24H | 48H |

**核心原则**：扩大时间窗口，保持评分标准比例不变，提高信号质量。
