# 币本位合约自动交易系统使用指南

## 📋 系统概述

币本位合约自动交易系统是一个完全自动化的交易服务，基于智能信号分析自动开仓和平仓币本位合约。

## 🚀 快速启动

### 1. 启动API服务器
```bash
python app/main.py
```

### 2. 启动币本位合约自动交易服务
```bash
python coin_futures_trader_service.py
```

## ⚙️ 配置说明

### 交易对配置
在 `config.yaml` 中配置交易对：

```yaml
coin_futures_symbols:
  - BTCUSD_PERP    # BTC/USD 永续合约
  - ETHUSD_PERP    # ETH/USD 永续合约
  - BNBUSD_PERP    # BNB/USD 永续合约
  - SOLUSD_PERP    # SOL/USD 永续合约
  - XRPUSD_PERP    # XRP/USD 永续合约
  - ADAUSD_PERP    # ADA/USD 永续合约
  - DOTUSD_PERP    # DOT/USD 永续合约
  - LINKUSD_PERP   # LINK/USD 永续合约
```

### 账户信息
- **账户ID**: 3
- **User ID**: 1000
- **账户名称**: 币本位合约账户
- **初始资金**: $100,000 USDT
- **账户类型**: coin_futures

## 🧠 智能决策系统

### 核心功能

1. **智能信号评分系统**
   - 多维度信号分析（位置、趋势、动量、量能）
   - 动态评分权重（从数据库加载）
   - 开仓阈值：35分（过滤低质量信号）

2. **防追高/防杀跌过滤器**
   - 做多：不在24H区间80%以上位置开多
   - 做空：不在24H区间20%以下位置开空
   - 防止追高杀跌导致的损失

3. **自适应止盈止损**
   - 从数据库加载自适应参数
   - 支持LONG/SHORT不同参数
   - 动态调整止盈止损比例

4. **分批建仓执行器**
   - 智能分批开仓（3批次）
   - 避免单次大额建仓
   - 平滑成本价格

5. **智能平仓优化器**
   - 基于盈亏动态调整平仓策略
   - 高盈利回撤保护
   - 低盈利延长持仓时间
   - 小额亏损快速止损

6. **Big4趋势检测**
   - 监控BTC/ETH/BNB/SOL四大币种
   - 整体市场趋势判断
   - 趋势反转预警

7. **3级黑名单评级制度**
   - Level 1: 短期表现不佳（小仓位）
   - Level 2: 中期表现不佳（更小仓位）
   - Level 3: 长期表现不佳（禁止交易）
   - 自动评级更新

## 📊 监控与日志

### 日志文件位置
```
logs/coin_futures_trader_{date}.log
```

### 前端监控页面
访问: http://localhost:8000/coin_futures_trading

可以查看：
- 当前持仓
- 历史交易
- 账户余额
- 盈亏统计
- 实时价格

## 🔧 数据库表结构

### 核心表
1. **futures_trading_accounts** - 账户管理
2. **futures_positions** - 持仓记录（coin_margin=1标记币本位）
3. **trading_blacklist** - 交易黑名单
4. **adaptive_params** - 自适应参数
5. **signal_scoring_weights** - 信号评分权重
6. **signal_blacklist** - 信号类型黑名单

## 📈 交易流程

### 自动交易循环（每分钟）

1. **信号扫描** - 扫描所有配置的币本位交易对
2. **信号评分** - 对每个交易对进行多维度评分
3. **过滤器检查** - 防追高/防杀跌/黑名单过滤
4. **开仓决策** - 评分≥35分且通过所有过滤器
5. **分批建仓** - SmartEntryExecutor执行3批次建仓
6. **持仓监控** - 实时监控所有持仓
7. **智能平仓** - SmartExitOptimizer优化平仓时机

### 开仓条件

必须同时满足：
- ✅ 信号评分 ≥ 35分
- ✅ 不在交易黑名单中
- ✅ 通过防追高/防杀跌检查
- ✅ 信号类型未被禁用
- ✅ 账户余额充足
- ✅ 未达到最大持仓限制

### 平仓条件

满足任一条件：
- 🎯 触及止盈价格
- 🛑 触及止损价格
- ⏱️ 达到最大持仓时间
- 📉 高盈利回撤保护触发
- 🔄 智能平仓优化器建议平仓

## 🎯 性能优化

### 优化特性

1. **批量价格获取** - WebSocket实时价格推送
2. **数据库连接池** - 减少连接开销
3. **异步信号处理** - 并行处理多个交易对
4. **缓存机制** - K线数据缓存
5. **延迟执行** - 避免频繁交易

## ⚠️ 风险控制

### 内置风险控制

1. **单笔保证金限制** - 根据账户余额动态调整
2. **最大持仓数量** - 防止过度持仓
3. **止损保护** - 强制止损避免大额损失
4. **黑名单制度** - 自动过滤表现不佳的币种
5. **防追高杀跌** - 避免情绪化交易

## 🔍 故障排查

### 常见问题

**Q1: 服务启动失败？**
- 检查数据库连接是否正常
- 确认 config.yaml 配置正确
- 查看日志文件了解详细错误

**Q2: 没有自动开仓？**
- 检查账户余额是否充足
- 确认交易对不在黑名单中
- 查看日志确认信号评分是否达标
- 检查是否被防追高/防杀跌过滤

**Q3: 持仓未自动平仓？**
- 检查止盈止损价格设置
- 确认最大持仓时间配置
- 查看智能平仓优化器日志

## 📞 技术支持

遇到问题请查看：
1. 日志文件: `logs/coin_futures_trader_{date}.log`
2. 前端页面: http://localhost:8000/coin_futures_trading
3. 数据库表: `futures_positions` (WHERE coin_margin=1)

## 🎉 开始使用

```bash
# 1. 启动API服务器
python app/main.py

# 2. 在另一个终端启动币本位自动交易
python coin_futures_trader_service.py
```

享受自动化交易！🚀
