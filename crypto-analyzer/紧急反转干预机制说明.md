# 紧急反转干预机制说明

## 🎯 目的

解决"死猫跳"陷阱问题 - 在市场触底反弹或触顶回调时，避免在错误方向开仓。

## 📊 问题背景

**2月5日触底反弹案例**:
- 市场剧烈下跌后触底
- 短期内出现反弹
- 系统继续做空 → 被反弹打止损 → 亏损

**问题本质**:
- 趋势判断有滞后性
- 触底后的反弹往往很快
- 继续做空 = 逆势交易 = 高风险

## 🔥 解决方案: 紧急反转干预

### 核心逻辑

**触底反弹保护**:
```
条件: Big4最近4小时内跌幅超过5%
动作: 禁止做空2小时
原因: 触底后往往有技术性反弹，做空风险极高
```

**触顶回调保护**:
```
条件: Big4最近4小时内涨幅超过5%
动作: 禁止做多2小时
原因: 触顶后往往有技术性回调，做多风险极高
```

## 🛠 技术实现

### 1. 检测机制 (`big4_trend_detector.py`)

```python
def _detect_emergency_reversal(self, conn) -> Dict:
    """
    检测Big4最近N小时的剧烈波动

    触底判断:
    - 期间跌幅 > 5%
    - 当前价格已从最低点反弹

    触顶判断:
    - 期间涨幅 > 5%
    - 当前价格已从最高点回调
    """
```

**参数配置**:
- `EMERGENCY_DETECTION_HOURS = 4`  # 检测窗口
- `BOTTOM_DROP_THRESHOLD = -5.0`   # 触底阈值
- `TOP_RISE_THRESHOLD = 5.0`       # 触顶阈值
- `BLOCK_DURATION_HOURS = 2`       # 阻止时长

### 2. 数据库记录

**表结构**: `emergency_intervention`
```sql
CREATE TABLE emergency_intervention (
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_id INT NOT NULL,
    trading_type VARCHAR(50) NOT NULL,
    intervention_type VARCHAR(50) NOT NULL,  -- BOTTOM_BOUNCE / TOP_REVERSAL
    block_long BOOLEAN DEFAULT FALSE,
    block_short BOOLEAN DEFAULT FALSE,
    trigger_reason TEXT,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_account_type (account_id, trading_type),
    INDEX idx_expires (expires_at)
);
```

### 3. 交易拦截 (`smart_trader_service.py`)

```python
# 在开仓前检查
emergency = big4_result.get('emergency_intervention', {})

if emergency.get('block_long') and new_side == 'LONG':
    logger.warning(f"🚨 触顶反转风险,禁止做多")
    continue

if emergency.get('block_short') and new_side == 'SHORT':
    logger.warning(f"🚨 触底反弹风险,禁止做空")
    continue
```

## 📈 效果预期

### 2月5日触底场景模拟

**无干预** (实际发生):
- 11:00 市场跌5% → 触底
- 11:30 系统继续做空
- 12:00 反弹2% → 触发止损
- 结果: 亏损

**有干预** (期望):
- 11:00 市场跌5% → 触底
- 11:01 紧急干预激活: 禁止做空2小时
- 11:30 系统检测到做空信号 → **被拦截**
- 13:00 反弹结束，继续观察
- 结果: 避免亏损

## 🎮 使用方法

### 1. 初始化数据库表

```bash
python init_emergency_table.py
```

### 2. 功能已自动集成

- Big4趋势检测时自动检查反转
- 开仓前自动拦截风险方向
- 日志中会显示干预状态

### 3. 查看干预状态

**查询当前干预**:
```sql
SELECT * FROM emergency_intervention
WHERE account_id = 2
AND trading_type = 'usdt_futures'
AND expires_at > NOW()
ORDER BY created_at DESC;
```

**查看干预历史**:
```sql
SELECT
    intervention_type,
    trigger_reason,
    created_at,
    expires_at,
    TIMESTAMPDIFF(MINUTE, created_at, expires_at) AS duration_minutes
FROM emergency_intervention
WHERE account_id = 2
ORDER BY created_at DESC
LIMIT 20;
```

## 📊 日志标识

**检测日志**:
```
🚨 紧急干预已激活: 触底反弹: BTC触底(-5.2%→+1.8%), ETH触底(-5.8%→+2.1%) (持续2小时)
```

**拦截日志**:
```
🚨 [EMERGENCY-BLOCK] DOGE/USDT 触底反弹风险,禁止做空 | ⚠️ 触底反弹: BTC触底(-5.2%→+1.8%)
```

**Big4趋势日志**:
```
📊 [TRADING-MODE] 当前模式: trend | Big4: BEARISH(45.0) | ⚠️ 触底反弹风险 - 禁止做空
```

## ⚙️ 参数调优

**保守配置** (更敏感，更频繁干预):
```python
EMERGENCY_DETECTION_HOURS = 6   # 检测窗口加长
BOTTOM_DROP_THRESHOLD = -3.0    # 触底阈值降低
TOP_RISE_THRESHOLD = 3.0        # 触顶阈值降低
BLOCK_DURATION_HOURS = 3        # 阻止时间延长
```

**激进配置** (更宽松，更少干预):
```python
EMERGENCY_DETECTION_HOURS = 2   # 检测窗口缩短
BOTTOM_DROP_THRESHOLD = -7.0    # 触底阈值提高
TOP_RISE_THRESHOLD = 7.0        # 触顶阈值提高
BLOCK_DURATION_HOURS = 1        # 阻止时间缩短
```

**推荐配置** (平衡):
```python
EMERGENCY_DETECTION_HOURS = 4   # 4小时窗口
BOTTOM_DROP_THRESHOLD = -5.0    # 5%跌幅
TOP_RISE_THRESHOLD = 5.0        # 5%涨幅
BLOCK_DURATION_HOURS = 2        # 阻止2小时
```

## 🔍 监控要点

### 观察指标

1. **干预触发频率**: 1-3次/周 正常，>5次/周 可能过于敏感
2. **拦截交易数量**: 记录有多少交易被拦截
3. **避免亏损估算**: 对比被拦截信号的后续走势

### 效果评估

**关键问题**:
- 被拦截的信号，如果执行了会怎样？
- 拦截是否真的避免了亏损？
- 是否错过了盈利机会？

**查询被拦截信号的表现**:
```sql
-- 查看干预期间的信号评分
SELECT
    ei.intervention_type,
    ei.trigger_reason,
    ei.created_at AS intervention_start,
    ei.expires_at AS intervention_end,
    COUNT(sh.id) AS blocked_signals
FROM emergency_intervention ei
LEFT JOIN signal_history sh ON (
    sh.timestamp BETWEEN ei.created_at AND ei.expires_at
    AND (
        (ei.block_long = 1 AND sh.side = 'LONG')
        OR (ei.block_short = 1 AND sh.side = 'SHORT')
    )
)
WHERE ei.account_id = 2
GROUP BY ei.id
ORDER BY ei.created_at DESC;
```

## 📝 注意事项

### 优点
1. ✅ 避免死猫跳陷阱
2. ✅ 自动识别剧烈波动
3. ✅ 有时间限制（2小时后自动解除）
4. ✅ 不影响反向交易（触底只禁空，不禁多）

### 局限性
1. ⚠️ 可能错过真正的反转机会
2. ⚠️ 参数固定，无法适应所有市场
3. ⚠️ 只看Big4，不看单个币种的特殊情况

### 建议
- 初期使用推荐配置
- 观察1-2周后根据实际效果调整
- 配合TREND模式使用效果更好
- 不要频繁调整参数

## 🚀 部署流程

### 1. 初始化数据库
```bash
python init_emergency_table.py
```

### 2. 重启服务
```bash
# 服务会自动加载新功能
pm2 restart smart_trader
```

### 3. 验证功能
```bash
# 查看日志
pm2 logs smart_trader --lines 50

# 应该看到:
# ✅ Big4趋势已保存: NEUTRAL (强度: 25)
# 无紧急干预状态
```

### 4. 监控效果
- 24小时后检查是否有干预记录
- 1周后评估拦截效果
- 必要时调整参数

---

**创建时间**: 2026-02-09
**版本**: v1.0
**状态**: ✅ 已实现，待部署测试
