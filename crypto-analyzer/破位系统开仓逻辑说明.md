# 破位系统开仓逻辑说明

## 最新开仓规则（2026-02-09更新）

### 规则1：同一币种可开5个仓位

**修改前**：同一个币种在破位期间只能开1次
**修改后**：同一个币种，同一个方向，最多可以开5个仓位

**示例**：
```
DOGE/USDT SHORT 可以开5个仓位：
- 第1次：破位信号生成时开仓
- 第2次：价格继续下跌，再次生成信号时开仓
- 第3次：...
- 第4次：...
- 第5次：达到上限，不再开仓
```

### 规则2：破位开仓窗口30分钟

**配置**：
- 开仓窗口：30分钟（从破位检测开始计时）
- 最大有效期：4小时

**说明**：
- 破位发生后，有30分钟的时间可以开仓
- 超过30分钟后，即使破位还有效，也不再生成新的开仓信号
- 破位信号最长有效4小时，之后完全失效

## 代码实现

### 核心数据结构

```python
# 旧版本
self.opened_symbols = []  # 列表，只记录币种名称

# 新版本
self.opened_symbols = {   # 字典，记录每个币种的开仓次数
    'DOGE/USDT': 3,       # DOGE已开3次
    'SHIB/USDT': 1,       # SHIB已开1次
    'PEPE/USDT': 5        # PEPE已开5次（达到上限）
}
```

### 开仓检查逻辑

```python
def should_generate_signal(self, symbol: str, current_price: float):
    # 检查1: 是否有活动会话
    if not self.session_id:
        return False, "无活动破位会话"

    # 检查2: 时间失效（4小时）
    if elapsed > self.config['max_duration']:
        return False, "破位信号已失效"

    # 检查3: 开仓窗口（30分钟）
    if elapsed > self.config['opening_window']:
        return False, "超过开仓窗口"

    # 检查4: 该币种开仓次数（最多5次）
    symbol_count = self.opened_symbols.get(symbol, 0)
    if symbol_count >= 5:
        return False, f"{symbol}已开仓{symbol_count}次，达到上限"

    # 检查5: 价格反转（1%）
    if self.check_price_reversal(current_price):
        return False, "价格已反转，破位失效"

    # 检查6: 趋势结束（2%）
    if self.check_trend_end(current_price):
        return False, "趋势已结束"

    return True, "破位信号有效"
```

### 记录开仓

```python
def record_opening(self, symbol: str):
    # 增加该币种的开仓次数
    if symbol not in self.opened_symbols:
        self.opened_symbols[symbol] = 0
    self.opened_symbols[symbol] += 1

    remaining = 5 - self.opened_symbols[symbol]
    total_opened = sum(self.opened_symbols.values())

    logger.info(
        f"[开仓记录] {symbol} 第{self.opened_symbols[symbol]}次开仓, "
        f"还可开{remaining}次 (总共已开{total_opened}单)"
    )
```

## 使用示例

### 场景1：破位后多次开仓同一币种

```python
# T+0分钟：检测到破位
result = brain.check_breakout()
# 破位: SHORT, 强度85

# T+5分钟：DOGE信号1
result = brain.should_trade('DOGE/USDT', 80, 'SHORT')
# decision=True, 开仓 (DOGE第1次)

# T+10分钟：DOGE信号2
result = brain.should_trade('DOGE/USDT', 85, 'SHORT')
# decision=True, 开仓 (DOGE第2次)

# T+15分钟：DOGE信号3
result = brain.should_trade('DOGE/USDT', 90, 'SHORT')
# decision=True, 开仓 (DOGE第3次)

# T+20分钟：DOGE信号4
result = brain.should_trade('DOGE/USDT', 88, 'SHORT')
# decision=True, 开仓 (DOGE第4次)

# T+25分钟：DOGE信号5
result = brain.should_trade('DOGE/USDT', 92, 'SHORT')
# decision=True, 开仓 (DOGE第5次)

# T+28分钟：DOGE信号6
result = brain.should_trade('DOGE/USDT', 95, 'SHORT')
# decision=False, 原因: "DOGE/USDT已开仓5次，达到上限(5)"
```

### 场景2：多个币种同时开仓

```python
# T+0分钟：检测到破位
result = brain.check_breakout()

# T+5分钟：同时扫描多个币种
for symbol in ['DOGE/USDT', 'SHIB/USDT', 'PEPE/USDT']:
    result = brain.should_trade(symbol, 80, 'SHORT')
    # 所有币种都可以开仓

# 状态：
# DOGE/USDT: 1次
# SHIB/USDT: 1次
# PEPE/USDT: 1次
# 总计: 3单
```

### 场景3：窗口超时

```python
# T+0分钟：检测到破位
result = brain.check_breakout()

# T+35分钟：超过30分钟窗口
result = brain.should_trade('ARB/USDT', 85, 'SHORT')
# decision=False, 原因: "超过开仓窗口(35分钟)"
```

## 配置参数

### breakout_convergence.py

```python
config = {
    'max_duration': 4 * 3600,      # 4小时失效
    'opening_window': 30 * 60,     # 30分钟窗口
    'max_openings': 5,             # 每个币种最多5次
    'reversal_threshold': 0.01,    # 1%反转失效
    'trend_end_threshold': 0.02    # 2%趋势结束
}
```

### 自定义配置

```python
# 如果需要调整参数
custom_config = {
    'max_duration': 6 * 3600,      # 改为6小时
    'opening_window': 45 * 60,     # 改为45分钟
    'max_openings': 3,             # 每个币种最多3次
}

from app.services.breakout_system import BreakoutSystem
breakout_system = BreakoutSystem(exchange, convergence_config=custom_config)
brain.breakout_system = breakout_system
```

## 风险控制

### 优点

1. **灵活性增强**：同一个币种可以多次加仓
2. **把握机会**：价格持续破位时可以继续开仓
3. **分批建仓**：可以实现分批入场

### 风险点

1. **过度集中**：同一个币种最多5个仓位，需要控制单币种仓位
2. **快速亏损**：如果判断错误，5个仓位会快速累积亏损
3. **资金占用**：同时开多个仓位会占用大量保证金

### 建议风控措施

1. **单币种仓位限制**：每个仓位不超过总资金的2%
   - 5个仓位 × 2% = 最多10%资金在同一币种

2. **总仓位限制**：所有破位仓位总和不超过总资金的30%

3. **快速止损**：每个仓位独立止损，不要等所有仓位一起止损

4. **分批加仓条件**：
   - 价格继续朝破位方向移动
   - 前一个仓位已经盈利
   - 破位强度增强

## 与分批建仓的关系

### 破位系统 vs 分批建仓

**破位系统（30分钟窗口）**：
- 检测市场破位，快速开仓
- 30分钟内可以开多次
- 适合快速入场

**分批建仓（30-45分钟完成）**：
- 计划性地分批入场
- 在30-45分钟内完成所有批次
- 适合大仓位入场

### 协同工作

```python
# 方案1：破位后触发分批建仓
if breakout_result['has_breakout']:
    # 启动分批建仓计划
    batch_plan = {
        'symbol': 'DOGE/USDT',
        'direction': 'SHORT',
        'total_amount': 1000,  # 总金额
        'batches': 3,          # 3个批次
        'interval': 10         # 每10分钟一批
    }
    execute_batch_opening(batch_plan)

# 方案2：破位系统和分批建仓独立
# - 破位系统：快速开仓，小仓位
# - 分批建仓：计划开仓，大仓位
```

## 总结

### 关键变更

1. ✅ 同一币种可开5个仓位（而非1个）
2. ✅ 使用字典记录每个币种的开仓次数
3. ✅ 开仓窗口固定为30分钟
4. ✅ 每个币种独立计数

### 适用场景

- ✅ 强烈破位，需要多次加仓
- ✅ 价格持续朝破位方向移动
- ✅ 想要在短时间内建立大仓位
- ❌ 不适合震荡市场
- ❌ 不适合反复试探的假破位

### 下一步优化

1. **动态调整上限**：根据破位强度调整max_openings
2. **加仓条件**：前一仓位盈利X%才能加仓
3. **递减仓位**：第1次100%，第2次80%，第3次60%...
4. **快速止损**：任一仓位触发止损后，停止新开仓
