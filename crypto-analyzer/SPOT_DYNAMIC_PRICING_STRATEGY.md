# 现货动态价格采样策略 V2

## 核心思路

通过**分阶段执行**和**动态价格采样**,在8小时内完成一个完整的短线交易周期,寻找最优建仓和平仓价格。

---

## 策略参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 单币资金 | 2,000 USDT | 每个币种最多投入2000 USDT |
| 最大持仓 | 15个 | 最多同时持有15个币种 |
| 止盈 | 15% | 达到15%盈利立即平仓 |
| 止损 | 5% | 亏损5%立即止损 |
| 总时长 | 8小时 | 从建仓到平仓的总时间 |
| 建仓批次 | 5批 | 分5批完成建仓 (15%/20%/20%/20%/25%) |

---

## 完整流程 (8小时周期)

### 阶段1: 采样阶段 (第1小时)

**目标**: 采集价格样本,了解价格波动范围

**操作**:
- 每30秒采集一次当前价格
- 记录价格、时间、成交量
- 不执行任何交易
- 建立价格波动的统计基准

**样本数量**: 约120个样本 (1小时 × 2次/分钟)

**阶段标识**: `phase = 'sampling'`

---

### 阶段2: 建仓阶段 (第2-3小时, 共2小时)

**目标**: 在2小时内完成5批次建仓,动态寻找最优价格

**建仓策略**:
1. 持续采集价格样本
2. 计算最近1小时样本的**20%分位数** (偏低价格)
3. 当前价格 ≤ 最优价格 × 1.02时,执行建仓
4. 每批次间隔自动调整,确保2小时内完成

**5批次比例**:
- 第1批: 15% (300 USDT)
- 第2批: 20% (400 USDT)
- 第3批: 20% (400 USDT)
- 第4批: 20% (400 USDT)
- 第5批: 25% (500 USDT)

**超时保护**:
- 如果2小时后仍未完成,强制以当前价格完成剩余批次

**阶段标识**: `phase = 'building'`

**示例**:
```
时间       价格     样本20%分位   操作
10:00:00  $1.5000  $1.4800      等待 (当前价高于最优价)
10:05:00  $1.4850  $1.4800      ✅ 执行第1批建仓 (300 USDT)
10:20:00  $1.4700  $1.4650      ✅ 执行第2批建仓 (400 USDT)
10:45:00  $1.4600  $1.4600      ✅ 执行第3批建仓 (400 USDT)
11:10:00  $1.4550  $1.4520      ✅ 执行第4批建仓 (400 USDT)
11:35:00  $1.4500  $1.4480      ✅ 执行第5批建仓 (500 USDT)
```

**建仓完成**:
- 记录建仓完成时间
- 计算平均成本
- 设置止盈价格 (均价 × 1.15)
- 设置止损价格 (均价 × 0.95)
- 自动进入持仓阶段

---

### 阶段3: 持仓阶段 (第4-7小时, 共4小时)

**目标**: 让利润奔跑,不做任何主动操作

**操作**:
- ✅ 持续监控止盈止损
- ❌ 不监控任何其他信号
- ❌ 不执行加仓
- ❌ 不主动平仓

**触发条件**:
1. 价格 ≥ 止盈价 (15%) → 立即平仓
2. 价格 ≤ 止损价 (5%) → 立即止损
3. 其他情况 → 继续持有

**阶段标识**: `phase = 'holding'`

**持仓时间**: 建仓完成后计时4小时

---

### 阶段4: 平仓采样阶段 (第8小时的第1个小时)

**目标**: 采集平仓价格样本,寻找最优卖出时机

**操作**:
- 持续采集价格样本
- 计算最近1小时样本的**80%分位数** (偏高价格)
- 不立即平仓,继续观察

**阶段标识**: `phase = 'exit_sampling'`

**持续时间**: 1小时

---

### 阶段5: 平仓阶段 (剩余3小时)

**目标**: 动态寻找最优价格平仓

**平仓策略**:
1. 计算最近1小时样本的**80%分位数**
2. 如果当前价格 ≥ 80%分位数 × 0.97,认为是好的卖出时机
3. 如果当前盈利 > 0,立即平仓

**触发条件** (优先级从高到低):
1. 止盈 (15%) → 立即平仓
2. 止损 (5%) → 立即止损
3. 当前价 ≥ 最优价 × 97% 且盈利 > 0 → 平仓
4. 8小时总时长到期 → 强制平仓

**阶段标识**: `phase = 'exit_ready'`

**示例**:
```
时间       价格     样本80%分位   操作
17:00:00  $1.6000  $1.6200      等待 (未达到最优价)
17:10:00  $1.6150  $1.6200      等待 (差一点)
17:20:00  $1.6210  $1.6200      ✅ 平仓 (达到97%最优价)

盈亏计算:
  平均成本: $1.4750
  平仓价格: $1.6210
  盈利: +9.9%
  原因: 最优平仓(+9.9%)
```

---

## 价格采样算法

### 建仓价格采样 (买入时用低价)

```python
def get_optimal_buy_price(samples, current_price):
    # 获取最近1小时的样本
    recent_samples = filter_last_hour(samples)

    # 价格排序
    prices = sorted([s.price for s in recent_samples])

    # 取20%分位数 (偏低)
    percentile_20 = prices[int(len(prices) * 0.2)]

    # 返回较低的价格
    return min(current_price, percentile_20)
```

### 平仓价格采样 (卖出时用高价)

```python
def get_optimal_sell_price(samples, current_price, entry_price):
    # 获取最近1小时的样本
    recent_samples = filter_last_hour(samples)

    # 价格排序
    prices = sorted([s.price for s in recent_samples])

    # 取80%分位数 (偏高)
    percentile_80 = prices[int(len(prices) * 0.8)]

    # 当前价格是否接近最优价 (97%以上)
    if current_price >= percentile_80 * 0.97:
        # 且有盈利
        if current_price > entry_price:
            return True, current_price

    return False, percentile_80
```

---

## 风险控制

### 止盈止损 (所有阶段都生效)

| 类型 | 阈值 | 说明 |
|------|------|------|
| 止盈 | +15% | 立即平仓,锁定利润 |
| 止损 | -5% | 立即止损,控制风险 |

### 时间止损

| 时间节点 | 操作 |
|----------|------|
| 建仓2小时超时 | 强制以当前价格完成剩余批次 |
| 总时长8小时到期 | 强制平仓,无论盈亏 |

### 流动性保护

- 只交易24H成交额 > 500万的币种
- 避免流动性不足导致滑点过大

---

## 资金管理

### 单币配置
- 单币资金: 2,000 USDT
- 分5批建仓: 300 + 400 + 400 + 400 + 500 = 2,000 USDT

### 总资金配置
- 总资金: 50,000 USDT
- 最大持仓: 15个币种
- 最大占用: 15 × 2,000 = 30,000 USDT (60%)
- 预留资金: 20,000 USDT (40%)

### 风险敞口
- 单笔最大亏损: 2,000 × 5% = 100 USDT
- 15个全部止损: 15 × 100 = 1,500 USDT (3%)
- 可接受范围

---

## 预期表现

### 胜率分析
假设:
- 胜率: 60% (短线策略)
- 平均盈利: 8-12% (止盈15%前平仓)
- 平均亏损: -5% (止损)

### 单笔收益
- 盈利: 2,000 × 10% × 60% = +120 USDT
- 亏损: 2,000 × 5% × 40% = -40 USDT
- 净收益: +80 USDT/笔

### 日均收益
- 每笔耗时: 8小时
- 每天交易: 3批 (24小时 / 8小时)
- 同时持仓: 15个
- 日均完成: 15个 / 8小时 × 24小时 = 45笔/天

**保守估计** (考虑实际情况):
- 日均交易: 10-15笔
- 日均收益: 10 × 80 = 800 USDT/天
- 月收益: 800 × 30 = 24,000 USDT
- 月化收益率: 24,000 / 50,000 = **48%**

---

## 优势分析

### 1. 动态价格优化
- 不追高: 建仓时等待价格回落到20%分位数
- 不杀低: 平仓时等待价格上涨到80%分位数
- 理论上获得**更优的成交价格**

### 2. 让利润奔跑
- 持仓4小时不监控信号
- 避免过早平仓
- 捕捉趋势延续

### 3. 严格风控
- 5%止损: 控制单笔亏损
- 15%止盈: 及时锁定利润
- 8小时强制平仓: 避免长期套牢

### 4. 资金利用率高
- 60%资金利用率 (vs 旧策略10%)
- 8小时周期,快速周转
- 同时运行15个币种

---

## 实施步骤

### 1. 创建数据库表
```bash
mysql -h 13.212.252.171 -u admin -p binance-data < create_spot_positions_v2_table.sql
```

### 2. 测试运行
```bash
python spot_trader_service_v2.py
```

### 3. 监控关键指标
- 采样阶段: 样本数量 (应 >50个/小时)
- 建仓阶段: 成交价格 vs 最优价格
- 持仓阶段: 止盈止损触发情况
- 平仓阶段: 平仓价格 vs 最优价格

### 4. 调优参数
根据实际表现调整:
- 建仓价格阈值: 20%分位数 → 15%或25%
- 平仓价格阈值: 80%分位数 → 75%或85%
- 止盈止损: 15%/5% → 根据市场调整

---

## 日志检查

### 关键日志
```bash
# 监控整体流程
tail -f spot_trader_v2.log

# 筛选关键事件
tail -f spot_trader_v2.log | grep "创建持仓\|完成第.*批建仓\|进入持仓阶段\|平仓"

# 查看采样数据
tail -f spot_trader_v2.log | grep "采样\|分位数"
```

---

## 数据库查询

### 查看活跃持仓
```sql
SELECT
    symbol, phase, current_batch,
    avg_entry_price, take_profit_price, stop_loss_price,
    TIMESTAMPDIFF(HOUR, created_at, NOW()) as hours_held
FROM spot_positions_v2
WHERE status = 'active'
ORDER BY created_at DESC;
```

### 查看已平仓记录
```sql
SELECT
    symbol, realized_pnl, realized_pnl_pct, close_reason,
    TIMESTAMPDIFF(HOUR, created_at, exit_time) as hours_held
FROM spot_positions_v2
WHERE status = 'closed'
    AND DATE(exit_time) = CURDATE()
ORDER BY exit_time DESC;
```

### 统计今日表现
```sql
SELECT
    COUNT(*) as total_trades,
    SUM(CASE WHEN realized_pnl > 0 THEN 1 ELSE 0 END) as winning_trades,
    SUM(CASE WHEN realized_pnl < 0 THEN 1 ELSE 0 END) as losing_trades,
    SUM(realized_pnl) as total_pnl,
    AVG(realized_pnl_pct) as avg_pnl_pct,
    AVG(TIMESTAMPDIFF(HOUR, created_at, exit_time)) as avg_hours_held
FROM spot_positions_v2
WHERE status = 'closed'
    AND DATE(exit_time) = CURDATE();
```

---

## 对比旧策略

| 指标 | 旧策略 (长线) | 新策略 (动态采样) |
|------|--------------|------------------|
| 单币资金 | 10,000 USDT | 2,000 USDT |
| 建仓方式 | 5批次固定价格 | 5批次动态寻优 |
| 持仓时间 | 不限 | 8小时 |
| 止盈/止损 | 50%/10% | 15%/5% |
| 资金利用率 | 10% | 60% |
| 日均交易 | 0笔 | 10-15笔 |
| 月化收益率 | 0% | 48% (预期) |

---

## 总结

✅ **核心创新**: 动态价格采样,寻找最优建仓和平仓时机
✅ **严格时间管理**: 8小时完整周期,快速周转
✅ **让利润奔跑**: 持仓4小时不干预
✅ **风险可控**: 5%止损 + 8小时强制平仓
✅ **资金效率高**: 60%利用率,月化48%收益

**下一步**: 创建数据库表,启动服务测试
