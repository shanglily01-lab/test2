# 数据库迁移指南

本指南说明如何将本地数据库迁移到服务器端。

## 概述

数据库迁移分为三个步骤：
1. 在本地导出数据库
2. 上传备份文件到服务器
3. 在服务器上导入数据库

## 前置条件

- 本地已安装MySQL/MariaDB客户端工具
- 服务器端已安装并配置好MariaDB
- 具有SSH访问服务器的权限
- config.yaml 配置文件已正确配置

## 详细步骤

### 步骤1: 在本地导出数据库

在本地项目目录运行导出脚本：

```bash
bash export_database.sh
```

**脚本功能：**
- 自动读取 config.yaml 中的数据库配置
- 导出完整的数据库结构和数据
- 包含存储过程、触发器、事件
- 自动压缩备份文件以节省空间
- 备份文件保存在 `./backups/` 目录

**输出示例：**
```
[INFO] 从 config.yaml 读取的数据库配置:
  主机: localhost
  用户: root
  数据库: binance-data

===================================================
开始导出数据库
===================================================

[INFO] 导出数据库到: ./backups/database_backup_20250112_120000.sql
[INFO] ✅ 数据库导出成功
[INFO] 压缩备份文件...
[INFO] 备份文件大小: 15M

导出完成!
备份文件位置: ./backups/database_backup_20250112_120000.sql.gz
```

### 步骤2: 上传备份文件到服务器

使用 SCP 命令将备份文件上传到服务器：

```bash
# 基本语法
scp ./backups/database_backup_YYYYMMDD_HHMMSS.sql.gz user@server:/path/to/crypto-analyzer/backups/

# 示例 (使用具体的服务器信息)
scp ./backups/database_backup_20250112_120000.sql.gz \
    ec2-user@your-server.amazonaws.com:/home/ec2-user/crypto-analyzer/backups/
```

**使用SSH密钥：**
```bash
scp -i ~/.ssh/your-key.pem \
    ./backups/database_backup_20250112_120000.sql.gz \
    ec2-user@your-server.amazonaws.com:/home/ec2-user/crypto-analyzer/backups/
```

**验证上传：**
```bash
# SSH到服务器
ssh user@server

# 检查文件
cd /path/to/crypto-analyzer
ls -lh backups/
```

### 步骤3: 在服务器上导入数据库

#### 3.1 确保数据库已安装并运行

如果还没有安装MariaDB，先运行：

```bash
sudo bash reinstall_mariadb.sh
```

#### 3.2 导入数据库

在服务器上运行导入脚本：

```bash
sudo bash import_database.sh backups/database_backup_20250112_120000.sql.gz
```

**脚本功能：**
- 自动读取 config.yaml 中的数据库配置
- 自动备份现有数据库（安全措施）
- 重建数据库并导入数据
- 验证导入是否成功
- 如果失败，自动恢复到导入前状态

**执行过程：**
```
[INFO] 从 config.yaml 读取的数据库配置:
  用户: root
  数据库: binance-data

[INFO] 备份文件: backups/database_backup_20250112_120000.sql.gz

确认导入此备份到数据库 binance-data? (这将覆盖现有数据!) (y/n): y

===================================================
步骤1: 备份现有数据库
===================================================
[INFO] 发现现有数据库，先备份...
[INFO] ✅ 安全备份已保存: ./backups/safety_backup_20250112_130000.sql.gz

===================================================
步骤2: 准备导入文件
===================================================
[INFO] 解压备份文件...
[INFO] ✅ 导入文件已准备

===================================================
步骤3: 重建数据库
===================================================
[INFO] 删除现有数据库...
[INFO] 创建新数据库...
[INFO] ✅ 数据库已重建

===================================================
步骤4: 导入数据
===================================================
[INFO] 开始导入数据，这可能需要几分钟...
[INFO] ✅ 数据导入成功

===================================================
步骤5: 验证导入
===================================================
[INFO] 检查表结构...
[INFO] ✅ 共导入 12 个表
[INFO] 显示表列表:
+-------------------------+
| Tables_in_binance-data  |
+-------------------------+
| prices                  |
| klines                  |
| news                    |
| signals                 |
| ...                     |
+-------------------------+

数据库导入完成!
```

### 步骤4: 重启应用服务

导入完成后，重启应用服务使其连接新数据库：

```bash
sudo systemctl restart crypto-analyzer
```

### 步骤5: 验证迁移

检查系统状态：

```bash
./status.sh
```

查看应用日志：

```bash
./logs.sh
```

## 故障排除

### 问题1: 导出失败 - 连接被拒绝

**错误信息：**
```
ERROR 2002 (HY000): Can't connect to local MySQL server
```

**解决方法：**
```bash
# 检查MySQL/MariaDB服务是否运行
systemctl status mysql
# 或
systemctl status mariadb

# 启动服务
sudo systemctl start mysql
# 或
sudo systemctl start mariadb
```

### 问题2: 导出失败 - 权限不足

**错误信息：**
```
mysqldump: Got error: 1044: Access denied
```

**解决方法：**
```bash
# 确认用户有足够权限
mysql -u root -p
GRANT ALL PRIVILEGES ON `binance-data`.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

### 问题3: 上传失败 - 权限被拒绝

**错误信息：**
```
Permission denied (publickey)
```

**解决方法：**
```bash
# 使用正确的SSH密钥
scp -i /path/to/your-key.pem backup.sql.gz user@server:/path/

# 或者使用密码认证
scp -o PreferredAuthentications=password backup.sql.gz user@server:/path/
```

### 问题4: 导入失败 - 磁盘空间不足

**错误信息：**
```
ERROR 1030 (HY000): Got error 28 from storage engine
```

**解决方法：**
```bash
# 检查磁盘空间
df -h

# 清理不必要的文件
sudo journalctl --vacuum-time=3d
sudo yum clean all

# 或者扩展磁盘空间
```

### 问题5: 导入后应用无法启动

**检查步骤：**

1. 验证数据库连接：
```bash
mysql -u root -pTonny@1000 -e "USE \`binance-data\`; SHOW TABLES;"
```

2. 检查config.yaml配置：
```bash
grep -A 5 "mysql:" config.yaml
```

3. 查看应用日志：
```bash
tail -100 /var/log/crypto-analyzer.log
```

4. 检查表结构：
```bash
mysql -u root -pTonny@1000 binance-data -e "SHOW TABLES;"
```

## 高级选项

### 仅导出结构（不含数据）

如果只需要导出表结构：

```bash
mysqldump -u root -pTonny@1000 \
    --no-data \
    binance-data > schema_only.sql
```

### 导出特定表

如果只需要导出某些表：

```bash
mysqldump -u root -pTonny@1000 \
    binance-data \
    prices klines signals > specific_tables.sql
```

### 增量备份

如果数据库很大，可以考虑增量备份：

```bash
# 首次全量备份
mysqldump -u root -pTonny@1000 \
    --single-transaction \
    --flush-logs \
    --master-data=2 \
    binance-data > full_backup.sql

# 后续增量备份使用binlog
mysqlbinlog mysql-bin.000001 > incremental_backup.sql
```

## 自动化迁移

### 创建定时备份

添加到 crontab：

```bash
# 编辑crontab
crontab -e

# 每天凌晨2点自动备份
0 2 * * * cd /path/to/crypto-analyzer && bash export_database.sh >> /var/log/db_backup.log 2>&1

# 每周日凌晨3点清理超过30天的备份
0 3 * * 0 find /path/to/crypto-analyzer/backups/ -name "*.sql.gz" -mtime +30 -delete
```

### 一键迁移脚本

创建完整的迁移脚本：

```bash
#!/bin/bash
# migrate_all.sh - 一键迁移脚本

SERVER_HOST="your-server.com"
SERVER_USER="ec2-user"
SERVER_KEY="~/.ssh/your-key.pem"
REMOTE_PATH="/home/ec2-user/crypto-analyzer"

# 1. 导出本地数据库
echo "1. 导出本地数据库..."
bash export_database.sh

# 2. 获取最新的备份文件
BACKUP_FILE=$(ls -t backups/*.sql.gz | head -1)
echo "2. 备份文件: $BACKUP_FILE"

# 3. 上传到服务器
echo "3. 上传到服务器..."
scp -i $SERVER_KEY $BACKUP_FILE $SERVER_USER@$SERVER_HOST:$REMOTE_PATH/backups/

# 4. 在服务器上导入
echo "4. 在服务器上导入..."
BACKUP_FILENAME=$(basename $BACKUP_FILE)
ssh -i $SERVER_KEY $SERVER_USER@$SERVER_HOST "cd $REMOTE_PATH && sudo bash import_database.sh backups/$BACKUP_FILENAME"

# 5. 重启服务
echo "5. 重启服务..."
ssh -i $SERVER_KEY $SERVER_USER@$SERVER_HOST "sudo systemctl restart crypto-analyzer"

echo "迁移完成!"
```

## 安全建议

1. **加密备份文件**
   ```bash
   # 加密
   gpg -c database_backup.sql.gz

   # 解密
   gpg database_backup.sql.gz.gpg
   ```

2. **定期清理旧备份**
   ```bash
   # 删除30天前的备份
   find ./backups/ -name "*.sql.gz" -mtime +30 -delete
   ```

3. **验证备份完整性**
   ```bash
   # 使用校验和
   md5sum database_backup.sql.gz > database_backup.sql.gz.md5

   # 验证
   md5sum -c database_backup.sql.gz.md5
   ```

4. **使用安全的传输方式**
   - 使用 SCP/SFTP 而不是 FTP
   - 使用 SSH 密钥认证
   - 在传输前压缩和加密

## 相关脚本

- [export_database.sh](export_database.sh) - 数据库导出脚本
- [import_database.sh](import_database.sh) - 数据库导入脚本
- [reinstall_mariadb.sh](reinstall_mariadb.sh) - MariaDB 重新安装脚本
- [deploy.sh](deploy.sh) - 完整部署脚本

## 参考资料

- [MySQL 官方文档 - mysqldump](https://dev.mysql.com/doc/refman/8.0/en/mysqldump.html)
- [MariaDB 备份和恢复](https://mariadb.com/kb/en/backup-and-restore-overview/)
- [AWS RDS 迁移指南](https://docs.aws.amazon.com/dms/latest/userguide/Welcome.html)
