# 币本位超级大脑逻辑梳理

## 一、整体架构

### 1.1 核心类结构

```
coin_futures_trader_service.py
├── DatabaseExchangeAdapter          # 数据库K线适配器
├── CoinFuturesDecisionBrain        # 智能决策大脑
└── CoinFuturesTraderService        # 主交易服务
```

### 1.2 关键组件

| 组件 | 说明 | 状态 |
|------|------|------|
| **WebSocket价格服务** | 实时价格获取 | ✅ 已集成 |
| **智能分批建仓** | SmartEntryExecutor | ✅ 已集成 |
| **智能平仓优化** | SmartExitOptimizer | ✅ 已集成 |
| **破位系统** | BreakoutSystem | ✅ 已集成 |
| **Big4趋势检测** | Big4TrendDetector | ✅ 已集成 |
| **信号黑名单** | SignalBlacklistChecker | ✅ 已集成 |
| **评分系统V2** | SignalScoreV2Service | ✅ 已集成 |

---

## 二、开仓流程（open_position）

### 2.1 流程图

```
开仓请求
    │
    ├─→ 第零步：验证symbol格式
    │   └─→ 必须是 /USD 格式（币本位）
    │       └─→ 拒绝 /USDT 格式（U本位）
    │
    ├─→ 第一步：信号验证
    │   ├─→ 时间框架一致性检查
    │   ├─→ position_high信号额外验证
    │   ├─→ 平仓后冷却期检查（15分钟）
    │   └─→ 防追高/追跌过滤
    │
    ├─→ 第二步：选择开仓方式
    │   ├─→ 分批建仓（SmartEntryExecutor）
    │   │   ├─→ 白名单检查
    │   │   ├─→ 非反转信号
    │   │   └─→ 后台异步执行（60分钟）
    │   │
    │   └─→ 一次性开仓
    │       └─→ 继续第三步
    │
    └─→ 第三步：一次性开仓逻辑
        ├─→ 获取实时价格（WS优先，DB回退）
        ├─→ 计算保证金
        │   ├─→ 反转开仓：使用原保证金
        │   └─→ 正常开仓：
        │       ├─→ 获取评级等级（0/1/2/3）
        │       ├─→ Level 3禁止交易
        │       ├─→ 基础保证金 × 评级倍数
        │       └─→ Big4市场信号调整（顺势×1.2）
        │
        ├─→ 计算止损止盈
        ├─→ 执行开仓
        └─→ 启动智能监控
```

### 2.2 保证金计算逻辑

#### 2.2.1 评级制度（⚠️ 需要更新）

**当前逻辑**（使用margin_multiplier）:
```python
# 从trading_symbol_rating表获取
rating_level = 0/1/2/3
rating_config = get_blacklist_config(rating_level)
margin_multiplier = rating_config['margin_multiplier']

# Level 0: multiplier = 1.0   → 400U × 1.0 = 400U
# Level 1: multiplier = 0.25  → 400U × 0.25 = 100U
# Level 2: multiplier = 0.125 → 400U × 0.125 = 50U
# Level 3: multiplier = 0     → 禁止交易
```

**新需求**（每批固定保证金）:
```python
# 根据评级等级设置每批固定保证金
if rating_level == 0:
    margin_per_batch = 200  # 白名单/默认
elif rating_level == 1:
    margin_per_batch = 50   # 黑名单1级
elif rating_level == 2:
    margin_per_batch = 30   # 黑名单2级
else:
    return False  # 黑名单3级禁止交易
```

#### 2.2.2 Big4市场信号调整

```python
if market_signal == 'BULLISH' and side == 'LONG':
    position_multiplier = 1.2  # 顺势做多，加仓20%
elif market_signal == 'BEARISH' and side == 'SHORT':
    position_multiplier = 1.2  # 顺势做空，加仓20%
else:
    position_multiplier = 1.0  # 逆势或中性，正常仓位
```

#### 2.2.3 反转开仓

```python
if is_reversal and 'original_margin' in opp:
    # 使用原仓位相同的保证金
    adjusted_position_size = opp['original_margin']
```

---

## 三、信号验证系统

### 3.1 验证流程

```
信号验证
    │
    ├─→ 时间框架一致性 (validate_signal_timeframe)
    │   ├─→ position_high: 仅15M有效
    │   ├─→ position_drop: 仅15M有效
    │   └─→ 其他信号：允许5M/15M/1H
    │
    ├─→ position_high额外验证 (validate_position_high_signal)
    │   ├─→ 做多：必须 current_price ≤ 15M最高价
    │   └─→ 做空：必须 current_price ≥ 15M最低价
    │
    ├─→ 平仓后冷却期检查
    │   └─→ 同方向15分钟内禁止再次开仓
    │
    └─→ 防追高/追跌过滤 (check_anti_fomo_filter)
        ├─→ 做多：当前价 ≤ 15M最高价
        └─→ 做空：当前价 ≥ 15M最低价
```

### 3.2 信号黑名单

```python
# 动态加载，5分钟缓存
blacklist_checker.is_blacklisted(signal_combination, direction)
```

---

## 四、智能分批建仓（SmartEntryExecutor）

### 4.1 触发条件

- ✅ batch_entry_config['enabled'] = True
- ✅ 在白名单中（或白名单为空）
- ❌ 不是反转开仓

### 4.2 执行方式

```python
# 后台异步执行，不阻塞主循环
asyncio.run_coroutine_threadsafe(
    self._open_position_with_batch(opp),
    self.event_loop
)
```

### 4.3 建仓策略（⚠️ 需要更新）

**旧逻辑**（分批比例）:
```
总保证金400U，分3批建仓
- 第1批：30% = 120U
- 第2批：30% = 120U
- 第3批：40% = 160U
```

**新逻辑**（固定金额）:
```
每批使用固定保证金（根据评级）
- 白名单：每批200U
- 黑名单1级：每批50U
- 黑名单2级：每批30U
```

---

## 五、智能平仓监控（SmartExitOptimizer）

### 5.1 监控策略

#### 5.1.1 极端亏损兜底（立即生效）

```python
if pnl_pct <= -3.0:
    return ('极端亏损止损(≥3%)', 1.0)  # 全部平仓
```

#### 5.1.2 智能亏损监控（30分钟后启动）

```python
# 策略A: 亏损≥2% + 2根5M K线无好转
if pnl_pct <= -2.0:
    no_improvement = check_5m_no_improvement()
    if no_improvement:
        return ('亏损2%+5M无好转', 1.0)

# 策略B: 亏损≥1% + 2根15M K线无持续好转
if pnl_pct <= -1.0:
    no_sustained = check_15m_no_sustained_improvement()
    if no_sustained:
        return ('亏损1%+15M无持续好转', 1.0)
```

#### 5.1.3 盈利监控

```python
# 盈利<1%: 任由其发育
# 盈利≥2%: 回撤≥0.5%即止盈
if profit_pct >= 2.0:
    drawback = max_profit - current_profit
    if drawback >= 0.5:
        return ('盈利回撤止盈', 1.0)
```

#### 5.1.4 计划平仓（150分钟后）

```python
# T-30分钟：启动价格评估体系
# T-20分钟：完成10分钟价格基线
# T-20到T+0：寻找最佳价格平仓
# T+0：计划平仓时间，必须强制执行
```

---

## 六、Big4趋势检测

### 6.1 底部反转检测

```python
# 4个顶级币种(BTC/ETH/BNB/SOL)均在底部
if all_bottom_signal_count == 4:
    # 紧急干预：平掉所有空头，禁止开空2小时
    emergency_close_all_positions('SHORT', '4币种同时触底')
    emergency_bottom_reversal_time = now
```

### 6.2 顶部反转检测

```python
# 4个顶级币种均在顶部
if all_top_signal_count == 4:
    # 紧急干预：平掉所有多头，禁止开多2小时
    emergency_close_all_positions('LONG', '4币种同时触顶')
    emergency_top_reversal_time = now
```

---

## 七、需要更新的部分

### 7.1 保证金逻辑（币本位）

**问题**：币本位仍在使用旧的 margin_multiplier 逻辑

**需要修改的文件**：
- `coin_futures_trader_service.py`
  - Line 1788-1802: 保证金计算逻辑
  - Line 1800: `base_position_size = self.position_size_usdt * rating_margin_multiplier`

**修改为**：
```python
# 获取每批固定保证金
margin_per_batch = self._get_margin_per_batch(symbol)

if margin_per_batch == 0:
    logger.warning(f"[BLACKLIST_LEVEL3] {symbol} 已被永久禁止交易")
    return False

# Big4市场信号调整
if market_signal == 'BULLISH' and side == 'LONG':
    adjusted_margin = margin_per_batch * 1.2
elif market_signal == 'BEARISH' and side == 'SHORT':
    adjusted_margin = margin_per_batch * 1.2
else:
    adjusted_margin = margin_per_batch
```

### 7.2 分批建仓逻辑（如果币本位也使用）

**检查是否使用**：
- 币本位是否启用了 SmartEntryExecutor？
- 如果启用，需要同步更新为固定保证金逻辑

### 7.3 平仓时间和原因更新

**已在U本位修复**，需要确认币本位是否有同样问题：
- close_time 是否正确更新
- close_reason 是否正确显示

---

## 八、关键配置

### 8.1 数据库配置

```yaml
db_config:
  host: 13.212.252.171
  port: 3306
  user: admin
  password: Tonny@1000
  database: binance-data
```

### 8.2 交易配置

```python
position_size_usdt = 400        # 基础保证金（将废弃）
leverage = 5                    # 杠杆倍数
threshold = 55                  # 开仓阈值（55分）
emergency_block_duration = 2h   # 紧急干预持续时间
```

### 8.3 分批建仓配置

```python
batch_entry_config = {
    'enabled': True,
    'whitelist_symbols': [],  # 空=所有币种
    'window_minutes': 60      # 建仓窗口
}
```

---

## 九、运行流程

```
启动
  │
  ├─→ 初始化组件
  │   ├─→ WebSocket价格服务
  │   ├─→ 决策大脑
  │   ├─→ 智能监控
  │   └─→ 数据库连接
  │
  ├─→ 加载配置
  │   ├─→ 交易对列表
  │   ├─→ 黑名单
  │   └─→ 自适应参数
  │
  ├─→ 主循环（每10分钟）
  │   ├─→ 检查交易开关
  │   ├─→ Big4趋势检测
  │   ├─→ 破位系统扫描
  │   ├─→ 信号分析（所有交易对）
  │   ├─→ 开仓决策
  │   └─→ 智能监控（持续运行）
  │
  └─→ 后台任务
      ├─→ 自适应优化（每日00:00）
      ├─→ 评级更新（每日00:00）
      └─→ 智能监控重启检查
```

---

## 十、与U本位的主要区别

| 特性 | U本位 | 币本位 |
|------|------|--------|
| **交易对格式** | /USDT | /USD |
| **保证金货币** | USDT | 对应币种 |
| **API端点** | fapi | dapi |
| **合约类型** | USDT永续 | USD永续 |
| **数量计算** | 基于USDT | 基于币数量 |
| **当前保证金逻辑** | ✅ 已更新为固定金额 | ❌ 仍使用倍数 |
| **分批建仓** | ✅ 已更新 | ⚠️ 需检查 |
| **平仓逻辑** | ✅ 已修复 | ⚠️ 需检查 |

---

## 十一、待办事项

### 高优先级
- [ ] 更新币本位保证金逻辑为固定金额（参考U本位）
- [ ] 检查并修复币本位平仓时间和原因更新问题
- [ ] 验证币本位是否有分批平仓遗留代码

### 中优先级
- [ ] 统一U本位和币本位的配置管理
- [ ] 添加币本位评级等级日志显示
- [ ] 优化Big4市场信号调整逻辑

### 低优先级
- [ ] 完善币本位文档
- [ ] 添加更多监控指标
- [ ] 性能优化

---

## 十二、常见问题

### Q1: 币本位和U本位可以同时运行吗？
A: 可以，它们是独立的服务，互不影响。

### Q2: 评级等级从哪里获取？
A: 从 `trading_symbol_rating` 表获取，由 SymbolRatingManager 自动维护。

### Q3: 分批建仓是否会阻塞主循环？
A: 不会，使用 `asyncio.run_coroutine_threadsafe` 后台异步执行。

### Q4: Big4紧急干预后多久恢复？
A: 默认2小时后自动恢复正常交易。

---

*文档创建时间: 2026-02-21*
*最后更新: 2026-02-21*
