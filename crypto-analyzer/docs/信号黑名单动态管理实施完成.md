# 信号黑名单动态管理 - 实施完成

## 📋 实施时间
**日期**: 2026-02-11
**版本**: v1.0

---

## ✅ 已完成的工作

### 1. 数据库表升级
**文件**: `scripts/upgrade_signal_blacklist_table.py`

**新增字段**：
```sql
ALTER TABLE signal_blacklist
ADD COLUMN blacklist_level TINYINT DEFAULT 3 COMMENT '黑名单等级: 1=观察, 2=限制, 3=禁用',
ADD COLUMN last_reviewed_at TIMESTAMP NULL COMMENT '上次评估时间',
ADD COLUMN review_period_days INT DEFAULT 7 COMMENT '评估周期（天）',
ADD COLUMN retry_count INT DEFAULT 0 COMMENT '重试次数',
ADD COLUMN performance_json TEXT COMMENT '加入黑名单后的表现（JSON）';
```

**执行命令**：
```bash
python scripts/upgrade_signal_blacklist_table.py
```

**结果**：
- 自动备份原表 `signal_blacklist_backup_YYYYMMDD_HHMMSS`
- 添加5个新字段
- 初始化现有30条记录为Level 3（完全禁用）
- 添加索引优化查询性能

---

### 2. 信号黑名单评估器
**文件**: `app/services/signal_blacklist_reviewer.py`

**核心功能**：
1. **3级黑名单制度**：
   - Level 1（观察期）：降低仓位50%，7天评估
   - Level 2（严格限制）：降低仓位25%，14天评估
   - Level 3（完全禁用）：彻底禁用，30天评估

2. **自动升级机制**（降低等级，变好）：
   - L1 → L0：胜率≥50% + 订单≥10
   - L2 → L1：胜率≥55% + 订单≥15 + 盈利≥50U
   - L3 → L2：胜率≥60% + 订单≥20 + 盈利≥100U

3. **自动降级机制**（提高等级，变差）：
   - L1 → L2：胜率<35% 或 亏损<-100U
   - L2 → L3：胜率<30% 或 亏损<-200U

4. **防止频繁波动**：
   - 最大重试次数：3次（超过则永久禁用）
   - 定期评估：按等级不同，周期为7/14/30天

---

### 3. 集成到主服务
**修改文件**：
- `smart_trader_service.py` - U本位合约服务
- `coin_futures_trader_service.py` - 币本位合约服务

**集成位置**: `check_and_run_daily_optimization()` 方法

**执行时间**: 每天凌晨2点（UTC），与其他优化任务一起运行

**执行流程**：
```python
1. 运行自适应优化（参数调整）
2. 更新交易对评级（3级黑名单）
3. 更新波动率配置
4. 评估信号黑名单（新增）
   ├─ 检查是否到达评估周期
   ├─ 查询最近30天表现
   ├─ 判断是否升级/降级/解除
   └─ 更新数据库记录
5. 如有信号解除，重新加载配置
```

---

### 4. 测试工具
**文件**: `scripts/test_signal_blacklist_reviewer.py`

**测试命令**：
```bash
python scripts/test_signal_blacklist_reviewer.py
```

**测试内容**：
- 评估所有激活的黑名单信号
- 打印详细的评估报告
- 验证数据库操作正确性

---

## 📊 系统架构

```
┌─────────────────────────────────────────────────────────┐
│         每日自适应优化任务（凌晨2点）                     │
└─────────────────────────────────────────────────────────┘
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
       ┌──────────┐  ┌──────────┐  ┌──────────┐
       │参数调整  │  │交易对评级│  │信号黑名单│◄── NEW!
       │          │  │（3级制）  │  │（3级制） │
       └──────────┘  └──────────┘  └──────────┘
                                         │
              ┌──────────────────────────┤
              ▼                          ▼
       ┌──────────┐              ┌──────────┐
       │查询表现  │              │评估等级  │
       │30天数据  │              │升/降/解除│
       └──────────┘              └──────────┘
              │                          │
              └──────────┬───────────────┘
                         ▼
                  ┌──────────┐
                  │更新数据库│
                  │重载配置  │
                  └──────────┘
```

---

## 🎯 预期效果

### 当前问题（实施前）
```
- 黑名单只增不减：31条记录
- 按速度推算：
  * 1个月后：~78条
  * 3个月后：~234条
  * 6个月后：~468条
- 结果：系统将无信号可用
```

### 实施后预期
```
- 黑名单动态平衡：
  * Level 1（观察）：10-15条
  * Level 2（限制）：5-8条
  * Level 3（禁用）：3-5条
  * 总计：20-30条

- 自动解除：每月5-10条信号恢复

- 系统适应性：
  * 牛市环境：自动解除高波动做多信号
  * 熊市环境：自动解除弱势反弹做空信号
  * 震荡市：维持严格的黑名单
```

---

## 🚀 部署步骤

### Step 1: 数据库升级（已完成）
```bash
# 备份数据库
mysqldump -h13.212.252.171 -uadmin -p binance-data signal_blacklist > signal_blacklist_backup.sql

# 运行升级脚本
python scripts/upgrade_signal_blacklist_table.py
```

### Step 2: 测试评估器（可选）
```bash
# 测试评估器功能
python scripts/test_signal_blacklist_reviewer.py
```

### Step 3: 重启交易服务
```bash
# 重启U本位服务
pkill -f smart_trader_service.py
nohup python smart_trader_service.py > logs/smart_trader.log 2>&1 &

# 重启币本位服务
pkill -f coin_futures_trader_service.py
nohup python coin_futures_trader_service.py > logs/coin_futures_trader.log 2>&1 &
```

### Step 4: 验证运行
```bash
# 查看日志
tail -f logs/smart_trader_$(date +%Y-%m-%d).log | grep "信号黑名单"

# 查询数据库
mysql -h13.212.252.171 -uadmin -p binance-data -e "
SELECT blacklist_level, COUNT(*) as count
FROM signal_blacklist
WHERE is_active=1
GROUP BY blacklist_level;"
```

---

## 📝 监控指标

### 每日查询脚本
```bash
# 查看最近评估结果
python scripts/check_self_optimization_history.py | grep -A 20 "信号黑名单"
```

### SQL监控查询
```sql
-- 1. 黑名单等级分布
SELECT
    blacklist_level,
    COUNT(*) as count,
    AVG(retry_count) as avg_retry
FROM signal_blacklist
WHERE is_active = 1
GROUP BY blacklist_level;

-- 2. 最近解除的信号
SELECT
    signal_type,
    position_side,
    updated_at,
    notes
FROM signal_blacklist
WHERE is_active = 0
AND updated_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY updated_at DESC
LIMIT 10;

-- 3. 即将评估的信号
SELECT
    signal_type,
    position_side,
    blacklist_level,
    last_reviewed_at,
    DATE_ADD(last_reviewed_at, INTERVAL review_period_days DAY) as next_review
FROM signal_blacklist
WHERE is_active = 1
AND DATE_ADD(last_reviewed_at, INTERVAL review_period_days DAY) <= DATE_ADD(NOW(), INTERVAL 3 DAY)
ORDER BY next_review ASC;
```

---

## ⚠️ 注意事项

### 1. 重试次数限制
- 信号最多重试3次（解除后再次拉黑）
- 超过3次后永久禁用
- 建议人工审核重试次数>=2的信号

### 2. 评估周期
- Level 1: 7天评估一次（快速响应）
- Level 2: 14天评估一次（观察期）
- Level 3: 30天评估一次（严格禁用）

### 3. 数据要求
- 至少需要5单数据才会评估
- 使用最近30天的数据计算表现
- 胜率和盈亏双重验证

### 4. 配置重载
- 解除黑名单后自动调用 `brain.reload_blacklist()`
- 确保新解除的信号立即生效
- 建议在低峰期（凌晨2点）执行

---

## 🔧 故障排查

### 问题1：评估器未运行
**症状**：日志中没有"评估信号黑名单"相关输出

**排查**：
```bash
# 检查是否到达评估时间
python -c "from datetime import datetime; print(datetime.utcnow())"

# 手动触发评估
python scripts/test_signal_blacklist_reviewer.py
```

### 问题2：信号未解除
**症状**：表现良好的信号仍在黑名单

**排查**：
```sql
-- 检查信号表现数据
SELECT
    entry_signal_type,
    position_side,
    COUNT(*) as orders,
    SUM(CASE WHEN realized_pnl > 0 THEN 1 ELSE 0 END) / COUNT(*) as win_rate,
    SUM(realized_pnl) as total_pnl
FROM futures_positions
WHERE entry_signal_type = '信号类型'
AND position_side = 'LONG/SHORT'
AND status = 'CLOSED'
AND close_time >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY entry_signal_type, position_side;
```

### 问题3：数据库连接超时
**症状**：评估器执行超时

**解决**：
```python
# 修改 signal_blacklist_reviewer.py
# 增加连接超时时间
self.connection = pymysql.connect(
    ...,
    connect_timeout=30,  # 增加到30秒
    read_timeout=60      # 增加到60秒
)
```

---

## 📈 后续优化方向

### 1. 信号白名单机制
保护核心信号（顶底识别、趋势反转）永不拉黑

### 2. 市场环境自适应
根据市场状态（牛市/熊市/震荡）动态调整阈值

### 3. 告警通知
重试次数达到2次时发送Telegram通知

### 4. A/B测试
对解除的信号进行小仓位测试验证

### 5. 机器学习优化
使用历史数据训练最优的升级/降级阈值

---

## ✅ 总结

**实施完成项**：
- ✅ 数据库表结构升级
- ✅ 信号黑名单评估器开发
- ✅ 集成到U本位和币本位服务
- ✅ 创建测试和监控脚本
- ✅ 完善文档和部署指南

**核心改进**：
- 从"一刀切永久禁用"改为"3级动态管理"
- 自动解除表现改善的信号
- 防止黑名单无限增长导致系统失效
- 适应不同市场环境

**预期效果**：
- 黑名单保持在20-30条动态平衡
- 每月自动解除5-10条信号
- 系统持续保持活力和适应性

**风险控制**：
- 最大重试3次，防止频繁波动
- 分级管理，逐步验证表现
- 定期评估，不会立即全部解除

---

**实施人员**: Claude Sonnet 4.5
**审核状态**: 待用户验证
**下次review**: 2026-02-18（7天后）
