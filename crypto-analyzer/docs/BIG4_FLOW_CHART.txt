四大天王信号判断和干预流程图
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          超级大脑发现交易机会                                  │
│                    (例: BTC/USDT LONG, 评分45)                               │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │  是四大天王之一?     │
                    │ (BTC/ETH/BNB/SOL)   │
                    └──────┬────────┬─────┘
                           │        │
                     是 ◄──┘        └──► 否
                      │                   │
                      ▼                   ▼
         ┌────────────────────┐    ┌────────────┐
         │ Big4趋势检测器启动  │    │ 正常开仓    │
         └──────────┬─────────┘    │ (不干预)    │
                    │              └────────────┘
                    ▼
    ┌───────────────────────────────────────────┐
    │         第一步: 盘整期检测 (6H)            │
    │                                           │
    │  获取6H前开盘价 vs 当前收盘价              │
    │  涨跌幅 = (now - before) / before * 100   │
    │                                           │
    │  ├─ abs(涨跌幅) < 0.5% → 盘整中            │
    │  └─ abs(涨跌幅) >= 0.5% → 非盘整           │
    └───────────────┬───────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────┐
    │       第二步: K线力度分析 (1H + 15M)       │
    │                                           │
    │  1H分析 (最近6根K线):                      │
    │  ├─ 阳线 vs 阴线数量                       │
    │  ├─ 阳线 vs 阴线成交量                     │
    │  └─ 阳线 vs 阴线实体大小                   │
    │     → 计算综合得分 → BULL/BEAR/NEUTRAL     │
    │                                           │
    │  15M分析 (最近8根K线):                     │
    │  └─ 同样逻辑 → BULL/BEAR/NEUTRAL           │
    └───────────────┬───────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────┐
    │      第三步: 突破检测 (5M + 15M)           │
    │                                           │
    │  5M突破 (最近10根K线):                     │
    │  ├─ 最新成交量 > 平均 × 1.5? ✓             │
    │  └─ 最新实体 > 平均 × 1.5? ✓               │
    │     → 检测到突破 → BULLISH/BEARISH         │
    │                                           │
    │  15M突破 (最近5根K线):                     │
    │  └─ 同样逻辑                               │
    └───────────────┬───────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────────┐
    │          第四步: 综合评分生成               │
    │                                           │
    │  评分系统 (-100 到 +100):                  │
    │                                           │
    │  盘整期内:                                 │
    │  ├─ 5M突破: ±30分                          │
    │  └─ 15M突破: ±25分                         │
    │                                           │
    │  K线力度:                                  │
    │  ├─ 1H主导: ±20分                          │
    │  └─ 15M主导: ±20分                         │
    │                                           │
    │  非盘整期:                                 │
    │  ├─ 5M突破: ±20分                          │
    │  └─ 15M突破: ±20分                         │
    │                                           │
    │  信号判定:                                 │
    │  ├─ 评分 > 30 → BULLISH (看多)             │
    │  ├─ 评分 < -30 → BEARISH (看空)            │
    │  └─ -30 ~ 30 → NEUTRAL (中性)              │
    │                                           │
    │  强度 = min(abs(评分), 100)                │
    └───────────────┬───────────────────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │   Big4信号已生成      │
         │                      │
         │ 信号: BEARISH         │
         │ 强度: 75              │
         │ 原因: 6H盘整 |        │
         │       5M向下突破 |     │
         │       1H阴线主导       │
         └──────────┬───────────┘
                    │
                    ▼
    ════════════════════════════════════════════
             干预决策树开始
    ════════════════════════════════════════════
                    │
                    ▼
         ┌──────────────────────┐
         │  Big4信号 vs         │
         │  超级大脑交易方向      │
         └──────────┬───────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
        ▼           ▼           ▼
   ┌────────┐ ┌────────┐ ┌────────┐
   │ 强冲突  │ │ 弱冲突  │ │ 一致   │
   │强度>=60│ │强度<60 │ │        │
   └───┬────┘ └───┬────┘ └───┬────┘
       │          │          │
       ▼          ▼          ▼

╔═════════════════════════════════════════════════════════╗
║  场景A: 强冲突 - 直接跳过                                 ║
╠═════════════════════════════════════════════════════════╣
║                                                         ║
║  条件: Big4强度 >= 60 && 方向相反                        ║
║                                                         ║
║  超级大脑: BTC LONG (45分)                               ║
║  Big4检测: BEARISH (强度75)                              ║
║                                                         ║
║  [BIG4-SKIP] BTC强烈看空, 跳过LONG信号                   ║
║                                                         ║
║  结果: 不开仓 ❌                                         ║
║  理由: 强烈反向信号,风险太大                              ║
╚═════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════╗
║  场景B: 弱冲突 - 降低评分                                ║
╠═════════════════════════════════════════════════════════╣
║                                                         ║
║  条件: Big4强度 < 60 && 方向相反                         ║
║                                                         ║
║  超级大脑: ETH SHORT (50分)                              ║
║  Big4检测: BULLISH (强度45)                              ║
║                                                         ║
║  处理:                                                   ║
║  ├─ 评分降低30分: 50 - 30 = 20                          ║
║  └─ 检查最低阈值: 20 >= 20? 是                           ║
║                                                         ║
║  [BIG4-ADJUST] ETH评分降低: 50 -> 20                    ║
║                                                         ║
║  结果: 降低评分后开仓 ⚠️                                 ║
║  理由: 有一定冲突,但不是强烈反向                          ║
║                                                         ║
║  ─────────────────────────────────────                  ║
║  如果评分 < 20:                                          ║
║  [BIG4-SKIP] 调整后评分过低, 跳过                        ║
║  结果: 不开仓 ❌                                         ║
╚═════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════╗
║  场景C: 方向一致 - 提升评分                              ║
╠═════════════════════════════════════════════════════════╣
║                                                         ║
║  条件: Big4信号方向 == 交易方向                          ║
║                                                         ║
║  超级大脑: BNB LONG (40分)                               ║
║  Big4检测: BULLISH (强度80)                              ║
║                                                         ║
║  计算提升分数:                                           ║
║  ├─ 原始: 强度 × 0.3 = 80 × 0.3 = 24                    ║
║  └─ 限制: min(20, 24) = 20                              ║
║                                                         ║
║  新评分: 40 + 20 = 60                                   ║
║                                                         ║
║  [BIG4-BOOST] BNB评分提升: 40 -> 60 (+20)              ║
║                                                         ║
║  结果: 以更高评分开仓 ✅                                 ║
║  理由: 趋势一致,增加信号可靠性                            ║
╚═════════════════════════════════════════════════════════╝

╔═════════════════════════════════════════════════════════╗
║  场景D: 中性信号 - 不干预                                ║
╠═════════════════════════════════════════════════════════╣
║                                                         ║
║  条件: Big4信号 = NEUTRAL                                ║
║                                                         ║
║  超级大脑: SOL SHORT (52分)                              ║
║  Big4检测: NEUTRAL (强度5)                               ║
║                                                         ║
║  [BIG4] SOL趋势信号: NEUTRAL (强度: 5)                   ║
║                                                         ║
║  结果: 保持原评分52,正常开仓 ✅                           ║
║  理由: 无明确方向,不影响决策                              ║
╚═════════════════════════════════════════════════════════╝

                    │
                    ▼
         ┌──────────────────────┐
         │    最终开仓决策        │
         └──────────┬───────────┘
                    │
        ┌───────────┼───────────┐
        │           │           │
        ▼           ▼           ▼
   ┌────────┐ ┌────────┐ ┌────────┐
   │ 跳过    │ │ 降分开仓│ │ 加分开仓│
   │        │ │        │ │        │
   │  ❌    │ │  ⚠️    │ │  ✅    │
   └────────┘ └────────┘ └────────┘


═══════════════════════════════════════════════════════════════════════════════
                              数据流示例
═══════════════════════════════════════════════════════════════════════════════

输入数据 (来自 kline_data 表):
┌──────────────────────────────────────────────────────────────────────────┐
│ symbol     | timeframe | timestamp           | open  | close | volume   │
├──────────────────────────────────────────────────────────────────────────┤
│ BTC/USDT   | 1h        | 2026-01-28 08:00:00 | 99500 | 99600 | 150      │
│ BTC/USDT   | 1h        | 2026-01-28 09:00:00 | 99600 | 99550 | 180      │
│ BTC/USDT   | 1h        | 2026-01-28 10:00:00 | 99550 | 99580 | 160      │
│ BTC/USDT   | 1h        | 2026-01-28 11:00:00 | 99580 | 99520 | 190      │
│ BTC/USDT   | 1h        | 2026-01-28 12:00:00 | 99520 | 99600 | 170      │
│ BTC/USDT   | 1h        | 2026-01-28 13:00:00 | 99600 | 99540 | 200      │
│ BTC/USDT   | 5m        | 2026-01-28 13:55:00 | 99540 | 98800 | 800 ◄── │
│            |           |                     |       |  ↑    |   ↑      │
│            |           |                     |       |  │    |   │      │
│            |           |                     |  向下突破  强力量│      │
└──────────────────────────────────────────────────────────────────────────┘

分析结果:
┌──────────────────────────────────────┐
│ 6H盘整: 是 (+0.40%)                   │
│ 1H主导: NEUTRAL                       │
│ 15M主导: NEUTRAL                      │
│ 5M突破: 检测到 (BEARISH)              │
│   ├─ 成交量: 800 vs 平均200 = 4.0x   │
│   └─ 实体: 0.74% vs 平均0.25% = 2.96x│
└──────────────────────────────────────┘

评分计算:
┌──────────────────────────────────────┐
│ 盘整期5M突破: -30分                   │
│ 1H主导: 0分 (NEUTRAL)                │
│ 15M主导: 0分 (NEUTRAL)               │
│ ────────────────────                 │
│ 总评分: -30                          │
│                                      │
│ 信号: BEARISH (< -30)                │
│ 强度: 30                             │
└──────────────────────────────────────┘

干预结果:
┌──────────────────────────────────────┐
│ 超级大脑: BTC LONG (45分)             │
│ Big4信号: BEARISH (强度30)            │
│                                      │
│ 判断: 弱冲突 (30 < 60)                │
│ 动作: 评分降低 45 - 30 = 15          │
│                                      │
│ 15 < 20 → 跳过交易 ❌                │
└──────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                            关键参数一览表
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────┬──────────┬────────────────────────────────────┐
│ 参数名称             │ 默认值    │ 说明                                │
├─────────────────────┼──────────┼────────────────────────────────────┤
│ 盘整阈值             │ 0.5%     │ 6H涨跌幅 < 0.5% 判定为盘整          │
│ 盘整观察期           │ 6小时    │ 向前追溯6小时检查盘整               │
│ 突破成交量倍数       │ 1.5x     │ 成交量 > 平均 × 1.5 判定为突破      │
│ 突破实体倍数         │ 1.5x     │ 实体 > 平均 × 1.5 判定为突破        │
│ 强冲突阈值           │ 60       │ 强度 >= 60 直接跳过                │
│ 弱冲突降分           │ -30分    │ 冲突时降低30分                      │
│ 一致加分上限         │ +20分    │ 最多提升20分                        │
│ 最低评分阈值         │ 20分     │ 调整后 < 20 则跳过                 │
│ 看多信号阈值         │ +30分    │ 评分 > 30 判定为BULLISH            │
│ 看空信号阈值         │ -30分    │ 评分 < -30 判定为BEARISH           │
└─────────────────────┴──────────┴────────────────────────────────────┘

权重分配:
┌─────────────────────┬──────────┬────────────────────────────────────┐
│ 信号类型             │ 盘整期    │ 非盘整期                            │
├─────────────────────┼──────────┼────────────────────────────────────┤
│ 5M突破              │ ±30分    │ ±20分                               │
│ 15M突破             │ ±25分    │ ±20分                               │
│ 1H K线主导          │ ±20分    │ ±20分                               │
│ 15M K线主导         │ ±20分    │ ±20分                               │
└─────────────────────┴──────────┴────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                              日志示例
═══════════════════════════════════════════════════════════════════════════════

正常流程:
[SCAN] 扫描 100 个币种...
[EXECUTE] 找到 5 个机会
[BIG4] BTC/USDT 趋势信号: BEARISH (强度: 75)
[BIG4-SKIP] BTC/USDT 强烈看空 (强度75), 跳过LONG信号 (原评分45)
[BIG4] ETH/USDT 趋势信号: BULLISH (强度: 65)
[BIG4-BOOST] ETH/USDT 看多信号与LONG方向一致, 评分提升: 38 -> 57 (+19)
[OPEN] ETH/USDT LONG | 价格: $3515.40 (WS) | 数量: 0.57
[BIG4-APPLIED] ETH/USDT Big4趋势: BULLISH (强度: 65)

异常处理:
[BIG4-ERROR] BNB/USDT Big4检测失败: Connection timeout
[OPEN] BNB/USDT SHORT | 价格: $623.45 (WS) | 数量: 0.64
(Big4失败不影响正常交易)


═══════════════════════════════════════════════════════════════════════════════
文档版本: v1.0
最后更新: 2026-01-28
作者: Claude Sonnet 4.5 & User
═══════════════════════════════════════════════════════════════════════════════
