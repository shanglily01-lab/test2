# 超级大脑优化任务清单

> **创建日期**: 2026-02-08
> **状态**: 待实施
> **目标**: 解决"不赚钱、赚得少、亏得多"的核心问题

---

## 📊 优化背景

### 当前问题
- ❌ 不赚钱、赚得少、亏得多
- ❌ 趋势误判
- ❌ 机会没抓住（最佳入场点被错过）
- ❌ 跟进去被反转（开仓后价格反转触发止损）

### 成功案例（2月5日）
- ✅ Big4单向看空 → 一直做空 → 胜率74.81% → +2,995U
- ✅ 关键：抓住了明确的单边趋势

### 失败案例（2月6-7日）
- ❌ 震荡市，来回打脸
- ❌ 67%的亏损单在24H区间75%以上开仓（追高）
- ❌ 日均亏损 -2,700U

---

## 🎯 优化目标

### 交易节奏
- 日交易次数: 200+ → **150笔**
- 持仓时间: 4小时 → **3小时**
- 日盈亏: -2,700U → **+50~150U**

### 核心策略
1. **15M为主导** - 快速响应短期波动
2. **Big4看重大事件** - 保留否决权
3. **抓住两种机会**:
   - 价格突然拉起/下跌 + 放量 → 立即跟进
   - 涨起来的等回调再买入

---

## 🚀 实施清单

### 第一阶段: 快速修复（1天）⭐⭐⭐⭐⭐

#### 任务1.1: 动态反转止损 🔴 P0

**目标**: 解决"跟进去被反转"问题

**文件**: `app/services/dynamic_stop_loss_v2.py` (新建)

**核心逻辑**:
```python
检测反转信号:
1. 持仓LONG，但出现连续2根5M阴线 + 放量1.3x
2. 持仓SHORT，但出现连续2根5M阳线 + 放量1.3x
3. 2根K线跌幅/涨幅 >= 0.8%
4. 当前浮盈 < 1%

→ 立即止损-1%，而不是等-3%
```

**实现要点**:
- 每30秒检查一次
- 集成到持仓监控循环
- 记录反转止损次数，便于统计

**预期效果**:
- 减少每笔亏损: 3% → 1% (减少2%)
- 月度减少亏损: ~800U

**时间估算**: 2小时

**验收标准**:
- [ ] 检测到反转信号时触发止损
- [ ] 止损价格为-1%左右
- [ ] 数据库记录notes字段包含"反转止损"

---

#### 任务1.2: 评分阈值调整 🔴 P0

**目标**: 筛除低质量信号

**文件**: `app/strategies/signal_scorer_v3.py` (修改)

**修改内容**:
```python
# 行号约34
self.min_score_to_trade = 25  # 当前

# 修改为
self.min_score_to_trade = 26  # 提升1分
```

**预期效果**:
- 减少边缘信号开仓
- 月度改善: +300U

**时间估算**: 5分钟

**验收标准**:
- [ ] 评分25分的信号被拒绝
- [ ] 评分26分的信号可以开仓

---

#### 任务1.3: 持仓时间缩短 🔴 P0

**目标**: 配合3小时持仓目标

**文件**: `smart_trader_service.py`, `coin_futures_trader_service.py` (修改)

**修改内容**:
```python
# 搜索 max_hold_minutes 或 240
max_hold_minutes = 240  # 当前

# 修改为
max_hold_minutes = 180  # 3小时

# 同时调整超时检查逻辑:
# 1H检查: 浮盈 < -1% → 平仓
# 2H检查: 浮盈 < 0% → 平仓
# 3H检查: 强制平仓
```

**预期效果**:
- 减少"拖着不动"的仓位
- 提高资金周转率
- 月度改善: +200U

**时间估算**: 10分钟

**验收标准**:
- [ ] 持仓超过180分钟触发超时
- [ ] 1H/2H检查条件正确

---

**第一阶段总预期**: +1,300U/月

---

### 第二阶段: 核心功能（2-3天）⭐⭐⭐⭐⭐

#### 任务2.1: 突然拉升检测器 🔴 P1

**目标**: 抓住5-15分钟快速拉升/下跌机会

**文件**: `app/detectors/sudden_move_detector.py` (新建)

**核心逻辑**:
```python
检测条件:
1. 检查5M和15M时间周期
2. 最近1-3根K线价格变化 >= 1%
3. 量能比率 >= 1.5x
4. Big4不强烈相反（强度<10时忽略Big4）

开仓条件:
- 突然拉升强度 >= 30
- 如果Big4相反，拉升强度需 >= 60
```

**实现要点**:
```python
class SuddenMoveDetector:
    def detect_sudden_move(self, symbol):
        """返回拉升/下跌检测结果"""
        pass

    def should_open_position(self, sudden_move, big4_signal):
        """判断是否应该开仓"""
        pass
```

**集成点**:
- `smart_trader_service.py` 主循环
- 每30秒检测一次
- 优先级高于常规评分系统

**预期效果**:
- 早期入场，成本优势1-2%
- 月度增加盈利: +1,500U

**时间估算**: 4小时

**验收标准**:
- [ ] 检测到BTC 5分钟拉升1.5% + 放量2x
- [ ] 立即触发开仓信号
- [ ] 数据库signal_type记录为"sudden_move"

---

#### 任务2.2: 回调买入检测器 🔴 P1

**目标**: 抓住价格回调后的反弹机会

**文件**: `app/detectors/pullback_detector.py` (新建)

**核心逻辑**:
```python
检测条件:
1. 计算最近2H的最高价/最低价
2. 当前价格回调1.5-4%
3. 出现第一根5M反弹K线
4. Big4趋势不强烈相反
5. 价格位置在24H区间30-70%

开仓条件:
- 入场质量 >= 40
- Big4不相反
```

**实现要点**:
```python
class PullbackDetector:
    def detect_pullback_opportunity(self, symbol):
        """检测回调买入机会"""
        pass

    def should_open_position(self, pullback, big4_signal, position_24h):
        """判断是否应该开仓"""
        pass
```

**集成点**:
- `smart_trader_service.py` 主循环
- 每30秒检测一次
- 与突然拉升检测器配合使用

**预期效果**:
- 入场成本优化2-3%
- 月度增加盈利: +1,200U

**时间估算**: 4小时

**验收标准**:
- [ ] 检测到BTC从104,000回调到102,000后反弹
- [ ] 触发回调买入信号
- [ ] 数据库signal_type记录为"pullback_entry"

---

#### 任务2.3: 评分权重调整 🟠 P1

**目标**: 15M主导，适应3小时短线

**文件**: `app/strategies/signal_scorer_v3.py` (修改)

**修改内容**:
```python
# 行号约24-30
self.score_weights = {
    'big4': 3,          # 当前
    '5h_trend': 7,
    '15m_signal': 12,
    'volume_price': 10,
    'technical': 10
}

# 修改为
self.score_weights = {
    'big4': 5,          # 3 → 5 (提升67%)
    '5h_trend': 6,      # 7 → 6 (降低14%)
    '15m_signal': 14,   # 12 → 14 (提升17%) ← 主导
    'volume_price': 10, # 保持
    'technical': 7      # 10 → 7 (降低30%)
}
```

**同时修复Big4强度阈值**:
```python
# 行号约144-152
if big4_strength >= 15:    # 当前
    return 3.0
elif big4_strength >= 10:
    return 2.4

# 修改为
if big4_strength >= 12:    # 15 → 12
    return 3.0
elif big4_strength >= 8:   # 10 → 8
    return 2.4
elif big4_strength >= 4:   # 5 → 4
    return 1.8
elif big4_strength >= 2:   # 新增
    return 1.2
```

**预期效果**:
- 15M权重增加，响应更快
- Big4阈值修正，实际权重提升
- 月度改善: +600U

**时间估算**: 1小时

**验收标准**:
- [ ] 总分42分不变
- [ ] 15M满分14分
- [ ] Big4强度12时可得3分

---

#### 任务2.4: Big4否决权机制 🟠 P1

**目标**: 重大事件时Big4强制否决

**文件**: `smart_trader_service.py`, `coin_futures_trader_service.py` (修改)

**实现逻辑**:
```python
def check_big4_veto(self, big4_signal, big4_strength, position_side):
    """
    Big4否决机制

    当Big4强度 >= 12且方向相反时，直接拒绝开仓
    """
    if not big4_signal or big4_strength < 12:
        return False, None

    # 判断Big4方向
    if 'BULL' in big4_signal.upper():
        big4_direction = 'LONG'
    elif 'BEAR' in big4_signal.upper():
        big4_direction = 'SHORT'
    else:
        return False, None  # NEUTRAL不否决

    # 否决逻辑
    if big4_direction != position_side:
        return True, f"Big4否决: {big4_signal}(强度{big4_strength}), 禁止{position_side}"

    return False, None

# 在开仓前调用
veto, reason = self.check_big4_veto(big4_signal, big4_strength, side)
if veto:
    logger.warning(f"[BIG4-VETO] {symbol} {reason}")
    continue  # 跳过该信号
```

**集成点**:
- 在evaluate_opportunities函数中
- 评分通过后，开仓前检查

**预期效果**:
- 避免逆重大趋势开仓
- 月度减少亏损: +700U

**时间估算**: 30分钟

**验收标准**:
- [ ] Big4强烈看空时拒绝多单
- [ ] Big4强度<12时不否决
- [ ] 日志记录"BIG4-VETO"

---

**第二阶段总预期**: +4,000U/月

---

### 第三阶段: 移动止盈优化（2天）⭐⭐⭐⭐

#### 任务3.1: V4.0移动止盈实施

**详见**: [移动止盈优化方案V4.0.md](./移动止盈优化方案V4.0.md)

**文件**: `app/services/trailing_stop_v4.py` (新建)

**核心改进**:
- 启动门槛: 40U → 20U
- 保护方式: 固定步进 → 分段保护50-80%
- 缓冲空间: 1.6U → 平均1,500U

**预期效果**: +2,100U/月

**时间估算**: 2天（包含测试）

**验收标准**:
- [ ] 浮盈20U时激活移动止盈
- [ ] 浮盈80U时保护60% = 48U
- [ ] 震荡市中利润回吐率 < 30%

---

### 第四阶段: 其他优化（1天）⭐⭐⭐

#### 任务4.1: 交易频率控制

**目标**: 200+ → 150笔

**实现方式**:
1. 评分阈值提升（已完成）
2. 增加开仓冷却: 同一币种5分钟内只开1次
3. 优先高质量信号排序

**文件**: `smart_trader_service.py` (修改)

```python
# 添加开仓冷却检查
self.last_open_time = {}  # {symbol: timestamp}

def can_open_position(self, symbol):
    """检查是否可以开仓"""
    last_time = self.last_open_time.get(symbol, 0)
    current_time = time.time()

    # 5分钟冷却
    if current_time - last_time < 300:
        return False, f"开仓冷却中({int((300-(current_time-last_time))/60)}分钟)"

    return True, None
```

**预期效果**: 日交易从220笔 → 150笔

**时间估算**: 2小时

---

#### 任务4.2: 信号优先级排序

**目标**: 优先处理高质量信号

**实现逻辑**:
```python
def prioritize_opportunities(self, opportunities):
    """
    信号优先级排序

    优先级:
    1. 突然拉升信号 (strength >= 50)
    2. 回调买入信号 (quality >= 60)
    3. 高分常规信号 (score >= 30)
    4. 其他信号
    """
    priority_scores = []

    for opp in opportunities:
        if opp['signal_type'] == 'sudden_move' and opp['strength'] >= 50:
            priority = 100
        elif opp['signal_type'] == 'pullback_entry' and opp['quality'] >= 60:
            priority = 90
        elif opp.get('score', 0) >= 30:
            priority = 80
        else:
            priority = opp.get('score', 0)

        priority_scores.append((priority, opp))

    # 按优先级排序
    priority_scores.sort(key=lambda x: x[0], reverse=True)

    return [opp for _, opp in priority_scores]
```

**预期效果**: 优先开仓高质量信号

**时间估算**: 1小时

---

## 📊 整体效果预估

### 优化前（2月6-7日平均）
```
日交易: 220笔
胜率: 34.66%
日盈亏: -2,703U
月度预期: -81,090U ❌
```

### 优化后（保守估计）

| 阶段 | 优化项 | 月度改善 |
|-----|-------|---------|
| **第一阶段** | 动态反转止损 | +800U |
| | 评分阈值调整 | +300U |
| | 持仓时间缩短 | +200U |
| | **小计** | **+1,300U** |
| **第二阶段** | 突然拉升检测器 | +1,500U |
| | 回调买入检测器 | +1,200U |
| | 评分权重调整 | +600U |
| | Big4否决权 | +700U |
| | **小计** | **+4,000U** |
| **第三阶段** | V4.0移动止盈 | +2,100U |
| **第四阶段** | 交易频率控制 | +400U |
| | **总计** | **+7,800U** |

```
优化后预期:
日交易: 150笔
胜率: 42-45%
日盈亏: +50 ~ +200U
月度盈利: +1,500 ~ +6,000U ✅
```

**注意**: 以上估算基于正常市场，2月6-7日是极端震荡行情

---

## 📅 时间计划

### Week 1: 快速修复 + 核心功能

**Day 1**: 第一阶段（快速修复）
- 上午: 动态反转止损 (2h)
- 下午: 评分阈值 + 持仓时间 (1h)
- 晚上: 测试验证 (2h)

**Day 2-3**: 第二阶段开始
- Day 2: 突然拉升检测器 (4h) + 测试 (2h)
- Day 3: 回调买入检测器 (4h) + 测试 (2h)

**Day 4**: 第二阶段完成
- 上午: 评分权重调整 (1h)
- 上午: Big4否决权 (30min)
- 下午: 集成测试 (3h)
- 晚上: 小规模实盘验证

**Day 5-6**: 第三阶段
- Day 5: V4.0移动止盈实现 (6h)
- Day 6: V4.0测试验证 (4h)

**Day 7**: 第四阶段 + 全量上线
- 上午: 交易频率控制 (2h)
- 下午: 信号优先级排序 (1h)
- 晚上: 全量上线监控

---

## ✅ 验收标准

### 功能验收

- [ ] 动态反转止损: 检测到反转时-1%止损
- [ ] 突然拉升检测: 5分钟拉升1%+放量1.5x触发
- [ ] 回调买入检测: 回调2%后反弹触发
- [ ] Big4否决权: 强度12+相反方向拒绝
- [ ] V4.0移动止盈: 20U激活，分段保护

### 性能验收

- [ ] 日交易次数: 150笔左右（±20笔）
- [ ] 平均持仓时间: 2-3小时
- [ ] 胜率: >= 40%
- [ ] 日盈亏: >= 0U（不亏损为基准）

### 数据验收

**回测验证** (2月5-7日数据):
- [ ] 2月5日: 保持盈利
- [ ] 2月6日: 亏损减少50%+
- [ ] 2月7日: 亏损减少50%+

**实盘验证** (小规模1天):
- [ ] 5个优质交易对
- [ ] 单仓200U（降低风险）
- [ ] 观察新功能触发情况

---

## 🚨 风险预案

### 风险1: 突然拉升检测误判

**场景**: 价格虚假突破，拉升后立即回落

**预案**:
- 动态反转止损会在-1%止损
- 限制单日最多触发30次
- 如果胜率<35%，暂停该功能

### 风险2: 回调买入抄底失败

**场景**: 判断为回调，实际是趋势反转

**预案**:
- 要求Big4不强烈相反
- 价格位置30-70%限制
- 反转止损保护

### 风险3: 新功能Bug

**场景**: 代码逻辑错误导致误操作

**预案**:
- 充分单元测试
- 小规模实盘验证
- 详细日志记录
- 每日检查异常日志

---

## 📝 实施检查清单

### 开发前检查
- [ ] 备份当前代码
- [ ] 创建新分支 `feature/super-brain-optimization`
- [ ] 准备测试数据

### 每个任务后检查
- [ ] 单元测试通过
- [ ] 代码Review
- [ ] 日志记录完整
- [ ] 更新文档

### 上线前检查
- [ ] 所有验收标准通过
- [ ] 回测结果符合预期
- [ ] 小规模实盘验证通过
- [ ] 监控告警配置完成

### 上线后监控
- [ ] 每日检查日志
- [ ] 每日统计新功能触发次数
- [ ] 每日检查盈亏情况
- [ ] 每周Review优化效果

---

## 📞 联系与反馈

**文档维护**: 系统开发团队
**最后更新**: 2026-02-08
**版本**: V1.0

**问题反馈**:
- 技术问题: 查看日志文件
- 效果评估: 查看数据库统计
- 优化建议: 更新本文档

---

**状态**: ✅ 文档完成，等待开始实施
**下一步**: 选择优先级最高的任务开始实现
