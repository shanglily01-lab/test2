# V3é›†æˆæ–¹æ¡ˆ - ç®€åŒ–ç‰ˆ (ä¸æ–°å¢æ–‡ä»¶)

## æ ¸å¿ƒåŸåˆ™
ä¸åˆ›å»ºæ–°æ–‡ä»¶ï¼Œç›´æ¥åœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ V3é€»è¾‘

## é›†æˆæ­¥éª¤

### æ­¥éª¤1: åœ¨ smart_trader_service.py å¤´éƒ¨æ·»åŠ V3å¯¼å…¥

```python
# åœ¨ç¬¬26è¡Œåæ·»åŠ 
from app.services.smart_entry_executor_v3 import SmartEntryExecutorV3
from app.services.position_manager_v3 import PositionManagerV3
from app.strategies.signal_scorer_v3 import SignalScorerV3
```

### æ­¥éª¤2: åœ¨ SmartDecisionBrain.__init__() ä¸­æ·»åŠ V3å¼€å…³

```python
# åœ¨ç¬¬58è¡Œåæ·»åŠ 
self.use_v3_mode = os.getenv('USE_V3_MODE', 'true').lower() == 'true'  # V3æ¨¡å¼å¼€å…³

if self.use_v3_mode:
    logger.info("ğŸš€ V3æ¨¡å¼å·²å¯ç”¨")
    # åˆå§‹åŒ–V3æ¨¡å—
    self.scorer_v3 = SignalScorerV3(db_config)
else:
    logger.info("ğŸ“Š ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼")
    self.scorer_v3 = None
```

### æ­¥éª¤3: åœ¨ SmartTraderService.__init__() ä¸­åˆå§‹åŒ–V3æ‰§è¡Œå™¨

```python
# åœ¨åˆå§‹åŒ– SmartEntryExecutor åæ·»åŠ 
if hasattr(self.brain, 'use_v3_mode') and self.brain.use_v3_mode:
    self.entry_executor_v3 = SmartEntryExecutorV3(self.db_config)
    self.position_manager_v3 = PositionManagerV3(self.db_config)
    logger.info("âœ… V3æ‰§è¡Œå™¨åˆå§‹åŒ–å®Œæˆ")
```

### æ­¥éª¤4: åœ¨ä¿¡å·è¯„åˆ†å‡½æ•°ä¸­æ·»åŠ V3é€»è¾‘

æ‰¾åˆ°è¯„åˆ†å‡½æ•° (å¤§çº¦åœ¨ç¬¬800-1200è¡Œ)ï¼Œåœ¨è¯„åˆ†é€»è¾‘ä¸­æ·»åŠ :

```python
def evaluate_symbol(self, symbol: str):
    """è¯„ä¼°äº¤æ˜“å¯¹ä¿¡å·"""

    # ... ç°æœ‰ä»£ç è·å–Kçº¿æ•°æ® ...

    # ğŸš€ V3æ¨¡å¼: ä½¿ç”¨å¤šæ—¶é—´å‘¨æœŸè¯„åˆ†
    if hasattr(self.brain, 'use_v3_mode') and self.brain.use_v3_mode:
        # è·å–5Hå’Œ15M Kçº¿
        klines_5h = self._get_klines(symbol, '5h', 3)
        klines_15m = self._get_klines(symbol, '15m', 20)

        # è®¡ç®—V3è¯„åˆ†
        score_result = self.brain.scorer_v3.calculate_total_score(
            symbol=symbol,
            position_side=side,
            klines_5h=klines_5h,
            klines_15m=klines_15m,
            big4_signal=big4_signal,
            big4_strength=big4_strength
        )

        if not score_result['can_trade']:
            logger.info(f"âŒ V3è¯„åˆ†ä¸è¾¾æ ‡: {score_result['total_score']:.1f}/{score_result['max_score']}")
            return

        # ä½¿ç”¨V3å…¥åœºæ‰§è¡Œå™¨
        await self._execute_v3_entry(symbol, side, score_result)
        return

    # ğŸ“Š ä¼ ç»Ÿæ¨¡å¼: ä½¿ç”¨åŸæœ‰é€»è¾‘
    # ... ç°æœ‰è¯„åˆ†ä»£ç  ...
```

### æ­¥éª¤5: æ·»åŠ V3å…¥åœºæ‰§è¡Œå‡½æ•°

åœ¨ SmartTraderService ç±»ä¸­æ·»åŠ æ–°æ–¹æ³•:

```python
async def _execute_v3_entry(self, symbol: str, side: str, score_result: dict):
    """æ‰§è¡ŒV3å…¥åœº (5Mç²¾å‡†ç­‰å¾…)"""
    logger.info(f"ğŸš€ V3å…¥åœº: {symbol} {side}, è¯„åˆ†:{score_result['total_score']:.1f}")

    # è·å–ä¿è¯é‡‘
    margin = await self._get_margin_for_symbol(symbol)

    # æ‰§è¡Œ5Mç²¾å‡†å…¥åœº
    entry_result = await self.entry_executor_v3.execute_entry(
        signal={'signal_type': 'V3_SIGNAL', 'score': score_result['total_score']},
        symbol=symbol,
        position_side=side,
        total_margin=margin,
        leverage=10
    )

    if not entry_result:
        logger.warning(f"âŒ V3å…¥åœºå¤±è´¥: {symbol}")
        return

    # ä¿å­˜æŒä»“
    position = await self._save_position(entry_result, score_result)

    # å¯åŠ¨V3æŒä»“ç®¡ç† (ç§»åŠ¨æ­¢ç›ˆ)
    asyncio.create_task(self.position_manager_v3.manage_position(position))

    logger.info(f"âœ… V3å…¥åœºå®Œæˆ: {symbol}, æŒä»“ID:{position['id']}")
```

### æ­¥éª¤6: æ·»åŠ ç¯å¢ƒå˜é‡å¼€å…³

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ :

```
USE_V3_MODE=true
```

## å›é€€æ–¹æ¡ˆ

å¦‚æœV3å‡ºç°é—®é¢˜ï¼Œç«‹å³å›é€€:

1. ä¿®æ”¹ `.env`: `USE_V3_MODE=false`
2. é‡å¯æœåŠ¡
3. ç³»ç»Ÿè‡ªåŠ¨åˆ‡æ¢å›ä¼ ç»Ÿæ¨¡å¼

## ä¼˜åŠ¿

1. âœ… ä¸åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæ˜“äºç»´æŠ¤
2. âœ… å¯ä»¥éšæ—¶å¼€å…³V3æ¨¡å¼
3. âœ… V3å’Œä¼ ç»Ÿæ¨¡å¼å…±å­˜
4. âœ… å‡ºé—®é¢˜ç«‹å³å›é€€
5. âœ… é€æ­¥ç°åº¦æµ‹è¯•

## æµ‹è¯•æµç¨‹

### ç¬¬ä¸€å¤©: å°è§„æ¨¡æµ‹è¯•
- USE_V3_MODE=true
- åªæµ‹è¯•5ä¸ªäº¤æ˜“å¯¹
- è§‚å¯Ÿå…¥åœºä»·æ ¼å’Œæ­¢ç›ˆæ•ˆæœ

### ç¬¬äºŒå¤©: æ‰©å¤§æµ‹è¯•
- å¢åŠ åˆ°20ä¸ªäº¤æ˜“å¯¹
- å¯¹æ¯”V3å’Œä¼ ç»Ÿæ¨¡å¼æ•°æ®
- è°ƒæ•´å‚æ•°

### ç¬¬ä¸‰å¤©: å…¨é¢ä¸Šçº¿
- å¦‚æœèƒœç‡æå‡5%+ â†’ å…¨é¢å¯ç”¨V3
- å¦‚æœèƒœç‡ä¸‹é™ â†’ å›é€€ä¼ ç»Ÿæ¨¡å¼

## å…³é”®ä¿®æ”¹ç‚¹æ€»ç»“

| ä½ç½® | ä¿®æ”¹å†…å®¹ | è¡Œæ•°ä¼°è®¡ |
|------|---------|---------|
| æ–‡ä»¶å¤´éƒ¨ | æ·»åŠ V3æ¨¡å—å¯¼å…¥ | 3è¡Œ |
| SmartDecisionBrain.__init__ | æ·»åŠ V3å¼€å…³ | 5è¡Œ |
| SmartTraderService.__init__ | åˆå§‹åŒ–V3æ‰§è¡Œå™¨ | 5è¡Œ |
| evaluate_symbolå‡½æ•° | æ·»åŠ V3è¯„åˆ†é€»è¾‘ | 20è¡Œ |
| SmartTraderServiceç±» | æ·»åŠ _execute_v3_entryæ–¹æ³• | 30è¡Œ |
| **æ€»è®¡** | **63è¡Œä»£ç ** | |

## ä¸‹ä¸€æ­¥

1. æŒ‰ç…§ä¸Šè¿°æ­¥éª¤ä¿®æ”¹ `smart_trader_service.py`
2. æ·»åŠ  `.env` ç¯å¢ƒå˜é‡
3. é‡å¯æœåŠ¡æµ‹è¯•
4. è§‚å¯Ÿæ—¥å¿—å’Œæ•°æ®

---

**æ ¸å¿ƒæ€æƒ³**: æœ€å°åŒ–ä¿®æ”¹ï¼Œæœ€å¤§åŒ–çµæ´»æ€§ï¼Œéšæ—¶å¯å›é€€
