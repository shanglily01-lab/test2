# 超级大脑 - 合约交易方案

> **最后更新**: 2026-01-29
> **系统版本**: V2.0 - 自我优化系统
> **核心特性**: Big4趋势检测 + 智能分批建仓 + 自动优化 + 多层风控

---

## 📋 目录

1. [系统概述](#系统概述)
2. [核心架构](#核心架构)
3. [交易流程](#交易流程)
4. [信号系统](#信号系统)
5. [风险控制](#风险控制)
6. [自动优化](#自动优化)
7. [性能指标](#性能指标)
8. [运维管理](#运维管理)

---

## 系统概述

### 定位

**超级大脑合约交易系统** 是一个具备自我学习能力的智能化期货合约交易平台，通过多层信号评分、Big4市场趋势检测、智能分批建仓和自动优化机制，实现稳定盈利。

### 核心特点

- 🧠 **自我优化**: 每4小时自动分析交易表现，优化信号质量
- 📊 **Big4趋势检测**: 基于BTC/ETH/BNB/SOL判断市场方向，避免逆势开仓
- 🎯 **智能分批建仓**: 3批次入场(30%-30%-40%)，60分钟内优化成本
- 🛡️ **多层风控**: 信号黑名单 + 币种分级 + 动态止损
- ⚡ **实时监控**: WebSocket价格推送 + 15分钟K线强度检测

### 适用场景

- ✅ 24小时自动化交易
- ✅ 中短线趋势捕捉(1-8小时持仓)
- ✅ 合约5x杠杆交易
- ✅ 监控100+主流交易对

---

## 核心架构

### 系统组件

```
┌─────────────────────────────────────────────────────────────┐
│                    超级大脑合约交易系统                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 数据采集服务  │  │ 价格推送服务  │  │ 信号生成器   │     │
│  │ Fast         │→ │ WebSocket    │→ │ Signal       │     │
│  │ Collector    │  │ Price Cache  │  │ Generator    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│         ↓                                    ↓              │
│  ┌──────────────┐                    ┌──────────────┐     │
│  │ Big4趋势检测 │                    │ 信号评分系统  │     │
│  │ Trend        │→───────────────→  │ Scoring      │     │
│  │ Detector     │                    │ System       │     │
│  └──────────────┘                    └──────────────┘     │
│                                             ↓              │
│                                      ┌──────────────┐     │
│                                      │ 智能交易服务  │     │
│                                      │ Smart Trader │     │
│                                      │ Service      │     │
│                                      └──────────────┘     │
│                                             ↓              │
│         ┌───────────────────────────────────────┐         │
│         │          仓位管理与监控                 │         │
│         │  • 智能建仓 (SmartEntryExecutor)      │         │
│         │  • 智能平仓 (SmartExitOptimizer)      │         │
│         │  • 风险控制 (RiskManager)            │         │
│         └───────────────────────────────────────┘         │
│                          ↓                                 │
│         ┌───────────────────────────────────────┐         │
│         │         自动优化系统                    │         │
│         │  • 24H信号分析 (analyze_24h_signals)  │         │
│         │  • 优化执行 (execute_optimization)    │         │
│         │  • 参数更新 (adaptive_params)         │         │
│         └───────────────────────────────────────┘         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈

- **语言**: Python 3.9+
- **框架**: FastAPI (异步Web框架)
- **数据库**: MySQL 8.0
- **交易所**: Binance Futures API
- **实时通讯**: WebSocket
- **调度**: schedule库 (定时任务)

---

## 交易流程

### 完整交易生命周期

```
1. 信号产生阶段
   ├─ 技术指标计算 (RSI, MACD, EMA, Bollinger等)
   ├─ K线强度评分 (方向性、成交量、形态)
   ├─ Big4趋势判断 (整体市场方向)
   └─ 信号组合评分 (综合得分 -100 ~ +100)

2. 信号过滤阶段
   ├─ 评分阈值检查 (≥35分才考虑)
   ├─ 信号黑名单检查 (历史表现差的信号类型)
   ├─ 币种分级检查 (Level 0-4, Level 4禁止)
   ├─ Big4趋势过滤 (市场看空时降低LONG评分)
   └─ 仓位数量限制 (避免过度分散)

3. 智能建仓阶段 (60分钟窗口)
   ├─ Batch 1: 30% 仓位 (第0-20分钟最优价格)
   ├─ Batch 2: 30% 仓位 (第20-40分钟最优价格)
   └─ Batch 3: 40% 仓位 (第40-60分钟最优价格)

4. 持仓监控阶段
   ├─ 实时价格监控 (WebSocket推送)
   ├─ 止盈止损检查 (TP: 6%, SL: 2%)
   ├─ K线强度检查 (每15分钟)
   ├─ 移动止盈检查 (盈利>3%时启动)
   └─ 超时检查 (基于评分动态调整, 4-8小时)

5. 智能平仓阶段
   ├─ 触发条件:
   │  • 止盈达标 (6%)
   │  • 止损触发 (2%)
   │  • K线强度下降 (15分钟内趋势反转)
   │  • 移动止盈回撤
   │  • 超时强制平仓
   │
   ├─ 分批平仓策略:
   │  • 盈利1-3%: 平50%
   │  • 盈利3-5%: 平70%
   │  • 盈利>5%: 启动移动止盈
   │
   └─ 记录平仓原因和盈亏

6. 数据分析阶段 (每4小时)
   ├─ 统计24H内所有已平仓交易
   ├─ 按信号类型分组分析
   ├─ 计算胜率、盈亏、平均评分
   └─ 生成优化建议

7. 自动优化阶段
   ├─ 禁用表现差的信号 (胜率<30%)
   ├─ 提高低质量信号阈值
   ├─ 调整币种分级
   └─ 更新数据库配置
```

### Big4趋势检测逻辑

**目的**: 判断整体市场方向，避免逆势开仓

**监控对象**:
- BTC/USDT (权重最高)
- ETH/USDT
- BNB/USDT
- SOL/USDT

**检测方法**:
1. **盘整期识别**: 6小时窗口内价格波动<0.5%
2. **方向性K线统计**: 统计看多/看空蜡烛数量
3. **成交量确认**: 成交量放大1.5x以上
4. **突破点检测**: 5m/15m级别强势K线

**信号输出**:
- `BULLISH`: ≥3个币种看多 → 整体市场看多
- `BEARISH`: ≥3个币种看空 → 整体市场看空
- `NEUTRAL`: 其他情况

**应用到交易**:
```python
# 对四大天王本身: 使用该币种专属信号
if symbol in ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT']:
    use_symbol_specific_signal()

# 对其他所有币种: 使用Big4整体市场信号
else:
    market_signal = big4_result['overall_signal']

    # 市场看空 + LONG信号 → 降低评分或跳过
    if market_signal == 'BEARISH' and side == 'LONG':
        if signal_strength >= 60:
            skip_this_signal()  # 强烈看空,直接跳过
        else:
            reduce_score(penalty = signal_strength * 0.5)

    # 市场看多 + SHORT信号 → 降低评分或跳过
    elif market_signal == 'BULLISH' and side == 'SHORT':
        if signal_strength >= 60:
            skip_this_signal()
        else:
            reduce_score(penalty = signal_strength * 0.5)

    # 顺势信号 → 提升评分
    elif (market_signal == 'BEARISH' and side == 'SHORT') or \
         (market_signal == 'BULLISH' and side == 'LONG'):
        bonus = min(20, signal_strength * 0.3)
        increase_score(bonus)
```

**仓位倍数应用**:
```python
# 根据Big4市场信号决定仓位倍数
if market_signal == 'BULLISH' and side == 'LONG':
    position_multiplier = 1.2  # 市场看多,做多加仓
elif market_signal == 'BEARISH' and side == 'SHORT':
    position_multiplier = 1.2  # 市场看空,做空加仓
else:
    position_multiplier = 1.0  # 其他情况正常仓位
```

---

## 信号系统

### 信号组成

**权重分配**:
- 技术分析: 60%
- 新闻情绪: 30%
- 社交媒体: 10%

**技术指标**:
```python
indicators = {
    'RSI': {
        'period': 14,
        'oversold': 30,    # 超卖阈值
        'overbought': 70   # 超买阈值
    },
    'MACD': {
        'fast': 12,
        'slow': 26,
        'signal': 9
    },
    'EMA': {
        'short': 12,
        'long': 26
    },
    'Bollinger Bands': {
        'period': 20,
        'std': 2
    }
}
```

**K线强度评分** (满分40分):
- 方向性力量 (15分): 连续阳线/阴线强度
- 成交量确认 (10分): 成交量相对均值
- 形态识别 (10分): 看涨/看跌形态
- 趋势对齐 (5分): 与更大周期趋势一致性

### 信号评分

**评分范围**: -100 ~ +100

**评分计算**:
```python
final_score = (
    technical_score * 0.6 +
    news_score * 0.3 +
    social_score * 0.1
)
```

**信号强度等级**:
- `STRONG_LONG`: ≥75分 (强烈看多)
- `LONG`: ≥60分 (看多)
- `NEUTRAL`: -59 ~ 59分 (中性)
- `SHORT`: ≤-60分 (看空)
- `STRONG_SHORT`: ≤-75分 (强烈看空)

**开仓阈值**:
- 默认: 35分
- 可通过 `signal_threshold_overrides` 表动态调整

### 信号黑名单

**黑名单类型**:

1. **信号类型黑名单** (`signal_blacklist`)
   - 格式: `"signal_component1 + signal_component2_LONG"`
   - 示例: `"position_low + volume_power_bull_LONG"`
   - 条件: 24H胜率<30% 且交易≥3笔

2. **币种黑名单** (`trading_blacklist`)
   - 直接禁止交易
   - 条件: 总亏损>20 USDT 且胜率<10%

3. **币种分级系统** (`trading_symbol_rating`)
   ```
   Level 0: 正常     - 100% 仓位, 0 评分惩罚
   Level 1: 警告     - 75% 仓位,  -5 评分惩罚
   Level 2: 谨慎     - 50% 仓位,  -10 评分惩罚
   Level 3: 严重     - 25% 仓位,  -15 评分惩罚
   Level 4: 黑名单   - 禁止交易
   ```

**白名单保护**:
四大天王永不进入黑名单:
- BTC/USDT
- ETH/USDT
- BNB/USDT
- SOL/USDT

---

## 风险控制

### 仓位管理

**单仓位配置**:
```yaml
margin: 400 USDT          # 保证金
leverage: 5x              # 杠杆倍数
notional_value: 2000 USDT # 名义价值
stop_loss: 2%             # 止损比例 (-40 USDT)
take_profit: 6%           # 止盈比例 (+120 USDT)
```

**动态仓位调整**:
```python
# 基于币种分级
if rating_level == 1:
    margin = 400 * 0.75 = 300 USDT
elif rating_level == 2:
    margin = 400 * 0.50 = 200 USDT
elif rating_level == 3:
    margin = 400 * 0.25 = 100 USDT

# 基于Big4市场信号
if 市场看多 and 做多:
    margin = margin * 1.2  # 顺势加仓
elif 市场看空 and 做空:
    margin = margin * 1.2
```

**最大并发仓位**: 根据资金量动态调整

### 止损策略

**硬止损** (2%):
- 触发条件: 未实现亏损≥2%
- 执行: 立即市价平仓
- 优先级: 最高

**动态止损** (基于K线强度):
```python
def check_kline_strength_degradation():
    """每15分钟检查一次K线强度"""
    if 连续3根阴线 and 成交量萎缩:
        close_position(reason='kline_strength_degradation')

    if RSI从超买回落 and MACD死叉:
        close_position(reason='technical_reversal')
```

**超时止损** (动态):
```python
def get_timeout_minutes(entry_score):
    """基于开仓评分动态计算超时时间"""
    if entry_score >= 50:
        return 480  # 8小时 (高质量信号)
    elif entry_score >= 40:
        return 360  # 6小时
    elif entry_score >= 35:
        return 300  # 5小时
    else:
        return 240  # 4小时 (低质量信号)
```

### 止盈策略

**固定止盈** (6%):
- 触发条件: 未实现盈利≥6%
- 执行: 立即市价平仓

**分批止盈**:
```python
if profit_pct >= 1% and profit_pct < 3%:
    close_partial(50%)  # 锁定50%利润
elif profit_pct >= 3% and profit_pct < 5%:
    close_partial(70%)  # 锁定70%利润
elif profit_pct >= 5%:
    activate_trailing_stop()  # 启动移动止盈
```

**移动止盈**:
- 启动条件: 盈利≥3%
- 回撤阈值: 从最高点回撤1%触发平仓
- 目的: 让利润奔跑，同时保护已有收益

### 风险监控

**实时监控**:
- WebSocket价格推送 (延迟<100ms)
- 每15分钟K线强度检查
- 每分钟止盈止损检查

**风险指标**:
```python
risk_metrics = {
    'total_margin_used': sum(position.margin),       # 总保证金占用
    'total_notional': sum(position.notional_value),  # 总名义价值
    'unrealized_pnl': sum(position.unrealized_pnl),  # 未实现盈亏
    'margin_ratio': total_margin / account_balance,  # 保证金占比
    'max_drawdown': calculate_max_drawdown()         # 最大回撤
}
```

---

## 自动优化

### 优化周期

**执行频率**: 每4小时一次 (00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)

**分析窗口**: 最近24小时

### 优化流程

```
1. 24H信号分析 (analyze_24h_signals.py)
   ├─ 查询所有已平仓位 (created_at >= 24H前)
   ├─ 按 signal_type + position_side 分组
   ├─ 计算指标:
   │  • total_trades: 总交易数
   │  • win_rate: 胜率 (盈利交易/总交易)
   │  • total_pnl: 总盈亏
   │  • avg_score: 平均入场评分
   │
   └─ 生成优化建议 → optimization_actions.json

2. 优化决策
   ├─ 胜率<30% AND 交易≥3笔 → BLACKLIST_SIGNAL
   ├─ 胜率<40% AND 交易≥3笔 → RAISE_THRESHOLD
   └─ 胜率≥40% → 观察，暂不调整

3. 执行优化 (execute_brain_optimization.py)
   ├─ 读取 optimization_actions.json
   ├─ 插入/更新数据库:
   │  • signal_blacklist (禁用信号)
   │  • signal_threshold_overrides (提高阈值)
   │
   └─ 输出优化报告

4. 配置生效
   ├─ SmartTrader 下一轮循环自动加载新配置
   └─ 无需重启服务
```

### 优化示例

**场景**: 某信号类型表现不佳

```json
{
  "timestamp": "2026-01-29T06:00:00Z",
  "analysis_period": "24h",
  "actions": [
    {
      "action": "BLACKLIST_SIGNAL",
      "signal_type": "position_low + volume_power_bull",
      "side": "LONG",
      "reason": "24H胜率25.0%,亏损$-156.32"
    },
    {
      "action": "RAISE_THRESHOLD",
      "signal_type": "macd_cross + rsi_oversold",
      "side": "LONG",
      "current_avg_score": 32.5,
      "reason": "24H胜率35.0%,亏损$-45.20"
    }
  ]
}
```

**执行结果**:
```sql
-- 禁用信号
INSERT INTO signal_blacklist
  (signal_type, position_side, reason, is_active)
VALUES
  ('position_low + volume_power_bull', 'LONG', '24H胜率25.0%,亏损$-156.32', TRUE);

-- 提高阈值
INSERT INTO signal_threshold_overrides
  (signal_type, position_side, min_score, reason, is_active)
VALUES
  ('macd_cross + rsi_oversold', 'LONG', 43, '24H胜率35.0%,亏损$-45.20', TRUE);
  -- 原平均分32.5 + 10 = 42.5, 向上取整到43
```

### 优化效果追踪

**关键指标**:
```python
optimization_metrics = {
    'blacklisted_signals': count(signal_blacklist.is_active=TRUE),
    'threshold_overrides': count(signal_threshold_overrides.is_active=TRUE),
    'avg_win_rate_improvement': compare_before_after(),
    'total_loss_reduction': calculate_saved_losses(),
    'signal_quality_score': aggregate_signal_performance()
}
```

**回滚机制**:
```sql
-- 如果某个优化效果不佳，可以禁用
UPDATE signal_blacklist
SET is_active = FALSE
WHERE signal_type = 'xxx' AND position_side = 'LONG';
```

---

## 性能指标

### 关键绩效指标 (KPI)

**盈利指标**:
- **总盈亏** (Total P&L): 所有已平仓位盈亏总和
- **胜率** (Win Rate): 盈利交易数 / 总交易数
- **盈亏比** (Profit/Loss Ratio): 平均盈利 / 平均亏损
- **利润因子** (Profit Factor): 总盈利 / 总亏损

**风险指标**:
- **最大回撤** (Max Drawdown): 资金峰值到谷底的最大跌幅
- **夏普比率** (Sharpe Ratio): 超额收益 / 收益波动率
- **索提诺比率** (Sortino Ratio): 超额收益 / 下行波动率
- **卡玛比率** (Calmar Ratio): 年化收益 / 最大回撤

**交易指标**:
- **日均交易数**: 每日平均交易笔数
- **平均持仓时间**: 所有已平仓位的平均持仓时长
- **平均入场评分**: 所有交易的平均入场信号评分

### 目标值

```yaml
target_metrics:
  win_rate: ">= 55%"           # 胜率目标
  profit_loss_ratio: ">= 2.0"  # 盈亏比目标
  profit_factor: ">= 1.5"      # 利润因子目标
  max_drawdown: "<= 15%"       # 最大回撤限制
  sharpe_ratio: ">= 1.5"       # 夏普比率目标
```

### 监控看板

**实时数据**:
- 当前持仓数量
- 总未实现盈亏
- 今日已平仓盈亏
- 保证金占用率

**24小时统计**:
- 总交易数 / 盈利 / 亏损
- 胜率 / 盈亏比
- 最佳交易 / 最差交易
- 信号质量分布

**历史趋势**:
- 7日盈亏曲线
- 30日胜率趋势
- 优化历史记录

---

## 运维管理

### 启动服务

**方式1: 直接运行**
```bash
python app/main.py
```

**方式2: 后台运行**
```bash
nohup python app/main.py > logs/smart_trader.log 2>&1 &
```

**方式3: systemd服务** (推荐)
```bash
sudo systemctl start smart-trader
sudo systemctl enable smart-trader  # 开机自启
```

### 日志监控

**日志级别**:
- `INFO`: 正常交易流程
- `WARNING`: 异常但可继续
- `ERROR`: 错误需要关注
- `CRITICAL`: 严重错误需立即处理

**关键日志标签**:
```
[BIG4-MARKET]  - Big4市场趋势判断
[BIG4-SKIP]    - Big4过滤跳过的信号
[BIG4-ADJUST]  - Big4调整后的评分
[BIG4-POSITION] - Big4仓位倍数调整
[BLACKLIST]    - 信号黑名单过滤
[ENTRY]        - 开仓执行
[EXIT]         - 平仓执行
[OPTIMIZATION] - 自动优化执行
```

**日志查看**:
```bash
# 实时查看
tail -f logs/smart_trader.log

# 查看Big4相关日志
grep "BIG4" logs/smart_trader.log

# 查看优化日志
grep "OPTIMIZATION" logs/smart_trader.log

# 查看错误日志
grep "ERROR" logs/smart_trader.log
```

### 数据库维护

**定期清理**:
```sql
-- 清理90天前的已平仓位
DELETE FROM futures_positions
WHERE status = 'closed'
  AND close_time < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 归档历史数据
INSERT INTO futures_positions_archive
SELECT * FROM futures_positions
WHERE status = 'closed'
  AND close_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

**索引优化**:
```sql
-- 确保关键字段有索引
CREATE INDEX idx_status ON futures_positions(status);
CREATE INDEX idx_created_at ON futures_positions(created_at);
CREATE INDEX idx_symbol ON futures_positions(symbol);
CREATE INDEX idx_signal_type ON signal_blacklist(signal_type, position_side);
```

### 备份策略

**数据库备份** (每日)
```bash
#!/bin/bash
mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASSWORD binance-data \
  > backup/db_$(date +%Y%m%d).sql

# 保留最近30天备份
find backup/ -name "db_*.sql" -mtime +30 -delete
```

**配置备份**:
```bash
# 备份关键配置文件
tar -czf backup/config_$(date +%Y%m%d).tar.gz \
  config.yaml .env
```

### 异常处理

**常见问题**:

1. **WebSocket断线**
   - 自动重连机制 (最多3次重试)
   - 降级使用REST API获取价格

2. **数据库连接失败**
   - 连接池自动重试
   - 记录错误日志，发送告警

3. **API限流**
   - 自动限速 (1200 req/min)
   - 优先级队列管理请求

4. **仓位数据不一致**
   - 定期同步交易所实际仓位
   - 对账机制确保一致性

**告警通知**:
```python
alerts = {
    'high_priority': [
        '数据库连接失败',
        '交易所API错误',
        '单日亏损超过阈值',
        '保证金不足'
    ],
    'medium_priority': [
        'WebSocket断线',
        '价格数据延迟',
        '优化执行失败'
    ]
}
```

### 性能优化

**连接池配置**:
```python
database_pool = {
    'pool_size': 10,           # 连接池大小
    'max_overflow': 20,        # 最大溢出连接
    'pool_timeout': 30,        # 获取连接超时
    'pool_recycle': 3600       # 连接回收时间
}
```

**缓存策略**:
```python
cache_config = {
    'price_cache_ttl': 1,           # 价格缓存1秒
    'config_cache_ttl': 300,        # 配置缓存5分钟
    'blacklist_cache_ttl': 300      # 黑名单缓存5分钟
}
```

---

## 附录

### 数据库表结构

#### futures_positions (合约仓位表)

```sql
CREATE TABLE futures_positions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    account_id VARCHAR(50),
    user_id VARCHAR(50),
    symbol VARCHAR(20) NOT NULL,
    position_side ENUM('LONG', 'SHORT') NOT NULL,
    leverage DECIMAL(5,2) DEFAULT 5.00,
    quantity DECIMAL(20,8),
    notional_value DECIMAL(20,2),
    margin DECIMAL(20,2),

    -- 价格相关
    entry_price DECIMAL(20,8),
    mark_price DECIMAL(20,8),
    avg_entry_price DECIMAL(20,8),
    close_price DECIMAL(20,8),
    liquidation_price DECIMAL(20,8),
    stop_loss_price DECIMAL(20,8),
    take_profit_price DECIMAL(20,8),

    -- 盈亏相关
    unrealized_pnl DECIMAL(20,2),
    unrealized_pnl_pct DECIMAL(10,4),
    realized_pnl DECIMAL(20,2),
    max_profit_pct DECIMAL(10,4),
    max_profit_price DECIMAL(20,8),
    max_profit_time DATETIME,

    -- 移动止盈
    trailing_stop_activated BOOLEAN DEFAULT FALSE,
    trailing_stop_price DECIMAL(20,8),

    -- 信号相关
    entry_signal_type VARCHAR(50),
    entry_score INT,
    signal_components JSON,

    -- 分批建仓
    batch_plan JSON,
    batch_filled INT DEFAULT 0,

    -- 生命周期
    open_time DATETIME,
    close_time DATETIME,
    last_update_time DATETIME,
    status ENUM('open', 'closed', 'liquidated') DEFAULT 'open',
    source VARCHAR(50) DEFAULT 'smart_trader',
    close_reason VARCHAR(100),

    -- 优化字段
    strategy_id VARCHAR(50),
    signal_id VARCHAR(100),
    entry_reason TEXT,
    max_hold_minutes INT,
    timeout_at DATETIME,
    planned_close_time DATETIME,
    close_extended BOOLEAN DEFAULT FALSE,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_symbol (symbol),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_entry_signal_type (entry_signal_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### signal_blacklist (信号黑名单表)

```sql
CREATE TABLE signal_blacklist (
    id INT AUTO_INCREMENT PRIMARY KEY,
    signal_type VARCHAR(500) NOT NULL,
    position_side ENUM('LONG', 'SHORT') NOT NULL,
    reason VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_signal (signal_type, position_side)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### signal_threshold_overrides (信号阈值覆盖表)

```sql
CREATE TABLE signal_threshold_overrides (
    id INT AUTO_INCREMENT PRIMARY KEY,
    signal_type VARCHAR(500) NOT NULL,
    position_side ENUM('LONG', 'SHORT') NOT NULL,
    min_score INT NOT NULL,
    reason VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_signal (signal_type, position_side)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### trading_symbol_rating (币种分级表)

```sql
CREATE TABLE trading_symbol_rating (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(20) UNIQUE NOT NULL,
    rating_level INT DEFAULT 0,  -- 0-4
    margin_multiplier DECIMAL(5,2) DEFAULT 1.00,
    score_bonus INT DEFAULT 0,
    hard_stop_loss_count INT DEFAULT 0,
    total_loss_amount DECIMAL(20,2) DEFAULT 0,
    total_profit_amount DECIMAL(20,2) DEFAULT 0,
    win_rate DECIMAL(5,2),
    total_trades INT DEFAULT 0,
    previous_level INT,
    level_changed_at DATETIME,
    level_change_reason VARCHAR(500),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 环境变量配置

`.env` 文件示例:

```bash
# 数据库配置
DB_HOST=13.212.252.171
DB_PORT=3306
DB_USER=admin
DB_PASSWORD=Tonny@1000
DB_NAME=binance-data

# 币安API配置
BINANCE_API_KEY=your_api_key
BINANCE_API_SECRET=your_api_secret

# 环境配置
ENVIRONMENT=production
LOG_LEVEL=INFO
```

### 常用命令

```bash
# 查看当前持仓
mysql -h $DB_HOST -u $DB_USER -p$DB_PASSWORD -D binance-data \
  -e "SELECT symbol, position_side, unrealized_pnl_pct, status FROM futures_positions WHERE status='open';"

# 查看24H盈亏
mysql -h $DB_HOST -u $DB_USER -p$DB_PASSWORD -D binance-data \
  -e "SELECT SUM(realized_pnl) as total_pnl FROM futures_positions WHERE close_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR);"

# 查看信号黑名单
mysql -h $DB_HOST -u $DB_USER -p$DB_PASSWORD -D binance-data \
  -e "SELECT signal_type, position_side, reason FROM signal_blacklist WHERE is_active=TRUE;"

# 手动运行24H分析
python analyze_24h_signals.py

# 手动执行优化
python execute_brain_optimization.py

# 查看服务状态
systemctl status smart-trader
```

---

## 总结

超级大脑合约交易系统通过以下核心机制实现稳定盈利:

1. ✅ **Big4趋势检测** - 避免逆势开仓，顺势加仓
2. ✅ **多层信号过滤** - 黑名单 + 阈值 + 分级系统
3. ✅ **智能分批建仓** - 60分钟优化成本
4. ✅ **动态风险控制** - 基于评分的止损止盈
5. ✅ **自动优化系统** - 每4小时自我学习改进
6. ✅ **实时监控告警** - WebSocket + 15分钟K线检查

系统将持续进化，通过自动优化机制不断提升交易质量和盈利能力。

---

**文档版本**: V2.0
**最后更新**: 2026-01-29
**维护者**: 超级大脑开发团队
