# 交易系统逻辑文档

## 目录
1. [系统概述](#系统概述)
2. [开仓逻辑](#开仓逻辑)
3. [平仓逻辑](#平仓逻辑)
4. [移动止损](#移动止损)
5. [移动止盈](#移动止盈)
6. [参数配置](#参数配置)
7. [流程图](#流程图)

---

## 系统概述

本系统是基于 EMA（指数移动平均线）的期货交易策略执行器，主要使用 **EMA9** 和 **EMA26** 的金叉/死叉信号进行交易决策。

核心特点：
- 使用 **已收盘的K线** 进行信号判断，避免未收盘K线波动导致误判
- 开仓需要信号强度检查（≥0.15%），平仓不检查信号强度
- 支持移动止损和移动止盈双重保护机制
- WebSocket 实时价格监控，毫秒级响应

---

## 开仓逻辑

### 1. 开仓信号类型

#### 1.1 金叉/死叉信号（主要信号）

```
金叉（做多信号）:
  条件: prev_EMA9 ≤ prev_EMA26 且 EMA9 > EMA26
  含义: EMA9 从下方穿过 EMA26

死叉（做空信号）:
  条件: prev_EMA9 ≥ prev_EMA26 且 EMA9 < EMA26
  含义: EMA9 从上方穿过 EMA26
```

**重要说明**：
- `prev_EMA9/26` = klines[-3] 的 EMA 值（倒数第三根K线，已收盘）
- `EMA9/26` = klines[-2] 的 EMA 值（倒数第二根K线，已收盘）
- **不使用** klines[-1]（当前未收盘K线），避免价格波动导致误判

#### 1.2 连续趋势信号

```
条件:
  1. 15M周期 EMA9 与 EMA26 差值 > 0.15%
  2. 5M周期连续3根K线 EMA 差值持续放大
  3. EMA + MA 方向一致
```

#### 1.3 反转开仓信号

当持仓因反转平仓后，自动开立反向仓位：
- SHORT 仓位因金叉平仓 → 自动开 LONG
- LONG 仓位因死叉平仓 → 自动开 SHORT

### 2. 开仓条件检查

```python
开仓必须满足的条件（按顺序检查）:

1. 信号强度检查
   ├── 计算: ema_diff_pct = |EMA9 - EMA26| / EMA26 * 100
   └── 要求: ema_diff_pct >= 0.15% (MIN_SIGNAL_STRENGTH)

2. EMA + MA 方向一致性检查
   ├── 做多: EMA9 > EMA26 且 价格 > MA10
   └── 做空: EMA9 < EMA26 且 价格 < MA10

3. 持仓检查
   └── 该策略下该交易对无已开仓位

4. 开单自检（position_validator）
   ├── 检查是否在高/低点附近
   ├── 检查是否刚刚平仓（冷却期）
   └── 其他风控检查
```

### 3. K线数据索引说明

```
klines 列表（按时间升序）:
  klines[-1] = 当前未收盘K线（正在变化中）❌ 不用于信号判断
  klines[-2] = 最近一根已收盘K线 ✅ confirmed_ema9/26
  klines[-3] = 倒数第二根已收盘K线 ✅ prev_ema9/26

EMA 数据对应关系:
  confirmed_ema9  = ema9_values[-2]  （最近已收盘K线的EMA9）
  confirmed_ema26 = ema26_values[-2] （最近已收盘K线的EMA26）
  prev_ema9       = ema9_values[-3]  （倒数第二根K线的EMA9）
  prev_ema26      = ema26_values[-3] （倒数第二根K线的EMA26）
```

---

## 平仓逻辑

### 平仓检测顺序（按优先级）

```
0. 移动止损价格调整（在止损检查之前）
   ├── 条件: 盈利 ≥ 启动阈值(0.5%) 且 不在冷却期
   ├── 做多: 新止损价 = 当前价 × (1 - 距离%)，只能上移
   └── 做空: 新止损价 = 当前价 × (1 + 距离%)，只能下移

1. 止损价触发（包含移动止损后的价格）
   ├── 做多: 当前价格 ≤ 止损价
   └── 做空: 当前价格 ≥ 止损价

2. 硬止损
   └── 亏损 ≥ 2.5%

2.5 5M EMA信号智能止损 ⭐ 新增
   ├── 条件: 当前亏损(pnl < 0) 且 不在冷却期
   ├── 做多亏损 + 5M EMA死叉 → 立即止损
   ├── 做空亏损 + 5M EMA金叉 → 立即止损
   └── 不检查信号强度，交叉发生即触发

3. 最大止盈
   └── 盈利 ≥ 8%

4. 金叉/死叉反转（15M周期）⭐ 关键逻辑
   ├── 持多仓 + 死叉发生 → 平仓
   ├── 持空仓 + 金叉发生 → 平仓
   └── 不检查信号强度（趋势已变应尽快平仓）

5. 趋势减弱（可选）
   ├── 条件: 开仓后30分钟 + 当前盈利 ≥ 1%
   └── 触发: 当前EMA差值 < 开仓时的50%

6. 移动止盈回撤
   ├── 最高盈利 ≥ 1.5% 时激活
   └── 从最高点回撤 ≥ 0.5% 时平仓
```

### 5M EMA信号智能止损详解

当持仓处于亏损状态时，使用 5M 周期的 EMA9/EMA26 交叉信号来判断是否需要提前止损。

```python
def check_5m_signal_stop_loss(position, current_pnl_pct, strategy):
    # 只在亏损时检查（pnl < 0）
    if current_pnl_pct >= 0:
        return False, ""  # 盈利或持平不检查

    # 获取5M EMA数据
    ema_5m = get_ema_data_5m(symbol)

    # 检测5M周期的金叉/死叉
    is_golden_cross = prev_ema9 <= prev_ema26 and ema9 > ema26
    is_death_cross = prev_ema9 >= prev_ema26 and ema9 < ema26

    # 做多亏损 + 5M死叉 → 立即止损
    if position_side == 'LONG' and is_death_cross:
        return True, "5M EMA死叉止损"

    # 做空亏损 + 5M金叉 → 立即止损
    if position_side == 'SHORT' and is_golden_cross:
        return True, "5M EMA金叉止损"
```

**设计理念**：
1. 只在亏损时触发，盈利时不干预
2. 使用更短周期(5M)的信号作为预警
3. 不检查信号强度，交叉发生即认为趋势可能反转
4. 冷却期内不检查，避免刚开仓就被止损

### 金叉/死叉反转平仓详解（15M周期）

```python
def check_cross_reversal(position, ema_data):
    # 使用已收盘K线判断（不用当前未收盘K线）
    ema9 = ema_data['confirmed_ema9']      # klines[-2]
    ema26 = ema_data['confirmed_ema26']    # klines[-2]
    prev_ema9 = ema_data['prev_ema9']      # klines[-3]
    prev_ema26 = ema_data['prev_ema26']    # klines[-3]

    if 持多仓:
        # 死叉判断
        is_death_cross = (prev_ema9 >= prev_ema26) and (ema9 < ema26)
        if is_death_cross:
            return True, "死叉反转平仓"

        # 趋势反转（EMA9 已经低于 EMA26）
        if ema9 < ema26:
            return True, "趋势反转平仓"

    if 持空仓:
        # 金叉判断
        is_golden_cross = (prev_ema9 <= prev_ema26) and (ema9 > ema26)
        if is_golden_cross:
            return True, "金叉反转平仓"

        # 趋势反转（EMA9 已经高于 EMA26）
        if ema9 > ema26:
            return True, "趋势反转平仓"
```

**重要**：平仓不检查信号强度，因为：
1. 金叉/死叉刚发生时，EMA9和EMA26非常接近，强度天然很弱
2. 如果检查强度，可能错过最佳平仓时机

---

## 移动止损

### 工作原理

移动止损会在盈利达到一定阈值后，**动态调整止损价**，锁定部分利润。

```
默认参数:
  启动阈值 (activatePct): 0.5%   # 盈利达到0.5%时启动
  止损距离 (distancePct): 1.0%   # 止损价与当前价保持1%距离
  最小移动阈值: 0.1%             # 止损价变动超过0.1%才更新
```

### 计算方式

```python
做多时:
  new_stop_loss = current_price * (1 - distancePct / 100)
  # 例: 当前价100, 距离1% → 止损价 = 100 * 0.99 = 99
  # 只有 new_stop_loss > current_stop_loss 时才更新（止损价只能上移）

做空时:
  new_stop_loss = current_price * (1 + distancePct / 100)
  # 例: 当前价100, 距离1% → 止损价 = 100 * 1.01 = 101
  # 只有 new_stop_loss < current_stop_loss 时才更新（止损价只能下移）
```

### 示例

```
做多 BTC/USDT:
  入场价: $100,000
  初始止损: $97,500 (硬止损 -2.5%)

价格上涨到 $100,500 (盈利 0.5%):
  → 移动止损启动
  → 新止损价 = $100,500 * 0.99 = $99,495

价格继续上涨到 $101,000:
  → 新止损价 = $101,000 * 0.99 = $99,990
  → 止损价从 $99,495 上移到 $99,990 ✅

价格回落到 $100,000:
  → 止损价保持 $99,990（不下移）
  → 如果价格跌破 $99,990 → 触发止损平仓
```

---

## 移动止盈

### 工作原理

移动止盈在盈利达到较高阈值后激活，当盈利从最高点回撤一定比例时自动平仓，锁定利润。

```
默认参数:
  激活阈值 (trailingActivate): 1.5%   # 盈利达到1.5%时激活
  回撤阈值 (trailingCallback): 0.5%   # 从最高盈利回撤0.5%时平仓
```

### 计算方式

```python
# 持续跟踪最高盈利
if current_pnl_pct > max_profit_pct:
    max_profit_pct = current_pnl_pct

# 检查是否激活
if max_profit_pct >= 1.5% and not activated:
    activated = True

# 检查回撤
if activated:
    callback_pct = max_profit_pct - current_pnl_pct
    if callback_pct >= 0.5%:
        → 平仓（移动止盈触发）
```

### 示例

```
做多 ETH/USDT:
  入场价: $3,000

价格上涨到 $3,045 (盈利 1.5%):
  → 移动止盈激活
  → max_profit_pct = 1.5%

价格继续上涨到 $3,090 (盈利 3%):
  → max_profit_pct = 3%

价格回落到 $3,060 (盈利 2%):
  → 回撤 = 3% - 2% = 1%
  → 回撤 1% >= 0.5% → 触发移动止盈平仓 ✅
  → 实际盈利: 2%
```

### 移动止损 vs 移动止盈 对比

| 特性 | 移动止损 | 移动止盈 |
|------|----------|----------|
| 激活阈值 | 盈利 0.5% | 盈利 1.5% |
| 作用方式 | 动态调整止损价 | 检测回撤比例 |
| 触发机制 | 价格触及止损价 | 盈利从最高点回撤 |
| 保护程度 | 更保守（更早锁定利润） | 更激进（允许更大波动） |

---

## 参数配置

### 系统默认参数

```python
class StrategyExecutorV2:
    # 开仓参数
    MIN_SIGNAL_STRENGTH = 0.15     # 最小开仓信号强度 (%)
    HIGH_SIGNAL_STRENGTH = 0.5     # 高强度阈值，立即开仓 (%)

    # 硬止损止盈
    HARD_STOP_LOSS = 2.5           # 硬止损 (%)
    MAX_TAKE_PROFIT = 8.0          # 最大止盈 (%)

    # 移动止盈
    TRAILING_ACTIVATE = 1.5        # 移动止盈激活阈值 (%)
    TRAILING_CALLBACK = 0.5        # 移动止盈回撤阈值 (%)

    # 移动止损
    TRAILING_STOP_LOSS_ACTIVATE = 0.5   # 移动止损激活阈值 (%)
    TRAILING_STOP_LOSS_DISTANCE = 1.0   # 移动止损距离 (%)

    # 其他
    STRENGTH_MONITOR_DELAY = 30    # 趋势减弱监控延迟（分钟）
```

### 策略级参数覆盖

可以在策略配置中覆盖默认参数：

```json
{
  "stopLossPercent": 2.0,
  "takeProfitPercent": 10.0,
  "trailingActivate": 2.0,
  "trailingCallback": 0.8,
  "smartStopLoss": {
    "trailingStopLoss": {
      "enabled": true,
      "activatePct": 0.5,
      "distancePct": 1.0
    }
  }
}
```

---

## 流程图

### 开仓流程

```
┌─────────────────────────────────────────────────────────────┐
│                      每15分钟K线收盘                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  计算 EMA9/EMA26（使用已收盘K线 klines[-2], klines[-3]）       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  检测金叉/死叉信号                                           │
│  金叉: prev_ema9 ≤ prev_ema26 且 ema9 > ema26               │
│  死叉: prev_ema9 ≥ prev_ema26 且 ema9 < ema26               │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │ 有信号？          │
                    └─────────┬─────────┘
              无信号 │         │ 有信号
                    ▼         ▼
               ┌────────┐  ┌─────────────────────────────────┐
               │ 结束   │  │ 检查信号强度                      │
               └────────┘  │ ema_diff_pct >= 0.15% ?          │
                           └─────────────────────────────────┘
                                          │
                              ┌───────────┴───────────┐
                              │ 强度不足             │ 强度满足
                              ▼                      ▼
                         ┌────────┐    ┌─────────────────────────┐
                         │ 跳过   │    │ 检查 EMA+MA 方向一致性    │
                         └────────┘    └─────────────────────────┘
                                                    │
                                          ┌────────┴────────┐
                                          │ 方向不一致      │ 方向一致
                                          ▼                ▼
                                     ┌────────┐   ┌─────────────────┐
                                     │ 跳过   │   │ 开单自检         │
                                     └────────┘   └─────────────────┘
                                                           │
                                                    ┌──────┴──────┐
                                                    │ 检查失败    │ 检查通过
                                                    ▼            ▼
                                               ┌────────┐  ┌──────────┐
                                               │ 跳过   │  │ 执行开仓  │
                                               └────────┘  └──────────┘
```

### 平仓流程

```
┌─────────────────────────────────────────────────────────────┐
│               WebSocket 实时价格更新（毫秒级）                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    check_smart_exit()                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 0. 移动止损价格调整（盈利≥0.5% 且 不在冷却期）               │
│    做多: 止损价只能上移    做空: 止损价只能下移              │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌─────────────────────┐
│ 1. 止损价触发  │    │ 2. 硬止损      │    │ 2.5 5M EMA信号止损   │
│ (含移动止损)  │    │ 亏损≥2.5%     │    │ 亏损+5M反向交叉      │
└───────┬───────┘    └───────┬───────┘    └──────────┬──────────┘
        │                    │                       │
        │触发                │触发                   │触发
        ▼                    ▼                       ▼
   ┌─────────┐          ┌─────────┐             ┌─────────┐
   │ 平仓    │          │ 平仓    │             │ 平仓    │
   └─────────┘          └─────────┘             └─────────┘

        │未触发              │未触发                 │未触发
        └────────────────────┼─────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 最大止盈检查（盈利≥8%）                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │ 达到止盈？         │
                    └─────────┬─────────┘
                  是 │         │ 否
                    ▼         ▼
               ┌─────────┐  ┌─────────────────────────────────┐
               │ 平仓    │  │ 4. 金叉/死叉反转检查（15M周期）   │
               └─────────┘  │    持多仓 + 死叉 → 平仓          │
                            │    持空仓 + 金叉 → 平仓          │
                            └─────────────────────────────────┘
                                              │
                                    ┌─────────┴─────────┐
                                    │ 反转发生？         │
                                    └─────────┬─────────┘
                                  是 │         │ 否
                                    ▼         ▼
                               ┌─────────┐  ┌─────────────────────┐
                               │ 平仓    │  │ 5. 趋势减弱检查       │
                               │ + 反转  │  │ (开仓30分钟后+盈利≥1%) │
                               │ 开仓    │  └─────────────────────┘
                               └─────────┘                │
                                                ┌─────────┴─────────┐
                                                │ 减弱？            │
                                                └─────────┬─────────┘
                                              是 │         │ 否
                                                ▼         ▼
                                           ┌─────────┐  ┌─────────────────┐
                                           │ 平仓    │  │ 6. 移动止盈检查  │
                                           └─────────┘  │ 回撤≥0.5%?     │
                                                        └─────────────────┘
                                                                  │
                                                        ┌─────────┴─────────┐
                                                        │ 回撤触发？        │
                                                        └─────────┬─────────┘
                                                      是 │         │ 否
                                                        ▼         ▼
                                                   ┌─────────┐  ┌────────┐
                                                   │ 平仓    │  │ 继续   │
                                                   └─────────┘  │ 持仓   │
                                                                └────────┘
```

---

## 常见问题

### Q: 为什么使用 klines[-2] 而不是 klines[-1]？

A: klines[-1] 是当前正在形成的K线，价格还在变化中。如果用它判断金叉/死叉，可能会出现：
- 价格波动导致"假金叉"或"假死叉"
- K线收盘后信号消失，但已经执行了错误的交易

使用 klines[-2]（已收盘K线）可以确保信号是确定的、不会改变的。

### Q: 为什么平仓不检查信号强度？

A: 当金叉/死叉刚发生时，EMA9 和 EMA26 非常接近，信号强度天然很弱（可能只有0.01%）。如果检查强度，就会错过最佳平仓时机。趋势已经反转，应该尽快平仓，不需要等强度增加。

### Q: 移动止损和移动止盈有什么区别？

A:
- **移动止损**：调整实际的止损价格，触发后是止损单成交
- **移动止盈**：监控盈利回撤比例，触发后是市价平仓

两者可以同时启用，互不冲突。移动止损更保守（0.5%激活），移动止盈更激进（1.5%激活）。

### Q: 反转开仓是什么？

A: 当持仓因为金叉/死叉反转而平仓后，系统会自动开立反向仓位：
- 原来做空，因金叉平仓 → 自动做多
- 原来做多，因死叉平仓 → 自动做空

这样可以跟随趋势变化，不错过新的行情。

### Q: 5M EMA信号止损和15M反转平仓有什么区别？

A:
- **5M EMA信号止损**：只在亏损时检查，使用 5M 周期（更短）的 EMA 交叉作为预警信号，提前止损减少亏损
- **15M反转平仓**：无论盈亏都检查，使用 15M 周期（主周期）的 EMA 交叉确认趋势反转

5M 止损是一种"提前预警"机制，当小周期已经出现反转信号时，提前止损避免等到 15M 确认时亏损更大。

### Q: 为什么5M止损只在亏损时触发？

A: 如果持仓盈利中，即使 5M 出现反向交叉，也不一定意味着趋势结束，可能只是短期回调。让移动止盈机制来保护利润更合适。但如果已经亏损，5M 反向交叉说明短期趋势已经不利，应该及时止损。

---

*文档版本: 2025-12-19*
*基于 strategy_executor_v2.py*
