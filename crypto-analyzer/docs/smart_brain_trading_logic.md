# 超级大脑智能交易系统 - 完整逻辑文档

## 一、系统概述

**超级大脑 (SmartDecisionBrain)** 是一个自动化的加密货币期货交易系统，支持做多和做空双向交易。系统每5分钟扫描一次市场，自动识别交易机会并执行开平仓操作。

### 核心参数
- **交易对**: 46个USDT交易对 (从config.yaml读取)
- **每笔仓位**: 400 USDT
- **杠杆**: 5倍
- **账户ID**: 2
- **扫描间隔**: 5分钟 (300秒)
- **持仓限制**: 无限制 (999)

---

## 二、开仓逻辑 - 如何寻找交易机会

### 2.1 扫描流程

```
每5分钟执行一次:
1. 扫描46个交易对
2. 对每个交易对进行评分
3. 选择得分达到阈值的币种
4. 排除已有持仓的币种
5. 开仓
```

### 2.2 评分系统 (threshold = 10分)

系统分别计算做多得分(long_score)和做空得分(short_score)。

**核心思路**: 主要使用1小时K线进行分析，辅以1天K线确认大趋势。

#### **评分维度1: 位置评分 (20分)** - 基于1小时K线

计算当前价格在72小时(3天)价格区间中的位置:

```python
# 使用最近72根1小时K线(相当于3天)
high_72h = 72小时内最高价
low_72h = 72小时内最低价
position_pct = (当前价格 - low_72h) / (high_72h - low_72h) * 100

低位 (position_pct < 30%):
  long_score += 20   # 低位适合做多

高位 (position_pct > 70%):
  short_score += 20  # 高位适合做空

中位 (30% - 70%):
  long_score += 5
  short_score += 5
```

**逻辑**:
- 价格在3天区间的底部(低于30%) → 适合抄底做多
- 价格在3天区间的顶部(高于70%) → 适合高位做空
- 价格在中间 → 两个方向都给少量得分

**为什么用72小时而不是30天?**
- 1小时K线反应最近的价格走势，更灵敏
- 30天太长，反应慢；15分钟太短，噪音大
- 72小时正好捕捉短期趋势变化

#### **评分维度2: 短期动量 (15分)** - 基于1小时K线

```python
# 使用24根1小时K线前的价格对比当前价格
gain_24h = (当前价格 - 24小时前价格) / 24小时前价格 * 100

如果 gain_24h < -3%:
  long_score += 15   # 24小时跌超3%，反弹机会

如果 gain_24h > 3%:
  short_score += 15  # 24小时涨超3%，回调风险
```

**逻辑**:
- 最近24小时大跌(< -3%) → 超跌反弹，做多
- 最近24小时大涨(> 3%) → 过热回调，做空

**为什么用24小时动量?**
- 捕捉短期过热/超跌状态
- 24小时足够识别快速变化
- 避免7天这种过长周期的滞后

#### **评分维度3: 1小时趋势评分 (20分)**

统计最近48根1小时K线(2天)的阳线和阴线数量:

```python
bullish_1h = 48小时中收阳线的小时数
bearish_1h = 48 - bullish_1h

如果 bullish_1h > 30:  # 超过62.5%是阳线
  long_score += 20     # 强上涨趋势，做多

如果 bearish_1h > 30:  # 超过62.5%是阴线
  short_score += 20    # 强下跌趋势，做空
```

**逻辑**:
- 48小时中有30小时以上收阳 → 上涨趋势明显，做多
- 48小时中有30小时以上收阴 → 下跌趋势明显，做空

**为什么用48小时?**
- 2天足够判断短期趋势方向
- 比30天更灵敏，更适合5倍杠杆短期交易
- 基于1小时K线，信号更及时

#### **评分维度4: 波动率加成 (10分)** - 基于1小时K线

```python
# 计算最近24小时的价格波动幅度
recent_24h = 最近24根1小时K线
volatility = (24h最高价 - 24h最低价) / 当前价格 * 100

如果 volatility > 5%:  # 波动率超过5%
  # 给得分更高的方向加分
  if long_score > short_score:
    long_score += 10
  else:
    short_score += 10
```

**逻辑**:
- 高波动环境下，增强已有趋势的信号
- 只有波动足够大，才值得开仓
- 避免在横盘震荡中频繁交易

#### **评分维度5: 大趋势确认 (10分)** - 基于1天K线(辅助)

```python
# 统计最近30天的阳线数量
bullish_1d = 30天中收阳线的天数

如果 bullish_1d > 18 且 long_score > short_score:
  long_score += 10   # 大趋势向上，增强做多信号

如果 bullish_1d <= 12 且 short_score > long_score:
  short_score += 10  # 大趋势向下，增强做空信号
```

**逻辑**:
- 1天K线用于确认长期大趋势
- 只有在与1小时分析方向一致时才加分
- 避免逆大势操作

### 2.3 开仓决策

```python
# 只要任一方向得分达到阈值(10分)，就选择得分更高的方向开仓

if long_score >= 10 OR short_score >= 10:
    if long_score >= short_score:
        开多单
    else:
        开空单
```

**举例**:

**场景1 - 底部反弹做多 (BTC/USDT)**:
- 位置: 在72小时区间的18% (低位) → long_score +20
- 24小时动量: -5% (超跌) → long_score +15
- 48小时趋势: 32根阳线 → long_score +20
- 24小时波动率: 6.5% → long_score +10 (波动够大且long更高)
- 30天大趋势: 22天阳线,且long>short → long_score +10
- **long_score = 75, short_score = 5**
- **决策: 开多单**

**场景2 - 高位回调做空 (ETH/USDT)**:
- 位置: 在72小时区间的85% (高位) → short_score +20
- 24小时动量: +8% (过热) → short_score +15
- 48小时趋势: 35根阴线 → short_score +20
- 24小时波动率: 7.2% → short_score +10 (波动够大且short更高)
- 30天大趋势: 10天阳线,且short>long → short_score +10
- **long_score = 5, short_score = 75**
- **决策: 开空单**

**场景3 - 震荡后突破做多 (SOL/USDT)**:
- 位置: 在72小时区间的45% (中位) → long_score +5, short_score +5
- 24小时动量: +1.5% (平稳) → 无加分
- 48小时趋势: 26根阳线 (平衡) → 无加分
- 24小时波动率: 3.2% (较低) → 无加分
- 30天大趋势: 20天阳线,且long>short → long_score +10
- **long_score = 15, short_score = 5**
- **决策: 开多单 (long_score达到阈值且更高)**

**场景4 - 条件不足不开仓 (ADA/USDT)**:
- 位置: 在72小时区间的52% (中位) → long_score +5, short_score +5
- 24小时动量: +0.3% (平稳) → 无加分
- 48小时趋势: 24阳24阴 (平衡) → 无加分
- 24小时波动率: 2.1% (过低) → 无加分
- 30天大趋势: 16天阳线 (平衡) → 无加分
- **long_score = 5, short_score = 5**
- **决策: 不开仓 (两边都未达到10分阈值)**

### 2.4 开仓执行

```python
开仓价格 = 当前市场价 (实时获取1分钟K线最新收盘价)
数量 = 400 USDT * 5倍杠杆 / 开仓价格
保证金 = 400 USDT

做多 (LONG):
  止损价 = 开仓价 * 0.97  (-3%)
  止盈价 = 开仓价 * 1.02  (+2%)

做空 (SHORT):
  止损价 = 开仓价 * 1.03  (+3%)
  止盈价 = 开仓价 * 0.98  (-2%)
```

---

## 三、平仓逻辑 - 4层保护机制

系统每5分钟检查一次所有持仓，按以下优先级执行平仓:

### 3.1 第一层: 固定止损 (保底风控)

```python
做多 (LONG):
  if 当前价格 <= 止损价 (开仓价 * 0.97):
    立即平仓
    原因: STOP_LOSS

做空 (SHORT):
  if 当前价格 >= 止损价 (开仓价 * 1.03):
    立即平仓
    原因: STOP_LOSS
```

**目的**: 防止大额亏损，-3%立即止损

**触发时机**: 任何时候，实时监控

---

### 3.2 第二层: 智能顶底识别 (主动止盈) ⭐核心功能

使用15分钟K线，分析最近10根(2.5小时)的价格走势。

#### **多单见顶平仓逻辑**:

```python
条件1: 价格创新高后回落
  - 找到最近10根K线的最高点
  - 最高点在前面(第0-7根K线)，不是最新的K线

条件2: 从高点回落 >= 1%
  pullback_pct = (最高价 - 当前价) / 最高价 * 100 >= 1.0%

条件3: K线形态确认 (满足其一)
  - 最近3根K线中，有2根以上收阴线 (close < open)
  - 最近3根K线中，有2根以上长上影线 (上影线 > 实体 * 2)

如果三个条件都满足:
  平仓
  原因: TOP_DETECTED(高点回落X.X%,盈利+Y.Y%)
```

**举例 - 多单见顶**:

```
时间轴 (15分钟K线):
K1: $100 (开仓)
K2: $101
K3: $102
K4: $103 ← 最高点
K5: $102.5 (阴线)
K6: $102.2 (阴线)
K7: $101.8 (阴线) ← 当前

判断:
✓ 最高点在K4 (idx=3 < 8)
✓ 回落 = (103-101.8)/103 = 1.17% >= 1%
✓ 最近3根K线(K5,K6,K7)都是阴线 >= 2根

决策: 见顶平仓，盈利 +1.8%
```

#### **空单见底平仓逻辑**:

```python
条件1: 价格创新低后反弹
  - 找到最近10根K线的最低点
  - 最低点在前面(第0-7根K线)

条件2: 从低点反弹 >= 1%
  bounce_pct = (当前价 - 最低价) / 最低价 * 100 >= 1.0%

条件3: K线形态确认 (满足其一)
  - 最近3根K线中，有2根以上收阳线 (close > open)
  - 最近3根K线中，有2根以上长下影线 (下影线 > 实体 * 2)

如果三个条件都满足:
  平仓
  原因: BOTTOM_DETECTED(低点反弹X.X%,盈利+Y.Y%)
```

**举例 - 空单见底**:

```
时间轴 (15分钟K线):
K1: $100 (开空)
K2: $99
K3: $98
K4: $97 ← 最低点
K5: $97.5 (阳线)
K6: $98 (阳线)
K7: $98.2 (阳线) ← 当前

判断:
✓ 最低点在K4 (idx=3 < 8)
✓ 反弹 = (98.2-97)/97 = 1.24% >= 1%
✓ 最近3根K线(K5,K6,K7)都是阳线 >= 3根

决策: 见底平仓，盈利 +1.8%
```

**智能顶底识别的优势**:
- 不会机械地等到+2%才平仓
- 在真正的顶部/底部提前获利
- 避免"坐电梯"(涨到+5%又跌回+1%)
- 可能在+1.5%就平仓，但避免了后续回撤

---

### 3.3 第三层: 固定止盈 (兜底止盈)

如果顶底识别没有触发，使用固定止盈作为兜底:

```python
做多 (LONG):
  if 当前价格 >= 止盈价 (开仓价 * 1.02):
    平仓
    原因: TAKE_PROFIT

做空 (SHORT):
  if 当前价格 <= 止盈价 (开仓价 * 0.98):
    平仓
    原因: TAKE_PROFIT
```

**目的**: 确保至少有+2%盈利时会平仓

**触发时机**: 智能顶底识别没触发时的保底方案

---

### 3.4 第四层: 超时平仓 (最终兜底)

```python
if 持仓时间 >= 6小时:
  强制平仓
  原因: CLOSE_TIMEOUT
```

**目的**:
- 避免长时间暴露杠杆风险
- 6小时足够完成一个短期趋势
- 最终兜底保护

---

## 四、完整交易流程示例

### 示例1: 成功的做多交易

**时间轴**:

```
00:00 扫描发现机会 (基于1小时K线)
  - BTC/USDT 72小时位置18% (低位) +20分
  - 24小时跌幅-4.2% (超跌) +15分
  - 48小时33根阳线 (强势) +20分
  - 24小时波动率5.8% +10分
  - 30天大趋势确认 +10分
  - long_score = 75 > 阈值

00:00 开多单
  - 开仓价: $42,000
  - 止损: $40,740 (-3%)
  - 止盈: $42,840 (+2%)
  - 仓位: 0.0476 BTC (400*5/42000)
  - 保证金: $400

00:15 - 02:30 持仓中，价格上涨
  - 价格到达 $42,800
  - 最高价 $43,000

02:45 智能顶底识别触发
  - 最高点在30分钟前($43,000)
  - 当前价格 $42,500
  - 回落幅度: 1.16%
  - 最近3根K线都是阴线

02:45 平仓
  - 平仓价: $42,500
  - 盈利: +1.19%
  - 实际盈利: 400*5*1.19% = $23.8
  - 原因: TOP_DETECTED(高点回落1.16%,盈利+1.19%)
```

**结果**: 成功在顶部附近平仓，虽然没到+2%止盈，但避免了后续回撤

---

### 示例2: 止损保护的做空交易

**时间轴**:

```
10:00 扫描发现机会 (基于1小时K线)
  - ETH/USDT 72小时位置88% (高位) +20分
  - 24小时涨幅+6.5% (过热) +15分
  - 48小时36根阴线 (弱势) +20分
  - 24小时波动率7.2% +10分
  - 30天大趋势确认 +10分
  - short_score = 75 > 阈值

10:00 开空单
  - 开仓价: $2,200
  - 止损: $2,266 (+3%)
  - 止盈: $2,156 (-2%)
  - 仓位: 0.909 ETH (400*5/2200)
  - 保证金: $400

10:15 - 10:45 价格反向上涨
  - 价格持续上涨至 $2,270

10:50 触发止损
  - 当前价格 $2,270 > 止损价 $2,266

10:50 平仓
  - 平仓价: $2,270
  - 亏损: -3.18%
  - 实际亏损: 400*5*(-3.18%) = -$63.6
  - 原因: STOP_LOSS
```

**结果**: 虽然判断失误，但止损机制限制了损失在-3%左右

---

### 示例3: 超时平仓

**时间轴**:

```
08:00 开多单 SOL/USDT (基于1小时K线)
  - 开仓价: $50
  - 72小时位置35% +20分
  - 24小时涨幅-1.2% (无加分)
  - 48小时28根阳线 (无加分)
  - 24小时波动率2.8% (无加分)
  - 30天大趋势确认 +10分
  - 评分: long_score = 30

08:00 - 14:00 横盘震荡
  - 价格在 $49.5 - $50.5 之间波动
  - 没有触发止盈止损
  - 没有形成明显顶部特征

14:00 超时平仓触发
  - 持仓时间 = 6小时
  - 当前价格: $50.20

14:00 强制平仓
  - 平仓价: $50.20
  - 盈利: +0.4%
  - 实际盈利: 400*5*0.4% = $8
  - 原因: CLOSE_TIMEOUT
```

**结果**: 虽然小盈利，但避免了继续暴露风险

---

## 五、风险控制总结

### 5.1 四层平仓保护优先级

```
第1层: 固定止损 (-3%)      → 随时触发，保底风控
         ↓ (如果未触发)
第2层: 智能顶底识别        → 2.5小时后生效，主动止盈
         ↓ (如果未触发)
第3层: 固定止盈 (+2%)      → 随时触发，兜底止盈
         ↓ (如果未触发)
第4层: 超时平仓 (6小时)    → 最终兜底
```

### 5.2 单笔风险

```
最大亏损: 400 USDT * 3% = $12 (触发止损)
期望盈利: 400 USDT * 2% = $8 (固定止盈)
         或更高 (智能顶底识别)
```

### 5.3 关键特性

✅ **多空双向**: 适应各种市场环境
✅ **智能识别**: 不机械依赖固定百分比
✅ **严格止损**: -3%必定平仓
✅ **灵活止盈**: 顶底识别优先，固定止盈兜底
✅ **时间控制**: 6小时强制平仓，避免长时间风险暴露

---

## 六、系统参数配置

```python
# SmartDecisionBrain 参数
threshold = 10              # 开仓阈值(分)
whitelist = 46个交易对      # 从config.yaml读取

# K线分析参数 (核心变化)
primary_timeframe = 1小时   # 主要分析时间框架
position_lookback = 72小时  # 位置评分回看周期(72根1h K线)
momentum_period = 24小时    # 动量评分周期(24根1h K线)
trend_period = 48小时       # 趋势评分周期(48根1h K线)
volatility_period = 24小时  # 波动率评分周期(24根1h K线)
bigtrend_period = 30天      # 大趋势确认周期(30根1d K线)

# 评分权重
position_score = 20分       # 位置评分
momentum_score = 15分       # 动量评分
trend_score = 20分          # 趋势评分
volatility_score = 10分     # 波动率评分
bigtrend_score = 10分       # 大趋势确认评分

# SmartTraderService 参数
account_id = 2              # 账户ID
position_size_usdt = 400    # 每笔保证金
max_positions = 999         # 持仓上限(无限制)
leverage = 5                # 杠杆倍数
scan_interval = 300         # 扫描间隔(秒)

# 止盈止损参数
stop_loss_pct = 3%          # 止损百分比
take_profit_pct = 2%        # 止盈百分比
timeout_hours = 6           # 超时小时数

# 顶底识别参数
closing_timeframe = 15分钟  # 平仓监控时间框架
lookback_candles = 10       # 回看K线数
pullback_threshold = 1.0%   # 回落/反弹阈值
confirmation_candles = 2    # 确认K线数(3根中2根)
```

---

## 七、日志示例

```bash
# 开仓日志
[OPEN] BTC/USDT LONG | 价格: $42000.0000 | 数量: 0.05
[SUCCESS] BTC/USDT LONG开仓成功 | 止损: $40740.0000 (-3%) | 止盈: $42840.0000 (+2%)

# 智能平仓日志
[TOP_DETECTED(高点回落1.2%,盈利+1.5%)] BTC/USDT LONG | 开仓: $42000.0000 | 平仓: $42630.0000 | 盈亏: +1.50%

# 止损日志
[STOP_LOSS] ETH/USDT SHORT | 开仓: $2200.0000 | 平仓: $2270.0000 | 盈亏: -3.18%

# 固定止盈日志
[TAKE_PROFIT] SOL/USDT LONG | 开仓: $50.0000 | 平仓: $51.0000 | 盈亏: +2.00%

# 超时平仓日志
[CLOSE_TIMEOUT] ADA/USDT 超时平仓 | 价格: $0.3650
```

---

## 八、常见问题

### Q1: 为什么开仓后立即平仓?
A: 已修复。之前是因为止盈止损基于扫描价格而非开仓价格计算。现在基于实际开仓价格计算，不会出现止盈价低于开仓价的情况。

### Q2: 为什么只开多单不开空单?
A: 已修复。现在支持多空双向，系统会根据市场位置和趋势自动选择方向。

### Q3: 1小时K线和1天K线的区别是什么?
A:
- **1小时K线**: 主要分析工具，用于位置、动量、趋势、波动率评分
- **1天K线**: 辅助工具，仅用于确认30天大趋势
- **15分钟K线**: 专门用于平仓时的顶底识别

这样的设计让系统既能捕捉短期机会(1小时)，又不违背大趋势(1天)，还能精准止盈(15分钟)。

### Q4: 为什么用72小时而不是30天计算位置?
A: 因为使用1小时K线作为主要分析工具:
- 30天太长，反应滞后，不适合5倍杠杆短期交易
- 72小时(3天)能捕捉短期高低点，更灵敏
- 配合1天K线确认大趋势，避免逆势

### Q5: 智能顶底识别会不会太敏感?
A: 不会。需要同时满足3个条件:
1. 价格创新高/新低后回落/反弹
2. 回落/反弹幅度 >= 1%
3. K线形态确认(3根中2根)

### Q6: 如果顶底识别和固定止盈都没触发怎么办?
A: 6小时后会强制平仓，这是最终的兜底保护。

### Q7: 为什么是6小时而不是更长?
A: 平衡点。既给智能算法充足时间判断(顶底识别需要2.5小时)，又控制5倍杠杆的风险暴露。

### Q8: 系统如何避免在震荡市频繁交易?
A: 通过多维度评分:
- 位置评分要求明确的高位或低位
- 动量评分要求足够的涨跌幅(±3%)
- 趋势评分要求明显的多空方向
- 波动率要求 >5% 才加分
- 只有综合得分 ≥10 才开仓

震荡市通常各维度得分都不高，难以达到开仓阈值。

---

---

## 九、核心升级说明 (v2.0)

### 9.1 为什么从1天K线改为1小时K线?

**之前的问题 (v1.0)**:
- 主要使用1天K线进行分析
- 1天K线太"大太空"，反应滞后
- 15分钟K线太敏感，噪音大
- **1小时K线完全没有利用** ❌

**现在的改进 (v2.0)**:
- **1小时K线成为核心分析工具** ✅
- 1天K线降级为辅助确认大趋势
- 15分钟K线专职平仓监控

### 9.2 具体变化对比

| 维度 | v1.0 (1天K线) | v2.0 (1小时K线) | 改进效果 |
|------|---------------|----------------|----------|
| 位置评分 | 30天高低点 | 72小时高低点 | 更灵敏捕捉短期机会 |
| 动量评分 | 7天涨跌幅 | 24小时涨跌幅 | 更快反应超跌/过热 |
| 趋势评分 | 30天阳阴线 | 48小时阳阴线 | 短期趋势判断更准 |
| 波动率 | ❌ 无 | ✅ 24小时波动率 | 避免低波动横盘 |
| 大趋势 | 主要参考 | 辅助确认 | 不逆大势但更灵活 |

### 9.3 为什么这样更好?

```
场景: BTC从$40,000涨到$42,000 (涨幅+5%)

v1.0分析 (1天K线):
- 看30天数据，认为还在上涨趋势
- 继续做多信号
- 结果: 在高位$42,000开多，随后回调亏损

v2.0分析 (1小时K线):
- 看72小时数据，发现已在3天区间的85%高位
- 看24小时涨幅+5%，过热信号
- 看48小时趋势，阳线减少
- 波动率高，给空单加分
- 结果: 在高位$42,000开空或不开仓，避免亏损
```

### 9.4 系统现在的优势

✅ **灵敏度**: 1小时K线捕捉短期变化，适合5倍杠杆短期交易
✅ **准确性**: 多维度评分(位置+动量+趋势+波动率)避免误判
✅ **稳定性**: 1天K线确认大趋势，不会完全逆势
✅ **及时性**: 15分钟K线精准识别顶底，主动止盈

---

*文档版本: v2.0*
*更新时间: 2026-01-19*
*系统版本: smart_trader_service.py*
*核心变化: 从1天K线主导改为1小时K线主导*
