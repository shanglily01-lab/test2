# è¶…çº§å¤§è„‘åˆçº¦äº¤æ˜“è´¨é‡ä¼˜åŒ–æ–¹æ¡ˆ

> **æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2026-01-23
> **å½“å‰äº¤æ˜“è¡¨ç°**: 30ç¬”äº¤æ˜“ï¼Œèƒœç‡56.7%ï¼Œæ€»ç›ˆäº$31.64ï¼Œç›ˆäºæ¯”1.60:1
> **ä¼˜åŒ–ç›®æ ‡**: æå‡èƒœç‡åˆ°65%+ï¼Œç›ˆäºæ¯”åˆ°2.0+ï¼Œé™ä½æ— æ•ˆäºæŸ

---

## ğŸ“Š é—®é¢˜è¯Šæ–­æ±‡æ€»

ä» `analyze_recent_trades.py` åˆ†æçš„æœ€è¿‘24å°æ—¶æ•°æ®æ¥çœ‹ï¼š

| é—®é¢˜åˆ†ç±» | äº¤æ˜“æ•° | èƒœç‡ | å¹³å‡ç›ˆäº | æ€»ç›ˆäº | ä¸¥é‡ç¨‹åº¦ |
|---------|--------|------|---------|--------|---------|
| **TIMEOUT_4H** (4å°æ—¶è¶…æ—¶) | 47ç¬” | 51.1% | $0.85 | $39.87 | ğŸ”´ é«˜ |
| **hard_stop_loss** (ç¡¬æ­¢æŸ) | 10ç¬” | 0% | -$41.13 | -$411.30 | ğŸ”´ é«˜ |
| **hedge_loss_cut** (å¯¹å†²æ­¢æŸ) | 8ç¬” | 0% | -$15.69 | -$125.50 | ğŸ”´ é«˜ |
| **æ­¢ç›ˆè§¦å‘** (ç§»åŠ¨æ­¢ç›ˆ) | 1ç¬” | 100% | $24.82 | $24.82 | ğŸŸ¡ ä¸­ |

---

## âœ… é—®é¢˜1: TIMEOUT_4H (æŒä»“4å°æ—¶è¶…æ—¶)

### é—®é¢˜æè¿°

- **å½“å‰é€»è¾‘**: ç¡¬ç¼–ç 4å°æ—¶è¶…æ—¶ï¼Œå¼ºåˆ¶å¹³ä»“
- **æ•°æ®è¡¨ç°**: 47ç¬”äº¤æ˜“ï¼Œèƒœç‡ä»…51.1%ï¼Œæ€»ç›ˆäº$39.87
- **æ ¸å¿ƒé—®é¢˜**:
  - å¾ˆå¤šå•å­æŒä»“4å°æ—¶ä»æœªç›ˆåˆ©ï¼Œè¢«åŠ¨å¹³ä»“
  - æœ€å·®äº¤æ˜“å¤šæ•°æ˜¯4å°æ—¶è¶…æ—¶äºæŸ (ALGO -$11.54, LTC -$8.92, BTC -$6.05...)
  - ç›ˆåˆ©å•ä¹Ÿå¯èƒ½åœ¨4å°æ—¶è¢«å¼ºåˆ¶å¹³ä»“ï¼Œé”™å¤±æ›´å¤§åˆ©æ¶¦

### ä¼˜åŒ–æ–¹æ¡ˆ âœ… **å·²ç¡®è®¤**

#### **æ–¹æ¡ˆ1: åŠ¨æ€è¶…æ—¶æ—¶é—´ï¼ˆåŸºäºè¯„åˆ†å’Œç›ˆåˆ©çŠ¶æ€ï¼‰**

```python
def get_timeout_minutes(entry_score, current_pnl_pct, elapsed_minutes):
    """
    æ ¹æ®å¼€ä»“è¯„åˆ†å’Œå½“å‰ç›ˆäºåŠ¨æ€è®¡ç®—è¶…æ—¶æ—¶é—´

    Args:
        entry_score: å¼€ä»“æ—¶çš„è¯„åˆ†
        current_pnl_pct: å½“å‰ç›ˆäºç™¾åˆ†æ¯”
        elapsed_minutes: å·²æŒä»“æ—¶é•¿(åˆ†é’Ÿ)

    Returns:
        ä»å¼€ä»“æ—¶é—´å¼€å§‹è®¡ç®—çš„æ€»è¶…æ—¶æ—¶é•¿(åˆ†é’Ÿ)
    """
    # åŸºäºè¯„åˆ†ç¡®å®šåŸºç¡€è¶…æ—¶
    if entry_score >= 40:
        base_timeout = 360  # é«˜è¯„åˆ†6å°æ—¶
    elif entry_score >= 35:
        base_timeout = 300  # 5å°æ—¶
    elif entry_score >= 30:
        base_timeout = 240  # 4å°æ—¶
    else:
        base_timeout = 180  # ä½è¯„åˆ†3å°æ—¶

    # æ ¹æ®ç›ˆäºçŠ¶æ€è°ƒæ•´
    if current_pnl_pct > 1.0:  # ç›ˆåˆ©>1%
        adjusted_timeout = base_timeout * 1.5  # å»¶é•¿50%ï¼Œè®©åˆ©æ¶¦å¥”è·‘
    elif current_pnl_pct < -0.5:  # äºæŸ>0.5%
        adjusted_timeout = base_timeout * 0.7  # ç¼©çŸ­30%ï¼ŒåŠæ—¶æ­¢æŸ
    else:
        adjusted_timeout = base_timeout

    return adjusted_timeout
```

**å®ç°è¦ç‚¹**:
- åœ¨å¼€ä»“æ—¶æ ¹æ® `entry_score` è®¾ç½®åˆå§‹ `timeout_at`
- æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ç›ˆäºï¼ŒåŠ¨æ€è°ƒæ•´ `timeout_at`
- **å…³é”®**: è¶…æ—¶æ—¶é—´ = å¼€ä»“æ—¶é—´ + æ€»æ—¶é•¿ï¼Œä¸æ˜¯å½“å‰æ—¶é—´ + å‰©ä½™æ—¶é•¿

**æ•°æ®åº“å­—æ®µ**:
```sql
ALTER TABLE futures_positions
ADD COLUMN max_hold_minutes INT DEFAULT 240 COMMENT 'æœ€å¤§æŒä»“æ—¶é•¿(åˆ†é’Ÿ)',
ADD COLUMN timeout_at DATETIME COMMENT 'è¶…æ—¶æ—¶é—´ç‚¹';
```

#### **æ–¹æ¡ˆ2: åˆ†é˜¶æ®µè¶…æ—¶ç­–ç•¥**

```python
def check_stage_timeout(position):
    """
    åˆ†é˜¶æ®µæ£€æŸ¥æŒä»“ï¼Œä¸åŒæ—¶é—´ç‚¹æœ‰ä¸åŒçš„å¹³ä»“æ¡ä»¶
    åªé’ˆå¯¹äºæŸå•ï¼Œç›ˆåˆ©å•è½¬ç§»åŠ¨æ­¢ç›ˆç®¡ç†
    """
    elapsed_hours = (datetime.utcnow() - position['created_at']).total_seconds() / 3600
    current_pnl_pct = calculate_current_pnl_pct(position)

    # ç›ˆåˆ©å•ä¸å—è¶…æ—¶é™åˆ¶
    if current_pnl_pct > 0:
        return False  # è½¬ç§»åŠ¨æ­¢ç›ˆç®¡ç†

    # åˆ†é˜¶æ®µæ£€æŸ¥ï¼ˆåªé’ˆå¯¹äºæŸå•ï¼‰
    if elapsed_hours >= 4:
        if current_pnl_pct <= -0.5:  # 4å°æ—¶äºæŸ>0.5%
            return True  # å¹³ä»“ï¼ŒåŸå› : STAGE_TIMEOUT_4H
    elif elapsed_hours >= 3:
        if current_pnl_pct <= -1.0:  # 3å°æ—¶äºæŸ>1%
            return True  # å¹³ä»“ï¼ŒåŸå› : STAGE_TIMEOUT_3H
    elif elapsed_hours >= 2:
        if current_pnl_pct <= -1.5:  # 2å°æ—¶äºæŸ>1.5%
            return True  # å¹³ä»“ï¼ŒåŸå› : STAGE_TIMEOUT_2H
    elif elapsed_hours >= 1:
        if current_pnl_pct <= -2.0:  # 1å°æ—¶äºæŸ>2%
            return True  # å¹³ä»“ï¼ŒåŸå› : STAGE_TIMEOUT_1H

    return False  # ç»§ç»­æŒæœ‰
```

**è°ƒç”¨æ—¶æœº**: æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æ‰€æœ‰æŒä»“

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|-----|------|--------|------|
| 4å°æ—¶è¶…æ—¶æ•°é‡ | 47ç¬” | 20-25ç¬” | -50% |
| è¶…æ—¶å¹³å‡ç›ˆäº | $0.85 | $3-5 | +300% |
| äºæŸå•æŒä»“æ—¶é•¿ | 4å°æ—¶ | 2-3å°æ—¶ | -30% |
| ç›ˆåˆ©å•æŒä»“æ—¶é•¿ | 4å°æ—¶ | 6-8å°æ—¶ | +50% |

---

## âœ… é—®é¢˜2: hard_stop_loss (ç¡¬æ­¢æŸ) - é»‘åå•åˆ†çº§åˆ¶åº¦

### é—®é¢˜æè¿°

- **å½“å‰è¡¨ç°**: 10ç¬”ç¡¬æ­¢æŸï¼Œ**èƒœç‡0%**ï¼Œå¹³å‡äºæŸ$-41.13ï¼Œæ€»äºæŸ$-411.30
- **æ ¸å¿ƒè®¤çŸ¥**: ç¡¬æ­¢æŸæœ¬æ¥å°±ä¸å¯èƒ½ç›ˆåˆ©ï¼Œè¿™æ˜¯**ç»“æœä¸æ˜¯åŸå› **
- **çœŸæ­£é—®é¢˜**: å“ªäº›äº¤æ˜“å¯¹ç»å¸¸è§¦å‘ç¡¬æ­¢æŸï¼Ÿåº”è¯¥é™ä½æˆ–åœæ­¢äº¤æ˜“

### ä¼˜åŒ–æ–¹æ¡ˆ âœ… **å·²ç¡®è®¤**

#### **äº¤æ˜“å¯¹é»‘åå•3çº§åˆ¶åº¦ï¼ˆåŠ¨æ€å‡é™çº§ï¼‰**

åŸºäºæœ€è¿‘7å¤©çš„ç¡¬æ­¢æŸç»Ÿè®¡ã€èƒœç‡å’Œç›ˆäºï¼Œå¯¹äº¤æ˜“å¯¹è¿›è¡Œ**åŠ¨æ€åˆ†çº§ç®¡ç†**ï¼š

```python
# åˆ†çº§è§„åˆ™ï¼ˆæ¯å¤©æ›´æ–°ï¼Œå¯å‡çº§å¯é™çº§ï¼‰

ã€ç™½åå•ã€‘æ­£å¸¸äº¤æ˜“
é™çº§æ¡ä»¶:
  - ç¡¬æ­¢æŸæ¬¡æ•° < 3æ¬¡/7å¤©
  - æˆ–ç¡¬æ­¢æŸäºæŸ > -100 USDT/7å¤©
  - æˆ–èƒœç‡ > 50% ä¸”æ€»ç›ˆäº > 0
é…ç½®:
  - ä¿è¯é‡‘: 400 USDT (100%)
  - å¼€ä»“é˜ˆå€¼: 30åˆ†
  - å¯ä»¥æ¥å—å¯¹å†²ï¼ˆ100Uï¼‰

å‡çº§è·¯å¾„: æ— ï¼ˆå·²æ˜¯æœ€é«˜çº§ï¼‰
é™çº§è·¯å¾„: â†’ é»‘åå•1çº§

---

ã€é»‘åå•1çº§ã€‘è¡¨ç°ä¸ä½³
è¿›å…¥æ¡ä»¶:
  - ç¡¬æ­¢æŸæ¬¡æ•° 3-5æ¬¡/7å¤©
  - æˆ–ç¡¬æ­¢æŸäºæŸ -100 ~ -200 USDT/7å¤©
  - æˆ–èƒœç‡ < 40%
é…ç½®:
  - ä¿è¯é‡‘: 100 USDT (25%)
  - å¼€ä»“é˜ˆå€¼: 35åˆ† (+5åˆ†)
  - å¯¹å†²ä¿è¯é‡‘: 25 USDT (25%)
  - åŸå› æ ‡è®°: "é»‘åå•1çº§-é™ä½ä»“ä½"

å‡çº§æ¡ä»¶ï¼ˆå›åˆ°ç™½åå•ï¼‰:
  - è¿ç»­3å¤©ç¡¬æ­¢æŸ < 2æ¬¡/å¤©
  - ä¸”æœ€è¿‘7å¤©èƒœç‡ > 50%
  - ä¸”æ€»ç›ˆäº > 0

é™çº§æ¡ä»¶ï¼ˆè¿›å…¥é»‘åå•2çº§ï¼‰:
  - ç¡¬æ­¢æŸæ¬¡æ•° â‰¥ 5æ¬¡/7å¤©
  - æˆ–ç¡¬æ­¢æŸäºæŸ < -200 USDT/7å¤©

---

ã€é»‘åå•2çº§ã€‘è¡¨ç°å¾ˆå·®
è¿›å…¥æ¡ä»¶:
  - ç¡¬æ­¢æŸæ¬¡æ•° 5-8æ¬¡/7å¤©
  - æˆ–ç¡¬æ­¢æŸäºæŸ -200 ~ -300 USDT/7å¤©
  - æˆ–èƒœç‡ < 30%
é…ç½®:
  - ä¿è¯é‡‘: 50 USDT (12.5%)
  - å¼€ä»“é˜ˆå€¼: 40åˆ† (+10åˆ†)
  - å¯¹å†²ä¿è¯é‡‘: 12.5 USDT (25%)
  - åŸå› æ ‡è®°: "é»‘åå•2çº§-æä½ä»“ä½"

å‡çº§æ¡ä»¶ï¼ˆå›åˆ°é»‘åå•1çº§ï¼‰:
  - è¿ç»­3å¤©ç¡¬æ­¢æŸ < 1æ¬¡/å¤©
  - ä¸”æœ€è¿‘7å¤©ç¡¬æ­¢æŸ < 5æ¬¡
  - ä¸”èƒœç‡ > 40%

é™çº§æ¡ä»¶ï¼ˆè¿›å…¥é»‘åå•3çº§ï¼‰:
  - ç¡¬æ­¢æŸæ¬¡æ•° > 8æ¬¡/7å¤©
  - æˆ–ç¡¬æ­¢æŸäºæŸ < -300 USDT/7å¤©

---

ã€é»‘åå•3çº§ã€‘æ°¸ä¹…ç¦æ­¢äº¤æ˜“
è¿›å…¥æ¡ä»¶:
  - ç¡¬æ­¢æŸæ¬¡æ•° > 8æ¬¡/7å¤©
  - æˆ–ç¡¬æ­¢æŸäºæŸ < -300 USDT/7å¤©
  - æˆ–è¿ç»­10ç¬”äº¤æ˜“èƒœç‡ 0%
é…ç½®:
  - ä¿è¯é‡‘: 0 USDT (ç¦æ­¢)
  - å®Œå…¨åœæ­¢äº¤æ˜“è¯¥äº¤æ˜“å¯¹
  - åŸå› æ ‡è®°: "é»‘åå•3çº§-æ°¸ä¹…ç¦æ­¢"

å‡çº§æ¡ä»¶: âŒ **æ— æ³•å‡çº§ï¼Œæ°¸ä¹…ç¦æ­¢**
```

**å‡é™çº§ç¤ºä¾‹**:
```
Day 1: ALGO/USDT ç™½åå• (400U)
Day 2: ç¡¬æ­¢æŸ3æ¬¡ â†’ é™çº§åˆ°é»‘åå•1çº§ (100U)
Day 3-5: è¡¨ç°æ”¹å–„ï¼Œç¡¬æ­¢æŸ0æ¬¡
Day 6: å‡çº§å›ç™½åå• (400U)

Day 1: LTC/USDT é»‘åå•1çº§ (100U)
Day 2-4: ç»§ç»­ç¡¬æ­¢æŸï¼Œç´¯è®¡6æ¬¡ â†’ é™çº§åˆ°é»‘åå•2çº§ (50U)
Day 5-7: ç¡¬æ­¢æŸå‡å°‘ï¼Œç´¯è®¡3æ¬¡
Day 8: å‡çº§åˆ°é»‘åå•1çº§ (100U)

Day 1: XMR/USDT é»‘åå•2çº§ (50U)
Day 2-4: è¿ç»­ç¡¬æ­¢æŸï¼Œç´¯è®¡10æ¬¡ â†’ é™çº§åˆ°é»‘åå•3çº§ (æ°¸ä¹…ç¦æ­¢)
Day 5+: ä¸å†äº¤æ˜“ï¼Œæ— æ³•å‡çº§
```

#### **æ•°æ®åº“è¡¨ç»“æ„**

```sql
CREATE TABLE IF NOT EXISTS trading_symbol_rating (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    blacklist_level INT DEFAULT 0 COMMENT 'é»‘åå•ç­‰çº§: 0=ç™½åå•, 1/2/3=é»‘åå•çº§åˆ«',

    -- ç»Ÿè®¡æ•°æ®
    hard_stop_loss_count_7d INT DEFAULT 0 COMMENT '7å¤©å†…ç¡¬æ­¢æŸæ¬¡æ•°',
    hard_stop_loss_amount_7d DECIMAL(20,2) DEFAULT 0 COMMENT '7å¤©å†…ç¡¬æ­¢æŸæ€»äºæŸ',
    total_trades_7d INT DEFAULT 0 COMMENT '7å¤©å†…æ€»äº¤æ˜“æ•°',
    win_rate_7d DECIMAL(5,2) DEFAULT 0 COMMENT '7å¤©å†…èƒœç‡',

    -- é…ç½®å‚æ•°
    margin_multiplier DECIMAL(5,2) DEFAULT 1.0 COMMENT 'ä¿è¯é‡‘å€æ•° (0=ç¦æ­¢, 0.125/0.25/1.0)',
    score_threshold_bonus INT DEFAULT 0 COMMENT 'å¼€ä»“è¯„åˆ†åŠ æˆ (0/5/10)',

    reason TEXT COMMENT 'åˆ†çº§åŸå› ',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY (symbol),
    INDEX idx_level (blacklist_level),
    INDEX idx_updated (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='äº¤æ˜“å¯¹è¯„çº§è¡¨';
```

#### **ä¼˜åŒ–å™¨é€»è¾‘ï¼ˆæ”¯æŒåŠ¨æ€å‡é™çº§ï¼‰**

```python
def update_symbol_rating():
    """æ¯å¤©å‡Œæ™¨æ›´æ–°äº¤æ˜“å¯¹è¯„çº§ï¼Œæ”¯æŒåŠ¨æ€å‡é™çº§"""

    for symbol in all_symbols:
        # ç»Ÿè®¡æœ€è¿‘7å¤©æ•°æ®
        stats = get_symbol_stats_7d(symbol)
        count = stats['hard_stop_loss_count']
        amount = stats['hard_stop_loss_amount']
        win_rate = stats['win_rate']
        total_pnl = stats['total_pnl']
        recent_3d_count = stats['hard_stop_loss_count_3d']  # æœ€è¿‘3å¤©

        # è·å–å½“å‰ç­‰çº§
        current_rating = get_current_rating(symbol)
        current_level = current_rating['blacklist_level'] if current_rating else 0

        # === åˆ¤æ–­æ–°ç­‰çº§ ===
        new_level = current_level  # é»˜è®¤ä¿æŒ

        # é»‘åå•3çº§ï¼šæ°¸ä¹…ç¦æ­¢ï¼ˆä¸å¯å‡çº§ï¼‰
        if current_level == 3:
            new_level = 3
            reason = f"æ°¸ä¹…ç¦æ­¢äº¤æ˜“ (å†å²ç¡¬æ­¢æŸ{count}æ¬¡ï¼ŒäºæŸ{amount:.2f}U)"

        # é™çº§åˆ¤æ–­ï¼ˆæ€§èƒ½æ¶åŒ–ï¼‰
        elif count >= 8 or amount < -300:
            new_level = 3  # é™åˆ°é»‘åå•3çº§
            reason = f"é™çº§åˆ°é»‘åå•3çº§: ç¡¬æ­¢æŸ{count}æ¬¡ï¼ŒäºæŸ{amount:.2f}U"

        elif count >= 5 or amount < -200 or win_rate < 0.3:
            if current_level < 2:
                new_level = 2  # é™åˆ°é»‘åå•2çº§
                reason = f"é™çº§åˆ°é»‘åå•2çº§: ç¡¬æ­¢æŸ{count}æ¬¡ï¼ŒäºæŸ{amount:.2f}Uï¼Œèƒœç‡{win_rate:.1%}"
            else:
                new_level = 2
                reason = f"ä¿æŒé»‘åå•2çº§: ç¡¬æ­¢æŸ{count}æ¬¡ï¼ŒäºæŸ{amount:.2f}U"

        elif count >= 3 or amount < -100 or win_rate < 0.4:
            if current_level == 0:
                new_level = 1  # é™åˆ°é»‘åå•1çº§
                reason = f"é™çº§åˆ°é»‘åå•1çº§: ç¡¬æ­¢æŸ{count}æ¬¡ï¼ŒäºæŸ{amount:.2f}Uï¼Œèƒœç‡{win_rate:.1%}"
            elif current_level > 1:
                # é»‘åå•2çº§ å¯èƒ½å‡çº§åˆ°1çº§
                if recent_3d_count < 3 and count < 5 and win_rate > 0.4:
                    new_level = 1
                    reason = f"å‡çº§åˆ°é»‘åå•1çº§: è¿‘3å¤©æ”¹å–„ï¼Œç¡¬æ­¢æŸ{recent_3d_count}æ¬¡"
                else:
                    new_level = 2
                    reason = f"ä¿æŒé»‘åå•2çº§: æ”¹å–„ä¸è¶³"
            else:
                new_level = 1
                reason = f"ä¿æŒé»‘åå•1çº§: ç¡¬æ­¢æŸ{count}æ¬¡"

        # å‡çº§åˆ¤æ–­ï¼ˆæ€§èƒ½æ”¹å–„ï¼‰
        else:
            if current_level == 1:
                # é»‘åå•1çº§ â†’ ç™½åå•
                if recent_3d_count < 6 and win_rate > 0.5 and total_pnl > 0:
                    new_level = 0
                    reason = f"å‡çº§åˆ°ç™½åå•: è¿‘3å¤©æ”¹å–„ï¼Œèƒœç‡{win_rate:.1%}ï¼Œç›ˆåˆ©{total_pnl:.2f}U"
                else:
                    new_level = 1
                    reason = f"ä¿æŒé»‘åå•1çº§: æ”¹å–„ä¸è¶³"
            else:
                new_level = 0  # ç™½åå•
                reason = "æ­£å¸¸è¡¨ç°"

        # é…ç½®å‚æ•°
        if new_level == 3:
            margin_mult = 0
            score_bonus = 999
        elif new_level == 2:
            margin_mult = 0.125  # 50/400
            score_bonus = 10
        elif new_level == 1:
            margin_mult = 0.25  # 100/400
            score_bonus = 5
        else:
            margin_mult = 1.0
            score_bonus = 0

        # è®°å½•å‡é™çº§
        if new_level != current_level:
            logger.warning(
                f"[RATING_CHANGE] {symbol}: "
                f"é»‘åå•{current_level}çº§ â†’ {new_level}çº§ | {reason}"
            )

        # æ›´æ–°æ•°æ®åº“
        update_or_insert_rating(symbol, new_level, margin_mult, score_bonus, reason, stats)
```

#### **å¼€ä»“æ—¶è¯»å–è¯„çº§**

```python
def open_position(opportunity):
    """å¼€ä»“å‰æ£€æŸ¥äº¤æ˜“å¯¹è¯„çº§"""
    symbol = opportunity['symbol']
    score = opportunity['score']

    # è¯»å–è¯„çº§
    rating = get_symbol_rating(symbol)

    # æ£€æŸ¥æ˜¯å¦ç¦æ­¢äº¤æ˜“
    if rating['blacklist_level'] == 3:
        logger.warning(f"[SKIP] {symbol} é»‘åå•3çº§ï¼Œç¦æ­¢äº¤æ˜“: {rating['reason']}")
        return

    # æ£€æŸ¥è¯„åˆ†æ˜¯å¦è¾¾æ ‡
    required_score = 30 + rating['score_threshold_bonus']
    if score < required_score:
        logger.info(f"[SKIP] {symbol} è¯„åˆ†{score}ä½äºé»‘åå•{rating['blacklist_level']}çº§è¦æ±‚({required_score}åˆ†)")
        return

    # è°ƒæ•´ä¿è¯é‡‘
    base_margin = 400
    margin = base_margin * rating['margin_multiplier']

    if rating['blacklist_level'] > 0:
        logger.warning(
            f"[BLACKLIST] {symbol} é»‘åå•{rating['blacklist_level']}çº§ | "
            f"ä¿è¯é‡‘{margin}U | è¦æ±‚{required_score}åˆ† | {rating['reason']}"
        )

    # å¼€ä»“
    ...
```

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|-----|------|--------|------|
| ç¡¬æ­¢æŸæ¬¡æ•° | 10æ¬¡/å¤© | 3-5æ¬¡/å¤© | -50% |
| ç¡¬æ­¢æŸäºæŸ | -$411/å¤© | -$100/å¤© | -75% |
| é—®é¢˜äº¤æ˜“å¯¹è¯†åˆ« | æ—  | è‡ªåŠ¨åˆ†çº§ | +100% |
| é£é™©æ§åˆ¶ | è¢«åŠ¨æ­¢æŸ | ä¸»åŠ¨é™çº§ | +100% |

**ç¤ºä¾‹**:
```
ALGO/USDT: 7å¤©ç¡¬æ­¢æŸ6æ¬¡ï¼ŒäºæŸ-$220 â†’ é»‘åå•2çº§ï¼Œä¿è¯é‡‘50Uï¼Œè¦æ±‚40åˆ†
LTC/USDT: 7å¤©ç¡¬æ­¢æŸ4æ¬¡ï¼ŒäºæŸ-$150 â†’ é»‘åå•1çº§ï¼Œä¿è¯é‡‘100Uï¼Œè¦æ±‚35åˆ†
BTC/USDT: 7å¤©ç¡¬æ­¢æŸ1æ¬¡ï¼ŒäºæŸ-$30 â†’ ç™½åå•ï¼Œä¿è¯é‡‘400Uï¼Œè¦æ±‚30åˆ†
```

---

## âœ… é—®é¢˜3: hedge_loss_cut (å¯¹å†²æ­¢æŸ) - é™ä½å¯¹å†²æˆæœ¬

### é—®é¢˜æè¿°

- **å½“å‰è¡¨ç°**: 8ç¬”å¯¹å†²æ­¢æŸï¼Œ**èƒœç‡0%**ï¼Œå¹³å‡äºæŸ$-15.69ï¼Œæ€»äºæŸ$-125.50
- **æ ¸å¿ƒè®¤çŸ¥**: å¯¹å†²æ˜¯**ç”¨å°æˆæœ¬è¯•æ¢æ–¹å‘**ï¼ŒäºæŸæ˜¯å¿…ç„¶ï¼Œä½†è¦æ§åˆ¶æˆæœ¬
- **å½“å‰é—®é¢˜**: å¯¹å†²å•ä¿è¯é‡‘400Uï¼Œæˆæœ¬å¤ªé«˜

### å¯¹å†²äº§ç”Ÿåœºæ™¯åˆ†æ

#### **å¯¹å†²äº§ç”Ÿé€»è¾‘** (smart_trader_service.py:1708-1741)

```python
# åœºæ™¯ï¼šBTCå·²æœ‰LONGæŒä»“(è¯„åˆ†35)ï¼Œç°åœ¨å‡ºç°SHORTä¿¡å·(è¯„åˆ†40)

# 1. æ£€æŸ¥åå‘æŒä»“
if self.has_position(symbol, opposite_side):
    old_score = self.get_position_score(symbol, opposite_side)  # 35åˆ†

    # æƒ…å†µA: æ–°ä¿¡å·æ¯”æ—§ä¿¡å·å¼º30åˆ†ä»¥ä¸Š â†’ åè½¬å¹³ä»“
    if new_score > old_score + 30:  # 40 > 35+30? NO
        close_position_by_side(opposite_side)
        open_position(new_opp)

    # æƒ…å†µB: æ–°ä¿¡å·ä¸å¤Ÿå¼º â†’ å…è®¸å¯¹å†²
    else:  # å·®è·åªæœ‰5åˆ†
        logger.info("[HEDGE] å…è®¸å¯¹å†²")
        open_position(new_opp)  # å¼€400Uçš„SHORT
```

**é—®é¢˜**:
- åè½¬é˜ˆå€¼30åˆ†å¤ªé«˜ï¼Œå¯¼è‡´å¾ˆå¤šæœ¬è¯¥åè½¬çš„ä¿¡å·å˜æˆå¯¹å†²
- å¯¹å†²å•400Uä¿è¯é‡‘ï¼Œæˆæœ¬å¤ªé«˜
- æ•°æ®æ˜¾ç¤ºï¼š21åˆ†å·®è·èƒœç‡87.5%ï¼Œä½†ä»£ç è¦æ±‚30åˆ†

### ä¼˜åŒ–æ–¹æ¡ˆ âœ… **å·²ç¡®è®¤**

#### **æ–¹æ¡ˆ1: é™ä½åè½¬é˜ˆå€¼ï¼ˆä»30åˆ†é™åˆ°15åˆ†ï¼‰**

```python
# ä¿®æ”¹ä»£ç 
if new_score > old_score + 15:  # ä»30æ”¹ä¸º15
    logger.info(
        f"[REVERSE] {symbol} å¼ºåå‘ä¿¡å·! "
        f"åŸ{opposite_side}å¾—åˆ†{old_score}, æ–°{new_side}å¾—åˆ†{new_score} (å·®è·{new_score-old_score}åˆ†)"
    )

    # åè½¬å¹³ä»“
    close_position_by_side(opposite_side, reason='reverse_signal')

    # å¼€æ–°æ–¹å‘ï¼ˆæ­£å¸¸ä¿è¯é‡‘400Uï¼‰
    open_position(opp)
```

**æ•ˆæœ**:
- åŸæ¥100ä¸ªåå‘ä¿¡å· â†’ 80ä¸ªå¯¹å†²ï¼Œ20ä¸ªåè½¬
- ä¼˜åŒ–å100ä¸ªåå‘ä¿¡å· â†’ 40ä¸ªå¯¹å†²ï¼Œ60ä¸ªåè½¬
- **å¯¹å†²å‡å°‘50%**

#### **æ–¹æ¡ˆ2: é™ä½å¯¹å†²ä¿è¯é‡‘ï¼ˆ400U â†’ 100Uï¼‰**

```python
# åå‘ä¿¡å·ä¸å¤Ÿå¼ºï¼Œå…è®¸å¯¹å†²ä½†é™ä½æˆæœ¬
else:
    logger.info(
        f"[HEDGE] {symbol} å·²æœ‰{opposite_side}(å¾—åˆ†{old_score})æŒä»“, "
        f"æ–°{new_side}å¾—åˆ†{new_score}æœªè¾¾åè½¬é˜ˆå€¼(éœ€>{old_score+15}), è¯•æ¢æ€§å¯¹å†²"
    )

    # é™ä½å¯¹å†²å•ä¿è¯é‡‘åˆ°25% (400 â†’ 100)
    base_margin = opp.get('margin', 400)
    opp['margin'] = base_margin * 0.25
    opp['is_hedge'] = True  # æ ‡è®°ä¸ºå¯¹å†²å•

    logger.info(f"[HEDGE] å¯¹å†²å•ä¿è¯é‡‘é™ä½åˆ° {opp['margin']} USDT (25%)")

    # å¼€ä»“
    open_position(opp)
```

**æ³¨æ„**: éœ€è¦åœ¨ `open_position` æ–¹æ³•ä¸­æ”¯æŒè‡ªå®šä¹‰ä¿è¯é‡‘ï¼š

```python
def open_position(self, opportunity):
    """å¼€ä»“"""
    # æ”¯æŒè‡ªå®šä¹‰ä¿è¯é‡‘
    margin = opportunity.get('margin', 400)
    is_hedge = opportunity.get('is_hedge', False)

    if is_hedge:
        logger.info(f"[HEDGE] è¯•æ¢æ€§å¯¹å†²å•ï¼Œä¿è¯é‡‘{margin}U")

    # å…¶ä»–é€»è¾‘ä¸å˜
    ...
```

#### **é»‘åå•äº¤æ˜“å¯¹çš„å¯¹å†²ä¿è¯é‡‘**

```python
# é»‘åå•äº¤æ˜“å¯¹çš„å¯¹å†²å•ä¿è¯é‡‘è¿›ä¸€æ­¥é™ä½
é»‘åå•0çº§(ç™½åå•): 400U â†’ å¯¹å†²100U (25%)
é»‘åå•1çº§: 100U â†’ å¯¹å†²25U (25%)
é»‘åå•2çº§: 50U â†’ å¯¹å†²12.5U (25%)
é»‘åå•3çº§: ç¦æ­¢äº¤æ˜“ï¼Œä¸ä¼šäº§ç”Ÿå¯¹å†²
```

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | æ–¹æ¡ˆ1æ•ˆæœ | æ–¹æ¡ˆ1+2æ•ˆæœ | æ€»æ”¹å–„ |
|-----|------|---------|-----------|--------|
| å¯¹å†²äº§ç”Ÿæ•°é‡ | 80ç¬”/å‘¨ | 40ç¬”/å‘¨ | 40ç¬”/å‘¨ | -50% |
| å•æ¬¡å¯¹å†²æˆæœ¬ | 400U | 400U | 100U | -75% |
| å¯¹å†²å¹³å‡äºæŸ | -$15.69 | -$15.69 | -$3.92 | -75% |
| å¯¹å†²æ€»äºæŸ(8ç¬”) | -$125 | -$63 | -$31 | -75% |
| **ç»¼åˆæ•ˆæœ** | -$1,255/å‘¨ | -$628/å‘¨ | -$157/å‘¨ | **-87.5%** |

**è®¡ç®—é€»è¾‘**:
```
å‡è®¾åŸæ¥100ä¸ªåå‘ä¿¡å·äº§ç”Ÿ80ç¬”å¯¹å†²:
- å½“å‰: 80ç¬” Ã— $15.69 = -$1,255

æ–¹æ¡ˆ1 (é™ä½é˜ˆå€¼):
- å¯¹å†²å‡å°‘50%: 40ç¬” Ã— $15.69 = -$628

æ–¹æ¡ˆ1+2 (é™ä½é˜ˆå€¼+é™ä½ä¿è¯é‡‘):
- å¯¹å†²å‡å°‘50%: 40ç¬”
- æˆæœ¬é™ä½75%: $15.69 Ã— 0.25 = $3.92
- æ€»äºæŸ: 40ç¬” Ã— $3.92 = -$157

æ€»èŠ‚çœ: $1,255 - $157 = $1,098 (87.5%)
```

---

## âœ… é—®é¢˜4: æ­¢ç›ˆè§¦å‘ç‡ä½ - åŸºäº15M Kçº¿é˜³çº¿/é˜´çº¿ç»Ÿè®¡

### é—®é¢˜æè¿°

- **å½“å‰è¡¨ç°**: 30ç¬”äº¤æ˜“åªæœ‰1ç¬”è§¦å‘æ­¢ç›ˆï¼Œè§¦å‘ç‡<5%
- **å½“å‰é…ç½®**: ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»é˜ˆå€¼8%ï¼Œå›æ’¤2%å¹³ä»“
- **æ ¸å¿ƒé—®é¢˜**: 8%æ¿€æ´»é˜ˆå€¼å¤ªé«˜ï¼Œå¾ˆå°‘è¾¾åˆ°
  - æœ€å¥½çš„ç›ˆåˆ©å•æ‰+36.21 USDT (9.46%)
  - å¤§éƒ¨åˆ†ç›ˆåˆ©å•åœ¨1-3%å°±4å°æ—¶è¶…æ—¶äº†

### ä¼˜åŒ–æ–¹æ¡ˆ âœ… **å·²ç¡®è®¤**

#### **æ–¹æ¡ˆ: åŸºäºæœ€è¿‘10æ ¹15Mé˜³çº¿/é˜´çº¿ç»Ÿè®¡æ³¢åŠ¨å¹…åº¦**

**æ ¸å¿ƒæ€æƒ³**:
- ä½¿ç”¨15M Kçº¿ï¼ˆæ›´è´´è¿‘äº¤æ˜“èŠ‚å¥ï¼Œ1Hå¤ªç²—ç³™ï¼‰
- åšå¤šåªç»Ÿè®¡é˜³çº¿ï¼ˆä¸Šæ¶¨ç©ºé—´ï¼‰
- åšç©ºåªç»Ÿè®¡é˜´çº¿ï¼ˆä¸‹è·Œç©ºé—´ï¼‰
- æœ€è¿‘10æ ¹ï¼ˆ2.5å°æ—¶æ•°æ®ï¼Œè¶³å¤Ÿæ–°é²œï¼‰

```python
def calculate_optimal_take_profit(symbol, period='15m', lookback_bars=20):
    """
    åŸºäºæœ€è¿‘Næ ¹15M Kçº¿ç»Ÿè®¡æ³¢åŠ¨å¹…åº¦ï¼Œåšå¤šåªçœ‹é˜³çº¿ï¼Œåšç©ºåªçœ‹é˜´çº¿

    Args:
        symbol: äº¤æ˜“å¯¹
        period: Kçº¿å‘¨æœŸ(15m)
        lookback_bars: å›æº¯Kçº¿æ•°é‡(20æ ¹=5å°æ—¶ï¼Œä»ä¸­ç­›é€‰10æ ¹é˜³çº¿/é˜´çº¿)

    Returns:
        è¯¥äº¤æ˜“å¯¹çš„æœ€ä¼˜æ­¢ç›ˆå‚æ•°
    """
    # è·å–æœ€è¿‘20æ ¹15M Kçº¿
    klines = get_klines(symbol, '15m', limit=20)

    # åˆ†ç¦»é˜³çº¿å’Œé˜´çº¿
    bullish_candles = []  # é˜³çº¿ï¼ˆæ”¶ç›˜>å¼€ç›˜ï¼‰
    bearish_candles = []  # é˜´çº¿ï¼ˆæ”¶ç›˜<å¼€ç›˜ï¼‰

    for kline in klines:
        open_price = float(kline['open_price'])
        close_price = float(kline['close_price'])
        high_price = float(kline['high_price'])
        low_price = float(kline['low_price'])

        if close_price > open_price:
            # é˜³çº¿ï¼šåšå¤šæœºä¼š
            # è®¡ç®—ä»å¼€ç›˜åˆ°æœ€é«˜ç‚¹çš„æ¶¨å¹…
            long_range = (high_price - open_price) / open_price * 100
            bullish_candles.append(long_range)

        elif close_price < open_price:
            # é˜´çº¿ï¼šåšç©ºæœºä¼š
            # è®¡ç®—ä»å¼€ç›˜åˆ°æœ€ä½ç‚¹çš„è·Œå¹…
            short_range = (open_price - low_price) / open_price * 100
            bearish_candles.append(short_range)

    # å–æœ€è¿‘10æ ¹é˜³çº¿/é˜´çº¿ï¼ˆå¦‚æœä¸è¶³10æ ¹ï¼Œç”¨å…¨éƒ¨ï¼‰
    recent_bullish = sorted(bullish_candles, reverse=True)[:10]
    recent_bearish = sorted(bearish_candles, reverse=True)[:10]

    # è®¡ç®—å¹³å‡å€¼
    long_avg = np.mean(recent_bullish) if recent_bullish else 2.0
    short_avg = np.mean(recent_bearish) if recent_bearish else 2.0

    # æ­¢ç›ˆç­–ç•¥
    # 1. å›ºå®šæ­¢ç›ˆï¼šå¹³å‡å€¼çš„70%ï¼ˆå¿«é€Ÿè·åˆ©ï¼‰
    long_take_profit = long_avg * 0.7
    short_take_profit = short_avg * 0.7

    # 2. ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»ï¼šå¹³å‡å€¼çš„50%ï¼ˆè®©åˆ©æ¶¦å¥”è·‘ï¼‰
    long_trailing_activation = long_avg * 0.5
    short_trailing_activation = short_avg * 0.5

    # 3. ç§»åŠ¨æ­¢ç›ˆå›æ’¤ï¼šå›ºå®š1.5%
    trailing_callback = 1.5

    return {
        'symbol': symbol,
        'timeframe': period,

        # åšå¤šå‚æ•°
        'long_avg_range': round(long_avg, 2),
        'long_take_profit': round(long_take_profit, 2),
        'long_trailing_activation': round(long_trailing_activation, 2),
        'long_sample_size': len(recent_bullish),

        # åšç©ºå‚æ•°
        'short_avg_range': round(short_avg, 2),
        'short_take_profit': round(short_take_profit, 2),
        'short_trailing_activation': round(short_trailing_activation, 2),
        'short_sample_size': len(recent_bearish),

        # é€šç”¨å‚æ•°
        'trailing_callback': trailing_callback
    }
```

**åº”ç”¨ç¤ºä¾‹**:
```python
# BTC/USDT ç»Ÿè®¡ç»“æœï¼ˆæœ€è¿‘10æ ¹15Mé˜³çº¿ï¼‰
{
    'long_avg_range': 1.8%,  # é˜³çº¿å¹³å‡æ¶¨å¹…1.8%
    'long_take_profit': 1.26%,  # å›ºå®šæ­¢ç›ˆ1.26% (70%)
    'long_trailing_activation': 0.9%,  # ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»0.9% (50%)
    'long_sample_size': 10
}

# HYPE/USDT ç»Ÿè®¡ç»“æœï¼ˆæœ€è¿‘10æ ¹15Mé˜³çº¿ï¼‰
{
    'long_avg_range': 3.5%,  # é˜³çº¿å¹³å‡æ¶¨å¹…3.5%
    'long_take_profit': 2.45%,  # å›ºå®šæ­¢ç›ˆ2.45% (70%)
    'long_trailing_activation': 1.75%,  # ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»1.75% (50%)
    'long_sample_size': 10
}

# ALGO/USDT SHORTç»Ÿè®¡ç»“æœï¼ˆæœ€è¿‘10æ ¹15Mé˜´çº¿ï¼‰
{
    'short_avg_range': 2.1%,  # é˜´çº¿å¹³å‡è·Œå¹…2.1%
    'short_take_profit': 1.47%,  # å›ºå®šæ­¢ç›ˆ1.47% (70%)
    'short_trailing_activation': 1.05%,  # ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»1.05% (50%)
    'short_sample_size': 10
}
```

**è¯´æ˜**:
- 15M Kçº¿æ›´è´´è¿‘å®é™…äº¤æ˜“èŠ‚å¥ï¼ˆ1æ ¹=15åˆ†é’Ÿï¼‰
- åªç»Ÿè®¡é˜³çº¿/é˜´çº¿ï¼Œé¿å…éœ‡è¡Kçº¿å¹²æ‰°
- 10æ ¹æ ·æœ¬ = æœ€è¿‘5å°æ—¶å†…çš„é˜³çº¿/é˜´çº¿ï¼Œæ•°æ®è¶³å¤Ÿæ–°é²œ
- å¦‚æœé˜³çº¿/é˜´çº¿ä¸è¶³10æ ¹ï¼Œä½¿ç”¨å…¨éƒ¨ï¼ˆæœ€å°‘3æ ¹ï¼‰

#### **æ•°æ®åº“è¡¨ç»“æ„**

```sql
CREATE TABLE IF NOT EXISTS symbol_volatility_profile (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,
    timeframe VARCHAR(10) DEFAULT '15m' COMMENT 'Kçº¿å‘¨æœŸ',

    -- åšå¤šç»Ÿè®¡ï¼ˆåŸºäºé˜³çº¿ï¼‰
    long_avg_range_pct DECIMAL(10,4) COMMENT 'é˜³çº¿å¹³å‡æ¶¨å¹…(%)',
    long_take_profit_pct DECIMAL(10,4) COMMENT 'åšå¤šå›ºå®šæ­¢ç›ˆ(%) = avg * 0.7',
    long_trailing_activation_pct DECIMAL(10,4) COMMENT 'åšå¤šç§»åŠ¨æ­¢ç›ˆæ¿€æ´»(%) = avg * 0.5',
    long_sample_size INT COMMENT 'é˜³çº¿æ ·æœ¬æ•°é‡',

    -- åšç©ºç»Ÿè®¡ï¼ˆåŸºäºé˜´çº¿ï¼‰
    short_avg_range_pct DECIMAL(10,4) COMMENT 'é˜´çº¿å¹³å‡è·Œå¹…(%)',
    short_take_profit_pct DECIMAL(10,4) COMMENT 'åšç©ºå›ºå®šæ­¢ç›ˆ(%) = avg * 0.7',
    short_trailing_activation_pct DECIMAL(10,4) COMMENT 'åšç©ºç§»åŠ¨æ­¢ç›ˆæ¿€æ´»(%) = avg * 0.5',
    short_sample_size INT COMMENT 'é˜´çº¿æ ·æœ¬æ•°é‡',

    -- é€šç”¨å‚æ•°
    trailing_callback_pct DECIMAL(10,4) DEFAULT 1.5 COMMENT 'ç§»åŠ¨æ­¢ç›ˆå›æ’¤(%)',

    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY (symbol, timeframe),
    INDEX idx_symbol (symbol),
    INDEX idx_updated (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='äº¤æ˜“å¯¹æ³¢åŠ¨ç‰¹å¾è¡¨(15Mé˜³çº¿/é˜´çº¿ç»Ÿè®¡)';
```

#### **ä¼˜åŒ–å™¨æ¯å°æ—¶æ›´æ–°**

```python
def update_volatility_profiles():
    """
    æ¯å°æ—¶æ›´æ–°æ‰€æœ‰äº¤æ˜“å¯¹çš„æ³¢åŠ¨ç‰¹å¾
    15M Kçº¿æ•°æ®å˜åŒ–å¿«ï¼Œéœ€è¦æ›´é¢‘ç¹æ›´æ–°
    """

    for symbol in all_symbols:
        try:
            # è®¡ç®—æ³¢åŠ¨ç‰¹å¾ï¼ˆæœ€è¿‘20æ ¹15M Kçº¿ï¼Œç­›é€‰10æ ¹é˜³çº¿/é˜´çº¿ï¼‰
            profile = calculate_optimal_take_profit(symbol, '15m', 20)

            # ä¿å­˜åˆ°æ•°æ®åº“
            conn.execute("""
                INSERT INTO symbol_volatility_profile
                (symbol, timeframe,
                 long_avg_range_pct, long_take_profit_pct, long_trailing_activation_pct, long_sample_size,
                 short_avg_range_pct, short_take_profit_pct, short_trailing_activation_pct, short_sample_size,
                 trailing_callback_pct)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                ON DUPLICATE KEY UPDATE
                    long_avg_range_pct = VALUES(long_avg_range_pct),
                    long_take_profit_pct = VALUES(long_take_profit_pct),
                    long_trailing_activation_pct = VALUES(long_trailing_activation_pct),
                    long_sample_size = VALUES(long_sample_size),
                    short_avg_range_pct = VALUES(short_avg_range_pct),
                    short_take_profit_pct = VALUES(short_take_profit_pct),
                    short_trailing_activation_pct = VALUES(short_trailing_activation_pct),
                    short_sample_size = VALUES(short_sample_size),
                    trailing_callback_pct = VALUES(trailing_callback_pct),
                    updated_at = NOW()
            """, (
                symbol, '15m',
                profile['long_avg_range'], profile['long_take_profit'],
                profile['long_trailing_activation'], profile['long_sample_size'],
                profile['short_avg_range'], profile['short_take_profit'],
                profile['short_trailing_activation'], profile['short_sample_size'],
                profile['trailing_callback']
            ))

            logger.info(
                f"[PROFILE] {symbol} æ³¢åŠ¨ç‰¹å¾å·²æ›´æ–° | "
                f"LONG: é˜³çº¿avg={profile['long_avg_range']:.2f}%, æ­¢ç›ˆ={profile['long_take_profit']:.2f}%, "
                f"ç§»åŠ¨={profile['long_trailing_activation']:.2f}% (æ ·æœ¬{profile['long_sample_size']}) | "
                f"SHORT: é˜´çº¿avg={profile['short_avg_range']:.2f}%, æ­¢ç›ˆ={profile['short_take_profit']:.2f}%, "
                f"ç§»åŠ¨={profile['short_trailing_activation']:.2f}% (æ ·æœ¬{profile['short_sample_size']})"
            )

        except Exception as e:
            logger.error(f"[PROFILE] {symbol} æ›´æ–°å¤±è´¥: {e}")
```

#### **äº¤æ˜“æ—¶è¯»å–æ­¢ç›ˆå‚æ•°**

```python
def get_take_profit_params(symbol, direction):
    """è·å–äº¤æ˜“å¯¹çš„æ­¢ç›ˆå‚æ•°"""

    # ä»æ•°æ®åº“è¯»å–
    profile = db.query("""
        SELECT * FROM symbol_volatility_profile
        WHERE symbol = %s AND timeframe = '1h'
    """, (symbol,))

    if not profile:
        # é™çº§åˆ°é»˜è®¤å€¼
        logger.warning(f"{symbol} æ— æ³¢åŠ¨ç‰¹å¾ï¼Œä½¿ç”¨é»˜è®¤å€¼")
        return {
            'take_profit': 2.0,
            'trailing_activation': 4.0,
            'trailing_callback': 1.5
        }

    if direction == 'LONG':
        return {
            'take_profit': profile['long_take_profit_pct'],
            'trailing_activation': profile['long_trailing_activation_pct'],
            'trailing_callback': profile['long_trailing_callback_pct']
        }
    else:  # SHORT
        return {
            'take_profit': profile['short_take_profit_pct'],
            'trailing_activation': profile['short_trailing_activation_pct'],
            'trailing_callback': profile['short_trailing_callback_pct']
        }
```

### é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | å½“å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|-----|------|--------|------|
| ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»é˜ˆå€¼ | å›ºå®š8% | åŠ¨æ€1.4-4% | -50% |
| æ­¢ç›ˆè§¦å‘ç‡ | <5% (1/30) | 30-40% | +600% |
| å›ºå®šæ­¢ç›ˆ | æ—  | åŠ¨æ€2-4% | æ–°å¢ |
| å¹³å‡ç›ˆåˆ©å•ç›ˆåˆ© | $4.96 | $8-12 | +100% |

**ç¤ºä¾‹**:
```
BTC/USDT LONG: æœ€è¿‘10æ ¹é˜³çº¿avg=1.8% â†’ å›ºå®šæ­¢ç›ˆ1.26%, ç§»åŠ¨æ¿€æ´»0.9%
ETH/USDT LONG: æœ€è¿‘10æ ¹é˜³çº¿avg=2.1% â†’ å›ºå®šæ­¢ç›ˆ1.47%, ç§»åŠ¨æ¿€æ´»1.05%
HYPE/USDT LONG: æœ€è¿‘10æ ¹é˜³çº¿avg=3.5% â†’ å›ºå®šæ­¢ç›ˆ2.45%, ç§»åŠ¨æ¿€æ´»1.75%
ALGO/USDT SHORT: æœ€è¿‘10æ ¹é˜´çº¿avg=2.1% â†’ å›ºå®šæ­¢ç›ˆ1.47%, ç§»åŠ¨æ¿€æ´»1.05%
```

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: ç«‹å³å®æ–½ï¼ˆå·²ç¡®è®¤ï¼‰

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡è€—æ—¶ | è´Ÿè´£æ¨¡å— |
|-----|--------|---------|---------|
| âœ… é—®é¢˜1-æ–¹æ¡ˆ1: åŠ¨æ€è¶…æ—¶æ—¶é—´ | ğŸ”´ é«˜ | 2å°æ—¶ | smart_auto_trader.py, æ•°æ®åº“ |
| âœ… é—®é¢˜1-æ–¹æ¡ˆ2: åˆ†é˜¶æ®µè¶…æ—¶ | ğŸ”´ é«˜ | 1å°æ—¶ | smart_auto_trader.py |
| âœ… é—®é¢˜2: é»‘åå•åˆ†çº§åˆ¶åº¦ | ğŸ”´ é«˜ | 3å°æ—¶ | adaptive_optimizer.py, æ•°æ®åº“ |
| âœ… é—®é¢˜3-æ–¹æ¡ˆ1: é™ä½åè½¬é˜ˆå€¼ | ğŸ”´ é«˜ | 10åˆ†é’Ÿ | smart_trader_service.py |
| âœ… é—®é¢˜3-æ–¹æ¡ˆ2: é™ä½å¯¹å†²ä¿è¯é‡‘ | ğŸ”´ é«˜ | 30åˆ†é’Ÿ | smart_trader_service.py |

**é¢„æœŸæ•ˆæœ**:
- å¯¹å†²äºæŸå‡å°‘87.5% (-$1,098/å‘¨)
- ç¡¬æ­¢æŸäºæŸå‡å°‘75% (-$311/å¤©)
- è¶…æ—¶å¹³ä»“èƒœç‡æå‡åˆ°60%+

### é˜¶æ®µ2: å¾…ç¡®è®¤åå®æ–½

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡è€—æ—¶ | è´Ÿè´£æ¨¡å— |
|-----|--------|---------|---------|
| âœ… é—®é¢˜4: 15Mé˜³çº¿/é˜´çº¿ç»Ÿè®¡æ­¢ç›ˆ | ğŸŸ¡ ä¸­ | 4å°æ—¶ | adaptive_optimizer.py, æ•°æ®åº“ |

**å·²ç¡®è®¤æ–¹æ¡ˆ**:
1. âœ… ä½¿ç”¨15M Kçº¿ï¼ˆè´´è¿‘äº¤æ˜“èŠ‚å¥ï¼‰
2. âœ… åšå¤šç»Ÿè®¡é˜³çº¿ï¼Œåšç©ºç»Ÿè®¡é˜´çº¿ï¼ˆç²¾å‡†ç»Ÿè®¡ï¼‰
3. âœ… æœ€è¿‘10æ ¹é˜³çº¿/é˜´çº¿ï¼ˆçº¦2.5å°æ—¶æ•°æ®ï¼‰
4. âœ… å›ºå®šæ­¢ç›ˆ=avg*0.7, ç§»åŠ¨æ¿€æ´»=avg*0.5

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å®æ–½åéœ€è¦æŒç»­ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

### æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | ç›‘æ§é¢‘ç‡ |
|-----|--------|--------|---------|
| **æ•´ä½“èƒœç‡** | 56.7% | 65%+ | æ¯æ—¥ |
| **ç›ˆäºæ¯”** | 1.60:1 | 2.0:1+ | æ¯æ—¥ |
| **æ—¥å‡ç›ˆåˆ©** | $31.64 | $100+ | æ¯æ—¥ |

### åˆ†é¡¹æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | ç›‘æ§é¢‘ç‡ |
|-----|--------|--------|---------|
| TIMEOUT_4Hæ•°é‡ | 47ç¬”/å¤© | 20-25ç¬”/å¤© | æ¯æ—¥ |
| TIMEOUT_4Hèƒœç‡ | 51.1% | 60%+ | æ¯æ—¥ |
| hard_stop_lossæ•°é‡ | 10ç¬”/å¤© | 3-5ç¬”/å¤© | æ¯æ—¥ |
| hard_stop_lossäºæŸ | -$411/å¤© | -$100/å¤© | æ¯æ—¥ |
| hedgeå¯¹å†²æ•°é‡ | 80ç¬”/å‘¨ | 40ç¬”/å‘¨ | æ¯å‘¨ |
| hedgeå¹³å‡äºæŸ | -$15.69 | -$3.92 | æ¯å‘¨ |
| æ­¢ç›ˆè§¦å‘ç‡ | <5% | 30-40% | æ¯æ—¥ |
| é»‘åå•äº¤æ˜“å¯¹æ•° | 0ä¸ª | è‡ªåŠ¨è¯†åˆ« | æ¯æ—¥ |

---

## âœ… ç¡®è®¤æ¸…å•

### å·²ç¡®è®¤ï¼ˆå…¨éƒ¨4ä¸ªé—®é¢˜ï¼‰

- [x] **é—®é¢˜1**: åŠ¨æ€è¶…æ—¶æ—¶é—´ + åˆ†é˜¶æ®µè¶…æ—¶ç­–ç•¥
- [x] **é—®é¢˜2**: é»‘åå•3çº§åˆ¶åº¦ï¼ˆæ”¯æŒåŠ¨æ€å‡é™çº§ï¼Œé»‘åå•3çº§æ°¸ä¹…ç¦æ­¢ï¼‰
- [x] **é—®é¢˜3**: é™ä½åè½¬é˜ˆå€¼(30â†’15) + é™ä½å¯¹å†²ä¿è¯é‡‘(400â†’100)
- [x] **é—®é¢˜4**: åŸºäº15Mé˜³çº¿/é˜´çº¿ç»Ÿè®¡åŠ¨æ€æ­¢ç›ˆï¼ˆåšå¤šçœ‹é˜³çº¿ï¼Œåšç©ºçœ‹é˜´çº¿ï¼Œæœ€è¿‘10æ ¹ï¼‰

---

## ğŸ“ å¤‡æ³¨

1. **å®æ–½é¡ºåº**: æŒ‰é—®é¢˜1â†’2â†’3â†’4é¡ºåºå®æ–½ï¼Œæ¯ä¸ªé—®é¢˜å®æ–½åè§‚å¯Ÿ1-2å¤©å†ç»§ç»­
2. **å›æ»šæœºåˆ¶**: æ‰€æœ‰å‚æ•°è°ƒæ•´éƒ½è®°å½•åˆ° `optimization_history` è¡¨ï¼Œæ”¯æŒå›æ»š
3. **A/Bæµ‹è¯•**: å¯ä»¥è€ƒè™‘50%ä»“ä½ä½¿ç”¨æ–°å‚æ•°ï¼Œ50%ä½¿ç”¨æ—§å‚æ•°å¯¹æ¯”æ•ˆæœ
4. **æ•°æ®å¤‡ä»½**: å®æ–½å‰å¤‡ä»½ `futures_positions` å’Œ `futures_trades` è¡¨

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-23
**ä¸‹æ¬¡å®¡æŸ¥**: å®æ–½å®Œæˆå7å¤©
