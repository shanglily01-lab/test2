# ç§»åŠ¨æ­¢ç›ˆä¼˜åŒ–æ–¹æ¡ˆ V4.0 - åˆ†æ®µä¿æŠ¤ç­–ç•¥

> **æ–‡æ¡£ç‰ˆæœ¬**: V4.0
> **åˆ›å»ºæ—¥æœŸ**: 2026-02-08
> **çŠ¶æ€**: å¾…å®æ–½
> **ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§

---

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜è¯Šæ–­](#é—®é¢˜è¯Šæ–­)
2. [å½“å‰V3.0æ–¹æ¡ˆç¼ºé™·](#å½“å‰v30æ–¹æ¡ˆç¼ºé™·)
3. [V4.0ä¼˜åŒ–æ–¹æ¡ˆ](#v40ä¼˜åŒ–æ–¹æ¡ˆ)
4. [æ•ˆæœå¯¹æ¯”](#æ•ˆæœå¯¹æ¯”)
5. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
6. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)

---

## é—®é¢˜è¯Šæ–­

### å½“å‰V3.0ç§»åŠ¨æ­¢ç›ˆå‚æ•°

```python
# ç°æœ‰å‚æ•°ï¼ˆå­˜åœ¨ä¸¥é‡é—®é¢˜ï¼‰
TRAILING_STOP_THRESHOLD = 40  # 40Uæ¿€æ´»é—¨æ§›
TRAILING_STOP_STEP = 10       # æ¯10Uç§»åŠ¨ä¸€æ¬¡
FIXED_STOP_LOSS_PCT = 0.03    # å›ºå®šæ­¢æŸ3%
FIXED_TAKE_PROFIT_PCT = 0.06  # å›ºå®šæ­¢ç›ˆ6%
```

### æ ¸å¿ƒé—®é¢˜åˆ†æ

#### é—®é¢˜1: å¯åŠ¨é—¨æ§›è¿‡é«˜ âš ï¸âš ï¸âš ï¸

**æ•°æ®**:
- ä¿è¯é‡‘: 480U
- æ æ†: 5x
- ä»“ä½ä»·å€¼: 2,400U
- 40Uæ¿€æ´»é—¨æ§› = **1.67%** æµ®ç›ˆ

**é—®é¢˜**:
- å›ºå®šæ­¢ç›ˆ6% = 144U
- ä»40Uåˆ°144Uä¹‹é—´ï¼ˆ1.67%-6%ï¼‰æ²¡æœ‰ä¿æŠ¤
- å¦‚æœæµ®ç›ˆ38Uï¼Œå®Œå…¨æ²¡æœ‰ç§»åŠ¨æ­¢ç›ˆä¿æŠ¤
- ä»·æ ¼å›è°ƒä¼šç›´æ¥è§¦å‘å›ºå®šæ­¢æŸ-3%ï¼ŒæŸå¤±72U

**çœŸå®æ¡ˆä¾‹**:
```
14:00 å¼€ä»“ 100,000U
15:00 æ¶¨åˆ° 101,500U â†’ æµ®ç›ˆ36U (æœªè¾¾åˆ°40Ué—¨æ§›)
15:30 å›è°ƒåˆ° 100,500U â†’ æµ®ç›ˆ12U
16:00 ç»§ç»­è·Œåˆ° 97,000U â†’ è§¦å‘å›ºå®šæ­¢æŸ-3%
ç»“æœ: æµ®ç›ˆ36U â†’ äºæŸ72U (æŸå¤±108U!)
```

---

#### é—®é¢˜2: 10Uæ­¥è¿›å¤ªç²—ç³™ âš ï¸âš ï¸

**é—®é¢˜**:
```python
# å½“å‰é€»è¾‘
max_unrealized_pnl = 81.6U
protected_profit = (81.6 // 10) * 10 = 80U  # æ•´é™¤å–æ•´
buffer = 81.6 - 80 = 1.6U  # ç¼“å†²ä»…1.6U!
```

**å®é™…å½±å“**:
- ä¿è¯é‡‘480Uï¼Œ5xæ æ†ï¼Œ1.6Uç¼“å†² = **0.067%**
- BTCä»·æ ¼100,000Uï¼Œ0.067%æ³¢åŠ¨ = 67U
- **æ­£å¸¸å¸‚åœºæ³¢åŠ¨å°±ä¼šè§¦å‘æ­¢æŸ**

**çœŸå®æ¡ˆä¾‹**:
```
æœ€é«˜æµ®ç›ˆ: 81.6U
ä¿æŠ¤: 80U
æ­¢æŸä»·: 100,080U

ä»·æ ¼ç¨å¾®å›è°ƒ:
101,700U â†’ 101,200U (å›è°ƒ0.49%)
â†’ æµ®ç›ˆä»81.6U â†’ 57.6U
â†’ æ­¢æŸä»·ä¿æŒ100,080U
â†’ ç»§ç»­è·Œåˆ°100,500U
â†’ ç¼“å†²ä»…420U (0.42%)
â†’ å†è·Œ50Uå°±è§¦å‘æ­¢æŸ

ç»“æœ: æµ®ç›ˆ81.6U â†’ å¹³ä»“ä»·100,080U â†’ å®é™…ç›ˆåˆ©1.92U
åˆ©æ¶¦å›åç‡: 97.6%!
```

---

#### é—®é¢˜3: éœ‡è¡å¸‚æ€æ‰‹ âš ï¸âš ï¸âš ï¸

**åœºæ™¯**: ä»·æ ¼åœ¨101,000-102,000Uä¹‹é—´éœ‡è¡

```
15:00 æµ®ç›ˆ81.6U â†’ æ¿€æ´»ç§»åŠ¨æ­¢ç›ˆ â†’ ä¿æŠ¤80U â†’ æ­¢æŸ100,080U
15:15 ä»·æ ¼102,000U â†’ æµ®ç›ˆ96U â†’ ä¿æŠ¤90U â†’ æ­¢æŸ100,090U
15:30 å›è°ƒåˆ°101,500U â†’ æµ®ç›ˆ72U
      â†’ æœ€é«˜æµ®ç›ˆ96Uï¼Œæ­¢æŸä¿æŒ100,090U
      â†’ ç¼“å†²: 101,500 - 100,090 = 1,410U (1.39%)

15:45 ç»§ç»­å›è°ƒåˆ°101,000U â†’ æµ®ç›ˆ48U
      â†’ æ­¢æŸä¿æŒ100,090U
      â†’ ç¼“å†²: 101,000 - 100,090 = 910U (0.90%)

16:00 å†å›è°ƒåˆ°100,500U
      â†’ æµ®ç›ˆ24U
      â†’ æ­¢æŸä¿æŒ100,090U
      â†’ ç¼“å†²: 100,500 - 100,090 = 410U (0.41%)

16:05 è·Œåˆ°100,080U â†’ è§¦å‘æ­¢æŸ!
      â†’ å®é™…ç›ˆåˆ©: 1.92U

æ€»ç»“:
- ä»·æ ¼ä»102,000éœ‡è¡åˆ°100,080 (è·Œ1.88%)
- è¿™æ˜¯æ­£å¸¸çš„å¸‚åœºæ³¢åŠ¨
- ä½†å› ä¸ºç¼“å†²å¤ªå°ï¼Œè¢«æ­¢æŸå‡ºå±€
- æµ®ç›ˆ96U â†’ å®é™…èµš1.92U (98%å›å)
```

**æœˆåº¦å½±å“ä¼°ç®—**:
- å‡è®¾æ¯æœˆ20ç¬”è§¦å‘ç§»åŠ¨æ­¢ç›ˆçš„äº¤æ˜“
- å…¶ä¸­12ç¬”(60%)åœ¨éœ‡è¡ä¸­è¢«è¿‡æ—©æ­¢æŸ
- æ¯ç¬”å¹³å‡æŸå¤±åˆ©æ¶¦: 50U
- **æœˆåº¦æŸå¤±: 12 * 50 = 600U**

---

## å½“å‰V3.0æ–¹æ¡ˆç¼ºé™·

### ç¼ºé™·æ€»ç»“

| ç¼ºé™· | å½±å“ | æœˆåº¦æŸå¤± | ä¸¥é‡åº¦ |
|------|------|---------|--------|
| **40Ué—¨æ§›è¿‡é«˜** | å°ç›ˆåˆ©äº¤æ˜“æ— ä¿æŠ¤ | -400U | ğŸ”´ é«˜ |
| **10Uæ­¥è¿›ç²—ç³™** | ç¼“å†²ç©ºé—´ä¸è¶³ | -600U | ğŸ”´ é«˜ |
| **éœ‡è¡å¸‚å›å** | åˆ©æ¶¦å¤§å¹…å›å | -800U | ğŸ”´ æé«˜ |
| **æ— å¸‚åœºé€‚åº”** | è¶‹åŠ¿å¸‚ä¿æŠ¤ä¸è¶³ | -300U | ğŸŸ  ä¸­ |

**æ€»è®¡æœˆåº¦æŸå¤±**: **-2,100U**

---

## V4.0ä¼˜åŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒç†å¿µ

**åˆ†æ®µé€’è¿›ä¿æŠ¤ + åŠ¨æ€ç¼“å†² + å¸‚åœºè‡ªé€‚åº”**

1. **é™ä½å¯åŠ¨é—¨æ§›**: 40U â†’ 20U (é™ä½50%)
2. **åŠ¨æ€ä¿æŠ¤æ¯”ä¾‹**: æ ¹æ®æµ®ç›ˆåˆ†æ®µä¿æŠ¤ (50% â†’ 80%)
3. **å¹³æ»‘ç¼“å†²ç©ºé—´**: ä¿æŠ¤æ¯”ä¾‹å¹³æ»‘è¿‡æ¸¡ï¼Œç•™è¶³ç¼“å†²
4. **å¸‚åœºè‡ªé€‚åº”**: æ ¹æ®å¸‚åœºçŠ¶æ€åˆ‡æ¢ä¿æŠ¤ç­–ç•¥

---

### æ–¹æ¡ˆA: å¹³è¡¡å‹ï¼ˆé»˜è®¤æ¨èï¼‰â­â­â­

**é€‚ç”¨åœºæ™¯**: æ‰€æœ‰å¸‚åœºç¯å¢ƒï¼ˆé€šç”¨ï¼‰

#### å‚æ•°é…ç½®

```python
TRAILING_STOP_CONFIG_BALANCED = {
    'name': 'balanced',
    'threshold': 20,  # 20Uå¯åŠ¨é—¨æ§›
    'stages': [
        # (æœ€å°æµ®ç›ˆ, æœ€å¤§æµ®ç›ˆ, ä¿æŠ¤æ¯”ä¾‹)
        (0, 20, 0.0),      # 0-20U: 0%ä¿æŠ¤ (è®©åˆ©æ¶¦å¥”è·‘)
        (20, 40, 0.5),     # 20-40U: ä¿æŠ¤50%
        (40, 80, 0.6),     # 40-80U: ä¿æŠ¤60%
        (80, 120, 0.7),    # 80-120U: ä¿æŠ¤70%
        (120, 9999, 0.8)   # 120U+: ä¿æŠ¤80%
    ]
}
```

#### å®é™…æ¡ˆä¾‹æ¼”ç¤º

**æ¡ˆä¾‹1: å°ç›ˆåˆ©åœºæ™¯ï¼ˆ20-40Uï¼‰**

```
å¼€ä»“ä»·: 100,000U
ä¿è¯é‡‘: 480U, æ æ†5x, ä»“ä½æ•°é‡: 0.024 BTC

ä»·æ ¼èµ°åŠ¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—¶é—´   ä»·æ ¼        æµ®ç›ˆ    ä¿æŠ¤æ¯”ä¾‹  ä¿æŠ¤åˆ©æ¶¦  æ­¢æŸä»·      ç¼“å†²ç©ºé—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
14:00  100,000    0U      -         -        97,000 (å›ºå®šæ­¢æŸ-3%)
14:30  100,833    20U     50%       10U      100,417      416U (0.42%)
15:00  101,250    30U     50%       15U      100,625      625U (0.62%)
15:30  100,900    21.6U   50%       15U      100,625      275U (0.27%) âœ…
16:00  101,500    36U     50%       18U      100,750      750U (0.74%)
16:30  106,000    144U    è§¦å‘å›ºå®šæ­¢ç›ˆ+6% â†’ å¹³ä»“ âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ç»“æœ:
- 15:30å›è°ƒåˆ°100,900ï¼Œç¼“å†²275Uï¼Œæœªè§¦å‘æ­¢æŸ âœ…
- æœ€ç»ˆæ­¢ç›ˆ144U

å¯¹æ¯”V3.0:
- V3.0: æµ®ç›ˆ36Uæ—¶æœªæ¿€æ´»(é—¨æ§›40U)ï¼Œæ— ä¿æŠ¤ âŒ
- V4.0: æµ®ç›ˆ20Uå°±æ¿€æ´»ï¼Œä¿æŠ¤18U âœ…
```

**æ¡ˆä¾‹2: ä¸­ç­‰ç›ˆåˆ©åœºæ™¯ï¼ˆ40-80Uï¼‰**

```
å¼€ä»“ä»·: 100,000U

ä»·æ ¼èµ°åŠ¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—¶é—´   ä»·æ ¼        æµ®ç›ˆ    ä¿æŠ¤æ¯”ä¾‹  ä¿æŠ¤åˆ©æ¶¦  æ­¢æŸä»·      ç¼“å†²ç©ºé—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
14:00  100,000    0U      -         -        97,000
15:00  102,500    60U     60%       36U      101,500      1,000U (0.98%)
15:30  103,000    72U     60%       43.2U    101,800      1,200U (1.16%)
16:00  102,200    52.8U   60%       43.2U    101,800      400U (0.39%) âœ…
16:30  102,800    67.2U   60%       40.3U    101,679      1,121U (1.09%)
17:00  101,500    36U     60%       43.2U    101,800      -300U âŒ
      â†’ è·Œç ´æ­¢æŸä»· â†’ è§¦å‘ç§»åŠ¨æ­¢æŸ â†’ å¹³ä»“101,800
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å®é™…ç›ˆåˆ©: (101,800 - 100,000) / 100,000 * 2,400 = 43.2U

å¯¹æ¯”V3.0:
- V3.0: æµ®ç›ˆ72U â†’ ä¿æŠ¤70U â†’ æ­¢æŸ100,070
  â†’ å›è°ƒåˆ°101,500å°±è§¦å‘ â†’ å®é™…èµš1.68U âŒ
- V4.0: æµ®ç›ˆ72U â†’ ä¿æŠ¤43.2U â†’ æ­¢æŸ101,800
  â†’ å›è°ƒåˆ°101,500ä¸è§¦å‘ â†’ å®é™…èµš43.2U âœ…

åˆ©æ¶¦ä¿æŠ¤ç‡æå‡: 1.68U â†’ 43.2U (2,471%!)
```

**æ¡ˆä¾‹3: å¤§ç›ˆåˆ©åœºæ™¯ï¼ˆ80U+ï¼‰**

```
å¼€ä»“ä»·: 100,000U

ä»·æ ¼èµ°åŠ¿:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ—¶é—´   ä»·æ ¼        æµ®ç›ˆ    ä¿æŠ¤æ¯”ä¾‹  ä¿æŠ¤åˆ©æ¶¦  æ­¢æŸä»·      ç¼“å†²ç©ºé—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
14:00  100,000    0U      -         -        97,000
15:00  103,333    80U     60%â†’70%   56U      102,333      1,000U (0.95%)
15:30  105,000    120U    70%â†’80%   84U      103,500      1,500U (1.43%)
16:00  106,000    144U    è§¦å‘å›ºå®šæ­¢ç›ˆ+6% â†’ å¹³ä»“ âœ…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å¦‚æœæœªè§¦å‘æ­¢ç›ˆï¼Œè€Œæ˜¯å›è°ƒ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
16:00  104,000    96U     80%       84U      103,500      500U (0.48%) âœ…
16:30  102,000    48U     80%       84U      103,500      -1,500U âŒ
      â†’ è·Œç ´æ­¢æŸä»· â†’ è§¦å‘ç§»åŠ¨æ­¢æŸ â†’ å¹³ä»“103,500
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å®é™…ç›ˆåˆ©: (103,500 - 100,000) / 100,000 * 2,400 = 84U

å¯¹æ¯”V3.0:
- V3.0: æµ®ç›ˆ120U â†’ ä¿æŠ¤110U â†’ æ­¢æŸ100,110
  â†’ å›è°ƒåˆ°104,000å°±è§¦å‘ â†’ å®é™…èµš2.64U âŒ
- V4.0: æµ®ç›ˆ120U â†’ ä¿æŠ¤84U â†’ æ­¢æŸ103,500
  â†’ å›è°ƒåˆ°104,000ä¸è§¦å‘ â†’ å®é™…èµš84U âœ…

åˆ©æ¶¦ä¿æŠ¤ç‡: 2.64U â†’ 84U (3,082%!)
ä»120Uæœ€é«˜æµ®ç›ˆä¿æŠ¤äº†70% âœ…
```

---

### æ–¹æ¡ˆB: è¶‹åŠ¿è·Ÿéšå‹ï¼ˆæ¿€è¿›ï¼‰â­â­

**é€‚ç”¨åœºæ™¯**: æ˜ç¡®çš„è¶‹åŠ¿è¡Œæƒ…ï¼Œè®©åˆ©æ¶¦å……åˆ†å¥”è·‘

#### å‚æ•°é…ç½®

```python
TRAILING_STOP_CONFIG_TRENDING = {
    'name': 'trending',
    'threshold': 30,  # 30Uå¯åŠ¨é—¨æ§›ï¼ˆç¨é«˜ï¼‰
    'stages': [
        (0, 30, 0.0),      # 0-30U: 0%ä¿æŠ¤ (å……åˆ†å¥”è·‘)
        (30, 60, 0.4),     # 30-60U: ä¿æŠ¤40%
        (60, 100, 0.5),    # 60-100U: ä¿æŠ¤50%
        (100, 200, 0.6),   # 100-200U: ä¿æŠ¤60%
        (200, 9999, 0.7)   # 200U+: ä¿æŠ¤70%
    ]
}
```

#### ä¼˜åŠ¿ä¸é£é™©

**ä¼˜åŠ¿**:
- âœ… å¯åŠ¨é—¨æ§›30Uï¼Œå‰æœŸä¿æŠ¤å°‘ï¼Œåˆ©æ¶¦å¥”è·‘ç©ºé—´å¤§
- âœ… é€‚åˆå¼ºè¶‹åŠ¿è¡Œæƒ…ï¼ˆBig4å¼ºåº¦>70ï¼Œ5Hè¿ç»­3æ ¹åŒå‘ï¼‰
- âœ… å¤§ç›ˆåˆ©åœºæ™¯ä¸‹èƒ½ä¿ç•™æ›´å¤šåˆ©æ¶¦ç©ºé—´

**é£é™©**:
- âš ï¸ å‰30Uæ— ä¿æŠ¤ï¼Œéœ‡è¡å¸‚å¯èƒ½å…¨éƒ¨å›å
- âš ï¸ ä¿æŠ¤æ¯”ä¾‹è¾ƒä½ï¼Œå›è°ƒå®¹å¿åº¦é«˜
- âš ï¸ ä¸é€‚åˆéœ‡è¡å¸‚æˆ–ä¸ç¡®å®šè¡Œæƒ…

**ä½¿ç”¨æ¡ä»¶**:
```python
# ä»…åœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹ä½¿ç”¨è¶‹åŠ¿å‹
if (big4_strength >= 70 and
    trend_5h_consecutive >= 3 and
    volatility_15m >= 0.02):
    use_scheme = 'trending'
```

---

### æ–¹æ¡ˆC: ä¿å®ˆå‹ï¼ˆé˜²å®ˆï¼‰â­

**é€‚ç”¨åœºæ™¯**: éœ‡è¡å¸‚æˆ–ä¸ç¡®å®šè¡Œæƒ…

#### å‚æ•°é…ç½®

```python
TRAILING_STOP_CONFIG_RANGING = {
    'name': 'ranging',
    'threshold': 15,  # 15Uå¯åŠ¨é—¨æ§›ï¼ˆæœ€ä½ï¼‰
    'stages': [
        (0, 15, 0.0),      # 0-15U: 0%ä¿æŠ¤
        (15, 30, 0.6),     # 15-30U: ä¿æŠ¤60%
        (30, 60, 0.7),     # 30-60U: ä¿æŠ¤70%
        (60, 9999, 0.8)    # 60U+: ä¿æŠ¤80%
    ]
}
```

#### ä¼˜åŠ¿ä¸é£é™©

**ä¼˜åŠ¿**:
- âœ… 15Uå³æ¿€æ´»ï¼ˆ0.625%ï¼‰ï¼Œæœ€æ—©ä¿æŠ¤
- âœ… ä¿æŠ¤æ¯”ä¾‹é«˜ï¼Œåˆ©æ¶¦ä¸æ˜“å›å
- âœ… é€‚åˆéœ‡è¡å¸‚å’Œå¼±è¶‹åŠ¿

**é£é™©**:
- âš ï¸ å¤§è¶‹åŠ¿ä¸­å®¹æ˜“è¿‡æ—©æ­¢ç›ˆ
- âš ï¸ åˆ©æ¶¦å¥”è·‘ç©ºé—´å—é™

**ä½¿ç”¨æ¡ä»¶**:
```python
# åœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹ä½¿ç”¨ä¿å®ˆå‹
if (big4_signal == 'NEUTRAL' or
    volatility_15m < 0.01 or
    recent_win_rate < 0.40):
    use_scheme = 'ranging'
```

---

### æ–¹æ¡ˆD: æ··åˆåŠ¨æ€å‹ï¼ˆç»ˆæï¼‰â­â­â­â­â­

**æ ¸å¿ƒ**: æ ¹æ®å®æ—¶å¸‚åœºçŠ¶æ€è‡ªåŠ¨åˆ‡æ¢ä¿æŠ¤ç­–ç•¥

#### å¸‚åœºçŠ¶æ€åˆ¤æ–­é€»è¾‘

```python
def get_market_regime(symbol):
    """
    åˆ¤æ–­å¸‚åœºçŠ¶æ€

    Returns: 'trending', 'ranging', 'balanced'
    """
    # 1. è·å–Kçº¿æ•°æ®
    klines_15m = get_klines(symbol, '15m', 8)
    klines_5h = get_klines(symbol, '5h', 3)

    # 2. è®¡ç®—ä»·æ ¼æ³¢åŠ¨ç‡
    prices = [k['close'] for k in klines_15m]
    max_price = max(prices)
    min_price = min(prices)
    volatility = (max_price - min_price) / min_price

    # 3. è®¡ç®—è¶‹åŠ¿å¼ºåº¦ï¼ˆé˜³çº¿vsé˜´çº¿ï¼‰
    bull_count_15m = sum(1 for k in klines_15m if k['close'] > k['open'])
    bear_count_15m = 8 - bull_count_15m
    trend_strength_15m = abs(bull_count_15m - bear_count_15m) / 8

    # 4. è®¡ç®—5Hè¶‹åŠ¿ä¸€è‡´æ€§
    bull_count_5h = sum(1 for k in klines_5h if k['close'] > k['open'])
    bear_count_5h = 3 - bull_count_5h
    trend_strength_5h = max(bull_count_5h, bear_count_5h) / 3

    # 5. è·å–Big4ä¿¡å·
    big4 = get_latest_big4_signal()
    big4_strength = big4['signal_strength'] if big4 else 0

    # 6. åˆ¤æ–­é€»è¾‘
    # è¶‹åŠ¿å¸‚æ¡ä»¶: 15Mè¶‹åŠ¿å¼º + 5Hä¸€è‡´ + Big4å¼º + æ³¢åŠ¨å¤§
    if (trend_strength_15m >= 0.625 and      # 15M: 5/8ä»¥ä¸ŠåŒå‘
        trend_strength_5h >= 0.667 and       # 5H: 2/3ä»¥ä¸ŠåŒå‘
        big4_strength >= 60 and              # Big4å¼ºåº¦>60
        volatility >= 0.02):                 # æ³¢åŠ¨ç‡>2%
        return 'trending'

    # éœ‡è¡å¸‚æ¡ä»¶: æ³¢åŠ¨å° + è¶‹åŠ¿å¼±
    elif (volatility < 0.01 or               # æ³¢åŠ¨ç‡<1%
          trend_strength_15m < 0.375):       # 15M: 3/8ä»¥ä¸‹åŒå‘
        return 'ranging'

    # é»˜è®¤: å¹³è¡¡å¸‚
    else:
        return 'balanced'
```

#### åŠ¨æ€åˆ‡æ¢ç¤ºä¾‹

```
æ¡ˆä¾‹: BTC/USDT ä»è¶‹åŠ¿å¸‚è½¬ä¸ºéœ‡è¡å¸‚

14:00 å¼€ä»“ 100,000U
      å¸‚åœºçŠ¶æ€: è¶‹åŠ¿å¸‚ (Big4=75, 15M 6/8é˜³çº¿, æ³¢åŠ¨2.3%)
      â†’ ä½¿ç”¨"è¶‹åŠ¿å‹"ä¿æŠ¤

15:00 æµ®ç›ˆ60U
      ä¿æŠ¤ç­–ç•¥: è¶‹åŠ¿å‹ â†’ ä¿æŠ¤50% = 30U â†’ æ­¢æŸ101,250U
      ç¼“å†²: 102,500 - 101,250 = 1,250U (1.22%)

15:30 å¸‚åœºè½¬å˜: Big4=55, 15M 4/8é˜³çº¿, æ³¢åŠ¨0.8%
      â†’ å¸‚åœºçŠ¶æ€åˆ‡æ¢ä¸º"å¹³è¡¡å¸‚"
      â†’ ä¿æŠ¤ç­–ç•¥åˆ‡æ¢ä¸º"å¹³è¡¡å‹"

      å½“å‰æµ®ç›ˆ: 72U
      æ–°ä¿æŠ¤ç­–ç•¥: å¹³è¡¡å‹ â†’ ä¿æŠ¤60% = 43.2U â†’ æ­¢æŸ101,800U
      â†’ æ­¢æŸä»·ä»101,250ä¸Šç§»è‡³101,800 (ä¿æŠ¤å¢å¼º)

16:00 å¸‚åœºå†å˜: Big4=45, æ³¢åŠ¨0.5%
      â†’ å¸‚åœºçŠ¶æ€åˆ‡æ¢ä¸º"éœ‡è¡å¸‚"
      â†’ ä¿æŠ¤ç­–ç•¥åˆ‡æ¢ä¸º"ä¿å®ˆå‹"

      å½“å‰æµ®ç›ˆ: 80U
      æ–°ä¿æŠ¤ç­–ç•¥: ä¿å®ˆå‹ â†’ ä¿æŠ¤70% = 56U â†’ æ­¢æŸ102,333U
      â†’ æ­¢æŸä»·ä»101,800ä¸Šç§»è‡³102,333 (è¿›ä¸€æ­¥å¢å¼º)

ç»“æœ:
- æ ¹æ®å¸‚åœºå˜åŒ–ï¼Œä¿æŠ¤ç­–ç•¥è‡ªåŠ¨å‡çº§
- ä»è¶‹åŠ¿å¸‚çš„"è®©åˆ©æ¶¦å¥”è·‘"é€æ­¥è½¬ä¸ºéœ‡è¡å¸‚çš„"ä¿æŠ¤åˆ©æ¶¦"
- æœ€å¤§åŒ–é€‚åº”å¸‚åœºç¯å¢ƒ âœ…
```

---

## æ•ˆæœå¯¹æ¯”

### åœºæ™¯å¯¹æ¯”æµ‹è¯•

#### æµ‹è¯•åœºæ™¯1: æµ®ç›ˆ80Uåå›è°ƒ

```
å¼€ä»“: 100,000U
æœ€é«˜: 103,333U (æµ®ç›ˆ80U)
å›è°ƒ: 100,500U (æµ®ç›ˆ12U)
```

| æ–¹æ¡ˆ | ä¿æŠ¤åˆ©æ¶¦ | æ­¢æŸä»· | ç¼“å†²ç©ºé—´ | æ˜¯å¦æ­¢æŸ | å®é™…ç›ˆåˆ© |
|-----|---------|--------|---------|---------|---------|
| **V3.0æ—§æ–¹æ¡ˆ** | 80U | 100,080 | 420U (0.42%) | âœ… è§¦å‘ | 1.92U âŒ |
| **V4.0-å¹³è¡¡** | 48U | 102,000 | -1,500U | âŒ ä¸è§¦å‘ | ç»§ç»­æŒæœ‰ âœ… |
| **V4.0-è¶‹åŠ¿** | 40U | 101,667 | -1,167U | âŒ ä¸è§¦å‘ | ç»§ç»­æŒæœ‰ âœ… |
| **V4.0-ä¿å®ˆ** | 56U | 102,333 | -1,833U | âŒ ä¸è§¦å‘ | ç»§ç»­æŒæœ‰ âœ… |

**ç»“è®º**: V4.0æ‰€æœ‰æ–¹æ¡ˆéƒ½èƒ½æ‰›ä½å›è°ƒï¼ŒV3.0ç›´æ¥æ­¢æŸå‡ºå±€

---

#### æµ‹è¯•åœºæ™¯2: æµ®ç›ˆ36Uæ—¶å›è°ƒï¼ˆé—¨æ§›æµ‹è¯•ï¼‰

```
å¼€ä»“: 100,000U
æœ€é«˜: 101,500U (æµ®ç›ˆ36U)
å›è°ƒ: 97,000U (è§¦å‘å›ºå®šæ­¢æŸ)
```

| æ–¹æ¡ˆ | æ˜¯å¦æ¿€æ´» | ä¿æŠ¤åˆ©æ¶¦ | æ­¢æŸä»· | å®é™…ç»“æœ |
|-----|---------|---------|--------|---------|
| **V3.0æ—§æ–¹æ¡ˆ** | âŒ æœªæ¿€æ´»(é—¨æ§›40U) | 0U | 97,000 | äºæŸ72U âŒ |
| **V4.0-å¹³è¡¡** | âœ… æ¿€æ´»(é—¨æ§›20U) | 18U | 100,750 | ç›ˆåˆ©18U âœ… |
| **V4.0-è¶‹åŠ¿** | âœ… æ¿€æ´»(é—¨æ§›30U) | 14.4U | 100,600 | ç›ˆåˆ©14.4U âœ… |
| **V4.0-ä¿å®ˆ** | âœ… æ¿€æ´»(é—¨æ§›15U) | 21.6U | 100,900 | ç›ˆåˆ©21.6U âœ… |

**ç»“è®º**: V3.0å› æœªæ¿€æ´»è€Œå…¨é¢äºæŸï¼ŒV4.0å…¨éƒ¨ä¿æŠ¤åˆ©æ¶¦

---

#### æµ‹è¯•åœºæ™¯3: éœ‡è¡å¸‚åœºï¼ˆ100,000-102,000éœ‡è¡ï¼‰

```
å¼€ä»“: 100,000U
æ³¢åŠ¨: 100,500 â†’ 102,000 â†’ 100,800 â†’ 101,500 â†’ 100,200
æŒç»­2å°æ—¶éœ‡è¡
```

| æ–¹æ¡ˆ | æœ€é«˜æµ®ç›ˆ | ä¿æŠ¤åˆ©æ¶¦ | æ­¢æŸä»· | ç»“æœ |
|-----|---------|---------|--------|------|
| **V3.0** | 96U | 90U | 100,090 | éœ‡è¡ä¸­è§¦å‘æ­¢æŸï¼Œèµš1.92U âŒ |
| **V4.0-å¹³è¡¡** | 96U | 57.6U | 102,400 | æ‰›ä½éœ‡è¡ï¼Œæœ€ç»ˆæ­¢ç›ˆ144U âœ… |
| **V4.0-è¶‹åŠ¿** | 96U | 48U | 102,000 | æ‰›ä½éœ‡è¡ï¼Œæœ€ç»ˆæ­¢ç›ˆ144U âœ… |
| **V4.0-ä¿å®ˆ** | 96U | 76.8U | 103,200 | éœ‡è¡ä¸­è§¦å‘ï¼Œèµš76.8U âš ï¸ |

**ç»“è®º**:
- V3.0åœ¨éœ‡è¡ä¸­è¢«è¿‡æ—©æ­¢æŸ
- V4.0å¹³è¡¡å‹å’Œè¶‹åŠ¿å‹å®Œç¾é€šè¿‡
- V4.0ä¿å®ˆå‹è™½è§¦å‘ï¼Œä½†ä¹Ÿä¿æŠ¤äº†80%åˆ©æ¶¦

---

### æœˆåº¦æ”¶ç›Šé¢„ä¼°

#### å‡è®¾æ¡ä»¶
- æœˆäº¤æ˜“æ¬¡æ•°: 200ç¬”
- å…¶ä¸­è§¦å‘ç§»åŠ¨æ­¢ç›ˆ: 40ç¬” (20%)
- éœ‡è¡å¸‚å æ¯”: 60%

#### V3.0æœˆåº¦è¡¨ç°
```
40ç¬”ç§»åŠ¨æ­¢ç›ˆäº¤æ˜“:
- 24ç¬”åœ¨éœ‡è¡ä¸­è¢«è¿‡æ—©æ­¢æŸ (60%)
  - å¹³å‡æµ®ç›ˆ: 80U
  - å¹³å‡å®é™…ç›ˆåˆ©: 2U
  - æ¯ç¬”æŸå¤±: 78U
  - å°è®¡: -1,872U

- 16ç¬”é¡ºåˆ©æ­¢ç›ˆ (40%)
  - å¹³å‡ç›ˆåˆ©: 100U
  - å°è®¡: +1,600U

å‡€æ”¶ç›Š: +1,600 - 1,872 = -272U âŒ
```

#### V4.0-å¹³è¡¡å‹æœˆåº¦è¡¨ç°
```
40ç¬”ç§»åŠ¨æ­¢ç›ˆäº¤æ˜“:
- 30ç¬”æ‰›ä½éœ‡è¡å¹¶æ­¢ç›ˆ (75%)
  - å¹³å‡ç›ˆåˆ©: 120U
  - å°è®¡: +3,600U

- 10ç¬”åœ¨éœ‡è¡ä¸­è§¦å‘ (25%)
  - å¹³å‡æµ®ç›ˆ: 80U
  - å¹³å‡ä¿æŠ¤: 48U (60%)
  - å°è®¡: +480U

å‡€æ”¶ç›Š: +3,600 + 480 = +4,080U âœ…

å¯¹æ¯”V3.0æ”¹å–„: +4,080 - (-272) = +4,352U/æœˆ
```

**å¹´åº¦æ”¶ç›Šæ”¹å–„**: **+52,224U**

---

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µ: ä»£ç å®ç°ï¼ˆ2å¤©ï¼‰

#### ä»»åŠ¡1: åˆ›å»ºV4.0ç§»åŠ¨æ­¢ç›ˆæ¨¡å—

**æ–‡ä»¶**: `app/services/trailing_stop_v4.py` (æ–°å»º)

**æ ¸å¿ƒåŠŸèƒ½**:
```python
class TrailingStopV4:
    """V4.0ç§»åŠ¨æ­¢ç›ˆç®¡ç†å™¨"""

    def __init__(self):
        self.schemes = {
            'balanced': TRAILING_STOP_CONFIG_BALANCED,
            'trending': TRAILING_STOP_CONFIG_TRENDING,
            'ranging': TRAILING_STOP_CONFIG_RANGING
        }
        self.current_scheme = 'balanced'  # é»˜è®¤å¹³è¡¡å‹

    def get_market_regime(self, symbol):
        """åˆ¤æ–­å¸‚åœºçŠ¶æ€"""
        pass

    def calculate_trailing_stop(self, position, current_price):
        """è®¡ç®—ç§»åŠ¨æ­¢æŸä»·æ ¼"""
        pass

    def update_position_trailing_stop(self, position_id, stop_price):
        """æ›´æ–°æ•°æ®åº“ä¸­çš„ç§»åŠ¨æ­¢æŸä»·"""
        pass
```

#### ä»»åŠ¡2: é›†æˆåˆ°ä¸»æœåŠ¡

**æ–‡ä»¶**: `smart_trader_service.py` (ä¿®æ”¹)

```python
from app.services.trailing_stop_v4 import TrailingStopV4

class SmartTraderService:
    def __init__(self):
        # ... ç°æœ‰ä»£ç 
        self.trailing_stop_v4 = TrailingStopV4()

    async def monitor_positions(self):
        """æŒä»“ç›‘æ§ä¸»å¾ªç¯"""
        for position in open_positions:
            # 1. æ£€æŸ¥å›ºå®šæ­¢æŸæ­¢ç›ˆ
            # ...

            # 2. æ£€æŸ¥V4.0ç§»åŠ¨æ­¢ç›ˆ
            stop_price = self.trailing_stop_v4.calculate_trailing_stop(
                position, current_price
            )
            if stop_price:
                # æ£€æŸ¥æ˜¯å¦è§¦å‘
                if self._check_trailing_stop_trigger(position, current_price, stop_price):
                    await self.close_position(position, 'ç§»åŠ¨æ­¢ç›ˆ')
```

#### ä»»åŠ¡3: æ•°æ®åº“å­—æ®µæ‰©å±•

**è¡¨**: `futures_positions`

```sql
ALTER TABLE futures_positions
ADD COLUMN trailing_stop_scheme VARCHAR(20) DEFAULT 'balanced'
    COMMENT 'ç§»åŠ¨æ­¢ç›ˆæ–¹æ¡ˆ: balanced/trending/ranging',
ADD COLUMN trailing_stop_activated TINYINT(1) DEFAULT 0
    COMMENT 'æ˜¯å¦æ¿€æ´»ç§»åŠ¨æ­¢ç›ˆ',
ADD COLUMN trailing_stop_activated_at DATETIME DEFAULT NULL
    COMMENT 'æ¿€æ´»æ—¶é—´',
ADD COLUMN max_unrealized_pnl_history DECIMAL(20,2) DEFAULT 0
    COMMENT 'å†å²æœ€é«˜æµ®ç›ˆ',
ADD COLUMN trailing_stop_trigger_count INT DEFAULT 0
    COMMENT 'ç§»åŠ¨æ­¢æŸè§¦å‘æ¬¡æ•°ç»Ÿè®¡';
```

---

### ç¬¬äºŒé˜¶æ®µ: æµ‹è¯•éªŒè¯ï¼ˆ3å¤©ï¼‰

#### æµ‹è¯•1: å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `tests/test_trailing_stop_v4.py`

```python
def test_balanced_scheme():
    """æµ‹è¯•å¹³è¡¡å‹æ–¹æ¡ˆ"""
    # æµ‹è¯•ä¸åŒæµ®ç›ˆä¸‹çš„ä¿æŠ¤æ¯”ä¾‹
    assert calculate_protection(10) == 0      # æœªæ¿€æ´»
    assert calculate_protection(20) == 10     # 50%
    assert calculate_protection(50) == 30     # 60%
    assert calculate_protection(100) == 70    # 70%
    assert calculate_protection(150) == 120   # 80%

def test_market_regime_detection():
    """æµ‹è¯•å¸‚åœºçŠ¶æ€åˆ¤æ–­"""
    # è¶‹åŠ¿å¸‚
    assert get_market_regime(trending_klines) == 'trending'
    # éœ‡è¡å¸‚
    assert get_market_regime(ranging_klines) == 'ranging'
    # å¹³è¡¡å¸‚
    assert get_market_regime(balanced_klines) == 'balanced'
```

#### æµ‹è¯•2: å›æµ‹éªŒè¯

**æ•°æ®èŒƒå›´**: 2026-02-05 ~ 2026-02-07 (3å¤©å†å²æ•°æ®)

**å¯¹æ¯”æŒ‡æ ‡**:
- V3.0 vs V4.0-å¹³è¡¡å‹
- ç§»åŠ¨æ­¢ç›ˆè§¦å‘æ¬¡æ•°
- å¹³å‡ä¿æŠ¤åˆ©æ¶¦æ¯”ä¾‹
- éœ‡è¡å¸‚è¡¨ç°
- è¶‹åŠ¿å¸‚è¡¨ç°

**é¢„æœŸç»“æœ**:
```
V3.0:
- ç§»åŠ¨æ­¢ç›ˆè§¦å‘: 15æ¬¡
- å¹³å‡å®é™…ç›ˆåˆ©: 8.5U
- å¹³å‡åˆ©æ¶¦å›åç‡: 92%

V4.0-å¹³è¡¡å‹:
- ç§»åŠ¨æ­¢ç›ˆè§¦å‘: 12æ¬¡ (å‡å°‘20%)
- å¹³å‡å®é™…ç›ˆåˆ©: 68.3U (æå‡703%)
- å¹³å‡åˆ©æ¶¦å›åç‡: 28% (é™ä½64ä¸ªç™¾åˆ†ç‚¹)
```

#### æµ‹è¯•3: å°è§„æ¨¡å®ç›˜ï¼ˆ1å¤©ï¼‰

**é…ç½®**:
- ä»…5ä¸ªä¼˜è´¨äº¤æ˜“å¯¹
- å•ä»“ä¿è¯é‡‘é™ä½è‡³200Uï¼ˆé™ä½é£é™©ï¼‰
- å¯ç”¨V4.0-å¹³è¡¡å‹

**è§‚å¯ŸæŒ‡æ ‡**:
- ç§»åŠ¨æ­¢ç›ˆæ¿€æ´»ç‡
- å®é™…ç›ˆåˆ© vs æœ€é«˜æµ®ç›ˆ
- æ˜¯å¦æœ‰è¿‡æ—©æ­¢æŸæƒ…å†µ

---

### ç¬¬ä¸‰é˜¶æ®µ: å…¨é‡ä¸Šçº¿ï¼ˆ1å¤©ï¼‰

#### ä¸Šçº¿æ­¥éª¤

1. **é…ç½®åˆ‡æ¢**
   ```python
   # smart_trader_service.py
   USE_TRAILING_STOP_V4 = True  # å¯ç”¨V4.0
   DEFAULT_TRAILING_SCHEME = 'balanced'  # é»˜è®¤æ–¹æ¡ˆ
   ```

2. **ç›‘æ§å‘Šè­¦**
   ```python
   # æ¯æ¬¡è§¦å‘ç§»åŠ¨æ­¢ç›ˆæ—¶å‘é€é€šçŸ¥
   if trailing_stop_triggered:
       send_telegram_notification(
           f"ç§»åŠ¨æ­¢ç›ˆè§¦å‘: {symbol}\n"
           f"æœ€é«˜æµ®ç›ˆ: {max_pnl}U\n"
           f"ä¿æŠ¤åˆ©æ¶¦: {protected_profit}U\n"
           f"å®é™…ç›ˆåˆ©: {realized_pnl}U\n"
           f"ä¿æŠ¤ç‡: {protected_profit/max_pnl*100:.1f}%"
       )
   ```

3. **æ•°æ®ç»Ÿè®¡**
   ```sql
   -- æ¯æ—¥ç»Ÿè®¡V4.0è¡¨ç°
   SELECT
       DATE(close_time) as trade_date,
       COUNT(*) as trailing_stop_count,
       AVG(max_unrealized_pnl_history) as avg_max_pnl,
       AVG(realized_pnl) as avg_realized_pnl,
       AVG(realized_pnl / max_unrealized_pnl_history) as avg_protection_rate
   FROM futures_positions
   WHERE trailing_stop_activated = 1
   AND close_time >= CURDATE() - INTERVAL 7 DAY
   GROUP BY DATE(close_time);
   ```

---

### ç¬¬å››é˜¶æ®µ: æ··åˆåŠ¨æ€ä¼˜åŒ–ï¼ˆ1å‘¨åï¼‰

**æ¡ä»¶**: V4.0-å¹³è¡¡å‹ç¨³å®šè¿è¡Œ1å‘¨ï¼Œè¡¨ç°ç¬¦åˆé¢„æœŸ

**å‡çº§å†…å®¹**:
1. å¯ç”¨å¸‚åœºçŠ¶æ€è‡ªåŠ¨åˆ¤æ–­
2. æ ¹æ®Big4ã€5Hã€15Må®æ—¶åˆ‡æ¢ä¿æŠ¤æ–¹æ¡ˆ
3. è®°å½•åˆ‡æ¢æ—¥å¿—ï¼Œåˆ†ææ•ˆæœ

**é¢„æœŸæå‡**:
- è¶‹åŠ¿å¸‚: åˆ©æ¶¦å¥”è·‘ç©ºé—´ +15%
- éœ‡è¡å¸‚: åˆ©æ¶¦ä¿æŠ¤ç‡ +10%
- ç»¼åˆæ”¶ç›Š: æœˆåº¦ +500U

---

## é£é™©è¯„ä¼°

### é£é™©1: è¿‡åº¦ä¿å®ˆå¯¼è‡´é”™å¤±å¤§è¶‹åŠ¿ âš ï¸

**åœºæ™¯**:
- å¼ºè¶‹åŠ¿è¡Œæƒ…ä¸­ï¼Œä¿æŠ¤æ¯”ä¾‹è¿‡é«˜
- ä»·æ ¼å›è°ƒè§¦å‘ç§»åŠ¨æ­¢æŸ
- é”™è¿‡åç»­å¤§æ¶¨

**æ¦‚ç‡**: ä½ (10%)

**ç¼“è§£æªæ–½**:
1. è¶‹åŠ¿å¸‚ä½¿ç”¨"è¶‹åŠ¿å‹"æ–¹æ¡ˆï¼ˆä¿æŠ¤æ¯”ä¾‹ä½ï¼‰
2. Big4å¼ºåº¦>70æ—¶ï¼Œé™ä½ä¿æŠ¤æ¯”ä¾‹5%
3. ç›‘æ§"ç§»åŠ¨æ­¢æŸåç»§ç»­ä¸Šæ¶¨"çš„æ¡ˆä¾‹ï¼Œè°ƒæ•´å‚æ•°

---

### é£é™©2: å¸‚åœºçŠ¶æ€è¯¯åˆ¤ âš ï¸

**åœºæ™¯**:
- åˆ¤æ–­ä¸ºè¶‹åŠ¿å¸‚ï¼Œå®é™…æ˜¯å‡çªç ´
- ä½¿ç”¨ä½ä¿æŠ¤æ¯”ä¾‹ï¼Œå›è°ƒæ—¶æŸå¤±å¤§

**æ¦‚ç‡**: ä¸­ (20%)

**ç¼“è§£æªæ–½**:
1. åˆæœŸä½¿ç”¨å›ºå®š"å¹³è¡¡å‹"ï¼Œç§¯ç´¯æ•°æ®
2. å¸‚åœºçŠ¶æ€åˆ¤æ–­å¢åŠ ç¡®è®¤æœºåˆ¶ï¼ˆè¿ç»­2æ¬¡åˆ¤æ–­ä¸€è‡´ï¼‰
3. è®¾ç½®æœ€ä½ä¿æŠ¤æ¯”ä¾‹ä¸‹é™ï¼ˆä»»ä½•æ–¹æ¡ˆä¸ä½äº40%ï¼‰

---

### é£é™©3: ç³»ç»ŸBugå¯¼è‡´è¯¯æ“ä½œ âš ï¸

**åœºæ™¯**:
- ä»£ç é€»è¾‘é”™è¯¯
- æ­¢æŸä»·è®¡ç®—é”™è¯¯
- æ„å¤–å¹³ä»“

**æ¦‚ç‡**: ä½ (5%)

**ç¼“è§£æªæ–½**:
1. å……åˆ†çš„å•å…ƒæµ‹è¯• (è¦†ç›–ç‡>90%)
2. å°è§„æ¨¡å®ç›˜éªŒè¯
3. å¢åŠ å®‰å…¨æ£€æŸ¥ï¼ˆæ­¢æŸä»·ä¸èƒ½ä½äºå…¥åœºä»·ï¼‰
4. è¯¦ç»†æ—¥å¿—è®°å½•ï¼Œä¾¿äºæ’æŸ¥

---

## å…³é”®æŒ‡æ ‡ç›‘æ§

### æ—¥å¸¸ç›‘æ§æŒ‡æ ‡

```sql
-- 1. V4.0æ¿€æ´»ç‡
SELECT
    COUNT(*) as total_positions,
    SUM(trailing_stop_activated) as activated_count,
    SUM(trailing_stop_activated) / COUNT(*) * 100 as activation_rate
FROM futures_positions
WHERE DATE(open_time) = CURDATE()
AND status = 'closed';

-- 2. å¹³å‡ä¿æŠ¤ç‡
SELECT
    AVG(realized_pnl / max_unrealized_pnl_history * 100) as avg_protection_rate
FROM futures_positions
WHERE trailing_stop_activated = 1
AND DATE(close_time) = CURDATE();

-- 3. æ–¹æ¡ˆåˆ†å¸ƒ
SELECT
    trailing_stop_scheme,
    COUNT(*) as count,
    AVG(realized_pnl) as avg_pnl
FROM futures_positions
WHERE trailing_stop_activated = 1
AND DATE(close_time) = CURDATE()
GROUP BY trailing_stop_scheme;
```

### å‘Šè­¦é˜ˆå€¼

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ |
|-----|---------|---------|
| æ¿€æ´»ç‡ | 15-25% | <10% æˆ– >30% |
| å¹³å‡ä¿æŠ¤ç‡ | 50-70% | <40% |
| å•æ—¥è§¦å‘æ¬¡æ•° | 5-15æ¬¡ | >20æ¬¡ |
| å¹³å‡å®é™…ç›ˆåˆ© | 40-80U | <20U |

---

## é™„å½•

### A. å®Œæ•´é…ç½®ç¤ºä¾‹

```python
# config/trailing_stop_v4_config.py

TRAILING_STOP_V4_CONFIG = {
    # å…¨å±€å¼€å…³
    'enabled': True,
    'version': '4.0',

    # é»˜è®¤æ–¹æ¡ˆ
    'default_scheme': 'balanced',

    # æ–¹æ¡ˆå®šä¹‰
    'schemes': {
        'balanced': {
            'name': 'å¹³è¡¡å‹',
            'threshold': 20,
            'stages': [
                (0, 20, 0.0),
                (20, 40, 0.5),
                (40, 80, 0.6),
                (80, 120, 0.7),
                (120, 9999, 0.8)
            ]
        },
        'trending': {
            'name': 'è¶‹åŠ¿å‹',
            'threshold': 30,
            'stages': [
                (0, 30, 0.0),
                (30, 60, 0.4),
                (60, 100, 0.5),
                (100, 200, 0.6),
                (200, 9999, 0.7)
            ]
        },
        'ranging': {
            'name': 'ä¿å®ˆå‹',
            'threshold': 15,
            'stages': [
                (0, 15, 0.0),
                (15, 30, 0.6),
                (30, 60, 0.7),
                (60, 9999, 0.8)
            ]
        }
    },

    # å¸‚åœºçŠ¶æ€åˆ¤æ–­å‚æ•°
    'market_regime_params': {
        'trending': {
            'min_trend_strength_15m': 0.625,  # 15M: 5/8ä»¥ä¸ŠåŒå‘
            'min_trend_strength_5h': 0.667,   # 5H: 2/3ä»¥ä¸ŠåŒå‘
            'min_big4_strength': 60,           # Big4å¼ºåº¦>60
            'min_volatility': 0.02             # æ³¢åŠ¨ç‡>2%
        },
        'ranging': {
            'max_volatility': 0.01,            # æ³¢åŠ¨ç‡<1%
            'max_trend_strength_15m': 0.375   # 15M: 3/8ä»¥ä¸‹åŒå‘
        }
    },

    # å®‰å…¨é™åˆ¶
    'safety_limits': {
        'min_protection_ratio': 0.3,      # æœ€ä½ä¿æŠ¤30%
        'max_protection_ratio': 0.9,      # æœ€é«˜ä¿æŠ¤90%
        'min_buffer_usd': 50,             # æœ€å°ç¼“å†²50U
        'stop_price_sanity_check': True   # æ­¢æŸä»·åˆç†æ€§æ£€æŸ¥
    },

    # é€šçŸ¥è®¾ç½®
    'notifications': {
        'on_activation': True,    # æ¿€æ´»æ—¶é€šçŸ¥
        'on_trigger': True,       # è§¦å‘æ—¶é€šçŸ¥
        'on_scheme_change': True  # æ–¹æ¡ˆåˆ‡æ¢æ—¶é€šçŸ¥
    }
}
```

---

## æ€»ç»“

### V4.0æ ¸å¿ƒæ”¹è¿›

1. **å¯åŠ¨é—¨æ§›é™ä½**: 40U â†’ 20U (é™ä½50%)
2. **åŠ¨æ€ä¿æŠ¤æ¯”ä¾‹**: 50% â†’ 80% åˆ†æ®µé€’è¿›
3. **ç¼“å†²ç©ºé—´å¢å¤§**: 1.6U â†’ å¹³å‡1,500U (å¢åŠ 937å€)
4. **å¸‚åœºè‡ªé€‚åº”**: 3ç§æ–¹æ¡ˆè‡ªåŠ¨åˆ‡æ¢

### é¢„æœŸæ”¶ç›Š

- **æœˆåº¦æ”¶ç›Šæå‡**: +4,352U
- **å¹´åº¦æ”¶ç›Šæå‡**: +52,224U
- **åˆ©æ¶¦ä¿æŠ¤ç‡**: ä»2% â†’ 60%
- **éœ‡è¡å¸‚è¡¨ç°**: åˆ©æ¶¦å›åç‡ä»92% â†’ 28%

### å®æ–½æ—¶é—´çº¿

- **ç¬¬1-2å¤©**: ä»£ç å¼€å‘
- **ç¬¬3-5å¤©**: æµ‹è¯•éªŒè¯
- **ç¬¬6å¤©**: å…¨é‡ä¸Šçº¿
- **ç¬¬7å¤©èµ·**: æ•°æ®ç›‘æ§ä¸ä¼˜åŒ–

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ
**ä¸‹ä¸€æ­¥**: å¼€å§‹ä»£ç å®ç°
**è´£ä»»äºº**: å¼€å‘å›¢é˜Ÿ
**å®¡æ ¸äºº**: å¾…å®š
