# RSI信号反转平仓豁免说明

> 更新日期: 2026-01-01
> 版本: 1.0
> 相关文件: `app/services/strategy_executor_v2.py`

## 问题背景

### 发现的问题

在实盘运行中发现：**RSI信号开的多单被趋势反转信号过早平掉**

### 问题场景

1. **12:00** - BNB RSI超卖（< 30）触发做多信号
   - RSI极值 + EMA强度上升
   - 系统开多单

2. **12:10** - 短期内出现死叉（EMA9 下穿 EMA26）
   - 15分钟冷却期内，反转检查被跳过
   - 持仓继续保留

3. **12:15** - 冷却期结束
   - 检测到死叉反转信号
   - ❌ **多单被平掉**（可能仍在盈利或小幅亏损）

### 问题根源

**逻辑冲突**：
- **RSI信号的本质**: 逆势抄底/追顶策略
  - RSI超卖做多 = 认为下跌过度，即将反弹
  - RSI超买做空 = 认为上涨过度，即将回落

- **反转平仓的本质**: 顺势策略
  - 死叉平多 = 趋势转为下跌，多单应该平掉
  - 金叉平空 = 趋势转为上涨，空单应该平掉

**矛盾点**：
- RSI信号开仓时，本身就预期**短期趋势会反转**
- 如果用趋势反转来平仓，会导致刚开仓就被平掉
- 违背了RSI信号的策略意图

---

## 解决方案

### 实现逻辑

在 `check_cross_reversal` 方法中添加RSI信号豁免检查：

```python
def check_cross_reversal(self, position: Dict, ema_data: Dict) -> Tuple[bool, str]:
    """
    检测金叉/死叉反转信号（使用已收盘K线判断，避免误判）
    """
    # RSI信号开的仓位不受反转平仓影响
    # 原因：RSI超卖做多/超买做空本身就是"逆势"策略，短期趋势反转是正常的
    # 应该由止损/止盈来管理，而不是反转信号
    entry_signal_type = position.get('entry_signal_type', '')
    if entry_signal_type == 'rsi_signal':
        return False, "rsi_signal_skip_reversal"

    # ... 其他反转检查逻辑
```

### 关键改动

**位置**: `app/services/strategy_executor_v2.py:2037-2042`

**逻辑**:
1. 检查持仓的 `entry_signal_type` 字段
2. 如果是 `'rsi_signal'`，直接返回 `False`（不平仓）
3. 其他信号类型继续正常的反转检查

---

## 技术细节

### 平仓逻辑优先级

在 `check_smart_exit` 方法中的平仓检查顺序：

```python
# 1. 移动止损检查
# 2. 硬止损检查 (-2.5%)
# 3. 5M信号智能止损
# 4. 最大止盈检查 (+8%)
# 5. EMA差值止盈检查
# 6. 金叉/死叉反转检查 ← RSI信号在这里被豁免
# 7. 趋势减弱检查
# 8. 移动止盈回撤检查
```

### RSI信号仓位的平仓方式

RSI信号开的仓位**仍然会被平仓**，但只通过以下方式：

| 平仓方式 | 是否生效 | 说明 |
|---------|---------|------|
| 硬止损 | ✅ 生效 | 亏损达到阈值（默认-2.5%） |
| 最大止盈 | ✅ 生效 | 盈利达到阈值（默认+8%） |
| 移动止损 | ✅ 生效 | 启用移动止损后触发 |
| 移动止盈 | ✅ 生效 | 盈利回撤触发 |
| 5M信号止损 | ✅ 生效 | 5M级别反向信号 |
| EMA差值止盈 | ✅ 生效 | EMA强度达到止盈阈值 |
| 趋势减弱 | ✅ 生效 | EMA强度持续减弱 |
| **金叉/死叉反转** | ❌ **不生效** | **豁免** |

---

## 效果预期

### 优势

1. ✅ **避免过早平仓**: RSI超卖做多不会因为短期死叉就被平掉
2. ✅ **策略逻辑一致**: 逆势策略用逆势方式管理（止损/止盈）
3. ✅ **提高持仓时间**: 给RSI信号足够时间发挥效果
4. ✅ **减少频繁交易**: 避免开仓-反转平仓-再开仓的循环

### 风险控制

即使豁免了反转平仓，RSI信号仓位仍有完善的风险控制：

1. **硬止损保底**: 最大亏损-2.5%（可配置）
2. **5M信号智能止损**: 亏损时检测5M反向信号
3. **移动止损**: 盈利后保护利润
4. **最大止盈**: 避免贪婪导致利润回撤

---

## 实际案例

### 案例1: BNB RSI超卖做多

**之前的逻辑**:
```
12:00 - RSI(28) < 30, EMA强度上升 → 开多单
12:10 - 出现死叉（EMA9 < EMA26）
12:15 - 冷却期结束，检测到死叉反转 → 平多单（可能+0.5%）
结果: 早早平仓，错过后续反弹到+3%的机会
```

**现在的逻辑**:
```
12:00 - RSI(28) < 30, EMA强度上升 → 开多单
12:10 - 出现死叉（EMA9 < EMA26）
12:15 - 冷却期结束，检测到死叉反转 → 跳过（RSI信号豁免）
12:30 - 价格反弹，盈利达到+3% → EMA差值止盈触发 → 平多单
结果: 持仓更久，捕捉到完整的反弹行情
```

### 案例2: SOL RSI超买做空

**之前的逻辑**:
```
14:00 - RSI(78) > 75, EMA强度下降 → 开空单
14:12 - 出现金叉（EMA9 > EMA26）
14:15 - 冷却期结束，检测到金叉反转 → 平空单（可能+0.3%）
结果: 早早平仓，错过后续回落到+2.5%的机会
```

**现在的逻辑**:
```
14:00 - RSI(78) > 75, EMA强度下降 → 开空单
14:12 - 出现金叉（EMA9 > EMA26）
14:15 - 冷却期结束，检测到金叉反转 → 跳过（RSI信号豁免）
14:40 - 价格回落，盈利达到+2.5% → 移动止盈触发 → 平空单
结果: 持仓更久，捕捉到完整的回落行情
```

---

## 配置建议

### 推荐配置

由于RSI信号豁免了反转平仓，建议配合以下配置确保风险可控：

```json
{
  "rsiSignal": {
    "enabled": true,
    "longThreshold": 30,
    "shortThreshold": 75,
    "minEmaStrengthLong": 0.15,
    "maxEmaStrengthShort": 1.0
  },
  "stopLossPercent": 2.5,        // 硬止损
  "takeProfitPercent": 8.0,      // 最大止盈
  "smartStopLoss": {
    "trailingStopLoss": {
      "enabled": true,           // 启用移动止损
      "activatePct": 1.5,        // 盈利1.5%激活
      "distancePct": 0.8         // 回撤0.8%触发
    }
  },
  "trailingActivate": 3.0,       // 移动止盈激活
  "trailingCallback": 1.5,       // 移动止盈回撤
  "emaDiffTakeProfit": {
    "enabled": true,
    "shortThreshold": 0.8,       // 做多时EMA强度达到0.8%止盈
    "longThreshold": -0.8        // 做空时EMA强度达到-0.8%止盈
  }
}
```

### 调优建议

1. **保守策略**:
   - 硬止损: -2.0%
   - 移动止损: 1.0%激活, 0.5%回撤
   - 最大止盈: +5%

2. **激进策略**:
   - 硬止损: -3.0%
   - 移动止损: 2.0%激活, 1.0%回撤
   - 最大止盈: +10%

---

## 监控指标

### 关键指标

1. **RSI信号持仓时长**: 观察平均持仓时间是否延长
2. **RSI信号胜率**: 豁免后胜率是否提升
3. **RSI信号平均盈亏**: 是否捕捉到更多利润
4. **平仓原因分布**: 验证是否更多由止损/止盈平仓，而非反转平仓

### 数据库查询

**查看RSI信号的平仓原因分布**:
```sql
SELECT
    SUBSTRING_INDEX(exit_reason, '|', 1) as exit_type,
    COUNT(*) as count,
    AVG(realized_pnl) as avg_pnl,
    SUM(CASE WHEN realized_pnl > 0 THEN 1 ELSE 0 END) as wins
FROM futures_positions
WHERE entry_signal_type = 'rsi_signal'
AND status = 'closed'
AND created_at >= '2026-01-01'
GROUP BY exit_type
ORDER BY count DESC;
```

**查看RSI信号的持仓时长分布**:
```sql
SELECT
    symbol,
    TIMESTAMPDIFF(MINUTE, open_time, close_time) as hold_minutes,
    realized_pnl,
    exit_reason
FROM futures_positions
WHERE entry_signal_type = 'rsi_signal'
AND status = 'closed'
AND created_at >= '2026-01-01'
ORDER BY close_time DESC
LIMIT 20;
```

---

## 注意事项

1. ⚠️ **仅豁免反转平仓**: 其他所有平仓检查仍然生效
2. ⚠️ **必须有止损**: 确保硬止损或移动止损已配置
3. ⚠️ **观察期建议**: 先在模拟盘运行1-2周，验证效果
4. ⚠️ **市场适应性**: 震荡行情中RSI信号可能频繁触发，注意仓位控制

---

## FAQ

**Q: 为什么只豁免RSI信号，其他信号不豁免？**
A: 其他信号（金叉/死叉、持续趋势等）都是顺势策略，趋势反转时应该平仓。只有RSI信号是逆势策略，需要豁免。

**Q: 如果RSI信号一直不反转怎么办？**
A: 硬止损会保底，最大亏损受限。同时5M信号止损和趋势减弱检查仍然生效，不会无限持仓。

**Q: 豁免反转平仓会增加风险吗？**
A: 不会。RSI信号本身就预期短期反转，豁免反转平仓符合策略逻辑。同时其他风控机制（止损/止盈）仍然完善。

**Q: 可以给其他信号也添加豁免吗？**
A: 可以，但需要仔细评估。每种信号的策略逻辑不同，需要根据实际情况调整平仓规则。

---

## 技术参考

- **实现位置**: `app/services/strategy_executor_v2.py:2037-2042`
- **相关文档**: [RSI信号功能说明](./rsi_signal_feature.md)
- **相关优化**: [信号优化说明](./signal_improvements_2026-01-01.md)

---

## 更新日志

- **2026-01-01 v1.0**: 初始版本，实现RSI信号反转平仓豁免逻辑
