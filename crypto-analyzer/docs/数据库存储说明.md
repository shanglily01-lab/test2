# 模拟交易数据库存储说明

## ✅ 所有数据都已存入数据库

本系统确保所有交易相关数据都持久化存储到 MySQL 数据库中，包括：

### 1. 当前持仓 (`paper_trading_positions`)

**存储位置**: `paper_trading_positions` 表

**包含信息**:
- 账户ID、交易对
- 持仓数量、可用数量
- 平均买入价格、总成本
- 当前价格、市值
- 未实现盈亏、未实现收益率
- 止盈止损价格
- 首次买入时间、最后更新时间
- 持仓状态（open/closed）

**API端点**:
- `GET /api/paper-trading/positions` - 获取所有持仓（从数据库读取）

**保存时机**:
- ✅ 买入时自动创建或更新持仓记录
- ✅ 卖出时自动更新持仓数量或标记为已平仓
- ✅ 价格更新时自动更新市值和盈亏

---

### 2. 待成交订单 (`paper_trading_pending_orders`)

**存储位置**: `paper_trading_pending_orders` 表

**包含信息**:
- 账户ID、订单ID
- 交易对、订单方向（BUY/SELL）
- 委托数量、触发价格
- 冻结资金、冻结数量
- 订单状态（PENDING/EXECUTED/CANCELLED）
- 是否已执行
- 执行时间、执行后的订单ID
- 订单来源（manual/signal/auto）
- 创建时间、更新时间

**API端点**:
- `GET /api/paper-trading/pending-orders?executed=false` - 获取待成交订单（从数据库读取）
- `POST /api/paper-trading/pending-order` - 创建待成交订单（保存到数据库）
- `DELETE /api/paper-trading/pending-order/{order_id}` - 撤销待成交订单（从数据库删除）

**保存时机**:
- ✅ 创建自动买入/卖出订单时保存
- ✅ 订单执行后标记为已执行
- ✅ 撤销订单时从数据库删除

---

### 3. 历史订单 (`paper_trading_orders`)

**存储位置**: `paper_trading_orders` 表

**包含信息**:
- 账户ID、订单ID
- 交易对、订单方向、订单类型
- 委托价格、委托数量
- 已成交数量、已成交金额
- 总金额、手续费
- 订单状态（PENDING/FILLED/CANCELLED/REJECTED）
- 平均成交价格、成交时间
- 订单来源、信号ID
- 创建时间、更新时间

**API端点**:
- `GET /api/paper-trading/orders` - 获取所有订单历史（从数据库读取）
- `GET /api/paper-trading/orders?status=FILLED` - 获取已成交订单
- `GET /api/paper-trading/orders?status=CANCELLED` - 获取已撤销订单

**保存时机**:
- ✅ 每次下单时自动创建订单记录
- ✅ 订单成交后更新状态和成交信息
- ✅ 订单撤销时更新状态

---

### 4. 历史交易 (`paper_trading_trades`)

**存储位置**: `paper_trading_trades` 表

**包含信息**:
- 账户ID、订单ID、成交ID
- 交易对、交易方向（BUY/SELL）
- 成交价格、成交数量、成交金额
- 手续费
- 已实现盈亏、收益率（卖出时计算）
- 成本价（买入时）
- 成交时间

**API端点**:
- `GET /api/paper-trading/trades` - 获取所有交易历史（从数据库读取）
- `GET /api/paper-trading/trades?limit=100` - 获取最近100条交易记录

**保存时机**:
- ✅ 每次买入/卖出成交时自动创建交易记录
- ✅ 卖出时自动计算盈亏和收益率

---

### 5. 账户信息 (`paper_trading_accounts`)

**存储位置**: `paper_trading_accounts` 表

**包含信息**:
- 账户名称、账户类型
- 初始资金、当前余额、冻结余额
- 总权益（余额+持仓市值）
- 总盈亏、总收益率
- 已实现盈亏、未实现盈亏
- 总交易次数、盈利次数、亏损次数、胜率
- 最大回撤
- 账户状态、是否默认账户
- 创建时间、更新时间

**API端点**:
- `GET /api/paper-trading/account` - 获取账户信息（从数据库读取）
- `GET /api/paper-trading/account/summary` - 获取账户完整摘要（从数据库读取）

**保存时机**:
- ✅ 创建账户时保存
- ✅ 每次交易后自动更新余额和统计信息
- ✅ 持仓市值更新时自动更新总权益

---

### 6. 资金变动历史 (`paper_trading_balance_history`)

**存储位置**: `paper_trading_balance_history` 表

**包含信息**:
- 账户ID
- 资金快照（余额、冻结余额、总权益）
- 盈亏快照（已实现盈亏、未实现盈亏、总盈亏、总收益率）
- 变动类型（deposit/withdraw/trade/fee/pnl_update）
- 变动金额
- 关联订单ID
- 备注
- 快照时间

**保存时机**:
- ✅ 每次交易后自动记录资金变动
- ✅ 盈亏更新时自动记录快照

---

## 📊 数据流程图

```
下单 (place_order)
    ↓
创建订单记录 → paper_trading_orders
    ↓
执行交易 → paper_trading_trades
    ↓
更新持仓 → paper_trading_positions
    ↓
更新账户 → paper_trading_accounts
    ↓
记录资金变动 → paper_trading_balance_history
```

---

## 🔍 验证数据存储

### 检查持仓数据
```sql
SELECT * FROM paper_trading_positions 
WHERE account_id = 1 AND status = 'open';
```

### 检查待成交订单
```sql
SELECT * FROM paper_trading_pending_orders 
WHERE account_id = 1 AND executed = FALSE;
```

### 检查历史订单
```sql
SELECT * FROM paper_trading_orders 
WHERE account_id = 1 
ORDER BY created_at DESC 
LIMIT 50;
```

### 检查历史交易
```sql
SELECT * FROM paper_trading_trades 
WHERE account_id = 1 
ORDER BY trade_time DESC 
LIMIT 50;
```

### 检查账户信息
```sql
SELECT * FROM paper_trading_accounts 
WHERE id = 1;
```

---

## ✅ 数据持久化保证

1. **所有交易操作都使用数据库事务**，确保数据一致性
2. **所有数据都从数据库读取**，不依赖内存缓存
3. **前端刷新后数据不会丢失**，因为数据存储在数据库中
4. **支持多账户**，每个账户的数据独立存储
5. **完整的审计日志**，所有操作都有时间戳记录

---

## 🚀 使用建议

1. **定期备份数据库**，确保数据安全
2. **监控数据库大小**，定期清理历史数据（如需要）
3. **使用索引优化查询**，所有表都已创建必要的索引
4. **检查数据完整性**，定期验证数据一致性

---

**最后更新**: 2025-11-09
**版本**: v1.0

