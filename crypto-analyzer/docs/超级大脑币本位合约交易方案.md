# 超级大脑 - 币本位合约交易方案

> **最后更新**: 2026-02-21
> **系统版本**: V2.0 - 智能评分系统
> **核心特性**: 55分开仓阈值 + Big4趋势检测 + 智能分批建仓 + 紧急干预机制

---

## 📋 目录

1. [系统概述](#系统概述)
2. [核心特性](#核心特性)
3. [交易流程](#交易流程)
4. [配置说明](#配置说明)
5. [前端界面](#前端界面)
6. [API接口](#api接口)
7. [风险控制](#风险控制)
8. [运维管理](#运维管理)

---

## 系统概述

### 什么是币本位合约?

币本位合约(Coin-Margined Futures)是以加密货币(如BTC、ETH)作为保证金和结算货币的永续合约。

| 特性 | 币本位合约 | U本位合约 |
|------|----------|----------|
| 保证金货币 | BTC, ETH等 | USDT |
| 结算货币 | BTC, ETH等 | USDT |
| 交易对格式 | BTC/USD, ETH/USD | BTC/USDT, ETH/USDT |
| API端点 | dapi.binance.com | fapi.binance.com |
| WebSocket | dstream.binance.com | fstream.binance.com |
| Account ID | 3 | 2 |

### 系统架构

```
币本位合约交易系统
│
├── 币本位交易引擎 (CoinFuturesTradingEngine)
│   ├── 开仓/平仓执行
│   ├── 持仓管理
│   └── 风险控制
│
├── 自动交易服务 (CoinFuturesTraderService)
│   ├── 智能信号评分系统（55分阈值）
│   ├── 防追高/防杀跌过滤器
│   ├── 分批建仓执行器（3批: 30%-30%-40%）
│   ├── 智能平仓优化器
│   ├── Big4趋势检测
│   ├── Big4紧急干预机制
│   └── 3级黑名单评级制度
│
├── WebSocket价格服务 (币本位专用)
│   ├── 实时价格推送 (1秒更新)
│   ├── 多级降级策略
│   └── 价格缓存机制
│
└── 前端界面
    ├── 币本位合约交易页面
    ├── 账户信息展示
    ├── 持仓管理
    ├── 交易历史
    └── 复盘分析 (24H)
```

---

## 核心特性

### 1. 智能信号评分系统 (55分开仓阈值)

**开仓条件**: 综合评分 ≥ 55分 (理论最大232分，55分≈24%强度)

**评分维度**:
```python
signal_score = 位置评分 + 趋势评分 + 动量评分 + 量能评分

# 开仓条件
if total_score >= 55:
    execute_position()
```

### 2. 止盈止损参数

**自适应参数** (从数据库加载):
```yaml
LONG:
  止损: 3%
  止盈: 2%
  最小持仓: 60分钟
  仓位倍数: 1.0

SHORT:
  止损: 3%
  止盈: 2%
  最小持仓: 60分钟
  仓位倍数: 1.0
```

**参数来源**:
- 从 `adaptive_params` 表动态加载
- 支持自适应优化器自动调整
- 可通过API修改单笔持仓

### 3. 分批建仓执行器

**3批次建仓**:
```yaml
batch_1: 30%  # 15M阶段 (0-30分钟)
batch_2: 30%  # 5M阶段 (30-60分钟)
batch_3: 40%  # 5M阶段 (需间隔≥5分钟)
```

**每批独立持仓**:
- 每批建仓创建独立的 position_id
- 平均入场价格 (avg_entry_price) 自动计算
- batch_plan 和 batch_filled JSON字段记录详情

### 4. Big4紧急干预机制 (新增 🔥)

**触底反弹保护**:
```python
检测条件:
  • 4小时内最低价反弹 > 3%

触发效果:
  • 禁止做空2小时
  • 自动解除空头信号
  • 优先考虑做多机会
```

**触顶回调保护**:
```python
检测条件:
  • 4小时内最高价回调 < -3%

触发效果:
  • 禁止做多2小时
  • 自动解除多头信号
  • 优先考虑做空机会
```

**受影响交易对**:
- BTC/USD
- ETH/USD
- BNB/USD
- SOL/USD

### 5. Big4趋势检测

**权重体系**:
```python
COIN_WEIGHTS = {
    'BTC/USD': 0.50,  # 50% - 绝对领导者
    'ETH/USD': 0.30,  # 30%
    'BNB/USD': 0.10,  # 10%
    'SOL/USD': 0.10   # 10%
}
```

**应用规则**:
```python
# 顺势加仓
if (market_signal == 'BULLISH' and side == 'LONG') or \
   (market_signal == 'BEARISH' and side == 'SHORT'):
    position_multiplier = 1.2  # 仓位+20%

# 逆势惩罚
if market_signal == 'BEARISH' and side == 'LONG':
    if signal_strength >= 60:
        skip_this_signal()  # 强势市场直接跳过
    else:
        final_score -= penalty
```

### 6. 3级黑名单评级制度

| 级别 | 保证金倍数 | 说明 |
|------|----------|------|
| Level0 | 1.0 | 白名单（默认） |
| Level1 | 0.75 | 警告：降25% |
| Level2 | 0.875 | 谨慎：降12.5% |
| Level3 | 0 | 永久禁止 |

**自动评级**:
- 每日凌晨更新
- 根据最近30天交易数据
- BTC, ETH, BNB, SOL永不进黑名单

---

## 交易流程

### 完整交易周期

```
1. 信号产生
   ├─ 多维度评分（位置+趋势+动量+量能）
   ├─ Big4趋势过滤
   └─ 综合评分 ≥ 55分

2. 紧急干预检查
   ├─ 检查Big4反转标志
   ├─ 底部反弹 → 禁止做空
   └─ 顶部回调 → 禁止做多

3. 分批建仓 (K线回调策略)
   ├─ Batch 1 (30%): 15M阶段等待反向K线
   ├─ Batch 2 (30%): 5M阶段等待反向K线
   └─ Batch 3 (40%): 间隔≥5分钟后执行

4. 持仓监控
   ├─ 固定止损: 3%
   ├─ 固定止盈: 2%
   ├─ 最小持仓: 60分钟
   └─ 实时价格监控

5. 平仓执行
   └─ 全部平仓（不分批）
```

---

## 配置说明

### 核心参数

```python
account_id = 3                           # 币本位账户ID
position_size_usdt = 400                 # 默认仓位 ($400)
blacklist_position_size_usdt = 100       # 黑名单仓位 ($100)
max_positions = 999                      # 无持仓数量限制
leverage = 5                             # 默认杠杆 (5x)
scan_interval = 300                      # 扫描间隔 (300秒)
threshold = 55                           # 开仓评分阈值
```

### 支持的交易对

```yaml
coin_futures_symbols:
  - BTCUSD_PERP    # BTC/USD 永续合约
  - ETHUSD_PERP    # ETH/USD 永续合约
  - BNBUSD_PERP    # BNB/USD 永续合约
  - SOLUSD_PERP    # SOL/USD 永续合约
  - XRPUSD_PERP    # XRP/USD 永续合约
  # ... 共21个交易对
```

---

## 前端界面

### 币本位合约交易页面

访问: http://localhost:9020/coin_futures_trading

**功能模块**:

1. **账户总览**
   - 账户ID: 3 (币本位合约账户)
   - 账户余额
   - 冻结保证金
   - 未实现盈亏
   - 已实现盈亏
   - 收益率
   - 胜率

2. **交易面板**
   - 交易对选择: 21个币本位交易对
   - 方向选择: LONG/SHORT
   - 数量设置
   - 杠杆设置: 1-125倍
   - 止损止盈设置
   - 开仓/平仓按钮

3. **持仓列表**
   - 实时显示所有开仓持仓
   - 自动刷新价格和盈亏
   - 手动平仓功能

4. **交易历史**
   - 已平仓交易记录
   - 分页显示
   - 筛选功能

---

## API接口

### 基础信息

**Base URL**: `http://localhost:9020/api/coin-futures`

### 主要接口

#### 1. 获取账户信息

```http
GET /api/coin-futures/account/3
```

**响应**:
```json
{
  "success": true,
  "data": {
    "account_id": 3,
    "account_name": "币本位合约账户",
    "account_type": "coin_futures",
    "current_balance": 102345.67,
    "frozen_balance": 3580.24,
    "unrealized_pnl": 234.56,
    "realized_pnl": 2345.67,
    "total_equity": 102580.23,
    "win_rate": 62.82,
    "roi": 2.58
  }
}
```

#### 2. 开仓

```http
POST /api/coin-futures/open
```

**请求体**:
```json
{
  "account_id": 3,
  "symbol": "BTC/USD",
  "position_side": "LONG",
  "quantity": 0.1,
  "leverage": 5,
  "stop_loss_pct": 3.0,
  "take_profit_pct": 2.0,
  "source": "manual"
}
```

#### 3. 平仓

```http
POST /api/coin-futures/close/{position_id}
```

**请求体**:
```json
{
  "close_reason": "手动平仓"
}
```

#### 4. 获取持仓列表

```http
GET /api/coin-futures/positions?account_id=3&status=open
```

---

## 风险控制

### 止盈止损保护机制

**止盈失效保护**:
```python
if triggered_by_take_profit and actual_pnl < 0:
    cancel_close()  # 止盈触发但实际亏损，取消平仓
    logger.warning("止盈触发但实际亏损，不执行平仓")
```

### 强平价格计算

```python
# LONG持仓
liquidation_price = entry_price * (1 - 1/leverage + maintenance_margin_rate)

# SHORT持仓
liquidation_price = entry_price * (1 + 1/leverage - maintenance_margin_rate)

# 维持保证金率: 0.5% (硬编码)
```

### 保证金限制

```python
single_position_margin <= total_equity * 0.10  # 单笔不超过总权益10%
```

---

## 运维管理

### 启动服务

```bash
# 直接运行
python coin_futures_trader_service.py

# 后台运行
nohup python coin_futures_trader_service.py > logs/coin_futures.log 2>&1 &
```

### 日志监控

**关键日志标签**:
```
[COIN_FUTURES]   - 币本位交易
[BIG4-EMERGENCY] - Big4紧急干预
[BATCH-ENTRY]    - 分批建仓
[STOP-PROTECTION] - 止盈保护
```

### 常用命令

```bash
# 查看当前持仓
mysql -e "SELECT symbol, position_side, unrealized_pnl_pct, status
FROM futures_positions WHERE account_id=3 AND status='open';"

# 查看24H盈亏
mysql -e "SELECT SUM(realized_pnl) as total_pnl, COUNT(*) as trades
FROM futures_positions WHERE account_id=3 AND
close_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR);"
```

---

## 数据库结构

### 核心字段

**futures_positions 表**:
```sql
account_id          INT             -- 币本位=3
coin_margin         TINYINT(1)      -- 币本位标记(1=币本位,0=U本位)
symbol              VARCHAR(20)     -- BTC/USD, ETH/USD等
entry_price         DECIMAL(18,8)   -- 开仓价格
avg_entry_price     DECIMAL(20,8)   -- 平均入场价（分批建仓用）
batch_plan          LONGTEXT        -- 分批建仓计划(JSON)
batch_filled        LONGTEXT        -- 已完成批次记录(JSON)
entry_signal_type   VARCHAR(500)    -- 开仓信号类型
entry_score         INT             -- 开仓评分(55分阈值)
entry_ema_diff      DECIMAL(18,8)   -- 开仓时EMA差值
```

**futures_trading_accounts 表**:
```sql
id                  INT PRIMARY KEY -- 账户ID (币本位=3)
account_type        VARCHAR(50)     -- 'coin_futures'
current_balance     DECIMAL(20,2)   -- 当前可用余额
frozen_balance      DECIMAL(20,2)   -- 冻结余额(保证金)
total_equity        DECIMAL(20,2)   -- 总权益
```

### 数据库初始化

```sql
INSERT INTO futures_trading_accounts (
    id, user_id, account_name, account_type,
    initial_balance, current_balance, frozen_balance,
    created_at, updated_at
) VALUES (
    3, 1000, '币本位合约账户', 'coin_futures',
    100000.00, 100000.00, 0.00,
    NOW(), NOW()
);
```

---

## 常见问题

### Q1: 为什么开仓阈值是55分？

**A**: 55分是经过优化后的阈值，确保只交易高质量信号。在理论最大232分的评分体系中，55分约占24%强度，能有效过滤掉低质量信号。

### Q2: 紧急干预机制如何工作？

**A**: 系统实时监控Big4的价格波动：
- **底部反弹**: 4小时内最低价反弹>3% → 禁止做空2小时
- **顶部回调**: 4小时内最高价回调<-3% → 禁止做多2小时

这能有效避免在市场急转直下时逆向开仓。

### Q3: 为什么止盈比止损小？

**A**: 当前配置（止损3% vs 止盈2%）是为了快速锁定利润，避免浮盈回吐。这种配置适合高胜率、小盈亏比的策略。如需调整，可修改 `adaptive_params` 表。

### Q4: 分批建仓如何优化成本？

**A**: 通过等待K线回调确认入场：
- 第1批: 等待15M反向K线
- 第2批: 等待5M反向K线
- 第3批: 间隔5分钟后执行

这样能避免一次性追高/杀跌，优化平均入场价格。

### Q5: 如何备份数据？

**A**:
```bash
# 备份币本位账户数据
mysqldump -u root -p binance-data \
  futures_trading_accounts \
  futures_positions \
  futures_trades \
  --where="account_id=3" \
  > coin_futures_backup_$(date +%Y%m%d).sql

# 恢复
mysql -u root -p binance-data < coin_futures_backup_20260221.sql
```

---

## 总结

币本位合约交易系统通过以下核心机制实现稳定盈利:

1. ✅ **55分开仓阈值** - 确保只交易高质量信号
2. ✅ **Big4权重判断** - BTC 50% / ETH 30% / BNB 10% / SOL 10%
3. ✅ **紧急干预机制** - 底部反弹/顶部回调2小时保护
4. ✅ **智能分批建仓** - 3批K线回调确认，每批独立持仓
5. ✅ **止盈保护机制** - 防止止盈触发时实际亏损
6. ✅ **3级黑名单制度** - 自动评级，动态调整仓位
7. ✅ **实盘同步** - 支持模拟盘同步实盘平仓

**关键参数**:
- 账户ID: 3
- 开仓阈值: 55分
- 分批比例: 30% / 30% / 40%
- 止损止盈: 3% / 2%
- 杠杆倍数: 5倍

---

**文档版本**: V2.0
**最后更新**: 2026-02-21
**维护者**: 超级大脑开发团队
