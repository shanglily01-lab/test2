# 安全模式切换系统 - 使用指南

> **版本**: V2.0 (安全增强版)
> **更新时间**: 2026-02-06
> **风险等级**: 🟢 低风险（已增加多重保护）

---

## ✅ 新版安全特性

### 系统已自动启用以下保护机制：

#### 1. **持仓检查** 🛡️
- 有任何持仓时，**禁止自动切换**
- 确保策略一致性，避免新旧策略冲突

#### 2. **连续确认机制** 🔍
- 需要**连续3次Big4检测**都满足条件才切换
- 每次检测间隔15分钟
- 总计需要45分钟确认期
- 避免因单次波动导致误切换

#### 3. **更严格的阈值** 📊
```
震荡模式: 强度 < 40 (原50)  ← 降低10
趋势模式: 强度 ≥ 70 (原60)  ← 提高10
缓冲区: 40-70 之间不切换    ← 新增30点缓冲
```

#### 4. **延长冷却期** ⏱️
- 最小冷却期：**6小时**（原120分钟）
- 即使数据库配置更短，也会强制使用6小时

#### 5. **降级保护** 🔄
- Big4检测失败时，**保持当前模式**
- 不再强制切换到趋势模式

---

## 📊 切换流程示例

### 从趋势模式切换到震荡模式

```
时间线:
10:00 - Big4检测: NEUTRAL(39) ✓ 满足震荡条件
10:15 - Big4检测: NEUTRAL(38) ✓ 满足震荡条件
10:30 - Big4检测: NEUTRAL(37) ✓ 满足震荡条件
      → 连续3次确认通过
      → 检查持仓: 0个 ✓
      → 检查冷却期: 距上次切换8小时 ✓
      → 执行切换: trend → range
```

### 触发保护机制的案例

```
案例1: 持仓保护
10:00 - Big4: NEUTRAL(35), 连续确认通过
      - 当前持仓: 5个
      → ❌ 禁止切换，保持趋势模式

案例2: 确认失败
10:00 - Big4: NEUTRAL(38) ✓
10:15 - Big4: NEUTRAL(42) ❌ (超过40)
10:30 - Big4: NEUTRAL(37) ✓
      → ❌ 未通过连续确认，不切换

案例3: 冷却期保护
10:00 - Big4: NEUTRAL(35), 连续确认通过
      - 上次切换时间: 08:30 (1.5小时前)
      → ❌ 冷却期未满6小时，不切换

案例4: 缓冲区保护
当前强度: 55
      - 不满足震荡(<40)
      - 不满足趋势(≥70)
      → ✅ 在缓冲区，保持当前模式
```

---

## 🎯 推荐配置

### 数据库配置

```sql
-- 查看当前配置
SELECT
    account_id,
    trading_type,
    mode_type,
    auto_switch_enabled,
    switch_cooldown_minutes,
    last_switch_time
FROM trading_mode_config
WHERE account_id = 2;

-- 推荐配置（启用自动切换）
UPDATE trading_mode_config
SET
    auto_switch_enabled = 1,              -- 启用自动切换
    mode_type = 'trend',                  -- 初始模式：趋势
    switch_cooldown_minutes = 480,        -- 冷却期8小时（更保守）
    updated_at = NOW()
WHERE account_id = 2;
```

### 调整冷却期

```sql
-- 更激进（不推荐）
UPDATE trading_mode_config
SET switch_cooldown_minutes = 360  -- 6小时
WHERE account_id = 2;

-- 更保守（推荐）
UPDATE trading_mode_config
SET switch_cooldown_minutes = 720  -- 12小时
WHERE account_id = 2;

-- 非常保守
UPDATE trading_mode_config
SET switch_cooldown_minutes = 1440 -- 24小时
WHERE account_id = 2;
```

---

## 📈 监控与调试

### 查看切换历史

```sql
-- 最近10次切换
SELECT
    switched_at,
    from_mode,
    to_mode,
    switch_trigger,
    big4_signal,
    big4_strength,
    reason,
    switched_by
FROM trading_mode_switch_log
WHERE account_id = 2
ORDER BY switched_at DESC
LIMIT 10;
```

### 查看Big4历史（验证连续确认）

```sql
-- 最近3次Big4检测
SELECT
    checked_at,
    overall_signal,
    signal_strength,
    TIMESTAMPDIFF(MINUTE, LAG(checked_at) OVER (ORDER BY checked_at), checked_at) as interval_minutes
FROM big4_trend_signals
ORDER BY checked_at DESC
LIMIT 3;
```

### 统计自动切换效果

```sql
-- 统计24小时内的切换次数
SELECT
    COUNT(*) as total_switches,
    SUM(CASE WHEN switch_trigger = 'auto' THEN 1 ELSE 0 END) as auto_switches,
    SUM(CASE WHEN switch_trigger = 'manual' THEN 1 ELSE 0 END) as manual_switches
FROM trading_mode_switch_log
WHERE account_id = 2
AND switched_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR);

-- 分析切换后的交易表现
SELECT
    l.to_mode,
    COUNT(p.id) as trades_after_switch,
    SUM(CASE WHEN p.realized_pnl > 0 THEN 1 ELSE 0 END) as winning_trades,
    AVG(p.realized_pnl) as avg_pnl
FROM trading_mode_switch_log l
LEFT JOIN futures_positions p ON
    p.account_id = l.account_id
    AND p.open_time BETWEEN l.switched_at AND DATE_ADD(l.switched_at, INTERVAL 4 HOUR)
    AND p.status = 'closed'
WHERE l.account_id = 2
AND l.switched_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY l.to_mode;
```

---

## 🔧 日志监控

### 关键日志标签

启用自动切换后，关注以下日志：

```
[SAFE-MODE-SWITCH]  - 安全切换检查结果
[MODE-CHECK-ERROR]  - 模式检查失败（需要关注）
[TRADING-MODE]      - 当前运行模式
```

### 日志示例

```bash
# 成功切换
2026-02-06 10:30:00 | INFO | 🔄 [SAFE-MODE-SWITCH] Big4=NEUTRAL(37.0)
2026-02-06 10:30:00 | INFO |    安全检查: 持仓=0, 冷却=True, 确认=True
2026-02-06 10:30:00 | INFO |    建议切换: trend → range
2026-02-06 10:30:01 | INFO | ✅ [SAFE-MODE-SWITCH] 模式切换成功: trend → range

# 持仓保护
2026-02-06 14:15:00 | WARN | 🚫 [SAFE-MODE-SWITCH] 当前有5个持仓，禁止自动切换

# 确认失败
2026-02-06 16:20:00 | INFO | ❌ 震荡确认失败: NEUTRAL(42.0)
2026-02-06 16:20:00 | WARN | ⚠️ [SAFE-MODE-SWITCH] 切换到range模式未通过连续确认

# 冷却期保护
2026-02-06 18:00:00 | INFO | ⏳ [SAFE-MODE-SWITCH] 冷却期中，剩余240.5分钟
```

---

## 🚨 告警配置（可选）

### 设置切换通知

如果你想在每次切换时收到通知，可以添加以下触发器：

```sql
DELIMITER $$
CREATE TRIGGER mode_switch_alert
AFTER INSERT ON trading_mode_switch_log
FOR EACH ROW
BEGIN
    -- 这里可以调用通知API或写入告警表
    -- 示例：记录到告警日志
    INSERT INTO system_alerts (
        alert_type,
        alert_level,
        message,
        created_at
    ) VALUES (
        'MODE_SWITCH',
        'INFO',
        CONCAT('账户', NEW.account_id, '模式切换: ',
               NEW.from_mode, ' → ', NEW.to_mode,
               ' (', NEW.reason, ')'),
        NOW()
    );
END$$
DELIMITER ;
```

---

## ❓ 常见问题

### Q1: 如果我想禁用自动切换怎么办？

```sql
UPDATE trading_mode_config
SET auto_switch_enabled = 0
WHERE account_id = 2;
```

### Q2: 为什么强度55时不切换？

**答**: 强度55在缓冲区（40-70）内，系统设计为"保持当前模式"。这是为了避免在边界值频繁切换。

### Q3: 如果Big4服务挂了会怎样？

**答**: 系统会捕获异常，**保持当前模式**，不会强制切换。日志会显示 `[MODE-CHECK-ERROR]`。

### Q4: 可以手动强制切换吗？

**答**: 可以，通过API或数据库直接修改：

```sql
-- 手动切换到震荡模式
UPDATE trading_mode_config
SET mode_type = 'range',
    last_switch_time = NOW()
WHERE account_id = 2;
```

### Q5: 连续确认3次太慢了，可以改成2次吗？

**答**: 可以修改 `safe_mode_switcher.py` 中的 `CONFIRMATION_COUNT = 3` 改为 `2`。但不建议，会增加误切换风险。

### Q6: 如何查看系统是否在正常工作？

```sql
-- 查看最近的Big4检测记录
SELECT checked_at, overall_signal, signal_strength
FROM big4_trend_signals
ORDER BY checked_at DESC
LIMIT 5;

-- 如果最近15分钟没有新记录，说明Big4检测可能停止了
```

---

## 📝 变更记录

### V2.0 (2026-02-06) - 安全增强版
- ✅ 新增持仓检查保护
- ✅ 新增连续3次确认机制
- ✅ 调整阈值：震荡<40, 趋势≥70
- ✅ 增加40-70缓冲区
- ✅ 最小冷却期6小时
- ✅ Big4失败时保持当前模式

### V1.0 (之前) - 原始版本
- 震荡<50, 趋势≥60
- 单次检测即切换
- 无持仓检查
- 冷却期120分钟

---

## 🎓 最佳实践

1. **初次启用**: 先观察1-2天，查看切换频率和效果
2. **冷却期设置**: 建议从8-12小时开始，逐步调整
3. **定期检查**: 每周查看切换日志和交易表现
4. **持仓控制**: 不要在接近切换时间点大量开仓
5. **手动干预**: 如果发现异常，随时可以手动禁用或切换

---

**结论**: 新版安全模式切换系统通过多重保护机制，将自动切换的风险降到最低，同时保留了自动化的便利性。无需24小时值守，系统会安全、稳定地运行。

**建议**: 启用自动切换，初期设置较长的冷却期（8-12小时），观察1-2周后根据实际效果调整。
