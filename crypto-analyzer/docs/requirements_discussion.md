# 需求讨论

## 当前状态分析

### 策略现状
- **策略本身有效**：在明确的涨/跌趋势中可以盈利
- **不需要修改策略核心逻辑**

### 存在的问题

| 问题 | 描述 | 影响 |
|-----|------|-----|
| 1. 震荡行情频繁开单 | 趋势不明时仍然开仓 | 无效亏损 |
| 2. 连续亏损继续开单 | 没有及时止损机制 | 扩大亏损 |
| 3. 缺少有效侦察机制 | 无法及时发现市场反转 | 错过恢复时机 |

---

## 解决方案思路

### 问题1：震荡行情频繁开单

**震荡行情定义（已确认）：**
```
震荡行情条件（使用15分钟K线）：
- EMA差值 < 0.8%（EMA9和EMA26接近）
- ADX < 25（趋势强度弱）
```

**解决方案（已确认）：**
- 检测周期：**15分钟K线**
- 检测到震荡行情 → **完全禁止该交易对开仓**
- 等待趋势确认后（不再是震荡）恢复开仓

**实现逻辑：**
```
每次开仓前检查15M行情类型:
    如果 行情类型 == 'ranging' (震荡):
        → 禁止开仓
        → 记录日志："震荡行情，禁止开仓"
    否则:
        → 允许开仓
```

### 问题2：连续亏损熔断后如何处理现有仓位

**触发熔断时需要处理：**

| 类型 | 处理方式 | 说明 |
|-----|---------|-----|
| 挂单（未成交限价单） | **全部取消** | 避免继续开新仓 |
| 已有持仓 | **？** | 需要您确认 |

**已有持仓的处理选项：**

**方案A：让它自己运行（不干预）**
- 优点：持仓可能转亏为盈，不强制平仓
- 缺点：如果继续亏损，扩大损失
- 适用：止损已设置好的情况

**方案B：立即全部平仓**
- 优点：立即止损，防止扩大亏损
- 缺点：可能平在最差的位置，错过反弹
- 适用：趋势明确反转的情况

**方案C：收紧止损（移动止损到成本价附近）**
- 优点：保护利润/限制亏损，但不强制平仓
- 缺点：实现较复杂
- 适用：希望给仓位一点空间的情况

**解决方案（已确认）：**

| 类型 | 处理方式 |
|-----|---------|
| 同方向的挂单（未成交限价单） | **全部取消** |
| 同方向的已有持仓 | **立即平仓** |
| 不同方向的挂单和持仓 | **保留不动** |

**实现逻辑：**
```
触发熔断（例如做多方向连续4单亏损）:
    1. 取消所有做多方向的挂单
    2. 平掉所有做多方向的持仓
    3. 做空方向的挂单和持仓保持不变
    4. 进入侦察模式
```

### 问题3：哨兵单机制（已确认）

**核心思路：**
- 熔断后不用真实交易做侦察，改用"虚拟哨兵单"
- 哨兵单跟随策略信号创建，但**不实际开仓**
- 只记录"如果开仓会怎样"的结果
- 连续2单盈利后恢复正常开仓

**哨兵单规则（已确认）：**

| 项目 | 规则 |
|-----|------|
| **创建条件** | 熔断后，策略发出开仓信号时创建哨兵单 |
| **记录内容** | 入场价、方向、止损价、止盈价、时间 |
| **止损止盈** | 跟策略配置的一样 |
| **判定盈亏** | 根据市场价格变化判定是否触及止盈/止损 |
| **恢复条件** | **连续2单盈利**即可恢复正常交易 |
| **恢复时处理** | 删除所有未平仓的哨兵单 |
| **超时处理** | 无超时，持续监控直到触及止盈/止损 |
| **不计入** | 不计入模拟盘持仓、不计入实际盈亏统计 |

**实现逻辑：**
```
熔断触发后:
    1. 进入"哨兵模式"
    2. 策略发出开仓信号时:
        - 不实际开仓
        - 创建哨兵单记录（入场价、止损、止盈）
    3. 后台监控哨兵单:
        - 价格触及止盈 → 记录盈利
        - 价格触及止损 → 记录亏损
        - 盈利后重置连续盈利计数
        - 亏损后重置连续盈利计数为0
    4. 检查恢复条件:
        - 连续2单盈利 → 恢复正常开仓
        - 删除所有未平仓的哨兵单
    5. 恢复后正常开仓
```

**哨兵单数据结构：**
```
sentinel_orders 表:
- id: 主键
- direction: 方向 (long/short)
- symbol: 交易对
- entry_price: 入场价
- stop_loss_price: 止损价
- take_profit_price: 止盈价
- status: 状态 (open/win/loss)
- created_at: 创建时间
- closed_at: 平仓时间
- close_reason: 平仓原因 (stop_loss/take_profit)
```

---

## 已确认的解决方案汇总

| 问题 | 解决方案 | 状态 |
|-----|---------|------|
| 1. 震荡行情开单 | 15M K线检测震荡（EMA差值<0.8%, ADX<25），完全禁止开仓 | ✅ 已确认 |
| 2. 熔断时仓位处理 | 同方向挂单取消、持仓平仓；不同方向保留 | ✅ 已确认 |
| 3. 哨兵单机制 | 虚拟哨兵单监控市场，连续2单盈利恢复正常 | ✅ 已确认 |

---

## 需求确认完成

所有需求已确认，可以开始实现。

