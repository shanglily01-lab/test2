# 策略命中监控使用说明

## 功能概述

策略命中监控系统会实时检查交易策略的信号命中情况，并将所有命中信息保存到数据库中，无论信号是否最终执行交易。

## 数据库表结构

### `strategy_hits` 表

存储所有策略信号命中记录，包括：

- **策略信息**：策略ID、策略名称、账户ID
- **信号信息**：信号类型（BUY_LONG/BUY_SHORT/SELL）、信号来源、时间周期、触发时间
- **技术指标值**：EMA、MA等指标的具体数值
- **信号强度**：EMA交叉强度、MA10/EMA10强度百分比
- **过滤条件检查结果**：成交量条件、趋势过滤、信号强度过滤等
- **执行结果**：是否执行、执行结果、执行原因、关联的持仓ID和订单ID

## 使用方法

### 1. 运行数据库迁移

首先需要创建数据库表：

```bash
python scripts/run_migration_009.py
```

### 2. 启动策略执行服务

**重要提示**：命中记录功能已经集成到 `strategy_scheduler.py` 中，**不需要单独运行 `monitor_strategy_hits.py`**。

启动策略调度器（它会自动记录命中信息）：

```bash
python app/strategy_scheduler.py
```

策略调度器会：
- 每5秒检查一次所有启用的策略
- 检测到信号时立即记录到数据库
- 执行交易后更新记录的执行结果

**⚠️ 注意**：不要同时运行 `monitor_strategy_hits.py` 和 `strategy_scheduler.py`，否则会导致策略重复执行！

### 3. 查询策略命中记录

通过API查询策略命中记录：

```bash
# 查询所有命中记录（最近24小时）
GET /api/strategies/hits

# 查询指定策略的命中记录
GET /api/strategies/hits?strategy_id=1

# 查询指定交易对的命中记录
GET /api/strategies/hits?symbol=BTC/USDT

# 查询已执行的命中记录
GET /api/strategies/hits?executed=true

# 查询未执行的命中记录
GET /api/strategies/hits?executed=false

# 查询指定信号类型
GET /api/strategies/hits?signal_type=BUY_LONG

# 查询指定时间范围
GET /api/strategies/hits?time_range=7d

# 组合查询
GET /api/strategies/hits?strategy_id=1&symbol=BTC/USDT&executed=true&time_range=24h&limit=50
```

### 4. 查看日志

监控服务的日志保存在：
- 控制台输出（INFO级别）
- `logs/strategy_hits_YYYY-MM-DD.log`（DEBUG级别，包含详细信息）

## 记录的内容

### 买入信号（BUY_LONG / BUY_SHORT）

当检测到EMA(9,26)交叉信号时，会记录：

- ✅ 信号类型（做多/做空）
- ✅ 当前价格和技术指标值
- ✅ 信号强度百分比
- ✅ 成交量条件检查结果
- ✅ MA10/EMA10趋势过滤结果
- ✅ 趋势持续性检查结果
- ✅ 最终是否执行交易
- ✅ 如果执行，关联的持仓ID和订单ID

### 卖出信号（SELL）

当检测到卖出信号时，会记录：

- ✅ 信号类型（SELL）
- ✅ 信号来源（ema_5m/ema_15m/ma_ema5/ma_ema10）
- ✅ 当前价格和技术指标值
- ✅ 成交量条件检查结果
- ✅ 最终是否执行平仓
- ✅ 如果执行，关联的持仓ID

## 数据统计

可以通过查询API获取统计数据：

```python
# 统计命中次数
GET /api/strategies/hits?strategy_id=1&time_range=7d

# 统计执行率
# 已执行数量 / 总命中数量
```

## 注意事项

1. **数据库表必须先创建**：运行迁移脚本创建 `strategy_hits` 表
2. **监控服务需要持续运行**：确保监控服务在后台运行，才能实时记录命中信息
3. **策略必须启用**：只有启用的策略才会被监控
4. **数据保留**：命中记录会永久保存在数据库中，建议定期清理旧数据

## 故障排查

### 监控服务无法启动

1. 检查数据库连接配置是否正确
2. 检查数据库表是否已创建
3. 查看日志文件了解详细错误信息

### 没有记录命中信息

1. 确认监控服务正在运行
2. 确认策略已启用
3. 检查策略配置是否正确
4. 查看日志确认是否有信号检测

### 查询API返回空数据

1. 确认时间范围设置正确
2. 确认策略ID、交易对等过滤条件正确
3. 检查数据库中是否有数据：`SELECT COUNT(*) FROM strategy_hits`

## 示例

### 启动监控服务

```bash
# 在项目根目录运行
python scripts/monitor_strategy_hits.py
```

输出示例：
```
============================================================
🚀 策略命中监控服务启动
============================================================
监控间隔: 5秒（实时监控）
开始时间: 2025-01-22 20:00:00
============================================================

✅ 策略命中记录已保存: 策略=测试策略, 交易对=BTC/USDT, 信号=BUY_LONG, ID=1
✅ 策略命中记录已更新: ID=1, 执行结果=SUCCESS
```

### 查询命中记录

```bash
curl "http://localhost:8000/api/strategies/hits?strategy_id=1&time_range=24h"
```

返回示例：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "strategy_id": 1,
      "strategy_name": "测试策略",
      "symbol": "BTC/USDT",
      "signal_type": "BUY_LONG",
      "signal_source": "ema_9_26",
      "signal_timeframe": "15m",
      "signal_timestamp": "2025-01-22 20:00:00",
      "current_price": 45000.0,
      "ema_short": 45100.0,
      "ema_long": 44900.0,
      "executed": true,
      "execution_result": "SUCCESS",
      "execution_reason": "所有条件满足，已执行开仓",
      "position_id": 123,
      "order_id": "456"
    }
  ],
  "count": 1
}
```

