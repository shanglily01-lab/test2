# 信号黑名单动态加载方案

## 概述

实现了信号黑名单的动态加载机制，支持运行时自动刷新黑名单数据，无需重启交易服务。

## 问题背景

### 原有实现问题
1. **一次性加载**: 黑名单在服务启动时从数据库加载一次后就不再更新
2. **运行时更新无效**: 通过脚本或管理界面添加新的黑名单记录后，必须重启服务才能生效
3. **维护不便**: 在生产环境中频繁重启服务风险大、影响交易

### 黑名单触发条件
根据历史统计数据，以下信号组合需要被禁用：
- **胜率 < 40%** 且 **订单数 > 5笔**: 完全禁用（不开仓）
- **胜率 < 50%**: 开仓金额减半（降低风险）

## 解决方案

### 1. 新增信号黑名单检查器服务

**文件**: `app/services/signal_blacklist_checker.py`

**核心功能**:
- 带缓存的动态加载（默认5分钟缓存过期）
- 自动检查缓存过期并重新加载
- 支持手动强制刷新
- 灵活的模式匹配（精确匹配、子串匹配、组件匹配）
- 返回详细的黑名单原因

**关键特性**:
```python
class SignalBlacklistChecker:
    def __init__(self, db_config: dict, cache_minutes: int = 5):
        """初始化检查器，默认5分钟缓存"""

    def is_blacklisted(self, signal_combination: str, direction: str):
        """检查信号是否在黑名单，自动处理缓存过期"""

    def force_reload(self):
        """强制重新加载黑名单（忽略缓存）"""

    def get_margin_multiplier(self, signal_combination: str, direction: str):
        """获取开仓金额乘数（0.0=禁用，0.5=减半，1.0=正常）"""
```

### 2. 模式匹配策略

支持三种匹配方式（按优先级）：

#### 2.1 精确匹配
```
黑名单: "breakdown_short+跌势3%+高波动+volume_power_1h_bear"
信号:   "breakdown_short+跌势3%+高波动+volume_power_1h_bear"
结果:   ✅ 匹配
```

#### 2.2 子串匹配
```
黑名单: "breakdown_short"
信号:   "breakdown_short+跌势3%+高波动"
结果:   ✅ 匹配（包含子串）
```

#### 2.3 组件匹配
```
黑名单: "breakdown_short+跌势3%"
信号:   "跌势3%+breakdown_short+高波动"  (顺序不同)
结果:   ✅ 匹配（所有组件都存在）
```

### 3. 集成到交易服务

#### 3.1 U本位合约 (smart_trader_service.py)

**初始化**:
```python
class SmartDecisionBrain:
    def __init__(self, db_config: dict):
        # ...现有代码...

        # 初始化信号黑名单检查器（动态加载，5分钟缓存）
        self.blacklist_checker = SignalBlacklistChecker(db_config, cache_minutes=5)
```

**信号检查**:
```python
# 旧代码（一次性加载）
blacklist_key = f"{signal_combination_key}_{side}"
if blacklist_key in self.signal_blacklist:
    logger.info(f"🚫 {symbol} 信号在黑名单中")
    return None

# 新代码（动态检查）
is_blacklisted, blacklist_reason = self.blacklist_checker.is_blacklisted(signal_combination_key, side)
if is_blacklisted:
    logger.info(f"🚫 {symbol} 信号 [{signal_combination_key}] {side} 在黑名单中，跳过（{blacklist_reason}）")
    return None
```

**配置重载**:
```python
def reload_config(self):
    """重新加载配置 - 供外部调用"""
    logger.info("🔄 重新加载配置文件...")
    self._load_config()
    # 同时强制重新加载信号黑名单
    if hasattr(self, 'blacklist_checker'):
        self.blacklist_checker.force_reload()
    return len(self.whitelist)
```

#### 3.2 币本位合约 (coin_futures_trader_service.py)

与U本位合约相同的集成方式。

### 4. 数据库表结构

**表名**: `signal_blacklist`

```sql
CREATE TABLE `signal_blacklist` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `signal_type` varchar(500) DEFAULT NULL,              -- 信号模式
  `position_side` varchar(10) NOT NULL,                 -- 方向（LONG/SHORT）
  `reason` varchar(255) DEFAULT NULL,                   -- 禁用原因
  `total_loss` decimal(15,2) DEFAULT NULL,              -- 历史总亏损
  `win_rate` decimal(5,4) DEFAULT NULL,                 -- 胜率（0-1）
  `order_count` int(11) DEFAULT NULL,                   -- 订单数量
  `is_active` tinyint(1) DEFAULT 1,                     -- 是否激活
  `notes` text DEFAULT NULL,                            -- 备注
  `created_at` timestamp NOT NULL DEFAULT current_timestamp(),
  `updated_at` timestamp NOT NULL DEFAULT current_timestamp() ON UPDATE current_timestamp(),
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_signal_side` (`signal_type`,`position_side`)
)
```

### 5. 已添加的黑名单记录

通过脚本 `scripts/add_signal_blacklist.py` 添加了3条黑名单记录：

| 信号模式 | 方向 | 胜率 | 亏损 | 订单数 | 原因 |
|---------|-----|------|------|-------|------|
| breakdown_short | SHORT | 35.0% | 350.00U | 50 | 破位做空信号整体表现差，追跌违背90分位策略 |
| breakdown_short+跌势3%+高波动+volume_power_1h_bear | SHORT | 30.8% | 294.27U | 13 | 最差信号组合之一 |
| breakdown_short+跌势3%+1H看跌+高波动+volume_power_bear | SHORT | 37.5% | 14.09U | 8 | 低胜率信号 |

## 使用方式

### 方式1: 自动刷新（推荐）
系统每5分钟自动检查并重新加载黑名单，无需任何操作。

### 方式2: 手动添加黑名单
```bash
# 1. 编辑 scripts/add_signal_blacklist.py，添加新的黑名单记录
# 2. 运行脚本
python scripts/add_signal_blacklist.py

# 3. 等待5分钟自动生效，或通过API手动触发刷新
```

### 方式3: 通过管理界面添加
```python
# 在数据库中直接插入记录
INSERT INTO signal_blacklist (signal_type, position_side, reason, win_rate, total_loss, order_count, is_active)
VALUES ('signal_pattern', 'SHORT', '胜率过低', 0.35, 100.0, 10, 1);

# 最多等待5分钟自动生效
```

### 方式4: 强制立即刷新
```python
# 通过服务对象
brain.reload_config()  # 会同时刷新黑名单

# 或直接调用黑名单检查器
brain.blacklist_checker.force_reload()
```

## 测试验证

运行测试脚本验证功能：
```bash
python scripts/test_blacklist_checker.py
```

**测试结果**:
```
[OK] breakdown_short                                              SHORT -> 拦截
       原因: 黑名单匹配: breakdown_short | 破位做空信号整体表现差，追跌违背90分位策略 | 胜率35.0% | 亏损350.00U (50单)

[OK] breakdown_short+跌势3%+高波动                                     SHORT -> 拦截
       原因: 黑名单匹配: breakdown_short | 破位做空信号整体表现差，追跌违背90分位策略 | 胜率35.0% | 亏损350.00U (50单)

[OK] momentum_down_3pct+position_low+volatility_high              SHORT -> 放行
```

## 配置文件（config.yaml）

虽然新方案从数据库加载黑名单，但配置文件中仍保留了规则说明：

```yaml
signals:
  signal_quality_filter:
    # 信号组合质量过滤规则（基于历史表现）
    enabled: true
    # 禁用规则：胜率<40% 且订单>5笔的信号组合
    blacklist_signals:
      - pattern: "breakdown_short"              # 破位做空系列信号全部禁用
        reason: "追跌信号，违背90分位策略"
    # 减半规则：胜率<50%的信号开仓金额减半
    reduced_margin_signals:
      min_trades: 3                  # 至少3笔才判断
      max_win_rate: 50               # 胜率低于50%
      margin_multiplier: 0.5         # 开仓金额减半
```

**注意**: 目前仅实现了黑名单拦截功能，开仓金额减半功能待后续实现。

## 日志输出

### 启动日志
```
✅ 信号黑名单检查器已初始化 | 缓存时间:5分钟 | 当前黑名单:23条
```

### 拦截日志
```
🚫 RLC/USDT 信号 [momentum_down_3pct + position_low + volatility_high] SHORT 在黑名单中，跳过（黑名单匹配: breakdown_short | 破位做空信号整体表现差，追跌违背90分位策略 | 胜率35.0% | 亏损350.00U (50单)）
```

### 刷新日志
```
🔄 信号黑名单已重新加载 | 共23条记录
```

## 经济学原理

### 为什么禁用 breakdown_short 信号？

**核心问题**: 违背"90分位策略"（低买高卖原则）

1. **追跌陷阱**: breakdown_short是"破位做空"信号，即价格跌破支撑位后继续做空
2. **成本问题**: 在价格已经下跌后开空仓，实际上是在"追跌"，违背了在90分位（相对低点）买入的策略
3. **数据验证**:
   - 50笔订单仅35%胜率，累计亏损350U
   - 特定组合（加量能确认）胜率仅30.8%，亏损294.27U
4. **策略冲突**:
   - 系统的Big4触底检测已提供"底部2小时禁止做空"保护
   - breakdown_short与这个保护机制存在逻辑冲突

### 更好的做空时机

系统推荐在以下情况做空：
- **position_high**: 价格在24H区间高位（80%以上）
- **momentum_down_3pct + position_high**: 高位开始回落
- **trend_1h_bear + position_high**: 1小时下跌趋势确认且在高位

## 后续改进计划

1. **开仓金额动态调整**: 实现胜率<50%信号的开仓金额减半逻辑
2. **黑名单自动生成**: 基于每日统计自动添加低胜率信号到黑名单
3. **白名单机制**: 对历史表现优秀的信号组合给予更高权重
4. **实时监控**: 在管理界面显示黑名单命中统计，分析被拦截的信号
5. **A/B测试**: 对新的信号组合先用小仓位测试，积累足够数据后再决定是否加入黑名单

## 相关文件

### 核心文件
- `app/services/signal_blacklist_checker.py` - 黑名单检查器（新增）
- `smart_trader_service.py` - U本位合约交易服务（已修改）
- `coin_futures_trader_service.py` - 币本位合约交易服务（已修改）

### 脚本文件
- `scripts/add_signal_blacklist.py` - 添加黑名单记录
- `scripts/test_blacklist_checker.py` - 测试黑名单检查器（新增）

### 配置文件
- `config.yaml` - 配置文件（已更新）
- `.env` - 数据库连接配置

## 总结

通过引入动态黑名单加载机制，实现了：
1. ✅ 运行时自动刷新黑名单（5分钟缓存）
2. ✅ 无需重启服务即可生效
3. ✅ 灵活的模式匹配支持多种场景
4. ✅ 详细的日志记录便于追踪
5. ✅ 与原有系统无缝集成

这为系统的风险控制提供了更灵活、更及时的手段，有助于提高整体交易表现。
