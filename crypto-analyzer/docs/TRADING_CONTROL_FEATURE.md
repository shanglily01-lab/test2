# äº¤æ˜“æ§åˆ¶åŠŸèƒ½è¯´æ˜

> å®æ–½æ—¥æœŸ: 2026-02-02
> åŠŸèƒ½: å‰ç«¯é¡µé¢æ·»åŠ äº¤æ˜“å¼€å…³æŒ‰é’®ï¼Œæ”¯æŒé€šè¿‡ç•Œé¢æ§åˆ¶Uæœ¬ä½åˆçº¦å’Œå¸æœ¬ä½åˆçº¦çš„äº¤æ˜“

---

## åŠŸèƒ½æ¦‚è¿°

åœ¨Uæœ¬ä½åˆçº¦å’Œå¸æœ¬ä½åˆçº¦é¡µé¢æ·»åŠ äº†äº¤æ˜“æ§åˆ¶æŒ‰é’®ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å‰ç«¯ç•Œé¢æ§åˆ¶è‡ªåŠ¨äº¤æ˜“çš„å¯ç”¨/åœç”¨çŠ¶æ€ã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **ç‹¬ç«‹æ§åˆ¶**: Uæœ¬ä½åˆçº¦å’Œå¸æœ¬ä½åˆçº¦å„è‡ªç‹¬ç«‹æ§åˆ¶
2. **å®æ—¶åˆ‡æ¢**: ç‚¹å‡»æŒ‰é’®å³æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡
3. **çŠ¶æ€æŒä¹…åŒ–**: äº¤æ˜“å¼€å…³çŠ¶æ€ä¿å­˜åœ¨æ•°æ®åº“ä¸­
4. **ä¸å½±å“æŒä»“**: åœæ­¢äº¤æ˜“åªå½±å“æ–°å¼€ä»“ï¼Œä¸å½±å“å·²æœ‰æŒä»“
5. **ç”¨æˆ·å‹å¥½**: æ¸…æ™°çš„æŒ‰é’®çŠ¶æ€æç¤ºå’ŒäºŒæ¬¡ç¡®è®¤

---

## å®ç°ç»†èŠ‚

### 1. æ•°æ®åº“è¡¨

**è¡¨å**: `trading_control`

**å­—æ®µ**:
```sql
id                INT          ä¸»é”®
account_id        INT          è´¦æˆ·ID (2=Uæœ¬ä½, 3=å¸æœ¬ä½)
trading_type      VARCHAR(50)  äº¤æ˜“ç±»å‹ (usdt_futures/coin_futures)
trading_enabled   BOOLEAN      æ˜¯å¦å¯ç”¨äº¤æ˜“
updated_by        VARCHAR(100) æ›´æ–°äºº
updated_at        TIMESTAMP    æ›´æ–°æ—¶é—´
created_at        TIMESTAMP    åˆ›å»ºæ—¶é—´
```

**ç´¢å¼•**:
- UNIQUE KEY: (account_id, trading_type)
- INDEX: account_id
- INDEX: trading_type

**é»˜è®¤æ•°æ®**:
```sql
account_id=2, trading_type='usdt_futures',  trading_enabled=TRUE
account_id=3, trading_type='coin_futures',  trading_enabled=TRUE
```

### 2. APIæ¥å£

**è·¯ç”±å‰ç¼€**: `/api/trading-control`

#### æ¥å£åˆ—è¡¨

##### GET /status/{account_id}/{trading_type}
è·å–äº¤æ˜“å¼€å…³çŠ¶æ€

**å‚æ•°**:
- `account_id`: è´¦æˆ·ID (2æˆ–3)
- `trading_type`: äº¤æ˜“ç±»å‹ (usdt_futuresæˆ–coin_futures)

**å“åº”ç¤ºä¾‹**:
```json
{
    "account_id": 2,
    "trading_type": "usdt_futures",
    "trading_enabled": true,
    "updated_by": "web_user",
    "updated_at": "2026-02-02 13:10:27"
}
```

##### POST /toggle
åˆ‡æ¢äº¤æ˜“å¼€å…³çŠ¶æ€

**è¯·æ±‚ä½“**:
```json
{
    "account_id": 2,
    "trading_type": "usdt_futures",
    "trading_enabled": false,
    "updated_by": "web_user"
}
```

**å“åº”**: åŒGET /status

##### GET /all
è·å–æ‰€æœ‰äº¤æ˜“å¼€å…³çŠ¶æ€

**å“åº”ç¤ºä¾‹**:
```json
{
    "data": [
        {
            "account_id": 2,
            "trading_type": "usdt_futures",
            "trading_enabled": true,
            "updated_by": "web_user",
            "updated_at": "2026-02-02 13:10:27"
        },
        {
            "account_id": 3,
            "trading_type": "coin_futures",
            "trading_enabled": true,
            "updated_by": "system",
            "updated_at": "2026-02-02 13:10:27"
        }
    ]
}
```

### 3. å‰ç«¯å®ç°

#### æ–‡ä»¶ä¿®æ”¹

**Uæœ¬ä½åˆçº¦é¡µé¢**: `templates/futures_trading.html`
**å¸æœ¬ä½åˆçº¦é¡µé¢**: `templates/coin_futures_trading.html`

#### æŒ‰é’®ä½ç½®

ä½äºé¡µé¢å¤´éƒ¨å³ä¾§ï¼Œåˆ·æ–°æŒ‰é’®å·¦è¾¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ·ï¸ Uæœ¬ä½åˆçº¦äº¤æ˜“                       â”‚
â”‚                    [åœæ­¢äº¤æ˜“] [åˆ·æ–°]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æŒ‰é’®çŠ¶æ€

**å¯ç”¨çŠ¶æ€** (ç»¿è‰²/çº¢è‰²):
- ç±»å: `btn-danger`
- å›¾æ ‡: `bi-pause-circle`
- æ–‡æœ¬: "åœæ­¢äº¤æ˜“"
- ç‚¹å‡»å: åœæ­¢è‡ªåŠ¨å¼€ä»“

**åœç”¨çŠ¶æ€** (ç»¿è‰²):
- ç±»å: `btn-success`
- å›¾æ ‡: `bi-play-circle`
- æ–‡æœ¬: "å¯åŠ¨äº¤æ˜“"
- ç‚¹å‡»å: å¯åŠ¨è‡ªåŠ¨å¼€ä»“

#### JavaScriptå‡½æ•°

```javascript
// åŠ è½½äº¤æ˜“çŠ¶æ€
async function loadTradingStatus()

// æ›´æ–°æŒ‰é’®æ˜¾ç¤º
function updateTradingButton(enabled)

// åˆ‡æ¢äº¤æ˜“çŠ¶æ€
async function toggleTrading()
```

#### ç”¨æˆ·äº¤äº’æµç¨‹

1. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨ `loadTradingStatus()` è·å–å½“å‰çŠ¶æ€
2. ç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘ `toggleTrading()`
3. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œéœ€è¦ç”¨æˆ·äºŒæ¬¡ç¡®è®¤
4. å‘é€POSTè¯·æ±‚åˆ° `/api/trading-control/toggle`
5. æ›´æ–°æŒ‰é’®çŠ¶æ€æ˜¾ç¤º
6. æ˜¾ç¤ºæ“ä½œç»“æœæç¤º

---

## ä½¿ç”¨è¯´æ˜

### åœæ­¢äº¤æ˜“

1. ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„ã€åœæ­¢äº¤æ˜“ã€‘æŒ‰é’®ï¼ˆçº¢è‰²ï¼‰
2. ç¡®è®¤å¯¹è¯æ¡†æç¤º: "ç¡®å®šè¦åœæ­¢XXåˆçº¦äº¤æ˜“å—ï¼Ÿç³»ç»Ÿå°†åœæ­¢è‡ªåŠ¨å¼€ä»“ï¼Œä½†ä¸å½±å“å·²æœ‰æŒä»“ã€‚"
3. ç‚¹å‡»ã€ç¡®å®šã€‘
4. æŒ‰é’®å˜ä¸ºç»¿è‰²ã€å¯åŠ¨äº¤æ˜“ã€‘
5. ç³»ç»Ÿåœæ­¢è‡ªåŠ¨å¼€ä»“

**å½±å“èŒƒå›´**:
- âœ… åœæ­¢æ ¹æ®ä¿¡å·è‡ªåŠ¨å¼€ä»“
- âŒ ä¸å½±å“å·²æœ‰æŒä»“çš„æ­¢ç›ˆæ­¢æŸ
- âŒ ä¸å½±å“æ‰‹åŠ¨å¼€ä»“
- âŒ ä¸å½±å“å¦ä¸€ä¸ªåˆçº¦ç±»å‹ï¼ˆUæœ¬ä½å’Œå¸æœ¬ä½ç‹¬ç«‹ï¼‰

### å¯åŠ¨äº¤æ˜“

1. ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„ã€å¯åŠ¨äº¤æ˜“ã€‘æŒ‰é’®ï¼ˆç»¿è‰²ï¼‰
2. ç¡®è®¤å¯¹è¯æ¡†æç¤º: "ç¡®å®šè¦å¯åŠ¨XXåˆçº¦äº¤æ˜“å—ï¼Ÿç³»ç»Ÿå°†å¼€å§‹æ ¹æ®ä¿¡å·è‡ªåŠ¨å¼€ä»“ã€‚"
3. ç‚¹å‡»ã€ç¡®å®šã€‘
4. æŒ‰é’®å˜ä¸ºçº¢è‰²ã€åœæ­¢äº¤æ˜“ã€‘
5. ç³»ç»Ÿæ¢å¤è‡ªåŠ¨å¼€ä»“

---

## åç«¯é›†æˆ

### smart_trader_service.py é›†æˆç¤ºä¾‹

åœ¨å¼€ä»“é€»è¾‘ä¸­æ·»åŠ äº¤æ˜“å¼€å…³æ£€æŸ¥ï¼š

```python
def check_trading_enabled(account_id: int, trading_type: str) -> bool:
    """æ£€æŸ¥äº¤æ˜“æ˜¯å¦å¯ç”¨"""
    try:
        cursor.execute("""
            SELECT trading_enabled
            FROM trading_control
            WHERE account_id = %s AND trading_type = %s
        """, (account_id, trading_type))

        result = cursor.fetchone()
        if result:
            return result['trading_enabled']
        else:
            # é»˜è®¤å¯ç”¨
            return True
    except Exception as e:
        logger.error(f"æ£€æŸ¥äº¤æ˜“çŠ¶æ€å¤±è´¥: {e}")
        return True  # å‡ºé”™æ—¶é»˜è®¤å¯ç”¨ï¼Œé¿å…å½±å“äº¤æ˜“

# åœ¨å¼€ä»“å‰æ£€æŸ¥
if not check_trading_enabled(account_id=2, trading_type='usdt_futures'):
    logger.info(f"[TRADING-DISABLED] Uæœ¬ä½åˆçº¦äº¤æ˜“å·²åœæ­¢ï¼Œè·³è¿‡å¼€ä»“")
    continue
```

### æ¨èé›†æˆä½ç½®

åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ äº¤æ˜“å¼€å…³æ£€æŸ¥ï¼š

1. **smart_trader_service.py**:
   - ä¸»å¾ªç¯å¼€ä»“é€»è¾‘ (Line ~2700)
   - ä¿¡å·å¤„ç†å‡½æ•°å¼€å¤´

2. **batch_position_builder.py**:
   - åˆ†æ‰¹å»ºä»“æ‰§è¡Œå‰æ£€æŸ¥

3. **auto_open_positions.py**:
   - è‡ªåŠ¨å¼€ä»“è„šæœ¬å¼€å¤´

---

## ç›‘æ§å’Œæ—¥å¿—

### æ•°æ®åº“ç›‘æ§

æŸ¥çœ‹äº¤æ˜“çŠ¶æ€å†å²:
```sql
SELECT * FROM trading_control
ORDER BY updated_at DESC;
```

æŸ¥çœ‹åˆ‡æ¢é¢‘ç‡:
```sql
SELECT
    account_id,
    trading_type,
    COUNT(*) as changes
FROM trading_control
WHERE DATE(updated_at) = CURDATE()
GROUP BY account_id, trading_type;
```

### åº”ç”¨æ—¥å¿—

åœ¨smart_trader_serviceä¸­æ·»åŠ æ—¥å¿—ï¼š
```python
logger.info(f"[TRADING-STATUS] Account {account_id} {trading_type}: {'Enabled' if enabled else 'Disabled'}")
```

å»ºè®®åœ¨ä»¥ä¸‹æ—¶æœºè®°å½•æ—¥å¿—ï¼š
- æœåŠ¡å¯åŠ¨æ—¶è¯»å–åˆå§‹çŠ¶æ€
- æ¯æ¬¡æ£€æŸ¥åˆ°çŠ¶æ€å˜åŒ–
- å› ä¸ºäº¤æ˜“åœæ­¢è€Œè·³è¿‡å¼€ä»“

---

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•æ¸…å•

- [ ] Uæœ¬ä½åˆçº¦é¡µé¢æŒ‰é’®æ˜¾ç¤ºæ­£å¸¸
- [ ] å¸æœ¬ä½åˆçº¦é¡µé¢æŒ‰é’®æ˜¾ç¤ºæ­£å¸¸
- [ ] ç‚¹å‡»åœæ­¢äº¤æ˜“æŒ‰é’®ï¼ŒçŠ¶æ€æ­£ç¡®åˆ‡æ¢
- [ ] ç‚¹å‡»å¯åŠ¨äº¤æ˜“æŒ‰é’®ï¼ŒçŠ¶æ€æ­£ç¡®åˆ‡æ¢
- [ ] åˆ·æ–°é¡µé¢åæŒ‰é’®çŠ¶æ€ä¿æŒ
- [ ] æ•°æ®åº“çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] APIæ¥å£å“åº”æ­£å¸¸
- [ ] äºŒæ¬¡ç¡®è®¤å¯¹è¯æ¡†æ­£å¸¸æ˜¾ç¤º
- [ ] æ“ä½œç»“æœæç¤ºæ­£å¸¸æ˜¾ç¤º

### APIæµ‹è¯•

**æµ‹è¯•åœæ­¢Uæœ¬ä½åˆçº¦äº¤æ˜“**:
```bash
curl -X POST http://localhost:9020/api/trading-control/toggle \
  -H "Content-Type: application/json" \
  -d '{
    "account_id": 2,
    "trading_type": "usdt_futures",
    "trading_enabled": false,
    "updated_by": "test_user"
  }'
```

**æµ‹è¯•æŸ¥è¯¢çŠ¶æ€**:
```bash
curl http://localhost:9020/api/trading-control/status/2/usdt_futures
```

**æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰çŠ¶æ€**:
```bash
curl http://localhost:9020/api/trading-control/all
```

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. **æ•°æ®åº“è¿ç§»**:
   - `scripts/migrations/023_create_trading_control_table.sql`

2. **APIè·¯ç”±**:
   - `app/api/trading_control_api.py`

3. **æ–‡æ¡£**:
   - `docs/TRADING_CONTROL_FEATURE.md` (æœ¬æ–‡ä»¶)

### ä¿®æ”¹æ–‡ä»¶

1. **å‰ç«¯é¡µé¢**:
   - `templates/futures_trading.html`
   - `templates/coin_futures_trading.html`

2. **åç«¯ä¸»ç¨‹åº**:
   - `app/main.py` (æ³¨å†Œtrading_control_router)

---

## åç»­ä¼˜åŒ–å»ºè®®

### åŠŸèƒ½å¢å¼º

1. **æ‰¹é‡æ§åˆ¶**: æ·»åŠ ä¸€é”®åœæ­¢æ‰€æœ‰äº¤æ˜“çš„åŠŸèƒ½
2. **å®šæ—¶æ§åˆ¶**: æ”¯æŒè®¾å®šè‡ªåŠ¨å¼€å¯/å…³é—­äº¤æ˜“çš„æ—¶é—´
3. **æ¡ä»¶æ§åˆ¶**: æ ¹æ®è´¦æˆ·ç›ˆäºã€èƒœç‡ç­‰è‡ªåŠ¨æ§åˆ¶äº¤æ˜“
4. **æƒé™ç®¡ç†**: åŒºåˆ†ä¸åŒç”¨æˆ·çš„äº¤æ˜“æ§åˆ¶æƒé™
5. **æ“ä½œå®¡è®¡**: è®°å½•è¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œæ“ä½œäºº

### UI/UXæ”¹è¿›

1. **çŠ¶æ€æŒ‡ç¤ºå™¨**: åœ¨å¤šä¸ªä½ç½®æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€
2. **å¿«æ·é”®**: æ”¯æŒé”®ç›˜å¿«æ·é”®åˆ‡æ¢
3. **çŠ¶æ€ç»Ÿè®¡**: æ˜¾ç¤ºäº¤æ˜“åœæ­¢/å¯åŠ¨çš„æ¬¡æ•°å’Œæ—¶é•¿
4. **é€šçŸ¥æé†’**: äº¤æ˜“çŠ¶æ€å˜åŒ–æ—¶å‘é€é€šçŸ¥

### å®‰å…¨æ€§

1. **å¯†ç ç¡®è®¤**: é‡è¦æ“ä½œéœ€è¦å¯†ç äºŒæ¬¡ç¡®è®¤
2. **æ“ä½œå†·å´**: é˜²æ­¢é¢‘ç¹åˆ‡æ¢ï¼ˆå¦‚5åˆ†é’Ÿå†…åªèƒ½æ“ä½œä¸€æ¬¡ï¼‰
3. **IPé™åˆ¶**: é™åˆ¶åªèƒ½ä»ç‰¹å®šIPæ“ä½œ
4. **åŒå› ç´ è®¤è¯**: é›†æˆ2FAéªŒè¯

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-02-02
**åˆ›å»ºäºº**: Claude Sonnet 4.5
