# 15åˆ†é’ŸKçº¿æ¶¨è·Œæ•°é‡è¶‹åŠ¿åˆ¤æ–­ç­–ç•¥

## ğŸ“– ç­–ç•¥åŸç†

é€šè¿‡ç»Ÿè®¡**æœ€è¿‘Næ ¹15åˆ†é’ŸKçº¿çš„æ¶¨è·Œæ•°é‡**ï¼Œå¿«é€Ÿåˆ¤æ–­çŸ­æœŸè¶‹åŠ¿ï¼š
- **é˜³çº¿ï¼ˆæ¶¨ï¼‰å¤š** = ä¸Šå‡è¶‹åŠ¿ â†’ åšå¤š
- **é˜´çº¿ï¼ˆè·Œï¼‰å¤š** = ä¸‹é™è¶‹åŠ¿ â†’ åšç©º/è§‚æœ›
- **æ¶¨è·ŒæŒå¹³** = éœ‡è¡å¸‚ â†’ è§‚æœ›

---

## ğŸ¯ æ ¸å¿ƒæŒ‡æ ‡

### 1. åŸºç¡€ç»Ÿè®¡æŒ‡æ ‡

```python
def analyze_15m_candles(candles, window=20):
    """
    åˆ†æ15åˆ†é’ŸKçº¿æ¶¨è·Œæƒ…å†µ

    Args:
        candles: Kçº¿æ•°æ®åˆ—è¡¨
        window: ç»Ÿè®¡çª—å£ï¼ˆé»˜è®¤20æ ¹Kçº¿ = 5å°æ—¶ï¼‰

    Returns:
        åˆ†æç»“æœå­—å…¸
    """
    if len(candles) < window:
        return None

    recent_candles = candles[-window:]

    # ç»Ÿè®¡æ¶¨è·Œ
    bullish_count = 0   # é˜³çº¿æ•°é‡
    bearish_count = 0   # é˜´çº¿æ•°é‡
    doji_count = 0      # åå­—æ˜Ÿæ•°é‡

    bullish_candles = []
    bearish_candles = []

    for candle in recent_candles:
        close = candle['close']
        open_price = candle['open']
        change = (close - open_price) / open_price

        if close > open_price:
            bullish_count += 1
            bullish_candles.append({
                'time': candle['timestamp'],
                'change': change,
                'body_size': close - open_price
            })
        elif close < open_price:
            bearish_count += 1
            bearish_candles.append({
                'time': candle['timestamp'],
                'change': change,
                'body_size': open_price - close
            })
        else:
            doji_count += 1

    # è®¡ç®—æ¯”ä¾‹
    total = bullish_count + bearish_count + doji_count
    bullish_ratio = bullish_count / total if total > 0 else 0
    bearish_ratio = bearish_count / total if total > 0 else 0

    return {
        'window': window,
        'total_candles': total,
        'bullish_count': bullish_count,
        'bearish_count': bearish_count,
        'doji_count': doji_count,
        'bullish_ratio': bullish_ratio,
        'bearish_ratio': bearish_ratio,
        'net_bullish': bullish_count - bearish_count,
        'bullish_candles': bullish_candles,
        'bearish_candles': bearish_candles
    }
```

---

## ğŸ“Š è¶‹åŠ¿åˆ¤æ–­è§„åˆ™

### è§„åˆ™1: ç®€å•å¤šæ•°æ³•ï¼ˆåŸºç¡€ç‰ˆï¼‰

**é€‚åˆæ–°æ‰‹ï¼Œç®€å•ç›´è§‚**

```python
def simple_trend_detection(analysis):
    """
    ç®€å•å¤šæ•°æ³•åˆ¤æ–­è¶‹åŠ¿

    è§„åˆ™:
    - é˜³çº¿ > 60% â†’ ä¸Šå‡è¶‹åŠ¿
    - é˜´çº¿ > 60% â†’ ä¸‹é™è¶‹åŠ¿
    - å…¶ä»– â†’ éœ‡è¡
    """
    bullish_ratio = analysis['bullish_ratio']
    bearish_ratio = analysis['bearish_ratio']
    net_bullish = analysis['net_bullish']

    # å¼ºä¸Šå‡è¶‹åŠ¿
    if bullish_ratio > 0.70:
        return {
            'trend': 'STRONG_UPTREND',
            'strength': bullish_ratio,
            'signal': 'STRONG_BUY',
            'confidence': 0.90,
            'reason': f"æœ€è¿‘{analysis['window']}æ ¹Kçº¿ä¸­{analysis['bullish_count']}æ ¹ä¸Šæ¶¨({bullish_ratio*100:.0f}%)"
        }

    # ä¸Šå‡è¶‹åŠ¿
    elif bullish_ratio > 0.60:
        return {
            'trend': 'UPTREND',
            'strength': bullish_ratio,
            'signal': 'BUY',
            'confidence': 0.75,
            'reason': f"æœ€è¿‘{analysis['window']}æ ¹Kçº¿ä¸­{analysis['bullish_count']}æ ¹ä¸Šæ¶¨({bullish_ratio*100:.0f}%)"
        }

    # å¼ºä¸‹é™è¶‹åŠ¿
    elif bearish_ratio > 0.70:
        return {
            'trend': 'STRONG_DOWNTREND',
            'strength': bearish_ratio,
            'signal': 'STRONG_SELL',
            'confidence': 0.90,
            'reason': f"æœ€è¿‘{analysis['window']}æ ¹Kçº¿ä¸­{analysis['bearish_count']}æ ¹ä¸‹è·Œ({bearish_ratio*100:.0f}%)"
        }

    # ä¸‹é™è¶‹åŠ¿
    elif bearish_ratio > 0.60:
        return {
            'trend': 'DOWNTREND',
            'strength': bearish_ratio,
            'signal': 'SELL',
            'confidence': 0.75,
            'reason': f"æœ€è¿‘{analysis['window']}æ ¹Kçº¿ä¸­{analysis['bearish_count']}æ ¹ä¸‹è·Œ({bearish_ratio*100:.0f}%)"
        }

    # éœ‡è¡å¸‚
    else:
        return {
            'trend': 'SIDEWAYS',
            'strength': 0.5,
            'signal': 'HOLD',
            'confidence': 0.50,
            'reason': f"æ¶¨è·ŒæŒå¹³({bullish_ratio*100:.0f}%æ¶¨ï¼Œ{bearish_ratio*100:.0f}%è·Œ)ï¼Œéœ‡è¡å¸‚"
        }
```

**å®æˆ˜ç¤ºä¾‹**:
```python
# æœ€è¿‘20æ ¹15åˆ†é’ŸKçº¿
åˆ†æç»“æœ:
- é˜³çº¿: 15æ ¹ (75%)
- é˜´çº¿: 4æ ¹ (20%)
- åå­—æ˜Ÿ: 1æ ¹ (5%)

åˆ¤æ–­: å¼ºä¸Šå‡è¶‹åŠ¿ (STRONG_UPTREND)
ä¿¡å·: å¼ºä¹°å…¥ (STRONG_BUY)
ç½®ä¿¡åº¦: 90%
```

---

### è§„åˆ™2: å‡€å·®å€¼æ³•ï¼ˆè¿›é˜¶ç‰ˆï¼‰

**æ›´çµæ´»ï¼Œè€ƒè™‘å‡€å·®å€¼**

```python
def net_difference_trend_detection(analysis, window=20):
    """
    å‡€å·®å€¼æ³•åˆ¤æ–­è¶‹åŠ¿

    è§„åˆ™:
    - å‡€å·®å€¼ = é˜³çº¿æ•° - é˜´çº¿æ•°
    - å‡€å·®å€¼è¶Šå¤§ï¼Œè¶‹åŠ¿è¶Šå¼º
    """
    net_bullish = analysis['net_bullish']
    bullish_count = analysis['bullish_count']
    bearish_count = analysis['bearish_count']

    # è®¡ç®—å‡€å·®å€¼æ¯”ä¾‹
    net_ratio = net_bullish / window

    # æå¼ºä¸Šå‡è¶‹åŠ¿ (å‡€å·®å€¼ > +10)
    if net_bullish > window * 0.5:  # ä¾‹å¦‚: 20æ ¹ä¸­å‡€å·® > 10
        return {
            'trend': 'VERY_STRONG_UPTREND',
            'net_difference': net_bullish,
            'signal': 'STRONG_BUY',
            'confidence': 0.95,
            'reason': f"å‡€å¤š{net_bullish}æ ¹é˜³çº¿({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }

    # å¼ºä¸Šå‡è¶‹åŠ¿ (å‡€å·®å€¼ +6 åˆ° +10)
    elif net_bullish > window * 0.3:
        return {
            'trend': 'STRONG_UPTREND',
            'net_difference': net_bullish,
            'signal': 'BUY',
            'confidence': 0.85,
            'reason': f"å‡€å¤š{net_bullish}æ ¹é˜³çº¿({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }

    # ä¸Šå‡è¶‹åŠ¿ (å‡€å·®å€¼ +2 åˆ° +5)
    elif net_bullish > window * 0.1:
        return {
            'trend': 'UPTREND',
            'net_difference': net_bullish,
            'signal': 'BUY',
            'confidence': 0.70,
            'reason': f"å‡€å¤š{net_bullish}æ ¹é˜³çº¿({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }

    # æå¼ºä¸‹é™è¶‹åŠ¿ (å‡€å·®å€¼ < -10)
    elif net_bullish < -window * 0.5:
        return {
            'trend': 'VERY_STRONG_DOWNTREND',
            'net_difference': net_bullish,
            'signal': 'STRONG_SELL',
            'confidence': 0.95,
            'reason': f"å‡€å¤š{abs(net_bullish)}æ ¹é˜´çº¿({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }

    # å¼ºä¸‹é™è¶‹åŠ¿ (å‡€å·®å€¼ -6 åˆ° -10)
    elif net_bullish < -window * 0.3:
        return {
            'trend': 'STRONG_DOWNTREND',
            'net_difference': net_bullish,
            'signal': 'SELL',
            'confidence': 0.85,
            'reason': f"å‡€å¤š{abs(net_bullish)}æ ¹é˜´çº¿({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }

    # ä¸‹é™è¶‹åŠ¿ (å‡€å·®å€¼ -2 åˆ° -5)
    elif net_bullish < -window * 0.1:
        return {
            'trend': 'DOWNTREND',
            'net_difference': net_bullish,
            'signal': 'SELL',
            'confidence': 0.70,
            'reason': f"å‡€å¤š{abs(net_bullish)}æ ¹é˜´çº¿({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }

    # éœ‡è¡å¸‚ (å‡€å·®å€¼ -1 åˆ° +1)
    else:
        return {
            'trend': 'SIDEWAYS',
            'net_difference': net_bullish,
            'signal': 'HOLD',
            'confidence': 0.50,
            'reason': f"æ¶¨è·ŒåŸºæœ¬æŒå¹³({bullish_count}æ¶¨ vs {bearish_count}è·Œ)"
        }
```

**å®æˆ˜ç¤ºä¾‹**:
```python
# æœ€è¿‘20æ ¹15åˆ†é’ŸKçº¿
åˆ†æç»“æœ:
- é˜³çº¿: 16æ ¹
- é˜´çº¿: 4æ ¹
- å‡€å·®å€¼: +12

åˆ¤æ–­: æå¼ºä¸Šå‡è¶‹åŠ¿ (VERY_STRONG_UPTREND)
ä¿¡å·: å¼ºä¹°å…¥ (STRONG_BUY)
ç½®ä¿¡åº¦: 95%
```

---

### è§„åˆ™3: åŠ æƒè¶‹åŠ¿æ³•ï¼ˆä¸“ä¸šç‰ˆï¼‰

**è€ƒè™‘Kçº¿å®ä½“å¤§å°ï¼Œæ›´å‡†ç¡®**

```python
def weighted_trend_detection(analysis, candles, window=20):
    """
    åŠ æƒè¶‹åŠ¿æ³•ï¼šè€ƒè™‘Kçº¿å®ä½“å¤§å°

    å¤§é˜³çº¿/å¤§é˜´çº¿æƒé‡æ›´é«˜
    """
    recent_candles = candles[-window:]

    # è®¡ç®—åŠ æƒå¾—åˆ†
    weighted_score = 0
    total_weight = 0

    for candle in recent_candles:
        close = candle['close']
        open_price = candle['open']
        high = candle['high']
        low = candle['low']

        # è®¡ç®—å®ä½“å¤§å°
        body_size = abs(close - open_price)
        total_range = high - low

        # å®ä½“æ¯”ä¾‹ï¼ˆå®ä½“è¶Šå¤§æƒé‡è¶Šé«˜ï¼‰
        if total_range > 0:
            body_ratio = body_size / total_range
        else:
            body_ratio = 0

        # æƒé‡ = 1 + å®ä½“æ¯”ä¾‹ï¼ˆèŒƒå›´ 1-2ï¼‰
        weight = 1 + body_ratio

        # è®¡ç®—æ–¹å‘å¾—åˆ†
        if close > open_price:
            # é˜³çº¿ï¼šæ­£åˆ†
            change_pct = (close - open_price) / open_price
            score = change_pct * 100 * weight  # åŠ æƒæ¶¨å¹…
            weighted_score += score
        elif close < open_price:
            # é˜´çº¿ï¼šè´Ÿåˆ†
            change_pct = (close - open_price) / open_price
            score = change_pct * 100 * weight  # åŠ æƒè·Œå¹…
            weighted_score -= abs(score)

        total_weight += weight

    # å½’ä¸€åŒ–åŠ æƒå¾—åˆ†
    avg_weighted_score = weighted_score / total_weight if total_weight > 0 else 0

    # åˆ¤æ–­è¶‹åŠ¿
    if avg_weighted_score > 0.8:
        return {
            'trend': 'VERY_STRONG_UPTREND',
            'weighted_score': avg_weighted_score,
            'signal': 'STRONG_BUY',
            'confidence': 0.95,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œå¤§é˜³çº¿ä¸»å¯¼"
        }
    elif avg_weighted_score > 0.4:
        return {
            'trend': 'STRONG_UPTREND',
            'weighted_score': avg_weighted_score,
            'signal': 'BUY',
            'confidence': 0.85,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œé˜³çº¿ä¸»å¯¼"
        }
    elif avg_weighted_score > 0.1:
        return {
            'trend': 'UPTREND',
            'weighted_score': avg_weighted_score,
            'signal': 'BUY',
            'confidence': 0.70,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œç•¥åå¤š"
        }
    elif avg_weighted_score < -0.8:
        return {
            'trend': 'VERY_STRONG_DOWNTREND',
            'weighted_score': avg_weighted_score,
            'signal': 'STRONG_SELL',
            'confidence': 0.95,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œå¤§é˜´çº¿ä¸»å¯¼"
        }
    elif avg_weighted_score < -0.4:
        return {
            'trend': 'STRONG_DOWNTREND',
            'weighted_score': avg_weighted_score,
            'signal': 'SELL',
            'confidence': 0.85,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œé˜´çº¿ä¸»å¯¼"
        }
    elif avg_weighted_score < -0.1:
        return {
            'trend': 'DOWNTREND',
            'weighted_score': avg_weighted_score,
            'signal': 'SELL',
            'confidence': 0.70,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œç•¥åç©º"
        }
    else:
        return {
            'trend': 'SIDEWAYS',
            'weighted_score': avg_weighted_score,
            'signal': 'HOLD',
            'confidence': 0.50,
            'reason': f"åŠ æƒå¾—åˆ†{avg_weighted_score:.2f}ï¼Œéœ‡è¡å¸‚"
        }
```

**å®æˆ˜ç¤ºä¾‹**:
```python
# æœ€è¿‘20æ ¹15åˆ†é’ŸKçº¿
åˆ†æç»“æœ:
- 14æ ¹é˜³çº¿ï¼ˆå…¶ä¸­5æ ¹å¤§é˜³çº¿ï¼Œå®ä½“ > 70%ï¼‰
- 6æ ¹é˜´çº¿ï¼ˆå°é˜´çº¿ï¼Œå®ä½“ < 40%ï¼‰
- åŠ æƒå¾—åˆ†: +0.85

åˆ¤æ–­: æå¼ºä¸Šå‡è¶‹åŠ¿ (VERY_STRONG_UPTREND)
ä¿¡å·: å¼ºä¹°å…¥ (STRONG_BUY)
ç½®ä¿¡åº¦: 95%
åŸå› : å¤§é˜³çº¿ä¸»å¯¼
```

---

## ğŸ”¥ å¤šæ—¶é—´çª—å£ç»¼åˆåˆ¤æ–­

**ä¸åŒçª—å£çœ‹ä¸åŒçº§åˆ«è¶‹åŠ¿**

```python
def multi_window_trend_analysis(candles):
    """
    å¤šæ—¶é—´çª—å£ç»¼åˆè¶‹åŠ¿åˆ†æ

    Returns:
        ç»¼åˆè¶‹åŠ¿åˆ¤æ–­
    """
    # 1. çŸ­æœŸè¶‹åŠ¿ï¼ˆ10æ ¹ = 2.5å°æ—¶ï¼‰
    short_analysis = analyze_15m_candles(candles, window=10)
    short_trend = simple_trend_detection(short_analysis)

    # 2. ä¸­æœŸè¶‹åŠ¿ï¼ˆ20æ ¹ = 5å°æ—¶ï¼‰
    medium_analysis = analyze_15m_candles(candles, window=20)
    medium_trend = simple_trend_detection(medium_analysis)

    # 3. é•¿æœŸè¶‹åŠ¿ï¼ˆ40æ ¹ = 10å°æ—¶ï¼‰
    long_analysis = analyze_15m_candles(candles, window=40)
    long_trend = simple_trend_detection(long_analysis)

    # ç»¼åˆåˆ¤æ–­
    trends = [short_trend, medium_trend, long_trend]

    # ç»Ÿè®¡è¶‹åŠ¿æ–¹å‘
    uptrend_count = sum(1 for t in trends if 'UP' in t['trend'])
    downtrend_count = sum(1 for t in trends if 'DOWN' in t['trend'])

    # ç»¼åˆç½®ä¿¡åº¦ï¼ˆå–å¹³å‡ï¼‰
    avg_confidence = sum(t['confidence'] for t in trends) / 3

    # æœ€ç»ˆåˆ¤æ–­
    if uptrend_count == 3:
        final_signal = 'STRONG_BUY'
        confidence = min(avg_confidence + 0.1, 0.95)
        reason = "çŸ­ä¸­é•¿æœŸå…¨éƒ¨ä¸Šå‡è¶‹åŠ¿ï¼Œå¼ºçƒˆä¹°å…¥"
    elif uptrend_count == 2:
        final_signal = 'BUY'
        confidence = avg_confidence
        reason = "å¤šæ•°æ—¶é—´çª—å£ä¸Šå‡è¶‹åŠ¿ï¼Œä¹°å…¥"
    elif downtrend_count == 3:
        final_signal = 'STRONG_SELL'
        confidence = min(avg_confidence + 0.1, 0.95)
        reason = "çŸ­ä¸­é•¿æœŸå…¨éƒ¨ä¸‹é™è¶‹åŠ¿ï¼Œå¼ºçƒˆå–å‡º"
    elif downtrend_count == 2:
        final_signal = 'SELL'
        confidence = avg_confidence
        reason = "å¤šæ•°æ—¶é—´çª—å£ä¸‹é™è¶‹åŠ¿ï¼Œå–å‡º"
    else:
        final_signal = 'HOLD'
        confidence = 0.50
        reason = "è¶‹åŠ¿ä¸ä¸€è‡´ï¼Œè§‚æœ›"

    return {
        'short_term': short_trend,
        'medium_term': medium_trend,
        'long_term': long_trend,
        'final_signal': final_signal,
        'confidence': round(confidence, 2),
        'reason': reason,
        'uptrend_windows': uptrend_count,
        'downtrend_windows': downtrend_count
    }
```

**å®æˆ˜ç¤ºä¾‹**:
```python
å¤šæ—¶é—´çª—å£åˆ†æ:
â”œâ”€ çŸ­æœŸ(10æ ¹): ä¸Šå‡è¶‹åŠ¿ (12æ¶¨/8è·Œ) âœ…
â”œâ”€ ä¸­æœŸ(20æ ¹): ä¸Šå‡è¶‹åŠ¿ (15æ¶¨/5è·Œ) âœ…
â””â”€ é•¿æœŸ(40æ ¹): ä¸Šå‡è¶‹åŠ¿ (28æ¶¨/12è·Œ) âœ…

ç»¼åˆåˆ¤æ–­: å¼ºä¹°å…¥ (STRONG_BUY)
ç½®ä¿¡åº¦: 90%
åŸå› : çŸ­ä¸­é•¿æœŸå…¨éƒ¨ä¸Šå‡è¶‹åŠ¿
```

---

## ğŸ“ˆ ç»“åˆå…¶ä»–æŒ‡æ ‡å¢å¼º

### å¢å¼º1: ç»“åˆæˆäº¤é‡

```python
def trend_with_volume_confirmation(trend_result, candles, window=20):
    """
    æˆäº¤é‡ç¡®è®¤è¶‹åŠ¿

    æ”¾é‡ä¸Šæ¶¨ = çœŸä¸Šæ¶¨
    ç¼©é‡ä¸Šæ¶¨ = å‡ä¸Šæ¶¨
    """
    recent_candles = candles[-window:]

    # è®¡ç®—å¹³å‡æˆäº¤é‡
    total_volume = sum(c['volume'] for c in recent_candles)
    avg_volume = total_volume / window

    # æœ€è¿‘ä¸€æ ¹Kçº¿æˆäº¤é‡
    last_volume = recent_candles[-1]['volume']
    volume_ratio = last_volume / avg_volume if avg_volume > 0 else 1

    # å¢å¼ºä¿¡å·
    if 'BUY' in trend_result['signal']:
        if volume_ratio > 1.5:
            trend_result['confidence'] = min(trend_result['confidence'] + 0.15, 0.95)
            trend_result['reason'] += " + æˆäº¤é‡æ”¾å¤§ç¡®è®¤"
        elif volume_ratio < 0.8:
            trend_result['confidence'] = max(trend_result['confidence'] - 0.10, 0.50)
            trend_result['reason'] += " - æˆäº¤é‡èç¼©è­¦å‘Š"

    elif 'SELL' in trend_result['signal']:
        if volume_ratio > 1.5:
            trend_result['confidence'] = min(trend_result['confidence'] + 0.15, 0.95)
            trend_result['reason'] += " + æˆäº¤é‡æ”¾å¤§ç¡®è®¤"

    return trend_result
```

---

### å¢å¼º2: ç»“åˆRSI

```python
def trend_with_rsi_filter(trend_result, rsi_value):
    """
    RSIè¿‡æ»¤æç«¯æƒ…å†µ

    RSI > 80 + ä¸Šå‡è¶‹åŠ¿ = å¯èƒ½è§é¡¶ï¼Œé™ä½ç½®ä¿¡åº¦
    RSI < 20 + ä¸‹é™è¶‹åŠ¿ = å¯èƒ½è§åº•ï¼Œé™ä½ç½®ä¿¡åº¦
    """
    if 'BUY' in trend_result['signal'] and rsi_value > 80:
        trend_result['confidence'] = max(trend_result['confidence'] - 0.20, 0.50)
        trend_result['reason'] += f" - RSIè¶…ä¹°({rsi_value:.0f})è­¦å‘Š"

    elif 'SELL' in trend_result['signal'] and rsi_value < 20:
        trend_result['confidence'] = max(trend_result['confidence'] - 0.20, 0.50)
        trend_result['reason'] += f" - RSIè¶…å–({rsi_value:.0f})è­¦å‘Š"

    return trend_result
```

---

### å¢å¼º3: ç»“åˆMACD

```python
def trend_with_macd_confirmation(trend_result, macd_histogram):
    """
    MACDç¡®è®¤è¶‹åŠ¿

    ä¸Šå‡è¶‹åŠ¿ + MACDæŸ±æ­£ = å¼ºåŒ–
    ä¸Šå‡è¶‹åŠ¿ + MACDæŸ±è´Ÿ = å‡å¼±
    """
    if 'BUY' in trend_result['signal']:
        if macd_histogram > 0:
            trend_result['confidence'] = min(trend_result['confidence'] + 0.10, 0.95)
            trend_result['reason'] += " + MACDæ”¯æŒ"
        else:
            trend_result['confidence'] = max(trend_result['confidence'] - 0.10, 0.50)
            trend_result['reason'] += " - MACDä¸æ”¯æŒ"

    elif 'SELL' in trend_result['signal']:
        if macd_histogram < 0:
            trend_result['confidence'] = min(trend_result['confidence'] + 0.10, 0.95)
            trend_result['reason'] += " + MACDæ”¯æŒ"
        else:
            trend_result['confidence'] = max(trend_result['confidence'] - 0.10, 0.50)
            trend_result['reason'] += " - MACDä¸æ”¯æŒ"

    return trend_result
```

---

## ğŸ’¡ å®æˆ˜äº¤æ˜“ç­–ç•¥

### ç­–ç•¥1: çº¯è¶‹åŠ¿è·Ÿéš

```python
def pure_trend_following_strategy(candles):
    """
    çº¯è¶‹åŠ¿è·Ÿéšç­–ç•¥

    ç®€å•ç²—æš´ï¼šè·Ÿéšè¶‹åŠ¿äº¤æ˜“
    """
    # åˆ†æ15åˆ†é’ŸKçº¿
    analysis = analyze_15m_candles(candles, window=20)
    trend = net_difference_trend_detection(analysis, window=20)

    # äº¤æ˜“è§„åˆ™
    if trend['signal'] == 'STRONG_BUY' and trend['confidence'] > 0.85:
        return {
            'action': 'BUY',
            'position': 0.30,  # 30%ä»“ä½
            'leverage': 1,     # ä¸ç”¨æ æ†
            'stop_loss_pct': 0.03,  # æ­¢æŸ3%
            'take_profit_pct': 0.08,  # æ­¢ç›ˆ8%
            'reason': trend['reason']
        }

    elif trend['signal'] == 'BUY' and trend['confidence'] > 0.70:
        return {
            'action': 'BUY',
            'position': 0.20,  # 20%ä»“ä½
            'leverage': 1,
            'stop_loss_pct': 0.03,
            'take_profit_pct': 0.06,
            'reason': trend['reason']
        }

    elif trend['signal'] == 'STRONG_SELL' and trend['confidence'] > 0.85:
        return {
            'action': 'SELL',
            'position': 0.25,  # 25%ä»“ä½åšç©º
            'leverage': 3,     # 3å€æ æ†
            'stop_loss_pct': 0.04,
            'take_profit_pct': 0.08,
            'reason': trend['reason']
        }

    else:
        return {
            'action': 'HOLD',
            'reason': 'è¶‹åŠ¿ä¸æ˜ç¡®æˆ–ç½®ä¿¡åº¦ä¸è¶³'
        }
```

---

### ç­–ç•¥2: è¶‹åŠ¿ + å›è°ƒå…¥åœº

```python
def trend_pullback_entry_strategy(candles, current_price):
    """
    è¶‹åŠ¿ + å›è°ƒå…¥åœºç­–ç•¥

    ç­‰å¾…è¶‹åŠ¿ç¡®è®¤åçš„å›è°ƒæœºä¼š
    """
    # 1. ç¡®è®¤ä¸­æœŸè¶‹åŠ¿ï¼ˆ20æ ¹ï¼‰
    medium_analysis = analyze_15m_candles(candles, window=20)
    medium_trend = simple_trend_detection(medium_analysis)

    # 2. æ£€æŸ¥çŸ­æœŸå›è°ƒï¼ˆæœ€è¿‘5æ ¹ï¼‰
    short_analysis = analyze_15m_candles(candles, window=5)

    # 3. ä¸Šå‡è¶‹åŠ¿ä¸­çš„å›è°ƒä¹°å…¥
    if 'UP' in medium_trend['trend']:
        # çŸ­æœŸå‡ºç°å›è°ƒï¼ˆé˜´çº¿å¤šï¼‰
        if short_analysis['bearish_count'] >= 3:
            return {
                'action': 'BUY',
                'position': 0.25,
                'entry_type': 'PULLBACK',
                'stop_loss_pct': 0.03,
                'take_profit_pct': 0.08,
                'reason': f"ä¸­æœŸä¸Šå‡è¶‹åŠ¿ï¼ŒçŸ­æœŸå›è°ƒä¹°å…¥æœºä¼š"
            }

    # 4. ä¸‹é™è¶‹åŠ¿ä¸­çš„åå¼¹åšç©º
    elif 'DOWN' in medium_trend['trend']:
        # çŸ­æœŸå‡ºç°åå¼¹ï¼ˆé˜³çº¿å¤šï¼‰
        if short_analysis['bullish_count'] >= 3:
            return {
                'action': 'SHORT',
                'position': 0.20,
                'leverage': 3,
                'entry_type': 'REBOUND_SHORT',
                'stop_loss_pct': 0.04,
                'take_profit_pct': 0.08,
                'reason': f"ä¸­æœŸä¸‹é™è¶‹åŠ¿ï¼ŒçŸ­æœŸåå¼¹åšç©ºæœºä¼š"
            }

    return {
        'action': 'WAIT',
        'reason': 'ç­‰å¾…å›è°ƒ/åå¼¹å…¥åœºæœºä¼š'
    }
```

---

### ç­–ç•¥3: å¤šæ—¶é—´çª—å£å…±æŒ¯

```python
def multi_timeframe_resonance_strategy(candles):
    """
    å¤šæ—¶é—´çª—å£å…±æŒ¯ç­–ç•¥

    æ‰€æœ‰çª—å£åŒå‘ = æœ€å¼ºä¿¡å·
    """
    # å¤šçª—å£åˆ†æ
    multi_result = multi_window_trend_analysis(candles)

    # å…¨éƒ¨ä¸Šå‡è¶‹åŠ¿ = å¼ºä¹°å…¥
    if multi_result['uptrend_windows'] == 3:
        return {
            'action': 'STRONG_BUY',
            'position': 0.40,  # 40%ä»“ä½
            'leverage': 2,     # 2å€æ æ†
            'stop_loss_pct': 0.04,
            'take_profit_pct': 0.12,
            'confidence': multi_result['confidence'],
            'reason': 'çŸ­ä¸­é•¿æœŸå…¨éƒ¨ä¸Šå‡ï¼Œå¼ºçƒˆä¹°å…¥ä¿¡å·'
        }

    # å…¨éƒ¨ä¸‹é™è¶‹åŠ¿ = å¼ºåšç©º
    elif multi_result['downtrend_windows'] == 3:
        return {
            'action': 'STRONG_SHORT',
            'position': 0.30,
            'leverage': 5,
            'stop_loss_pct': 0.03,
            'take_profit_pct': 0.10,
            'confidence': multi_result['confidence'],
            'reason': 'çŸ­ä¸­é•¿æœŸå…¨éƒ¨ä¸‹é™ï¼Œå¼ºçƒˆåšç©ºä¿¡å·'
        }

    # 2ä¸ªçª—å£åŒå‘
    elif multi_result['uptrend_windows'] == 2:
        return {
            'action': 'BUY',
            'position': 0.25,
            'leverage': 1,
            'stop_loss_pct': 0.03,
            'take_profit_pct': 0.08,
            'reason': 'å¤šæ•°çª—å£ä¸Šå‡è¶‹åŠ¿'
        }

    elif multi_result['downtrend_windows'] == 2:
        return {
            'action': 'SHORT',
            'position': 0.20,
            'leverage': 3,
            'stop_loss_pct': 0.04,
            'take_profit_pct': 0.08,
            'reason': 'å¤šæ•°çª—å£ä¸‹é™è¶‹åŠ¿'
        }

    # è¶‹åŠ¿ä¸ä¸€è‡´
    else:
        return {
            'action': 'HOLD',
            'reason': 'å¤šæ—¶é—´çª—å£è¶‹åŠ¿ä¸ä¸€è‡´ï¼Œè§‚æœ›'
        }
```

---

## ğŸ“Š å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1: å¼ºä¸Šå‡è¶‹åŠ¿ä¹°å…¥

**å¸‚åœºæƒ…å†µ**:
```
BTC 15åˆ†é’ŸKçº¿åˆ†æ (æœ€è¿‘20æ ¹)
æ—¶é—´: 2024-11-11 14:00

Kçº¿ç»Ÿè®¡:
â”œâ”€ é˜³çº¿: 16æ ¹ (80%)
â”œâ”€ é˜´çº¿: 3æ ¹ (15%)
â”œâ”€ åå­—æ˜Ÿ: 1æ ¹ (5%)
â””â”€ å‡€å·®å€¼: +13

ä»·æ ¼èµ°åŠ¿:
- èµ·å§‹: $94,500
- ç»“æŸ: $96,800
- æ¶¨å¹…: +2.4%
```

**è¶‹åŠ¿åˆ¤æ–­**:
```python
è¶‹åŠ¿: æå¼ºä¸Šå‡è¶‹åŠ¿ (VERY_STRONG_UPTREND)
ä¿¡å·: å¼ºä¹°å…¥ (STRONG_BUY)
ç½®ä¿¡åº¦: 95%
åŸå› : å‡€å¤š13æ ¹é˜³çº¿(16æ¶¨ vs 3è·Œ)
```

**äº¤æ˜“æ‰§è¡Œ**:
```
å…¥åœº: $96,800
ä»“ä½: 35%
æ æ†: 2å€
æ­¢æŸ: $93,792 (-3%)
æ­¢ç›ˆ: $104,544 (+8%)
```

**ç»“æœ**:
```
æŒä»“æ—¶é—´: 4å°æ—¶
æœ€é«˜ä»·: $98,500 (+1.8%)
æ­¢ç›ˆä»·: $104,544
å®é™…æ­¢ç›ˆ: $98,200 (éƒ¨åˆ†æ­¢ç›ˆ)
è·åˆ©: +1.4% (35%ä»“ä½ï¼Œ2å€æ æ† = 2.8%è´¦æˆ·æ”¶ç›Š)
```

---

### æ¡ˆä¾‹2: è¶‹åŠ¿åè½¬åšç©º

**å¸‚åœºæƒ…å†µ**:
```
ETH 15åˆ†é’ŸKçº¿åˆ†æ (æœ€è¿‘20æ ¹)
æ—¶é—´: 2024-11-11 18:00

Kçº¿ç»Ÿè®¡:
â”œâ”€ é˜³çº¿: 4æ ¹ (20%)
â”œâ”€ é˜´çº¿: 15æ ¹ (75%)
â”œâ”€ åå­—æ˜Ÿ: 1æ ¹ (5%)
â””â”€ å‡€å·®å€¼: -11

ä»·æ ¼èµ°åŠ¿:
- èµ·å§‹: $3,650
- ç»“æŸ: $3,520
- è·Œå¹…: -3.6%
```

**è¶‹åŠ¿åˆ¤æ–­**:
```python
è¶‹åŠ¿: æå¼ºä¸‹é™è¶‹åŠ¿ (VERY_STRONG_DOWNTREND)
ä¿¡å·: å¼ºåšç©º (STRONG_SHORT)
ç½®ä¿¡åº¦: 95%
åŸå› : å‡€å¤š11æ ¹é˜´çº¿(4æ¶¨ vs 15è·Œ)
```

**äº¤æ˜“æ‰§è¡Œ**:
```
åšç©ºå…¥åœº: $3,520
ä»“ä½: 25%
æ æ†: 5å€
æ­¢æŸ: $3,661 (+4%)
æ­¢ç›ˆ: $3,238 (-8%)
```

**ç»“æœ**:
```
æŒä»“æ—¶é—´: 6å°æ—¶
æœ€ä½ä»·: $3,380 (-4%)
æ­¢ç›ˆä»·: $3,238
å®é™…æ­¢ç›ˆ: $3,415 (åˆ†æ‰¹æ­¢ç›ˆ)
è·åˆ©: -3% Ã— 5å€ = -15% (25%ä»“ä½ = 3.75%è´¦æˆ·æ”¶ç›Š)
```

---

## âš™ï¸ ä»£ç å®ç°

### å®Œæ•´ç³»ç»Ÿå®ç°

```python
class Candle15mTrendAnalyzer:
    """15åˆ†é’ŸKçº¿è¶‹åŠ¿åˆ†æå™¨"""

    def __init__(self, config=None):
        self.config = config or {}
        self.default_window = self.config.get('window', 20)

    def analyze(self, candles, window=None):
        """
        åˆ†æ15åˆ†é’ŸKçº¿è¶‹åŠ¿

        Args:
            candles: Kçº¿æ•°æ®
            window: ç»Ÿè®¡çª—å£

        Returns:
            è¶‹åŠ¿åˆ†æç»“æœ
        """
        window = window or self.default_window

        # åŸºç¡€ç»Ÿè®¡
        stats = self._calculate_statistics(candles, window)

        # è¶‹åŠ¿åˆ¤æ–­
        trend = self._detect_trend(stats)

        # å¤šçª—å£åˆ†æ
        multi_window = self._multi_window_analysis(candles)

        # ç»¼åˆç»“æœ
        return {
            'statistics': stats,
            'trend': trend,
            'multi_window': multi_window,
            'timestamp': datetime.now().isoformat()
        }

    def _calculate_statistics(self, candles, window):
        """è®¡ç®—ç»Ÿè®¡æ•°æ®"""
        if len(candles) < window:
            return None

        recent = candles[-window:]

        bullish = 0
        bearish = 0
        doji = 0

        for c in recent:
            if c['close'] > c['open']:
                bullish += 1
            elif c['close'] < c['open']:
                bearish += 1
            else:
                doji += 1

        total = bullish + bearish + doji

        return {
            'window': window,
            'total': total,
            'bullish': bullish,
            'bearish': bearish,
            'doji': doji,
            'bullish_ratio': bullish / total if total > 0 else 0,
            'bearish_ratio': bearish / total if total > 0 else 0,
            'net_bullish': bullish - bearish
        }

    def _detect_trend(self, stats):
        """æ£€æµ‹è¶‹åŠ¿"""
        if not stats:
            return None

        net = stats['net_bullish']
        window = stats['window']

        # ä½¿ç”¨å‡€å·®å€¼æ³•
        if net > window * 0.5:
            return {
                'type': 'VERY_STRONG_UPTREND',
                'signal': 'STRONG_BUY',
                'confidence': 0.95
            }
        elif net > window * 0.3:
            return {
                'type': 'STRONG_UPTREND',
                'signal': 'BUY',
                'confidence': 0.85
            }
        elif net > window * 0.1:
            return {
                'type': 'UPTREND',
                'signal': 'BUY',
                'confidence': 0.70
            }
        elif net < -window * 0.5:
            return {
                'type': 'VERY_STRONG_DOWNTREND',
                'signal': 'STRONG_SELL',
                'confidence': 0.95
            }
        elif net < -window * 0.3:
            return {
                'type': 'STRONG_DOWNTREND',
                'signal': 'SELL',
                'confidence': 0.85
            }
        elif net < -window * 0.1:
            return {
                'type': 'DOWNTREND',
                'signal': 'SELL',
                'confidence': 0.70
            }
        else:
            return {
                'type': 'SIDEWAYS',
                'signal': 'HOLD',
                'confidence': 0.50
            }

    def _multi_window_analysis(self, candles):
        """å¤šçª—å£åˆ†æ"""
        windows = [10, 20, 40]
        results = {}

        for w in windows:
            stats = self._calculate_statistics(candles, w)
            if stats:
                trend = self._detect_trend(stats)
                results[f'{w}_candles'] = {
                    'stats': stats,
                    'trend': trend
                }

        return results

    def generate_trading_signal(self, candles, current_price):
        """
        ç”Ÿæˆäº¤æ˜“ä¿¡å·

        Returns:
            äº¤æ˜“å»ºè®®
        """
        analysis = self.analyze(candles)

        if not analysis or not analysis['trend']:
            return {'action': 'HOLD', 'reason': 'æ•°æ®ä¸è¶³'}

        trend = analysis['trend']
        signal = trend['signal']
        confidence = trend['confidence']

        # æ ¹æ®ä¿¡å·ç”Ÿæˆäº¤æ˜“å»ºè®®
        if signal == 'STRONG_BUY' and confidence > 0.85:
            return {
                'action': 'BUY',
                'position': 0.35,
                'leverage': 2,
                'entry_price': current_price,
                'stop_loss': current_price * 0.97,
                'take_profit': current_price * 1.08,
                'confidence': confidence,
                'reason': f"{trend['type']} - å¼ºçƒˆä¹°å…¥"
            }

        elif signal == 'BUY' and confidence > 0.70:
            return {
                'action': 'BUY',
                'position': 0.25,
                'leverage': 1,
                'entry_price': current_price,
                'stop_loss': current_price * 0.97,
                'take_profit': current_price * 1.06,
                'confidence': confidence,
                'reason': f"{trend['type']} - ä¹°å…¥"
            }

        elif signal == 'STRONG_SELL' and confidence > 0.85:
            return {
                'action': 'SHORT',
                'position': 0.30,
                'leverage': 5,
                'entry_price': current_price,
                'stop_loss': current_price * 1.03,
                'take_profit': current_price * 0.92,
                'confidence': confidence,
                'reason': f"{trend['type']} - å¼ºçƒˆåšç©º"
            }

        elif signal == 'SELL' and confidence > 0.70:
            return {
                'action': 'SHORT',
                'position': 0.20,
                'leverage': 3,
                'entry_price': current_price,
                'stop_loss': current_price * 1.04,
                'take_profit': current_price * 0.94,
                'confidence': confidence,
                'reason': f"{trend['type']} - åšç©º"
            }

        else:
            return {
                'action': 'HOLD',
                'reason': 'è¶‹åŠ¿ä¸æ˜ç¡®æˆ–ç½®ä¿¡åº¦ä¸è¶³'
            }


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    # åˆå§‹åŒ–åˆ†æå™¨
    analyzer = Candle15mTrendAnalyzer()

    # è·å–15åˆ†é’ŸKçº¿æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
    candles = [
        # ... ä½ çš„Kçº¿æ•°æ®
    ]

    # åˆ†æè¶‹åŠ¿
    result = analyzer.analyze(candles)

    print("=== 15åˆ†é’ŸKçº¿è¶‹åŠ¿åˆ†æ ===")
    print(f"ç»Ÿè®¡: {result['statistics']}")
    print(f"è¶‹åŠ¿: {result['trend']}")

    # ç”Ÿæˆäº¤æ˜“ä¿¡å·
    current_price = 95000
    signal = analyzer.generate_trading_signal(candles, current_price)

    print(f"\n=== äº¤æ˜“ä¿¡å· ===")
    print(f"æ“ä½œ: {signal['action']}")
    print(f"åŸå› : {signal['reason']}")
    if signal['action'] != 'HOLD':
        print(f"ä»“ä½: {signal['position']*100}%")
        print(f"æ æ†: {signal['leverage']}x")
        print(f"æ­¢æŸ: ${signal['stop_loss']:,.0f}")
        print(f"æ­¢ç›ˆ: ${signal['take_profit']:,.0f}")
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
1. âœ… **ç®€å•ç›´è§‚** - çœ‹æ¶¨è·Œæ•°é‡ï¼Œä¸€ç›®äº†ç„¶
2. âœ… **å“åº”å¿«é€Ÿ** - 15åˆ†é’Ÿçº§åˆ«ï¼Œå¿«é€Ÿæ•æ‰è¶‹åŠ¿
3. âœ… **æ˜“äºå®ç°** - ä»£ç ç®€å•ï¼Œå®¹æ˜“ç†è§£
4. âœ… **çµæ´»æ‰©å±•** - å¯ç»“åˆå…¶ä»–æŒ‡æ ‡å¢å¼º

### é€‚ç”¨åœºæ™¯
- âœ… çŸ­çº¿äº¤æ˜“ï¼ˆæŒä»“å‡ å°æ—¶ï¼‰
- âœ… æ³¢æ®µäº¤æ˜“ï¼ˆæŒä»“1-2å¤©ï¼‰
- âœ… è¶‹åŠ¿è·Ÿéš
- âœ… å›è°ƒå…¥åœº

### æ³¨æ„äº‹é¡¹
- âš ï¸ ä¸é€‚åˆé•¿æœŸè¶‹åŠ¿åˆ¤æ–­ï¼ˆç”¨1å°æ—¶æˆ–4å°æ—¶Kçº¿æ›´å¥½ï¼‰
- âš ï¸ éœ‡è¡å¸‚æ•ˆæœå·®ï¼ˆéœ€è¦ç»“åˆå…¶ä»–æŒ‡æ ‡ï¼‰
- âš ï¸ éœ€è¦ä¸¥æ ¼æ­¢æŸï¼ˆçŸ­æœŸæ³¢åŠ¨å¤§ï¼‰

---

**ç¥ä½ äº¤æ˜“é¡ºåˆ©ï¼** ğŸš€
