# 实盘合约交易执行逻辑说明书

## 目录
1. [系统架构](#1-系统架构)
   - [核心设计原则：实盘跟随模拟盘](#️-核心设计原则实盘跟随模拟盘)
   - [模拟盘与实盘同步流程](#模拟盘与实盘同步流程)
2. [策略配置参数](#2-策略配置参数)
3. [信号生成流程](#3-信号生成流程)
4. [开仓执行流程](#4-开仓执行流程)
5. [平仓执行流程](#5-平仓执行流程)
6. [订单监控服务](#6-订单监控服务)
7. [数据库表结构](#7-数据库表结构)
8. [API接口](#8-api接口)
9. [资金控制总结](#9-资金控制总结)
10. [文件位置索引](#10-文件位置索引)
11. [反转预警机制](#11-反转预警机制)
12. [5M信号智能止损](#12-5m信号智能止损)

---

## 1. 系统架构

### ⚠️ 核心设计原则：实盘跟随模拟盘

**实盘交易不是独立运行的，它是跟随模拟盘逻辑执行的。**

当策略的 `syncLive` 配置为 `true` 时：
1. **模拟盘引擎**先执行交易信号判断和开仓/平仓操作
2. **如果模拟盘开仓成功**，才会同步调用实盘引擎开仓
3. **如果模拟盘平仓**，才会同步调用实盘引擎平仓

这样设计的好处：
- 模拟盘作为"前置验证"，先验证信号逻辑是否正确
- 实盘跟随模拟盘，确保两边仓位一致
- 可以只开模拟盘 (`syncLive=false`) 观察策略效果，满意后再开启实盘同步

### 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           策略配置层                                      │
│                    trading_strategies 表                                 │
│                    (config JSON 字段)                                    │
└─────────────────────────────┬───────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         信号生成层                                        │
│                   StrategyExecutor                                       │
│              (app/services/strategy_executor.py)                         │
│   - 定时获取K线数据                                                       │
│   - 计算技术指标 (EMA/RSI/MACD/KDJ/布林带)                                │
│   - 判断开仓/平仓信号                                                     │
│   - 多重过滤条件                                                          │
└─────────────────────────────┬───────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        交易执行层                                         │
│                 BinanceFuturesEngine                                     │
│          (app/trading/binance_futures_engine.py)                         │
│   - 调用币安合约API                                                       │
│   - 执行开仓/平仓订单                                                     │
│   - 设置止损止盈订单                                                      │
│   - 保存交易记录到数据库                                                   │
└─────────────────────────────┬───────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        订单监控层                                         │
│                  LiveOrderMonitor                                        │
│           (app/services/live_order_monitor.py)                           │
│   - 监控限价单成交状态                                                     │
│   - 成交后设置止损止盈                                                     │
│   - 限价单超时转市价                                                       │
│   - 趋势反转取消挂单                                                       │
│   - 智能止盈监控                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 模拟盘与实盘同步流程

```
策略信号触发
      │
      ▼
┌─────────────────────┐
│  模拟盘引擎         │
│  FuturesTradingEngine │
│  (内存计算)          │
└─────────┬───────────┘
          │
          ▼
   模拟盘开仓成功？
          │
    ┌─────┴─────┐
    │           │
   Yes         No
    │           │
    ▼           ▼
检查 syncLive    结束
    │
    ▼
syncLive = true?
    │
  ┌─┴─┐
  │   │
 Yes  No
  │   │
  ▼   ▼
┌───────────────────────┐
│  实盘引擎             │    ←── 只有模拟盘成功且syncLive=true才执行
│  BinanceFuturesEngine │
│  (真实API调用)        │
└───────────────────────┘
```

**关键代码位置**: `app/services/strategy_executor.py` 第 3843-3896 行

```python
# ========== 同步实盘交易 ==========
if sync_live and self.live_engine is not None:
    # 获取实盘账户可用余额
    live_balance_info = self.live_engine.get_account_balance()
    # ... 计算实盘下单数量 ...
    # 调用实盘引擎开仓
    live_result = self.live_engine.open_position(
        account_id=1,
        symbol=symbol,
        position_side=position_side,
        quantity=live_quantity,
        leverage=leverage,
        ...
    )
```

---

## 2. 策略配置参数

所有交易参数存储在 `trading_strategies` 表的 `config` JSON 字段中。

### 2.1 基础交易参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `leverage` | int | 5 | 杠杆倍数 (1-125) |
| `positionSizePct` | float | 10 | 仓位占账户余额百分比 (1-100) |
| `stopLossPercent` | float | 2.5 | 止损百分比 |
| `takeProfitPercent` | float | 7.5 | 止盈百分比 |
| `feeRate` | float | 0.0004 | 手续费率 (0.04%) |

### 2.2 实盘同步配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `syncLive` | bool | false | 是否同步到实盘 |
| `liveQuantityPct` | float | 100 | 实盘下单比例 (占模拟仓位的%) |
| `liveMaxPositionUsdt` | float | 200 | **实盘单笔最大仓位(USDT)** - 硬上限 |

### 2.3 订单类型配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `longPriceType` | string | "market" | 做多订单类型: market/limit |
| `shortPriceType` | string | "market" | 做空订单类型: market/limit |
| `limitOrderTimeoutMinutes` | int | 0 | 限价单超时分钟数 (0=不超时) |

### 2.4 信号过滤配置

| 参数 | 类型 | 说明 |
|-----|------|------|
| `emaPeriods` | [int, int] | EMA周期 [短期, 长期]，默认 [9, 26] |
| `timeframe` | string | K线周期，如 "15m" |
| `buyDirection` | string[] | 允许的开仓方向: ["long"], ["short"], ["long", "short"] |
| `rsiFilter.enabled` | bool | 是否启用RSI过滤 |
| `rsiFilter.longMax` | int | 做多时RSI最大值 (默认70) |
| `rsiFilter.shortMin` | int | 做空时RSI最小值 (默认30) |
| `macdFilter.enabled` | bool | 是否启用MACD过滤 |
| `kdjFilter.enabled` | bool | 是否启用KDJ过滤 |

### 2.5 持续趋势配置

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `sustainedTrend.enabled` | bool | false | 是否允许趋势中段开仓 |
| `sustainedTrend.minStrength` | float | 0.15 | 最小EMA差距% |
| `sustainedTrend.maxStrength` | float | 1.0 | 最大EMA差距% (防止追高) |
| `sustainedTrend.minBars` | int | 2 | 最少连续K线数 |
| `sustainedTrend.cooldownMinutes` | int | 60 | 冷却时间(分钟) |

### 2.6 策略配置JSON示例

```json
{
  "emaPeriods": [9, 26],
  "timeframe": "15m",
  "leverage": 5,
  "positionSizePct": 10,
  "stopLossPercent": 2.5,
  "takeProfitPercent": 7.5,
  "syncLive": true,
  "liveQuantityPct": 100,
  "liveMaxPositionUsdt": 200,
  "longPriceType": "limit",
  "shortPriceType": "market",
  "limitOrderTimeoutMinutes": 5,
  "buyDirection": ["long", "short"],
  "rsiFilter": {
    "enabled": true,
    "longMax": 70,
    "shortMin": 30
  },
  "sustainedTrend": {
    "enabled": true,
    "minStrength": 0.15,
    "maxStrength": 1.0,
    "minBars": 2
  }
}
```

---

## 3. 信号生成流程

### 3.1 信号判断逻辑

```
获取K线数据 (timeframe周期)
        │
        ▼
计算技术指标
├── EMA短期 (emaPeriods[0], 默认9)
├── EMA长期 (emaPeriods[1], 默认26)
├── RSI (14周期)
├── MACD (12, 26, 9)
└── KDJ (9, 3, 3)
        │
        ▼
判断买入信号
├── 金叉信号: EMA短期 上穿 EMA长期
├── 持续趋势: EMA差距在 minStrength ~ maxStrength 范围内
└── EMA方向确认: EMA9 > EMA26 (做多) / EMA9 < EMA26 (做空)
        │
        ▼
多重过滤
├── RSI过滤: 做多时RSI < longMax
├── MACD过滤: 做多时MACD > 0
├── KDJ过滤: 做多时K < longMaxK
├── 价格距离限制: 防止追高杀低
└── 开仓冷却: 防止频繁开仓
        │
        ▼
通过所有过滤 → 产生开仓信号
```

### 3.2 代码位置

- 主入口: `app/services/strategy_executor.py` 的 `execute_strategy()` 方法
- 配置加载: 第 460-580 行
- 信号判断: 第 3000-3500 行

---

## 4. 开仓执行流程

### 4.1 仓位计算公式

```python
# 1. 计算目标仓位价值
position_value = account_equity × (positionSizePct / 100)

# 2. 实盘模式限制单笔上限
if market_type == 'live':
    if position_value > liveMaxPositionUsdt:
        position_value = liveMaxPositionUsdt  # 硬上限 200 USDT

    if account_equity < position_value:
        position_value = account_equity  # 余额不足按实际下单

# 3. 计算下单数量
quantity = (position_value × leverage) / entry_price
```

### 4.2 开仓流程 (BinanceFuturesEngine.open_position)

```
接收开仓请求
        │
        ▼
1. 设置杠杆 (/fapi/v1/leverage)
        │
        ▼
2. 设置全仓模式 (/fapi/v1/marginType → CROSSED)
        │
        ▼
3. 获取当前价格 (/fapi/v1/ticker/price)
        │
        ▼
4. 精度处理
   ├── 数量精度 (stepSize)
   ├── 价格精度 (tickSize)
   ├── 最小数量检查 (minQty)
   └── 最小名义价值检查 (minNotional = 5 USDT)
        │
        ▼
5. 构建订单参数
   {
     symbol: "BTCUSDT",
     side: "BUY" / "SELL",
     positionSide: "LONG" / "SHORT",  ← 双向持仓模式
     type: "MARKET" / "LIMIT",
     quantity: "0.001",
     price: "50000" (限价单),
     timeInForce: "GTC" (限价单)
   }
        │
        ▼
6. 发送订单 (/fapi/v1/order)
        │
        ▼
7. 解析订单结果
   ├── orderId: 币安订单ID
   ├── status: NEW / FILLED
   ├── executedQty: 成交数量
   └── avgPrice: 成交均价
        │
        ▼
8. 设置止损止盈 (仅市价单立即成交时)
   ├── 止损: STOP_MARKET 订单
   └── 止盈: TAKE_PROFIT_MARKET 订单
        │
        ▼
9. 保存到数据库 (live_futures_positions)
        │
        ▼
10. 发送Telegram通知
```

### 4.3 止损止盈价格计算

```python
# 做多 (LONG)
stop_loss_price = entry_price × (1 - stopLossPercent / 100)
take_profit_price = entry_price × (1 + takeProfitPercent / 100)

# 做空 (SHORT)
stop_loss_price = entry_price × (1 + stopLossPercent / 100)
take_profit_price = entry_price × (1 - takeProfitPercent / 100)
```

### 4.4 止损止盈价格验证

```python
# 做多: 止损价必须低于入场价，止盈价必须高于入场价
if position_side == 'LONG':
    sl_valid = stop_loss_price < entry_price
    tp_valid = take_profit_price > entry_price

# 做空: 止损价必须高于入场价，止盈价必须低于入场价
if position_side == 'SHORT':
    sl_valid = stop_loss_price > entry_price
    tp_valid = take_profit_price < entry_price
```

---

## 5. 平仓执行流程

### 5.1 平仓流程 (BinanceFuturesEngine.close_position)

```
接收平仓请求 (position_id, reason)
        │
        ▼
1. 从数据库获取持仓信息
   SELECT * FROM live_futures_positions WHERE id = ? AND status = 'OPEN'
        │
        ▼
2. 确定平仓数量 (默认全部)
        │
        ▼
3. 发送平仓订单
   {
     symbol: "BTCUSDT",
     side: "SELL" (做多平仓) / "BUY" (做空平仓),
     positionSide: "LONG" / "SHORT",
     type: "MARKET",
     quantity: "0.001"
   }
        │
        ▼
4. 计算盈亏
   # 做多
   pnl = (close_price - entry_price) × quantity
   # 做空
   pnl = (entry_price - close_price) × quantity
        │
        ▼
5. 更新数据库
   UPDATE live_futures_positions
   SET status = 'CLOSED',
       realized_pnl = pnl,
       close_price = avg_price,
       close_time = NOW(),
       close_reason = reason
        │
        ▼
6. 取消相关止损止盈订单
        │
        ▼
7. 发送Telegram通知
```

### 5.2 平仓原因 (close_reason)

| 原因 | 说明 |
|-----|------|
| `manual` | 手动平仓 |
| `stop_loss` | 止损触发 |
| `take_profit` | 止盈触发 |
| `signal_reverse` | 信号反转 (如死叉平多) |
| `binance_sync` | 从币安APP同步 |
| `trend_reversal` | 趋势反转 |
| `reversal_warning` | 反转预警平仓 |
| `5m_signal_stop` | 5M信号止损 |

---

## 6. 订单监控服务

### 6.1 监控内容

`LiveOrderMonitor` 每10秒检查一次：

1. **限价单成交状态**: PENDING → FILLED 后设置止损止盈
2. **限价单超时**: 超时后根据价格偏离决定转市价或取消
3. **趋势反转**: EMA趋势反转时取消未成交限价单
4. **智能止盈**: 连续K线止盈、移动止盈

### 6.2 限价单超时处理

```
检测到限价单超时 (elapsed >= limitOrderTimeoutMinutes)
        │
        ▼
计算价格偏离
# 做多: 当前价高于限价 = 追高
deviation = (current_price - limit_price) / limit_price × 100
# 做空: 当前价低于限价 = 杀低
deviation = (limit_price - current_price) / limit_price × 100
        │
        ▼
取消币安上的限价单
        │
        ├── deviation ≤ 0.5%
        │   └── 以市价重新开仓 (转市价)
        │
        └── deviation > 0.5%
            └── 放弃开仓 (避免追高杀低)
            └── 更新状态为 TIMEOUT_PRICE_DEVIATION
```

### 6.3 趋势反转检查

```python
# 做多仓位: 检查EMA是否死叉
if position_side == 'LONG':
    if ema9 < ema26:  # EMA9下穿EMA26
        return 'ema_death_cross'  # 取消限价单

# 做空仓位: 检查EMA是否金叉
if position_side == 'SHORT':
    if ema9 > ema26:  # EMA9上穿EMA26
        return 'ema_golden_cross'  # 取消限价单
```

---

## 7. 数据库表结构

### 7.1 live_futures_positions (实盘持仓表)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | INT | 主键 |
| account_id | INT | 账户ID |
| symbol | VARCHAR | 交易对 (BTC/USDT) |
| position_side | VARCHAR | LONG / SHORT |
| quantity | DECIMAL | 持仓数量 |
| entry_price | DECIMAL | 入场价格 |
| leverage | INT | 杠杆倍数 |
| stop_loss_price | DECIMAL | 止损价格 |
| take_profit_price | DECIMAL | 止盈价格 |
| status | VARCHAR | PENDING / OPEN / CLOSED |
| binance_order_id | VARCHAR | 币安订单ID |
| strategy_id | INT | 关联策略ID |
| source | VARCHAR | 来源 (strategy / manual) |
| realized_pnl | DECIMAL | 已实现盈亏 |
| close_price | DECIMAL | 平仓价格 |
| close_time | DATETIME | 平仓时间 |
| close_reason | VARCHAR | 平仓原因 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 7.2 trading_strategies (策略配置表)

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | INT | 主键 |
| name | VARCHAR | 策略名称 |
| config | JSON | 策略配置 (本文档第2节所述参数) |
| status | VARCHAR | 策略状态 |
| market_type | VARCHAR | test / live |
| created_at | DATETIME | 创建时间 |

---

## 8. API接口

### 8.1 实盘交易API

基础路径: `/api/live-trading`

| 方法 | 端点 | 说明 |
|-----|------|------|
| GET | `/test-connection` | 测试币安API连接 |
| GET | `/account/balance` | 获取账户余额 |
| GET | `/price/{symbol}` | 获取实时价格 |
| POST | `/leverage` | 设置杠杆 |
| GET | `/positions` | 获取当前持仓 |
| POST | `/open` | 开仓 |
| POST | `/close` | 平仓 (按position_id) |
| POST | `/close-by-symbol` | 平仓 (按交易对) |
| GET | `/orders` | 获取挂单 |
| DELETE | `/order` | 取消订单 |
| POST | `/sync-from-binance` | 从币安同步持仓状态 |

### 8.2 开仓请求示例

```json
POST /api/live-trading/open
{
  "account_id": 1,
  "symbol": "BTC/USDT",
  "position_side": "LONG",
  "quantity_pct": 10,          // 按资金百分比
  "leverage": 5,
  "limit_price": null,         // null=市价
  "stop_loss_pct": 2.5,
  "take_profit_pct": 7.5,
  "source": "manual",
  "strategy_id": null
}
```

### 8.3 平仓请求示例

```json
POST /api/live-trading/close
{
  "position_id": 123,
  "close_quantity": null,      // null=全部
  "reason": "manual"
}
```

---

## 9. 资金控制总结

```
┌─────────────────────────────────────────────────────────────┐
│                     资金控制三层机制                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. positionSizePct (仓位百分比)                             │
│     └── 按账户余额百分比计算目标仓位                          │
│     └── 例: 余额1000U × 10% = 100U                         │
│                                                             │
│  2. liveMaxPositionUsdt (单笔上限)                          │
│     └── 实盘硬上限，超过则截断                               │
│     └── 例: 计算结果300U > 上限200U → 使用200U              │
│                                                             │
│  3. account_equity (余额检查)                               │
│     └── 余额不足时按实际余额下单                             │
│     └── 例: 目标200U > 可用150U → 使用150U                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘

最终下单金额 = min(
    account_equity × positionSizePct%,
    liveMaxPositionUsdt,
    account_equity
)
```

---

## 10. 文件位置索引

| 模块 | 文件路径 |
|-----|---------|
| 策略执行器 | `app/services/strategy_executor.py` |
| 实盘交易引擎 | `app/trading/binance_futures_engine.py` |
| 订单监控服务 | `app/services/live_order_monitor.py` |
| 实盘交易API | `app/api/live_trading_api.py` |
| 交易通知 | `app/services/trade_notifier.py` |
| 全局配置 | `config.yaml` |

---

## 11. 反转预警机制

### 11.1 概述

反转预警检测的是EMA9斜率的**突变**（而非简单的方向反转）。当斜率变化幅度超过阈值时触发预警。

### 11.2 检测逻辑

```python
# 计算斜率变化
slope_current = (ema9[-2] - ema9[-3]) / ema9[-3] * 100
slope_prev = (ema9[-3] - ema9[-4]) / ema9[-4] * 100
slope_change = abs(slope_current - slope_prev)

# 默认阈值0.3%
if slope_change >= threshold:
    trigger_reversal_warning()
```

### 11.3 预警触发后的干预

1. **阻止新开仓**：策略进入冷却期
2. **取消模拟盘挂单**：取消该方向的PENDING限价单
3. **平仓模拟盘持仓**：自动平掉该方向的模拟盘持仓

**注意**：实盘使用市价单开仓，不存在挂单，所以不需要取消实盘订单。

### 11.4 配置参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `reversalWarning.enabled` | bool | true | 是否启用反转预警 |
| `reversalWarning.slopeChangeThreshold` | float | 0.3 | 斜率变化阈值(%) |

---

## 12. 5M信号智能止损

### 12.1 概述

当持仓处于亏损状态时，使用5M周期的EMA交叉信号提前止损，避免等到15M确认反转时亏损更大。

### 12.2 触发条件

- 当前持仓亏损 (pnl < 0)
- 5M周期出现反向EMA交叉（做多遇死叉、做空遇金叉）
- EMA差值超过阈值（默认0.15%）
- 不在开仓冷却期内

### 12.3 配置参数

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|-------|------|
| `smartStopLoss.signalStopLoss.enabled` | bool | true | 是否启用5M信号止损 |
| `smartStopLoss.signalStopLoss.minEmaDiffPct` | float | 0.15 | 最小EMA差值阈值(%) |

---

*文档更新时间: 2025-12-26*
