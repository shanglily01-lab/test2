# ç ´ä½ä¿¡å·äº¤æ˜“ç­–ç•¥è®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€ç ´ä½ä¿¡å·å®šä¹‰ï¼ˆ24HåŒºé—´ï¼‰

### 1. æ£€æµ‹æ¡ä»¶ï¼ˆä¸‰è¦ç´ å…¨éƒ¨æ»¡è¶³ï¼‰

```python
æ¡ä»¶1: Big4å¤©ç‹ç¡®è®¤æ–¹å‘
  - è°ƒç”¨ç°æœ‰çš„ Big4TrendDetector
  - ç¡®ä¿å¤§ç›˜æ–¹å‘ä¸ç ´ä½æ–¹å‘ä¸€è‡´

æ¡ä»¶2: çŸ­å‘¨æœŸæ”¾é‡çªç ´
  - 15M Kçº¿æ¶¨è·Œå¹… > 0.3%
  - æˆäº¤é‡æ”¾å¤§ > 1.5å€ï¼ˆç›¸å¯¹æœ€è¿‘20æ ¹15Må‡å€¼ï¼‰
  - æ–¹å‘æ˜ç¡®ï¼ˆé˜³çº¿å‘ä¸Š/é˜´çº¿å‘ä¸‹ï¼‰

æ¡ä»¶3: çªç ´24Hæ–°é«˜/æ–°ä½
  - è·å– price_stats_24h è¡¨æ•°æ®
  - å‘ä¸Šç ´ä½: current_price > high_24h
  - å‘ä¸‹ç ´ä½: current_price < low_24h
```

### 2. ç ´ä½å¼ºåº¦åˆ†çº§

| çº§åˆ« | çªç ´å¹…åº¦ | é‡èƒ½æ”¾å¤§ | 15Mæ¶¨è·Œ | ç½®ä¿¡åº¦ |
|-----|---------|---------|---------|-------|
| ğŸ”¥ å¼ºç ´ä½ | >0.5% | >2.0å€ | >0.5% | 90+ |
| âš¡ ä¸­ç ´ä½ | 0.2-0.5% | 1.5-2.0å€ | 0.3-0.5% | 70-85 |
| âš ï¸ å¼±ç ´ä½ | <0.2% | <1.5å€ | <0.3% | <60 |

---

## äºŒã€ç ´ä½ä¸ç°æœ‰æŒä»“å†²çªå¤„ç†

### åœºæ™¯åˆ†ç±»

```
åœºæ™¯A: å¼ºç ´ä½ + æŒæœ‰åå‘ä»“
  â†’ æ“ä½œ: ç«‹å³å¹³æ‰åå‘ä»“ + ç«‹å³å¼€ç ´ä½æ–¹å‘æ–°ä»“
  â†’ ç†ç”±: å¼ºç ´ä½ç½®ä¿¡åº¦é«˜(90+),è¶‹åŠ¿ç¡®å®š,ç«‹å³åæ‰‹

åœºæ™¯B: ä¸­ç ´ä½ + æŒæœ‰åå‘ä»“
  â†’ æ“ä½œ: ç«‹å³å¹³æ‰åå‘ä»“ + ç­‰å¾…å›è°ƒ1-2æ ¹15M Kçº¿åå¼€ä»“
  â†’ ç†ç”±: ä¸­ç­‰å¼ºåº¦,å…ˆæ­¢æŸä¿æŠ¤,ç­‰å›è°ƒç¡®è®¤å†å…¥åœº

åœºæ™¯C: å¼±ç ´ä½ + æŒæœ‰åå‘ä»“
  â†’ æ“ä½œ: å¿½ç•¥ç ´ä½ä¿¡å·,ç»§ç»­æŒæœ‰,ç­‰åŸæ­¢æŸç­–ç•¥è§¦å‘
  â†’ ç†ç”±: å¼±ç ´ä½å¯èƒ½æ˜¯å‡çªç ´,ä¸å€¼å¾—æ“ä½œ
```

### å®ç°é€»è¾‘

```python
def handle_breakout_conflict(self, breakout_signal, current_positions):
    """
    å¤„ç†ç ´ä½ä¿¡å·ä¸ç°æœ‰æŒä»“çš„å†²çª

    Args:
        breakout_signal: {
            'direction': 'LONG'/'SHORT',
            'strength': 'STRONG'/'MEDIUM'/'WEAK',
            'confidence': 90
        }
        current_positions: å½“å‰æŒä»“åˆ—è¡¨

    Returns:
        action: 'REVERSE_NOW' / 'STOP_AND_WAIT' / 'IGNORE'
    """
    breakout_dir = breakout_signal['direction']
    strength = breakout_signal['strength']

    # æŸ¥æ‰¾åå‘æŒä»“
    reverse_positions = [
        pos for pos in current_positions
        if (breakout_dir == 'LONG' and pos['side'] == 'SHORT') or
           (breakout_dir == 'SHORT' and pos['side'] == 'LONG')
    ]

    if not reverse_positions:
        return 'NO_CONFLICT'  # æ— å†²çª,æ­£å¸¸å¤„ç†

    # æ ¹æ®ç ´ä½å¼ºåº¦å†³å®šæ“ä½œ
    if strength == 'STRONG':
        # ğŸ”¥ å¼ºç ´ä½: ç«‹å³åæ‰‹
        for pos in reverse_positions:
            self.close_position_by_side(
                symbol=pos['symbol'],
                side=pos['side'],
                reason=f"BREAKOUT_REVERSE:å¼ºç ´ä½åè½¬"
            )
        return 'REVERSE_NOW'  # è¿”å›ç«‹å³å¼€ä»“æŒ‡ä»¤

    elif strength == 'MEDIUM':
        # âš¡ ä¸­ç ´ä½: å…ˆæ­¢æŸ,ç­‰å›è°ƒ
        for pos in reverse_positions:
            self.close_position_by_side(
                symbol=pos['symbol'],
                side=pos['side'],
                reason=f"BREAKOUT_STOP:ä¸­ç ´ä½æ­¢æŸ"
            )
        return 'STOP_AND_WAIT'  # è¿”å›ç­‰å¾…ç¡®è®¤æŒ‡ä»¤

    else:  # WEAK
        # âš ï¸ å¼±ç ´ä½: å¿½ç•¥
        return 'IGNORE'
```

---

## ä¸‰ã€ç ´ä½åçš„å¼€ä»“æ—¶æœºç­–ç•¥

### ç­–ç•¥ï¼šåˆ†çº§å¼€ä»“

```python
å¼€ä»“æ—¶æœºå†³ç­–æ ‘:

ç ´ä½å¼ºåº¦ == å¼ºç ´ä½?
  â”œâ”€ YES â†’ ç«‹å³å¼€ä»“ï¼ˆ3åˆ†é’Ÿå†…æ‰§è¡Œï¼‰
  â”‚         - ä»“ä½: æ ‡å‡†ä»“ä½ Ã— 1.0
  â”‚         - æ­¢æŸ: ç ´ä½ç‚¹ä½ï¼ˆ24H high/lowï¼‰
  â”‚         - ç†ç”±: é«˜ç½®ä¿¡åº¦,æŠ“ä½è¶‹åŠ¿å¯åŠ¨
  â”‚
  â””â”€ NO â†’ ç ´ä½å¼ºåº¦ == ä¸­ç ´ä½?
           â”œâ”€ YES â†’ ç­‰å¾…å›è°ƒå¼€ä»“
           â”‚         - ç­‰å¾…: 1-2æ ¹15M Kçº¿
           â”‚         - å›è°ƒæ¡ä»¶: å›è°ƒ0.2%-0.3%
           â”‚         - è¶…æ—¶: 30åˆ†é’Ÿæœªå›è°ƒåˆ™æ”¾å¼ƒ
           â”‚         - ä»“ä½: æ ‡å‡†ä»“ä½ Ã— 0.8
           â”‚
           â””â”€ NO â†’ å¼±ç ´ä½,ä¸å¼€ä»“
```

### ç­‰å¾…å›è°ƒçš„å…·ä½“é€»è¾‘

```python
def wait_for_pullback_entry(self, symbol, breakout_signal):
    """
    ç ´ä½åç­‰å¾…å›è°ƒå¼€ä»“

    ç›‘æ§é€»è¾‘:
    1. ç ´ä½å‘ç”Ÿå,è®°å½•ç ´ä½ä»·æ ¼ breakout_price
    2. ç­‰å¾…ä»·æ ¼å›è°ƒåˆ° breakout_price Â± 0.3%
    3. å›è°ƒåå†æ¬¡å‘ç ´ä½æ–¹å‘è¿åŠ¨ > 0.15%
    4. æ»¡è¶³æ¡ä»¶ â†’ å¼€ä»“
    5. è¶…æ—¶30åˆ†é’Ÿæœªè§¦å‘ â†’ æ”¾å¼ƒ

    Args:
        symbol: äº¤æ˜“å¯¹
        breakout_signal: ç ´ä½ä¿¡å·
    """
    breakout_price = breakout_signal['price']
    direction = breakout_signal['direction']
    start_time = time.time()

    while (time.time() - start_time) < 1800:  # 30åˆ†é’Ÿè¶…æ—¶
        current_price = self.ws_service.get_price(symbol)

        if direction == 'LONG':
            # å‘ä¸Šç ´ä½,ç­‰å¾…å›è°ƒ
            pullback_target = breakout_price * 0.997  # å›è°ƒ0.3%
            if current_price <= pullback_target:
                # å›è°ƒåˆ°ä½,ç­‰å¾…å†æ¬¡ä¸Šæ¶¨
                time.sleep(60)  # ç­‰å¾…1åˆ†é’Ÿ
                new_price = self.ws_service.get_price(symbol)
                if new_price > current_price * 1.0015:  # å†æ¶¨0.15%
                    return 'ENTRY_CONFIRMED'

        else:  # SHORT
            # å‘ä¸‹ç ´ä½,ç­‰å¾…åå¼¹
            pullback_target = breakout_price * 1.003  # åå¼¹0.3%
            if current_price >= pullback_target:
                # åå¼¹åˆ°ä½,ç­‰å¾…å†æ¬¡ä¸‹è·Œ
                time.sleep(60)
                new_price = self.ws_service.get_price(symbol)
                if new_price < current_price * 0.9985:  # å†è·Œ0.15%
                    return 'ENTRY_CONFIRMED'

        time.sleep(15)  # æ¯15ç§’æ£€æŸ¥ä¸€æ¬¡

    return 'TIMEOUT'  # è¶…æ—¶æ”¾å¼ƒ
```

---

## å››ã€ç ´ä½ä¿¡å·æƒé‡é…ç½®

### è¯„åˆ†ä½“ç³»è°ƒæ•´

```python
# åŸæœ‰æƒé‡
OLD_WEIGHTS = {
    'breakout_long': 20,
    'breakdown_short': 20,
    'volume_power_bull': 25,
    'volume_power_bear': 25,
}

# æ–°æƒé‡ï¼ˆç ´ä½ä¸ºæ ¸å¿ƒï¼‰
NEW_WEIGHTS = {
    # ğŸ”¥ ç ´ä½ä¿¡å·ï¼ˆæ ¸å¿ƒï¼‰
    'breakout_strong': 50,      # å¼ºç ´ä½å•ç‹¬å°±èƒ½å¼€ä»“
    'breakdown_strong': 50,
    'breakout_medium': 40,      # ä¸­ç ´ä½éœ€é…åˆå…¶ä»–ä¿¡å·
    'breakdown_medium': 40,

    # é‡èƒ½ä¿¡å·ï¼ˆè¾…åŠ©ï¼‰
    'volume_power_bull': 20,    # é™ä½æƒé‡,ä½œä¸ºç¡®è®¤ä¿¡å·
    'volume_power_bear': 20,

    # å…¶ä»–ä¿¡å·
    'trend_1h_bull': 15,
    'trend_1h_bear': 15,
    'position_low': 10,
    'position_high': 10,
}

# å¼€ä»“é˜ˆå€¼
THRESHOLD = 35  # ä¿æŒä¸å˜

# ç»„åˆç¤ºä¾‹
å¼ºç ´ä½ (50åˆ†) â†’ ç›´æ¥å¼€ä»“
ä¸­ç ´ä½ (40åˆ†) + é‡èƒ½ç¡®è®¤ (20åˆ†) â†’ 60åˆ†å¼€ä»“
ä¸­ç ´ä½ (40åˆ†) + ä½ç½®ä¿¡å· (10åˆ†) â†’ ä»éœ€å…¶ä»–ä¿¡å·
```

---

## äº”ã€é£é™©æ§åˆ¶

### 1. ç ´ä½åæ‰‹çš„é£é™©æ§åˆ¶

```python
é£é™©é¡¹ | æ§åˆ¶æªæ–½
------|--------
å‡çªç ´ | åªå¯¹å¼ºç ´ä½(ç½®ä¿¡åº¦90+)ç«‹å³åæ‰‹,ä¸­ç ´ä½ç­‰å›è°ƒ
è¿ç»­åæ‰‹ | åŒä¸€äº¤æ˜“å¯¹2å°æ—¶å†…æœ€å¤šåæ‰‹1æ¬¡
æ‰‹ç»­è´¹ | è®¡ç®—åæ‰‹æˆæœ¬,ç¡®ä¿ç›ˆäºæ¯” > 2:1
æ­¢æŸè·ç¦» | ç ´ä½ç‚¹ä½ä½œä¸ºæ­¢æŸ,ç¡®ä¿é£é™©å¯æ§
```

### 2. ç ´ä½ä¿¡å·çš„æ­¢æŸç­–ç•¥

```python
# å¼ºç ´ä½å¼€ä»“åçš„æ­¢æŸ
æ­¢æŸä½ = ç ´ä½ç‚¹ä½ï¼ˆ24H high/lowï¼‰
æ­¢æŸå¹…åº¦ = é€šå¸¸0.5%-1.0%

ç¤ºä¾‹ï¼ˆå‘ä¸Šç ´ä½åšå¤šï¼‰:
  ç ´ä½ä»·: 45000 (çªç ´24Hé«˜ç‚¹44800)
  å¼€ä»“ä»·: 45000
  æ­¢æŸä»·: 44800 (24Hé«˜ç‚¹)
  æ­¢æŸå¹…åº¦: -0.44%

ç¤ºä¾‹ï¼ˆå‘ä¸‹ç ´ä½åšç©ºï¼‰:
  ç ´ä½ä»·: 2300 (è·Œç ´24Hä½ç‚¹2320)
  å¼€ä»“ä»·: 2300
  æ­¢æŸä»·: 2320 (24Hä½ç‚¹)
  æ­¢æŸå¹…åº¦: -0.87%
```

### 3. ä»“ä½ç®¡ç†

```python
ç ´ä½ä¿¡å·ä»“ä½åˆ†é…:

å¼ºç ´ä½:
  - æ ‡å‡†ä»“ä½ Ã— 1.0ï¼ˆ400Uï¼‰
  - ç†ç”±: é«˜ç½®ä¿¡åº¦,æ­£å¸¸ä»“ä½

ä¸­ç ´ä½ï¼ˆç­‰å¾…å›è°ƒåï¼‰:
  - æ ‡å‡†ä»“ä½ Ã— 0.8ï¼ˆ320Uï¼‰
  - ç†ç”±: ç­‰å¾…é™ä½äº†éƒ¨åˆ†é£é™©,ä½†ä¹Ÿé”™è¿‡äº†åˆæœŸæœºä¼š

ç ´ä½åæ‰‹:
  - æ ‡å‡†ä»“ä½ Ã— 1.0ï¼ˆ400Uï¼‰
  - ç†ç”±: è¶‹åŠ¿åè½¬,éœ€è¦æœæ–­
```

---

## å…­ã€å®æ–½æ­¥éª¤

### Phase 1: ç ´ä½æ£€æµ‹æ¨¡å—ï¼ˆä¼˜å…ˆï¼‰
```
1. å®ç° detect_breakout_24h() å‡½æ•°
2. é›†æˆ Big4 æ–¹å‘ç¡®è®¤
3. æ·»åŠ å¼ºåº¦åˆ†çº§é€»è¾‘
4. å•å…ƒæµ‹è¯•
```

### Phase 2: å†²çªå¤„ç†æ¨¡å—
```
1. å®ç° handle_breakout_conflict()
2. å®ç°ç´§æ€¥å¹³ä»“é€»è¾‘
3. æ·»åŠ åæ‰‹è®°å½•è¡¨
4. æµ‹è¯•åæ‰‹æµç¨‹
```

### Phase 3: å¼€ä»“æ—¶æœºæ¨¡å—
```
1. å¼ºç ´ä½ç«‹å³å¼€ä»“é€»è¾‘
2. ä¸­ç ´ä½ç­‰å¾…å›è°ƒé€»è¾‘ï¼ˆå¯é€‰ï¼‰
3. è¶…æ—¶æ”¾å¼ƒæœºåˆ¶
4. æµ‹è¯•å„ç§åœºæ™¯
```

### Phase 4: æƒé‡è°ƒæ•´ä¸æµ‹è¯•
```
1. è°ƒæ•´è¯„åˆ†æƒé‡é…ç½®
2. å›æµ‹å†å²æ•°æ®
3. æ¨¡æ‹Ÿç›˜æµ‹è¯•
4. é€æ­¥ä¸Šçº¿
```

---

## ä¸ƒã€ç›‘æ§æŒ‡æ ‡

```python
ç ´ä½ä¿¡å·å…³é”®æŒ‡æ ‡:

1. ç ´ä½è¯†åˆ«å‡†ç¡®ç‡
   - å¼ºç ´ä½åç»­æŒç»­æ€§ > 80%
   - ä¸­ç ´ä½åç»­æŒç»­æ€§ > 60%

2. åæ‰‹æ“ä½œè¡¨ç°
   - åæ‰‹åç›ˆåˆ©ç‡ > 55%
   - åæ‰‹æˆæœ¬æ§åˆ¶ < 0.5%

3. å¼€ä»“æ—¶æœºä¼˜åŒ–
   - ç«‹å³å¼€ä»“ vs ç­‰å¾…å›è°ƒ çš„ç›ˆäºå¯¹æ¯”
   - å¹³å‡æŒä»“æ—¶é—´
   - æœ€å¤§å›æ’¤

4. æ•´ä½“æ”¶ç›Š
   - ç ´ä½ä¿¡å·è´¡çŒ®çš„åˆ©æ¶¦å æ¯”
   - ç ´ä½ä¿¡å·çš„èƒœç‡
   - ç ´ä½ä¿¡å·çš„ç›ˆäºæ¯”
```

---

## å…«ã€é¢„æœŸæ•ˆæœ

```
ä¿å®ˆä¼°è®¡:
- æ¯å¤©æ•è· 1-3 ä¸ªç ´ä½ä¿¡å·
- å¼ºç ´ä½å æ¯”: 20-30%
- ä¸­ç ´ä½å æ¯”: 40-50%
- å¼±ç ´ä½å æ¯”: 20-30%ï¼ˆå¿½ç•¥ï¼‰

æ”¶ç›Šé¢„æœŸ:
- ç ´ä½ä¿¡å·èƒœç‡: 60-65%
- ç ´ä½ä¿¡å·ç›ˆäºæ¯”: 2:1
- å•ç¬”å¹³å‡ç›ˆåˆ©: +1.5%
- å•ç¬”å¹³å‡äºæŸ: -0.8%
```
