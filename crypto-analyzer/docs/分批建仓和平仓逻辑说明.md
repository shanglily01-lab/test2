# åˆ†æ‰¹å»ºä»“å’Œå¹³ä»“é€»è¾‘è¯´æ˜

**ç‰ˆæœ¬**: V2.0
**æ›´æ–°æ—¥æœŸ**: 2026-02-21
**çŠ¶æ€**: âœ… å·²å®ç°å¹¶ç®€åŒ–

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒè®¾è®¡ç†å¿µ](#æ ¸å¿ƒè®¾è®¡ç†å¿µ)
2. [åˆ†æ‰¹å»ºä»“é€»è¾‘](#åˆ†æ‰¹å»ºä»“é€»è¾‘)
3. [å¹³ä»“é€»è¾‘](#å¹³ä»“é€»è¾‘)
4. [ç›ˆäºè®¡ç®—](#ç›ˆäºè®¡ç®—)
5. [æ•°æ®åº“è¡¨ç»“æ„](#æ•°æ®åº“è¡¨ç»“æ„)
6. [ä»£ç ç¤ºä¾‹](#ä»£ç ç¤ºä¾‹)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## æ ¸å¿ƒè®¾è®¡ç†å¿µ

### âœ¨ è®¾è®¡åŸåˆ™

1. **æ¯æ‰¹å»ºä»“ = ç‹¬ç«‹æŒä»“**
   - ä¸å†åˆå¹¶åˆ°åŒä¸€ä¸ªæŒä»“è®°å½•
   - æ¯æ‰¹åˆ›å»ºç‹¬ç«‹çš„ position_id

2. **æ¯ä¸ªæŒä»“å…¨éƒ¨å¹³ä»“**
   - ä¸æ”¯æŒåœ¨å•ä¸ªæŒä»“å†…åˆ†æ‰¹å¹³ä»“
   - æ ¹æ®ç›ˆäºæ¯”ä¾‹åŠ¨æ€å¹³ä»“

3. **ç›ˆäºç‹¬ç«‹è®¡ç®—**
   - realized_pnl ç›´æ¥èµ‹å€¼ï¼Œä¸ç´¯åŠ 
   - æ€»ç›ˆäº = SUM(æ‰€æœ‰closedæŒä»“)

4. **æŒä»“æ•°é‡é™åˆ¶**
   - åŒä¸€äº¤æ˜“å¯¹åŒæ–¹å‘æœ€å¤š3ä¸ªæŒä»“
   - é˜²æ­¢æ— é™åˆ¶å¼€ä»“

---

## åˆ†æ‰¹å»ºä»“é€»è¾‘

### ğŸ“Š å»ºä»“æµç¨‹

```
ä¿¡å·è§¦å‘ (ä¾‹: BTC/USDT LONG)
  â†“
æ£€æŸ¥æŒä»“æ•°é‡ (< 3ä¸ª)
  â†“
ç¬¬1æ‰¹å»ºä»“ (ç«‹å³æ‰§è¡Œ)
  â”œâ”€ è®¡ç®—æ•°é‡: æ€»ä»“ä½ Ã— 40%
  â”œâ”€ æ‰§è¡Œä»·æ ¼: å½“å‰å¸‚ä»·
  â”œâ”€ åˆ›å»ºæŒä»“: INSERT Position 1001
  â””â”€ çŠ¶æ€: status = 'open'
  â†“
ç­‰å¾…15M Kçº¿å›è°ƒ
  â†“
ç¬¬2æ‰¹å»ºä»“ (Kçº¿å›è°ƒå)
  â”œâ”€ è®¡ç®—æ•°é‡: æ€»ä»“ä½ Ã— 30%
  â”œâ”€ æ‰§è¡Œä»·æ ¼: å›è°ƒåä»·æ ¼
  â”œâ”€ åˆ›å»ºæŒä»“: INSERT Position 1002
  â””â”€ çŠ¶æ€: status = 'open'
  â†“
ç­‰å¾…15M Kçº¿å›è°ƒ
  â†“
ç¬¬3æ‰¹å»ºä»“ (Kçº¿å›è°ƒå)
  â”œâ”€ è®¡ç®—æ•°é‡: æ€»ä»“ä½ Ã— 30%
  â”œâ”€ æ‰§è¡Œä»·æ ¼: å›è°ƒåä»·æ ¼
  â”œâ”€ åˆ›å»ºæŒä»“: INSERT Position 1003
  â””â”€ çŠ¶æ€: status = 'open'
```

### ğŸ“ å»ºä»“è§„åˆ™

#### 1. åˆ†æ‰¹æ¯”ä¾‹
- **ç¬¬1æ‰¹**: 40% (ç«‹å³æ‰§è¡Œ)
- **ç¬¬2æ‰¹**: 30% (ç­‰å¾…å›è°ƒ)
- **ç¬¬3æ‰¹**: 30% (ç­‰å¾…å›è°ƒ)

#### 2. å›è°ƒæ£€æµ‹
- **åšå¤š**: ç­‰å¾…1æ ¹15Mé˜´çº¿ (close < open)
- **åšç©º**: ç­‰å¾…1æ ¹15Mé˜³çº¿ (close > open)

#### 3. è¶…æ—¶æœºåˆ¶
- **ç¬¬2æ‰¹**: 30åˆ†é’Ÿè¶…æ—¶
- **ç¬¬3æ‰¹**: 45åˆ†é’Ÿè¶…æ—¶
- è¶…æ—¶åä¸å†å»ºä»“ï¼Œä½¿ç”¨å·²å»ºä»“çš„æŒä»“

#### 4. æŒä»“æ•°é‡é™åˆ¶
```python
position_count = count_positions(symbol, direction)
if position_count >= 3:
    logger.info(f"[SKIP] {symbol} {direction}æ–¹å‘å·²æœ‰{position_count}ä¸ªæŒä»“ï¼Œè¾¾åˆ°ä¸Šé™(3)")
    return  # è·³è¿‡å»ºä»“
```

### ğŸ—„ï¸ æ•°æ®åº“æ“ä½œ

æ¯æ‰¹å»ºä»“éƒ½æ‰§è¡Œ **INSERT** æ“ä½œï¼š

```sql
-- ç¬¬1æ‰¹
INSERT INTO futures_positions (
    account_id, symbol, position_side,
    quantity, entry_price, margin,
    status, source
) VALUES (
    1, 'BTC/USDT', 'LONG',
    0.012, 100000, 120,
    'open', 'smart_trader_batch'
);
-- position_id = 1001

-- ç¬¬2æ‰¹ (ç‹¬ç«‹æŒä»“ï¼Œä¸æ˜¯UPDATE)
INSERT INTO futures_positions (
    account_id, symbol, position_side,
    quantity, entry_price, margin,
    status, source
) VALUES (
    1, 'BTC/USDT', 'LONG',
    0.009, 99500, 89.55,
    'open', 'smart_trader_batch'
);
-- position_id = 1002

-- ç¬¬3æ‰¹ (ç‹¬ç«‹æŒä»“)
INSERT INTO futures_positions (
    account_id, symbol, position_side,
    quantity, entry_price, margin,
    status, source
) VALUES (
    1, 'BTC/USDT', 'LONG',
    0.009, 99000, 89.1,
    'open', 'smart_trader_batch'
);
-- position_id = 1003
```

---

## å¹³ä»“é€»è¾‘

### ğŸ¯ å¹³ä»“ç­–ç•¥

æ¯ä¸ªæŒä»“ç‹¬ç«‹åˆ¤æ–­å¹³ä»“æ¡ä»¶ï¼Œæ»¡è¶³æ¡ä»¶å°±**å…¨éƒ¨å¹³ä»“**ã€‚

#### å¹³ä»“è§¦å‘æ¡ä»¶

1. **æ­¢ç›ˆè§¦å‘**
   - ç›ˆåˆ©ç™¾åˆ†æ¯” â‰¥ take_profit_pct
   - ä¾‹: è®¾ç½®3%æ­¢ç›ˆï¼Œå½“å‰ç›ˆåˆ©3.5% â†’ å¹³ä»“

2. **æ­¢æŸè§¦å‘**
   - äºæŸç™¾åˆ†æ¯” â‰¤ stop_loss_pct
   - ä¾‹: è®¾ç½®-2%æ­¢æŸï¼Œå½“å‰äºæŸ-2.1% â†’ å¹³ä»“

3. **åŠ¨æ€æ­¢ç›ˆ**
   - æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡åŠ¨æ€è°ƒæ•´
   - é«˜æ³¢åŠ¨ç‡: æ­¢ç›ˆæé«˜åˆ°5%
   - ä½æ³¢åŠ¨ç‡: æ­¢ç›ˆé™ä½åˆ°2%

4. **ç§»åŠ¨æ­¢æŸ**
   - ç›ˆåˆ©åå¯åŠ¨ç§»åŠ¨æ­¢æŸ
   - å›æ’¤è¶…è¿‡é˜ˆå€¼ â†’ å¹³ä»“ä¿æŠ¤åˆ©æ¶¦

### ğŸ“Š å¹³ä»“æµç¨‹

```
Position 1001 ç›‘æ§å¾ªç¯
  â†“
è®¡ç®—å½“å‰ç›ˆäº
  â”œâ”€ entry_price = 100000
  â”œâ”€ current_price = 103000
  â””â”€ profit_pct = 3%
  â†“
æ£€æŸ¥å¹³ä»“æ¡ä»¶
  â”œâ”€ profit_pct (3%) >= take_profit_pct (3%) âœ“
  â””â”€ æ»¡è¶³æ­¢ç›ˆæ¡ä»¶
  â†“
æ‰§è¡Œå…¨éƒ¨å¹³ä»“
  â”œâ”€ close_quantity = quantity (å…¨éƒ¨)
  â”œâ”€ realized_pnl = +360 USDT
  â”œâ”€ UPDATE status = 'closed'
  â””â”€ é‡Šæ”¾ä¿è¯é‡‘
  â†“
æ›´æ–°è´¦æˆ·ä½™é¢
  â””â”€ current_balance += 360
```

### ğŸ”§ close_position æ–¹æ³•

```python
def close_position(
    self,
    position_id: int,
    close_quantity: Optional[Decimal] = None,  # å·²åºŸå¼ƒï¼Œæ€»æ˜¯å…¨éƒ¨å¹³ä»“
    reason: str = 'manual',
    close_price: Optional[Decimal] = None
) -> Dict:
    """
    å¹³ä»“ï¼ˆå…¨éƒ¨å¹³ä»“ï¼‰

    æ–°é€»è¾‘ï¼š
    1. æ€»æ˜¯å…¨éƒ¨å¹³ä»“ï¼Œå¿½ç•¥ close_quantity å‚æ•°
    2. realized_pnl ç›´æ¥èµ‹å€¼ï¼Œä¸ç´¯åŠ 
    3. ä¸€æ¬¡æ€§æ›´æ–°è´¦æˆ·ä½™é¢
    """

    # 1. è·å–æŒä»“ä¿¡æ¯
    position = get_position(position_id)
    quantity = position['quantity']

    # 2. ğŸ”¥ æ€»æ˜¯å…¨éƒ¨å¹³ä»“
    close_quantity = quantity

    # 3. è®¡ç®—ç›ˆäº
    if position_side == 'LONG':
        pnl = (current_price - entry_price) * quantity
    else:  # SHORT
        pnl = (entry_price - current_price) * quantity

    realized_pnl = pnl - fee

    # 4. ğŸ”¥ æ›´æ–°æŒä»“ (realized_pnl ç›´æ¥èµ‹å€¼ï¼Œä¸ç´¯åŠ )
    UPDATE futures_positions
    SET status = 'closed',
        realized_pnl = realized_pnl  # ä¸æ˜¯ realized_pnl + realized_pnl
    WHERE id = position_id

    # 5. æ›´æ–°è´¦æˆ·ä½™é¢
    UPDATE futures_trading_accounts
    SET current_balance = initial_balance + (
        SELECT SUM(realized_pnl)
        FROM futures_positions
        WHERE status = 'closed'
    )
```

### ğŸš« ä¸å†æ”¯æŒçš„åŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½å·²è¢«ç§»é™¤ï¼š

1. âŒ **åˆ†æ‰¹å¹³ä»“**
   ```python
   # æ—§ä»£ç ï¼ˆå·²ç§»é™¤ï¼‰
   close_position(1001, close_quantity=15)  # å…ˆå¹³ä¸€åŠ
   close_position(1001, close_quantity=15)  # å†å¹³ä¸€åŠ
   ```

2. âŒ **realized_pnl ç´¯åŠ **
   ```python
   # æ—§ä»£ç ï¼ˆå·²ç§»é™¤ï¼‰
   realized_pnl = realized_pnl + pnl  # ç´¯åŠ 

   # æ–°ä»£ç 
   realized_pnl = pnl  # ç›´æ¥èµ‹å€¼
   ```

3. âŒ **éƒ¨åˆ†å¹³ä»“é€»è¾‘**
   ```python
   # æ—§ä»£ç ï¼ˆå·²ç§»é™¤ï¼‰
   if close_quantity == quantity:
       # å…¨éƒ¨å¹³ä»“
   else:
       # éƒ¨åˆ†å¹³ä»“
       remaining_quantity = quantity - close_quantity
   ```

---

## ç›ˆäºè®¡ç®—

### ğŸ’° å•ä¸ªæŒä»“ç›ˆäº

```python
# åšå¤šç›ˆäº
if position_side == 'LONG':
    pnl = (close_price - entry_price) * quantity - fee

# åšç©ºç›ˆäº
if position_side == 'SHORT':
    pnl = (entry_price - close_price) * quantity - fee
```

### ğŸ“ˆ ç¤ºä¾‹è®¡ç®—

**åœºæ™¯**: BTC/USDT åšå¤šï¼Œåˆ†3æ‰¹å»ºä»“

| æŒä»“ID | æ•°é‡ | å…¥åœºä»· | å¹³ä»“ä»· | ç›ˆäº | æ‰‹ç»­è´¹ | realized_pnl |
|--------|------|--------|--------|------|--------|--------------|
| 1001 | 0.012 | 100000 | 103000 | +36 | -4.8 | **+31.2** |
| 1002 | 0.009 | 99500 | 102000 | +22.5 | -3.6 | **+18.9** |
| 1003 | 0.009 | 99000 | 104000 | +45 | -3.9 | **+41.1** |

**æ€»ç›ˆäº**: 31.2 + 18.9 + 41.1 = **+91.2 USDT**

### ğŸ” è´¦æˆ·ä½™é¢æ›´æ–°

```sql
-- è‡ªåŠ¨é‡æ–°è®¡ç®—è´¦æˆ·ä½™é¢
UPDATE futures_trading_accounts
SET current_balance = initial_balance + (
    SELECT COALESCE(SUM(realized_pnl), 0)
    FROM futures_positions
    WHERE account_id = 1 AND status = 'closed'
)
WHERE id = 1;

-- ç»“æœ
-- initial_balance = 10000
-- SUM(realized_pnl) = 91.2
-- current_balance = 10091.2 âœ“
```

### âœ… ä¸ºä»€ä¹ˆä¸ä¼šé‡å¤æ‰£é™¤

1. **æ¯ä¸ªæŒä»“ç‹¬ç«‹**: Position 1001, 1002, 1003 æ˜¯ç‹¬ç«‹è®°å½•
2. **realized_pnl ä¸ç´¯åŠ **: æ¯ä¸ªæŒä»“çš„ realized_pnl æ˜¯ç‹¬ç«‹çš„å€¼
3. **ä¸€æ¬¡æ€§è®¡ç®—**: è´¦æˆ·ä½™é¢é€šè¿‡ SUM é‡æ–°è®¡ç®—ï¼Œä¸æ˜¯é€ä¸ªç´¯åŠ 

---

## æ•°æ®åº“è¡¨ç»“æ„

### futures_positions è¡¨

```sql
CREATE TABLE futures_positions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_id INT NOT NULL,
    symbol VARCHAR(20) NOT NULL,
    position_side VARCHAR(10) NOT NULL,  -- 'LONG' or 'SHORT'

    -- æŒä»“ä¿¡æ¯
    quantity DECIMAL(20, 8) NOT NULL,
    entry_price DECIMAL(20, 8) NOT NULL,
    margin DECIMAL(20, 8) NOT NULL,
    leverage INT DEFAULT 25,

    -- æ­¢ç›ˆæ­¢æŸ
    stop_loss_price DECIMAL(20, 8),
    take_profit_price DECIMAL(20, 8),
    stop_loss_pct DECIMAL(10, 2),
    take_profit_pct DECIMAL(10, 2),

    -- ç›ˆäº
    realized_pnl DECIMAL(20, 8) DEFAULT 0,  -- ğŸ”¥ ä¸å†ç´¯åŠ ï¼Œç›´æ¥èµ‹å€¼
    unrealized_pnl DECIMAL(20, 8) DEFAULT 0,

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'open',  -- 'open' or 'closed'
    source VARCHAR(50),  -- 'smart_trader_batch'

    -- æ—¶é—´
    open_time DATETIME,
    close_time DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_account_symbol_status (account_id, symbol, status),
    INDEX idx_status_close_time (status, close_time)
);
```

### æŒä»“çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | ä½•æ—¶ä½¿ç”¨ |
|------|------|----------|
| `open` | å·²å¼€ä»“ | æ¯æ‰¹å»ºä»“å®Œæˆåç«‹å³è®¾ç½® |
| `closed` | å·²å¹³ä»“ | å¹³ä»“å®Œæˆåè®¾ç½® |
| ~~`building`~~ | ~~å»ºä»“ä¸­~~ | **å·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨** |

---

## ä»£ç ç¤ºä¾‹

### ç¤ºä¾‹1: åˆ†æ‰¹å»ºä»“æµç¨‹

```python
# kline_pullback_entry_executor.py

async def execute_batch_entry(plan):
    """æ‰§è¡Œåˆ†æ‰¹å»ºä»“"""

    # æ£€æŸ¥æŒä»“æ•°é‡é™åˆ¶
    position_count = count_positions(symbol, direction)
    if position_count >= 3:
        logger.info(f"æŒä»“å·²è¾¾ä¸Šé™(3)")
        return

    # ç¬¬1æ‰¹: ç«‹å³å»ºä»“
    await _create_position_record(plan, price_1, batch_num=0)
    # â†’ Position 1001 created

    # ç­‰å¾…15Må›è°ƒ...
    if await _check_reverse_kline(symbol, direction, '15m', count=1):
        # ç¬¬2æ‰¹: å›è°ƒåå»ºä»“
        await _create_position_record(plan, price_2, batch_num=1)
        # â†’ Position 1002 created

    # ç­‰å¾…15Må›è°ƒ...
    if await _check_reverse_kline(symbol, direction, '15m', count=1):
        # ç¬¬3æ‰¹: å›è°ƒåå»ºä»“
        await _create_position_record(plan, price_3, batch_num=2)
        # â†’ Position 1003 created
```

### ç¤ºä¾‹2: æ¯æ‰¹åˆ›å»ºç‹¬ç«‹æŒä»“

```python
async def _create_position_record(plan, entry_price, batch_num=0):
    """åˆ›å»ºæŒä»“è®°å½•ï¼ˆæ¯æ‰¹éƒ½æ˜¯ç‹¬ç«‹æŒä»“ï¼‰"""

    current_batch = plan['batches'][batch_num]

    # ğŸ”¥ INSERT æ–°çš„ç‹¬ç«‹æŒä»“è®°å½•
    cursor.execute("""
        INSERT INTO futures_positions
        (account_id, symbol, position_side, quantity, entry_price,
         margin, leverage, status, source)
        VALUES (%s, %s, %s, %s, %s, %s, %s, 'open', 'smart_trader_batch')
    """, (
        account_id,
        plan['symbol'],
        plan['direction'],
        current_batch['quantity'],
        entry_price,
        current_batch['margin'],
        plan['leverage']
    ))

    position_id = cursor.lastrowid
    logger.info(f"âœ… ç¬¬{batch_num+1}æ‰¹å»ºä»“å®Œæˆ | ID:{position_id}")
```

### ç¤ºä¾‹3: å…¨éƒ¨å¹³ä»“

```python
def close_position(position_id, reason='take_profit'):
    """å¹³ä»“ï¼ˆæ€»æ˜¯å…¨éƒ¨å¹³ä»“ï¼‰"""

    # 1. è·å–æŒä»“
    position = get_position(position_id)
    quantity = position['quantity']
    entry_price = position['entry_price']

    # 2. ğŸ”¥ æ€»æ˜¯å…¨éƒ¨å¹³ä»“
    close_quantity = quantity  # å¿½ç•¥å¤–éƒ¨ä¼ å…¥çš„ close_quantity

    # 3. è·å–å½“å‰ä»·æ ¼
    current_price = get_current_price(symbol)

    # 4. è®¡ç®—ç›ˆäº
    if position_side == 'LONG':
        pnl = (current_price - entry_price) * quantity
    else:
        pnl = (entry_price - current_price) * quantity

    fee = current_price * quantity * 0.0004
    realized_pnl = pnl - fee

    # 5. ğŸ”¥ æ›´æ–°æŒä»“ï¼ˆrealized_pnl ç›´æ¥èµ‹å€¼ï¼‰
    cursor.execute("""
        UPDATE futures_positions
        SET status = 'closed',
            close_time = NOW(),
            realized_pnl = %s,  -- ä¸æ˜¯ realized_pnl + %s
            notes = %s
        WHERE id = %s
    """, (realized_pnl, reason, position_id))

    # 6. é‡Šæ”¾ä¿è¯é‡‘
    cursor.execute("""
        UPDATE futures_trading_accounts
        SET frozen_balance = frozen_balance - %s
        WHERE id = %s
    """, (margin, account_id))

    # 7. é‡æ–°è®¡ç®—è´¦æˆ·ä½™é¢
    cursor.execute("""
        UPDATE futures_trading_accounts a
        SET a.current_balance = a.initial_balance + (
            SELECT COALESCE(SUM(p.realized_pnl), 0)
            FROM futures_positions p
            WHERE p.account_id = a.id AND p.status = 'closed'
        )
        WHERE a.id = %s
    """, (account_id,))

    logger.info(f"âœ… å¹³ä»“å®Œæˆ | ç›ˆäº: {realized_pnl:.2f} USDT")
```

### ç¤ºä¾‹4: æŒä»“æ•°é‡æ£€æŸ¥

```python
# smart_trader_service.py

def check_before_open(symbol, direction):
    """å¼€ä»“å‰æ£€æŸ¥"""

    # æ£€æŸ¥æŒä»“æ•°é‡
    position_count = self.count_positions(symbol, direction)
    if position_count >= 3:
        logger.info(f"[SKIP] {symbol} {direction}æ–¹å‘å·²æœ‰{position_count}ä¸ªæŒä»“ï¼Œè¾¾åˆ°ä¸Šé™(3)")
        return False

    # æ£€æŸ¥å†·å´æœŸ
    if self.check_recent_close(symbol, direction, cooldown_minutes=15):
        logger.info(f"[SKIP] {symbol} å†·å´ä¸­")
        return False

    # æ£€æŸ¥åå‘æŒä»“
    opposite_side = 'SHORT' if direction == 'LONG' else 'LONG'
    if self.has_position(symbol, opposite_side):
        logger.info(f"[SKIP] {symbol} å·²æœ‰åå‘æŒä»“")
        return False

    return True

def count_positions(symbol, direction):
    """ç»Ÿè®¡æŒä»“æ•°é‡"""
    cursor.execute("""
        SELECT COUNT(*)
        FROM futures_positions
        WHERE symbol = %s
          AND position_side = %s
          AND status IN ('open')
          AND account_id = %s
    """, (symbol, direction, self.account_id))

    result = cursor.fetchone()
    return result[0] if result else 0
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸å†æ”¯æŒåˆ†æ‰¹å¹³ä»“ï¼Ÿ

**A**: å› ä¸ºæ¯ä¸ªæŒä»“éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯æ‰¹å»ºä»“éƒ½åˆ›å»ºäº†ç‹¬ç«‹çš„æŒä»“è®°å½•ã€‚å¹³ä»“æ—¶ï¼Œæ¯ä¸ªæŒä»“æ ¹æ®è‡ªå·±çš„ç›ˆäºæƒ…å†µç‹¬ç«‹å¹³ä»“ï¼Œä¸éœ€è¦åœ¨å•ä¸ªæŒä»“å†…åˆ†æ‰¹å¹³ä»“ã€‚

**ç¤ºä¾‹**:
```
æ—§æ–¹æ¡ˆï¼ˆåˆ†æ‰¹å¹³ä»“ï¼‰:
  Position 1001 (100ä¸ªå¸)
    â†’ å…ˆå¹³50ä¸ª â†’ realized_pnl += pnl1
    â†’ å†å¹³50ä¸ª â†’ realized_pnl += pnl2
    âŒ å®¹æ˜“å‡ºé”™ï¼šç´¯åŠ é€»è¾‘å¤æ‚

æ–°æ–¹æ¡ˆï¼ˆç‹¬ç«‹æŒä»“ï¼‰:
  Position 1001 (30ä¸ªå¸) â†’ å…¨éƒ¨å¹³ä»“ â†’ realized_pnl = pnl1 âœ“
  Position 1002 (30ä¸ªå¸) â†’ å…¨éƒ¨å¹³ä»“ â†’ realized_pnl = pnl2 âœ“
  Position 1003 (40ä¸ªå¸) â†’ å…¨éƒ¨å¹³ä»“ â†’ realized_pnl = pnl3 âœ“
  âœ… ç®€å•æ¸…æ™°ï¼šæ¯ä¸ªæŒä»“ç‹¬ç«‹
```

### Q2: realized_pnl ä¸ºä»€ä¹ˆä¸å†ç´¯åŠ ï¼Ÿ

**A**: å› ä¸ºæ¯ä¸ªæŒä»“åªå¹³ä»“ä¸€æ¬¡ï¼ˆå…¨éƒ¨å¹³ä»“ï¼‰ï¼Œrealized_pnl æ˜¯è¯¥æŒä»“å”¯ä¸€çš„ç›ˆäºå€¼ï¼Œä¸éœ€è¦ç´¯åŠ ã€‚

```python
# æ—§ä»£ç ï¼ˆç´¯åŠ ï¼Œç”¨äºåˆ†æ‰¹å¹³ä»“ï¼‰
realized_pnl = realized_pnl + pnl  # å¤šæ¬¡ç´¯åŠ 

# æ–°ä»£ç ï¼ˆç›´æ¥èµ‹å€¼ï¼Œç”¨äºå…¨éƒ¨å¹³ä»“ï¼‰
realized_pnl = pnl  # åªèµ‹å€¼ä¸€æ¬¡
```

### Q3: å¦‚ä½•æŸ¥çœ‹æŸä¸ªå¸ç§çš„æ‰€æœ‰æŒä»“ï¼Ÿ

**A**: æŸ¥è¯¢ futures_positions è¡¨ï¼š

```sql
SELECT
    id,
    position_side,
    quantity,
    entry_price,
    realized_pnl,
    status,
    open_time,
    close_time
FROM futures_positions
WHERE symbol = 'BTC/USDT'
  AND account_id = 1
ORDER BY open_time DESC;
```

### Q4: å¦‚ä½•ç»Ÿè®¡æ€»ç›ˆäºï¼Ÿ

**A**: ä½¿ç”¨ SUM èšåˆï¼š

```sql
SELECT
    COALESCE(SUM(realized_pnl), 0) as total_pnl
FROM futures_positions
WHERE account_id = 1
  AND status = 'closed';
```

### Q5: å¦‚ä½•éªŒè¯ç›ˆäºè®¡ç®—æ˜¯å¦æ­£ç¡®ï¼Ÿ

**A**: è¿è¡Œæ£€æŸ¥è„šæœ¬ï¼š

```bash
python check_pnl_issue.py <position_id>
```

è„šæœ¬ä¼šéªŒè¯ï¼š
- âœ… positions è¡¨çš„ realized_pnl
- âœ… orders è¡¨çš„æ€»ç›ˆäº
- âœ… trades è¡¨çš„æ€»ç›ˆäº
- âœ… ä¸‰ä¸ªæ¥æºæ˜¯å¦ä¸€è‡´

### Q6: ä¸ºä»€ä¹ˆé™åˆ¶æœ€å¤š3ä¸ªåŒæ–¹å‘æŒä»“ï¼Ÿ

**A**: é£æ§è€ƒè™‘ï¼š

1. **ä¿è¯é‡‘å ç”¨**: é¿å…è¿‡åº¦å ç”¨ä¿è¯é‡‘
2. **é£é™©åˆ†æ•£**: æ¯æ‰¹å»ºä»“çš„æˆæœ¬ä¸åŒï¼Œé™ä½é£é™©
3. **ç®¡ç†å¤æ‚åº¦**: å¤ªå¤šæŒä»“éš¾ä»¥ç®¡ç†

å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ä¸Šé™ï¼š

```python
# ä¿®æ”¹ä¸Šé™
MAX_POSITIONS_PER_SIDE = 5  # æ”¹ä¸º5ä¸ª

if position_count >= MAX_POSITIONS_PER_SIDE:
    return False
```

### Q7: å¦‚æœæŸä¸€æ‰¹å»ºä»“å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A**: ä¸å½±å“å…¶ä»–æ‰¹æ¬¡ï¼š

```
ç¬¬1æ‰¹: æˆåŠŸ â†’ Position 1001 âœ“
ç¬¬2æ‰¹: å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰â†’ è·³è¿‡ âŒ
ç¬¬3æ‰¹: æˆåŠŸ â†’ Position 1002 âœ“

ç»“æœ: åªæœ‰2ä¸ªæŒä»“ï¼Œä½†ä¸å½±å“äº¤æ˜“
```

### Q8: å¹³ä»“æ—¶å¦‚ä½•é€‰æ‹©å…ˆå¹³å“ªä¸ªæŒä»“ï¼Ÿ

**A**: æ¯ä¸ªæŒä»“ç‹¬ç«‹åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶å°±å¹³ï¼š

```python
# ç›‘æ§æ‰€æœ‰æŒä»“
for position in get_open_positions(symbol, direction):
    profit_pct = calculate_profit_pct(position)

    if profit_pct >= take_profit_pct:
        close_position(position['id'], reason='take_profit')
    elif profit_pct <= stop_loss_pct:
        close_position(position['id'], reason='stop_loss')
```

é€šå¸¸ï¼š
- ç›ˆåˆ©æœ€å¤šçš„å…ˆæ­¢ç›ˆ
- äºæŸæœ€å¤šçš„å…ˆæ­¢æŸ

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ä»£ç ç®€åŒ–å¯¹æ¯”

| é¡¹ç›® | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ | æ”¹è¿› |
|------|--------|--------|------|
| close_position æ–¹æ³• | ~80 è¡Œ | ~40 è¡Œ | **-50%** |
| åˆ†æ”¯åˆ¤æ–­ | if-else 2ä¸ªåˆ†æ”¯ | æ— åˆ†æ”¯ | **ç®€åŒ–** |
| SQL UPDATE | 2-3æ¬¡ | 1æ¬¡ | **-66%** |
| realized_pnl é€»è¾‘ | ç´¯åŠ ï¼ˆå¤æ‚ï¼‰ | ç›´æ¥èµ‹å€¼ | **ç®€åŒ–** |

### æ€§èƒ½æå‡

1. **å‡å°‘æ•°æ®åº“æ“ä½œ**: å°‘äº† 1-2 æ¬¡ UPDATE
2. **å‡å°‘è®¡ç®—**: ä¸éœ€è¦è®¡ç®— remaining_quantityã€remaining_margin
3. **å‡å°‘åˆ†æ”¯**: ç§»é™¤ if-elseï¼Œä»£ç æ‰§è¡Œè·¯å¾„å•ä¸€
4. **å‡å°‘é”™è¯¯**: é€»è¾‘ç®€å•ï¼Œä¸æ˜“å‡ºé”™

---

## ğŸ¯ æ€»ç»“

### âœ… æ ¸å¿ƒä¼˜åŠ¿

1. **é€»è¾‘æ¸…æ™°**: æ¯æ‰¹å»ºä»“ = ç‹¬ç«‹æŒä»“ï¼Œæ¯ä¸ªæŒä»“ = å…¨éƒ¨å¹³ä»“
2. **ç›ˆäºå‡†ç¡®**: realized_pnl ç›´æ¥èµ‹å€¼ï¼Œä¸ä¼šé‡å¤æ‰£é™¤
3. **ä»£ç ç®€æ´**: å‡å°‘ 157 è¡Œä»£ç ï¼Œå‡å°‘ 50% å¤æ‚åº¦
4. **æ˜“äºç»´æŠ¤**: é€»è¾‘ç®€å•ï¼Œæ–°äººå®¹æ˜“ç†è§£
5. **é£æ§å®Œå–„**: é™åˆ¶æŒä»“æ•°é‡ï¼Œé˜²æ­¢è¿‡åº¦å¼€ä»“

### ğŸš€ é€‚ç”¨åœºæ™¯

- âœ… åˆ†æ‰¹å»ºä»“ç­–ç•¥ï¼ˆKçº¿å›è°ƒå»ºä»“ï¼‰
- âœ… åŠ¨æ€æ­¢ç›ˆæ­¢æŸ
- âœ… å¤šä¸ªç‹¬ç«‹æŒä»“ç®¡ç†
- âœ… æ ¹æ®ç›ˆäºæ¯”ä¾‹çµæ´»å¹³ä»“

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **æŒä»“æ•°é‡é™åˆ¶**: é»˜è®¤æœ€å¤š3ä¸ªï¼Œå¯æ ¹æ®éœ€è¦è°ƒæ•´
2. **å†·å´æœŸ**: å¹³ä»“å15åˆ†é’Ÿå†…ä¸å†å¼€ä»“ï¼ˆå¯é…ç½®ï¼‰
3. **åå‘æŒä»“**: ä¸åšå¯¹å†²ï¼Œæœ‰åå‘æŒä»“æ—¶è·³è¿‡
4. **ä¿è¯é‡‘å ç”¨**: æ³¨æ„æ€»ä¿è¯é‡‘å ç”¨ä¸è¶…è¿‡è´¦æˆ·ä½™é¢

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ“ä½œè¯´æ˜.ini](../æ“ä½œè¯´æ˜.ini) - ç³»ç»Ÿæ•´ä½“è¯´æ˜
- [table_schemas.txt](../table_schemas.txt) - æ•°æ®åº“è¡¨ç»“æ„
- [check_pnl_issue.py](../check_pnl_issue.py) - ç›ˆäºéªŒè¯è„šæœ¬

---

**æ–‡æ¡£ç‰ˆæœ¬**: V2.0
**æœ€åæ›´æ–°**: 2026-02-21
**ç»´æŠ¤è€…**: System Architecture Team
