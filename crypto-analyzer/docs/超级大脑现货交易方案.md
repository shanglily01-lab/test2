# è¶…çº§å¤§è„‘ - ç°è´§äº¤æ˜“æ–¹æ¡ˆ

> **æœ€åæ›´æ–°**: 2026-01-29
> **ç³»ç»Ÿç‰ˆæœ¬**: V2.0 - åŠ¨æ€ä»·æ ¼é‡‡æ ·ç³»ç»Ÿ
> **æ ¸å¿ƒç‰¹æ€§**: 8å°æ—¶å‘¨æœŸ + åŠ¨æ€é‡‡æ · + åˆ†æ‰¹å»ºä»“ + è®©åˆ©æ¶¦å¥”è·‘

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ç­–ç•¥åŸç†](#ç­–ç•¥åŸç†)
3. [äº¤æ˜“æµç¨‹](#äº¤æ˜“æµç¨‹)
4. [é£é™©æ§åˆ¶](#é£é™©æ§åˆ¶)
5. [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
6. [è¿ç»´ç®¡ç†](#è¿ç»´ç®¡ç†)

---

## ç³»ç»Ÿæ¦‚è¿°

### å®šä½

**è¶…çº§å¤§è„‘ç°è´§äº¤æ˜“ç³»ç»ŸV2** æ˜¯åŸºäºåŠ¨æ€ä»·æ ¼é‡‡æ ·çš„çŸ­çº¿ç°è´§äº¤æ˜“ç­–ç•¥ï¼Œé€šè¿‡8å°æ—¶å®Œæ•´å‘¨æœŸã€5æ‰¹æ¬¡å»ºä»“å’Œæ™ºèƒ½ä»·æ ¼ä¼˜åŒ–ï¼Œå®ç°ç¨³å®šç›ˆåˆ©ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- â±ï¸ **8å°æ—¶å‘¨æœŸ**: 1Hé‡‡æ · + 2Hå»ºä»“ + 4HæŒæœ‰ + 1Hé€€å‡ºé‡‡æ ·
- ğŸ“Š **åŠ¨æ€ä»·æ ¼é‡‡æ ·**: æ”¶é›†100+ä»·æ ¼æ ·æœ¬ï¼Œ20%åˆ†ä½å…¥åœºï¼Œ80%åˆ†ä½å‡ºåœº
- ğŸ’° **åˆ†æ‰¹å»ºä»“**: 5æ‰¹æ¬¡é€æ­¥å»ºç«‹ä»“ä½ (15%-20%-20%-20%-25%)
- ğŸ¯ **è®©åˆ©æ¶¦å¥”è·‘**: æŒæœ‰æœŸä¸å¹²é¢„ï¼Œåªç›‘æ§æ­¢ç›ˆæ­¢æŸ
- ğŸ›¡ï¸ **ä¸¥æ ¼é£æ§**: 5%æ­¢æŸï¼Œ15%æ­¢ç›ˆ

### é€‚ç”¨åœºæ™¯

- âœ… çŸ­çº¿æ³¢æ®µäº¤æ˜“ (8å°æ—¶å‘¨æœŸ)
- âœ… ç°è´§åŒå‘äº¤æ˜“ (åšå¤šä¸ºä¸»)
- âœ… ä¸­ç­‰èµ„é‡‘é‡ (2000 USDT/ä»“ä½)
- âœ… æ•æ‰çŸ­æœŸè¶‹åŠ¿

---

## ç­–ç•¥åŸç†

### æ ¸å¿ƒç†å¿µ

1. **ä»·æ ¼ä¼˜åŒ–ç†å¿µ**
   - å»ºä»“æ—¶å¯»æ‰¾ä½ä»· (20%åˆ†ä½)
   - é€€å‡ºæ—¶å¯»æ‰¾é«˜ä»· (80%åˆ†ä½)
   - é€šè¿‡ä»·æ ¼é‡‡æ ·ä¼˜åŒ–æˆæœ¬

2. **æ—¶é—´å‘¨æœŸç®¡ç†**
   ```
   æ€»å‘¨æœŸ: 8å°æ—¶
   â”œâ”€ é‡‡æ ·æœŸ (1å°æ—¶): æ”¶é›†ä»·æ ¼åŸºçº¿
   â”œâ”€ å»ºä»“æœŸ (2å°æ—¶): æ‰§è¡Œ5æ‰¹å»ºä»“
   â”œâ”€ æŒæœ‰æœŸ (4å°æ—¶): è®©åˆ©æ¶¦å¥”è·‘
   â””â”€ é€€å‡ºé‡‡æ · (1å°æ—¶): å¯»æ‰¾æœ€ä¼˜é€€å‡ºä»·æ ¼
   ```

3. **åˆ†æ‰¹å»ºä»“åŸç†**
   - é¿å…ä¸€æ¬¡æ€§è¿½é«˜/æ€è·Œ
   - å¹³æ»‘å…¥åœºæˆæœ¬
   - é™ä½å¸‚åœºæ³¢åŠ¨å½±å“

### ä»·æ ¼é‡‡æ ·æœºåˆ¶

**é‡‡æ ·ç­–ç•¥**:
```python
price_sampler = {
    'sampling_interval': 30,        # æ¯30ç§’é‡‡æ ·ä¸€æ¬¡
    'samples_per_hour': 120,        # æ¯å°æ—¶120ä¸ªæ ·æœ¬
    'entry_percentile': 20,         # å…¥åœºä½¿ç”¨20%åˆ†ä½ä»·æ ¼
    'exit_percentile': 80,          # é€€å‡ºä½¿ç”¨80%åˆ†ä½ä»·æ ¼
    'rolling_window': 100           # æ»šåŠ¨çª—å£100ä¸ªæ ·æœ¬
}
```

**åˆ†ä½æ•°è®¡ç®—**:
```python
def get_optimal_entry_price(samples):
    """è·å–æœ€ä¼˜å…¥åœºä»·æ ¼ (ä½ç‚¹)"""
    return np.percentile(samples, 20)  # 20%åˆ†ä½

def get_optimal_exit_price(samples):
    """è·å–æœ€ä¼˜é€€å‡ºä»·æ ¼ (é«˜ç‚¹)"""
    return np.percentile(samples, 80)  # 80%åˆ†ä½
```

**ä¼˜åŠ¿**:
- é¿å…è¿½æ¶¨æ€è·Œ
- é™ä½å¸‚åœºå™ªéŸ³å½±å“
- æé«˜å…¥åœºè´¨é‡

---

## äº¤æ˜“æµç¨‹

### å®Œæ•´äº¤æ˜“å‘¨æœŸ

```
é˜¶æ®µ1: ä¿¡å·äº§ç”Ÿ
   â”œâ”€ 24Hæ¶¨å¹… > 3%
   â”œâ”€ æˆäº¤é‡ > 500ä¸‡USDT
   â”œâ”€ è¶‹åŠ¿: STRONG_UP æˆ– UP
   â””â”€ ä¿¡å·å¼ºåº¦ â‰¥ 40åˆ†

é˜¶æ®µ2: é‡‡æ ·æœŸ (1å°æ—¶)
   â”œâ”€ åˆ›å»ºæŒä»“è®°å½• (phase='sampling')
   â”œâ”€ å¼€å§‹ä»·æ ¼é‡‡æ · (æ¯30ç§’)
   â”œâ”€ æ”¶é›†100+ä»·æ ¼æ ·æœ¬
   â””â”€ è®¡ç®—20%åˆ†ä½å…¥åœºä»·æ ¼

é˜¶æ®µ3: å»ºä»“æœŸ (2å°æ—¶)
   â”œâ”€ phase='building'
   â”œâ”€ Batch 1 (15%): ç¬¬0-24åˆ†é’Ÿ
   â”‚  â””â”€ å½“ä»·æ ¼ â‰¤ 20%åˆ†ä½æ—¶æ‰§è¡Œ
   â”œâ”€ Batch 2 (20%): ç¬¬24-48åˆ†é’Ÿ
   â”‚  â””â”€ å½“ä»·æ ¼ â‰¤ 20%åˆ†ä½æ—¶æ‰§è¡Œ
   â”œâ”€ Batch 3 (20%): ç¬¬48-72åˆ†é’Ÿ
   â”‚  â””â”€ å½“ä»·æ ¼ â‰¤ 20%åˆ†ä½æ—¶æ‰§è¡Œ
   â”œâ”€ Batch 4 (20%): ç¬¬72-96åˆ†é’Ÿ
   â”‚  â””â”€ å½“ä»·æ ¼ â‰¤ 20%åˆ†ä½æ—¶æ‰§è¡Œ
   â””â”€ Batch 5 (25%): ç¬¬96-120åˆ†é’Ÿ
      â””â”€ å½“ä»·æ ¼ â‰¤ 20%åˆ†ä½æ—¶æ‰§è¡Œ

é˜¶æ®µ4: æŒæœ‰æœŸ (4å°æ—¶)
   â”œâ”€ phase='holding'
   â”œâ”€ ä¸ä¸»åŠ¨å¹²é¢„
   â”œâ”€ åªç›‘æ§æ­¢ç›ˆæ­¢æŸ:
   â”‚  â€¢ æ­¢ç›ˆ: +15%
   â”‚  â€¢ æ­¢æŸ: -5%
   â””â”€ è®©åˆ©æ¶¦å¥”è·‘

é˜¶æ®µ5: é€€å‡ºé‡‡æ ·æœŸ (1å°æ—¶)
   â”œâ”€ phase='exit_sampling'
   â”œâ”€ å¼€å§‹æ”¶é›†é€€å‡ºä»·æ ¼æ ·æœ¬
   â”œâ”€ è®¡ç®—80%åˆ†ä½é€€å‡ºä»·æ ¼
   â””â”€ å‡†å¤‡é€€å‡º

é˜¶æ®µ6: é€€å‡ºæ‰§è¡Œ
   â”œâ”€ phase='exit_ready'
   â”œâ”€ å½“ä»·æ ¼ â‰¥ 80%åˆ†ä½æ—¶æ‰§è¡Œé€€å‡º
   â””â”€ è®°å½•P&Lï¼Œå…³é—­æŒä»“
```

### å…¥åœºä¿¡å·ç­›é€‰

**åŸºç¡€æ¡ä»¶**:
```yaml
market_filters:
  price_change_24h: ">= 3%"     # 24Hæ¶¨å¹…
  quote_volume: ">= 5000000"    # æˆäº¤é‡(USDT)
  min_price: ">= 0.0001"        # æœ€ä½ä»·æ ¼
  max_price: "<= 100000"        # æœ€é«˜ä»·æ ¼
```

**è¶‹åŠ¿åˆ¤æ–­**:
```python
trend_levels = {
    'STRONG_UP': 'å¼ºçƒˆä¸Šæ¶¨',     # å¤šå‘¨æœŸå…±æŒ¯å‘ä¸Š
    'UP': 'ä¸Šæ¶¨',               # ä¸»è¦å‘¨æœŸå‘ä¸Š
    'NEUTRAL': 'ä¸­æ€§',          # æ— æ˜æ˜¾è¶‹åŠ¿
    'DOWN': 'ä¸‹è·Œ',             # ä¸»è¦å‘¨æœŸå‘ä¸‹
    'STRONG_DOWN': 'å¼ºçƒˆä¸‹è·Œ'   # å¤šå‘¨æœŸå…±æŒ¯å‘ä¸‹
}

# å…¥åœºæ¡ä»¶
if trend in ['STRONG_UP', 'UP'] and signal_strength >= 40:
    create_position()
```

**ä¿¡å·å¼ºåº¦è¯„åˆ†** (0-100åˆ†):
```python
def calculate_signal_strength(symbol):
    """è®¡ç®—ä¿¡å·å¼ºåº¦"""
    score = 0

    # RSI (20åˆ†)
    if 30 <= rsi <= 70:
        score += 20

    # MACD (20åˆ†)
    if macd_trend == 'bullish':
        score += 20

    # æˆäº¤é‡ (20åˆ†)
    if volume > avg_volume * 1.5:
        score += 20

    # ä»·æ ¼è¶‹åŠ¿ (20åˆ†)
    if price_trend == 'uptrend':
        score += 20

    # å¸ƒæ—å¸¦ (20åˆ†)
    if price_position == 'middle':
        score += 20

    return score
```

### åˆ†æ‰¹å»ºä»“è¯¦è§£

**æ‰¹æ¬¡æ¯”ä¾‹**:
```python
batch_ratios = [0.15, 0.20, 0.20, 0.20, 0.25]
total_capital_per_position = 2000  # USDT

batch_amounts = [
    2000 * 0.15 = 300 USDT,  # Batch 1
    2000 * 0.20 = 400 USDT,  # Batch 2
    2000 * 0.20 = 400 USDT,  # Batch 3
    2000 * 0.20 = 400 USDT,  # Batch 4
    2000 * 0.25 = 500 USDT   # Batch 5
]
```

**æ‰§è¡Œé€»è¾‘**:
```python
def execute_batch_entry(position, batch_num):
    """æ‰§è¡Œæ‰¹æ¬¡å»ºä»“"""
    # 1. è·å–ç›®æ ‡å…¥åœºä»·æ ¼
    target_price = get_entry_price_20th_percentile()

    # 2. ç­‰å¾…ä»·æ ¼è¾¾åˆ°ç›®æ ‡
    current_price = get_current_price()
    if current_price <= target_price:
        # 3. æ‰§è¡Œä¹°å…¥
        execute_market_buy(
            symbol=position.symbol,
            amount=batch_amounts[batch_num],
            reason=f"ä»·æ ¼è¾¾åˆ°20%åˆ†ä½({target_price})"
        )

        # 4. æ›´æ–°æŒä»“
        update_position_batch(position, batch_num)
    else:
        # ä»·æ ¼æœªè¾¾åˆ°ï¼Œç»§ç»­ç­‰å¾…
        wait_for_better_price()
```

**è¶…æ—¶å¤„ç†**:
```python
def handle_batch_timeout(position, batch_num):
    """æ‰¹æ¬¡è¶…æ—¶å¤„ç†"""
    elapsed_time = get_elapsed_time(batch_num)

    if elapsed_time >= batch_window_minutes:
        # è¶…æ—¶ä»æœªæˆäº¤ï¼Œä½¿ç”¨å½“å‰ä»·æ ¼å…¥åœº
        execute_market_buy(
            symbol=position.symbol,
            amount=batch_amounts[batch_num],
            reason="æ‰¹æ¬¡è¶…æ—¶ï¼Œå½“å‰ä»·æ ¼å…¥åœº"
        )
```

### é€€å‡ºç­–ç•¥

**æ­£å¸¸é€€å‡º** (é€€å‡ºé‡‡æ ·é˜¶æ®µ):
```python
def exit_position(position):
    """é€€å‡ºæŒä»“"""
    # 1. é€€å‡ºé‡‡æ ·æœŸæ”¶é›†ä»·æ ¼æ ·æœ¬
    exit_samples = collect_exit_price_samples(duration=60)  # 1å°æ—¶

    # 2. è®¡ç®—ç›®æ ‡é€€å‡ºä»·æ ¼ (80%åˆ†ä½)
    target_exit_price = np.percentile(exit_samples, 80)

    # 3. ç­‰å¾…ä»·æ ¼è¾¾åˆ°ç›®æ ‡
    current_price = get_current_price()
    if current_price >= target_exit_price:
        # ä»·æ ¼è¾¾åˆ°80%åˆ†ä½ï¼Œæ‰§è¡Œé€€å‡º
        execute_market_sell(
            symbol=position.symbol,
            quantity=position.total_quantity,
            reason=f"ä»·æ ¼è¾¾åˆ°80%åˆ†ä½({target_exit_price})"
        )
```

**æ­¢ç›ˆé€€å‡º** (+15%):
```python
if unrealized_pnl_pct >= 15%:
    execute_market_sell(reason='take_profit_15pct')
```

**æ­¢æŸé€€å‡º** (-5%):
```python
if unrealized_pnl_pct <= -5%:
    execute_market_sell(reason='stop_loss_5pct')
```

---

## é£é™©æ§åˆ¶

### ä»“ä½ç®¡ç†

**å•ä»“ä½é…ç½®**:
```yaml
position_config:
  capital_per_position: 2000 USDT    # å•ä»“ä½èµ„é‡‘
  max_concurrent_positions: 15       # æœ€å¤§å¹¶å‘ä»“ä½
  total_capital_required: 30000 USDT # æ€»èµ„é‡‘éœ€æ±‚
```

**ä»“ä½åˆ†é…**:
```python
# 5æ‰¹æ¬¡ä»“ä½åˆ†é…
positions = {
    'batch_1': 300,   # 15%
    'batch_2': 400,   # 20%
    'batch_3': 400,   # 20%
    'batch_4': 400,   # 20%
    'batch_5': 500    # 25%
}

# é€æ‰¹å»ºç«‹ï¼Œé¿å…ä¸€æ¬¡æ€§æŠ•å…¥
```

### æ­¢æŸæ­¢ç›ˆ

**å›ºå®šæ­¢æŸ** (5%):
```python
stop_loss_config = {
    'threshold': -0.05,          # -5%
    'execution': 'market_order',  # å¸‚ä»·å•
    'priority': 'highest'         # æœ€é«˜ä¼˜å…ˆçº§
}
```

**å›ºå®šæ­¢ç›ˆ** (15%):
```python
take_profit_config = {
    'threshold': 0.15,            # +15%
    'execution': 'market_order',
    'priority': 'high'
}
```

**ç›ˆäºæ¯”**: 1:3 (æ­¢æŸ5% vs æ­¢ç›ˆ15%)

### é£é™©ç›‘æ§

**å®æ—¶ç›‘æ§æŒ‡æ ‡**:
```python
risk_metrics = {
    'total_positions': count_active_positions(),
    'total_capital_used': sum(position.capital),
    'avg_unrealized_pnl_pct': calculate_avg_pnl(),
    'worst_position': find_worst_position(),
    'capital_utilization': used_capital / total_capital
}
```

**å‘Šè­¦é˜ˆå€¼**:
```yaml
alerts:
  max_loss_per_position: -100 USDT    # å•ä»“ä½æœ€å¤§äºæŸ
  max_daily_loss: -500 USDT           # æ—¥æœ€å¤§äºæŸ
  max_concurrent_losses: 5            # æœ€å¤§å¹¶å‘äºæŸä»“ä½
```

---

## æ€§èƒ½æŒ‡æ ‡

### å…³é”®ç»©æ•ˆæŒ‡æ ‡ (KPI)

**ç›ˆåˆ©æŒ‡æ ‡**:
- **æ€»ç›ˆäº** (Total P&L): æ‰€æœ‰å·²å¹³ä»“ä½ç›ˆäºæ€»å’Œ
- **èƒœç‡** (Win Rate): ç›ˆåˆ©äº¤æ˜“æ•° / æ€»äº¤æ˜“æ•°
- **å¹³å‡ç›ˆåˆ©** (Avg Profit): æ€»ç›ˆåˆ© / ç›ˆåˆ©äº¤æ˜“æ•°
- **å¹³å‡äºæŸ** (Avg Loss): æ€»äºæŸ / äºæŸäº¤æ˜“æ•°
- **ç›ˆäºæ¯”** (Profit/Loss Ratio): å¹³å‡ç›ˆåˆ© / å¹³å‡äºæŸ

**æ—¶é—´æŒ‡æ ‡**:
- **å¹³å‡å‘¨æœŸ**: å®é™…äº¤æ˜“å‘¨æœŸ vs ç›®æ ‡8å°æ—¶
- **å»ºä»“æ•ˆç‡**: å¹³å‡å»ºä»“å®Œæˆæ—¶é—´
- **é€€å‡ºæ•ˆç‡**: ä»é€€å‡ºé‡‡æ ·åˆ°å®é™…é€€å‡ºçš„æ—¶é—´

**ä»·æ ¼ä¼˜åŒ–æŒ‡æ ‡**:
- **å…¥åœºä»·æ ¼è´¨é‡**: å®é™…å…¥åœºä»· vs 20%åˆ†ä½ä»·æ ¼
- **é€€å‡ºä»·æ ¼è´¨é‡**: å®é™…é€€å‡ºä»· vs 80%åˆ†ä½ä»·æ ¼
- **ä»·æ ¼ä¼˜åŒ–æ”¶ç›Š**: é€šè¿‡ä»·æ ¼é‡‡æ ·èŠ‚çœçš„æˆæœ¬

### ç›®æ ‡å€¼

```yaml
target_metrics:
  win_rate: ">= 60%"              # èƒœç‡ç›®æ ‡
  avg_profit: ">= 200 USDT"       # å¹³å‡ç›ˆåˆ©
  avg_loss: "<= 80 USDT"          # å¹³å‡äºæŸ
  profit_loss_ratio: ">= 2.5"     # ç›ˆäºæ¯”ç›®æ ‡
  avg_cycle_hours: "7-9 hours"    # å¹³å‡å‘¨æœŸ
```

### ç›‘æ§çœ‹æ¿

**å®æ—¶æ•°æ®**:
```
å½“å‰æŒä»“æ•°: 12/15
æ€»æœªå®ç°ç›ˆäº: +$345.67
ä»Šæ—¥å·²å¹³ä»“ç›ˆäº: +$123.45
èµ„é‡‘åˆ©ç”¨ç‡: 80%

å„é˜¶æ®µæŒä»“åˆ†å¸ƒ:
- sampling: 2ä¸ª
- building: 3ä¸ª
- holding: 5ä¸ª
- exit_sampling: 2ä¸ª
```

**24å°æ—¶ç»Ÿè®¡**:
```
æ€»äº¤æ˜“æ•°: 15ç¬”
ç›ˆåˆ©: 10ç¬” (66.7%)
äºæŸ: 5ç¬” (33.3%)
æ€»ç›ˆäº: +$456.78
å¹³å‡ç›ˆåˆ©: $82.34
å¹³å‡äºæŸ: -$45.67
ç›ˆäºæ¯”: 1.80:1
```

---

## è¿ç»´ç®¡ç†

### å¯åŠ¨æœåŠ¡

**ç›´æ¥è¿è¡Œ**:
```bash
python app/main.py
```

**åå°è¿è¡Œ**:
```bash
nohup python app/main.py > logs/spot_trader_v2.log 2>&1 &
```

**systemdæœåŠ¡**:
```bash
sudo systemctl start spot-trader-v2
sudo systemctl enable spot-trader-v2  # å¼€æœºè‡ªå¯
```

### æ—¥å¿—ç›‘æ§

**å…³é”®æ—¥å¿—æ ‡ç­¾**:
```
[SAMPLING]      - ä»·æ ¼é‡‡æ ·é˜¶æ®µ
[BUILDING]      - å»ºä»“æ‰§è¡Œé˜¶æ®µ
[HOLDING]       - æŒæœ‰æœŸç›‘æ§
[EXIT_SAMPLING] - é€€å‡ºé‡‡æ ·é˜¶æ®µ
[EXIT]          - é€€å‡ºæ‰§è¡Œ
[TP/SL]         - æ­¢ç›ˆæ­¢æŸè§¦å‘
```

**æ—¥å¿—æŸ¥çœ‹**:
```bash
# å®æ—¶æŸ¥çœ‹
tail -f logs/spot_trader_v2.log

# æŸ¥çœ‹é‡‡æ ·é˜¶æ®µ
grep "SAMPLING" logs/spot_trader_v2.log

# æŸ¥çœ‹å»ºä»“æ‰§è¡Œ
grep "BUILDING" logs/spot_trader_v2.log

# æŸ¥çœ‹æ­¢ç›ˆæ­¢æŸ
grep "TP/SL" logs/spot_trader_v2.log
```

### æ•°æ®åº“æŸ¥è¯¢

**æŸ¥çœ‹å½“å‰æŒä»“**:
```sql
SELECT
    symbol,
    phase,
    current_batch,
    total_batches,
    avg_entry_price,
    unrealized_pnl_pct,
    TIMESTAMPDIFF(HOUR, created_at, NOW()) as hours_elapsed
FROM spot_positions_v2
WHERE status = 'active'
ORDER BY created_at DESC;
```

**æŸ¥çœ‹å„é˜¶æ®µæŒä»“åˆ†å¸ƒ**:
```sql
SELECT
    phase,
    COUNT(*) as count,
    AVG(unrealized_pnl_pct) as avg_pnl_pct
FROM spot_positions_v2
WHERE status = 'active'
GROUP BY phase;
```

**æŸ¥çœ‹24Häº¤æ˜“ç»Ÿè®¡**:
```sql
SELECT
    COUNT(*) as total_trades,
    SUM(CASE WHEN realized_pnl > 0 THEN 1 ELSE 0 END) as wins,
    SUM(CASE WHEN realized_pnl <= 0 THEN 1 ELSE 0 END) as losses,
    SUM(realized_pnl) as total_pnl,
    AVG(realized_pnl) as avg_pnl,
    AVG(CASE WHEN realized_pnl > 0 THEN realized_pnl END) as avg_profit,
    AVG(CASE WHEN realized_pnl <= 0 THEN realized_pnl END) as avg_loss
FROM spot_positions_v2
WHERE status = 'closed'
  AND closed_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR);
```

### å¼‚å¸¸å¤„ç†

**å¸¸è§é—®é¢˜**:

1. **å»ºä»“è¶…æ—¶**
   - åŸå› : ä»·æ ¼æœªè¾¾åˆ°20%åˆ†ä½ç›®æ ‡
   - å¤„ç†: æ‰¹æ¬¡çª—å£ç»“æŸæ—¶ä»¥å½“å‰ä»·æ ¼å…¥åœº
   - æ—¥å¿—: `[BUILDING] Batch timeout, using current price`

2. **ä»·æ ¼é‡‡æ ·ä¸è¶³**
   - åŸå› : ç½‘ç»œå»¶è¿Ÿæˆ–æ•°æ®æºé—®é¢˜
   - å¤„ç†: ä½¿ç”¨æœ€è¿‘å¯ç”¨çš„æ ·æœ¬
   - æœ€å°æ ·æœ¬æ•°: 30ä¸ª

3. **æ­¢æŸé¢‘ç¹è§¦å‘**
   - åŸå› : å¸‚åœºæ³¢åŠ¨è¿‡å¤§æˆ–å…¥åœºæ—¶æœºä¸ä½³
   - æ£€æŸ¥: ä¿¡å·è´¨é‡ã€å¸‚åœºç¯å¢ƒ
   - ä¼˜åŒ–: è°ƒæ•´å…¥åœºé˜ˆå€¼

4. **æŒä»“å‘¨æœŸè¿‡é•¿**
   - åŸå› : é€€å‡ºé‡‡æ ·æœŸæœªè¾¾åˆ°80%åˆ†ä½ç›®æ ‡
   - å¤„ç†: 9å°æ—¶å¼ºåˆ¶é€€å‡º
   - æ—¥å¿—: `[EXIT] Force exit after 9 hours`

### æ€§èƒ½ä¼˜åŒ–

**ä»·æ ¼é‡‡æ ·ä¼˜åŒ–**:
```python
sampler_config = {
    'use_websocket': True,          # ä½¿ç”¨WebSocketå®æ—¶ä»·æ ¼
    'fallback_to_rest': True,       # é™çº§åˆ°REST API
    'cache_samples': True,          # ç¼“å­˜æ ·æœ¬æ•°æ®
    'max_samples': 200,             # æœ€å¤§æ ·æœ¬æ•°
    'sample_interval': 30           # é‡‡æ ·é—´éš”(ç§’)
}
```

**å¹¶å‘å¤„ç†**:
```python
async def monitor_all_positions():
    """å¼‚æ­¥ç›‘æ§æ‰€æœ‰æŒä»“"""
    tasks = []
    for position in active_positions:
        tasks.append(monitor_single_position(position))

    await asyncio.gather(*tasks)  # å¹¶å‘æ‰§è¡Œ
```

---

## é™„å½•

### æ•°æ®åº“è¡¨ç»“æ„

#### spot_positions_v2 (ç°è´§ä»“ä½è¡¨V2)

```sql
CREATE TABLE spot_positions_v2 (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,

    -- ä»·æ ¼ç›¸å…³
    entry_price DECIMAL(20,8),
    avg_entry_price DECIMAL(20,8),
    current_price DECIMAL(20,8),
    exit_price DECIMAL(20,8),

    -- æ•°é‡å’Œæˆæœ¬
    quantity DECIMAL(20,8),
    total_cost DECIMAL(20,2),

    -- æ‰¹æ¬¡ç®¡ç†
    total_batches INT DEFAULT 5,
    current_batch INT DEFAULT 0,
    batch_plan JSON,

    -- æ­¢ç›ˆæ­¢æŸ
    take_profit_price DECIMAL(20,8),
    stop_loss_price DECIMAL(20,8),

    -- ç›ˆäº
    unrealized_pnl DECIMAL(20,2),
    unrealized_pnl_pct DECIMAL(10,4),
    realized_pnl DECIMAL(20,2),
    realized_pnl_pct DECIMAL(10,4),

    -- ä¿¡å·ç›¸å…³
    signal_strength INT,
    signal_details JSON,

    -- äº¤æ˜“é˜¶æ®µ
    phase ENUM('sampling', 'building', 'holding', 'exit_sampling', 'exit_ready', 'closed') DEFAULT 'sampling',

    -- æ—¶é—´æˆ³
    sampling_start_time DATETIME,
    building_start_time DATETIME,
    holding_start_time DATETIME,
    exit_sampling_start_time DATETIME,

    -- çŠ¶æ€
    status ENUM('active', 'closed') DEFAULT 'active',
    close_reason VARCHAR(100),

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    closed_at DATETIME,

    INDEX idx_symbol (symbol),
    INDEX idx_status (status),
    INDEX idx_phase (phase),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### é…ç½®ç¤ºä¾‹

```yaml
spot_trading_v2:
  enabled: true

  # ä»“ä½é…ç½®
  position:
    capital_per_position: 2000    # å•ä»“ä½èµ„é‡‘(USDT)
    max_concurrent: 15            # æœ€å¤§å¹¶å‘ä»“ä½
    batch_ratios: [0.15, 0.20, 0.20, 0.20, 0.25]

  # å‘¨æœŸé…ç½®
  timeframe:
    sampling_hours: 1             # é‡‡æ ·æœŸ(å°æ—¶)
    building_hours: 2             # å»ºä»“æœŸ(å°æ—¶)
    holding_hours: 4              # æŒæœ‰æœŸ(å°æ—¶)
    exit_sampling_hours: 1        # é€€å‡ºé‡‡æ ·æœŸ(å°æ—¶)
    max_total_hours: 9            # æœ€å¤§æ€»å‘¨æœŸ(å°æ—¶)

  # ä»·æ ¼é‡‡æ ·
  sampling:
    interval_seconds: 30          # é‡‡æ ·é—´éš”(ç§’)
    min_samples: 30               # æœ€å°æ ·æœ¬æ•°
    entry_percentile: 20          # å…¥åœºåˆ†ä½æ•°
    exit_percentile: 80           # é€€å‡ºåˆ†ä½æ•°

  # å…¥åœºæ¡ä»¶
  entry:
    min_price_change_24h: 3.0     # æœ€å°24Hæ¶¨å¹…(%)
    min_quote_volume: 5000000     # æœ€å°æˆäº¤é‡(USDT)
    min_signal_strength: 40       # æœ€å°ä¿¡å·å¼ºåº¦
    required_trend: ['STRONG_UP', 'UP']

  # é£æ§
  risk:
    stop_loss_pct: 5.0            # æ­¢æŸ(%)
    take_profit_pct: 15.0         # æ­¢ç›ˆ(%)
    max_loss_per_position: 100    # å•ä»“ä½æœ€å¤§äºæŸ(USDT)
    max_daily_loss: 500           # æ—¥æœ€å¤§äºæŸ(USDT)
```

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹å½“å‰æŒä»“ç»Ÿè®¡
mysql -e "SELECT phase, COUNT(*) as count FROM spot_positions_v2 WHERE status='active' GROUP BY phase;"

# æŸ¥çœ‹å»ºä»“ä¸­çš„æŒä»“
mysql -e "SELECT symbol, current_batch, total_batches, avg_entry_price FROM spot_positions_v2 WHERE phase='building';"

# æŸ¥çœ‹ä»Šæ—¥ç›ˆäº
mysql -e "SELECT SUM(realized_pnl) as today_pnl FROM spot_positions_v2 WHERE closed_at >= CURDATE();"

# æ‰‹åŠ¨è§¦å‘é€€å‡ºé‡‡æ ·
python -c "from app.services.spot_trader_service_v2 import SpotTraderServiceV2; service = SpotTraderServiceV2(); service.start_exit_sampling('BTC/USDT')"
```

---

## æ€»ç»“

è¶…çº§å¤§è„‘ç°è´§äº¤æ˜“ç³»ç»ŸV2é€šè¿‡ä»¥ä¸‹æ ¸å¿ƒæœºåˆ¶å®ç°ç¨³å®šç›ˆåˆ©:

1. âœ… **åŠ¨æ€ä»·æ ¼é‡‡æ ·** - 20%åˆ†ä½å…¥åœºï¼Œ80%åˆ†ä½é€€å‡º
2. âœ… **8å°æ—¶å®Œæ•´å‘¨æœŸ** - é‡‡æ ·-å»ºä»“-æŒæœ‰-é€€å‡ºå®Œæ•´æµç¨‹
3. âœ… **5æ‰¹æ¬¡å»ºä»“** - å¹³æ»‘æˆæœ¬ï¼Œé™ä½æ³¢åŠ¨å½±å“
4. âœ… **è®©åˆ©æ¶¦å¥”è·‘** - æŒæœ‰æœŸä¸å¹²é¢„ï¼Œåªç›‘æ§æ­¢ç›ˆæ­¢æŸ
5. âœ… **ä¸¥æ ¼é£æ§** - 5%æ­¢æŸï¼Œ15%æ­¢ç›ˆï¼Œç›ˆäºæ¯”1:3

ç³»ç»Ÿé€šè¿‡ä»·æ ¼é‡‡æ ·ä¼˜åŒ–å…¥åœºå’Œé€€å‡ºæˆæœ¬ï¼Œåœ¨ä¿è¯é£æ§çš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–æ¯ç¬”äº¤æ˜“çš„ç›ˆåˆ©ç©ºé—´ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: V2.0
**æœ€åæ›´æ–°**: 2026-01-29
**ç»´æŠ¤è€…**: è¶…çº§å¤§è„‘å¼€å‘å›¢é˜Ÿ
