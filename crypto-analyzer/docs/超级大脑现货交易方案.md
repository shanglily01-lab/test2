# 超级大脑 - 现货交易方案

> **最后更新**: 2026-02-21
> **当前版本**: V1.5 (简化版)
> **设计版本**: V2.0 (动态价格采样系统 - 未完整实现)
> **核心特性**: 分批建仓 + 价格采样 + 智能平仓

---

## 📋 目录

1. [系统概述](#系统概述)
2. [当前实现状态](#当前实现状态)
3. [V1.5 简化版说明](#v15-简化版说明)
4. [V2.0 设计方案](#v20-设计方案)
5. [交易流程](#交易流程)
6. [风险控制](#风险控制)
7. [API接口](#api接口)
8. [运维管理](#运维管理)

---

## 系统概述

### 定位

**超级大脑现货交易系统** 旨在通过动态价格采样和分批建仓策略，实现短线现货交易的稳定盈利。

### 版本说明

**当前实现 (V1.5 简化版)**:
- ✅ 基础现货交易API接口
- ✅ 模拟交易引擎
- ✅ 分批建仓管理器（3批次）
- ✅ 价格采样器（90分位策略）
- ❌ 完整的阶段追踪（未实现）
- ❌ V2.0的动态价格采样系统（未实现）

**设计目标 (V2.0 完整版)**:
- 8小时完整周期
- 5批次分批建仓（15%-20%-20%-20%-25%）
- 20%分位入场 / 80%分位退出
- 完整的阶段追踪（采样-建仓-持有-退出采样-退出）

---

## 当前实现状态

### V1.5 简化版特性

**核心组件**:
```
现货交易系统 V1.5
│
├── 现货API接口 (spot_trading_api.py)
│   ├── GET /api/spot-trading/positions
│   ├── GET /api/spot-trading/history
│   └── GET /api/spot-trading/summary
│
├── 模拟交易引擎 (paper_trading_engine.py)
│   ├── 开仓/平仓执行
│   ├── 持仓管理
│   └── 盈亏计算
│
├── 价格采样器 (price_sampler.py)
│   ├── 滚动窗口: 5分钟（非30秒采样）
│   ├── 分位数策略: 90分位（非20%/80%）
│   └── 止跌/止涨信号检测
│
└── 分批建仓管理器 (batch_position_manager.py)
    ├── 3批次建仓（30%-30%-40%）
    ├── 每批独立持仓
    └── 超时时间: 30/45/60分钟
```

**数据库表**:
- `paper_trading_positions`: 现货模拟持仓
- `paper_trading_accounts`: 模拟交易账户
- 状态字段: `'open'` / `'closed'` (无阶段追踪)

**与V2.0设计的主要差异**:

| 功能 | V1.5 实现 | V2.0 设计 | 状态 |
|------|---------|----------|------|
| **价格采样间隔** | 5分钟滚动窗口 | 30秒/每120个样本 | ❌ 不同 |
| **入场分位数** | 90分位 | 20分位 | ❌ 不同 |
| **退出分位数** | 90分位 | 80分位 | ❌ 不同 |
| **批次数量** | 3批（30%-30%-40%） | 5批（15%-20%-20%-20%-25%） | ❌ 不同 |
| **时间窗口** | 30/45/60分钟 | 0-120分钟 | ❌ 不同 |
| **阶段追踪** | 仅 open/closed | 5个阶段 | ❌ 未实现 |
| **止盈止损** | 固定百分比 | 动态+固定 | ⚠️ 部分实现 |

---

## V1.5 简化版说明

### 核心参数

```python
# 分批建仓配置
batch_ratios = [0.3, 0.3, 0.4]          # 3批次
timeout_minutes = [30, 45, 60]          # 超时时间

# 价格采样配置
window_seconds = 300                     # 滚动窗口5分钟
price_threshold = 90                     # 90分位数阈值

# 止盈止损
stop_loss = 5%                           # 固定止损
take_profit = 15%                        # 固定止盈
```

### 交易流程 (V1.5)

```
1. 信号产生
   └─ 基础信号评分

2. 价格采样
   ├─ 5分钟滚动窗口采样
   └─ 计算90分位数基线

3. 分批建仓 (3批)
   ├─ Batch 1 (30%): 0-30分钟
   │  └─ 价格 ≤ 90分位时执行
   ├─ Batch 2 (30%): 30-45分钟
   │  └─ 价格 ≤ 90分位时执行
   └─ Batch 3 (40%): 45-60分钟
      └─ 价格 ≤ 90分位时执行

4. 持仓监控
   ├─ 固定止损: 5%
   └─ 固定止盈: 15%

5. 平仓执行
   └─ 全部平仓
```

### API接口

#### 1. 获取现货持仓

```http
GET /api/spot-trading/positions
```

**响应**:
```json
{
  "success": true,
  "positions": [
    {
      "id": 1001,
      "symbol": "BTC/USDT",
      "position_side": "LONG",
      "quantity": 0.05,
      "entry_price": 87500.0,
      "current_price": 88200.0,
      "total_cost": 4375.0,
      "unrealized_pnl": 35.0,
      "unrealized_pnl_pct": 0.8,
      "status": "open",
      "created_at": "2026-02-21T10:00:00"
    }
  ]
}
```

#### 2. 获取交易历史

```http
GET /api/spot-trading/history?start_date=2026-02-20&end_date=2026-02-21
```

#### 3. 获取交易统计

```http
GET /api/spot-trading/summary
```

**响应**:
```json
{
  "success": true,
  "summary": {
    "total_trades": 15,
    "winning_trades": 10,
    "losing_trades": 5,
    "win_rate": 66.7,
    "total_pnl": 456.78,
    "avg_profit": 82.34,
    "avg_loss": -45.67
  }
}
```

---

## V2.0 设计方案

### 设计目标

**完整的8小时周期管理**:
```
总周期: 8小时
├─ 采样期 (1小时): 收集价格基线
├─ 建仓期 (2小时): 执行5批建仓
├─ 持有期 (4小时): 让利润奔跑
└─ 退出采样 (1小时): 寻找最优退出价格
```

### 价格采样机制 (V2.0设计)

**采样策略**:
```python
price_sampler = {
    'sampling_interval': 30,        # 每30秒采样一次
    'samples_per_hour': 120,        # 每小时120个样本
    'entry_percentile': 20,         # 入场使用20%分位价格
    'exit_percentile': 80,          # 退出使用80%分位价格
    'rolling_window': 100           # 滚动窗口100个样本
}
```

**分位数计算**:
```python
def get_optimal_entry_price(samples):
    """获取最优入场价格 (低点)"""
    return np.percentile(samples, 20)  # 20%分位

def get_optimal_exit_price(samples):
    """获取最优退出价格 (高点)"""
    return np.percentile(samples, 80)  # 80%分位
```

### 5批次建仓 (V2.0设计)

**批次配置**:
```python
batch_ratios = [0.15, 0.20, 0.20, 0.20, 0.25]
total_capital_per_position = 2000  # USDT

batch_amounts = [
    2000 * 0.15 = 300 USDT,  # Batch 1
    2000 * 0.20 = 400 USDT,  # Batch 2
    2000 * 0.20 = 400 USDT,  # Batch 3
    2000 * 0.20 = 400 USDT,  # Batch 4
    2000 * 0.25 = 500 USDT   # Batch 5
]
```

**执行策略**:
```python
# Batch 1 (15%): 第0-24分钟
if price <= 20th_percentile:
    execute_batch_1()

# Batch 2 (20%): 第24-48分钟
if price <= 20th_percentile:
    execute_batch_2()

# Batch 3-5: 同理
```

### 阶段追踪 (V2.0设计)

**需要的数据库表结构**:
```sql
CREATE TABLE spot_positions_v2 (
    id INT AUTO_INCREMENT PRIMARY KEY,
    symbol VARCHAR(20) NOT NULL,

    -- 价格相关
    entry_price DECIMAL(20,8),
    avg_entry_price DECIMAL(20,8),
    exit_price DECIMAL(20,8),

    -- 批次管理
    total_batches INT DEFAULT 5,
    current_batch INT DEFAULT 0,
    batch_plan JSON,

    -- 交易阶段
    phase ENUM('sampling', 'building', 'holding',
               'exit_sampling', 'exit_ready', 'closed')
          DEFAULT 'sampling',

    -- 时间戳
    sampling_start_time DATETIME,
    building_start_time DATETIME,
    holding_start_time DATETIME,
    exit_sampling_start_time DATETIME,

    -- 状态
    status ENUM('active', 'closed') DEFAULT 'active',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
               ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 交易流程

### V1.5 当前流程

```
1. 信号产生 → 2. 价格采样 (5分钟) → 3. 分批建仓 (3批)
   → 4. 持仓监控 (止盈止损) → 5. 平仓
```

### V2.0 设计流程

```
阶段1: 采样期 (1小时)
   ├─ 创建持仓记录 (phase='sampling')
   ├─ 开始价格采样 (每30秒)
   ├─ 收集100+价格样本
   └─ 计算20%分位入场价格

阶段2: 建仓期 (2小时)
   ├─ phase='building'
   ├─ Batch 1 (15%): 第0-24分钟
   ├─ Batch 2 (20%): 第24-48分钟
   ├─ Batch 3 (20%): 第48-72分钟
   ├─ Batch 4 (20%): 第72-96分钟
   └─ Batch 5 (25%): 第96-120分钟

阶段3: 持有期 (4小时)
   ├─ phase='holding'
   ├─ 不主动干预
   ├─ 只监控止盈止损
   └─ 让利润奔跑

阶段4: 退出采样期 (1小时)
   ├─ phase='exit_sampling'
   ├─ 开始收集退出价格样本
   ├─ 计算80%分位退出价格
   └─ 准备退出

阶段5: 退出执行
   ├─ phase='exit_ready'
   ├─ 当价格 ≥ 80%分位时执行退出
   └─ 记录P&L，关闭持仓
```

---

## 风险控制

### 止盈止损 (V1.5)

**固定止损**: 5%
```python
if unrealized_pnl_pct <= -5%:
    execute_market_sell(reason='stop_loss_5pct')
```

**固定止盈**: 15%
```python
if unrealized_pnl_pct >= 15%:
    execute_market_sell(reason='take_profit_15pct')
```

**盈亏比**: 1:3

### 仓位管理

**单仓位配置** (V1.5):
```yaml
capital_per_position: 根据配置
max_concurrent_positions: 根据配置
```

**单仓位配置** (V2.0设计):
```yaml
capital_per_position: 2000 USDT
max_concurrent_positions: 15
total_capital_required: 30000 USDT
```

---

## 运维管理

### 启动服务

```bash
# 启动API服务器
python app/main.py

# 访问现货交易API
curl http://localhost:9020/api/spot-trading/positions
```

### 日志监控

**关键日志标签**:
```
[SPOT_TRADING]   - 现货交易
[PRICE_SAMPLER]  - 价格采样
[BATCH-ENTRY]    - 分批建仓
```

### 常用命令

```bash
# 查看当前持仓
mysql -e "SELECT symbol, quantity, unrealized_pnl_pct, status
FROM paper_trading_positions WHERE status='open';"

# 查看24H盈亏
mysql -e "SELECT SUM(realized_pnl) as total_pnl
FROM paper_trading_positions
WHERE updated_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR);"
```

---

## 迁移到V2.0计划

### 短期任务（维护V1.5）

1. ✅ 文档说明当前实现状态
2. ✅ API文档补充参数说明
3. ☐ 添加配置选项允许调整批次数和分位数

### 中期任务（迁移到V2.0）

1. ☐ 创建 `spot_positions_v2` 表
2. ☐ 实现完整的动态价格采样逻辑
3. ☐ 实现5批次建仓流程
4. ☐ 添加价格样本持久化存储
5. ☐ 实现阶段追踪功能

### 长期任务（完整V2.0）

1. ☐ 完整的8小时周期管理
2. ☐ 动态止盈止损基于波动率
3. ☐ 完整的信号黑名单管理
4. ☐ 性能监控和报警系统

---

## 差异说明

### 为什么V1.5与V2.0设计不同？

**1. 90分位 vs 20/80分位**

V1.5选择90分位是因为：
- 更保守的入场策略
- 减少等待时间
- 简化实现复杂度

V2.0设计的20/80分位是为了：
- 更优的成本优化
- 更大的价格优势
- 完整的入场退出对称性

**2. 3批 vs 5批**

V1.5使用3批是因为：
- 与合约交易系统保持一致
- 复用现有的 BatchPositionManager
- 减少实现复杂度

V2.0设计5批是为了：
- 更平滑的成本分摊
- 更细粒度的价格优化

**3. 无阶段追踪 vs 完整阶段**

V1.5缺少阶段追踪是因为：
- 复用了合约交易的表结构
- 简化版不需要复杂的状态管理

V2.0设计完整阶段是为了：
- 精确控制每个阶段的时间
- 支持更复杂的策略优化

---

## 总结

现货交易系统当前处于 **V1.5 简化版实现状态**：

**已实现功能** ✅:
1. 基础现货交易API接口
2. 模拟交易引擎
3. 分批建仓管理器（3批次）
4. 价格采样器（90分位策略）
5. 固定止盈止损

**未实现功能** ❌:
1. 完整的阶段追踪（5个阶段）
2. V2.0的动态价格采样系统（20/80分位）
3. 5批次分批建仓
4. 8小时完整周期管理

**使用建议**:
- V1.5适合: 简单的现货交易需求
- V2.0适合: 需要精细化价格优化的策略

**迁移计划**:
- 短期: 维护和优化V1.5
- 中期: 逐步实现V2.0核心功能
- 长期: 完整的V2.0系统上线

---

**文档版本**: V1.5 (当前实现) + V2.0 (设计方案)
**最后更新**: 2026-02-21
**维护者**: 超级大脑开发团队
