# 重启服务指南

## 需要重启的服务

由于添加了策略命中记录功能，需要重启以下服务：

### 1. **strategy_scheduler** ✅ 必须重启
- **原因**：使用了 `StrategyExecutor`，需要加载新的命中记录功能
- **影响**：如果不重启，策略执行时不会记录命中信息到数据库

### 2. **main** ✅ 必须重启  
- **原因**：添加了新的 API 端点 `/api/strategies/hits`
- **影响**：如果不重启，新的 API 端点无法访问

## 重启步骤

### 方法1：手动重启（推荐）

#### 1. 停止 strategy_scheduler
```bash
# 查找进程
tasklist | findstr python

# 或者使用任务管理器找到 strategy_scheduler 进程并结束

# 或者如果使用命令行运行，按 Ctrl+C 停止
```

#### 2. 停止 main 服务
```bash
# 如果使用 uvicorn 运行
# 找到进程并结束，或者按 Ctrl+C

# 如果使用其他方式运行，找到对应进程并停止
```

#### 3. 重新启动 strategy_scheduler
```bash
python app/strategy_scheduler.py
```

#### 4. 重新启动 main 服务
```bash
# 如果使用 uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 或者使用其他启动方式
python app/main.py
```

### 方法2：使用脚本重启（如果已配置）

如果有启动脚本，可以使用脚本重启。

## 验证重启是否成功

### 1. 检查 strategy_scheduler 日志
重启后，查看日志中是否有：
```
初始化策略执行器...
  ✓ 策略执行器初始化成功
```

### 2. 检查 main 服务日志
重启后，查看日志中是否有：
```
🚀 启动加密货币交易分析系统...
```

### 3. 测试新的 API 端点
```bash
# 测试策略命中记录 API
curl http://localhost:8000/api/strategies/hits

# 应该返回 JSON 数据（可能是空数组，如果还没有命中记录）
```

### 4. 检查策略执行是否记录命中信息
- 等待策略执行一次
- 查询数据库：`SELECT * FROM strategy_hits ORDER BY created_at DESC LIMIT 10;`
- 或者通过 API 查询：`GET /api/strategies/hits`

## 注意事项

1. **重启顺序**：建议先停止所有服务，然后先启动 main，再启动 strategy_scheduler
2. **数据安全**：重启不会影响已保存的数据，但重启期间策略不会执行
3. **⚠️ 重要**：**不要同时运行 `scripts/monitor_strategy_hits.py` 和 `strategy_scheduler.py`**
   - 这两个脚本功能重复，都会执行策略
   - 同时运行会导致策略被重复执行，可能造成重复交易
   - **只需要运行 `strategy_scheduler.py` 即可**，它已经包含了命中记录功能
   - `monitor_strategy_hits.py` 是多余的，可以忽略或删除

## 故障排查

### 如果重启后没有记录命中信息

1. 检查数据库表是否存在：
   ```sql
   SHOW TABLES LIKE 'strategy_hits';
   ```

2. 检查策略是否启用：
   ```bash
   # 查看策略配置文件
   cat config/strategies/futures_strategies.json
   ```

3. 查看 strategy_scheduler 日志，确认策略执行器是否正常初始化

4. 查看日志文件：`logs/strategy_hits_*.log`

### 如果 API 端点无法访问

1. 确认 main 服务已启动
2. 检查端口是否正确（默认 8000）
3. 查看 main 服务日志，确认是否有错误
4. 测试其他 API 端点是否正常

