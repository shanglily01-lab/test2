# æ€§èƒ½ä¼˜åŒ–è¯´æ˜æ–‡æ¡£

## é—®é¢˜æè¿°

åœ¨åŸå§‹çš„ `main.py` å®ç°ä¸­ï¼ŒPaper Trading çš„ä»·æ ¼æŸ¥è¯¢ç»å¸¸è¢«é˜»å¡ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸‹é™ã€‚

### ä¸»è¦é—®é¢˜

1. **æ•°æ®åº“æŸ¥è¯¢é˜»å¡**
   - `PaperTradingEngine.get_current_price()` æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„æ•°æ®åº“è¿æ¥å¹¶æŸ¥è¯¢
   - Dashboard API çš„å¤æ‚æŸ¥è¯¢ä¼šé•¿æ—¶é—´å ç”¨æ•°æ®åº“è¿æ¥
   - å¤šä¸ªå¹¶å‘è¯·æ±‚ä¼šå¯¼è‡´æ•°æ®åº“è¿æ¥æ± è€—å°½

2. **Dashboard æ€§èƒ½é—®é¢˜**
   - `/api/dashboard` éœ€è¦è·å–å¤šä¸ªå¸ç§çš„å®Œæ•´æ•°æ®ï¼ˆæŠ€æœ¯åˆ†æã€æ–°é—»ã€Hyperliquid ç­‰ï¼‰
   - åŸå§‹ç¼“å­˜æ—¶é—´ä»… 5 ç§’ï¼Œç¼“å­˜è¿‡æœŸåé‡æ–°è®¡ç®—è€—æ—¶è¾ƒé•¿
   - åŒæ­¥æ‰§è¡Œé˜»å¡å…¶ä»– API è¯·æ±‚

---

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ä»·æ ¼ç¼“å­˜æœåŠ¡ï¼ˆPriceCacheServiceï¼‰

**æ–‡ä»¶ï¼š** `app/services/price_cache_service.py`

#### æ ¸å¿ƒç‰¹æ€§

- **å†…å­˜ç¼“å­˜**ï¼šæ‰€æœ‰ä»·æ ¼æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ŒæŸ¥è¯¢é€Ÿåº¦æå¿«ï¼ˆå¾®ç§’çº§ï¼‰
- **åå°æ›´æ–°**ï¼šç‹¬ç«‹çº¿ç¨‹æ¯ 5 ç§’ä»æ•°æ®åº“æ‰¹é‡æ›´æ–°ä»·æ ¼
- **é›¶é˜»å¡**ï¼šä»·æ ¼æŸ¥è¯¢ä¸ä¼šè§¦å‘æ•°æ®åº“è¿æ¥ï¼Œé¿å…ç«äº‰
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨ `threading.Lock` ä¿è¯å¹¶å‘å®‰å…¨

#### æ¶æ„è®¾è®¡

```python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Price Cache Service (å†…å­˜)            â”‚
â”‚   {symbol: price, timestamp}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†‘ æ¯ 5 ç§’æ›´æ–°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åå°æ›´æ–°çº¿ç¨‹                          â”‚
â”‚   - æ‰¹é‡æŸ¥è¯¢æ•°æ®åº“                      â”‚
â”‚   - æ›´æ–°å†…å­˜ç¼“å­˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä½¿ç”¨æ–¹å¼

```python
# åˆå§‹åŒ–ï¼ˆåœ¨ main.py å¯åŠ¨æ—¶ï¼‰
from app.services.price_cache_service import init_global_price_cache

price_cache_service = init_global_price_cache(db_config, update_interval=5)

# æŸ¥è¯¢ä»·æ ¼ï¼ˆæå¿«ï¼Œæ— æ•°æ®åº“æŸ¥è¯¢ï¼‰
price = price_cache_service.get_price("BTC/USDT")
```

---

### 2. PaperTradingEngine ä¼˜åŒ–

**æ–‡ä»¶ï¼š** `app/trading/paper_trading_engine.py`

#### ä¿®æ”¹å†…å®¹

1. **æ„é€ å‡½æ•°å¢åŠ å‚æ•°**
   ```python
   def __init__(self, db_config: Dict, price_cache_service=None):
       self.price_cache_service = price_cache_service
   ```

2. **ä¼˜åŒ– `get_current_price()` æ–¹æ³•**
   - ä¼˜å…ˆä»ç¼“å­˜è·å–ä»·æ ¼ï¼ˆ0 æ•°æ®åº“æŸ¥è¯¢ï¼‰
   - ç¼“å­˜æœªå‘½ä¸­æ—¶å›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢
   - æ·»åŠ è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•

   ```python
   def get_current_price(self, symbol: str) -> Decimal:
       # ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
       if self.price_cache_service:
           price = self.price_cache_service.get_price(symbol)
           if price > 0:
               return price

       # å›é€€åˆ°æ•°æ®åº“
       return self._query_price_from_db(symbol)
   ```

#### æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ä»·æ ¼æŸ¥è¯¢å»¶è¿Ÿ | 10-50msï¼ˆæ•°æ®åº“ï¼‰ | <1msï¼ˆå†…å­˜ï¼‰ | **50å€+** |
| æ•°æ®åº“è¿æ¥æ•° | æ¯æ¬¡æŸ¥è¯¢ 1 ä¸ª | åå°çº¿ç¨‹ 1 ä¸ª | **å¤§å¹…å‡å°‘** |
| å¹¶å‘èƒ½åŠ› | å®¹æ˜“é˜»å¡ | æ— é˜»å¡ | **æ˜¾è‘—æå‡** |

---

### 3. Dashboard API ä¼˜åŒ–

**æ–‡ä»¶ï¼š** `app/main.py`

#### ä¼˜åŒ–æªæ–½

1. **å¢åŠ ç¼“å­˜æ—¶é—´**
   - ä» 5 ç§’å¢åŠ åˆ° 30 ç§’
   - å‡å°‘é‡å¤è®¡ç®—é¢‘ç‡

2. **çº¿ç¨‹æ± éš”ç¦»**
   - ä½¿ç”¨ `ThreadPoolExecutor` æ‰§è¡Œ Dashboard æ•°æ®è·å–
   - é¿å…é˜»å¡ FastAPI äº‹ä»¶å¾ªç¯
   - å…¶ä»– APIï¼ˆå¦‚ Paper Tradingï¼‰å¯ä»¥å¹¶è¡Œæ‰§è¡Œ

   ```python
   from concurrent.futures import ThreadPoolExecutor

   with ThreadPoolExecutor(max_workers=1) as executor:
       data = await loop.run_in_executor(
           executor,
           lambda: asyncio.run(enhanced_dashboard.get_dashboard_data(symbols))
       )
   ```

---

### 4. API ä¾èµ–æ³¨å…¥ä¼˜åŒ–

**æ–‡ä»¶ï¼š** `app/api/paper_trading_api.py`

#### ä¿®æ”¹å†…å®¹

```python
from app.services.price_cache_service import get_global_price_cache

def get_engine():
    db_config = get_db_config()
    price_cache = get_global_price_cache()  # è·å–å…¨å±€ç¼“å­˜
    return PaperTradingEngine(db_config, price_cache_service=price_cache)
```

---

### 5. æ•°æ®åº“æœåŠ¡æ‰©å±•

**æ–‡ä»¶ï¼š** `app/database/db_service.py`

#### æ–°å¢æ–¹æ³•

```python
def get_all_latest_prices(self) -> List[Dict]:
    """
    æ‰¹é‡è·å–æ‰€æœ‰å¸ç§çš„æœ€æ–°ä»·æ ¼
    ä½¿ç”¨å­æŸ¥è¯¢ä¼˜åŒ–ï¼Œå•æ¬¡æŸ¥è¯¢è¿”å›æ‰€æœ‰å¸ç§
    """
    # ä½¿ç”¨ GROUP BY + JOIN ä¼˜åŒ–
    subquery = session.query(
        PriceData.symbol,
        func.max(PriceData.timestamp).label('max_timestamp')
    ).group_by(PriceData.symbol).subquery()

    prices = session.query(PriceData).join(subquery, ...).all()
    return prices
```

**æ€§èƒ½ä¼˜åŠ¿ï¼š**
- å•æ¬¡æŸ¥è¯¢æ›¿ä»£ N æ¬¡æŸ¥è¯¢ï¼ˆN = å¸ç§æ•°é‡ï¼‰
- ä½¿ç”¨æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- å‡å°‘ç½‘ç»œå¾€è¿”æ—¶é—´

---

## ä¼˜åŒ–æ•ˆæœæ€»ç»“

### æ€§èƒ½å¯¹æ¯”

| åŠŸèƒ½ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| Paper Trading ä»·æ ¼æŸ¥è¯¢ | 10-50ms | <1ms | âš¡ **50å€** |
| Dashboard åŠ è½½ | 5-10ç§’ | 30ç§’ç¼“å­˜ï¼ˆé¿å…é‡å¤è®¡ç®—ï¼‰ | ğŸš€ **æ˜¾è‘—ä¼˜åŒ–** |
| æ•°æ®åº“è¿æ¥æ•° | é«˜ï¼ˆæ¯æ¬¡è¯·æ±‚ï¼‰ | ä½ï¼ˆåå°å®šæœŸï¼‰ | ğŸ“‰ **å¤§å¹…é™ä½** |
| å¹¶å‘å“åº”èƒ½åŠ› | å®¹æ˜“é˜»å¡ | ç‹¬ç«‹æ‰§è¡Œ | âœ… **æ— é˜»å¡** |

### æ¶æ„ä¼˜åŠ¿

1. **è§£è€¦è®¾è®¡**
   - Price Cache ç‹¬ç«‹äºä¸šåŠ¡é€»è¾‘
   - å¯ä»¥è½»æ¾å…³é—­ç¼“å­˜å›é€€åˆ°æ•°æ®åº“

2. **å‘åå…¼å®¹**
   - å¦‚æœç¼“å­˜æœåŠ¡æœªå¯åŠ¨ï¼Œè‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
   - ä¸å½±å“ç°æœ‰åŠŸèƒ½

3. **å¯æ‰©å±•æ€§**
   - å¯ä»¥æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆå†…å­˜ â†’ Redis â†’ æ•°æ®åº“ï¼‰
   - å¯ä»¥é’ˆå¯¹ä¸åŒå¸ç§è®¾ç½®ä¸åŒæ›´æ–°é¢‘ç‡

---

## å¯åŠ¨è¯´æ˜

### è‡ªåŠ¨å¯åŠ¨

ä¼˜åŒ–åçš„ç³»ç»Ÿä¼šåœ¨ FastAPI å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–ä»·æ ¼ç¼“å­˜æœåŠ¡ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ã€‚

```bash
# å¯åŠ¨ Web æœåŠ¡ï¼ˆè‡ªåŠ¨å¯åŠ¨ä»·æ ¼ç¼“å­˜ï¼‰
python run.py

# æˆ–ç›´æ¥è¿è¡Œ
python app/main.py
```

### æ—¥å¿—ç›‘æ§

å¯åŠ¨æ—¶ä¼šçœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

```
âœ… é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ
âœ… ä»·æ ¼ç¼“å­˜æœåŠ¡å·²å¯åŠ¨ï¼ˆ5ç§’æ›´æ–°é—´éš”ï¼‰
ğŸš€ FastAPI å¯åŠ¨å®Œæˆï¼ˆPaper Trading å·²å°±ç»ªï¼Œåˆ†ææ¨¡å—åå°åŠ è½½ä¸­ï¼‰
ğŸš€ ä»·æ ¼ç¼“å­˜åå°æ›´æ–°çº¿ç¨‹å·²å¯åŠ¨
```

### å¥åº·æ£€æŸ¥

è®¿é—® `/health` ç«¯ç‚¹æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ï¼š

```bash
curl http://localhost:8000/health
```

å“åº”ï¼š
```json
{
  "status": "healthy",
  "modules": {
    "price_collector": true,
    "news_aggregator": true,
    "technical_analyzer": true,
    "sentiment_analyzer": true,
    "signal_generator": true
  }
}
```

---

## é…ç½®é€‰é¡¹

### è°ƒæ•´ç¼“å­˜æ›´æ–°é¢‘ç‡

åœ¨ `app/main.py` ç¬¬ 72 è¡Œä¿®æ”¹ï¼š

```python
price_cache_service = init_global_price_cache(
    db_config,
    update_interval=5  # ä¿®æ”¹ä¸ºéœ€è¦çš„ç§’æ•°ï¼ˆæ¨è 3-10 ç§’ï¼‰
)
```

### è°ƒæ•´ Dashboard ç¼“å­˜æ—¶é—´

åœ¨ `app/main.py` ç¬¬ 569 è¡Œä¿®æ”¹ï¼š

```python
_dashboard_cache_ttl_seconds = 30  # ä¿®æ”¹ä¸ºéœ€è¦çš„ç§’æ•°
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šä»·æ ¼ç¼“å­˜æœªå‘½ä¸­

**ç—‡çŠ¶ï¼š** æ—¥å¿—æ˜¾ç¤º "âš ï¸ {symbol} ç¼“å­˜æœªå‘½ä¸­ï¼Œå›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢"

**åŸå› ï¼š**
1. æ•°æ®é‡‡é›†å™¨æœªè¿è¡Œï¼ˆæ•°æ®åº“ä¸­æ²¡æœ‰ä»·æ ¼æ•°æ®ï¼‰
2. Symbol æ ¼å¼ä¸åŒ¹é…ï¼ˆä¾‹å¦‚ BTC-USDT vs BTC/USDTï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç¡®ä¿æ•°æ®é‡‡é›†å™¨æ­£åœ¨è¿è¡Œ
python app/scheduler.py

# æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰ä»·æ ¼æ•°æ®
mysql -u root -p -D binance-data -e "SELECT * FROM price_data ORDER BY timestamp DESC LIMIT 10;"
```

### é—®é¢˜ï¼šDashboard ä»ç„¶å¾ˆæ…¢

**å¯èƒ½åŸå› ï¼š**
1. Hyperliquid æ•°æ®æŸ¥è¯¢è€—æ—¶
2. æ–°é—»èšåˆå™¨è¶…æ—¶
3. æ•°æ®åº“æŸ¥è¯¢æœªä¼˜åŒ–

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ Hyperliquid æ•°æ®åº“è¿æ¥
- å¢åŠ  Dashboard ç¼“å­˜æ—¶é—´åˆ° 60 ç§’
- ä½¿ç”¨ `EXPLAIN` åˆ†ææ…¢æŸ¥è¯¢

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **Redis ç¼“å­˜**
   - åˆ†å¸ƒå¼ç¼“å­˜ï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
   - æŒä¹…åŒ–ä»·æ ¼æ•°æ®

2. **WebSocket æ¨é€**
   - å®æ—¶ä»·æ ¼æ¨é€åˆ°å‰ç«¯
   - å‡å°‘è½®è¯¢è¯·æ±‚

3. **æ•°æ®åº“è¯»å†™åˆ†ç¦»**
   - è¯»åº“ä¸“ç”¨äºæŸ¥è¯¢
   - å†™åº“ä¸“ç”¨äºæ•°æ®é‡‡é›†

4. **GraphQL API**
   - æŒ‰éœ€æŸ¥è¯¢å‡å°‘æ•°æ®ä¼ è¾“
   - æ‰¹é‡è¯·æ±‚ä¼˜åŒ–

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| [app/services/price_cache_service.py](../app/services/price_cache_service.py) | ä»·æ ¼ç¼“å­˜æœåŠ¡ |
| [app/main.py](../app/main.py) | FastAPI ä¸»ç¨‹åºï¼ˆé›†æˆç¼“å­˜ï¼‰ |
| [app/trading/paper_trading_engine.py](../app/trading/paper_trading_engine.py) | Paper Trading å¼•æ“ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰ |
| [app/api/paper_trading_api.py](../app/api/paper_trading_api.py) | Paper Trading API |
| [app/database/db_service.py](../app/database/db_service.py) | æ•°æ®åº“æœåŠ¡ï¼ˆæ–°å¢æ‰¹é‡æŸ¥è¯¢ï¼‰ |

---

## è´¡çŒ®è€…

- ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡ï¼šClaude Code
- å®æ–½æ—¶é—´ï¼š2025-10-25
- ç‰ˆæœ¬ï¼šv1.0.0

---

## è®¸å¯è¯

MIT License
