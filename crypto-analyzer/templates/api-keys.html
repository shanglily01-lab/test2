<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API密钥管理 - 加密货币交易系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #eee;
        }
        .card {
            background-color: #16213e;
            border: 1px solid #0f3460;
        }
        .card-header {
            background-color: #0f3460;
            border-bottom: 1px solid #1a1a2e;
        }
        .form-control, .form-select {
            background-color: #1a1a2e;
            border-color: #0f3460;
            color: #eee;
        }
        .form-control:focus, .form-select:focus {
            background-color: #1a1a2e;
            border-color: #e94560;
            color: #eee;
            box-shadow: 0 0 0 0.25rem rgba(233, 69, 96, 0.25);
        }
        .btn-primary {
            background-color: #e94560;
            border-color: #e94560;
        }
        .btn-primary:hover {
            background-color: #c93b52;
            border-color: #c93b52;
        }
        .table {
            color: #eee;
        }
        .table-dark {
            --bs-table-bg: #16213e;
            --bs-table-border-color: #0f3460;
        }
        .alert-info {
            background-color: #0f3460;
            border-color: #1a1a2e;
            color: #eee;
        }
        .badge-active {
            background-color: #28a745;
        }
        .badge-inactive {
            background-color: #dc3545;
        }
        .api-key-masked {
            font-family: monospace;
            color: #888;
        }
        .navbar {
            background-color: #0f3460 !important;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-currency-bitcoin"></i> 交易系统
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="bi bi-house"></i> 首页</a>
                <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2"></i> 仪表盘</a>
                <a class="nav-link active" href="/api-keys"><i class="bi bi-key"></i> API密钥</a>
                <a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2 class="mb-4"><i class="bi bi-key-fill"></i> API密钥管理</h2>

        <!-- 提示信息 -->
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>安全提示：</strong>
            <ul class="mb-0 mt-2">
                <li>API密钥将被加密存储，确保安全</li>
                <li>建议只开启交易权限，不要开启提现权限</li>
                <li>定期更换API密钥以提高安全性</li>
                <li>每个交易所可配置多个账户</li>
            </ul>
        </div>

        <div class="row">
            <!-- 左侧：添加/编辑表单 -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> 添加API密钥</h5>
                    </div>
                    <div class="card-body">
                        <form id="apiKeyForm">
                            <div class="mb-3">
                                <label class="form-label">交易所</label>
                                <select class="form-select" id="exchange" required>
                                    <option value="binance">Binance 币安</option>
                                    <option value="gate">Gate.io</option>
                                    <option value="okx">OKX</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">账户名称</label>
                                <input type="text" class="form-control" id="accountName"
                                       placeholder="例如：主账户、套利账户" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="apiKey"
                                       placeholder="输入API Key" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" id="apiSecret"
                                       placeholder="输入API Secret" required>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="showSecret"
                                           onchange="toggleSecretVisibility()">
                                    <label class="form-check-label" for="showSecret">显示密钥</label>
                                </div>
                            </div>

                            <hr>

                            <div class="mb-3">
                                <label class="form-label">风控设置</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">最大持仓(USDT)</label>
                                        <input type="number" class="form-control" id="maxPositionValue"
                                               value="1000" min="0">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">最大日亏损(USDT)</label>
                                        <input type="number" class="form-control" id="maxDailyLoss"
                                               value="100" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">最大杠杆</label>
                                        <input type="number" class="form-control" id="maxLeverage"
                                               value="10" min="1" max="125">
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="isTestnet">
                                            <label class="form-check-label" for="isTestnet">测试网</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> 保存API密钥
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 右侧：已配置的密钥列表 -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> 已配置的API密钥</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="loadApiKeys()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="apiKeysList">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">加载中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 验证结果 -->
                <div class="card mt-3" id="verifyResultCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-check-circle"></i> 验证结果</h5>
                    </div>
                    <div class="card-body" id="verifyResult">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) {
                return;
            }
            loadApiKeys();
        });

        // 切换密钥显示
        function toggleSecretVisibility() {
            const input = document.getElementById('apiSecret');
            const checkbox = document.getElementById('showSecret');
            input.type = checkbox.checked ? 'text' : 'password';
        }

        // 加载API密钥列表
        async function loadApiKeys() {
            const container = document.getElementById('apiKeysList');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';

            try {
                const response = await Auth.authFetch('/api/api-keys/list');
                const data = await response.json();

                if (data.success && data.api_keys) {
                    if (data.api_keys.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">暂无配置的API密钥</p>
                                <p class="small">请在左侧添加您的交易所API密钥</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '<table class="table table-dark table-hover">';
                    html += `
                        <thead>
                            <tr>
                                <th>交易所</th>
                                <th>账户名称</th>
                                <th>状态</th>
                                <th>最后使用</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    for (const key of data.api_keys) {
                        const statusBadge = key.status === 'active'
                            ? '<span class="badge badge-active">活跃</span>'
                            : '<span class="badge badge-inactive">禁用</span>';
                        const lastUsed = key.last_used_at
                            ? new Date(key.last_used_at).toLocaleString()
                            : '从未使用';
                        const testnetBadge = key.is_testnet
                            ? '<span class="badge bg-warning ms-1">测试网</span>'
                            : '';

                        html += `
                            <tr>
                                <td>${key.exchange.toUpperCase()}${testnetBadge}</td>
                                <td>${key.account_name}</td>
                                <td>${statusBadge}</td>
                                <td class="small">${lastUsed}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="verifyApiKey(${key.id}, '${key.exchange}')">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteApiKey(${key.id}, '${key.account_name}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }

                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="alert alert-danger">${data.detail || '加载失败'}</div>`;
                }
            } catch (error) {
                console.error('加载API密钥失败:', error);
                container.innerHTML = `<div class="alert alert-danger">加载失败: ${error.message}</div>`;
            }
        }

        // 保存API密钥
        document.getElementById('apiKeyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                exchange: document.getElementById('exchange').value,
                account_name: document.getElementById('accountName').value,
                api_key: document.getElementById('apiKey').value,
                api_secret: document.getElementById('apiSecret').value,
                max_position_value: parseFloat(document.getElementById('maxPositionValue').value) || 1000,
                max_daily_loss: parseFloat(document.getElementById('maxDailyLoss').value) || 100,
                max_leverage: parseInt(document.getElementById('maxLeverage').value) || 10,
                is_testnet: document.getElementById('isTestnet').checked
            };

            try {
                const response = await Auth.authFetch('/api/api-keys/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('API密钥保存成功！');
                    // 清空表单
                    document.getElementById('accountName').value = '';
                    document.getElementById('apiKey').value = '';
                    document.getElementById('apiSecret').value = '';
                    // 刷新列表
                    loadApiKeys();
                } else {
                    alert('保存失败: ' + (result.detail || result.error || '未知错误'));
                }
            } catch (error) {
                console.error('保存API密钥失败:', error);
                alert('保存失败: ' + error.message);
            }
        });

        // 验证API密钥
        async function verifyApiKey(keyId, exchange) {
            const resultCard = document.getElementById('verifyResultCard');
            const resultContainer = document.getElementById('verifyResult');

            resultCard.style.display = 'block';
            resultContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div> 验证中...</div>';

            try {
                const response = await Auth.authFetch(`/api/api-keys/verify?exchange=${exchange}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    const balance = result.balance || {};
                    resultContainer.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> API密钥验证成功！
                        </div>
                        <table class="table table-dark table-sm">
                            <tr><td>总余额</td><td>${balance.total_wallet_balance || 0} USDT</td></tr>
                            <tr><td>可用余额</td><td>${balance.available_balance || 0} USDT</td></tr>
                            <tr><td>未实现盈亏</td><td>${balance.total_unrealized_pnl || 0} USDT</td></tr>
                        </table>
                    `;
                } else {
                    resultContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle-fill"></i> 验证失败: ${result.error || '未知错误'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('验证API密钥失败:', error);
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle-fill"></i> 验证失败: ${error.message}
                    </div>
                `;
            }
        }

        // 删除API密钥
        async function deleteApiKey(keyId, accountName) {
            if (!confirm(`确定要删除 "${accountName}" 的API密钥吗？\n此操作不可恢复！`)) {
                return;
            }

            try {
                const response = await Auth.authFetch('/api/api-keys/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key_id: keyId })
                });

                const result = await response.json();

                if (result.success) {
                    alert('API密钥已删除');
                    loadApiKeys();
                } else {
                    alert('删除失败: ' + (result.detail || result.error || '未知错误'));
                }
            } catch (error) {
                console.error('删除API密钥失败:', error);
                alert('删除失败: ' + error.message);
            }
        }

        // 退出登录
        async function logout() {
            await Auth.logout();
            window.location.href = '/login';
        }
    </script>
</body>
</html>
