<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API密钥管理 - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="/static/js/auth.js"></script>
    <style>
        /* AlphaFlow 统一设计系统 */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; }
        .container { max-width: 1400px; margin: 0 auto; padding: var(--spacing-xl); }

        /* 导航栏 */
        .nav-container { background: linear-gradient(135deg, rgba(44, 68, 100, 0.9) 0%, rgba(28, 33, 40, 0.95) 100%); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); backdrop-filter: blur(10px); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; align-items: center; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 14px; border: 1px solid transparent; display: flex; align-items: center; gap: var(--spacing-sm); }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .nav-brand { font-size: 20px; font-weight: 700; color: var(--text-primary); margin-right: auto; display: flex; align-items: center; gap: var(--spacing-sm); }
        .nav-brand i { color: var(--primary-blue); }

        /* 页面标题 */
        .page-header { margin-bottom: var(--spacing-xl); }
        .page-title { font-size: 28px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm); }
        .page-title i { color: var(--primary-blue); }
        .page-subtitle { color: var(--text-secondary); font-size: 14px; }

        /* 卡片 */
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); overflow: hidden; transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding: var(--spacing-lg) var(--spacing-xl); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-card) 100%); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: var(--spacing-xl); }

        /* 提示框 */
        .alert { padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-xl); border: 1px solid; }
        .alert-info { background: linear-gradient(135deg, rgba(43, 111, 237, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%); border-color: rgba(43, 111, 237, 0.3); color: var(--text-primary); }
        .alert-info i { color: var(--primary-blue); }
        .alert-success { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); color: var(--success-green); }
        .alert-danger { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger-red); }
        .alert-title { font-weight: 600; margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-sm); }
        .alert ul { margin: var(--spacing-sm) 0 0 var(--spacing-xl); color: var(--text-secondary); }
        .alert li { margin-bottom: var(--spacing-xs); }

        /* 表单 */
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-sm); text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { width: 100%; padding: var(--spacing-md) var(--spacing-lg); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; transition: all var(--transition-base); }
        .form-control:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(43, 111, 237, 0.2); background: var(--bg-secondary); }
        .form-control::placeholder { color: var(--text-tertiary); }
        select.form-control { cursor: pointer; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); }
        .form-check { display: flex; align-items: center; gap: var(--spacing-sm); margin-top: var(--spacing-sm); }
        .form-check-input { width: 18px; height: 18px; accent-color: var(--primary-blue); cursor: pointer; }
        .form-check-label { color: var(--text-secondary); font-size: 13px; cursor: pointer; }

        .form-divider { border: none; border-top: 1px solid var(--border-default); margin: var(--spacing-xl) 0; }
        .form-section-title { font-size: 12px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: var(--spacing-lg); }

        /* 按钮 */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 600; text-decoration: none; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-blue-dark) 100%); color: white; border-color: var(--primary-blue); }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(135deg, var(--primary-blue-hover) 0%, var(--primary-blue-dark) 100%); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(43, 111, 237, 0.4); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--border-muted); }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #DC2626; transform: translateY(-1px); }
        .btn-success { background: var(--success-green); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-outline { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-default); }
        .btn-outline:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
        .btn-sm { padding: var(--spacing-sm) var(--spacing-md); font-size: 12px; }
        .btn-block { width: 100%; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: var(--radius-md); }

        /* 表格 */
        .table-container { overflow-x: auto; border-radius: var(--radius-md); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-tertiary); }
        th { padding: var(--spacing-md) var(--spacing-lg); text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border-default); }
        td { padding: var(--spacing-lg); border-bottom: 1px solid var(--border-default); color: var(--text-primary); font-size: 13px; }
        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color var(--transition-fast); }
        tbody tr:hover { background: var(--bg-hover); }

        /* 徽章 */
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success-green); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger-red); }
        .badge-warning { background: rgba(249, 158, 22, 0.2); color: var(--warning-yellow); }
        .badge-info { background: rgba(43, 111, 237, 0.2); color: var(--primary-blue); }

        /* 空状态 */
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .empty-state-icon { font-size: 64px; margin-bottom: var(--spacing-lg); opacity: 0.3; color: var(--primary-blue); }
        .empty-state-text { font-size: 16px; margin-bottom: var(--spacing-sm); color: var(--text-primary); }
        .empty-state-hint { font-size: 13px; color: var(--text-tertiary); }

        /* 加载动画 */
        .spinner { border: 3px solid var(--bg-tertiary); border-top: 3px solid var(--primary-blue); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: var(--spacing-md); color: var(--text-secondary); }

        /* 布局 */
        .grid-2 { display: grid; grid-template-columns: 1fr 1.5fr; gap: var(--spacing-xl); }
        @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } }

        /* 操作按钮组 */
        .action-buttons { display: flex; gap: var(--spacing-sm); }

        /* 验证结果卡片 */
        .verify-card { margin-top: var(--spacing-lg); }
        .verify-success { border-left: 4px solid var(--success-green); }
        .verify-error { border-left: 4px solid var(--danger-red); }
        .balance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); margin-top: var(--spacing-lg); }
        .balance-item { background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); text-align: center; }
        .balance-label { font-size: 11px; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: var(--spacing-xs); }
        .balance-value { font-size: 18px; font-weight: 700; font-family: var(--font-mono); color: var(--text-primary); }

        /* 淡入动画 */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- 导航栏 -->
        <nav class="nav-container">
            <div class="nav-links">
                <div class="nav-brand">
                    <i class="bi bi-currency-bitcoin"></i> AlphaFlow
                </div>
                <a class="nav-link" href="/"><i class="bi bi-house"></i> 首页</a>
                <a class="nav-link" href="/dashboard"><i class="bi bi-speedometer2"></i> 仪表盘</a>
                <a class="nav-link" href="/futures-trading"><i class="bi bi-graph-up-arrow"></i> U本位合约</a>
                <a class="nav-link active" href="/api-keys"><i class="bi bi-key"></i> API密钥</a>
                <a href="/coin_futures_trading" class="nav-link">
                    <i class="bi bi-currency-bitcoin"></i> 币本位合约
                </a>
                <a class="nav-link" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 退出</a>
            </div>
        </nav>

        <!-- 页面标题 -->
        <div class="page-header">
            <h1 class="page-title"><i class="bi bi-shield-lock"></i> API密钥管理</h1>
            <p class="page-subtitle">配置您的交易所API密钥，实现自动化交易</p>
        </div>

        <!-- 安全提示 -->
        <div class="alert alert-info">
            <div class="alert-title"><i class="bi bi-info-circle-fill"></i> 安全提示</div>
            <ul>
                <li>API密钥将使用AES-256加密存储，确保安全</li>
                <li>建议只开启<strong>交易权限</strong>，不要开启提现权限</li>
                <li>定期更换API密钥以提高安全性</li>
                <li>建议在交易所设置IP白名单</li>
            </ul>
        </div>

        <div class="grid-2">
            <!-- 左侧：添加表单 -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-plus-circle"></i> 添加API密钥</h3>
                    </div>
                    <div class="card-body">
                        <form id="apiKeyForm">
                            <div class="form-group">
                                <label class="form-label">交易所</label>
                                <select class="form-control" id="exchange" required>
                                    <option value="binance">Binance 币安</option>
                                    <option value="gate">Gate.io (即将支持)</option>
                                    <option value="okx">OKX (即将支持)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">账户名称</label>
                                <input type="text" class="form-control" id="accountName"
                                       placeholder="例如：主账户、量化账户" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="apiKey"
                                       placeholder="输入您的 API Key" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" id="apiSecret"
                                       placeholder="输入您的 API Secret" required>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showSecret"
                                           onchange="toggleSecretVisibility()">
                                    <label class="form-check-label" for="showSecret">显示密钥</label>
                                </div>
                            </div>

                            <hr class="form-divider">
                            <div class="form-section-title">风控设置</div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">最大持仓 (USDT)</label>
                                    <input type="number" class="form-control" id="maxPositionValue"
                                           value="1000" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">最大日亏损 (USDT)</label>
                                    <input type="number" class="form-control" id="maxDailyLoss"
                                           value="100" min="0">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">最大杠杆</label>
                                    <input type="number" class="form-control" id="maxLeverage"
                                           value="10" min="1" max="125">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="form-check" style="margin-top: 8px;">
                                        <input class="form-check-input" type="checkbox" id="isTestnet">
                                        <label class="form-check-label" for="isTestnet">使用测试网</label>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="bi bi-save"></i> 保存API密钥
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 右侧：密钥列表 -->
            <div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-list-ul"></i> 已配置的API密钥</h3>
                        <button class="btn btn-outline btn-sm" onclick="loadApiKeys()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                    <div class="card-body" id="apiKeysList">
                        <div class="empty-state">
                            <div class="spinner"></div>
                            <p class="loading-text">加载中...</p>
                        </div>
                    </div>
                </div>

                <!-- 验证结果 -->
                <div class="card verify-card fade-in" id="verifyResultCard" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-check-circle"></i> 验证结果</h3>
                    </div>
                    <div class="card-body" id="verifyResult"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            if (!Auth.requireLogin()) {
                return;
            }
            loadApiKeys();
        });

        // 切换密钥显示
        function toggleSecretVisibility() {
            const input = document.getElementById('apiSecret');
            const checkbox = document.getElementById('showSecret');
            input.type = checkbox.checked ? 'text' : 'password';
        }

        // 加载API密钥列表
        async function loadApiKeys() {
            const container = document.getElementById('apiKeysList');
            container.innerHTML = '<div class="empty-state"><div class="spinner"></div><p class="loading-text">加载中...</p></div>';

            try {
                const response = await Auth.authFetch('/api/api-keys/list');
                const data = await response.json();

                if (data.success && data.api_keys) {
                    if (data.api_keys.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="bi bi-key"></i></div>
                                <p class="empty-state-text">暂无配置的API密钥</p>
                                <p class="empty-state-hint">在左侧添加您的交易所API密钥开始交易</p>
                            </div>
                        `;
                        return;
                    }

                    let html = '<div class="table-container"><table>';
                    html += `
                        <thead>
                            <tr>
                                <th>交易所</th>
                                <th>账户名称</th>
                                <th>状态</th>
                                <th>风控</th>
                                <th>最后使用</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    for (const key of data.api_keys) {
                        const statusBadge = key.status === 'active'
                            ? '<span class="badge badge-success">活跃</span>'
                            : '<span class="badge badge-danger">禁用</span>';
                        const testnetBadge = key.is_testnet
                            ? '<span class="badge badge-warning" style="margin-left: 6px;">测试网</span>'
                            : '';
                        const lastUsed = key.last_used_at
                            ? new Date(key.last_used_at).toLocaleString('zh-CN')
                            : '<span style="color: var(--text-tertiary);">从未使用</span>';
                        const riskInfo = `${key.max_leverage}x / ${key.max_position_value}U`;

                        html += `
                            <tr class="fade-in">
                                <td>
                                    <strong>${key.exchange.toUpperCase()}</strong>
                                    ${testnetBadge}
                                </td>
                                <td>${key.account_name}</td>
                                <td>${statusBadge}</td>
                                <td><span style="font-family: var(--font-mono); font-size: 12px;">${riskInfo}</span></td>
                                <td style="font-size: 12px;">${lastUsed}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-outline btn-icon" onclick="verifyApiKey(${key.id}, '${key.exchange}')" title="验证密钥">
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                        <button class="btn btn-danger btn-icon" onclick="deleteApiKey(${key.id}, '${key.account_name}')" title="删除">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }

                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${data.detail || '加载失败'}</div>`;
                }
            } catch (error) {
                console.error('加载API密钥失败:', error);
                container.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 加载失败: ${error.message}</div>`;
            }
        }

        // 保存API密钥
        document.getElementById('apiKeyForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> 保存中...';
            submitBtn.disabled = true;

            const data = {
                exchange: document.getElementById('exchange').value,
                account_name: document.getElementById('accountName').value,
                api_key: document.getElementById('apiKey').value,
                api_secret: document.getElementById('apiSecret').value,
                max_position_value: parseFloat(document.getElementById('maxPositionValue').value) || 1000,
                max_daily_loss: parseFloat(document.getElementById('maxDailyLoss').value) || 100,
                max_leverage: parseInt(document.getElementById('maxLeverage').value) || 10,
                is_testnet: document.getElementById('isTestnet').checked
            };

            try {
                const response = await Auth.authFetch('/api/api-keys/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    // 清空表单
                    document.getElementById('accountName').value = '';
                    document.getElementById('apiKey').value = '';
                    document.getElementById('apiSecret').value = '';
                    // 刷新列表
                    loadApiKeys();
                    showNotification('API密钥保存成功！', 'success');
                } else {
                    showNotification('保存失败: ' + (result.detail || result.error || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('保存API密钥失败:', error);
                showNotification('保存失败: ' + error.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // 验证API密钥
        async function verifyApiKey(keyId, exchange) {
            const resultCard = document.getElementById('verifyResultCard');
            const resultContainer = document.getElementById('verifyResult');

            resultCard.style.display = 'block';
            resultCard.className = 'card verify-card fade-in';
            resultContainer.innerHTML = '<div class="empty-state"><div class="spinner"></div><p class="loading-text">验证中...</p></div>';

            try {
                const response = await Auth.authFetch(`/api/api-keys/verify?exchange=${exchange}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    const balance = result.balance || {};
                    resultCard.classList.add('verify-success');
                    resultContainer.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle-fill"></i> API密钥验证成功！连接正常。
                        </div>
                        <div class="balance-grid">
                            <div class="balance-item">
                                <div class="balance-label">总余额</div>
                                <div class="balance-value">${parseFloat(balance.total_wallet_balance || 0).toFixed(2)}</div>
                            </div>
                            <div class="balance-item">
                                <div class="balance-label">可用余额</div>
                                <div class="balance-value">${parseFloat(balance.available_balance || 0).toFixed(2)}</div>
                            </div>
                            <div class="balance-item">
                                <div class="balance-label">未实现盈亏</div>
                                <div class="balance-value" style="color: ${parseFloat(balance.total_unrealized_pnl || 0) >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">
                                    ${parseFloat(balance.total_unrealized_pnl || 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultCard.classList.add('verify-error');
                    resultContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle-fill"></i> 验证失败: ${result.error || '未知错误'}
                        </div>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-top: var(--spacing-md);">
                            请检查：1. API密钥是否正确 2. 是否开启了合约交易权限 3. IP白名单设置
                        </p>
                    `;
                }
            } catch (error) {
                console.error('验证API密钥失败:', error);
                resultCard.classList.add('verify-error');
                resultContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle-fill"></i> 验证请求失败: ${error.message}
                    </div>
                `;
            }
        }

        // 删除API密钥
        async function deleteApiKey(keyId, accountName) {
            if (!confirm(`确定要删除 "${accountName}" 的API密钥吗？\n\n此操作不可恢复！`)) {
                return;
            }

            try {
                const response = await Auth.authFetch('/api/api-keys/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key_id: keyId })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('API密钥已删除', 'success');
                    loadApiKeys();
                    // 隐藏验证结果
                    document.getElementById('verifyResultCard').style.display = 'none';
                } else {
                    showNotification('删除失败: ' + (result.detail || result.error || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('删除API密钥失败:', error);
                showNotification('删除失败: ' + error.message, 'error');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                padding: 16px 24px; border-radius: 8px; font-size: 14px; font-weight: 500;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            `;

            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                notification.style.color = 'white';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
                notification.style.color = 'white';
            } else {
                notification.style.background = 'var(--bg-card)';
                notification.style.border = '1px solid var(--border-default)';
                notification.style.color = 'var(--text-primary)';
            }

            notification.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 退出登录
        async function logout() {
            await Auth.logout();
            window.location.href = '/login';
        }
    </script>

    <style>
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</body>
</html>
