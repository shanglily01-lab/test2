<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>48å°æ—¶ç­–ç•¥åˆ†æ - å‚æ•°ä¼˜åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-link {
            color: var(--accent-blue);
            text-decoration: none;
            margin-bottom: 20px;
            display: inline-block;
        }
        .back-link:hover { text-decoration: underline; }

        h1 {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .form-control {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        .btn-primary:hover { filter: brightness(1.1); }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-positive { color: var(--accent-green); }
        .stat-negative { color: var(--accent-red); }
        .stat-neutral { color: var(--accent-yellow); }

        /* å›¾è¡¨ */
        .chart-container {
            height: 400px;
            position: relative;
        }

        /* äº¤æ˜“è®°å½•è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-success { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .badge-danger { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .badge-warning { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .badge-info { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }

        /* å»ºè®®åˆ—è¡¨ */
        .suggestion {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .suggestion-warning {
            background: rgba(210, 153, 34, 0.1);
            border-left: 3px solid var(--accent-yellow);
        }

        .suggestion-success {
            background: rgba(63, 185, 80, 0.1);
            border-left: 3px solid var(--accent-green);
        }

        .suggestion-info {
            background: rgba(88, 166, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        .suggestion-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-content h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .suggestion-content p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* è¡Œæƒ…ç±»å‹ */
        .regime-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .regime-strong_uptrend { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .regime-weak_uptrend { background: rgba(63, 185, 80, 0.1); color: #7ee787; }
        .regime-ranging { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .regime-weak_downtrend { background: rgba(248, 81, 73, 0.1); color: #ffa198; }
        .regime-strong_downtrend { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ä¸¤æ å¸ƒå±€ */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: linear-gradient(135deg, #238636, #2ea043); }
        .toast.error { background: linear-gradient(135deg, #da3633, #f85149); }
        .toast.info { background: linear-gradient(135deg, #1f6feb, #388bfd); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* å‚æ•°å¯¹æ¯” */
        .param-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .param-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .param-item .label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .param-item .value {
            font-weight: 600;
            font-size: 14px;
        }

        /* ä¿¡å·æ ‡è®° */
        .signal-marker {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .signal-golden { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .signal-death { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
    </style>
</head>
<body>
    <div class="container">
        <a href="/futures_trading" class="back-link">&larr; è¿”å›åˆçº¦äº¤æ˜“</a>
        <h1>48å°æ—¶ç­–ç•¥åˆ†æä¸å‚æ•°ä¼˜åŒ–</h1>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">åˆ†æå‚æ•°</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="loadStrategies()">åŠ è½½ç­–ç•¥é…ç½®</button>
                    <button class="btn btn-primary" onclick="runAnalysis()">å¼€å§‹åˆ†æ</button>
                    <button class="btn btn-success" onclick="showLiveTradeDialog()" id="btn-live-trade" style="display: none;">
                        å®ç›˜äº¤æ˜“
                    </button>
                </div>
            </div>
            <div class="controls">
                <div class="form-group">
                    <label class="form-label">äº¤æ˜“å¯¹</label>
                    <select class="form-control" id="symbol">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Kçº¿å‘¨æœŸ</label>
                    <select class="form-control" id="timeframe">
                        <option value="5m">5åˆ†é’Ÿ</option>
                        <option value="15m" selected>15åˆ†é’Ÿ</option>
                        <option value="30m">30åˆ†é’Ÿ</option>
                        <option value="1h">1å°æ—¶</option>
                        <option value="4h">4å°æ—¶</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">åˆ†ææ—¶é•¿ï¼ˆå°æ—¶ï¼‰</label>
                    <select class="form-control" id="hours">
                        <option value="24">24å°æ—¶</option>
                        <option value="48" selected>48å°æ—¶</option>
                        <option value="72">72å°æ—¶</option>
                        <option value="168">7å¤©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">çŸ­æœŸEMA</label>
                    <input type="number" class="form-control" id="ema-short" value="9" min="3" max="50">
                </div>
                <div class="form-group">
                    <label class="form-label">é•¿æœŸEMA</label>
                    <input type="number" class="form-control" id="ema-long" value="26" min="10" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">æ­¢æŸ %</label>
                    <input type="number" class="form-control" id="stop-loss" value="2.5" step="0.1" min="0.5" max="10">
                </div>
                <div class="form-group">
                    <label class="form-label">æ­¢ç›ˆ %</label>
                    <input type="number" class="form-control" id="take-profit" value="4.0" step="0.1" min="1" max="20">
                </div>
            </div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div id="results" style="display: none;">
            <!-- æ•°æ®ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="card" style="background: linear-gradient(135deg, rgba(88, 166, 255, 0.1), rgba(63, 185, 80, 0.1));">
                <div class="card-header" style="border-bottom: none; padding-bottom: 8px;">
                    <span class="card-title" style="color: var(--accent-blue);">ğŸ“Š åˆ†ææ•°æ®èŒƒå›´</span>
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                    <div class="stat-card" style="background: var(--bg-secondary);">
                        <div class="stat-value stat-positive" id="data-klines">--</div>
                        <div class="stat-label">å®é™…Kçº¿æ•°é‡</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-secondary);">
                        <div class="stat-value" id="data-hours">--</div>
                        <div class="stat-label">è¦†ç›–æ—¶é•¿</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-secondary);">
                        <div class="stat-value" id="data-start">--</div>
                        <div class="stat-label">èµ·å§‹æ—¶é—´</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-secondary);">
                        <div class="stat-value" id="data-end">--</div>
                        <div class="stat-label">ç»“æŸæ—¶é—´</div>
                    </div>
                    <div class="stat-card" style="background: var(--bg-secondary);">
                        <div class="stat-value" id="data-completeness">--</div>
                        <div class="stat-label">æ•°æ®å®Œæ•´åº¦</div>
                    </div>
                </div>
            </div>

            <!-- è¡Œæƒ…æ¦‚è§ˆ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">è¡Œæƒ…æ¦‚è§ˆ</span>
                    <span id="regime-badge" class="regime-badge"></span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="price-change">--</div>
                        <div class="stat-label">ä»·æ ¼å˜åŒ–</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="volatility">--</div>
                        <div class="stat-label">æ³¢åŠ¨ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="golden-crosses">--</div>
                        <div class="stat-label">é‡‘å‰æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="death-crosses">--</div>
                        <div class="stat-label">æ­»å‰æ¬¡æ•°</div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å¼å¯¹æ¯” -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">å‡ºåœºæ¨¡å¼å¯¹æ¯”</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="btn-mode-fixed" onclick="switchMode('fixed')">å›ºå®šæ­¢ç›ˆæ­¢æŸ</button>
                        <button class="btn btn-primary" id="btn-mode-trend" onclick="switchMode('trend')">è¶‹åŠ¿è·Ÿè¸ª</button>
                    </div>
                </div>
                <div class="two-col" style="margin-bottom: 16px;">
                    <!-- å›ºå®šæ­¢ç›ˆæ­¢æŸæ¨¡å¼ -->
                    <div class="stat-card" style="border: 2px solid var(--border-color);" id="mode-fixed-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: var(--accent-yellow);">å›ºå®šæ­¢ç›ˆæ­¢æŸ</span>
                            <span class="badge badge-warning" id="fixed-winner-badge" style="display: none;">æ›´ä¼˜</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">åˆ°è¾¾å›ºå®šæ­¢ç›ˆ/æ­¢æŸä»·æ ¼æˆ–åå‘ä¿¡å·æ—¶å‡ºåœº</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="fixed-pnl">--</div>
                                <div class="stat-label">æ€»ç›ˆäº</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="fixed-winrate">--</div>
                                <div class="stat-label">èƒœç‡</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="fixed-trades">--</div>
                                <div class="stat-label">äº¤æ˜“æ•°</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">
                            å‡ºåœº: <span id="fixed-exits">æ­¢æŸ 0 / æ­¢ç›ˆ 0 / ä¿¡å· 0</span>
                        </div>
                    </div>
                    <!-- è¶‹åŠ¿è·Ÿè¸ªæ¨¡å¼ -->
                    <div class="stat-card" style="border: 2px solid var(--accent-green);" id="mode-trend-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: var(--accent-green);">è¶‹åŠ¿è·Ÿè¸ªï¼ˆæ¨èï¼‰</span>
                            <span class="badge badge-success" id="trend-winner-badge" style="display: none;">æ›´ä¼˜</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">åªåœ¨è¶‹åŠ¿åè½¬æ—¶å‡ºåœºï¼Œç§»åŠ¨æ­¢æŸä»…ä½œä¿æŠ¤</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="trend-pnl">--</div>
                                <div class="stat-label">æ€»ç›ˆäº</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="trend-winrate">--</div>
                                <div class="stat-label">èƒœç‡</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="trend-trades">--</div>
                                <div class="stat-label">äº¤æ˜“æ•°</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">
                            å‡ºåœº: <span id="trend-exits">è¶‹åŠ¿åè½¬ 0 / ç§»åŠ¨æ­¢æŸ 0</span>
                        </div>
                    </div>
                </div>
                <div id="mode-diff" style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <span style="color: var(--text-secondary);">å¯¹æ¯”å·®å¼‚: </span>
                    <span id="pnl-diff" style="font-weight: 600;">--</span>
                </div>
            </div>

            <!-- å½“å‰æ¨¡å¼äº¤æ˜“ç»Ÿè®¡ -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">å½“å‰æ¨¡å¼ç»Ÿè®¡ (<span id="current-mode-name">è¶‹åŠ¿è·Ÿè¸ª</span>)</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-trades">--</div>
                        <div class="stat-label">æ€»äº¤æ˜“æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-positive" id="win-rate">--</div>
                        <div class="stat-label">èƒœç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-pnl">--</div>
                        <div class="stat-label">æ€»ç›ˆäº</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-positive" id="avg-win">--</div>
                        <div class="stat-label">å¹³å‡ç›ˆåˆ©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-negative" id="avg-loss">--</div>
                        <div class="stat-label">å¹³å‡äºæŸ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="exit-breakdown">--</div>
                        <div class="stat-label">å‡ºåœºåˆ†å¸ƒ</div>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨å’Œå»ºè®® -->
            <div class="two-col">
                <!-- Kçº¿å›¾è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Kçº¿ä¸EMAèµ°åŠ¿</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- ä¼˜åŒ–å»ºè®® -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">ä¼˜åŒ–å»ºè®®</span>
                        <button class="btn btn-success" onclick="applyOptimizedParams()" id="btn-apply-optimized" style="display: none;">åº”ç”¨ä¼˜åŒ–å‚æ•°</button>
                    </div>
                    <!-- ä¼˜åŒ–å‚æ•°é¢„è§ˆ -->
                    <div id="optimized-params-preview" style="display: none; margin-bottom: 16px;">
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px;">
                            <div style="font-size: 13px; color: var(--accent-green); margin-bottom: 8px; font-weight: 600;">æ¨èå‚æ•°:</div>
                            <div class="param-comparison" id="param-changes">
                                <!-- åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                    <div id="suggestions">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“è®°å½• -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">æ¨¡æ‹Ÿäº¤æ˜“è®°å½•</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ç±»å‹</th>
                                <th>å…¥åœºæ—¶é—´</th>
                                <th>å…¥åœºä»·</th>
                                <th>å‡ºåœºæ—¶é—´</th>
                                <th>å‡ºåœºä»·</th>
                                <th>å‡ºåœºåŸå› </th>
                                <th>ç›ˆäº</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div id="loading" class="card" style="display: none;">
            <div class="loading">
                <div class="spinner"></div>
                <span>æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™...</span>
            </div>
        </div>
    </div>

    <script>
        let priceChart = null;
        let analysisData = null;
        let currentMode = 'trend';  // å½“å‰é€‰ä¸­çš„æ¨¡å¼

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadSymbols();
        });

        // åº”ç”¨å½“å‰åˆ†æç»“æœä¸­çš„ä¼˜åŒ–å‚æ•°
        function applyOptimizedParams() {
            if (!analysisData || !analysisData.optimized_params) {
                showToast('æ²¡æœ‰å¯åº”ç”¨çš„ä¼˜åŒ–å‚æ•°', 'error');
                return;
            }

            const opt = analysisData.optimized_params;

            document.getElementById('ema-short').value = opt.ema_short;
            document.getElementById('ema-long').value = opt.ema_long;
            document.getElementById('stop-loss').value = opt.stop_loss_pct;
            document.getElementById('take-profit').value = opt.take_profit_pct;

            // å¦‚æœæœ‰æ¨èçš„å‡ºåœºæ¨¡å¼
            if (opt.exit_mode) {
                switchMode(opt.exit_mode);
            }

            showToast('å·²åº”ç”¨ä¼˜åŒ–å‚æ•°ï¼Œç‚¹å‡»"å¼€å§‹åˆ†æ"é‡æ–°æµ‹è¯•', 'success');
        }

        // åˆ‡æ¢å‡ºåœºæ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;

            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('btn-mode-fixed').className = mode === 'fixed' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('btn-mode-trend').className = mode === 'trend' ? 'btn btn-primary' : 'btn btn-secondary';

            // æ›´æ–°å¡ç‰‡è¾¹æ¡†
            document.getElementById('mode-fixed-card').style.border = mode === 'fixed' ? '2px solid var(--accent-blue)' : '2px solid var(--border-color)';
            document.getElementById('mode-trend-card').style.border = mode === 'trend' ? '2px solid var(--accent-green)' : '2px solid var(--border-color)';

            // æ›´æ–°æ¨¡å¼åç§°
            document.getElementById('current-mode-name').textContent = mode === 'trend' ? 'è¶‹åŠ¿è·Ÿè¸ª' : 'å›ºå®šæ­¢ç›ˆæ­¢æŸ';

            // é‡æ–°æ¸²æŸ“ç»Ÿè®¡å’Œäº¤æ˜“è®°å½•
            if (analysisData) {
                const stats = mode === 'trend' ? analysisData.statistics_trend : analysisData.statistics_fixed;
                const trades = mode === 'trend' ? analysisData.trades_trend : analysisData.trades_fixed;
                renderStats(stats);
                renderTrades(trades);
            }
        }

        // åŠ è½½äº¤æ˜“å¯¹
        async function loadSymbols() {
            try {
                const resp = await fetch('/api/strategy-analyzer/symbols');
                const data = await resp.json();

                if (data.success && data.data.length > 0) {
                    const select = document.getElementById('symbol');
                    select.innerHTML = data.data.map(s =>
                        `<option value="${s}">${s}</option>`
                    ).join('');
                }
            } catch (e) {
                console.error('åŠ è½½äº¤æ˜“å¯¹å¤±è´¥:', e);
            }
        }

        // åŠ è½½ç­–ç•¥é…ç½®
        async function loadStrategies() {
            try {
                const resp = await fetch('/api/strategy-analyzer/strategies');
                const data = await resp.json();

                if (data.success && data.data.length > 0) {
                    // æ˜¾ç¤ºç­–ç•¥é€‰æ‹©å¯¹è¯æ¡†
                    const strategies = data.data;
                    let html = '<div style="padding: 20px;">';
                    html += '<h3 style="margin-bottom: 16px;">é€‰æ‹©ç­–ç•¥é…ç½®</h3>';
                    strategies.forEach(s => {
                        html += `
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer;"
                                 onclick="applyStrategy('${s.id}', ${s.stop_loss}, ${s.take_profit}, '${s.buy_timeframe}', ${s.ema_short}, ${s.ema_long}, '${s.symbols.join(',')}')">
                                <strong>${s.name}</strong>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    EMA: ${s.ema_short}/${s.ema_long} | æ­¢æŸ: ${s.stop_loss}% | æ­¢ç›ˆ: ${s.take_profit}% | å‘¨æœŸ: ${s.buy_timeframe}
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    äº¤æ˜“å¯¹: ${s.symbols.join(', ')}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    showDialog('åŠ è½½ç­–ç•¥é…ç½®', html);
                }
            } catch (e) {
                showToast('åŠ è½½ç­–ç•¥å¤±è´¥: ' + e.message, 'error');
            }
        }

        // åº”ç”¨ç­–ç•¥é…ç½®
        function applyStrategy(id, stopLoss, takeProfit, timeframe, emaShort, emaLong, symbolsStr) {
            document.getElementById('stop-loss').value = stopLoss;
            document.getElementById('take-profit').value = takeProfit;
            document.getElementById('timeframe').value = timeframe;
            document.getElementById('ema-short').value = emaShort;
            document.getElementById('ema-long').value = emaLong;

            // å°è¯•è®¾ç½®ç¬¬ä¸€ä¸ªäº¤æ˜“å¯¹
            if (symbolsStr) {
                const symbols = symbolsStr.split(',');
                const symbolSelect = document.getElementById('symbol');
                const options = Array.from(symbolSelect.options);
                for (const sym of symbols) {
                    const match = options.find(o => o.value === sym.trim());
                    if (match) {
                        symbolSelect.value = sym.trim();
                        break;
                    }
                }
            }

            closeDialog();
            showToast('å·²åŠ è½½ç­–ç•¥é…ç½®ï¼Œç‚¹å‡»"å¼€å§‹åˆ†æ"', 'success');
        }

        // è¿è¡Œåˆ†æ
        async function runAnalysis() {
            const symbol = document.getElementById('symbol').value;
            if (!symbol) {
                showToast('è¯·é€‰æ‹©äº¤æ˜“å¯¹', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const params = new URLSearchParams({
                    symbol: symbol,
                    timeframe: document.getElementById('timeframe').value,
                    hours: document.getElementById('hours').value,
                    ema_short: document.getElementById('ema-short').value,
                    ema_long: document.getElementById('ema-long').value,
                    stop_loss_pct: document.getElementById('stop-loss').value,
                    take_profit_pct: document.getElementById('take-profit').value
                });

                const resp = await fetch(`/api/strategy-analyzer/analyze?${params}`);
                const data = await resp.json();

                if (data.success) {
                    analysisData = data.data;
                    renderResults(data.data);
                } else {
                    showToast(data.error || 'åˆ†æå¤±è´¥', 'error');
                }
            } catch (e) {
                showToast('åˆ†æè¯·æ±‚å¤±è´¥: ' + e.message, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // æ¸²æŸ“ç»“æœ
        function renderResults(data) {
            document.getElementById('results').style.display = 'block';
            // æ˜¾ç¤ºå®ç›˜äº¤æ˜“æŒ‰é’®
            document.getElementById('btn-live-trade').style.display = 'inline-block';

            // æ•°æ®ç»Ÿè®¡ä¿¡æ¯
            renderDataStats(data.data_stats);

            // è¡Œæƒ…æ¦‚è§ˆ
            const regime = data.regime;
            const regimeBadge = document.getElementById('regime-badge');
            regimeBadge.className = `regime-badge regime-${regime.type}`;
            regimeBadge.textContent = regime.name;

            document.getElementById('price-change').textContent = `${regime.price_change_pct > 0 ? '+' : ''}${regime.price_change_pct}%`;
            document.getElementById('price-change').className = `stat-value ${regime.price_change_pct >= 0 ? 'stat-positive' : 'stat-negative'}`;

            document.getElementById('volatility').textContent = `${regime.volatility}%`;
            document.getElementById('golden-crosses').textContent = data.signals.golden_crosses;
            document.getElementById('death-crosses').textContent = data.signals.death_crosses;

            // æ¨¡å¼å¯¹æ¯”
            renderModeComparison(data);

            // å½“å‰æ¨¡å¼ç»Ÿè®¡
            const stats = currentMode === 'trend' ? data.statistics_trend : data.statistics_fixed;
            renderStats(stats);

            // ä¼˜åŒ–å»ºè®®å’Œå‚æ•°é¢„è§ˆ
            renderSuggestions(data.suggestions);
            renderOptimizedParams(data);

            // äº¤æ˜“è®°å½•
            const trades = currentMode === 'trend' ? data.trades_trend : data.trades_fixed;
            renderTrades(trades);

            // å›¾è¡¨
            renderChart(data.klines);
        }

        // æ¸²æŸ“æ•°æ®ç»Ÿè®¡ä¿¡æ¯
        function renderDataStats(stats) {
            if (!stats) return;

            document.getElementById('data-klines').textContent = `${stats.total_klines} æ¡`;
            document.getElementById('data-hours').textContent = `${stats.hours_covered} å°æ—¶`;
            document.getElementById('data-start').textContent = stats.start_time;
            document.getElementById('data-end').textContent = stats.end_time;

            const completeness = stats.data_completeness;
            const completenessEl = document.getElementById('data-completeness');
            completenessEl.textContent = `${completeness}%`;
            completenessEl.className = `stat-value ${completeness >= 90 ? 'stat-positive' : completeness >= 70 ? 'stat-neutral' : 'stat-negative'}`;
        }

        // æ¸²æŸ“ä¼˜åŒ–å‚æ•°é¢„è§ˆï¼ˆä¸è‡ªåŠ¨å¡«å…¥ï¼Œéœ€ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»åº”ç”¨ï¼‰
        function renderOptimizedParams(data) {
            const current = data.current_params;
            const optimized = data.optimized_params;

            // æ£€æŸ¥æ˜¯å¦æœ‰å‚æ•°å˜åŒ–
            const hasChanges = optimized.ema_short !== current.ema_short ||
                              optimized.ema_long !== current.ema_long ||
                              optimized.stop_loss_pct !== current.stop_loss_pct ||
                              optimized.take_profit_pct !== current.take_profit_pct ||
                              optimized.exit_mode;

            if (!hasChanges) {
                document.getElementById('optimized-params-preview').style.display = 'none';
                document.getElementById('btn-apply-optimized').style.display = 'none';
                return;
            }

            // æ˜¾ç¤ºæŒ‰é’®
            document.getElementById('btn-apply-optimized').style.display = 'inline-block';
            document.getElementById('optimized-params-preview').style.display = 'block';

            // ç”Ÿæˆå‚æ•°å˜åŒ–å¯¹æ¯”
            let html = '';
            const paramLabels = {
                'ema_short': 'çŸ­æœŸEMA',
                'ema_long': 'é•¿æœŸEMA',
                'stop_loss_pct': 'æ­¢æŸ %',
                'take_profit_pct': 'æ­¢ç›ˆ %'
            };

            ['ema_short', 'ema_long', 'stop_loss_pct', 'take_profit_pct'].forEach(key => {
                const oldVal = current[key];
                const newVal = optimized[key];
                const changed = oldVal !== newVal;

                html += `<div class="param-item">
                    <span class="label">${paramLabels[key]}</span>
                    <span class="value">
                        ${changed ?
                            `<span style="text-decoration: line-through; color: var(--text-secondary);">${oldVal}</span>
                             <span style="color: var(--accent-green);"> â†’ ${newVal}</span>` :
                            oldVal
                        }
                    </span>
                </div>`;
            });

            // å¦‚æœæœ‰å‡ºåœºæ¨¡å¼å»ºè®®
            if (optimized.exit_mode) {
                const modeLabel = optimized.exit_mode === 'trend' ? 'è¶‹åŠ¿è·Ÿè¸ª' : 'å›ºå®šæ­¢ç›ˆæ­¢æŸ';
                html += `<div class="param-item">
                    <span class="label">æ¨èå‡ºåœºæ¨¡å¼</span>
                    <span class="value" style="color: var(--accent-green);">${modeLabel}</span>
                </div>`;
            }

            // å¦‚æœæœ‰è¡Œæƒ…è¿‡æ»¤å»ºè®®
            if (optimized.sustainedTrend_enabled) {
                html += `<div class="param-item">
                    <span class="label">è¡Œæƒ…è¿‡æ»¤</span>
                    <span class="value" style="color: var(--accent-yellow);">å»ºè®®å¯ç”¨ sustainedTrend</span>
                </div>`;
            }

            document.getElementById('param-changes').innerHTML = html;
        }

        // æ¸²æŸ“æ¨¡å¼å¯¹æ¯”
        function renderModeComparison(data) {
            const comp = data.mode_comparison;
            const statsFixed = data.statistics_fixed;
            const statsTrend = data.statistics_trend;

            // å›ºå®šæ¨¡å¼ç»Ÿè®¡
            const fixedPnl = document.getElementById('fixed-pnl');
            fixedPnl.textContent = `${comp.fixed.total_pnl > 0 ? '+' : ''}${comp.fixed.total_pnl}%`;
            fixedPnl.className = `stat-value ${comp.fixed.total_pnl >= 0 ? 'stat-positive' : 'stat-negative'}`;
            document.getElementById('fixed-winrate').textContent = `${comp.fixed.win_rate}%`;
            document.getElementById('fixed-trades').textContent = comp.fixed.trades;
            document.getElementById('fixed-exits').textContent = `æ­¢æŸ ${statsFixed.stop_loss_exits} / æ­¢ç›ˆ ${statsFixed.take_profit_exits} / ä¿¡å· ${statsFixed.signal_exits}`;

            // è¶‹åŠ¿è·Ÿè¸ªæ¨¡å¼ç»Ÿè®¡
            const trendPnl = document.getElementById('trend-pnl');
            trendPnl.textContent = `${comp.trend.total_pnl > 0 ? '+' : ''}${comp.trend.total_pnl}%`;
            trendPnl.className = `stat-value ${comp.trend.total_pnl >= 0 ? 'stat-positive' : 'stat-negative'}`;
            document.getElementById('trend-winrate').textContent = `${comp.trend.win_rate}%`;
            document.getElementById('trend-trades').textContent = comp.trend.trades;
            document.getElementById('trend-exits').textContent = `è¶‹åŠ¿åè½¬ ${statsTrend.trend_reverse_exits} / ç§»åŠ¨æ­¢æŸ ${statsTrend.trailing_stop_exits}`;

            // æ˜¾ç¤ºæ›´ä¼˜æ ‡ç­¾
            document.getElementById('fixed-winner-badge').style.display = comp.better_mode === 'fixed' ? 'inline' : 'none';
            document.getElementById('trend-winner-badge').style.display = comp.better_mode === 'trend' ? 'inline' : 'none';

            // å¯¹æ¯”å·®å¼‚
            const diffEl = document.getElementById('pnl-diff');
            const diff = comp.pnl_diff;
            const betterName = comp.better_mode === 'trend' ? 'è¶‹åŠ¿è·Ÿè¸ª' : 'å›ºå®šæ­¢ç›ˆæ­¢æŸ';
            diffEl.textContent = `${betterName} å¤šèµš ${diff}%`;
            diffEl.className = comp.better_mode === 'trend' ? 'stat-positive' : 'stat-neutral';
        }

        // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
        function renderStats(stats) {
            document.getElementById('total-trades').textContent = stats.total_trades;

            const winRateEl = document.getElementById('win-rate');
            winRateEl.textContent = `${stats.win_rate}%`;
            winRateEl.className = `stat-value ${stats.win_rate >= 50 ? 'stat-positive' : 'stat-negative'}`;

            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = `${stats.total_pnl_pct > 0 ? '+' : ''}${stats.total_pnl_pct}%`;
            pnlEl.className = `stat-value ${stats.total_pnl_pct >= 0 ? 'stat-positive' : 'stat-negative'}`;

            document.getElementById('avg-win').textContent = `+${stats.avg_win_pct}%`;
            document.getElementById('avg-loss').textContent = `${stats.avg_loss_pct}%`;

            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„å‡ºåœºåˆ†å¸ƒ
            if (currentMode === 'trend') {
                document.getElementById('exit-breakdown').textContent = `åè½¬${stats.trend_reverse_exits}/æ­¢æŸ${stats.trailing_stop_exits}`;
            } else {
                document.getElementById('exit-breakdown').textContent = `æ­¢æŸ${stats.stop_loss_exits}/æ­¢ç›ˆ${stats.take_profit_exits}/ä¿¡å·${stats.signal_exits}`;
            }
        }

        // æ¸²æŸ“å»ºè®®
        function renderSuggestions(suggestions) {
            const container = document.getElementById('suggestions');

            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = `
                    <div class="suggestion suggestion-success">
                        <span class="suggestion-icon">âœ“</span>
                        <div class="suggestion-content">
                            <h4>å‚æ•°è¡¨ç°è‰¯å¥½</h4>
                            <p>å½“å‰å‚æ•°é…ç½®åœ¨è¯¥æ—¶é—´æ®µè¡¨ç°ä¸é”™ï¼Œæ— éœ€è°ƒæ•´</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = suggestions.map(s => {
                const icons = { warning: 'âš ', success: 'âœ“', info: 'â„¹' };
                return `
                    <div class="suggestion suggestion-${s.type}">
                        <span class="suggestion-icon">${icons[s.type] || 'â„¹'}</span>
                        <div class="suggestion-content">
                            <h4>${s.title}</h4>
                            <p>${s.content}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“äº¤æ˜“è®°å½•
        function renderTrades(trades) {
            const tbody = document.getElementById('trades-table');

            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = trades.map(t => {
                const exitReasons = {
                    'STOP_LOSS': 'æ­¢æŸ',
                    'TAKE_PROFIT': 'æ­¢ç›ˆ',
                    'SIGNAL_EXIT': 'ä¿¡å·å‡ºåœº',
                    'TREND_REVERSE': 'è¶‹åŠ¿åè½¬',
                    'TRAILING_STOP': 'ç§»åŠ¨æ­¢æŸ'
                };
                const exitClass = {
                    'STOP_LOSS': 'badge-danger',
                    'TAKE_PROFIT': 'badge-success',
                    'SIGNAL_EXIT': 'badge-info',
                    'TREND_REVERSE': 'badge-warning',
                    'TRAILING_STOP': 'badge-danger'
                };

                // æ˜¾ç¤ºæœ€å¤§ç›ˆåˆ©ï¼ˆè¶‹åŠ¿è·Ÿè¸ªæ¨¡å¼ï¼‰
                const maxProfit = t.max_profit !== undefined ? `<br><span style="font-size:11px;color:var(--text-secondary);">æœ€é«˜${t.max_profit}%</span>` : '';

                return `
                    <tr>
                        <td><span class="badge ${t.type === 'LONG' ? 'badge-success' : 'badge-danger'}">${t.type === 'LONG' ? 'åšå¤š' : 'åšç©º'}</span></td>
                        <td>${t.entry_time}</td>
                        <td>${t.entry_price}</td>
                        <td>${t.exit_time}</td>
                        <td>${t.exit_price}</td>
                        <td><span class="badge ${exitClass[t.exit_reason] || 'badge-info'}">${exitReasons[t.exit_reason] || t.exit_reason}</span></td>
                        <td class="${t.pnl_pct >= 0 ? 'stat-positive' : 'stat-negative'}">${t.pnl_pct > 0 ? '+' : ''}${t.pnl_pct}%${maxProfit}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(klines) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            if (priceChart) {
                priceChart.destroy();
            }

            const labels = klines.map(k => k.timestamp.split(' ')[1] || k.timestamp);
            const closeData = klines.map(k => k.close);
            const emaShortData = klines.map(k => k.ema_short);
            const emaLongData = klines.map(k => k.ema_long);

            // æ‰¾å‡ºä¿¡å·ç‚¹
            const goldenCrossPoints = [];
            const deathCrossPoints = [];
            klines.forEach((k, i) => {
                if (k.signal === 1) {
                    goldenCrossPoints.push({ x: i, y: k.close });
                } else if (k.signal === -1) {
                    deathCrossPoints.push({ x: i, y: k.close });
                }
            });

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¶ç›˜ä»·',
                            data: closeData,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: `EMA${document.getElementById('ema-short').value}`,
                            data: emaShortData,
                            borderColor: '#3fb950',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: `EMA${document.getElementById('ema-long').value}`,
                            data: emaLongData,
                            borderColor: '#f85149',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#c9d1d9',
                            bodyColor: '#8b949e',
                            borderColor: '#30363d',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e', maxRotation: 45 },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        },
                        y: {
                            ticks: { color: '#8b949e' },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        }
                    }
                }
            });
        }

        // Toasté€šçŸ¥
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // å¯¹è¯æ¡†
        let currentDialog = null;

        function showDialog(title, content) {
            if (currentDialog) closeDialog();

            const overlay = document.createElement('div');
            overlay.id = 'dialog-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            overlay.innerHTML = `
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px;">${title}</h3>
                        <button onclick="closeDialog()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px;">&times;</button>
                    </div>
                    ${content}
                </div>
            `;

            document.body.appendChild(overlay);
            currentDialog = overlay;

            overlay.onclick = (e) => {
                if (e.target === overlay) closeDialog();
            };
        }

        function closeDialog() {
            if (currentDialog) {
                currentDialog.remove();
                currentDialog = null;
            }
        }

        // ==================== å®ç›˜äº¤æ˜“åŠŸèƒ½ ====================

        let liveTradeCurrentPrice = 0;

        // æ˜¾ç¤ºå®ç›˜äº¤æ˜“å¯¹è¯æ¡†
        async function showLiveTradeDialog() {
            if (!analysisData) {
                showToast('è¯·å…ˆè¿è¡Œåˆ†æ', 'error');
                return;
            }

            const symbol = document.getElementById('symbol').value;
            const stopLoss = document.getElementById('stop-loss').value;
            const takeProfit = document.getElementById('take-profit').value;

            // è·å–å½“å‰ä»·æ ¼
            try {
                const priceResp = await fetch(`/api/live-trading/price?symbol=${encodeURIComponent(symbol)}`);
                const priceData = await priceResp.json();
                if (priceData.success) {
                    liveTradeCurrentPrice = priceData.data.price;
                }
            } catch (e) {
                console.error('è·å–ä»·æ ¼å¤±è´¥:', e);
            }

            const html = `
                <div style="padding: 20px; min-width: 400px;">
                    <div style="background: rgba(248, 81, 73, 0.1); border: 1px solid var(--accent-red); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="color: var(--accent-red); font-weight: 600; margin-bottom: 4px;">âš ï¸ å®ç›˜äº¤æ˜“è­¦å‘Š</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">æ­¤æ“ä½œå°†ä½¿ç”¨çœŸå®èµ„é‡‘è¿›è¡Œäº¤æ˜“ï¼Œè¯·è°¨æ…æ“ä½œï¼</div>
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">äº¤æ˜“å¯¹</label>
                        <input type="text" class="form-control" id="live-symbol" value="${symbol}" readonly style="background: var(--bg-primary);">
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">å½“å‰ä»·æ ¼</label>
                        <input type="text" class="form-control" id="live-current-price" value="${liveTradeCurrentPrice.toFixed(4)}" readonly style="background: var(--bg-primary);">
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">äº¤æ˜“æ–¹å‘</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" id="btn-direction-long" onclick="setLiveDirection('LONG')" style="flex: 1;">åšå¤š LONG</button>
                            <button class="btn btn-secondary" id="btn-direction-short" onclick="setLiveDirection('SHORT')" style="flex: 1;">åšç©º SHORT</button>
                        </div>
                        <input type="hidden" id="live-direction" value="LONG">
                    </div>

                    <div class="form-group" style="margin-bottom: 16px;">
                        <label class="form-label">è®¢å•ç±»å‹</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" id="btn-order-market" onclick="setLiveOrderType('market')" style="flex: 1;">å¸‚ä»·å•</button>
                            <button class="btn btn-secondary" id="btn-order-limit" onclick="setLiveOrderType('limit')" style="flex: 1;">é™ä»·å•</button>
                        </div>
                        <input type="hidden" id="live-order-type" value="market">
                    </div>

                    <div class="form-group" style="margin-bottom: 16px; display: none;" id="limit-price-group">
                        <label class="form-label">é™ä»·ä»·æ ¼</label>
                        <input type="number" class="form-control" id="live-limit-price" value="${liveTradeCurrentPrice.toFixed(4)}" step="0.0001">
                        <small style="color: var(--warning-yellow); display: block; margin-top: 4px;">
                            <i class="bi bi-exclamation-triangle"></i> é™ä»·å•ä¼šæäº¤åˆ°å¸å®‰ï¼Œè‹¥è¶‹åŠ¿è½¬å‘å°†è‡ªåŠ¨å–æ¶ˆ
                        </small>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label class="form-label">å¼€ä»“æ•°é‡</label>
                            <input type="number" class="form-control" id="live-quantity" value="0.001" step="0.001" min="0.001">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ æ†å€æ•°</label>
                            <select class="form-control" id="live-leverage">
                                <option value="5">5x</option>
                                <option value="10" selected>10x</option>
                                <option value="20">20x</option>
                                <option value="50">50x</option>
                            </select>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div class="form-group">
                            <label class="form-label">æ­¢æŸ %</label>
                            <input type="number" class="form-control" id="live-stop-loss" value="${stopLoss}" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ­¢ç›ˆ %</label>
                            <input type="number" class="form-control" id="live-take-profit" value="${takeProfit}" step="0.1">
                        </div>
                    </div>

                    <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">é¢„è®¡ä¿è¯é‡‘</span>
                            <span id="live-margin-estimate">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">æ­¢æŸä»·æ ¼</span>
                            <span id="live-sl-price" style="color: var(--accent-red);">--</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">æ­¢ç›ˆä»·æ ¼</span>
                            <span id="live-tp-price" style="color: var(--accent-green);">--</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="closeDialog()" style="flex: 1;">å–æ¶ˆ</button>
                        <button class="btn btn-success" onclick="executeLiveTrade()" style="flex: 1;">ç¡®è®¤ä¸‹å•</button>
                    </div>
                </div>
            `;

            showDialog('å®ç›˜äº¤æ˜“', html);

            // ç»‘å®šè¾“å…¥äº‹ä»¶è®¡ç®—é¢„ä¼°å€¼
            setTimeout(() => {
                const inputs = ['live-quantity', 'live-leverage', 'live-stop-loss', 'live-take-profit', 'live-limit-price', 'live-direction'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', updateLiveTradeEstimate);
                        el.addEventListener('input', updateLiveTradeEstimate);
                    }
                });
                updateLiveTradeEstimate();
            }, 100);
        }

        // è®¾ç½®äº¤æ˜“æ–¹å‘
        function setLiveDirection(direction) {
            document.getElementById('live-direction').value = direction;
            document.getElementById('btn-direction-long').className = direction === 'LONG' ? 'btn btn-success' : 'btn btn-secondary';
            document.getElementById('btn-direction-short').className = direction === 'SHORT' ? 'btn btn-danger' : 'btn btn-secondary';
            updateLiveTradeEstimate();
        }

        // è®¾ç½®è®¢å•ç±»å‹
        function setLiveOrderType(type) {
            document.getElementById('live-order-type').value = type;
            document.getElementById('btn-order-market').className = type === 'market' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('btn-order-limit').className = type === 'limit' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('limit-price-group').style.display = type === 'limit' ? 'block' : 'none';
            updateLiveTradeEstimate();
        }

        // æ›´æ–°é¢„ä¼°å€¼
        function updateLiveTradeEstimate() {
            const orderType = document.getElementById('live-order-type').value;
            const price = orderType === 'limit' ?
                parseFloat(document.getElementById('live-limit-price').value) :
                liveTradeCurrentPrice;
            const quantity = parseFloat(document.getElementById('live-quantity').value) || 0;
            const leverage = parseInt(document.getElementById('live-leverage').value) || 10;
            const stopLossPct = parseFloat(document.getElementById('live-stop-loss').value) || 0;
            const takeProfitPct = parseFloat(document.getElementById('live-take-profit').value) || 0;
            const direction = document.getElementById('live-direction').value;

            // è®¡ç®—ä¿è¯é‡‘
            const positionValue = price * quantity;
            const margin = positionValue / leverage;
            document.getElementById('live-margin-estimate').textContent = `${margin.toFixed(4)} USDT`;

            // è®¡ç®—æ­¢æŸæ­¢ç›ˆä»·æ ¼
            let slPrice, tpPrice;
            if (direction === 'LONG') {
                slPrice = price * (1 - stopLossPct / 100);
                tpPrice = price * (1 + takeProfitPct / 100);
            } else {
                slPrice = price * (1 + stopLossPct / 100);
                tpPrice = price * (1 - takeProfitPct / 100);
            }

            document.getElementById('live-sl-price').textContent = slPrice.toFixed(4);
            document.getElementById('live-tp-price').textContent = tpPrice.toFixed(4);
        }

        // æ‰§è¡Œå®ç›˜äº¤æ˜“
        async function executeLiveTrade() {
            const symbol = document.getElementById('live-symbol').value;
            const direction = document.getElementById('live-direction').value;
            const orderType = document.getElementById('live-order-type').value;
            const quantity = parseFloat(document.getElementById('live-quantity').value);
            const leverage = parseInt(document.getElementById('live-leverage').value);
            const stopLossPct = parseFloat(document.getElementById('live-stop-loss').value);
            const takeProfitPct = parseFloat(document.getElementById('live-take-profit').value);
            const limitPrice = orderType === 'limit' ? parseFloat(document.getElementById('live-limit-price').value) : null;

            // ç¡®è®¤å¯¹è¯æ¡†
            const orderTypeText = orderType === 'market' ? 'å¸‚ä»·å•' : `é™ä»·å• @ ${limitPrice}`;
            const confirmMsg = `ç¡®è®¤ä»¥ä¸‹äº¤æ˜“ï¼Ÿ\n\näº¤æ˜“å¯¹: ${symbol}\næ–¹å‘: ${direction === 'LONG' ? 'åšå¤š' : 'åšç©º'}\nç±»å‹: ${orderTypeText}\næ•°é‡: ${quantity}\næ æ†: ${leverage}x\næ­¢æŸ: ${stopLossPct}%\næ­¢ç›ˆ: ${takeProfitPct}%`;

            if (!confirm(confirmMsg)) {
                return;
            }

            closeDialog();
            showToast('æ­£åœ¨æäº¤è®¢å•...', 'info');

            try {
                const requestBody = {
                    symbol: symbol,
                    position_side: direction,
                    quantity: quantity,
                    leverage: leverage,
                    stop_loss_pct: stopLossPct,
                    take_profit_pct: takeProfitPct,
                    source: 'strategy_analyzer'
                };

                if (limitPrice) {
                    requestBody.limit_price = limitPrice;
                }

                const resp = await fetch('/api/live-trading/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const result = await resp.json();

                if (result.success) {
                    showToast(`å¼€ä»“æˆåŠŸï¼${result.message || ''}`, 'success');
                } else {
                    showToast(`å¼€ä»“å¤±è´¥: ${result.detail || result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                showToast(`è¯·æ±‚å¤±è´¥: ${e.message}`, 'error');
            }
        }
    </script>
</body>
</html>
