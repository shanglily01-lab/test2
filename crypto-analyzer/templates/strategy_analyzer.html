<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>48小时策略分析 - 参数优化</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-link {
            color: var(--accent-blue);
            text-decoration: none;
            margin-bottom: 20px;
            display: inline-block;
        }
        .back-link:hover { text-decoration: underline; }

        h1 {
            font-size: 24px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 控制面板 */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .form-control {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        .btn-primary:hover { filter: brightness(1.1); }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-positive { color: var(--accent-green); }
        .stat-negative { color: var(--accent-red); }
        .stat-neutral { color: var(--accent-yellow); }

        /* 图表 */
        .chart-container {
            height: 400px;
            position: relative;
        }

        /* 交易记录表格 */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-success { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .badge-danger { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .badge-warning { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .badge-info { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }

        /* 建议列表 */
        .suggestion {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .suggestion-warning {
            background: rgba(210, 153, 34, 0.1);
            border-left: 3px solid var(--accent-yellow);
        }

        .suggestion-success {
            background: rgba(63, 185, 80, 0.1);
            border-left: 3px solid var(--accent-green);
        }

        .suggestion-info {
            background: rgba(88, 166, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        .suggestion-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .suggestion-content h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .suggestion-content p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* 行情类型 */
        .regime-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .regime-strong_uptrend { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .regime-weak_uptrend { background: rgba(63, 185, 80, 0.1); color: #7ee787; }
        .regime-ranging { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .regime-weak_downtrend { background: rgba(248, 81, 73, 0.1); color: #ffa198; }
        .regime-strong_downtrend { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }

        /* 加载动画 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 两栏布局 */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: linear-gradient(135deg, #238636, #2ea043); }
        .toast.error { background: linear-gradient(135deg, #da3633, #f85149); }
        .toast.info { background: linear-gradient(135deg, #1f6feb, #388bfd); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* 参数对比 */
        .param-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
        }

        .param-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .param-item .label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .param-item .value {
            font-weight: 600;
            font-size: 14px;
        }

        /* 信号标记 */
        .signal-marker {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .signal-golden { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .signal-death { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
    </style>
</head>
<body>
    <div class="container">
        <a href="/futures_trading" class="back-link">&larr; 返回合约交易</a>
        <h1>48小时策略分析与参数优化</h1>

        <!-- 控制面板 -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">分析参数</span>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="loadStrategies()">加载策略配置</button>
                    <button class="btn btn-secondary" onclick="loadSavedParams()" id="btn-load-saved" style="display: none;">加载优化参数</button>
                    <button class="btn btn-primary" onclick="runAnalysis()">开始分析</button>
                </div>
            </div>
            <div class="controls">
                <div class="form-group">
                    <label class="form-label">交易对</label>
                    <select class="form-control" id="symbol">
                        <option value="">加载中...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">K线周期</label>
                    <select class="form-control" id="timeframe">
                        <option value="5m">5分钟</option>
                        <option value="15m" selected>15分钟</option>
                        <option value="30m">30分钟</option>
                        <option value="1h">1小时</option>
                        <option value="4h">4小时</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">分析时长（小时）</label>
                    <select class="form-control" id="hours">
                        <option value="24">24小时</option>
                        <option value="48" selected>48小时</option>
                        <option value="72">72小时</option>
                        <option value="168">7天</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">短期EMA</label>
                    <input type="number" class="form-control" id="ema-short" value="9" min="3" max="50">
                </div>
                <div class="form-group">
                    <label class="form-label">长期EMA</label>
                    <input type="number" class="form-control" id="ema-long" value="26" min="10" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">止损 %</label>
                    <input type="number" class="form-control" id="stop-loss" value="2.5" step="0.1" min="0.5" max="10">
                </div>
                <div class="form-group">
                    <label class="form-label">止盈 %</label>
                    <input type="number" class="form-control" id="take-profit" value="4.0" step="0.1" min="1" max="20">
                </div>
            </div>
        </div>

        <!-- 结果区域 -->
        <div id="results" style="display: none;">
            <!-- 行情概览 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">行情概览</span>
                    <span id="regime-badge" class="regime-badge"></span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="price-change">--</div>
                        <div class="stat-label">价格变化</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="volatility">--</div>
                        <div class="stat-label">波动率</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="golden-crosses">--</div>
                        <div class="stat-label">金叉次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="death-crosses">--</div>
                        <div class="stat-label">死叉次数</div>
                    </div>
                </div>
            </div>

            <!-- 模式对比 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">出场模式对比</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" id="btn-mode-fixed" onclick="switchMode('fixed')">固定止盈止损</button>
                        <button class="btn btn-primary" id="btn-mode-trend" onclick="switchMode('trend')">趋势跟踪</button>
                    </div>
                </div>
                <div class="two-col" style="margin-bottom: 16px;">
                    <!-- 固定止盈止损模式 -->
                    <div class="stat-card" style="border: 2px solid var(--border-color);" id="mode-fixed-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: var(--accent-yellow);">固定止盈止损</span>
                            <span class="badge badge-warning" id="fixed-winner-badge" style="display: none;">更优</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">到达固定止盈/止损价格或反向信号时出场</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="fixed-pnl">--</div>
                                <div class="stat-label">总盈亏</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="fixed-winrate">--</div>
                                <div class="stat-label">胜率</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="fixed-trades">--</div>
                                <div class="stat-label">交易数</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">
                            出场: <span id="fixed-exits">止损 0 / 止盈 0 / 信号 0</span>
                        </div>
                    </div>
                    <!-- 趋势跟踪模式 -->
                    <div class="stat-card" style="border: 2px solid var(--accent-green);" id="mode-trend-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-weight: 600; color: var(--accent-green);">趋势跟踪（推荐）</span>
                            <span class="badge badge-success" id="trend-winner-badge" style="display: none;">更优</span>
                        </div>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">只在趋势反转时出场，移动止损仅作保护</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center;">
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="trend-pnl">--</div>
                                <div class="stat-label">总盈亏</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="trend-winrate">--</div>
                                <div class="stat-label">胜率</div>
                            </div>
                            <div>
                                <div class="stat-value" style="font-size: 18px;" id="trend-trades">--</div>
                                <div class="stat-label">交易数</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: var(--text-secondary);">
                            出场: <span id="trend-exits">趋势反转 0 / 移动止损 0</span>
                        </div>
                    </div>
                </div>
                <div id="mode-diff" style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <span style="color: var(--text-secondary);">对比差异: </span>
                    <span id="pnl-diff" style="font-weight: 600;">--</span>
                </div>
            </div>

            <!-- 当前模式交易统计 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">当前模式统计 (<span id="current-mode-name">趋势跟踪</span>)</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-trades">--</div>
                        <div class="stat-label">总交易次数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-positive" id="win-rate">--</div>
                        <div class="stat-label">胜率</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-pnl">--</div>
                        <div class="stat-label">总盈亏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-positive" id="avg-win">--</div>
                        <div class="stat-label">平均盈利</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-negative" id="avg-loss">--</div>
                        <div class="stat-label">平均亏损</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="exit-breakdown">--</div>
                        <div class="stat-label">出场分布</div>
                    </div>
                </div>
            </div>

            <!-- 图表和建议 -->
            <div class="two-col">
                <!-- K线图表 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">K线与EMA走势</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- 优化建议 -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">优化建议</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="applyOptimizedParams()" id="btn-apply-optimized" style="display: none;">应用优化参数</button>
                            <button class="btn btn-secondary" onclick="saveOptimizedParams()" id="btn-save-optimized" style="display: none;">保存到本地</button>
                        </div>
                    </div>
                    <!-- 优化参数预览 -->
                    <div id="optimized-params-preview" style="display: none; margin-bottom: 16px;">
                        <div style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px;">
                            <div style="font-size: 13px; color: var(--accent-green); margin-bottom: 8px; font-weight: 600;">推荐参数:</div>
                            <div class="param-comparison" id="param-changes">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                    </div>
                    <div id="suggestions">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 交易记录 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">模拟交易记录</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>类型</th>
                                <th>入场时间</th>
                                <th>入场价</th>
                                <th>出场时间</th>
                                <th>出场价</th>
                                <th>出场原因</th>
                                <th>盈亏</th>
                            </tr>
                        </thead>
                        <tbody id="trades-table">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 加载中 -->
        <div id="loading" class="card" style="display: none;">
            <div class="loading">
                <div class="spinner"></div>
                <span>正在分析数据，请稍候...</span>
            </div>
        </div>
    </div>

    <script>
        let priceChart = null;
        let analysisData = null;
        let currentMode = 'trend';  // 当前选中的模式
        const STORAGE_KEY = 'strategy_analyzer_optimized_params';

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadSymbols();
            checkSavedParams();
        });

        // 检查是否有保存的优化参数
        function checkSavedParams() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                document.getElementById('btn-load-saved').style.display = 'inline-block';
            }
        }

        // 保存优化参数到本地
        function saveOptimizedParams() {
            if (!analysisData || !analysisData.optimized_params) {
                showToast('没有可保存的优化参数', 'error');
                return;
            }

            const saveData = {
                symbol: analysisData.symbol,
                timeframe: analysisData.timeframe,
                current_params: analysisData.current_params,
                optimized_params: analysisData.optimized_params,
                suggestions: analysisData.suggestions,
                statistics: analysisData.statistics,
                saved_at: new Date().toISOString()
            };

            localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData));
            document.getElementById('btn-load-saved').style.display = 'inline-block';
            showToast('优化参数已保存到本地', 'success');
        }

        // 加载保存的优化参数
        function loadSavedParams() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) {
                showToast('没有保存的优化参数', 'error');
                return;
            }

            const data = JSON.parse(saved);
            const savedTime = new Date(data.saved_at).toLocaleString('zh-CN');

            let html = '<div style="padding: 20px;">';
            html += `<p style="color: var(--text-secondary); margin-bottom: 16px;">保存时间: ${savedTime}</p>`;
            html += `<p style="margin-bottom: 12px;">交易对: <strong>${data.symbol}</strong> | 周期: <strong>${data.timeframe}</strong></p>`;

            html += '<div style="margin-bottom: 16px;">';
            html += '<h4 style="margin-bottom: 8px; color: var(--accent-yellow);">原始参数:</h4>';
            html += '<div class="param-comparison">';
            html += `<div class="param-item"><span class="label">短期EMA</span><span class="value">${data.current_params.ema_short}</span></div>`;
            html += `<div class="param-item"><span class="label">长期EMA</span><span class="value">${data.current_params.ema_long}</span></div>`;
            html += `<div class="param-item"><span class="label">止损</span><span class="value">${data.current_params.stop_loss_pct}%</span></div>`;
            html += `<div class="param-item"><span class="label">止盈</span><span class="value">${data.current_params.take_profit_pct}%</span></div>`;
            html += '</div></div>';

            html += '<div style="margin-bottom: 16px;">';
            html += '<h4 style="margin-bottom: 8px; color: var(--accent-green);">优化参数:</h4>';
            html += '<div class="param-comparison">';
            html += `<div class="param-item"><span class="label">短期EMA</span><span class="value" style="color: ${data.optimized_params.ema_short !== data.current_params.ema_short ? 'var(--accent-green)' : 'inherit'};">${data.optimized_params.ema_short}</span></div>`;
            html += `<div class="param-item"><span class="label">长期EMA</span><span class="value" style="color: ${data.optimized_params.ema_long !== data.current_params.ema_long ? 'var(--accent-green)' : 'inherit'};">${data.optimized_params.ema_long}</span></div>`;
            html += `<div class="param-item"><span class="label">止损</span><span class="value" style="color: ${data.optimized_params.stop_loss_pct !== data.current_params.stop_loss_pct ? 'var(--accent-green)' : 'inherit'};">${data.optimized_params.stop_loss_pct}%</span></div>`;
            html += `<div class="param-item"><span class="label">止盈</span><span class="value" style="color: ${data.optimized_params.take_profit_pct !== data.current_params.take_profit_pct ? 'var(--accent-green)' : 'inherit'};">${data.optimized_params.take_profit_pct}%</span></div>`;
            if (data.optimized_params.exit_mode) {
                html += `<div class="param-item"><span class="label">出场模式</span><span class="value" style="color: var(--accent-green);">${data.optimized_params.exit_mode === 'trend' ? '趋势跟踪' : '固定止盈止损'}</span></div>`;
            }
            html += '</div></div>';

            html += '<div style="display: flex; gap: 10px; margin-top: 20px;">';
            html += '<button class="btn btn-success" onclick="applySavedParams()">应用优化参数</button>';
            html += '<button class="btn btn-secondary" onclick="clearSavedParams()">清除保存</button>';
            html += '<button class="btn btn-secondary" onclick="closeDialog()">取消</button>';
            html += '</div></div>';

            showDialog('加载保存的优化参数', html);
        }

        // 应用保存的优化参数
        function applySavedParams() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;

            const data = JSON.parse(saved);
            const opt = data.optimized_params;

            document.getElementById('ema-short').value = opt.ema_short;
            document.getElementById('ema-long').value = opt.ema_long;
            document.getElementById('stop-loss').value = opt.stop_loss_pct;
            document.getElementById('take-profit').value = opt.take_profit_pct;

            // 如果有保存的交易对，也设置它
            const symbolSelect = document.getElementById('symbol');
            const options = Array.from(symbolSelect.options);
            const matchOption = options.find(o => o.value === data.symbol);
            if (matchOption) {
                symbolSelect.value = data.symbol;
            }

            // 如果有周期
            if (data.timeframe) {
                document.getElementById('timeframe').value = data.timeframe;
            }

            closeDialog();
            showToast('已应用优化参数，点击"开始分析"进行测试', 'success');
        }

        // 清除保存的参数
        function clearSavedParams() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('btn-load-saved').style.display = 'none';
            closeDialog();
            showToast('已清除保存的优化参数', 'info');
        }

        // 应用当前分析结果中的优化参数
        function applyOptimizedParams() {
            if (!analysisData || !analysisData.optimized_params) {
                showToast('没有可应用的优化参数', 'error');
                return;
            }

            const opt = analysisData.optimized_params;

            document.getElementById('ema-short').value = opt.ema_short;
            document.getElementById('ema-long').value = opt.ema_long;
            document.getElementById('stop-loss').value = opt.stop_loss_pct;
            document.getElementById('take-profit').value = opt.take_profit_pct;

            // 如果有推荐的出场模式
            if (opt.exit_mode) {
                switchMode(opt.exit_mode);
            }

            showToast('已应用优化参数，点击"开始分析"重新测试', 'success');
        }

        // 切换出场模式
        function switchMode(mode) {
            currentMode = mode;

            // 更新按钮样式
            document.getElementById('btn-mode-fixed').className = mode === 'fixed' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('btn-mode-trend').className = mode === 'trend' ? 'btn btn-primary' : 'btn btn-secondary';

            // 更新卡片边框
            document.getElementById('mode-fixed-card').style.border = mode === 'fixed' ? '2px solid var(--accent-blue)' : '2px solid var(--border-color)';
            document.getElementById('mode-trend-card').style.border = mode === 'trend' ? '2px solid var(--accent-green)' : '2px solid var(--border-color)';

            // 更新模式名称
            document.getElementById('current-mode-name').textContent = mode === 'trend' ? '趋势跟踪' : '固定止盈止损';

            // 重新渲染统计和交易记录
            if (analysisData) {
                const stats = mode === 'trend' ? analysisData.statistics_trend : analysisData.statistics_fixed;
                const trades = mode === 'trend' ? analysisData.trades_trend : analysisData.trades_fixed;
                renderStats(stats);
                renderTrades(trades);
            }
        }

        // 加载交易对
        async function loadSymbols() {
            try {
                const resp = await fetch('/api/strategy-analyzer/symbols');
                const data = await resp.json();

                if (data.success && data.data.length > 0) {
                    const select = document.getElementById('symbol');
                    select.innerHTML = data.data.map(s =>
                        `<option value="${s}">${s}</option>`
                    ).join('');
                }
            } catch (e) {
                console.error('加载交易对失败:', e);
            }
        }

        // 加载策略配置
        async function loadStrategies() {
            try {
                const resp = await fetch('/api/strategy-analyzer/strategies');
                const data = await resp.json();

                if (data.success && data.data.length > 0) {
                    // 显示策略选择对话框
                    const strategies = data.data;
                    let html = '<div style="padding: 20px;">';
                    html += '<h3 style="margin-bottom: 16px;">选择策略配置</h3>';
                    strategies.forEach(s => {
                        html += `
                            <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer;"
                                 onclick="applyStrategy('${s.id}', ${s.stop_loss}, ${s.take_profit}, '${s.buy_timeframe}', ${s.ema_short}, ${s.ema_long}, '${s.symbols.join(',')}')">
                                <strong>${s.name}</strong>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                    EMA: ${s.ema_short}/${s.ema_long} | 止损: ${s.stop_loss}% | 止盈: ${s.take_profit}% | 周期: ${s.buy_timeframe}
                                </div>
                                <div style="font-size: 11px; color: var(--text-secondary);">
                                    交易对: ${s.symbols.join(', ')}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';

                    showDialog('加载策略配置', html);
                }
            } catch (e) {
                showToast('加载策略失败: ' + e.message, 'error');
            }
        }

        // 应用策略配置
        function applyStrategy(id, stopLoss, takeProfit, timeframe, emaShort, emaLong, symbolsStr) {
            document.getElementById('stop-loss').value = stopLoss;
            document.getElementById('take-profit').value = takeProfit;
            document.getElementById('timeframe').value = timeframe;
            document.getElementById('ema-short').value = emaShort;
            document.getElementById('ema-long').value = emaLong;

            // 尝试设置第一个交易对
            if (symbolsStr) {
                const symbols = symbolsStr.split(',');
                const symbolSelect = document.getElementById('symbol');
                const options = Array.from(symbolSelect.options);
                for (const sym of symbols) {
                    const match = options.find(o => o.value === sym.trim());
                    if (match) {
                        symbolSelect.value = sym.trim();
                        break;
                    }
                }
            }

            closeDialog();
            showToast('已加载策略配置，点击"开始分析"', 'success');
        }

        // 运行分析
        async function runAnalysis() {
            const symbol = document.getElementById('symbol').value;
            if (!symbol) {
                showToast('请选择交易对', 'error');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const params = new URLSearchParams({
                    symbol: symbol,
                    timeframe: document.getElementById('timeframe').value,
                    hours: document.getElementById('hours').value,
                    ema_short: document.getElementById('ema-short').value,
                    ema_long: document.getElementById('ema-long').value,
                    stop_loss_pct: document.getElementById('stop-loss').value,
                    take_profit_pct: document.getElementById('take-profit').value
                });

                const resp = await fetch(`/api/strategy-analyzer/analyze?${params}`);
                const data = await resp.json();

                if (data.success) {
                    analysisData = data.data;
                    renderResults(data.data);
                } else {
                    showToast(data.error || '分析失败', 'error');
                }
            } catch (e) {
                showToast('分析请求失败: ' + e.message, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // 渲染结果
        function renderResults(data) {
            document.getElementById('results').style.display = 'block';

            // 行情概览
            const regime = data.regime;
            const regimeBadge = document.getElementById('regime-badge');
            regimeBadge.className = `regime-badge regime-${regime.type}`;
            regimeBadge.textContent = regime.name;

            document.getElementById('price-change').textContent = `${regime.price_change_pct > 0 ? '+' : ''}${regime.price_change_pct}%`;
            document.getElementById('price-change').className = `stat-value ${regime.price_change_pct >= 0 ? 'stat-positive' : 'stat-negative'}`;

            document.getElementById('volatility').textContent = `${regime.volatility}%`;
            document.getElementById('golden-crosses').textContent = data.signals.golden_crosses;
            document.getElementById('death-crosses').textContent = data.signals.death_crosses;

            // 模式对比
            renderModeComparison(data);

            // 当前模式统计
            const stats = currentMode === 'trend' ? data.statistics_trend : data.statistics_fixed;
            renderStats(stats);

            // 优化建议和参数预览
            renderSuggestions(data.suggestions);
            renderOptimizedParams(data);

            // 交易记录
            const trades = currentMode === 'trend' ? data.trades_trend : data.trades_fixed;
            renderTrades(trades);

            // 图表
            renderChart(data.klines);
        }

        // 渲染优化参数预览（不自动填入，需用户手动点击应用）
        function renderOptimizedParams(data) {
            const current = data.current_params;
            const optimized = data.optimized_params;

            // 检查是否有参数变化
            const hasChanges = optimized.ema_short !== current.ema_short ||
                              optimized.ema_long !== current.ema_long ||
                              optimized.stop_loss_pct !== current.stop_loss_pct ||
                              optimized.take_profit_pct !== current.take_profit_pct ||
                              optimized.exit_mode;

            if (!hasChanges) {
                document.getElementById('optimized-params-preview').style.display = 'none';
                document.getElementById('btn-apply-optimized').style.display = 'none';
                document.getElementById('btn-save-optimized').style.display = 'none';
                return;
            }

            // 显示按钮
            document.getElementById('btn-apply-optimized').style.display = 'inline-block';
            document.getElementById('btn-save-optimized').style.display = 'inline-block';
            document.getElementById('optimized-params-preview').style.display = 'block';

            // 生成参数变化对比
            let html = '';
            const paramLabels = {
                'ema_short': '短期EMA',
                'ema_long': '长期EMA',
                'stop_loss_pct': '止损 %',
                'take_profit_pct': '止盈 %'
            };

            ['ema_short', 'ema_long', 'stop_loss_pct', 'take_profit_pct'].forEach(key => {
                const oldVal = current[key];
                const newVal = optimized[key];
                const changed = oldVal !== newVal;

                html += `<div class="param-item">
                    <span class="label">${paramLabels[key]}</span>
                    <span class="value">
                        ${changed ?
                            `<span style="text-decoration: line-through; color: var(--text-secondary);">${oldVal}</span>
                             <span style="color: var(--accent-green);"> → ${newVal}</span>` :
                            oldVal
                        }
                    </span>
                </div>`;
            });

            // 如果有出场模式建议
            if (optimized.exit_mode) {
                const modeLabel = optimized.exit_mode === 'trend' ? '趋势跟踪' : '固定止盈止损';
                html += `<div class="param-item">
                    <span class="label">推荐出场模式</span>
                    <span class="value" style="color: var(--accent-green);">${modeLabel}</span>
                </div>`;
            }

            // 如果有行情过滤建议
            if (optimized.sustainedTrend_enabled) {
                html += `<div class="param-item">
                    <span class="label">行情过滤</span>
                    <span class="value" style="color: var(--accent-yellow);">建议启用 sustainedTrend</span>
                </div>`;
            }

            document.getElementById('param-changes').innerHTML = html;
        }

        // 渲染模式对比
        function renderModeComparison(data) {
            const comp = data.mode_comparison;
            const statsFixed = data.statistics_fixed;
            const statsTrend = data.statistics_trend;

            // 固定模式统计
            const fixedPnl = document.getElementById('fixed-pnl');
            fixedPnl.textContent = `${comp.fixed.total_pnl > 0 ? '+' : ''}${comp.fixed.total_pnl}%`;
            fixedPnl.className = `stat-value ${comp.fixed.total_pnl >= 0 ? 'stat-positive' : 'stat-negative'}`;
            document.getElementById('fixed-winrate').textContent = `${comp.fixed.win_rate}%`;
            document.getElementById('fixed-trades').textContent = comp.fixed.trades;
            document.getElementById('fixed-exits').textContent = `止损 ${statsFixed.stop_loss_exits} / 止盈 ${statsFixed.take_profit_exits} / 信号 ${statsFixed.signal_exits}`;

            // 趋势跟踪模式统计
            const trendPnl = document.getElementById('trend-pnl');
            trendPnl.textContent = `${comp.trend.total_pnl > 0 ? '+' : ''}${comp.trend.total_pnl}%`;
            trendPnl.className = `stat-value ${comp.trend.total_pnl >= 0 ? 'stat-positive' : 'stat-negative'}`;
            document.getElementById('trend-winrate').textContent = `${comp.trend.win_rate}%`;
            document.getElementById('trend-trades').textContent = comp.trend.trades;
            document.getElementById('trend-exits').textContent = `趋势反转 ${statsTrend.trend_reverse_exits} / 移动止损 ${statsTrend.trailing_stop_exits}`;

            // 显示更优标签
            document.getElementById('fixed-winner-badge').style.display = comp.better_mode === 'fixed' ? 'inline' : 'none';
            document.getElementById('trend-winner-badge').style.display = comp.better_mode === 'trend' ? 'inline' : 'none';

            // 对比差异
            const diffEl = document.getElementById('pnl-diff');
            const diff = comp.pnl_diff;
            const betterName = comp.better_mode === 'trend' ? '趋势跟踪' : '固定止盈止损';
            diffEl.textContent = `${betterName} 多赚 ${diff}%`;
            diffEl.className = comp.better_mode === 'trend' ? 'stat-positive' : 'stat-neutral';
        }

        // 渲染统计数据
        function renderStats(stats) {
            document.getElementById('total-trades').textContent = stats.total_trades;

            const winRateEl = document.getElementById('win-rate');
            winRateEl.textContent = `${stats.win_rate}%`;
            winRateEl.className = `stat-value ${stats.win_rate >= 50 ? 'stat-positive' : 'stat-negative'}`;

            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = `${stats.total_pnl_pct > 0 ? '+' : ''}${stats.total_pnl_pct}%`;
            pnlEl.className = `stat-value ${stats.total_pnl_pct >= 0 ? 'stat-positive' : 'stat-negative'}`;

            document.getElementById('avg-win').textContent = `+${stats.avg_win_pct}%`;
            document.getElementById('avg-loss').textContent = `${stats.avg_loss_pct}%`;

            // 根据模式显示不同的出场分布
            if (currentMode === 'trend') {
                document.getElementById('exit-breakdown').textContent = `反转${stats.trend_reverse_exits}/止损${stats.trailing_stop_exits}`;
            } else {
                document.getElementById('exit-breakdown').textContent = `止损${stats.stop_loss_exits}/止盈${stats.take_profit_exits}/信号${stats.signal_exits}`;
            }
        }

        // 渲染建议
        function renderSuggestions(suggestions) {
            const container = document.getElementById('suggestions');

            if (!suggestions || suggestions.length === 0) {
                container.innerHTML = `
                    <div class="suggestion suggestion-success">
                        <span class="suggestion-icon">✓</span>
                        <div class="suggestion-content">
                            <h4>参数表现良好</h4>
                            <p>当前参数配置在该时间段表现不错，无需调整</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = suggestions.map(s => {
                const icons = { warning: '⚠', success: '✓', info: 'ℹ' };
                return `
                    <div class="suggestion suggestion-${s.type}">
                        <span class="suggestion-icon">${icons[s.type] || 'ℹ'}</span>
                        <div class="suggestion-content">
                            <h4>${s.title}</h4>
                            <p>${s.content}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 渲染交易记录
        function renderTrades(trades) {
            const tbody = document.getElementById('trades-table');

            if (!trades || trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">暂无交易记录</td></tr>';
                return;
            }

            tbody.innerHTML = trades.map(t => {
                const exitReasons = {
                    'STOP_LOSS': '止损',
                    'TAKE_PROFIT': '止盈',
                    'SIGNAL_EXIT': '信号出场',
                    'TREND_REVERSE': '趋势反转',
                    'TRAILING_STOP': '移动止损'
                };
                const exitClass = {
                    'STOP_LOSS': 'badge-danger',
                    'TAKE_PROFIT': 'badge-success',
                    'SIGNAL_EXIT': 'badge-info',
                    'TREND_REVERSE': 'badge-warning',
                    'TRAILING_STOP': 'badge-danger'
                };

                // 显示最大盈利（趋势跟踪模式）
                const maxProfit = t.max_profit !== undefined ? `<br><span style="font-size:11px;color:var(--text-secondary);">最高${t.max_profit}%</span>` : '';

                return `
                    <tr>
                        <td><span class="badge ${t.type === 'LONG' ? 'badge-success' : 'badge-danger'}">${t.type === 'LONG' ? '做多' : '做空'}</span></td>
                        <td>${t.entry_time}</td>
                        <td>${t.entry_price}</td>
                        <td>${t.exit_time}</td>
                        <td>${t.exit_price}</td>
                        <td><span class="badge ${exitClass[t.exit_reason] || 'badge-info'}">${exitReasons[t.exit_reason] || t.exit_reason}</span></td>
                        <td class="${t.pnl_pct >= 0 ? 'stat-positive' : 'stat-negative'}">${t.pnl_pct > 0 ? '+' : ''}${t.pnl_pct}%${maxProfit}</td>
                    </tr>
                `;
            }).join('');
        }

        // 渲染图表
        function renderChart(klines) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            if (priceChart) {
                priceChart.destroy();
            }

            const labels = klines.map(k => k.timestamp.split(' ')[1] || k.timestamp);
            const closeData = klines.map(k => k.close);
            const emaShortData = klines.map(k => k.ema_short);
            const emaLongData = klines.map(k => k.ema_long);

            // 找出信号点
            const goldenCrossPoints = [];
            const deathCrossPoints = [];
            klines.forEach((k, i) => {
                if (k.signal === 1) {
                    goldenCrossPoints.push({ x: i, y: k.close });
                } else if (k.signal === -1) {
                    deathCrossPoints.push({ x: i, y: k.close });
                }
            });

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '收盘价',
                            data: closeData,
                            borderColor: '#58a6ff',
                            backgroundColor: 'rgba(88, 166, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: `EMA${document.getElementById('ema-short').value}`,
                            data: emaShortData,
                            borderColor: '#3fb950',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        },
                        {
                            label: `EMA${document.getElementById('ema-long').value}`,
                            data: emaLongData,
                            borderColor: '#f85149',
                            borderWidth: 1.5,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#c9d1d9' }
                        },
                        tooltip: {
                            backgroundColor: '#21262d',
                            titleColor: '#c9d1d9',
                            bodyColor: '#8b949e',
                            borderColor: '#30363d',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e', maxRotation: 45 },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        },
                        y: {
                            ticks: { color: '#8b949e' },
                            grid: { color: 'rgba(48, 54, 61, 0.5)' }
                        }
                    }
                }
            });
        }

        // Toast通知
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 对话框
        let currentDialog = null;

        function showDialog(title, content) {
            if (currentDialog) closeDialog();

            const overlay = document.createElement('div');
            overlay.id = 'dialog-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            overlay.innerHTML = `
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px;">${title}</h3>
                        <button onclick="closeDialog()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 20px;">&times;</button>
                    </div>
                    ${content}
                </div>
            `;

            document.body.appendChild(overlay);
            currentDialog = overlay;

            overlay.onclick = (e) => {
                if (e.target === overlay) closeDialog();
            };
        }

        function closeDialog() {
            if (currentDialog) {
                currentDialog.remove();
                currentDialog = null;
            }
        }
    </script>
</body>
</html>
