<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæƒ…è¯†åˆ«ä¸ç­–ç•¥è‡ªé€‚åº”</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #58a6ff; margin-bottom: 20px; }
        h2 { color: #8b949e; margin: 20px 0 10px; font-size: 18px; }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .regime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .regime-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .regime-card.strong_uptrend { border-left: 4px solid #3fb950; }
        .regime-card.weak_uptrend { border-left: 4px solid #7ee787; }
        .regime-card.ranging { border-left: 4px solid #8b949e; }
        .regime-card.weak_downtrend { border-left: 4px solid #f0883e; }
        .regime-card.strong_downtrend { border-left: 4px solid #f85149; }

        .regime-icon { font-size: 32px; margin-bottom: 10px; }
        .regime-name { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .regime-count { font-size: 24px; color: #58a6ff; }
        .regime-desc { font-size: 12px; color: #8b949e; margin-top: 5px; }

        .symbol-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            justify-content: center;
        }

        .symbol-tag {
            background: #30363d;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #30363d;
        }

        th {
            background: #21262d;
            color: #8b949e;
            font-weight: 500;
        }

        tr:hover { background: #21262d; }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn-primary { background: #238636; color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-secondary { background: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
        .btn-secondary:hover { background: #30363d; }
        .btn-danger { background: #f85149; color: white; }
        .btn-danger:hover { background: #da3633; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #8b949e;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input { display: none; }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #30363d;
            transition: .3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider { background-color: #238636; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .status-enabled { background: #238636; color: white; }
        .status-disabled { background: #f85149; color: white; }

        .score-bar {
            width: 100%;
            height: 8px;
            background: #30363d;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .score-positive { background: linear-gradient(90deg, #238636, #3fb950); }
        .score-negative { background: linear-gradient(90deg, #f85149, #da3633); }
        .score-neutral { background: #8b949e; }

        .tabs {
            display: flex;
            border-bottom: 1px solid #30363d;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #8b949e;
        }

        .tab:hover { color: #c9d1d9; }
        .tab.active { color: #58a6ff; border-bottom-color: #58a6ff; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .refresh-btn {
            float: right;
            margin-top: -45px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }

        .modal-content {
            background: #161b22;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 24px;
            cursor: pointer;
        }

        .back-link {
            color: #58a6ff;
            text-decoration: none;
            margin-bottom: 20px;
            display: inline-block;
        }

        .back-link:hover { text-decoration: underline; }

        /* Toast é€šçŸ¥æ ·å¼ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.success {
            background: linear-gradient(135deg, #238636, #2ea043);
            border: 1px solid #3fb950;
        }

        .toast.error {
            background: linear-gradient(135deg, #da3633, #f85149);
            border: 1px solid #f85149;
        }

        .toast.info {
            background: linear-gradient(135deg, #1f6feb, #388bfd);
            border: 1px solid #58a6ff;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ç¡®è®¤å¯¹è¯æ¡†æ ·å¼ */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .confirm-dialog {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
            max-width: 420px;
            width: 90%;
            animation: scaleIn 0.2s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .confirm-dialog h3 {
            color: #c9d1d9;
            margin-bottom: 16px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confirm-dialog h3.success { color: #3fb950; }
        .confirm-dialog h3.error { color: #f85149; }
        .confirm-dialog h3.warning { color: #d29922; }

        .confirm-dialog .content {
            color: #8b949e;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .confirm-dialog .buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .confirm-dialog .btn {
            min-width: 80px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/futures_trading" class="back-link">&larr; è¿”å›åˆçº¦äº¤æ˜“</a>
        <h1>è¡Œæƒ…è¯†åˆ«ä¸ç­–ç•¥è‡ªé€‚åº”</h1>

        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">è¡Œæƒ…æ€»è§ˆ</div>
            <div class="tab" onclick="showTab('circuit-breaker')">è¿ç»­äºæŸç†”æ–­</div>
            <div class="tab" onclick="showTab('params')">ç­–ç•¥å‚æ•°é…ç½®</div>
            <div class="tab" onclick="showTab('history')">è¡Œæƒ…åˆ‡æ¢å†å²</div>
        </div>

        <!-- è¡Œæƒ…æ€»è§ˆ -->
        <div id="overview" class="tab-content active">
            <div class="card">
                <h2>å½“å‰è¡Œæƒ…åˆ†å¸ƒ
                    <button class="btn btn-secondary refresh-btn" onclick="loadSummary()">åˆ·æ–°</button>
                </h2>
                <div id="regime-summary" class="regime-grid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div class="card">
                <h2>æ£€æµ‹å•ä¸ªäº¤æ˜“å¯¹</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“å¯¹</label>
                        <select id="detect-symbol">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´å‘¨æœŸ</label>
                        <select id="detect-timeframe">
                            <option value="5m">5åˆ†é’Ÿ</option>
                            <option value="15m" selected>15åˆ†é’Ÿ</option>
                            <option value="1h">1å°æ—¶</option>
                            <option value="4h">4å°æ—¶</option>
                            <option value="1d">1å¤©</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="detectRegime()">æ£€æµ‹è¡Œæƒ…</button>
                <div id="detect-result" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- è¿ç»­äºæŸç†”æ–­ -->
        <div id="circuit-breaker" class="tab-content">
            <div class="card">
                <h2>ç†”æ–­çŠ¶æ€
                    <button class="btn btn-secondary refresh-btn" onclick="loadCircuitBreakerStatus()">åˆ·æ–°</button>
                </h2>
                <p style="color: #8b949e; margin-bottom: 15px;">
                    å½“æŸæ–¹å‘è¿ç»­4å•äºæŸæ—¶ï¼Œè‡ªåŠ¨æš‚åœè¯¥æ–¹å‘å¼€ä»“1å°æ—¶
                </p>
                <div class="regime-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div id="long-breaker" class="regime-card" style="border-left-color: #3fb950;">
                        <div class="regime-icon">ğŸ“ˆ</div>
                        <div class="regime-name">åšå¤šæ–¹å‘</div>
                        <div id="long-status" class="regime-count" style="font-size: 16px;">æ£€æŸ¥ä¸­...</div>
                        <div id="long-losses" style="margin-top: 10px; font-size: 14px; color: #8b949e;"></div>
                        <button id="long-clear-btn" class="btn btn-secondary" style="margin-top: 10px; display: none;" onclick="clearBreaker('long')">è§£é™¤ç†”æ–­</button>
                    </div>
                    <div id="short-breaker" class="regime-card" style="border-left-color: #f85149;">
                        <div class="regime-icon">ğŸ“‰</div>
                        <div class="regime-name">åšç©ºæ–¹å‘</div>
                        <div id="short-status" class="regime-count" style="font-size: 16px;">æ£€æŸ¥ä¸­...</div>
                        <div id="short-losses" style="margin-top: 10px; font-size: 14px; color: #8b949e;"></div>
                        <button id="short-clear-btn" class="btn btn-secondary" style="margin-top: 10px; display: none;" onclick="clearBreaker('short')">è§£é™¤ç†”æ–­</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ç†”æ–­è§„åˆ™è¯´æ˜</h2>
                <table>
                    <thead>
                        <tr>
                            <th>è§„åˆ™</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>è§¦å‘æ¡ä»¶</strong></td>
                            <td>æŸæ–¹å‘ï¼ˆåšå¤š/åšç©ºï¼‰è¿ç»­4å•äºæŸ</td>
                        </tr>
                        <tr>
                            <td><strong>ç†”æ–­æ•ˆæœ</strong></td>
                            <td>æš‚åœè¯¥æ–¹å‘çš„å¼€ä»“æ“ä½œ</td>
                        </tr>
                        <tr>
                            <td><strong>å†·å´æ—¶é—´</strong></td>
                            <td>1å°æ—¶åè‡ªåŠ¨è§£é™¤</td>
                        </tr>
                        <tr>
                            <td><strong>ç»Ÿè®¡èŒƒå›´</strong></td>
                            <td>æ‰€æœ‰å¸ç§çš„åŒæ–¹å‘äº¤æ˜“</td>
                        </tr>
                        <tr>
                            <td><strong>æ‰‹åŠ¨è§£é™¤</strong></td>
                            <td>å¯ç‚¹å‡»"è§£é™¤ç†”æ–­"æŒ‰é’®æå‰è§£é™¤</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ç­–ç•¥å‚æ•°é…ç½® -->
        <div id="params" class="tab-content">
            <div class="card">
                <h2>é€‰æ‹©ç­–ç•¥</h2>
                <select id="strategy-select" onchange="loadStrategyParams()">
                    <option value="">-- è¯·é€‰æ‹©ç­–ç•¥ --</option>
                </select>
            </div>

            <div id="params-config" style="display: none;">
                <div class="card">
                    <h2>è¡Œæƒ…å‚æ•°é…ç½®
                        <button class="btn btn-primary refresh-btn" onclick="openAddParamModal()">æ·»åŠ é…ç½®</button>
                    </h2>
                    <table>
                        <thead>
                            <tr>
                                <th>è¡Œæƒ…ç±»å‹</th>
                                <th>çŠ¶æ€</th>
                                <th>å‚æ•°é…ç½®</th>
                                <th>è¯´æ˜</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="params-table">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- è¡Œæƒ…åˆ‡æ¢å†å² -->
        <div id="history" class="tab-content">
            <div class="card">
                <h2>ç­›é€‰æ¡ä»¶
                    <button class="btn btn-secondary refresh-btn" onclick="loadAllHistory()">åˆ·æ–°</button>
                </h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>äº¤æ˜“å¯¹ï¼ˆç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨ï¼‰</label>
                        <input type="text" id="history-symbol" placeholder="ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨" value="">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´å‘¨æœŸ</label>
                        <select id="history-timeframe">
                            <option value="15m" selected>15åˆ†é’Ÿ</option>
                            <option value="1h">1å°æ—¶</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="loadAllHistory()">ç­›é€‰</button>
            </div>

            <div class="card">
                <h2>åˆ‡æ¢è®°å½•ï¼ˆæœ€è¿‘50æ¡ï¼‰</h2>
                <table>
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>äº¤æ˜“å¯¹</th>
                            <th>åŸè¡Œæƒ…</th>
                            <th>æ–°è¡Œæƒ…</th>
                            <th>å¾—åˆ†å˜åŒ–</th>
                        </tr>
                    </thead>
                    <tbody id="history-table">
                        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å‚æ•°æ¨¡æ€æ¡† -->
    <div id="param-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">æ·»åŠ è¡Œæƒ…å‚æ•°</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="param-form">
                <div class="form-group">
                    <label>è¡Œæƒ…ç±»å‹</label>
                    <select id="param-regime-type" required>
                        <option value="strong_uptrend">å¼ºè¶‹åŠ¿ä¸Šæ¶¨</option>
                        <option value="weak_uptrend">å¼±è¶‹åŠ¿ä¸Šæ¶¨</option>
                        <option value="ranging">éœ‡è¡è¡Œæƒ…</option>
                        <option value="weak_downtrend">å¼±è¶‹åŠ¿ä¸‹è·Œ</option>
                        <option value="strong_downtrend">å¼ºè¶‹åŠ¿ä¸‹è·Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯ç”¨äº¤æ˜“</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="param-enabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="form-group">
                    <label>å¯ç”¨æŒç»­è¶‹åŠ¿ä¿¡å· (sustainedTrend)</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="param-sustained-trend">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è¶‹åŠ¿æœ€å°å¼ºåº¦ (%)</label>
                        <input type="number" id="param-min-strength" step="0.1" value="0.3">
                    </div>
                    <div class="form-group">
                        <label>è¶‹åŠ¿æœ€å¤§å¼ºåº¦ (%)</label>
                        <input type="number" id="param-max-strength" step="0.1" value="2.0">
                    </div>
                </div>
                <div class="form-group">
                    <label>å…è®¸äº¤æ˜“æ–¹å‘</label>
                    <select id="param-allow-direction">
                        <option value="both">åŒå‘ï¼ˆè·Ÿéšç­–ç•¥é…ç½®ï¼‰</option>
                        <option value="long_only">ä»…åšå¤š</option>
                        <option value="short_only">ä»…åšç©º</option>
                        <option value="none">ç¦æ­¢äº¤æ˜“</option>
                    </select>
                    <p style="font-size: 11px; color: #6e7681; margin-top: 5px;">
                        æ­¤è®¾ç½®ä¼šè¦†ç›–ç­–ç•¥çš„äº¤æ˜“æ–¹å‘é…ç½®ã€‚é€‰æ‹©"ç¦æ­¢äº¤æ˜“"ç›¸å½“äºåœ¨è¯¥è¡Œæƒ…ä¸‹æš‚åœç­–ç•¥ã€‚
                    </p>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ­¢æŸ (%)</label>
                        <input type="number" id="param-stop-loss" step="0.1" value="3.0">
                    </div>
                    <div class="form-group">
                        <label>æ­¢ç›ˆ (%)</label>
                        <input type="number" id="param-take-profit" step="0.1" value="6.0">
                    </div>
                </div>
                <div class="form-group">
                    <label>è¯´æ˜</label>
                    <textarea id="param-description" rows="2" placeholder="å‚æ•°é…ç½®è¯´æ˜"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
        let currentStrategyId = null;

        // Toast é€šçŸ¥
        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const icons = {
                success: 'âœ“',
                error: 'âœ—',
                info: 'â„¹'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span style="font-size: 18px;">${icons[type] || icons.info}</span> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, content, type = 'warning') {
            return new Promise((resolve) => {
                const icons = {
                    success: 'âœ“',
                    error: 'âœ—',
                    warning: 'âš ',
                    danger: 'âš '
                };

                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-dialog">
                        <h3 class="${type}">
                            <span style="font-size: 22px;">${icons[type] || icons.warning}</span>
                            ${title}
                        </h3>
                        <div class="content">${content}</div>
                        <div class="buttons">
                            <button class="btn btn-secondary" onclick="this.closest('.confirm-overlay').remove()">å–æ¶ˆ</button>
                            <button class="btn ${type === 'danger' ? 'btn-danger' : 'btn-primary'}" id="confirm-yes-btn">ç¡®å®š</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);

                overlay.querySelector('#confirm-yes-btn').onclick = () => {
                    overlay.remove();
                    resolve(true);
                };
                overlay.querySelector('.btn-secondary').onclick = () => {
                    overlay.remove();
                    resolve(false);
                };

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                };
            });
        }

        // æˆåŠŸæç¤ºå¯¹è¯æ¡†ï¼ˆåªæœ‰ç¡®å®šæŒ‰é’®ï¼‰
        function showSuccessDialog(title, content) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-dialog">
                        <h3 class="success">
                            <span style="font-size: 22px;">âœ“</span>
                            ${title}
                        </h3>
                        <div class="content">${content}</div>
                        <div class="buttons">
                            <button class="btn btn-primary" id="success-ok-btn">ç¡®å®š</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);

                overlay.querySelector('#success-ok-btn').onclick = () => {
                    overlay.remove();
                    resolve(true);
                };

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(true);
                    }
                };
            });
        }

        // Tabåˆ‡æ¢
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        // åŠ è½½è¡Œæƒ…æ±‡æ€»
        async function loadSummary() {
            const container = document.getElementById('regime-summary');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const resp = await fetch('/api/market-regime/summary?timeframe=15m');
                const data = await resp.json();

                if (data.success) {
                    let html = '';
                    const order = ['strong_uptrend', 'weak_uptrend', 'ranging', 'weak_downtrend', 'strong_downtrend'];
                    const icons = {
                        'strong_uptrend': 'ğŸ“ˆ',
                        'weak_uptrend': 'â†—ï¸',
                        'ranging': 'â†”ï¸',
                        'weak_downtrend': 'â†˜ï¸',
                        'strong_downtrend': 'ğŸ“‰'
                    };

                    for (const type of order) {
                        const info = data.data[type];
                        html += `
                            <div class="regime-card ${type}">
                                <div class="regime-icon">${icons[type]}</div>
                                <div class="regime-name">${info.display.replace(/[ğŸ“ˆâ†—ï¸â†”ï¸â†˜ï¸ğŸ“‰]/g, '')}</div>
                                <div class="regime-count">${info.count}</div>
                                <div class="regime-desc">${info.suggestion}</div>
                                <div class="symbol-list">
                                    ${info.symbols.slice(0, 5).map(s => `<span class="symbol-tag">${s.symbol}</span>`).join('')}
                                    ${info.count > 5 ? `<span class="symbol-tag">+${info.count - 5}</span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                }
            } catch (e) {
                container.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
            }
        }

        // æ£€æµ‹å•ä¸ªäº¤æ˜“å¯¹è¡Œæƒ…
        async function detectRegime() {
            const symbol = document.getElementById('detect-symbol').value;
            const timeframe = document.getElementById('detect-timeframe').value;
            const resultDiv = document.getElementById('detect-result');

            resultDiv.innerHTML = '<div class="loading">æ£€æµ‹ä¸­...</div>';

            try {
                const resp = await fetch(`/api/market-regime/detect/${encodeURIComponent(symbol)}?timeframe=${timeframe}`);
                const data = await resp.json();

                if (data.success) {
                    const r = data.data;
                    const scoreColor = r.regime_score > 20 ? 'score-positive' : (r.regime_score < -20 ? 'score-negative' : 'score-neutral');
                    const scoreWidth = Math.min(Math.abs(r.regime_score), 100);

                    resultDiv.innerHTML = `
                        <div class="card" style="margin: 0;">
                            <h3>${r.regime_display}</h3>
                            <p>å¾—åˆ†: ${r.regime_score}</p>
                            <div class="score-bar">
                                <div class="score-fill ${scoreColor}" style="width: ${scoreWidth}%;"></div>
                            </div>
                            <p style="margin-top: 10px; color: #8b949e;">${r.trading_suggestion}</p>
                            <p style="margin-top: 10px; font-size: 12px; color: #6e7681;">
                                EMAå·®å€¼: ${(r.ema_diff_pct || 0).toFixed(4)}% |
                                ADX: ${(r.adx_value || 0).toFixed(2)} |
                                è¶‹åŠ¿Kçº¿: ${r.trend_bars || 0}
                            </p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="loading">${data.error || 'æ£€æµ‹å¤±è´¥'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = '<div class="loading">æ£€æµ‹å¤±è´¥: ' + e.message + '</div>';
            }
        }

        // åŠ è½½ç­–ç•¥åˆ—è¡¨
        async function loadStrategies() {
            try {
                const resp = await fetch('/api/futures/strategies');
                const data = await resp.json();

                const select = document.getElementById('strategy-select');
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç­–ç•¥ --</option>';

                // APIè¿”å›çš„æ˜¯ data.dataï¼Œä¸æ˜¯ data.strategies
                const strategies = data.data || data.strategies || [];
                if (data.success && strategies.length > 0) {
                    for (const s of strategies) {
                        select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    }
                }
            } catch (e) {
                console.error('åŠ è½½ç­–ç•¥å¤±è´¥:', e);
            }
        }

        // åŠ è½½ç­–ç•¥çš„è¡Œæƒ…å‚æ•°
        async function loadStrategyParams() {
            const strategyId = document.getElementById('strategy-select').value;
            if (!strategyId) {
                document.getElementById('params-config').style.display = 'none';
                return;
            }

            currentStrategyId = strategyId;
            document.getElementById('params-config').style.display = 'block';

            try {
                const resp = await fetch(`/api/market-regime/params/${strategyId}`);
                const data = await resp.json();

                const tbody = document.getElementById('params-table');

                if (data.success && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(p => `
                        <tr>
                            <td>${p.regime_display}</td>
                            <td>
                                <span class="status-badge ${p.enabled ? 'status-enabled' : 'status-disabled'}">
                                    ${p.enabled ? 'å¯ç”¨äº¤æ˜“' : 'ç¦ç”¨äº¤æ˜“'}
                                </span>
                            </td>
                            <td style="font-size: 12px; max-width: 300px; overflow: hidden;">
                                ${formatParams(p.params)}
                            </td>
                            <td style="font-size: 12px; color: #8b949e;">${p.description || '-'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editParam('${p.regime_type}', ${JSON.stringify(p).replace(/"/g, '&quot;')})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteParam('${p.regime_type}')">åˆ é™¤</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">æš‚æ— é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ é…ç½®"åˆ›å»º</td></tr>';
                }
            } catch (e) {
                console.error('åŠ è½½å‚æ•°å¤±è´¥:', e);
            }
        }

        function formatParams(params) {
            if (!params) return '-';
            const items = [];
            if (params.sustainedTrend !== undefined) items.push(`æŒç»­è¶‹åŠ¿: ${params.sustainedTrend ? 'æ˜¯' : 'å¦'}`);
            if (params.sustainedTrendMinStrength) items.push(`æœ€å°å¼ºåº¦: ${params.sustainedTrendMinStrength}%`);
            // å¤„ç†æ–°çš„ allowDirection æ ¼å¼
            if (params.allowDirection) {
                const dirMap = {
                    'both': 'åŒå‘',
                    'long_only': 'ä»…åšå¤š',
                    'short_only': 'ä»…åšç©º',
                    'none': 'ç¦æ­¢äº¤æ˜“'
                };
                items.push(`æ–¹å‘: ${dirMap[params.allowDirection] || params.allowDirection}`);
            } else {
                // å…¼å®¹æ—§æ ¼å¼
                if (params.allowLong !== undefined) items.push(`åšå¤š: ${params.allowLong ? 'æ˜¯' : 'å¦'}`);
                if (params.allowShort !== undefined) items.push(`åšç©º: ${params.allowShort ? 'æ˜¯' : 'å¦'}`);
            }
            if (params.stopLossPercent) items.push(`æ­¢æŸ: ${params.stopLossPercent}%`);
            if (params.takeProfitPercent) items.push(`æ­¢ç›ˆ: ${params.takeProfitPercent}%`);
            return items.join(' | ') || JSON.stringify(params);
        }

        // æ‰“å¼€æ·»åŠ å‚æ•°æ¨¡æ€æ¡†
        function openAddParamModal() {
            document.getElementById('modal-title').textContent = 'æ·»åŠ è¡Œæƒ…å‚æ•°';
            document.getElementById('param-regime-type').disabled = false;
            document.getElementById('param-form').reset();
            document.getElementById('param-enabled').checked = true;
            document.getElementById('param-allow-direction').value = 'both';
            document.getElementById('param-modal').style.display = 'block';
        }

        // ç¼–è¾‘å‚æ•°
        function editParam(regimeType, paramData) {
            document.getElementById('modal-title').textContent = 'ç¼–è¾‘è¡Œæƒ…å‚æ•°';
            document.getElementById('param-regime-type').value = regimeType;
            document.getElementById('param-regime-type').disabled = true;
            document.getElementById('param-enabled').checked = paramData.enabled;

            const p = paramData.params || {};
            document.getElementById('param-sustained-trend').checked = p.sustainedTrend || false;
            document.getElementById('param-min-strength').value = p.sustainedTrendMinStrength || 0.3;
            document.getElementById('param-max-strength').value = p.sustainedTrendMaxStrength || 2.0;

            // å¤„ç†æ–°çš„ allowDirection æ ¼å¼ï¼Œå…¼å®¹æ—§æ ¼å¼
            if (p.allowDirection) {
                document.getElementById('param-allow-direction').value = p.allowDirection;
            } else {
                // ä»æ—§çš„ allowLong/allowShort è½¬æ¢
                if (p.allowLong === false && p.allowShort === false) {
                    document.getElementById('param-allow-direction').value = 'none';
                } else if (p.allowLong === false) {
                    document.getElementById('param-allow-direction').value = 'short_only';
                } else if (p.allowShort === false) {
                    document.getElementById('param-allow-direction').value = 'long_only';
                } else {
                    document.getElementById('param-allow-direction').value = 'both';
                }
            }

            document.getElementById('param-stop-loss').value = p.stopLossPercent || 3.0;
            document.getElementById('param-take-profit').value = p.takeProfitPercent || 6.0;
            document.getElementById('param-description').value = paramData.description || '';

            document.getElementById('param-modal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('param-modal').style.display = 'none';
        }

        // ä¿å­˜å‚æ•°
        document.getElementById('param-form').onsubmit = async function(e) {
            e.preventDefault();

            const allowDirection = document.getElementById('param-allow-direction').value;
            const params = {
                sustainedTrend: document.getElementById('param-sustained-trend').checked,
                sustainedTrendMinStrength: parseFloat(document.getElementById('param-min-strength').value),
                sustainedTrendMaxStrength: parseFloat(document.getElementById('param-max-strength').value),
                allowDirection: allowDirection,
                // åŒæ—¶ä¿å­˜å…¼å®¹æ ¼å¼
                allowLong: allowDirection === 'both' || allowDirection === 'long_only',
                allowShort: allowDirection === 'both' || allowDirection === 'short_only',
                stopLossPercent: parseFloat(document.getElementById('param-stop-loss').value),
                takeProfitPercent: parseFloat(document.getElementById('param-take-profit').value)
            };

            const body = {
                strategy_id: parseInt(currentStrategyId),
                regime_type: document.getElementById('param-regime-type').value,
                enabled: document.getElementById('param-enabled').checked,
                params: params,
                description: document.getElementById('param-description').value
            };

            try {
                const resp = await fetch('/api/market-regime/params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await resp.json();

                if (data.success) {
                    closeModal();
                    // æ˜¾ç¤ºæˆåŠŸå¯¹è¯æ¡†
                    const regimeNames = {
                        'strong_uptrend': 'å¼ºè¶‹åŠ¿ä¸Šæ¶¨',
                        'weak_uptrend': 'å¼±è¶‹åŠ¿ä¸Šæ¶¨',
                        'ranging': 'éœ‡è¡è¡Œæƒ…',
                        'weak_downtrend': 'å¼±è¶‹åŠ¿ä¸‹è·Œ',
                        'strong_downtrend': 'å¼ºè¶‹åŠ¿ä¸‹è·Œ'
                    };
                    const regimeType = document.getElementById('param-regime-type').value;
                    const regimeName = regimeNames[regimeType] || regimeType;
                    const enabled = document.getElementById('param-enabled').checked;

                    await showSuccessDialog(
                        'ä¿å­˜æˆåŠŸ',
                        `<div style="text-align: left;">
                            <p style="margin-bottom: 12px;"><strong>${regimeName}</strong> å‚æ•°é…ç½®å·²ä¿å­˜</p>
                            <div style="background: #21262d; padding: 12px; border-radius: 6px; font-size: 13px;">
                                <p>â€¢ äº¤æ˜“çŠ¶æ€: <span style="color: ${enabled ? '#3fb950' : '#f85149'};">${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></p>
                                <p>â€¢ æŒç»­è¶‹åŠ¿: ${params.sustainedTrend ? 'æ˜¯' : 'å¦'}</p>
                                <p>â€¢ å¼ºåº¦èŒƒå›´: ${params.sustainedTrendMinStrength}% ~ ${params.sustainedTrendMaxStrength}%</p>
                                <p>â€¢ æ­¢æŸ/æ­¢ç›ˆ: ${params.stopLossPercent}% / ${params.takeProfitPercent}%</p>
                            </div>
                        </div>`
                    );
                    loadStrategyParams();
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + (data.detail || data.message), 'error', 5000);
                }
            } catch (e) {
                showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error', 5000);
            }
        };

        // åˆ é™¤å‚æ•°
        async function deleteParam(regimeType) {
            const regimeNames = {
                'strong_uptrend': 'å¼ºè¶‹åŠ¿ä¸Šæ¶¨',
                'weak_uptrend': 'å¼±è¶‹åŠ¿ä¸Šæ¶¨',
                'ranging': 'éœ‡è¡è¡Œæƒ…',
                'weak_downtrend': 'å¼±è¶‹åŠ¿ä¸‹è·Œ',
                'strong_downtrend': 'å¼ºè¶‹åŠ¿ä¸‹è·Œ'
            };
            const regimeName = regimeNames[regimeType] || regimeType;

            const confirmed = await showConfirmDialog(
                'åˆ é™¤ç¡®è®¤',
                `ç¡®å®šè¦åˆ é™¤ <strong>${regimeName}</strong> çš„å‚æ•°é…ç½®å—ï¼Ÿ<br><br><span style="color: #8b949e;">åˆ é™¤åè¯¥è¡Œæƒ…ç±»å‹å°†ä½¿ç”¨é»˜è®¤ç­–ç•¥å‚æ•°ã€‚</span>`,
                'danger'
            );

            if (!confirmed) return;

            try {
                const resp = await fetch(`/api/market-regime/params/${currentStrategyId}/${regimeType}`, {
                    method: 'DELETE'
                });
                const data = await resp.json();

                if (data.success) {
                    showToast(`${regimeName} é…ç½®å·²åˆ é™¤`, 'success');
                    loadStrategyParams();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + (data.detail || data.message), 'error', 5000);
                }
            } catch (e) {
                showToast('åˆ é™¤å¤±è´¥: ' + e.message, 'error', 5000);
            }
        }

        // åŠ è½½æ‰€æœ‰å†å²è®°å½•ï¼ˆæ”¯æŒæŒ‰äº¤æ˜“å¯¹ç­›é€‰ï¼‰
        async function loadAllHistory() {
            const symbol = document.getElementById('history-symbol').value.trim();
            const timeframe = document.getElementById('history-timeframe').value;
            const tbody = document.getElementById('history-table');

            tbody.innerHTML = '<tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>';

            try {
                // å¦‚æœæœ‰æŒ‡å®šsymbolåˆ™æŒ‰symbolæŸ¥è¯¢ï¼Œå¦åˆ™æŸ¥è¯¢å…¨éƒ¨
                let url = `/api/market-regime/changes-all?timeframe=${timeframe}&limit=50`;
                if (symbol) {
                    url = `/api/market-regime/changes/${encodeURIComponent(symbol)}?timeframe=${timeframe}&limit=50`;
                }

                const resp = await fetch(url);
                const data = await resp.json();

                if (data.success && data.data && data.data.length > 0) {
                    tbody.innerHTML = data.data.map(r => `
                        <tr>
                            <td>${formatTime(r.changed_at)}</td>
                            <td><strong>${r.symbol || '-'}</strong></td>
                            <td>${r.old_regime_display || '-'}</td>
                            <td>${r.new_regime_display}</td>
                            <td>${r.old_score || 0} &rarr; ${r.new_score || 0}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">æš‚æ— åˆ‡æ¢è®°å½•</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">åŠ è½½å¤±è´¥: ' + e.message + '</td></tr>';
            }
        }

        function formatTime(t) {
            if (!t) return '-';
            const d = new Date(t);
            return d.toLocaleString('zh-CN');
        }

        // åŠ è½½é…ç½®çš„äº¤æ˜“å¯¹åˆ—è¡¨
        async function loadSymbols() {
            try {
                const resp = await fetch('/api/futures/symbols');
                const data = await resp.json();

                const select = document.getElementById('detect-symbol');
                select.innerHTML = '';

                if (data.success && data.symbols && data.symbols.length > 0) {
                    for (const symbol of data.symbols) {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = symbol;
                        select.appendChild(option);
                    }
                } else {
                    select.innerHTML = '<option value="BTC/USDT">BTC/USDT</option>';
                }
            } catch (e) {
                console.error('åŠ è½½äº¤æ˜“å¯¹å¤±è´¥:', e);
                document.getElementById('detect-symbol').innerHTML = '<option value="BTC/USDT">BTC/USDT</option>';
            }
        }

        // ==================== ç†”æ–­çŠ¶æ€ ====================

        // åŠ è½½ç†”æ–­çŠ¶æ€
        async function loadCircuitBreakerStatus() {
            try {
                const resp = await fetch('/api/market-regime/circuit-breaker/status');
                const data = await resp.json();

                if (data.success) {
                    updateBreakerDisplay('long', data.data.long);
                    updateBreakerDisplay('short', data.data.short);
                }
            } catch (e) {
                console.error('åŠ è½½ç†”æ–­çŠ¶æ€å¤±è´¥:', e);
            }
        }

        function updateBreakerDisplay(direction, info) {
            const statusEl = document.getElementById(`${direction}-status`);
            const lossesEl = document.getElementById(`${direction}-losses`);
            const clearBtn = document.getElementById(`${direction}-clear-btn`);
            const cardEl = document.getElementById(`${direction}-breaker`);

            if (info.is_active) {
                statusEl.innerHTML = '<span style="color: #f85149;">ğŸš¨ ç†”æ–­ä¸­</span>';
                statusEl.style.color = '#f85149';
                lossesEl.textContent = info.description;
                clearBtn.style.display = 'inline-block';
                cardEl.style.background = 'rgba(248, 81, 73, 0.1)';
                cardEl.style.borderColor = '#f85149';
            } else {
                statusEl.innerHTML = '<span style="color: #3fb950;">âœ“ æ­£å¸¸</span>';
                statusEl.style.color = '#3fb950';
                lossesEl.textContent = info.description;
                clearBtn.style.display = 'none';
                cardEl.style.background = '#21262d';
                cardEl.style.borderColor = '#30363d';
            }
        }

        // æ¸…é™¤ç†”æ–­
        async function clearBreaker(direction) {
            const confirmed = await showConfirmDialog(
                'è§£é™¤ç†”æ–­',
                `ç¡®å®šè¦è§£é™¤ <strong>${direction === 'long' ? 'åšå¤š' : 'åšç©º'}</strong> æ–¹å‘çš„ç†”æ–­å—ï¼Ÿ<br><br><span style="color: #d29922;">æ³¨æ„ï¼šå¦‚æœå¸‚åœºæ¡ä»¶æœªæ”¹å–„ï¼Œå¯èƒ½ä¼šå†æ¬¡è§¦å‘ç†”æ–­</span>`,
                'warning'
            );

            if (!confirmed) return;

            try {
                const resp = await fetch(`/api/market-regime/circuit-breaker/clear?direction=${direction}`, {
                    method: 'POST'
                });
                const data = await resp.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadCircuitBreakerStatus();
                } else {
                    showToast('è§£é™¤å¤±è´¥: ' + (data.detail || data.message), 'error');
                }
            } catch (e) {
                showToast('è§£é™¤å¤±è´¥: ' + e.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½
        window.onload = function() {
            loadSummary();
            loadStrategies();
            loadSymbols();  // åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨
            loadAllHistory();  // è‡ªåŠ¨åŠ è½½åˆ‡æ¢å†å²
            loadCircuitBreakerStatus();  // åŠ è½½ç†”æ–­çŠ¶æ€
        };
    </script>
</body>
</html>
