<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ‹Ÿåˆçº¦äº¤æ˜“ - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; }
        .header-actions { display: flex; gap: var(--spacing-md); align-items: center; flex-wrap: wrap; }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: 0; }
        .trades-card .card-body { padding: var(--spacing-md); }
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: var(--spacing-md); }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-lg); text-align: center; transition: all var(--transition-base); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary-blue), var(--secondary-purple)); opacity: 0; transition: opacity var(--transition-base); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--primary-blue); }
        .stat-card:hover::before { opacity: 1; }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); font-weight: 600; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-xs); font-family: var(--font-mono); }
        .stat-change { font-size: 13px; color: var(--text-secondary); }
        .stat-change.positive { color: var(--success-green); }
        .stat-change.negative { color: var(--danger-red); }
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border-default); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        thead { background: var(--bg-tertiary); border-bottom: 2px solid var(--border-default); }
        th { padding: var(--spacing-md) var(--spacing-lg); text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: var(--spacing-lg); border-bottom: 1px solid var(--border-default); color: var(--text-primary); font-size: 13px; }
        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color var(--transition-fast); }
        tbody tr:hover { background: var(--bg-hover); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 500; line-height: 1; text-decoration: none; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); white-space: nowrap; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-blue-hover); border-color: var(--primary-blue-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-success { background: var(--success-green); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #DC2626; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--border-muted); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border-color: transparent; }
        .btn-ghost:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
        .btn-sm { padding: var(--spacing-sm) var(--spacing-md); font-size: 12px; }
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
        .badge-success { background: var(--success-green-bg); color: var(--success-green); }
        .badge-danger { background: var(--danger-red-bg); color: var(--danger-red); }
        .badge-info { background: var(--primary-blue-light); color: var(--primary-blue); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .pnl-positive { color: var(--success-green); }
        .pnl-negative { color: var(--danger-red); }
        .status-indicator { display: inline-flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-full); font-size: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .status-dot.online { background: var(--success-green); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .empty-state-icon { font-size: 48px; margin-bottom: var(--spacing-lg); opacity: 0.5; }
        .empty-state-text { font-size: 15px; margin-bottom: var(--spacing-sm); }
        .loading-overlay { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--bg-tertiary); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-success { color: var(--success-green); }
        .text-danger { color: var(--danger-red); }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--spacing-sm); }
        .gap-md { gap: var(--spacing-md); }
        .mb-sm { margin-bottom: var(--spacing-sm); }
        .font-mono { font-family: var(--font-mono); }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 11px; }
        .text-lg { font-size: 16px; }
        .position-card { 
            background: var(--bg-card); 
            border: 1px solid var(--border-default); 
            border-left-width: 4px; 
            border-radius: var(--radius-md); 
            padding: 16px; 
            transition: all var(--transition-base);
        }
        .position-card:hover { 
            border-color: var(--border-muted); 
            box-shadow: var(--shadow-md); 
            background: var(--bg-hover);
        }
        .position-card.long { border-left-color: var(--success-green); }
        .position-card.short { border-left-color: var(--danger-red); }
        .last-update { font-size: 12px; color: var(--text-secondary); }
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
        .form-control { width: 100%; padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: var(--font-family); transition: all var(--transition-base); }
        .form-control:focus { outline: none; border-color: var(--primary-blue); background: var(--bg-card); box-shadow: 0 0 0 3px rgba(43, 111, 237, 0.1); }
        .form-control:disabled, .form-control[readonly] { opacity: 0.6; cursor: not-allowed; background: var(--bg-secondary); }
        select.form-control { cursor: pointer; }
        input[type="number"].form-control { font-family: var(--font-mono); }
        .toast { 
            position: fixed; 
            bottom: 24px; 
            right: 24px; 
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-lg); 
            padding: var(--spacing-lg); 
            box-shadow: var(--shadow-xl); 
            z-index: 10000; 
            min-width: 320px; 
            max-width: 520px; 
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            transition: all var(--transition-base);
        }
        .toast:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl), 0 0 20px rgba(43, 111, 237, 0.2);
        }
        @keyframes slideInRight { 
            from { 
                transform: translateX(120%); 
                opacity: 0; 
            } 
            to { 
                transform: translateX(0); 
                opacity: 1; 
            } 
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }
        .toast.success { 
            border-left: 4px solid var(--success-green);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-card) 100%);
        }
        .toast.error { 
            border-left: 4px solid var(--danger-red);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-card) 100%);
        }
        .toast.info { 
            border-left: 4px solid var(--info-blue);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--bg-card) 100%);
        }
        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-dialog {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 0;
            min-width: 400px;
            max-width: 500px;
            box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        @keyframes slideUp {
            from {
                transform: translateY(20px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-default);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            border: 2px solid rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .modal-body {
            padding: var(--spacing-xl);
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 14px;
        }
        .modal-footer {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-top: 1px solid var(--border-default);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            background: var(--bg-secondary);
        }
        .trading-layout { display: grid; grid-template-columns: 400px 1fr; gap: var(--spacing-xl); align-items: stretch; }
        .trading-panel-wrapper { display: flex; flex-direction: column; height: 100%; }
        .positions-trades-wrapper { display: flex; flex-direction: column; gap: var(--spacing-xl); height: 100%; }
        .positions-card, .trades-card { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        .positions-card .card-body, .trades-card .card-body { flex: 1; overflow-y: auto; min-height: 0; display: flex; flex-direction: column; }
        .positions-card .card-body::-webkit-scrollbar, .trades-card .card-body::-webkit-scrollbar { width: 6px; }
        .positions-card .card-body::-webkit-scrollbar-track, .trades-card .card-body::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .positions-card .card-body::-webkit-scrollbar-thumb, .trades-card .card-body::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
        .positions-card .card-body::-webkit-scrollbar-thumb:hover, .trades-card .card-body::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        @media (max-width: 1400px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .trading-layout { grid-template-columns: 350px 1fr; }
        }
        @media (max-width: 1200px) {
            .trading-layout { grid-template-columns: 1fr; align-items: start; }
            .trading-panel-wrapper, .positions-trades-wrapper { height: auto; }
            .positions-card, .trades-card { min-height: 400px; }
        }
        @media (max-width: 768px) {
            .container { padding: var(--spacing-md); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); }
            .stat-value { font-size: 20px; }
            .stat-label { font-size: 11px; }
            .stat-card { padding: var(--spacing-md); }
            .nav-links { flex-direction: column; }
            th, td { padding: var(--spacing-sm); font-size: 11px; }
            .trading-layout { grid-template-columns: 1fr; gap: var(--spacing-lg); }
        }

        /* Tab pagination styles */
        .tab-content-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .tab-content-container::-webkit-scrollbar {
            width: 8px;
        }
        .tab-content-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .tab-content-container::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }
        .tab-content-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        .tab-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg) 0;
            border-top: 1px solid var(--border-default);
            margin-top: var(--spacing-lg);
            flex-shrink: 0;
        }
        .tab-pagination-info {
            color: var(--text-secondary);
            font-size: 13px;
        }
        .tab-pagination-controls {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }
        .tab-pagination-select {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
        }
        .tab-pagination-select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        .tab-pagination-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            transition: all var(--transition-fast);
        }
        .tab-pagination-btn:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--primary-blue);
        }
        .tab-pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <img src="/static/images/logo/alphaflow-logo-icon.svg" alt="AlphaFlow" style="height: 36px; width: auto;">
                        <div>
                            <h1 class="header-title" style="margin: 0;">
                                <i class="bi bi-graph-up-arrow"></i>
                                æ¨¡æ‹Ÿåˆçº¦äº¤æ˜“
                            </h1>
                            <p class="header-subtitle">
                                <span class="status-indicator">
                                    <span class="status-dot online"></span>
                                    ç³»ç»Ÿè¿è¡Œä¸­
                                </span>
                                <span style="margin-left: 16px;">æœ€åæ›´æ–°: <span id="lastUpdate" class="last-update">--</span></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-container slide-up">
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> é¦–é¡µ
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/technical-signals" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> æŠ€æœ¯ä¿¡å·
                </a>
                <a href="/paper_trading" class="nav-link">
                    <i class="bi bi-journals"></i> æ¨¡æ‹Ÿç°è´§
                </a>
                <a href="/futures_trading" class="nav-link active">
                    <i class="bi bi-graph-up-arrow"></i> æ¨¡æ‹Ÿåˆçº¦
                </a>
                <a href="/live_trading" class="nav-link">
                    <i class="bi bi-currency-exchange"></i> å®ç›˜åˆçº¦
                </a>
                <a href="/trading-strategies" class="nav-link">
                    <i class="bi bi-diagram-3"></i> äº¤æ˜“ç­–ç•¥
                </a>
                <a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF æ•°æ®
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> ä¼ä¸šé‡‘åº“
                </a>
                <a href="/blockchain_gas" class="nav-link">
                    <i class="bi bi-lightning-charge"></i> Gasç»Ÿè®¡
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> æ•°æ®ç®¡ç†
                </a>
            </div>
        </nav>

        <!-- Account Overview -->
        <div class="card slide-up">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-wallet2"></i>
                    <span id="account-title">è´¦æˆ·æ€»è§ˆ</span>
                </h2>
                <div class="last-update" id="account-update">-</div>
            </div>
            <div class="card-body">
                <div id="accountLoading" class="loading-overlay">
                    <div class="spinner"></div>
                </div>
                <div id="accountStats" class="stats-grid" style="display: none;">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- Trading Panel and Positions Side by Side -->
        <div class="trading-layout">
            <!-- Trading Panel -->
            <div class="card slide-up trading-panel-wrapper" style="margin-bottom: 0;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="bi bi-currency-exchange"></i>
                        äº¤æ˜“é¢æ¿
                    </h2>
                </div>
                <div class="card-body">
                    <form id="trade-form">
                        <div class="form-group">
                            <label class="form-label">äº¤æ˜“å¯¹</label>
                            <select class="form-control" id="symbol" required>
                                <option value="">åŠ è½½ä¸­...</option>
                            </select>
                        </div>
                    <div class="form-group">
                        <div class="d-flex justify-between align-center" style="margin-bottom: var(--spacing-sm);">
                            <label class="form-label" style="margin-bottom: 0;">
                                å½“å‰ä»·æ ¼: <span id="current-price-display" class="font-mono" style="color: var(--primary-blue); font-weight: 600; margin-left: 8px; display: inline-block; transition: all 0.3s ease;">--</span>
                                <span id="price-change-indicator" style="margin-left: 8px; font-size: 12px; font-weight: 600; opacity: 0; transition: opacity 0.3s ease;"></span>
                            </label>
                            <button type="button" class="btn btn-sm btn-ghost" onclick="refreshPrice()" style="padding: 4px 8px; min-width: auto;">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <input type="number" class="form-control" id="current-price" step="0.00000001" placeholder="è¾“å…¥é™ä»·ä»·æ ¼ï¼ˆå¯é€‰ï¼‰">
                        <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                            ä¸Šæ–¹æ˜¾ç¤ºå®æ—¶åˆçº¦ä»·æ ¼ï¼Œä¸‹æ–¹å¯è¾“å…¥é™ä»·å•ä»·æ ¼<br>
                            <span style="color: var(--warning-yellow);">âš  é™ä»·å•è¶…æ—¶åï¼Œè‹¥ä»·æ ¼åç¦»è¶…è¿‡1%å°†è‡ªåŠ¨å–æ¶ˆ</span>
                        </small>
                    </div>
                        <div class="form-group">
                            <label class="form-label">æ–¹å‘</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                <button type="button" class="btn btn-success" id="long-btn" onclick="selectPositionSide('LONG')" style="width: 100%;">
                                    <i class="bi bi-arrow-up-circle"></i> åšå¤š
                                </button>
                                <button type="button" class="btn btn-secondary" id="short-btn" onclick="selectPositionSide('SHORT')" style="width: 100%;">
                                    <i class="bi bi-arrow-down-circle"></i> åšç©º
                                </button>
                            </div>
                            <input type="hidden" id="position-side" value="LONG">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ æ†å€æ•°</label>
                            <select class="form-control" id="leverage" required>
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="5">5x</option>
                                <option value="10" selected>10x</option>
                                <option value="20">20x</option>
                                <option value="50">50x</option>
                                <option value="100">100x</option>
                                <option value="125">125x</option>
                            </select>
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                æ æ†è¶Šé«˜ï¼Œé£é™©è¶Šå¤§ï¼Œè¯·è°¨æ…é€‰æ‹©
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ•°é‡</label>
                            <input type="number" class="form-control" id="quantity" step="0.00000001" required placeholder="è¯·è¾“å…¥æ•°é‡">
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                é¢„è®¡ä¿è¯é‡‘: <span id="estimated-margin" class="font-mono">0.00</span> USDT
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ­¢æŸä»·ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="number" class="form-control" id="stop-loss-price" step="0.00000001" placeholder="è®¾ç½®æ­¢æŸä»·æ ¼">
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                å½“ä»·æ ¼è¾¾åˆ°æ­¢æŸä»·æ—¶å°†è‡ªåŠ¨å¹³ä»“
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ­¢ç›ˆä»·ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="number" class="form-control" id="take-profit-price" step="0.00000001" placeholder="è®¾ç½®æ­¢ç›ˆä»·æ ¼">
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                å½“ä»·æ ¼è¾¾åˆ°æ­¢ç›ˆä»·æ—¶å°†è‡ªåŠ¨å¹³ä»“
                            </small>
                        </div>
                        <div style="margin-top: var(--spacing-xl);">
                            <button type="button" class="btn btn-primary" style="width: 100%;" onclick="openPosition()">
                                <i class="bi bi-play-circle"></i> å¼€ä»“
                            </button>
                        </div>
                    </form>
                    <div id="trade-result" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- Right Column: Positions and Recent Trades -->
            <div class="positions-trades-wrapper">
                <!-- Open Positions -->
                <div class="card slide-up positions-card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <div style="display: flex; gap: var(--spacing-md); align-items: center; flex: 1; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="tabPositionsTitle" onclick="showPositionsTab('positions')" style="font-size: 14px; font-weight: 600; padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-md); box-shadow: var(--shadow-md);">
                                <i class="bi bi-briefcase"></i>
                                <span id="positions-title">æŒä»“ä¸­</span>
                            </button>
                            <button class="btn btn-secondary" id="tabOrdersTitle" onclick="showPositionsTab('orders')" style="font-size: 14px; font-weight: 600; padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); opacity: 0.7;">
                                <i class="bi bi-hourglass-split"></i>
                                <span id="orders-title">æœªæˆäº¤è®¢å•</span>
                            </button>
                            <button class="btn btn-secondary" id="tabCancelledTitle" onclick="showPositionsTab('cancelled')" style="font-size: 14px; font-weight: 600; padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); opacity: 0.7;">
                                <i class="bi bi-x-circle"></i>
                                <span id="cancelled-title">å·²å–æ¶ˆè®¢å•</span>
                            </button>
                        </div>
                        <div class="d-flex align-center gap-md">
                            <span class="badge badge-info" id="positionCount" style="display: none;">0 ä¸ªæŒä»“</span>
                            <span class="badge badge-warning" id="orderCount" style="display: none;">0 ä¸ªè®¢å•</span>
                            <span class="badge badge-secondary" id="cancelledCount" style="display: none;">0 ä¸ªå·²å–æ¶ˆ</span>
                            <div class="last-update" id="positions-update">-</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- æŒä»“ä¸­æ ‡ç­¾é¡µ -->
                        <div id="positionsTab">
                            <div id="positionsLoading" class="loading-overlay" style="min-height: 200px;">
                                <div class="spinner"></div>
                            </div>
                            <div id="positionsTable" style="display: none;">
                                <div class="tab-content-container" id="positionsBodyContainer">
                                    <div id="positionsBody" style="display: flex; flex-direction: column; gap: 12px;">
                                        <!-- åŠ¨æ€åŠ è½½æŒä»“å¡ç‰‡ -->
                                    </div>
                                </div>
                                <div class="tab-pagination" id="positionsPagination" style="display: none;">
                                    <div class="tab-pagination-info">
                                        æ˜¾ç¤º <span id="positionsPageStart">0</span> - <span id="positionsPageEnd">0</span> / å…± <span id="positionsTotalRows">0</span> æ¡
                                    </div>
                                    <div class="tab-pagination-controls">
                                        <label style="color: var(--text-secondary); font-size: 13px; margin-right: var(--spacing-sm);">æ¯é¡µæ˜¾ç¤º:</label>
                                        <select id="positionsRowsPerPage" class="tab-pagination-select" onchange="changePositionsRowsPerPage()">
                                            <option value="10" selected>10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                        <button class="tab-pagination-btn" id="positionsPrevBtn" onclick="changePositionsPage(-1)">
                                            <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
                                        </button>
                                        <span style="color: var(--text-secondary); font-size: 13px; padding: 0 var(--spacing-md);">
                                            ç¬¬ <span id="positionsCurrentPage">1</span> / <span id="positionsTotalPages">1</span> é¡µ
                                        </span>
                                        <button class="tab-pagination-btn" id="positionsNextBtn" onclick="changePositionsPage(1)">
                                            ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="positionsEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <div class="empty-state-text">æš‚æ— æŒä»“</div>
                                <p class="text-sm text-secondary" style="margin-top: 8px;">ç³»ç»Ÿä¼šæ¯30åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æŠ•èµ„å»ºè®®å¹¶å¼€ä»“</p>
                            </div>
                        </div>
                        
                        <!-- æœªæˆäº¤è®¢å•æ ‡ç­¾é¡µ -->
                        <div id="ordersTab" style="display: none;">
                            <div id="ordersLoading" class="loading-overlay" style="min-height: 200px;">
                                <div class="spinner"></div>
                            </div>
                            <div id="ordersTable" style="display: none;">
                                <div class="tab-content-container">
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>äº¤æ˜“å¯¹</th>
                                                    <th>æ–¹å‘</th>
                                                    <th>è®¢å•ç±»å‹</th>
                                                    <th>æ æ†</th>
                                                    <th>å§”æ‰˜ä»·æ ¼</th>
                                                    <th>æ•°é‡</th>
                                                    <th>å·²æˆäº¤</th>
                                                    <th>ä¿è¯é‡‘</th>
                                                    <th>æ­¢æŸä»·</th>
                                                    <th>æ­¢ç›ˆä»·</th>
                                                    <th>æ¥æº</th>
                                                    <th>çŠ¶æ€</th>
                                                    <th>åˆ›å»ºæ—¶é—´</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ordersBody">
                                                <!-- åŠ¨æ€åŠ è½½ -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pagination" id="ordersPagination" style="display: none;">
                                    <div class="tab-pagination-info">
                                        æ˜¾ç¤º <span id="ordersPageStart">0</span> - <span id="ordersPageEnd">0</span> / å…± <span id="ordersTotalRows">0</span> æ¡
                                    </div>
                                    <div class="tab-pagination-controls">
                                        <label style="color: var(--text-secondary); font-size: 13px; margin-right: var(--spacing-sm);">æ¯é¡µæ˜¾ç¤º:</label>
                                        <select id="ordersRowsPerPage" class="tab-pagination-select" onchange="changeOrdersRowsPerPage()">
                                            <option value="10" selected>10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                        <button class="tab-pagination-btn" id="ordersPrevBtn" onclick="changeOrdersPage(-1)">
                                            <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
                                        </button>
                                        <span style="color: var(--text-secondary); font-size: 13px; padding: 0 var(--spacing-md);">
                                            ç¬¬ <span id="ordersCurrentPage">1</span> / <span id="ordersTotalPages">1</span> é¡µ
                                        </span>
                                        <button class="tab-pagination-btn" id="ordersNextBtn" onclick="changeOrdersPage(1)">
                                            ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="ordersEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">â³</div>
                                <div class="empty-state-text">æš‚æ— æœªæˆäº¤è®¢å•</div>
                            </div>
                        </div>

                        <!-- å·²å–æ¶ˆè®¢å•æ ‡ç­¾é¡µ -->
                        <div id="cancelledTab" style="display: none;">
                            <div id="cancelledLoading" class="loading-overlay" style="min-height: 200px;">
                                <div class="spinner"></div>
                            </div>
                            <div id="cancelledTable" style="display: none;">
                                <div class="tab-content-container">
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>äº¤æ˜“å¯¹</th>
                                                    <th>æ–¹å‘</th>
                                                    <th>è®¢å•ç±»å‹</th>
                                                    <th>æ æ†</th>
                                                    <th>å§”æ‰˜ä»·æ ¼</th>
                                                    <th>æ•°é‡</th>
                                                    <th>ä¿è¯é‡‘</th>
                                                    <th>æ­¢æŸä»·</th>
                                                    <th>æ­¢ç›ˆä»·</th>
                                                    <th>å–æ¶ˆåŸå› </th>
                                                    <th>æ¥æº</th>
                                                    <th>åˆ›å»ºæ—¶é—´</th>
                                                    <th>å–æ¶ˆæ—¶é—´</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cancelledBody">
                                                <!-- åŠ¨æ€åŠ è½½ -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pagination" id="cancelledPagination" style="display: none;">
                                    <div class="tab-pagination-info">
                                        æ˜¾ç¤º <span id="cancelledPageStart">0</span> - <span id="cancelledPageEnd">0</span> / å…± <span id="cancelledTotalRows">0</span> æ¡
                                    </div>
                                    <div class="tab-pagination-controls">
                                        <label style="color: var(--text-secondary); font-size: 13px; margin-right: var(--spacing-sm);">æ¯é¡µæ˜¾ç¤º:</label>
                                        <select id="cancelledRowsPerPage" class="tab-pagination-select" onchange="changeCancelledRowsPerPage()">
                                            <option value="10" selected>10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                        <button class="tab-pagination-btn" id="cancelledPrevBtn" onclick="changeCancelledPage(-1)">
                                            <i class="bi bi-chevron-left"></i> ä¸Šä¸€é¡µ
                                        </button>
                                        <span style="color: var(--text-secondary); font-size: 13px; padding: 0 var(--spacing-md);">
                                            ç¬¬ <span id="cancelledCurrentPage">1</span> / <span id="cancelledTotalPages">1</span> é¡µ
                                        </span>
                                        <button class="tab-pagination-btn" id="cancelledNextBtn" onclick="changeCancelledPage(1)">
                                            ä¸‹ä¸€é¡µ <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="cancelledEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">âœ…</div>
                                <div class="empty-state-text">æš‚æ— å·²å–æ¶ˆè®¢å•</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Trades -->
                <div class="card slide-up trades-card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="bi bi-clock-history"></i>
                            <span id="trades-title">æœ€è¿‘äº¤æ˜“è®°å½•</span>
                        </h2>
                        <div class="last-update" id="trades-update">-</div>
                    </div>
                    <div class="card-body" style="padding: var(--spacing-md); display: flex; flex-direction: column; flex: 1; min-height: 0;">
                        <div id="tradesLoading" class="loading-overlay" style="min-height: 200px; flex: 1;">
                            <div class="spinner"></div>
                        </div>
                        <div id="tradesTable" style="display: none; flex-direction: column; min-height: 0;">
                            <div class="table-container" style="flex: 1; overflow-y: auto; min-height: 0;">
                                <table>
                                    <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 10;">
                                        <tr>
                                            <th>äº¤æ˜“å¯¹</th>
                                            <th>æ–¹å‘</th>
                                            <th>æ æ†</th>
                                            <th>ä»·æ ¼</th>
                                            <th>æ•°é‡</th>
                                            <th>å·²å®ç°ç›ˆäº</th>
                                            <th>ROI</th>
                                            <th>å¹³ä»“åŸå› </th>
                                            <th>æ­¢ç›ˆæ­¢æŸ</th>
                                            <th>æ‰‹ç»­è´¹</th>
                                            <th>å¼€ä»“æ—¶é—´</th>
                                            <th>å¹³ä»“æ—¶é—´</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tradesBody">
                                        <!-- åŠ¨æ€åŠ è½½ -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="tradesPagination" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-top: 1px solid var(--border-default); margin-top: 8px; flex-shrink: 0;">
                                <div class="text-sm text-secondary">
                                    <span id="tradesPageInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button id="tradesPrevBtn" class="btn btn-secondary" onclick="loadTradesPage(currentTradesPage - 1)" disabled style="padding: 4px 12px; font-size: 12px;">ä¸Šä¸€é¡µ</button>
                                    <button id="tradesNextBtn" class="btn btn-secondary" onclick="loadTradesPage(currentTradesPage + 1)" disabled style="padding: 4px 12px; font-size: 12px;">ä¸‹ä¸€é¡µ</button>
                                </div>
                            </div>
                        </div>
                        <div id="tradesEmpty" class="empty-state" style="display: none; flex: 1; align-items: center; justify-content: center;">
                            <div>
                                <div class="empty-state-icon">ğŸ“œ</div>
                                <div class="empty-state-text">æš‚æ— äº¤æ˜“è®°å½•</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        const API_BASE = '/api/futures';
        let currentSymbol = 'BTC/USDT';
        let currentPrice = 0;
        let previousPrice = 0; // ç”¨äºä»·æ ¼å˜åŒ–æ£€æµ‹
        let symbols = [];

        // Pagination variables
        let allPositions = [];
        let currentPositionsPage = 1;
        let positionsRowsPerPage = 10;

        let allOrders = [];
        let currentOrdersPage = 1;
        let ordersRowsPerPage = 10;

        let allCancelledOrders = [];
        let currentCancelledPage = 1;
        let cancelledRowsPerPage = 10;

        // åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨
        async function loadSymbols() {
            try {
                // ä»APIè·å–äº¤æ˜“å¯¹åˆ—è¡¨ï¼ˆä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
                const response = await fetch('/api/futures/symbols');
                const data = await response.json();
                
                if (data.success && data.symbols && data.symbols.length > 0) {
                    symbols = data.symbols;
                    
                    const symbolSelect = document.getElementById('symbol');
                    symbolSelect.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
                    
                    // è®¾ç½®é»˜è®¤äº¤æ˜“å¯¹
                    currentSymbol = symbols[0];
                    symbolSelect.value = currentSymbol;
                    await refreshPrice();
                } else {
                    // ä½¿ç”¨é»˜è®¤äº¤æ˜“å¯¹
                    symbols = ['BTC/USDT', 'ETH/USDT'];
                    const symbolSelect = document.getElementById('symbol');
                    symbolSelect.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
                    currentSymbol = symbols[0];
                    symbolSelect.value = currentSymbol;
                    await refreshPrice();
                }
            } catch (error) {
                // é™é»˜å¤„ç†åŠ è½½å¤±è´¥
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
                symbols = ['BTC/USDT', 'ETH/USDT'];
                const symbolSelect = document.getElementById('symbol');
                symbolSelect.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
                currentSymbol = symbols[0];
                symbolSelect.value = currentSymbol;
                showToast('åŠ è½½äº¤æ˜“å¯¹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', 'warning');
            }
        }

        // é€‰æ‹©äº¤æ˜“å¯¹
        document.getElementById('symbol').addEventListener('change', async function(e) {
            currentSymbol = e.target.value;
            // åˆ‡æ¢äº¤æ˜“å¯¹æ—¶ç«‹å³åˆ·æ–°ä»·æ ¼ï¼ˆæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼‰
            const priceDisplay = document.getElementById('current-price-display');
            priceDisplay.textContent = 'åŠ è½½ä¸­...';
            priceDisplay.style.color = 'var(--text-secondary)';
            // ç«‹å³åˆ·æ–°ï¼Œä¸ç­‰å¾…
            refreshPrice().catch(err => {
                // é™é»˜å¤„ç†ä»·æ ¼åˆ·æ–°å¤±è´¥
                priceDisplay.textContent = 'åŠ è½½å¤±è´¥';
                priceDisplay.style.color = 'var(--danger-red)';
            });
        });

        // é€‰æ‹©æ–¹å‘
        function selectPositionSide(side) {
            document.getElementById('position-side').value = side;
            const longBtn = document.getElementById('long-btn');
            const shortBtn = document.getElementById('short-btn');
            
            if (side === 'LONG') {
                longBtn.classList.remove('btn-secondary');
                longBtn.classList.add('btn-success');
                shortBtn.classList.remove('btn-danger');
                shortBtn.classList.add('btn-secondary');
            } else {
                longBtn.classList.remove('btn-success');
                longBtn.classList.add('btn-secondary');
                shortBtn.classList.remove('btn-secondary');
                shortBtn.classList.add('btn-danger');
            }
        }

        // ä»·æ ¼ç¼“å­˜ï¼ˆé¿å…é‡å¤è¯·æ±‚ï¼‰
        let futuresPriceCache = {};
        let futuresPriceCacheTime = {};
        const FUTURES_PRICE_CACHE_DURATION = 3000; // 3ç§’ç¼“å­˜

        // åˆ·æ–°ä»·æ ¼ï¼ˆä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜å’Œæ›´çŸ­çš„è¶…æ—¶ï¼‰
        async function refreshPrice() {
            const symbol = document.getElementById('symbol').value;
            if (!symbol) {
                document.getElementById('current-price-display').textContent = '--';
                currentPrice = 0;
                updateEstimatedMargin();
                return;
            }

            // æ£€æŸ¥ç¼“å­˜
            const now = Date.now();
            if (futuresPriceCache[symbol] && futuresPriceCacheTime[symbol] && (now - futuresPriceCacheTime[symbol]) < FUTURES_PRICE_CACHE_DURATION) {
                const cachedPrice = futuresPriceCache[symbol];
                currentPrice = cachedPrice;
                previousPrice = cachedPrice;
                document.getElementById('current-price-display').textContent = formatPrice(cachedPrice);
                document.getElementById('current-price-display').style.color = 'var(--primary-blue)';
                updateEstimatedMargin();
                return;
            }

            const priceDisplay = document.getElementById('current-price-display');
            
            try {
                let price = null;
                let priceSource = null;
                
                // ä½¿ç”¨åç«¯APIè·å–åˆçº¦ä»·æ ¼ï¼ˆé¿å…CORSé—®é¢˜ï¼‰
                // ä½¿ç”¨AbortControllerè®¾ç½®è¶…æ—¶ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000); // ç¼©çŸ­åˆ°2ç§’è¶…æ—¶
                
                try {
                    const response = await fetch(`/api/futures/price/${encodeURIComponent(symbol)}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.price) {
                            price = parseFloat(data.price);
                            priceSource = data.source || 'unknown';
                            // åªåœ¨è°ƒè¯•æ—¶è¾“å‡ºæ—¥å¿—
                            // console.log(`âœ… ä»åç«¯APIè·å– ${symbol} åˆçº¦ä»·æ ¼ (${priceSource}): ${price}`);
                        }
                    }
                } catch (e) {
                    clearTimeout(timeoutId);
                    // é™é»˜å¤„ç†è¶…æ—¶ï¼Œä¸è¾“å‡ºè­¦å‘Šï¼ˆå› ä¸ºä¼šè‡ªåŠ¨å›é€€åˆ°ç°è´§ä»·æ ¼ï¼‰
                    if (e.name !== 'AbortError') {
                        // å°è¯•ç°è´§ä»·æ ¼API
                    }
                }
                
                // å¦‚æœåˆçº¦ä»·æ ¼è·å–å¤±è´¥ï¼Œå›é€€åˆ°ç°è´§ä»·æ ¼APIï¼ˆä¸ä½¿ç”¨force_refreshï¼Œä½¿ç”¨ç¼“å­˜ï¼‰
                if (!price || price === 0) {
                    try {
                        const controller2 = new AbortController();
                        const timeoutId2 = setTimeout(() => controller2.abort(), 1500); // ç¼©çŸ­åˆ°1.5ç§’è¶…æ—¶
                        
                        const response = await fetch(`/api/paper-trading/price?symbol=${encodeURIComponent(symbol)}`, {
                            signal: controller2.signal
                        });
                        clearTimeout(timeoutId2);
                        
                        const data = await response.json();
                        if (data.price && data.price > 0) {
                            price = parseFloat(data.price);
                            priceSource = data.source || 'spot_cache';
                        }
                    } catch (e) {
                        if (e.name !== 'AbortError') {
                            // é™é»˜å¤„ç†è·å–å¤±è´¥
                        }
                    }
                }
                
                if (price && price > 0) {
                    // æ›´æ–°ç¼“å­˜
                    futuresPriceCache[symbol] = price;
                    futuresPriceCacheTime[symbol] = now;
                    // ä»·æ ¼å˜åŒ–æ£€æµ‹å’ŒåŠ¨ç”»
                    const priceChangeIndicator = document.getElementById('price-change-indicator');
                    if (previousPrice > 0 && previousPrice !== price) {
                        const priceChange = price - previousPrice;
                        const changePercent = ((priceChange / previousPrice) * 100).toFixed(4);
                        
                        // æ·»åŠ ä»·æ ¼å˜åŒ–åŠ¨ç”»
                        priceDisplay.style.transition = 'all 0.3s ease';
                        
                        if (priceChange > 0) {
                            // ä»·æ ¼ä¸Šæ¶¨ï¼šç»¿è‰²é—ªçƒ
                            priceDisplay.style.color = 'var(--success-green)';
                            priceDisplay.style.transform = 'scale(1.1)';
                            if (priceChangeIndicator) {
                                priceChangeIndicator.textContent = `â†‘ +${changePercent}%`;
                                priceChangeIndicator.style.color = 'var(--success-green)';
                                priceChangeIndicator.style.opacity = '1';
                                setTimeout(() => {
                                    priceChangeIndicator.style.opacity = '0';
                                }, 2000);
                            }
                            setTimeout(() => {
                                priceDisplay.style.transform = 'scale(1)';
                                priceDisplay.style.color = 'var(--primary-blue)';
                            }, 300);
                        } else {
                            // ä»·æ ¼ä¸‹è·Œï¼šçº¢è‰²é—ªçƒ
                            priceDisplay.style.color = 'var(--danger-red)';
                            priceDisplay.style.transform = 'scale(0.95)';
                            if (priceChangeIndicator) {
                                priceChangeIndicator.textContent = `â†“ ${changePercent}%`;
                                priceChangeIndicator.style.color = 'var(--danger-red)';
                                priceChangeIndicator.style.opacity = '1';
                                setTimeout(() => {
                                    priceChangeIndicator.style.opacity = '0';
                                }, 2000);
                            }
                            setTimeout(() => {
                                priceDisplay.style.transform = 'scale(1)';
                                priceDisplay.style.color = 'var(--primary-blue)';
                            }, 300);
                        }
                    } else if (previousPrice === 0) {
                        // é¦–æ¬¡åŠ è½½ï¼Œæ­£å¸¸æ˜¾ç¤º
                        priceDisplay.style.color = 'var(--primary-blue)';
                        if (priceChangeIndicator) {
                            priceChangeIndicator.style.opacity = '0';
                        }
                    }
                    
                    currentPrice = price;
                    previousPrice = price;
                    priceDisplay.textContent = formatPrice(currentPrice);
                    updateEstimatedMargin();
                } else {
                    priceDisplay.textContent = 'è·å–å¤±è´¥';
                    priceDisplay.style.color = 'var(--danger-red)';
                    currentPrice = 0;
                    previousPrice = 0;
                    showToast(`æ— æ³•è·å– ${symbol} çš„åˆçº¦ä»·æ ¼ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`, 'error');
                }
            } catch (error) {
                // é™é»˜å¤„ç†è·å–ä»·æ ¼å¤±è´¥
                priceDisplay.textContent = 'è·å–å¤±è´¥';
                priceDisplay.style.color = 'var(--danger-red)';
                currentPrice = 0;
                showToast('è·å–ä»·æ ¼å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é¢„è®¡ä¿è¯é‡‘
        function updateEstimatedMargin() {
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const leverage = parseInt(document.getElementById('leverage').value) || 1;
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä»·æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰å®æ—¶ä»·æ ¼
            const userPrice = parseFloat(document.getElementById('current-price').value) || currentPrice;
            
            if (userPrice > 0 && quantity > 0) {
                const margin = (userPrice * quantity) / leverage;
                document.getElementById('estimated-margin').textContent = margin.toFixed(2);
            } else {
                document.getElementById('estimated-margin').textContent = '0.00';
            }
        }

        // ç›‘å¬æ•°é‡ã€æ æ†å’Œä»·æ ¼è¾“å…¥å˜åŒ–
        document.getElementById('quantity').addEventListener('input', updateEstimatedMargin);
        document.getElementById('leverage').addEventListener('change', updateEstimatedMargin);
        document.getElementById('current-price').addEventListener('input', updateEstimatedMargin);

        // å¼€ä»“
        async function openPosition() {
            const symbol = document.getElementById('symbol').value;
            const positionSide = document.getElementById('position-side').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const leverage = parseInt(document.getElementById('leverage').value);
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä»·æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰å®æ—¶ä»·æ ¼
            const userPrice = parseFloat(document.getElementById('current-price').value);
            const entryPrice = userPrice && userPrice > 0 ? userPrice : currentPrice;
            const stopLossPrice = document.getElementById('stop-loss-price').value ? parseFloat(document.getElementById('stop-loss-price').value) : null;
            const takeProfitPrice = document.getElementById('take-profit-price').value ? parseFloat(document.getElementById('take-profit-price').value) : null;

            // éªŒè¯
            if (!symbol) {
                showToast('è¯·é€‰æ‹©äº¤æ˜“å¯¹', 'error');
                return;
            }
            if (!quantity || quantity <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡', 'error');
                return;
            }
            if (!entryPrice || entryPrice <= 0) {
                showToast('è¯·å…ˆè·å–å½“å‰ä»·æ ¼æˆ–è¾“å…¥é™ä»·', 'error');
                return;
            }

            const estimatedMargin = ((entryPrice * quantity) / leverage).toFixed(2);
            const priceType = userPrice && userPrice > 0 ? 'é™ä»·' : 'å¸‚ä»·';
            
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const openConfirmMsg = `
                <div style="margin-bottom: 12px;">
                    <strong>äº¤æ˜“å¯¹:</strong> ${symbol}<br>
                    <strong>æ–¹å‘:</strong> ${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}<br>
                    <strong>æ•°é‡:</strong> ${quantity}<br>
                    <strong>è®¢å•ç±»å‹:</strong> ${priceType}<br>
                    ${priceType === 'é™ä»·' ? `<strong>é™ä»·:</strong> ${formatPrice(entryPrice)}<br>` : ''}
                    <strong>æ æ†:</strong> ${leverage}x<br>
                    <strong>é¢„è®¡ä¿è¯é‡‘:</strong> ${estimatedMargin} USDT
                </div>
            `;
            const confirmed = await showConfirmDialog(
                `ç¡®å®šè¦${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}å—ï¼Ÿ`,
                openConfirmMsg,
                'info'
            );
            if (!confirmed) return;

            try {
                // å¦‚æœç”¨æˆ·è¾“å…¥äº†ä»·æ ¼ï¼Œåˆ™ä¼ é€’é™ä»·å‚æ•°
                const limitPrice = userPrice && userPrice > 0 ? userPrice : null;
                
                const response = await fetch(`${API_BASE}/open`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: 2,
                        symbol: symbol,
                        position_side: positionSide,
                        quantity: quantity,
                        leverage: leverage,
                        limit_price: limitPrice,
                        stop_loss_price: stopLossPrice,
                        take_profit_price: takeProfitPrice,
                        source: 'manual'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é™ä»·å•ï¼ˆä»dataæˆ–data.dataä¸­è·å–ï¼‰
                    const orderType = data.order_type || data.data?.order_type;
                    const orderStatus = data.status || data.data?.status;
                    
                    if (orderType === 'LIMIT' && orderStatus === 'PENDING') {
                        // é™ä»·å•æœªæˆäº¤
                        const limitPrice = data.limit_price || data.data?.limit_price;
                        const currentPrice = data.current_price || data.data?.current_price;
                        const limitMsg = `é™ä»·å•å·²åˆ›å»º\n` +
                            `äº¤æ˜“å¯¹: ${symbol}\n` +
                            `æ–¹å‘: ${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}\n` +
                            `æ•°é‡: ${quantity}\n` +
                            `é™ä»·: ${formatPrice(limitPrice)}\n` +
                            `å½“å‰ä»·: ${formatPrice(currentPrice)}\n` +
                            `æ æ†: ${leverage}x\n` +
                            `çŠ¶æ€: æœªæˆäº¤ï¼Œç­‰å¾…ä»·æ ¼è¾¾åˆ°é™ä»·\n` +
                            `âš  è¶…æ—¶åè‹¥ä»·æ ¼åç¦»è¶…è¿‡1%å°†è‡ªåŠ¨å–æ¶ˆ`;
                        showToast(limitMsg, 'info');
                    } else {
                        // å¸‚ä»·å•ç«‹å³æˆäº¤
                        const entryPrice = data.entry_price || data.data?.entry_price;
                        const margin = data.margin || data.data?.margin;
                        const successMsg = `å¼€ä»“æˆåŠŸï¼å·²æˆäº¤\n` +
                            `äº¤æ˜“å¯¹: ${symbol}\n` +
                            `æ–¹å‘: ${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}\n` +
                            `æ•°é‡: ${quantity}\n` +
                            `å¼€ä»“ä»·: ${formatPrice(entryPrice)}\n` +
                            `æ æ†: ${leverage}x\n` +
                            `ä¿è¯é‡‘: ${formatLargeNumber(margin || 0)} USDT\n` +
                            `çŠ¶æ€: å·²æˆäº¤`;
                        showToast(successMsg, 'success');
                    }
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('quantity').value = '';
                    document.getElementById('current-price').value = '';
                    document.getElementById('stop-loss-price').value = '';
                    document.getElementById('take-profit-price').value = '';
                    updateEstimatedMargin();
                    // å¼€ä»“åï¼Œæ£€æŸ¥æŒä»“æ•°é‡æ˜¯å¦å˜åŒ–ï¼Œå¦‚æœå˜åŒ–æ‰é‡æ–°åŠ è½½æŒä»“åˆ—è¡¨
                    // å¦åˆ™åªæ›´æ–°ä»·æ ¼å’Œç›ˆäº
                    setTimeout(async () => {
                        try {
                            const response = await fetch(`${API_BASE}/positions?account_id=2&status=open`);
                            const data = await response.json();
                            const positionsBody = document.getElementById('positionsBody');
                            const currentCount = positionsBody ? positionsBody.querySelectorAll('.position-card[data-symbol]').length : 0;
                            const newCount = data.success && data.data ? data.data.length : 0;
                            
                            // å¦‚æœæŒä»“æ•°é‡å˜åŒ–äº†ï¼Œæ‰é‡æ–°åŠ è½½æŒä»“åˆ—è¡¨
                            if (newCount !== currentCount) {
                                await loadPositions();
                            } else {
                                // å¦åˆ™åªæ›´æ–°ä»·æ ¼å’Œç›ˆäº
                                updatePositionsPrices();
                            }
                        } catch (e) {
                            // å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œåªæ›´æ–°ä»·æ ¼å’Œç›ˆäº
                            updatePositionsPrices();
                        }
                    }, 500);
                } else {
                    showToast('å¼€ä»“å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                // å¼€ä»“å¤±è´¥å·²åœ¨UIä¸­æ˜¾ç¤º
                showToast('å¼€ä»“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, type = 'warning') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const iconConfig = {
                    'warning': { icon: 'exclamation-triangle-fill', color: 'var(--warning-yellow)' },
                    'danger': { icon: 'x-circle-fill', color: 'var(--danger-red)' },
                    'info': { icon: 'info-circle-fill', color: 'var(--info-blue)' }
                };
                const config = iconConfig[type] || iconConfig['warning'];
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-title">
                                <div class="modal-icon" style="background: linear-gradient(135deg, ${type === 'warning' ? 'rgba(245, 158, 11, 0.2)' : type === 'danger' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(59, 130, 246, 0.2)'} 0%, ${type === 'warning' ? 'rgba(245, 158, 11, 0.1)' : type === 'danger' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)'} 100%); border-color: ${type === 'warning' ? 'rgba(245, 158, 11, 0.3)' : type === 'danger' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)'};">
                                    <i class="bi bi-${config.icon}" style="font-size: 24px; color: ${config.color};"></i>
                                </div>
                                <span>${title}</span>
                            </div>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel-btn" style="min-width: 100px;">
                                <i class="bi bi-x-circle"></i> å–æ¶ˆ
                            </button>
                            <button class="btn btn-danger" id="modal-confirm-btn" style="min-width: 100px;">
                                <i class="bi bi-check-circle"></i> ç¡®å®š
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const cancelBtn = overlay.querySelector('#modal-cancel-btn');
                const confirmBtn = overlay.querySelector('#modal-confirm-btn');
                const dialog = overlay.querySelector('.modal-dialog');
                
                const closeModal = (result) => {
                    dialog.style.animation = 'slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                    overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                    setTimeout(() => {
                        overlay.remove();
                        resolve(result);
                    }, 300);
                };
                
                cancelBtn.addEventListener('click', () => closeModal(false));
                confirmBtn.addEventListener('click', () => closeModal(true));
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(false);
                    }
                });
                
                // ESCé”®å…³é—­
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            });
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œï¼Œå¹¶è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            const escapedMessage = message
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            
            // æ ¹æ®ç±»å‹é€‰æ‹©å›¾æ ‡å’Œé¢œè‰²
            const iconMap = {
                'success': { icon: 'check-circle-fill', color: 'var(--success-green)', bg: 'rgba(16, 185, 129, 0.15)' },
                'error': { icon: 'x-circle-fill', color: 'var(--danger-red)', bg: 'rgba(239, 68, 68, 0.15)' },
                'info': { icon: 'info-circle-fill', color: 'var(--info-blue)', bg: 'rgba(59, 130, 246, 0.15)' }
            };
            const iconConfig = iconMap[type] || iconMap['info'];
            
            // è§£ææ¶ˆæ¯ï¼Œæå–æ ‡é¢˜å’Œå†…å®¹
            const lines = message.split('\n');
            const title = lines[0];
            const content = lines.slice(1).join('<br>');
            
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        border-radius: 50%; 
                        background: ${iconConfig.bg}; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        flex-shrink: 0;
                        animation: pulse 0.6s ease-out;
                    ">
                        <i class="bi bi-${iconConfig.icon}" style="font-size: 22px; color: ${iconConfig.color};"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="
                            font-weight: 600; 
                            font-size: 15px; 
                            color: var(--text-primary); 
                            margin-bottom: ${content ? '6px' : '0'};
                            line-height: 1.4;
                        ">${title}</div>
                        ${content ? `<div style="
                            font-size: 13px; 
                            color: var(--text-secondary); 
                            line-height: 1.6; 
                            white-space: normal;
                            margin-top: 4px;
                        ">${content}</div>` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(139, 148, 158, 0.1); 
                        border: none; 
                        color: var(--text-secondary); 
                        cursor: pointer; 
                        padding: 4px; 
                        width: 24px; 
                        height: 24px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        flex-shrink: 0;
                        border-radius: 4px;
                        transition: all var(--transition-fast);
                    " onmouseover="this.style.background='rgba(139, 148, 158, 0.2)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='rgba(139, 148, 158, 0.1)'; this.style.color='var(--text-secondary)'">
                        <i class="bi bi-x" style="font-size: 14px;"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // æ ¹æ®æ¶ˆæ¯é•¿åº¦è°ƒæ•´æ˜¾ç¤ºæ—¶é—´ï¼ˆå¤šè¡Œæ¶ˆæ¯æ˜¾ç¤ºæ›´é•¿æ—¶é—´ï¼‰
            const displayTime = message.split('\n').length > 3 ? 7000 : 5000;
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 400);
            }, displayTime);
        }

        // æ ¼å¼åŒ–ä»·æ ¼
        function formatPrice(price) {
            if (!price && price !== 0) return '-';
            const num = parseFloat(price);
            if (num >= 1000) return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (num >= 1) return num.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
            return num.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
        }

        // æ ¼å¼åŒ–å¤§é¢æ•°å­—
        function formatLargeNumber(num) {
            if (!num && num !== 0) return '-';
            const absNum = Math.abs(num);
            if (absNum >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (absNum >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (absNum >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toFixed(2)}`;
        }

        // åˆ‡æ¢æŒä»“é¢æ¿æ ‡ç­¾é¡µ
        function showPositionsTab(tab) {
            const positionsTab = document.getElementById('positionsTab');
            const ordersTab = document.getElementById('ordersTab');
            const cancelledTab = document.getElementById('cancelledTab');
            const positionsTitle = document.getElementById('tabPositionsTitle');
            const ordersTitle = document.getElementById('tabOrdersTitle');
            const cancelledTitle = document.getElementById('tabCancelledTitle');

            // é‡ç½®æ‰€æœ‰æ ‡ç­¾é¡µæ ·å¼
            const resetButton = (btn) => {
                btn.className = 'btn btn-secondary';
                btn.style.opacity = '0.7';
                btn.style.boxShadow = 'var(--shadow-sm)';
            };
            const activateButton = (btn) => {
                btn.className = 'btn btn-primary';
                btn.style.opacity = '1';
                btn.style.boxShadow = 'var(--shadow-md)';
            };

            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå’Œè®¡æ•°å™¨
            positionsTab.style.display = 'none';
            ordersTab.style.display = 'none';
            cancelledTab.style.display = 'none';
            document.getElementById('positionCount').style.display = 'none';
            document.getElementById('orderCount').style.display = 'none';
            document.getElementById('cancelledCount').style.display = 'none';

            resetButton(positionsTitle);
            resetButton(ordersTitle);
            resetButton(cancelledTitle);

            // æ ¹æ®tabå‚æ•°æ˜¾ç¤ºå¯¹åº”æ ‡ç­¾é¡µ
            if (tab === 'positions') {
                positionsTab.style.display = 'block';
                activateButton(positionsTitle);
                document.getElementById('positionCount').style.display = 'inline-flex';
            } else if (tab === 'orders') {
                ordersTab.style.display = 'block';
                activateButton(ordersTitle);
                document.getElementById('orderCount').style.display = 'inline-flex';
                loadOrders();
            } else if (tab === 'cancelled') {
                cancelledTab.style.display = 'block';
                activateButton(cancelledTitle);
                document.getElementById('cancelledCount').style.display = 'inline-flex';
                loadCancelledOrders();
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadData() {
            await Promise.all([
                loadAccount(),
                loadPositions(),
                loadTrades()
            ]);
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è®¢å•æ ‡ç­¾é¡µï¼Œä¹ŸåŠ è½½è®¢å•
            const ordersTab = document.getElementById('ordersTab');
            if (ordersTab && ordersTab.style.display !== 'none') {
                await loadOrders();
            }
            updateLastUpdateTime();
        }

        // åŠ è½½è´¦æˆ·ä¿¡æ¯
        async function loadAccount() {
            try {
                const response = await fetch(`${API_BASE}/account/2`);
                const data = await response.json();

                if (data.success) {
                    const account = data.data;
                    const accountStats = document.getElementById('accountStats');
                    const accountTitle = document.getElementById('account-title');

                    accountStats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-label">è´¦æˆ·ä½™é¢</div>
                            <div class="stat-value">${formatLargeNumber(account.current_balance)}</div>
                            <div class="stat-change">å¯ç”¨: ${formatLargeNumber(account.available_balance)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å†»ç»“ä¿è¯é‡‘</div>
                            <div class="stat-value">${formatLargeNumber(account.frozen_balance)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœªå®ç°ç›ˆäº</div>
                            <div class="stat-value ${account.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${account.unrealized_pnl >= 0 ? '+' : ''}${formatLargeNumber(account.unrealized_pnl)}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ€»æƒç›Š</div>
                            <div class="stat-value">${formatLargeNumber(account.total_equity)}</div>
                            <div class="stat-change ${account.total_profit_loss_pct >= 0 ? 'positive' : 'negative'}">
                                æ”¶ç›Šç‡: ${account.total_profit_loss_pct >= 0 ? '+' : ''}${account.total_profit_loss_pct.toFixed(2)}%
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å·²å®ç°ç›ˆäº</div>
                            <div class="stat-value ${account.realized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${account.realized_pnl >= 0 ? '+' : ''}${formatLargeNumber(account.realized_pnl)}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">äº¤æ˜“ç»Ÿè®¡</div>
                            <div class="stat-value">${account.total_trades || 0}</div>
                            <div class="stat-change">èƒœç‡: ${(account.win_rate || 0).toFixed(1)}%</div>
                        </div>
                    `;

                    // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæ•°é‡
                    accountTitle.textContent = `è´¦æˆ·æ€»è§ˆ [6]`;

                    document.getElementById('accountLoading').style.display = 'none';
                    accountStats.style.display = 'grid';
                    document.getElementById('account-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    throw new Error(data.message || 'åŠ è½½è´¦æˆ·å¤±è´¥');
                }
            } catch (error) {
                // é™é»˜å¤„ç†è´¦æˆ·åŠ è½½å¤±è´¥
                document.getElementById('accountLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // ========== Pagination Functions ==========

        // Positions pagination
        function updatePositionsPagination(start, end, total, current, totalPages) {
            document.getElementById('positionsPageStart').textContent = start;
            document.getElementById('positionsPageEnd').textContent = end;
            document.getElementById('positionsTotalRows').textContent = total;
            document.getElementById('positionsCurrentPage').textContent = current;
            document.getElementById('positionsTotalPages').textContent = totalPages;

            document.getElementById('positionsPrevBtn').disabled = current <= 1;
            document.getElementById('positionsNextBtn').disabled = current >= totalPages;

            // Show/hide pagination based on total rows
            const paginationEl = document.getElementById('positionsPagination');
            if (paginationEl) {
                paginationEl.style.display = total > positionsRowsPerPage ? 'flex' : 'none';
            }
        }

        function renderPositionsPage() {
            const positionsBody = document.getElementById('positionsBody');
            const totalRows = allPositions.length;
            const totalPages = Math.ceil(totalRows / positionsRowsPerPage);

            const startIndex = (currentPositionsPage - 1) * positionsRowsPerPage;
            const endIndex = Math.min(startIndex + positionsRowsPerPage, totalRows);

            const pageData = allPositions.slice(startIndex, endIndex);

            positionsBody.innerHTML = pageData.map(pos => pos.html).join('');

            updatePositionsPagination(startIndex + 1, endIndex, totalRows, currentPositionsPage, totalPages);
        }

        function changePositionsPage(direction) {
            const totalPages = Math.ceil(allPositions.length / positionsRowsPerPage);
            const newPage = currentPositionsPage + direction;

            if (newPage < 1 || newPage > totalPages) return;

            currentPositionsPage = newPage;
            renderPositionsPage();
        }

        function changePositionsRowsPerPage() {
            positionsRowsPerPage = parseInt(document.getElementById('positionsRowsPerPage').value);
            currentPositionsPage = 1;
            renderPositionsPage();
        }

        // Orders pagination
        function updateOrdersPagination(start, end, total, current, totalPages) {
            document.getElementById('ordersPageStart').textContent = start;
            document.getElementById('ordersPageEnd').textContent = end;
            document.getElementById('ordersTotalRows').textContent = total;
            document.getElementById('ordersCurrentPage').textContent = current;
            document.getElementById('ordersTotalPages').textContent = totalPages;

            document.getElementById('ordersPrevBtn').disabled = current <= 1;
            document.getElementById('ordersNextBtn').disabled = current >= totalPages;

            const paginationEl = document.getElementById('ordersPagination');
            if (paginationEl) {
                paginationEl.style.display = total > ordersRowsPerPage ? 'flex' : 'none';
            }
        }

        function renderOrdersPage() {
            const ordersBody = document.getElementById('ordersBody');
            const totalRows = allOrders.length;
            const totalPages = Math.ceil(totalRows / ordersRowsPerPage);

            const startIndex = (currentOrdersPage - 1) * ordersRowsPerPage;
            const endIndex = Math.min(startIndex + ordersRowsPerPage, totalRows);

            const pageData = allOrders.slice(startIndex, endIndex);

            ordersBody.innerHTML = pageData.map(order => order.html).join('');

            updateOrdersPagination(startIndex + 1, endIndex, totalRows, currentOrdersPage, totalPages);
        }

        function changeOrdersPage(direction) {
            const totalPages = Math.ceil(allOrders.length / ordersRowsPerPage);
            const newPage = currentOrdersPage + direction;

            if (newPage < 1 || newPage > totalPages) return;

            currentOrdersPage = newPage;
            renderOrdersPage();
        }

        function changeOrdersRowsPerPage() {
            ordersRowsPerPage = parseInt(document.getElementById('ordersRowsPerPage').value);
            currentOrdersPage = 1;
            renderOrdersPage();
        }

        // Cancelled orders pagination
        function updateCancelledPagination(start, end, total, current, totalPages) {
            document.getElementById('cancelledPageStart').textContent = start;
            document.getElementById('cancelledPageEnd').textContent = end;
            document.getElementById('cancelledTotalRows').textContent = total;
            document.getElementById('cancelledCurrentPage').textContent = current;
            document.getElementById('cancelledTotalPages').textContent = totalPages;

            document.getElementById('cancelledPrevBtn').disabled = current <= 1;
            document.getElementById('cancelledNextBtn').disabled = current >= totalPages;

            const paginationEl = document.getElementById('cancelledPagination');
            if (paginationEl) {
                paginationEl.style.display = total > cancelledRowsPerPage ? 'flex' : 'none';
            }
        }

        function renderCancelledPage() {
            const cancelledBody = document.getElementById('cancelledBody');
            const totalRows = allCancelledOrders.length;
            const totalPages = Math.ceil(totalRows / cancelledRowsPerPage);

            const startIndex = (currentCancelledPage - 1) * cancelledRowsPerPage;
            const endIndex = Math.min(startIndex + cancelledRowsPerPage, totalRows);

            const pageData = allCancelledOrders.slice(startIndex, endIndex);

            cancelledBody.innerHTML = pageData.map(order => order.html).join('');

            updateCancelledPagination(startIndex + 1, endIndex, totalRows, currentCancelledPage, totalPages);
        }

        function changeCancelledPage(direction) {
            const totalPages = Math.ceil(allCancelledOrders.length / cancelledRowsPerPage);
            const newPage = currentCancelledPage + direction;

            if (newPage < 1 || newPage > totalPages) return;

            currentCancelledPage = newPage;
            renderCancelledPage();
        }

        function changeCancelledRowsPerPage() {
            cancelledRowsPerPage = parseInt(document.getElementById('cancelledRowsPerPage').value);
            currentCancelledPage = 1;
            renderCancelledPage();
        }

        // ========== End Pagination Functions ==========

        // åŠ è½½æŒä»“
        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE}/positions?account_id=2&status=open`);
                const data = await response.json();

                const positionsBody = document.getElementById('positionsBody');
                const positionsTable = document.getElementById('positionsTable');
                const positionsEmpty = document.getElementById('positionsEmpty');
                const positionCount = document.getElementById('positionCount');
                const positionsLoading = document.getElementById('positionsLoading');
                const positionsTitle = document.getElementById('positions-title');

                positionsLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    // ä¸ºæ¯ä¸ªæŒä»“å®æ—¶è·å–å½“å‰ä»·æ ¼
                    const positionsWithPrices = await Promise.all(data.data.map(async (pos) => {
                        let currentPrice = pos.current_price || 0;
                        try {
                            // å®æ—¶è·å–å½“å‰ä»·æ ¼
                            const priceResponse = await fetch(`/api/futures/price/${encodeURIComponent(pos.symbol)}`);
                            if (priceResponse.ok) {
                                const priceData = await priceResponse.json();
                                if (priceData.success && priceData.price) {
                                    currentPrice = parseFloat(priceData.price);
                                }
                            }
                        } catch (e) {
                            // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨åç«¯è¿”å›çš„ä»·æ ¼
                            // é™é»˜å¤„ç†ä»·æ ¼è·å–å¤±è´¥
                        }
                        
                        // è®¡ç®—å®æ—¶ç›ˆäºï¼ˆåŸºäºåä¹‰ä»·å€¼ï¼Œä¸ä¹˜ä»¥æ æ†ï¼‰
                        // æ æ†åªå½±å“ä¿è¯é‡‘ï¼Œä¸å½±å“ç›ˆäºæœ¬èº«
                        const quantity = parseFloat(pos.quantity) || 0;
                        const entryPrice = parseFloat(pos.entry_price) || 0;
                        const margin = parseFloat(pos.margin) || 0;
                        
                        let unrealizedPnl = 0;
                        let unrealizedPnlPct = 0;
                        
                        if (currentPrice > 0 && entryPrice > 0 && quantity > 0) {
                            if (pos.position_side === 'LONG') {
                                unrealizedPnl = (currentPrice - entryPrice) * quantity;
                            } else {
                                unrealizedPnl = (entryPrice - currentPrice) * quantity;
                            }
                            // ç›ˆäºç™¾åˆ†æ¯”åŸºäºä¿è¯é‡‘è®¡ç®—ï¼ˆæ æ†æ”¶ç›Šç‡ï¼‰
                            if (margin > 0) {
                                unrealizedPnlPct = (unrealizedPnl / margin) * 100;
                            }
                        } else {
                            // ä½¿ç”¨åç«¯è®¡ç®—çš„ç›ˆäº
                            unrealizedPnl = parseFloat(pos.unrealized_pnl) || 0;
                            unrealizedPnlPct = parseFloat(pos.unrealized_pnl_pct) || 0;
                        }
                        
                        // å¤„ç†æ­¢ç›ˆæ­¢æŸä»·æ ¼ï¼šç›´æ¥ä½¿ç”¨æ•°æ®åº“è¿”å›çš„å€¼ï¼ˆæ ¹æ®è®¢å•å·åŠ è½½ï¼‰
                        let stopLossPrice = null;
                        let takeProfitPrice = null;
                        
                        if (pos.stop_loss_price !== null && pos.stop_loss_price !== undefined && pos.stop_loss_price !== '') {
                            const parsed = parseFloat(pos.stop_loss_price);
                            if (!isNaN(parsed) && parsed > 0) {
                                stopLossPrice = parsed;
                            }
                        }
                        
                        if (pos.take_profit_price !== null && pos.take_profit_price !== undefined && pos.take_profit_price !== '') {
                            const parsed = parseFloat(pos.take_profit_price);
                            if (!isNaN(parsed) && parsed > 0) {
                                takeProfitPrice = parsed;
                            }
                        }
                        
                        const positionData = {
                            ...pos,
                            current_price: currentPrice,
                            unrealized_pnl: unrealizedPnl,
                            unrealized_pnl_pct: unrealizedPnlPct,
                            stop_loss_price: stopLossPrice,
                            take_profit_price: takeProfitPrice
                        };
                        
                        // ä¿å­˜åˆ°æ˜ å°„è¡¨ï¼Œç”¨äºåç»­å¿«é€Ÿæ›´æ–°ï¼ˆä½¿ç”¨position_idä½œä¸ºé”®ï¼Œè€Œä¸æ˜¯symbolï¼‰
                        const dbId = pos.position_id || pos.id;
                        if (dbId) {
                            positionsDataMap[dbId] = {
                            entry_price: parseFloat(pos.entry_price) || 0,
                            quantity: parseFloat(pos.quantity) || 0,
                            margin: parseFloat(pos.margin) || 0,
                            position_side: pos.position_side,
                            current_price: currentPrice,
                            unrealized_pnl: unrealizedPnl,
                            unrealized_pnl_pct: unrealizedPnlPct
                        };
                        }
                        
                        return positionData;
                    }));
                    
                    // è®¡ç®—æ‰€æœ‰æŒä»“çš„æœªå®ç°ç›ˆäºæ€»å’Œ
                    const totalUnrealizedPnl = positionsWithPrices.reduce((sum, pos) => {
                        return sum + (parseFloat(pos.unrealized_pnl) || 0);
                    }, 0);
                    
                    // æ›´æ–°è´¦æˆ·ä¿¡æ¯ä¸­çš„æœªå®ç°ç›ˆäºæ˜¾ç¤º
                    const unrealizedPnlCard = document.querySelector('.stat-card:nth-child(3) .stat-value');
                    if (unrealizedPnlCard) {
                        const pnlClass = totalUnrealizedPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        unrealizedPnlCard.className = `stat-value ${pnlClass}`;
                        unrealizedPnlCard.textContent = (totalUnrealizedPnl >= 0 ? '+' : '') + formatLargeNumber(totalUnrealizedPnl);
                    }
                    
                    // ä½¿ç”¨å¡ç‰‡æ ·å¼æ¸²æŸ“æŒä»“
                    positionsBody.innerHTML = positionsWithPrices.map(pos => {
                        const priceColor = pos.current_price > 0 && pos.entry_price > 0 
                            ? (pos.current_price > pos.entry_price ? 'var(--success-green)' : 
                               pos.current_price < pos.entry_price ? 'var(--danger-red)' : 'var(--text-secondary)')
                            : 'var(--text-secondary)';
                        const pnlClass = pos.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        const cardClass = pos.position_side === 'LONG' ? 'long' : 'short';
                        
                        // ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ•°æ®åº“ID
                        const dbId = pos.position_id || pos.id;
                        
                        return `
                            <div class="position-card ${cardClass}" 
                                 data-position-id="${dbId}" 
                                 data-symbol="${pos.symbol}"
                                 style="margin-bottom: 12px;">
                                <div style="display: grid; grid-template-columns: 1fr 280px; gap: 16px;">
                                    <!-- å·¦ä¾§ï¼šæŒä»“ä¿¡æ¯ -->
                                    <div>
                                        <div class="d-flex justify-between align-center" style="margin-bottom: 8px;">
                                            <div>
                                                <strong class="text-lg">${pos.symbol}</strong>
                                                <span class="badge ${pos.position_side === 'LONG' ? 'badge-success' : 'badge-danger'}" style="margin-left: 8px;">
                                                    ${pos.position_side === 'LONG' ? 'åšå¤š' : 'åšç©º'}
                                                </span>
                                                <span class="badge badge-info" style="margin-left: 8px;">${pos.leverage || 1}x</span>
                                            </div>
                                            <span class="${pnlClass} font-mono" style="font-size: 16px; font-weight: 600;" data-pnl="${dbId}">
                                ${pos.unrealized_pnl >= 0 ? '+' : ''}${formatLargeNumber(pos.unrealized_pnl || 0)}
                                            </span>
                                        </div>
                                        <div class="text-sm text-secondary" style="margin-bottom: 6px;">
                                            æ•°é‡: ${pos.quantity || '--'} å¼  | å¼€ä»“ä»·: $${formatPrice(pos.entry_price)} | ç°ä»·: <span class="font-mono current-price-cell" data-symbol="${pos.symbol}" style="color: ${priceColor}; font-weight: 600;">$${pos.current_price ? formatPrice(pos.current_price) : '--'}</span>
                                        </div>
                                        <div class="text-sm text-secondary" style="margin-bottom: 6px;">
                                            ä¿è¯é‡‘: ${formatLargeNumber(pos.margin || 0)} | æ”¶ç›Šç‡: <span class="${pnlClass}" data-pnl-pct="${dbId}">${pos.unrealized_pnl_pct >= 0 ? '+' : ''}${(pos.unrealized_pnl_pct || 0).toFixed(2)}%</span>
                                        </div>
                                        <div class="text-sm text-secondary" style="margin-bottom: 6px;">
                                            å¼€ä»“æ—¶é—´: ${pos.open_time ? new Date(pos.open_time).toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '--'}
                                        </div>
                                        ${(pos.stop_loss_price !== null && pos.stop_loss_price !== undefined && pos.stop_loss_price > 0) || (pos.take_profit_price !== null && pos.take_profit_price !== undefined && pos.take_profit_price > 0) ? `
                                        <div class="stop-loss-take-profit-display text-xs text-secondary" style="display: flex; gap: 12px; align-items: center; margin-top: 6px;">
                                            ${(pos.stop_loss_price !== null && pos.stop_loss_price !== undefined && pos.stop_loss_price > 0) ? `<span style="color: var(--danger-red);"><i class="bi bi-shield-exclamation"></i> æ­¢æŸ: $${formatPrice(pos.stop_loss_price)}</span>` : ''}
                                            ${(pos.take_profit_price !== null && pos.take_profit_price !== undefined && pos.take_profit_price > 0) ? `<span style="color: var(--success-green);"><i class="bi bi-bullseye"></i> æ­¢ç›ˆ: $${formatPrice(pos.take_profit_price)}</span>` : ''}
                                        </div>
                                        ` : ''}
                                    </div>
                                    <!-- å³ä¾§ï¼šæ­¢ç›ˆæ­¢æŸè®¾ç½®å’Œå¹³ä»“æŒ‰é’® -->
                                    <div style="border-left: 1px solid var(--border-default); padding-left: 16px; display: flex; flex-direction: column; gap: 8px; justify-content: space-between;">
                                        <!-- æ­¢ç›ˆæ­¢æŸè¾“å…¥ -->
                                        <div style="display: flex; flex-direction: column; gap: 6px;">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 11px; color: var(--text-tertiary); min-width: 50px;">æ­¢æŸ:</label>
                                                <input type="number" 
                                                       id="stopLoss_${dbId}" 
                                                       data-position-id="${dbId}"
                                                       value="${(pos.stop_loss_price !== null && pos.stop_loss_price !== undefined && pos.stop_loss_price > 0) ? pos.stop_loss_price : ''}" 
                                                       placeholder="æ­¢æŸä»·"
                                                       step="0.00000001"
                                                       style="flex: 1; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 12px; font-family: var(--font-mono);"
                                                       onblur="saveStopLossTakeProfitInline(${dbId}, '${pos.symbol}')"
                                                       onkeypress="if(event.key === 'Enter') { this.blur(); }">
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <label style="font-size: 11px; color: var(--text-tertiary); min-width: 50px;">æ­¢ç›ˆ:</label>
                                                <input type="number" 
                                                       id="takeProfit_${dbId}" 
                                                       data-position-id="${dbId}"
                                                       value="${(pos.take_profit_price !== null && pos.take_profit_price !== undefined && pos.take_profit_price > 0) ? pos.take_profit_price : ''}" 
                                                       placeholder="æ­¢ç›ˆä»·"
                                                       step="0.00000001"
                                                       style="flex: 1; padding: 4px 8px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 12px; font-family: var(--font-mono);"
                                                       onblur="saveStopLossTakeProfitInline(${dbId}, '${pos.symbol}')"
                                                       onkeypress="if(event.key === 'Enter') { this.blur(); }">
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-danger" style="padding: 6px 12px; font-size: 12px; min-width: auto;" onclick="event.stopPropagation(); closePosition(${dbId})" title="å¹³ä»“">
                                    <i class="bi bi-x-circle"></i> å¹³ä»“
                                </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    const count = data.data.length;
                    positionCount.textContent = `${count} ä¸ªæŒä»“`;
                    positionsTitle.textContent = `æŒä»“ä¸­ [${count}]`;
                    positionsTable.style.display = 'block';
                    positionsEmpty.style.display = 'none';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    positionCount.textContent = '0 ä¸ªæŒä»“';
                    positionsTitle.textContent = 'æŒä»“ä¸­ [0]';
                    positionsTable.style.display = 'none';
                    positionsEmpty.style.display = 'block';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                // é™é»˜å¤„ç†æŒä»“åŠ è½½å¤±è´¥
                document.getElementById('positionsLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½æŒä»“å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æœªæˆäº¤è®¢å•
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders?account_id=2&status=PENDING`);
                const data = await response.json();

                const ordersBody = document.getElementById('ordersBody');
                const ordersTable = document.getElementById('ordersTable');
                const ordersEmpty = document.getElementById('ordersEmpty');
                const ordersLoading = document.getElementById('ordersLoading');
                const orderCount = document.getElementById('orderCount');
                const ordersTitle = document.getElementById('orders-title');

                ordersLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    // åŒæ—¶è·å–éƒ¨åˆ†æˆäº¤çš„è®¢å•
                    try {
                        const partialResponse = await fetch(`${API_BASE}/orders?account_id=2&status=PARTIALLY_FILLED`);
                        const partialData = await partialResponse.json();
                        const allOrders = [...data.data, ...(partialData.success && partialData.data ? partialData.data : [])];

                        ordersBody.innerHTML = allOrders.map(order => {
                            // åªæ˜¾ç¤º"å¤š"æˆ–"ç©º"
                            const sideText = order.side.includes('LONG') ? 'å¤š' : 
                                            order.side.includes('SHORT') ? 'ç©º' : 
                                            order.side === 'BUY' ? 'å¤š' : 'ç©º';
                            const sideClass = order.side.includes('LONG') || order.side === 'BUY' ? 'badge-success' : 'badge-danger';
                            const orderTypeText = order.order_type === 'MARKET' ? 'å¸‚ä»·' : 
                                                order.order_type === 'LIMIT' ? 'é™ä»·' :
                                                order.order_type === 'STOP_MARKET' ? 'æ­¢æŸå¸‚ä»·' :
                                                order.order_type === 'TAKE_PROFIT_MARKET' ? 'æ­¢ç›ˆå¸‚ä»·' : order.order_type;
                            const statusText = order.status === 'PENDING' ? 'å¾…æˆäº¤' :
                                             order.status === 'PARTIALLY_FILLED' ? 'éƒ¨åˆ†æˆäº¤' : order.status;
                            const statusClass = order.status === 'PENDING' ? 'badge-warning' :
                                              order.status === 'PARTIALLY_FILLED' ? 'badge-info' : 'badge-neutral';
                            const fillProgress = order.quantity > 0 ? ((order.executed_quantity || 0) / order.quantity * 100).toFixed(1) : 0;

                            // æ ¼å¼åŒ–è®¢å•æ¥æº
                            const orderSource = order.order_source || 'manual';
                            const sourceText = orderSource === 'strategy' ? 'ç­–ç•¥' : 
                                             orderSource === 'limit_order' ? 'é™ä»·å•' : 
                                             orderSource === 'manual' ? 'æ‰‹åŠ¨' : orderSource;
                            const sourceClass = orderSource === 'strategy' ? 'badge-info' : 
                                              orderSource === 'limit_order' ? 'badge-warning' : 
                                              'badge-neutral';
                            
                            return `
                                <tr>
                                    <td><strong>${order.symbol}</strong></td>
                                    <td><span class="badge ${sideClass}">${sideText}</span></td>
                                    <td><span class="badge badge-neutral">${orderTypeText}</span></td>
                                    <td><span class="badge badge-info">${order.leverage || 1}x</span></td>
                                    <td class="font-mono">${order.price ? '$' + formatPrice(order.price) : 'å¸‚ä»·'}</td>
                                    <td>${order.quantity || '--'}</td>
                                    <td class="text-sm">
                                        ${order.executed_quantity || 0} / ${order.quantity || 0}
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            ${fillProgress}%
                                        </div>
                                    </td>
                                    <td>${formatLargeNumber(order.margin || 0)}</td>
                                    <td class="font-mono text-sm">
                                        ${order.status === 'PENDING' || order.status === 'PARTIALLY_FILLED' ? `
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="number" 
                                                       id="order_stop_loss_${order.order_id}" 
                                                       value="${order.stop_loss_price || ''}" 
                                                       placeholder="æœªè®¾ç½®"
                                                       step="0.00000001"
                                                       style="width: 100px; padding: 4px 6px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 11px;"
                                                       onchange="updateOrderStopLossTakeProfit('${order.order_id}', 'stop_loss', this.value)">
                                                <button class="btn btn-xs btn-ghost" onclick="clearOrderStopLoss('${order.order_id}')" title="æ¸…é™¤æ­¢æŸ" style="padding: 2px 6px; font-size: 10px;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        ` : (order.stop_loss_price ? '<span style="color: var(--danger-red);">$' + formatPrice(order.stop_loss_price) + '</span>' : '--')}
                                    </td>
                                    <td class="font-mono text-sm">
                                        ${order.status === 'PENDING' || order.status === 'PARTIALLY_FILLED' ? `
                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                <input type="number" 
                                                       id="order_take_profit_${order.order_id}" 
                                                       value="${order.take_profit_price || ''}" 
                                                       placeholder="æœªè®¾ç½®"
                                                       step="0.00000001"
                                                       style="width: 100px; padding: 4px 6px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 11px;"
                                                       onchange="updateOrderStopLossTakeProfit('${order.order_id}', 'take_profit', this.value)">
                                                <button class="btn btn-xs btn-ghost" onclick="clearOrderTakeProfit('${order.order_id}')" title="æ¸…é™¤æ­¢ç›ˆ" style="padding: 2px 6px; font-size: 10px;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        ` : (order.take_profit_price ? '<span style="color: var(--success-green);">$' + formatPrice(order.take_profit_price) + '</span>' : '--')}
                                    </td>
                                    <td><span class="badge ${sourceClass}" title="${order.signal_id ? 'ç­–ç•¥ID: ' + order.signal_id : ''}">${sourceText}</span></td>
                                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                                    <td class="text-sm text-secondary">${order.created_at ? new Date(order.created_at).toLocaleString('zh-CN') : '--'}</td>
                                    <td>
                                        ${order.status === 'PENDING' || order.status === 'PARTIALLY_FILLED' ? `
                                            <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.order_id}')">
                                                <i class="bi bi-x-circle"></i> æ’¤å•
                                            </button>
                                        ` : '--'}
                                    </td>
                                </tr>
                            `;
                        }).join('');

                        const count = allOrders.length;
                        orderCount.textContent = `${count} ä¸ªè®¢å•`;
                        ordersTitle.textContent = `æœªæˆäº¤è®¢å• [${count}]`;
                        orderCount.style.display = 'inline-flex';
                        ordersTable.style.display = 'block';
                        ordersEmpty.style.display = 'none';
                    } catch (e) {
                        // å¦‚æœè·å–éƒ¨åˆ†æˆäº¤è®¢å•å¤±è´¥ï¼Œåªæ˜¾ç¤ºå¾…æˆäº¤è®¢å•
                        const count = data.data.length;
                        orderCount.textContent = `${count} ä¸ªè®¢å•`;
                        ordersTitle.textContent = `æœªæˆäº¤è®¢å• [${count}]`;
                        orderCount.style.display = 'inline-flex';
                        ordersTable.style.display = 'block';
                        ordersEmpty.style.display = 'none';
                    }
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    orderCount.textContent = '0 ä¸ªè®¢å•';
                    ordersTitle.textContent = 'æœªæˆäº¤è®¢å• [0]';
                    orderCount.style.display = 'inline-flex';
                    ordersTable.style.display = 'none';
                    ordersEmpty.style.display = 'block';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                // é™é»˜å¤„ç†è®¢å•åŠ è½½å¤±è´¥
                document.getElementById('ordersLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½æœªæˆäº¤è®¢å•å¤±è´¥', 'error');
            }
        }

        // åŠ è½½å·²å–æ¶ˆè®¢å•
        async function loadCancelledOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders?account_id=2&status=CANCELLED`);
                const data = await response.json();

                const cancelledBody = document.getElementById('cancelledBody');
                const cancelledTable = document.getElementById('cancelledTable');
                const cancelledEmpty = document.getElementById('cancelledEmpty');
                const cancelledLoading = document.getElementById('cancelledLoading');
                const cancelledCount = document.getElementById('cancelledCount');
                const cancelledTitle = document.getElementById('cancelled-title');

                cancelledLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    cancelledBody.innerHTML = data.data.map(order => {
                        // åªæ˜¾ç¤º"å¤š"æˆ–"ç©º"
                        const sideText = order.side.includes('LONG') ? 'å¤š' :
                                        order.side.includes('SHORT') ? 'ç©º' :
                                        order.side === 'BUY' ? 'å¤š' : 'ç©º';
                        const sideClass = order.side.includes('LONG') || order.side === 'BUY' ? 'badge-success' : 'badge-danger';
                        const orderTypeText = order.order_type === 'MARKET' ? 'å¸‚ä»·' :
                                            order.order_type === 'LIMIT' ? 'é™ä»·' :
                                            order.order_type === 'STOP_MARKET' ? 'æ­¢æŸå¸‚ä»·' :
                                            order.order_type === 'TAKE_PROFIT_MARKET' ? 'æ­¢ç›ˆå¸‚ä»·' : order.order_type;

                        // æ ¼å¼åŒ–å–æ¶ˆåŸå› 
                        const reasonMap = {
                            'manual': 'æ‰‹åŠ¨å–æ¶ˆ',
                            'strategy_signal': 'ç­–ç•¥ä¿¡å·',
                            'risk_control': 'é£é™©æ§åˆ¶',
                            'system': 'ç³»ç»Ÿå–æ¶ˆ',
                            'expired': 'è®¢å•è¿‡æœŸ'
                        };
                        const reasonText = order.cancellation_reason ? reasonMap[order.cancellation_reason] || order.cancellation_reason : 'æœªçŸ¥';
                        const reasonClass = order.cancellation_reason === 'manual' ? 'badge-neutral' :
                                          order.cancellation_reason === 'strategy_signal' ? 'badge-info' :
                                          order.cancellation_reason === 'risk_control' ? 'badge-warning' : 'badge-secondary';

                        // æ ¼å¼åŒ–è®¢å•æ¥æº
                        const orderSource = order.order_source || 'manual';
                        const sourceText = orderSource === 'strategy' ? 'ç­–ç•¥' :
                                         orderSource === 'limit_order' ? 'é™ä»·å•' :
                                         orderSource === 'manual' ? 'æ‰‹åŠ¨' : orderSource;
                        const sourceClass = orderSource === 'strategy' ? 'badge-info' :
                                          orderSource === 'limit_order' ? 'badge-warning' :
                                          'badge-neutral';

                        return `
                            <tr>
                                <td><strong>${order.symbol}</strong></td>
                                <td><span class="badge ${sideClass}">${sideText}</span></td>
                                <td><span class="badge badge-neutral">${orderTypeText}</span></td>
                                <td><span class="badge badge-info">${order.leverage || 1}x</span></td>
                                <td class="font-mono">${order.price ? '$' + formatPrice(order.price) : 'å¸‚ä»·'}</td>
                                <td>${order.quantity || '--'}</td>
                                <td>${formatLargeNumber(order.margin || 0)}</td>
                                <td class="font-mono text-sm">${order.stop_loss_price ? '<span style="color: var(--danger-red);">$' + formatPrice(order.stop_loss_price) + '</span>' : '--'}</td>
                                <td class="font-mono text-sm">${order.take_profit_price ? '<span style="color: var(--success-green);">$' + formatPrice(order.take_profit_price) + '</span>' : '--'}</td>
                                <td><span class="badge ${reasonClass}">${reasonText}</span></td>
                                <td><span class="badge ${sourceClass}" title="${order.signal_id ? 'ç­–ç•¥ID: ' + order.signal_id : ''}">${sourceText}</span></td>
                                <td class="text-sm text-secondary">${order.created_at ? new Date(order.created_at).toLocaleString('zh-CN') : '--'}</td>
                                <td class="text-sm text-secondary">${order.updated_at ? new Date(order.updated_at).toLocaleString('zh-CN') : '--'}</td>
                            </tr>
                        `;
                    }).join('');

                    const count = data.data.length;
                    cancelledCount.textContent = `${count} ä¸ªå·²å–æ¶ˆ`;
                    cancelledTitle.textContent = `å·²å–æ¶ˆè®¢å• [${count}]`;
                    cancelledTable.style.display = 'block';
                    cancelledEmpty.style.display = 'none';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    cancelledCount.textContent = '0 ä¸ªå·²å–æ¶ˆ';
                    cancelledTitle.textContent = 'å·²å–æ¶ˆè®¢å• [0]';
                    cancelledTable.style.display = 'none';
                    cancelledEmpty.style.display = 'block';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                // é™é»˜å¤„ç†å·²å–æ¶ˆè®¢å•åŠ è½½å¤±è´¥
                document.getElementById('cancelledLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½å·²å–æ¶ˆè®¢å•å¤±è´¥', 'error');
            }
        }

        // æ’¤é”€è®¢å•
        // æ›´æ–°è®¢å•æ­¢ç›ˆæ­¢æŸ
        async function updateOrderStopLossTakeProfit(orderId, type, price) {
            const priceValue = price && price.trim() !== '' ? parseFloat(price) : null;
            
            const requestData = {
                order_id: orderId
            };
            
            // è·å–å½“å‰è®¢å•çš„æ­¢ç›ˆæ­¢æŸå€¼
            const stopLossInput = document.getElementById(`order_stop_loss_${orderId}`);
            const takeProfitInput = document.getElementById(`order_take_profit_${orderId}`);
            
            if (type === 'stop_loss') {
                requestData.stop_loss_price = priceValue;
                // ä¿ç•™åŸæœ‰çš„æ­¢ç›ˆ
                if (takeProfitInput && takeProfitInput.value) {
                    requestData.take_profit_price = parseFloat(takeProfitInput.value);
                }
            } else if (type === 'take_profit') {
                requestData.take_profit_price = priceValue;
                // ä¿ç•™åŸæœ‰çš„æ­¢æŸ
                if (stopLossInput && stopLossInput.value) {
                    requestData.stop_loss_price = parseFloat(stopLossInput.value);
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/orders/stop-loss-take-profit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast(`${type === 'stop_loss' ? 'æ­¢æŸ' : 'æ­¢ç›ˆ'}å·²æ›´æ–°`, 'success');
                    // åˆ·æ–°è®¢å•åˆ—è¡¨
                    setTimeout(() => {
                        loadOrders();
                    }, 300);
                } else {
                    showToast('æ›´æ–°å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                    // æ¢å¤åŸå€¼
                    if (type === 'stop_loss' && stopLossInput) {
                        stopLossInput.value = stopLossInput.defaultValue || '';
                    } else if (type === 'take_profit' && takeProfitInput) {
                        takeProfitInput.value = takeProfitInput.defaultValue || '';
                    }
                }
            } catch (error) {
                showToast('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
                // æ¢å¤åŸå€¼
                if (type === 'stop_loss' && stopLossInput) {
                    stopLossInput.value = stopLossInput.defaultValue || '';
                } else if (type === 'take_profit' && takeProfitInput) {
                    takeProfitInput.value = takeProfitInput.defaultValue || '';
                }
            }
        }
        
        // æ¸…é™¤è®¢å•æ­¢æŸ
        async function clearOrderStopLoss(orderId) {
            const takeProfitInput = document.getElementById(`order_take_profit_${orderId}`);
            const requestData = {
                order_id: orderId,
                stop_loss_price: null
            };
            
            // ä¿ç•™åŸæœ‰çš„æ­¢ç›ˆ
            if (takeProfitInput && takeProfitInput.value) {
                requestData.take_profit_price = parseFloat(takeProfitInput.value);
            }
            
            try {
                const response = await fetch(`${API_BASE}/orders/stop-loss-take-profit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('æ­¢æŸå·²æ¸…é™¤', 'success');
                    setTimeout(() => {
                        loadOrders();
                    }, 300);
                } else {
                    showToast('æ¸…é™¤å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ¸…é™¤è®¢å•æ­¢ç›ˆ
        async function clearOrderTakeProfit(orderId) {
            const stopLossInput = document.getElementById(`order_stop_loss_${orderId}`);
            const requestData = {
                order_id: orderId,
                take_profit_price: null
            };
            
            // ä¿ç•™åŸæœ‰çš„æ­¢æŸ
            if (stopLossInput && stopLossInput.value) {
                requestData.stop_loss_price = parseFloat(stopLossInput.value);
            }
            
            try {
                const response = await fetch(`${API_BASE}/orders/stop-loss-take-profit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('æ­¢ç›ˆå·²æ¸…é™¤', 'success');
                    setTimeout(() => {
                        loadOrders();
                    }, 300);
                } else {
                    showToast('æ¸…é™¤å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                showToast('æ¸…é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function cancelOrder(orderId) {
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = await showConfirmDialog(
                'ç¡®å®šè¦æ’¤é”€è¿™ä¸ªè®¢å•å—ï¼Ÿ',
                'æ’¤é”€åï¼Œå†»ç»“çš„ä¿è¯é‡‘å°†è¢«é‡Šæ”¾å›å¯ç”¨ä½™é¢ã€‚',
                'warning'
            );
            if (!confirmed) return;

            try {
                // æ‰‹åŠ¨æ’¤å•ï¼Œä¼ é€’ reason=manual
                const response = await fetch(`${API_BASE}/orders/${encodeURIComponent(orderId)}?account_id=2&reason=manual`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('è®¢å•å·²æ’¤é”€', 'success');
                    // åˆ·æ–°è´¦æˆ·ä½™é¢ï¼ˆé‡Šæ”¾å†»ç»“èµ„é‡‘ï¼‰ã€å¾…æˆäº¤è®¢å•åˆ—è¡¨å’Œæˆäº¤å†å²
                    setTimeout(() => {
                        loadAccount();  // åˆ·æ–°è´¦æˆ·ä½™é¢å’Œå†»ç»“èµ„é‡‘
                        loadOrders();
                        loadTrades();
                        updatePositionsPrices();
                    }, 500);
                } else {
                    showToast('æ’¤é”€è®¢å•å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                // æ’¤é”€å¤±è´¥å·²åœ¨UIä¸­æ˜¾ç¤º
                showToast('æ’¤é”€è®¢å•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ†é¡µç›¸å…³å˜é‡
        let currentTradesPage = 1;
        const tradesPageSize = 10;
        let totalTradesPages = 1;
        let totalTradesCount = 0;

        // åŠ è½½äº¤æ˜“è®°å½•ï¼ˆä»futures_tradesè¡¨è·å–ï¼Œæ”¯æŒåˆ†é¡µï¼‰
        async function loadTradesPage(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/trades?account_id=2&page=${page}&page_size=${tradesPageSize}`);
                const data = await response.json();

                const tradesBody = document.getElementById('tradesBody');
                const tradesTable = document.getElementById('tradesTable');
                const tradesEmpty = document.getElementById('tradesEmpty');
                const tradesLoading = document.getElementById('tradesLoading');
                const tradesTitle = document.getElementById('trades-title');
                const tradesPagination = document.getElementById('tradesPagination');

                tradesLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    currentTradesPage = data.page || page;
                    totalTradesPages = data.total_pages || 1;
                    totalTradesCount = data.total_count || 0;
                    
                    const recentTrades = data.data;

                    // æ ¼å¼åŒ–å¹³ä»“åŸå› 
                    function formatCloseReason(orderSource) {
                        // å¦‚æœ order_source ä¸ºç©ºæˆ–æœªå®šä¹‰ï¼Œé»˜è®¤ä¸ºæ‰‹åŠ¨
                        if (!orderSource || orderSource === null || orderSource === undefined || orderSource === '') {
                            return '<span class="badge badge-info">æ‰‹åŠ¨</span>';
                        }
                        const reasonMap = {
                            'manual': '<span class="badge badge-info">æ‰‹åŠ¨</span>',
                            'strategy': '<span class="badge badge-primary">ç­–ç•¥</span>',
                            'limit_order': '<span class="badge badge-warning">é™ä»·å•</span>',
                            'stop_loss': '<span class="badge badge-danger">æ­¢æŸ</span>',
                            'take_profit': '<span class="badge badge-success">æ­¢ç›ˆ</span>',
                            'liquidation': '<span class="badge badge-warning">å¼ºå¹³</span>',
                            'signal': '<span class="badge badge-secondary">ä¿¡å·</span>',
                            'auto': '<span class="badge badge-secondary">è‡ªåŠ¨</span>',
                            'strategy_signal': '<span class="badge badge-primary">ç­–ç•¥ä¿¡å·</span>'
                        };
                        // è½¬æ¢ä¸ºå°å†™è¿›è¡Œæ¯”è¾ƒï¼Œç¡®ä¿åŒ¹é…
                        const sourceLower = String(orderSource).toLowerCase().trim();
                        return reasonMap[sourceLower] || `<span class="badge badge-info">${orderSource}</span>`;
                    }
                    
                    // æ ¼å¼åŒ–æ­¢ç›ˆæ­¢æŸä¿¡æ¯
                    function formatStopLossTakeProfit(stopLossPrice, takeProfitPrice) {
                        const parts = [];
                        if (stopLossPrice && stopLossPrice > 0) {
                            parts.push(`<span class="text-danger" title="æ­¢æŸä»·">æ­¢æŸ: $${formatPrice(stopLossPrice)}</span>`);
                        }
                        if (takeProfitPrice && takeProfitPrice > 0) {
                            parts.push(`<span class="text-success" title="æ­¢ç›ˆä»·">æ­¢ç›ˆ: $${formatPrice(takeProfitPrice)}</span>`);
                        }
                        if (parts.length === 0) {
                            return '<span class="text-secondary">-</span>';
                        }
                        return parts.join('<br>');
                    }

                    tradesBody.innerHTML = recentTrades.map(trade => {
                        const isLong = trade.side === 'CLOSE_LONG';
                        const sideText = isLong ? 'å¤š' : 'ç©º';
                        const sideBadge = isLong ? 'badge-success' : 'badge-danger';

                        // æ ¼å¼åŒ–æ—¶é—´å‡½æ•°
                        function formatTradeTime(timeStr) {
                            if (!timeStr) return '--';
                            const date = new Date(timeStr);
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const hours = String(date.getHours()).padStart(2, '0');
                            const minutes = String(date.getMinutes()).padStart(2, '0');
                            return `${month}-${day} ${hours}:${minutes}`;
                        }

                        return `
                        <tr>
                            <td><strong>${trade.symbol}</strong></td>
                            <td><span class="badge ${sideBadge}">${sideText}</span></td>
                            <td><span class="badge badge-info">${trade.leverage || 1}x</span></td>
                            <td class="text-sm">
                                <div>å¼€: <span class="font-mono">$${trade.entry_price ? formatPrice(trade.entry_price) : '--'}</span></div>
                                <div class="text-secondary">å¹³: <span class="font-mono">$${formatPrice(trade.price)}</span></div>
                            </td>
                            <td>${trade.quantity || '--'}</td>
                            <td class="pnl ${trade.realized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${trade.realized_pnl >= 0 ? '+' : ''}${formatLargeNumber(trade.realized_pnl || 0)}
                            </td>
                            <td class="pnl ${trade.pnl_pct >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${trade.pnl_pct >= 0 ? '+' : ''}${(trade.pnl_pct || 0).toFixed(2)}%
                            </td>
                            <td class="text-sm">${formatCloseReason(trade.order_source)}</td>
                            <td class="text-sm">${formatStopLossTakeProfit(trade.stop_loss_price, trade.take_profit_price)}</td>
                            <td class="text-sm">${formatLargeNumber(trade.fee || 0)}</td>
                            <td class="text-sm text-secondary">${formatTradeTime(trade.open_time)}</td>
                            <td class="text-sm text-secondary">${formatTradeTime(trade.close_time)}</td>
                        </tr>
                    `;
                    }).join('');

                    // æ›´æ–°åˆ†é¡µä¿¡æ¯
                    document.getElementById('tradesPageInfo').textContent = `ç¬¬ ${currentTradesPage} é¡µï¼Œå…± ${totalTradesPages} é¡µï¼ˆå…± ${totalTradesCount} æ¡ï¼‰`;
                    
                    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
                    const prevBtn = document.getElementById('tradesPrevBtn');
                    const nextBtn = document.getElementById('tradesNextBtn');
                    prevBtn.disabled = currentTradesPage <= 1;
                    nextBtn.disabled = currentTradesPage >= totalTradesPages;
                    
                    tradesTitle.textContent = `æœ€è¿‘äº¤æ˜“è®°å½• [${totalTradesCount}]`;
                    tradesTable.style.display = 'flex';
                    tradesPagination.style.display = 'flex';
                    tradesEmpty.style.display = 'none';
                    document.getElementById('trades-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    tradesTitle.textContent = 'æœ€è¿‘äº¤æ˜“è®°å½• [0]';
                    tradesTable.style.display = 'none';
                    tradesPagination.style.display = 'none';
                    tradesEmpty.style.display = 'flex';
                    document.getElementById('trades-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                // é™é»˜å¤„ç†äº¤æ˜“è®°å½•åŠ è½½å¤±è´¥
                document.getElementById('tradesLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥', 'error');
            }
        }

        // å…¼å®¹æ—§å‡½æ•°å
        function loadTrades() {
            loadTradesPage(1);
        }

        // å¹³ä»“
        async function closePosition(positionId) {
            // éªŒè¯positionId
            if (!positionId || positionId === 'undefined' || positionId === undefined) {
                // positionIdæ— æ•ˆ
                showToast('å¹³ä»“å¤±è´¥: æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            // ç¡®ä¿positionIdæ˜¯æ•°å­—
            positionId = parseInt(positionId);
            if (isNaN(positionId) || positionId <= 0) {
                // positionIdæ ¼å¼é”™è¯¯
                showToast('å¹³ä»“å¤±è´¥: æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = await showConfirmDialog(
                'ç¡®å®šè¦å¹³ä»“å—ï¼Ÿ',
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå¹³ä»“åå°†è®¡ç®—å·²å®ç°ç›ˆäºå¹¶é‡Šæ”¾ä¿è¯é‡‘ã€‚',
                'warning'
            );
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/close/${positionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        close_quantity: null,
                        reason: 'manual' 
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    // å¦‚æœå“åº”ä¸æ˜¯JSONï¼Œå°è¯•è·å–æ–‡æœ¬
                    const text = await response.text();
                    // å“åº”æ ¼å¼é”™è¯¯
                    showToast('å¹³ä»“å¤±è´¥: æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”', 'error');
                    return;
                }

                if (!response.ok) {
                    // HTTPé”™è¯¯çŠ¶æ€ç 
                    const errorMsg = data.detail || data.message || `HTTP ${response.status}: ${response.statusText}`;
                    // å¹³ä»“å¤±è´¥å·²åœ¨UIä¸­æ˜¾ç¤º
                    showToast('å¹³ä»“å¤±è´¥: ' + errorMsg, 'error');
                    return;
                }

                if (data.success) {
                    // ç¾åŒ–å¹³ä»“æˆåŠŸæç¤º
                    const closeData = data.data || {};
                    const realizedPnl = closeData.realized_pnl || 0;
                    const pnlPct = closeData.pnl_pct || 0;
                    const roi = closeData.roi || 0;
                    const symbol = closeData.symbol || '';
                    const closePrice = closeData.close_price || 0;
                    const entryPrice = closeData.entry_price || 0;
                    const positionSide = closeData.position_side || '';
                    const closeQuantity = closeData.close_quantity || 0;
                    
                    const pnlColor = realizedPnl >= 0 ? 'var(--success-green)' : 'var(--danger-red)';
                    const pnlSign = realizedPnl >= 0 ? '+' : '';
                    
                    // åˆ›å»ºè‡ªå®šä¹‰çš„ç¾åŒ–å¹³ä»“æˆåŠŸæç¤ºæ¡†
                    const toast = document.createElement('div');
                    toast.className = 'toast success';
                    const isProfit = realizedPnl >= 0;
                    const profitIcon = isProfit ? 'bi-trending-up' : 'bi-trending-down';
                    
                    toast.innerHTML = `
                        <div style="
                            position: relative;
                            overflow: hidden;
                        ">
                            <!-- èƒŒæ™¯è£…é¥° -->
                            <div style="
                                position: absolute;
                                top: -50px;
                                right: -50px;
                                width: 150px;
                                height: 150px;
                                background: ${isProfit ? 'radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%)' : 'radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%)'};
                                border-radius: 50%;
                                pointer-events: none;
                            "></div>
                            
                            <div style="display: flex; align-items: flex-start; gap: var(--spacing-lg); position: relative; z-index: 1;">
                                <!-- å›¾æ ‡åŒºåŸŸ -->
                                <div style="
                                    width: 56px; 
                                    height: 56px; 
                                    border-radius: 16px; 
                                    background: ${isProfit ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%)' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%)'}; 
                                    border: 2px solid ${isProfit ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    flex-shrink: 0;
                                    animation: pulse 0.6s ease-out;
                                    box-shadow: 0 4px 12px ${isProfit ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                ">
                                    <i class="bi ${profitIcon}" style="font-size: 28px; color: ${pnlColor};"></i>
                                </div>
                                
                                <!-- å†…å®¹åŒºåŸŸ -->
                                <div style="flex: 1; min-width: 0;">
                                    <!-- æ ‡é¢˜ -->
                                    <div style="
                                        font-weight: 700; 
                                        font-size: 18px; 
                                        color: var(--text-primary); 
                                        margin-bottom: 12px;
                                        line-height: 1.3;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <span>å¹³ä»“æˆåŠŸ</span>
                                        <span style="
                                            font-size: 12px;
                                            padding: 2px 8px;
                                            border-radius: 12px;
                                            background: ${isProfit ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                                            color: ${pnlColor};
                                            font-weight: 600;
                                        ">${isProfit ? 'ç›ˆåˆ©' : 'äºæŸ'}</span>
                                    </div>
                                    
                                    <!-- è¯¦ç»†ä¿¡æ¯ -->
                                    <div style="
                                        background: rgba(139, 148, 158, 0.05);
                                        border-radius: 12px;
                                        padding: 12px;
                                        margin-bottom: 12px;
                                    ">
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 8px;
                                            font-size: 13px;
                                            color: var(--text-secondary);
                                        ">
                                            <div><span style="color: var(--text-tertiary);">äº¤æ˜“å¯¹:</span> <strong style="color: var(--text-primary);">${symbol}</strong></div>
                                            <div><span style="color: var(--text-tertiary);">æ–¹å‘:</span> <strong style="color: var(--text-primary);">${positionSide === 'LONG' ? 'å¤š' : 'ç©º'}</strong></div>
                                            <div><span style="color: var(--text-tertiary);">æ•°é‡:</span> <strong style="color: var(--text-primary);">${closeQuantity}</strong></div>
                                            <div><span style="color: var(--text-tertiary);">æ æ†:</span> <strong style="color: var(--text-primary);">${closeData.leverage || '--'}x</strong></div>
                                        </div>
                                        
                                        <div style="
                                            margin-top: 10px;
                                            padding-top: 10px;
                                            border-top: 1px solid var(--border-default);
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 8px;
                                        ">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 2px;">å¼€ä»“ä»·</div>
                                                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); font-family: var(--font-mono);">${formatPrice(entryPrice)}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 2px;">å¹³ä»“ä»·</div>
                                                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); font-family: var(--font-mono);">${formatPrice(closePrice)}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç›ˆäºä¿¡æ¯å¡ç‰‡ -->
                                    <div style="
                                        background: ${isProfit ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%)' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%)'};
                                        border: 1px solid ${isProfit ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                        border-radius: 12px;
                                        padding: 14px;
                                        display: grid;
                                        grid-template-columns: repeat(3, 1fr);
                                        gap: 12px;
                                    ">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">å·²å®ç°ç›ˆäº</div>
                                            <div style="font-size: 18px; font-weight: 700; color: ${pnlColor}; font-family: var(--font-mono);">
                                                ${pnlSign}${formatLargeNumber(realizedPnl)}
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">USDT</div>
                                        </div>
                                        <div style="text-align: center; border-left: 1px solid var(--border-default); border-right: 1px solid var(--border-default); padding: 0 12px;">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">æ”¶ç›Šç‡</div>
                                            <div style="font-size: 18px; font-weight: 700; color: ${pnlColor}; font-family: var(--font-mono);">
                                                ${pnlSign}${pnlPct.toFixed(2)}%
                                            </div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">ROI</div>
                                            <div style="font-size: 18px; font-weight: 700; color: ${pnlColor}; font-family: var(--font-mono);">
                                                ${pnlSign}${roi.toFixed(2)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å…³é—­æŒ‰é’® -->
                                <button onclick="this.parentElement.parentElement.remove()" style="
                                    background: rgba(139, 148, 158, 0.1); 
                                    border: none; 
                                    color: var(--text-secondary); 
                                    cursor: pointer; 
                                    padding: 6px; 
                                    width: 28px; 
                                    height: 28px; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    flex-shrink: 0;
                                    border-radius: 6px;
                                    transition: all var(--transition-fast);
                                    position: absolute;
                                    top: 0;
                                    right: 0;
                                " onmouseover="this.style.background='rgba(139, 148, 158, 0.2)'; this.style.color='var(--text-primary)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(139, 148, 158, 0.1)'; this.style.color='var(--text-secondary)'; this.style.transform='scale(1)'">
                                    <i class="bi bi-x" style="font-size: 16px;"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.animation = 'slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 400);
                    }, 8000);
                    
                    // å¹³ä»“åï¼Œç§»é™¤å¯¹åº”çš„æŒä»“è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¹¶åˆ·æ–°è´¦æˆ·ä½™é¢å’Œå†»ç»“èµ„é‡‘
                    const positionsBody = document.getElementById('positionsBody');
                    if (positionsBody) {
                        const row = positionsBody.querySelector(`.position-card[data-position-id="${positionId}"]`);
                        if (row) {
                            row.remove();
                            // æ›´æ–°æŒä»“æ•°é‡
                            const remainingRows = positionsBody.querySelectorAll('.position-card[data-symbol]');
                            const count = remainingRows.length;
                            const positionCount = document.getElementById('positionCount');
                            const positionsTitle = document.getElementById('positions-title');
                            if (positionCount) positionCount.textContent = `${count} ä¸ªæŒä»“`;
                            if (positionsTitle) positionsTitle.textContent = `æŒä»“ä¸­ [${count}]`;

                            // å¦‚æœæ²¡æœ‰æŒä»“äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
                            if (count === 0) {
                                const positionsTable = document.getElementById('positionsTable');
                                const positionsEmpty = document.getElementById('positionsEmpty');
                                if (positionsTable) positionsTable.style.display = 'none';
                                if (positionsEmpty) positionsEmpty.style.display = 'block';
                            }
                        }
                    }
                    // åˆ·æ–°è´¦æˆ·ä½™é¢ï¼ˆé‡Šæ”¾å†»ç»“èµ„é‡‘ï¼‰ã€å¾…æˆäº¤è®¢å•åˆ—è¡¨å’Œæˆäº¤å†å²
                    setTimeout(() => {
                        loadAccount();  // åˆ·æ–°è´¦æˆ·ä½™é¢å’Œå†»ç»“èµ„é‡‘
                        loadOrders();
                        loadTrades();
                        updatePositionsPrices();
                    }, 500);
                } else {
                    const errorMsg = data.message || data.detail || data.error || 'æœªçŸ¥é”™è¯¯';
                    // å¹³ä»“å¤±è´¥å·²åœ¨UIä¸­æ˜¾ç¤º
                    showToast('å¹³ä»“å¤±è´¥: ' + errorMsg, 'error');
                }
            } catch (error) {
                // å¹³ä»“è¯·æ±‚å¤±è´¥å·²åœ¨UIä¸­æ˜¾ç¤º
                showToast('å¹³ä»“å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadData();
            showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
        }

        // æ›´æ–°æ­¢ç›ˆæ­¢æŸ
        async function updateStopLossTakeProfit(positionId, symbol, type, value) {
            if (!value || value === '' || value === null) {
                return; // ç©ºå€¼ä¸å¤„ç†ï¼Œç”±æ¸…é™¤æŒ‰é’®å¤„ç†
            }
            
            const price = parseFloat(value);
            if (isNaN(price) || price <= 0) {
                showToast('ä»·æ ¼æ— æ•ˆ', 'error');
                return;
            }
            
            // ç¡®ä¿ positionId æ˜¯æ•°å­—
            positionId = parseInt(positionId);
            if (isNaN(positionId) || positionId <= 0) {
                showToast('æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            try {
                // å…ˆè·å–å½“å‰æŒä»“ä¿¡æ¯ï¼Œä¿ç•™å¦ä¸€ä¸ªå­—æ®µçš„å€¼
                const positionResponse = await fetch(`${API_BASE}/positions?account_id=2&status=open`);
                const positionData = await positionResponse.json();
                let currentStopLoss = null;
                let currentTakeProfit = null;
                
                if (positionData.success && positionData.data) {
                    const position = positionData.data.find(p => (p.position_id || p.id) == positionId);
                    if (position) {
                        currentStopLoss = position.stop_loss_price || null;
                        currentTakeProfit = position.take_profit_price || null;
                    }
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œä¿ç•™å¦ä¸€ä¸ªå­—æ®µ
                const requestData = {};
                if (type === 'stop_loss') {
                    requestData.stop_loss_price = price;
                    // ä¿ç•™åŸæœ‰çš„æ­¢ç›ˆï¼ˆå³ä½¿ä¸º null ä¹Ÿè¦æ˜ç¡®ä¼ é€’ï¼‰
                    requestData.take_profit_price = currentTakeProfit !== null && currentTakeProfit !== undefined ? currentTakeProfit : null;
                } else if (type === 'take_profit') {
                    requestData.take_profit_price = price;
                    // ä¿ç•™åŸæœ‰çš„æ­¢æŸï¼ˆå³ä½¿ä¸º null ä¹Ÿè¦æ˜ç¡®ä¼ é€’ï¼‰
                    requestData.stop_loss_price = currentStopLoss !== null && currentStopLoss !== undefined ? currentStopLoss : null;
                }
                
                const url = `${API_BASE}/positions/${positionId}/stop-loss-take-profit`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast(`${type === 'stop_loss' ? 'æ­¢æŸ' : 'æ­¢ç›ˆ'}è®¾ç½®æˆåŠŸ`, 'success');
                    // é‡æ–°åŠ è½½æŒä»“æ•°æ®ï¼Œç¡®ä¿ä»æ•°æ®åº“è·å–æœ€æ–°å€¼
                    // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œç¡®ä¿æ•°æ®åº“æ›´æ–°å®Œæˆ
                    setTimeout(async () => {
                        await loadPositions();
                    }, 100);
                } else {
                    showToast(`è®¾ç½®å¤±è´¥: ${data.detail || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showToast(`è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ­¢æŸ
        async function clearStopLoss(positionId, symbol) {
            // ç¡®ä¿ positionId æ˜¯æ•°å­—
            positionId = parseInt(positionId);
            if (isNaN(positionId) || positionId <= 0) {
                showToast('æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            try {
                // å…ˆè·å–å½“å‰æŒä»“ä¿¡æ¯ï¼Œä¿ç•™æ­¢ç›ˆ
                const positionResponse = await fetch(`${API_BASE}/positions?account_id=2&status=open`);
                const positionData = await positionResponse.json();
                let currentTakeProfit = null;
                
                if (positionData.success && positionData.data) {
                    const position = positionData.data.find(p => (p.position_id || p.id) == positionId);
                    if (position) {
                        currentTakeProfit = position.take_profit_price || null;
                    }
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œæ¸…é™¤æ­¢æŸä½†ä¿ç•™æ­¢ç›ˆï¼ˆå³ä½¿ä¸º null ä¹Ÿè¦æ˜ç¡®ä¼ é€’ï¼‰
                const requestData = { 
                    stop_loss_price: null,
                    take_profit_price: currentTakeProfit !== null && currentTakeProfit !== undefined ? currentTakeProfit : null
                };
                
                const response = await fetch(`${API_BASE}/positions/${positionId}/stop-loss-take-profit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('æ­¢æŸå·²æ¸…é™¤', 'success');
                    // é‡æ–°åŠ è½½æŒä»“æ•°æ®ï¼Œç¡®ä¿ä»æ•°æ®åº“è·å–æœ€æ–°å€¼
                    await loadPositions();
                } else {
                    showToast(`æ¸…é™¤å¤±è´¥: ${data.detail || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showToast(`æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤æ­¢ç›ˆ
        async function clearTakeProfit(positionId, symbol) {
            // ç¡®ä¿ positionId æ˜¯æ•°å­—
            positionId = parseInt(positionId);
            if (isNaN(positionId) || positionId <= 0) {
                showToast('æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            try {
                // å…ˆè·å–å½“å‰æŒä»“ä¿¡æ¯ï¼Œä¿ç•™æ­¢æŸ
                const positionResponse = await fetch(`${API_BASE}/positions?account_id=2&status=open`);
                const positionData = await positionResponse.json();
                let currentStopLoss = null;
                
                if (positionData.success && positionData.data) {
                    const position = positionData.data.find(p => (p.position_id || p.id) == positionId);
                    if (position) {
                        currentStopLoss = position.stop_loss_price || null;
                    }
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼Œæ¸…é™¤æ­¢ç›ˆä½†ä¿ç•™æ­¢æŸï¼ˆå³ä½¿ä¸º null ä¹Ÿè¦æ˜ç¡®ä¼ é€’ï¼‰
                const requestData = { 
                    take_profit_price: null,
                    stop_loss_price: currentStopLoss !== null && currentStopLoss !== undefined ? currentStopLoss : null
                };
                
                const response = await fetch(`${API_BASE}/positions/${positionId}/stop-loss-take-profit`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('æ­¢ç›ˆå·²æ¸…é™¤', 'success');
                    // é‡æ–°åŠ è½½æŒä»“æ•°æ®ï¼Œç¡®ä¿ä»æ•°æ®åº“è·å–æœ€æ–°å€¼
                    await loadPositions();
                } else {
                    showToast(`æ¸…é™¤å¤±è´¥: ${data.detail || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showToast(`æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
        }

        // å®æ—¶æ›´æ–°æ­¢ç›ˆæ­¢æŸæ˜¾ç¤º
        function updateStopLossTakeProfitDisplay(positionId, symbol, type, value) {
            // æ›´æ–°è¾“å…¥æ¡†
            const inputId = type === 'stop_loss' 
                ? `stopLoss_${symbol}_${positionId}`
                : `takeProfit_${symbol}_${positionId}`;
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value || '';
            }
            
            // æ›´æ–°å¡ç‰‡ä¸­çš„æ˜¾ç¤ºåŒºåŸŸ
            const card = document.querySelector(`.position-card[data-position-id="${positionId}"]`);
            if (card) {
                // æŸ¥æ‰¾æˆ–åˆ›å»ºæ˜¾ç¤ºåŒºåŸŸ
                let displayArea = card.querySelector('.stop-loss-take-profit-display');
                if (!displayArea) {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œåœ¨ä¿è¯é‡‘è¡Œåé¢æ’å…¥
                    const marginRow = card.querySelector('.text-sm.text-secondary:last-of-type');
                    if (marginRow) {
                        displayArea = document.createElement('div');
                        displayArea.className = 'stop-loss-take-profit-display text-xs text-secondary';
                        displayArea.style.cssText = 'display: flex; gap: 12px; align-items: center; margin-top: 6px;';
                        marginRow.parentNode.insertBefore(displayArea, marginRow.nextSibling);
                    }
                }
                
                if (displayArea) {
                    // è·å–å½“å‰çš„æ­¢ç›ˆæ­¢æŸå€¼
                    const stopLossInput = document.getElementById(`stopLoss_${symbol}_${positionId}`);
                    const takeProfitInput = document.getElementById(`takeProfit_${symbol}_${positionId}`);
                    const stopLossValue = stopLossInput ? stopLossInput.value : '';
                    const takeProfitValue = takeProfitInput ? takeProfitInput.value : '';
                    
                    // æ›´æ–°æ˜¾ç¤º
                    let html = '';
                    if (stopLossValue) {
                        html += `<span style="color: var(--danger-red);"><i class="bi bi-shield-exclamation"></i> æ­¢æŸ: $${formatPrice(parseFloat(stopLossValue))}</span>`;
                    }
                    if (takeProfitValue) {
                        html += `<span style="color: var(--success-green);"><i class="bi bi-bullseye"></i> æ­¢ç›ˆ: $${formatPrice(parseFloat(takeProfitValue))}</span>`;
                    }
                    displayArea.innerHTML = html;
                    
                    // å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œéšè—æ˜¾ç¤ºåŒºåŸŸ
                    if (!stopLossValue && !takeProfitValue) {
                        displayArea.style.display = 'none';
                    } else {
                        displayArea.style.display = 'flex';
                    }
                }
            }
        }

        // å­˜å‚¨æŒä»“æ•°æ®æ˜ å°„ï¼ˆç”¨äºå¿«é€Ÿæ›´æ–°ï¼‰
        let positionsDataMap = {};
        
        let priceUpdateInterval = null;

        // ç›´æ¥åœ¨é¡µé¢ä¸Šä¿å­˜æ­¢ç›ˆæ­¢æŸ
        async function saveStopLossTakeProfitInline(positionId, symbol) {
            try {
                positionId = parseInt(positionId);
                if (isNaN(positionId) || positionId <= 0) {
                    return;
                }
                
                const stopLossInput = document.getElementById(`stopLoss_${positionId}`);
                const takeProfitInput = document.getElementById(`takeProfit_${positionId}`);
                
                const stopLossValue = stopLossInput.value.trim();
                const takeProfitValue = takeProfitInput.value.trim();
                
                const stopLossPrice = stopLossValue ? parseFloat(stopLossValue) : null;
                const takeProfitPrice = takeProfitValue ? parseFloat(takeProfitValue) : null;
                
                // éªŒè¯ä»·æ ¼æœ‰æ•ˆæ€§
                if (stopLossPrice !== null && (isNaN(stopLossPrice) || stopLossPrice <= 0)) {
                    showToast('æ­¢æŸä»·æ ¼æ— æ•ˆ', 'error');
                    return;
                }
                
                if (takeProfitPrice !== null && (isNaN(takeProfitPrice) || takeProfitPrice <= 0)) {
                    showToast('æ­¢ç›ˆä»·æ ¼æ— æ•ˆ', 'error');
                    return;
                }
                
                // å…ˆè·å–å½“å‰æŒä»“ä¿¡æ¯ï¼Œä¿ç•™å¦ä¸€ä¸ªå­—æ®µçš„å€¼
                let currentStopLoss = null;
                let currentTakeProfit = null;
                
                try {
                    const positionResponse = await fetch(`${API_BASE}/positions/${positionId}`);
                    const positionData = await positionResponse.json();
                    if (positionData.success && positionData.data) {
                        currentStopLoss = positionData.data.stop_loss_price;
                        currentTakeProfit = positionData.data.take_profit_price;
                    }
                } catch (e) {
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼šæ€»æ˜¯åŒæ—¶ä¼ é€’ä¸¤ä¸ªå­—æ®µï¼Œç¡®ä¿å¦ä¸€ä¸ªå­—æ®µè¢«ä¿ç•™
                const requestData = {
                    stop_loss_price: stopLossPrice !== undefined && stopLossPrice !== null ? stopLossPrice : (currentStopLoss !== null && currentStopLoss !== undefined ? currentStopLoss : null),
                    take_profit_price: takeProfitPrice !== undefined && takeProfitPrice !== null ? takeProfitPrice : (currentTakeProfit !== null && currentTakeProfit !== undefined ? currentTakeProfit : null)
                };
                
                const url = `${API_BASE}/positions/${positionId}/stop-loss-take-profit`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    showToast('æ­¢ç›ˆæ­¢æŸè®¾ç½®æˆåŠŸ', 'success');
                    // ä¸é‡æ–°åŠ è½½æ•´ä¸ªåˆ—è¡¨ï¼Œåªæ›´æ–°å·¦ä¾§æ˜¾ç¤ºåŒºåŸŸ
                    const card = document.querySelector(`.position-card[data-position-id="${positionId}"]`);
                    if (card) {
                        // æ›´æ–°å·¦ä¾§æ˜¾ç¤ºåŒºåŸŸ
                        let displayArea = card.querySelector('.stop-loss-take-profit-display');
                        if (displayArea) {
                            // æ›´æ–°æ˜¾ç¤º
                            let displayHtml = '';
                            if (stopLossPrice !== null && stopLossPrice > 0) {
                                displayHtml += `<span style="color: var(--danger-red);"><i class="bi bi-shield-exclamation"></i> æ­¢æŸ: $${formatPrice(stopLossPrice)}</span>`;
                            }
                            if (takeProfitPrice !== null && takeProfitPrice > 0) {
                                if (displayHtml) displayHtml += ' ';
                                displayHtml += `<span style="color: var(--success-green);"><i class="bi bi-bullseye"></i> æ­¢ç›ˆ: $${formatPrice(takeProfitPrice)}</span>`;
                            }
                            displayArea.innerHTML = displayHtml;
                            displayArea.style.display = displayHtml ? 'flex' : 'none';
                        } else if ((stopLossPrice !== null && stopLossPrice > 0) || (takeProfitPrice !== null && takeProfitPrice > 0)) {
                            // å¦‚æœæ˜¾ç¤ºåŒºåŸŸä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                            const leftSection = card.querySelector('div > div:first-child');
                            if (leftSection) {
                                displayArea = document.createElement('div');
                                displayArea.className = 'stop-loss-take-profit-display text-xs text-secondary';
                                displayArea.style.cssText = 'display: flex; gap: 12px; align-items: center; margin-top: 6px;';
                                let displayHtml = '';
                                if (stopLossPrice !== null && stopLossPrice > 0) {
                                    displayHtml += `<span style="color: var(--danger-red);"><i class="bi bi-shield-exclamation"></i> æ­¢æŸ: $${formatPrice(stopLossPrice)}</span>`;
                                }
                                if (takeProfitPrice !== null && takeProfitPrice > 0) {
                                    if (displayHtml) displayHtml += ' ';
                                    displayHtml += `<span style="color: var(--success-green);"><i class="bi bi-bullseye"></i> æ­¢ç›ˆ: $${formatPrice(takeProfitPrice)}</span>`;
                                }
                                displayArea.innerHTML = displayHtml;
                                leftSection.appendChild(displayArea);
                            }
                        }
                    }
                } else {
                    showToast(`è®¾ç½®å¤±è´¥: ${data.detail || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showToast(`è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰“å¼€æ­¢ç›ˆæ­¢æŸè®¾ç½®å¼¹æ¡†ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ä»¥é˜²å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
        function openStopLossTakeProfitModal(positionId, symbol, isLong, entryPrice, currentStopLoss, currentTakeProfit) {
            // æš‚åœä»·æ ¼æ›´æ–°
            stopLossTakeProfitModalOpen = true;
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = null;
            }
            
            const overlay = document.createElement('div');
            overlay.id = 'stopLossTakeProfitModal';
            overlay.className = 'modal-overlay';
            
            overlay.innerHTML = `
                <div class="modal-dialog" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, rgba(43, 111, 237, 0.1) 0%, transparent 100%);">
                        <div class="modal-title">
                            <div class="modal-icon" style="background: linear-gradient(135deg, rgba(43, 111, 237, 0.2) 0%, rgba(43, 111, 237, 0.1) 100%); border-color: rgba(43, 111, 237, 0.3);">
                                <i class="bi bi-shield-check" style="font-size: 24px; color: var(--primary-blue);"></i>
                            </div>
                            <span>è®¾ç½®æ­¢ç›ˆæ­¢æŸ - ${symbol}</span>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æŒä»“ä¿¡æ¯</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                <div><span style="color: var(--text-tertiary);">æ–¹å‘:</span> <strong style="color: var(--text-primary);">${isLong ? 'åšå¤š' : 'åšç©º'}</strong></div>
                                <div><span style="color: var(--text-tertiary);">å¼€ä»“ä»·:</span> <strong style="color: var(--text-primary); font-family: var(--font-mono);">$${formatPrice(entryPrice)}</strong></div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                                <i class="bi bi-shield-exclamation" style="color: var(--danger-red);"></i> æ­¢æŸä»·æ ¼
                            </label>
                            <input type="number" 
                                   id="modalStopLossPrice" 
                                   value="${currentStopLoss !== null && currentStopLoss !== undefined && currentStopLoss !== 'null' ? currentStopLoss : ''}" 
                                   placeholder="è¯·è¾“å…¥æ­¢æŸä»·æ ¼"
                                   step="0.00000001"
                                   style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: var(--font-mono);">
                            <div style="margin-top: 4px; font-size: 11px; color: var(--text-tertiary);">
                                ${isLong ? 'æ­¢æŸä»·åº”ä½äºå¼€ä»“ä»·' : 'æ­¢æŸä»·åº”é«˜äºå¼€ä»“ä»·'}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
                                <i class="bi bi-bullseye" style="color: var(--success-green);"></i> æ­¢ç›ˆä»·æ ¼
                            </label>
                            <input type="number" 
                                   id="modalTakeProfitPrice" 
                                   value="${currentTakeProfit !== null && currentTakeProfit !== undefined && currentTakeProfit !== 'null' ? currentTakeProfit : ''}" 
                                   placeholder="è¯·è¾“å…¥æ­¢ç›ˆä»·æ ¼"
                                   step="0.00000001"
                                   style="width: 100%; padding: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: var(--font-mono);">
                            <div style="margin-top: 4px; font-size: 11px; color: var(--text-tertiary);">
                                ${isLong ? 'æ­¢ç›ˆä»·åº”é«˜äºå¼€ä»“ä»·' : 'æ­¢ç›ˆä»·åº”ä½äºå¼€ä»“ä»·'}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" id="modalCancelBtn" style="min-width: 100px;">
                            <i class="bi bi-x-circle"></i> å–æ¶ˆ
                        </button>
                        <button class="btn btn-ghost" id="modalClearBtn" style="min-width: 100px;">
                            <i class="bi bi-trash"></i> æ¸…é™¤
                        </button>
                        <button class="btn btn-primary" id="modalSaveBtn" style="min-width: 100px;">
                            <i class="bi bi-check-circle"></i> ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            const closeModal = () => {
                overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                const dialog = overlay.querySelector('.modal-dialog');
                dialog.style.animation = 'slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                setTimeout(() => {
                    overlay.remove();
                    stopLossTakeProfitModalOpen = false;
                    // æ¢å¤ä»·æ ¼æ›´æ–°
                    if (!priceUpdateInterval) {
                        priceUpdateInterval = setInterval(updatePositionsPrices, 2000);
                    }
                }, 300);
            };
            
            overlay.querySelector('#modalCancelBtn').onclick = closeModal;
            overlay.querySelector('#modalClearBtn').onclick = async () => {
                if (await showConfirmDialog('æ¸…é™¤æ­¢ç›ˆæ­¢æŸ', 'ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ­¢ç›ˆæ­¢æŸè®¾ç½®å—ï¼Ÿ', 'warning')) {
                    await saveStopLossTakeProfit(positionId, symbol, null, null, closeModal);
                }
            };
            overlay.querySelector('#modalSaveBtn').onclick = async () => {
                const stopLossInput = document.getElementById('modalStopLossPrice');
                const takeProfitInput = document.getElementById('modalTakeProfitPrice');
                
                // è·å–è¾“å…¥å€¼ï¼Œç©ºå­—ç¬¦ä¸²è§†ä¸º null
                const stopLossValue = stopLossInput.value.trim();
                const takeProfitValue = takeProfitInput.value.trim();
                
                // è½¬æ¢ä¸ºæ•°å­—æˆ– null
                const stopLossPrice = stopLossValue ? parseFloat(stopLossValue) : null;
                const takeProfitPrice = takeProfitValue ? parseFloat(takeProfitValue) : null;
                
                // éªŒè¯ä»·æ ¼æœ‰æ•ˆæ€§
                if (stopLossPrice !== null && (isNaN(stopLossPrice) || stopLossPrice <= 0)) {
                    showToast('æ­¢æŸä»·æ ¼æ— æ•ˆ', 'error');
                    return;
                }
                
                if (takeProfitPrice !== null && (isNaN(takeProfitPrice) || takeProfitPrice <= 0)) {
                    showToast('æ­¢ç›ˆä»·æ ¼æ— æ•ˆ', 'error');
                    return;
                }
                
                // å¦‚æœä¸¤ä¸ªéƒ½ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
                if (stopLossPrice === null && takeProfitPrice === null) {
                    showToast('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªæ­¢ç›ˆæˆ–æ­¢æŸä»·æ ¼', 'warning');
                    return;
                }
                
                await saveStopLossTakeProfit(
                    positionId, 
                    symbol, 
                    stopLossPrice, 
                    takeProfitPrice, 
                    closeModal
                );
            };
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    closeModal();
                }
            };
        }
        
        // ä¿å­˜æ­¢ç›ˆæ­¢æŸè®¾ç½® - ç›´æ¥æ ¹æ®è®¢å•å·ä¿å­˜åˆ°æ•°æ®åº“
        async function saveStopLossTakeProfit(positionId, symbol, stopLossPrice, takeProfitPrice, closeCallback) {
            try {
                positionId = parseInt(positionId);
                
                if (isNaN(positionId) || positionId <= 0) {
                    showToast('æŒä»“IDæ— æ•ˆ', 'error');
                    return;
                }
                
                // å…ˆè·å–å½“å‰æŒä»“ä¿¡æ¯ï¼Œä¿ç•™å¦ä¸€ä¸ªå­—æ®µçš„å€¼
                let currentStopLoss = null;
                let currentTakeProfit = null;
                
                try {
                    const positionResponse = await fetch(`${API_BASE}/positions/${positionId}`);
                    const positionData = await positionResponse.json();
                    
                    if (positionData.success && positionData.data) {
                        currentStopLoss = positionData.data.stop_loss_price;
                        currentTakeProfit = positionData.data.take_profit_price;
                    } else {
                        showToast(`è·å–æŒä»“ä¿¡æ¯å¤±è´¥: ${positionData.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                        return;
                    }
                } catch (e) {
                    showToast(`è·å–æŒä»“ä¿¡æ¯å¤±è´¥: ${e.message}`, 'error');
                    return;
                }
                
                // æ„å»ºè¯·æ±‚æ•°æ®ï¼šæ€»æ˜¯åŒæ—¶ä¼ é€’ä¸¤ä¸ªå­—æ®µï¼Œç¡®ä¿å¦ä¸€ä¸ªå­—æ®µè¢«ä¿ç•™
                const requestData = {
                    stop_loss_price: stopLossPrice !== undefined && stopLossPrice !== null ? stopLossPrice : (currentStopLoss !== null && currentStopLoss !== undefined ? currentStopLoss : null),
                    take_profit_price: takeProfitPrice !== undefined && takeProfitPrice !== null ? takeProfitPrice : (currentTakeProfit !== null && currentTakeProfit !== undefined ? currentTakeProfit : null)
                };
                
                
                const url = `${API_BASE}/positions/${positionId}/stop-loss-take-profit`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('æ­¢ç›ˆæ­¢æŸè®¾ç½®æˆåŠŸ', 'success');
                    if (closeCallback) closeCallback();
                    // é‡æ–°åŠ è½½æŒä»“æ•°æ®ï¼Œç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
                    await loadPositions();
                } else {
                    showToast(`è®¾ç½®å¤±è´¥: ${data.detail || data.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                showToast(`è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°æŒä»“ä»·æ ¼å’Œç›ˆäºï¼ˆä¸é‡æ–°åŠ è½½æ•´ä¸ªæŒä»“åˆ—è¡¨ï¼‰
        async function updatePositionsPrices() {
            try {
                const positionsBody = document.getElementById('positionsBody');
                if (!positionsBody) {
                    return;
                }
                
                // è·å–æ‰€æœ‰æŒä»“å¡ç‰‡
                const positionRows = positionsBody.querySelectorAll('.position-card[data-symbol]');
                
                if (positionRows.length === 0) {
                    // å¦‚æœæ²¡æœ‰æŒä»“ï¼Œå°è¯•é‡æ–°åŠ è½½ä¸€æ¬¡
                    await loadPositions();
                    return;
                }
                
                // ä¸ºæ¯ä¸ªæŒä»“æ›´æ–°ä»·æ ¼å’Œç›ˆäº
                await Promise.all(Array.from(positionRows).map(async (row) => {
                    const symbol = row.getAttribute('data-symbol');
                    const positionId = row.getAttribute('data-position-id');
                    if (!symbol || !positionId) {
                        return;
                    }
                    
                    try {
                        // è·å–å®æ—¶ä»·æ ¼ï¼ˆä½¿ç”¨å®æ—¶APIï¼‰
                        const priceUrl = `/api/futures/price/${encodeURIComponent(symbol)}`;
                        const priceResponse = await fetch(priceUrl);
                        if (priceResponse.ok) {
                            const priceData = await priceResponse.json();
                            if (priceData.success && priceData.price) {
                                const currentPrice = parseFloat(priceData.price);
                                
                                // è·å–æŒä»“æ•°æ®ï¼ˆä»æ˜ å°„è¡¨æˆ–å¡ç‰‡æ•°æ®ï¼Œä½¿ç”¨position_idä½œä¸ºé”®ï¼‰
                                let positionData = positionsDataMap[positionId];
                                if (!positionData) {
                                    // ä»å¡ç‰‡æ–‡æœ¬ä¸­æå–æ•°æ®
                                    const cardText = row.textContent;
                                    const entryPriceMatch = cardText.match(/å¼€ä»“ä»·:\s*\$?([\d,]+\.?\d*)/);
                                    const quantityMatch = cardText.match(/æ•°é‡:\s*([\d,]+\.?\d*)/);
                                    const marginMatch = cardText.match(/ä¿è¯é‡‘:\s*([\d,]+\.?\d*)/);
                                    const positionSide = row.querySelector('.badge-success') ? 'LONG' : 'SHORT';
                                    
                                    if (entryPriceMatch && quantityMatch && marginMatch) {
                                        const entryPrice = parseFloat(entryPriceMatch[1].replace(/,/g, '')) || 0;
                                        const quantity = parseFloat(quantityMatch[1].replace(/,/g, '')) || 0;
                                        const margin = parseFloat(marginMatch[1].replace(/,/g, '')) || 0;
                                        
                                        positionData = {
                                            entry_price: entryPrice,
                                            quantity: quantity,
                                            margin: margin,
                                            position_side: positionSide
                                        };
                                        positionsDataMap[positionId] = positionData;
                                    } else {
                                        return; // æ— æ³•è·å–æŒä»“æ•°æ®ï¼Œè·³è¿‡
                                    }
                                }
                                
                                const { entry_price, quantity, margin, position_side } = positionData;
                                
                                // è®¡ç®—å®æ—¶ç›ˆäº
                                let unrealizedPnl = 0;
                                let unrealizedPnlPct = 0;
                                
                                // ç¡®ä¿æ‰€æœ‰å€¼éƒ½æ˜¯æ•°å­—
                                const currentPriceNum = parseFloat(currentPrice) || 0;
                                const entryPriceNum = parseFloat(entry_price) || 0;
                                const quantityNum = parseFloat(quantity) || 0;
                                const marginNum = parseFloat(margin) || 0;
                                
                                if (currentPriceNum > 0 && entryPriceNum > 0 && quantityNum > 0) {
                                    if (position_side === 'LONG') {
                                        unrealizedPnl = (currentPriceNum - entryPriceNum) * quantityNum;
                                    } else {
                                        unrealizedPnl = (entryPriceNum - currentPriceNum) * quantityNum;
                                    }
                                    
                                    // ç›ˆäºç™¾åˆ†æ¯”åŸºäºä¿è¯é‡‘è®¡ç®—
                                    if (marginNum > 0) {
                                        unrealizedPnlPct = (unrealizedPnl / marginNum) * 100;
                                    }
                                } else {
                                    return; // æ•°æ®æ— æ•ˆï¼Œè·³è¿‡
                                }
                                
                                // æ›´æ–°ä»·æ ¼æ˜¾ç¤º - å°è¯•å¤šç§é€‰æ‹©å™¨
                                let priceCell = row.querySelector('.current-price-cell[data-symbol="' + symbol + '"]');
                                if (!priceCell) {
                                    // å°è¯•å…¶ä»–å¯èƒ½çš„é€‰æ‹©å™¨
                                    priceCell = row.querySelector('[data-symbol="' + symbol + '"].current-price-cell');
                                }
                                if (!priceCell) {
                                    // å°è¯•æŸ¥æ‰¾åŒ…å«ä»·æ ¼çš„å•å…ƒæ ¼
                                    const allCells = row.querySelectorAll('td, .cell, [class*="price"]');
                                    for (let cell of allCells) {
                                        if (cell.textContent.includes('$') || cell.textContent.match(/[\d,]+\.?\d*/)) {
                                            priceCell = cell;
                                            break;
                                        }
                                    }
                                }
                                
                                if (priceCell) {
                                    priceCell.textContent = '$' + formatPrice(currentPrice);
                                    
                                    // æ ¹æ®ä»·æ ¼å˜åŒ–æ·»åŠ é¢œè‰²æ ‡æ³¨
                                    if (currentPrice > entry_price) {
                                        priceCell.style.color = 'var(--success-green)';
                                    } else if (currentPrice < entry_price) {
                                        priceCell.style.color = 'var(--danger-red)';
                                    } else {
                                        priceCell.style.color = 'var(--primary-blue)';
                                    }
                                }
                                
                                // æ›´æ–°æ­¢ç›ˆæ­¢æŸè¾“å…¥æ¡†çš„å€¼ï¼ˆåªæœ‰åœ¨è¾“å…¥æ¡†æ²¡æœ‰ç„¦ç‚¹æ—¶æ‰æ›´æ–°ï¼Œé¿å…è¦†ç›–ç”¨æˆ·æ­£åœ¨è¾“å…¥çš„å€¼ï¼‰
                                if (positionId) {
                                    const stopLossInput = document.getElementById(`stopLoss_${positionId}`);
                                    const takeProfitInput = document.getElementById(`takeProfit_${positionId}`);
                                    
                                    // åªæœ‰å½“è¾“å…¥æ¡†æ²¡æœ‰ç„¦ç‚¹æ—¶ï¼Œæ‰ä»æ•°æ®åº“æ›´æ–°å€¼
                                    if (stopLossInput && document.activeElement !== stopLossInput) {
                                        // ä¸æ›´æ–°ï¼Œä¿æŒç”¨æˆ·è¾“å…¥çš„å€¼
                                    }
                                    if (takeProfitInput && document.activeElement !== takeProfitInput) {
                                        // ä¸æ›´æ–°ï¼Œä¿æŒç”¨æˆ·è¾“å…¥çš„å€¼
                                    }
                                }
                                
                                // æ›´æ–°æœªå®ç°ç›ˆäºï¼ˆå¡ç‰‡æ ·å¼ï¼Œä½¿ç”¨position_idä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                                let pnlCell = row.querySelector(`[data-pnl="${positionId}"]`);
                                if (pnlCell) {
                                    const pnlClass = unrealizedPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                                    pnlCell.className = `${pnlClass} font-mono`;
                                    let formattedPnl = formatLargeNumber(unrealizedPnl);
                                    const newPnlText = (unrealizedPnl >= 0 ? '+' : '') + formattedPnl;
                                    pnlCell.textContent = newPnlText;
                                }
                                
                                // æ›´æ–°æœªå®ç°ç›ˆäºç™¾åˆ†æ¯”ï¼ˆå¡ç‰‡æ ·å¼ï¼Œä½¿ç”¨position_idä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼‰
                                let pnlPctCell = row.querySelector(`[data-pnl-pct="${positionId}"]`);
                                if (pnlPctCell) {
                                    const pnlClass = unrealizedPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                                    pnlPctCell.className = pnlClass;
                                    const newPnlPctText = (unrealizedPnlPct >= 0 ? '+' : '') + unrealizedPnlPct.toFixed(2) + '%';
                                    pnlPctCell.textContent = newPnlPctText;
                                }
                                
                                // æ›´æ–°æ˜ å°„è¡¨ä¸­çš„æ•°æ®
                                positionData.current_price = currentPrice;
                                positionData.unrealized_pnl = unrealizedPnl;
                                positionData.unrealized_pnl_pct = unrealizedPnlPct;
                            }
                        }
                    } catch (e) {
                        console.error(`updatePositionsPrices: ${symbol} æ›´æ–°å¤±è´¥`, e);
                        console.error(`updatePositionsPrices: ${symbol} é”™è¯¯å †æ ˆ:`, e.stack);
                    }
                }));
                
                // æ›´æ–°è´¦æˆ·ä¿¡æ¯ä¸­çš„æœªå®ç°ç›ˆäºæ€»å’Œ
                const totalUnrealizedPnl = Object.values(positionsDataMap).reduce((sum, pos) => {
                    return sum + (parseFloat(pos.unrealized_pnl) || 0);
                }, 0);
                
                const unrealizedPnlCard = document.querySelector('.stat-card:nth-child(3) .stat-value');
                if (unrealizedPnlCard) {
                    const pnlClass = totalUnrealizedPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                    unrealizedPnlCard.className = `stat-value ${pnlClass}`;
                    unrealizedPnlCard.textContent = (totalUnrealizedPnl >= 0 ? '+' : '') + formatLargeNumber(totalUnrealizedPnl);
                }
            } catch (error) {
                // é™é»˜å¤„ç†æ›´æ–°å¤±è´¥
            }
        }
        
        // åˆå§‹åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            
            // å…ˆåŠ è½½æ•°æ®ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼Œä¸è‡ªåŠ¨åˆ·æ–°ï¼‰
            loadData().then(() => {
                // å»¶è¿Ÿ1ç§’åå¼€å§‹ç¬¬ä¸€æ¬¡ä»·æ ¼å’Œç›ˆäºæ›´æ–°ï¼Œç¡®ä¿æŒä»“æ•°æ®å·²å®Œå…¨æ¸²æŸ“
                setTimeout(() => {
                    // ç«‹å³æ‰§è¡Œä¸€æ¬¡æ›´æ–°
                    updatePositionsPrices();
                    // ç„¶åæ¯2ç§’åªæ›´æ–°ä»·æ ¼å’Œç›ˆäºï¼Œä¸åˆ·æ–°å…¶ä»–å†…å®¹
                    if (!priceUpdateInterval) {
                        priceUpdateInterval = setInterval(() => {
                            updatePositionsPrices();
                        }, 2000);
                    }
                }, 1000);
            }).catch(err => {
                // é™é»˜å¤„ç†åˆå§‹æ•°æ®åŠ è½½å¤±è´¥
                // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿå°è¯•å¯åŠ¨ä»·æ ¼æ›´æ–°
                setTimeout(() => {
                    updatePositionsPrices();
                    if (!priceUpdateInterval) {
                        priceUpdateInterval = setInterval(() => {
                            updatePositionsPrices();
                        }, 2000);
                    }
                }, 2000);
            });
            
            // å·²ç¦ç”¨ loadData çš„å®šæ—¶åˆ·æ–°ï¼Œé¿å…åˆ·æ–°æŒä»“åˆ—è¡¨ã€è®¢å•åˆ—è¡¨ç­‰
            // åªä¿ç•™ä»·æ ¼å’Œç›ˆäºçš„å®æ—¶æ›´æ–°
            // setInterval(loadData, 5000);  // ä¸å†è‡ªåŠ¨åˆ·æ–°æŒä»“åˆ—è¡¨
            // setInterval(refreshPrice, 2000);  // ä¸å†å•ç‹¬åˆ·æ–°ä»·æ ¼ï¼Œå·²åˆå¹¶åˆ° updatePositionsPrices
        });
    </script>
</body>
</html>
