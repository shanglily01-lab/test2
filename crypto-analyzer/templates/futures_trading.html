<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ‹Ÿåˆçº¦äº¤æ˜“ - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; }
        .header-actions { display: flex; gap: var(--spacing-md); align-items: center; flex-wrap: wrap; }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: var(--spacing-md); }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-lg); text-align: center; transition: all var(--transition-base); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary-blue), var(--secondary-purple)); opacity: 0; transition: opacity var(--transition-base); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--primary-blue); }
        .stat-card:hover::before { opacity: 1; }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); font-weight: 600; }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-xs); font-family: var(--font-mono); }
        .stat-change { font-size: 13px; color: var(--text-secondary); }
        .stat-change.positive { color: var(--success-green); }
        .stat-change.negative { color: var(--danger-red); }
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border-default); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        thead { background: var(--bg-tertiary); border-bottom: 2px solid var(--border-default); }
        th { padding: var(--spacing-md) var(--spacing-lg); text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: var(--spacing-lg); border-bottom: 1px solid var(--border-default); color: var(--text-primary); font-size: 13px; }
        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color var(--transition-fast); }
        tbody tr:hover { background: var(--bg-hover); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 500; line-height: 1; text-decoration: none; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); white-space: nowrap; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-blue-hover); border-color: var(--primary-blue-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-success { background: var(--success-green); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #DC2626; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--border-muted); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border-color: transparent; }
        .btn-ghost:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
        .btn-sm { padding: var(--spacing-sm) var(--spacing-md); font-size: 12px; }
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
        .badge-success { background: var(--success-green-bg); color: var(--success-green); }
        .badge-danger { background: var(--danger-red-bg); color: var(--danger-red); }
        .badge-info { background: var(--primary-blue-light); color: var(--primary-blue); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .pnl-positive { color: var(--success-green); }
        .pnl-negative { color: var(--danger-red); }
        .status-indicator { display: inline-flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-full); font-size: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .status-dot.online { background: var(--success-green); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .empty-state-icon { font-size: 48px; margin-bottom: var(--spacing-lg); opacity: 0.5; }
        .empty-state-text { font-size: 15px; margin-bottom: var(--spacing-sm); }
        .loading-overlay { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--bg-tertiary); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-success { color: var(--success-green); }
        .text-danger { color: var(--danger-red); }
        .d-flex { display: flex; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--spacing-sm); }
        .gap-md { gap: var(--spacing-md); }
        .mb-sm { margin-bottom: var(--spacing-sm); }
        .font-mono { font-family: var(--font-mono); }
        .text-sm { font-size: 13px; }
        .text-xs { font-size: 11px; }
        .last-update { font-size: 12px; color: var(--text-secondary); }
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
        .form-control { width: 100%; padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: var(--font-family); transition: all var(--transition-base); }
        .form-control:focus { outline: none; border-color: var(--primary-blue); background: var(--bg-card); box-shadow: 0 0 0 3px rgba(43, 111, 237, 0.1); }
        .form-control:disabled, .form-control[readonly] { opacity: 0.6; cursor: not-allowed; background: var(--bg-secondary); }
        select.form-control { cursor: pointer; }
        input[type="number"].form-control { font-family: var(--font-mono); }
        .toast { 
            position: fixed; 
            bottom: 24px; 
            right: 24px; 
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); 
            border: 1px solid var(--border-default); 
            border-radius: var(--radius-lg); 
            padding: var(--spacing-lg); 
            box-shadow: var(--shadow-xl); 
            z-index: 10000; 
            min-width: 320px; 
            max-width: 520px; 
            animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            transition: all var(--transition-base);
        }
        .toast:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl), 0 0 20px rgba(43, 111, 237, 0.2);
        }
        @keyframes slideInRight { 
            from { 
                transform: translateX(120%); 
                opacity: 0; 
            } 
            to { 
                transform: translateX(0); 
                opacity: 1; 
            } 
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.9;
            }
        }
        .toast.success { 
            border-left: 4px solid var(--success-green);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-card) 100%);
        }
        .toast.error { 
            border-left: 4px solid var(--danger-red);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-card) 100%);
        }
        .toast.info { 
            border-left: 4px solid var(--info-blue);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, var(--bg-card) 100%);
        }
        /* è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-dialog {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 0;
            min-width: 400px;
            max-width: 500px;
            box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        @keyframes slideUp {
            from {
                transform: translateY(20px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-default);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            border: 2px solid rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .modal-body {
            padding: var(--spacing-xl);
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 14px;
        }
        .modal-footer {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-top: 1px solid var(--border-default);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            background: var(--bg-secondary);
        }
        .trading-layout { display: grid; grid-template-columns: 400px 1fr; gap: var(--spacing-xl); align-items: stretch; }
        .trading-panel-wrapper { display: flex; flex-direction: column; height: 100%; }
        .positions-trades-wrapper { display: flex; flex-direction: column; gap: var(--spacing-xl); height: 100%; }
        .positions-card, .trades-card { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        .positions-card .card-body, .trades-card .card-body { flex: 1; overflow-y: auto; min-height: 0; }
        .positions-card .card-body::-webkit-scrollbar, .trades-card .card-body::-webkit-scrollbar { width: 6px; }
        .positions-card .card-body::-webkit-scrollbar-track, .trades-card .card-body::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .positions-card .card-body::-webkit-scrollbar-thumb, .trades-card .card-body::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
        .positions-card .card-body::-webkit-scrollbar-thumb:hover, .trades-card .card-body::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        @media (max-width: 1400px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .trading-layout { grid-template-columns: 350px 1fr; }
        }
        @media (max-width: 1200px) {
            .trading-layout { grid-template-columns: 1fr; align-items: start; }
            .trading-panel-wrapper, .positions-trades-wrapper { height: auto; }
            .positions-card, .trades-card { min-height: 400px; }
        }
        @media (max-width: 768px) {
            .container { padding: var(--spacing-md); }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); }
            .stat-value { font-size: 20px; }
            .stat-label { font-size: 11px; }
            .stat-card { padding: var(--spacing-md); }
            .nav-links { flex-direction: column; }
            th, td { padding: var(--spacing-sm); font-size: 11px; }
            .trading-layout { grid-template-columns: 1fr; gap: var(--spacing-lg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <img src="/static/images/logo/alphaflow-logo-icon.svg" alt="AlphaFlow" style="height: 36px; width: auto;">
                        <div>
                            <h1 class="header-title" style="margin: 0;">
                                <i class="bi bi-graph-up-arrow"></i>
                                æ¨¡æ‹Ÿåˆçº¦äº¤æ˜“
                            </h1>
                            <p class="header-subtitle">
                                <span class="status-indicator">
                                    <span class="status-dot online"></span>
                                    ç³»ç»Ÿè¿è¡Œä¸­
                                </span>
                                <span style="margin-left: 16px;">æœ€åæ›´æ–°: <span id="lastUpdate" class="last-update">--</span></span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-container slide-up">
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> é¦–é¡µ
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/paper_trading" class="nav-link">
                    <i class="bi bi-journals"></i> æ¨¡æ‹Ÿç°è´§
                </a>
                <a href="/futures_trading" class="nav-link active">
                    <i class="bi bi-graph-up-arrow"></i> æ¨¡æ‹Ÿåˆçº¦
                </a>
                <a href="/strategies" class="nav-link">
                    <i class="bi bi-diagram-3"></i> ç­–ç•¥ç®¡ç†
                </a>
                <a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF æ•°æ®
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> ä¼ä¸šé‡‘åº“
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> æ•°æ®ç®¡ç†
                </a>
            </div>
        </nav>

        <!-- Account Overview -->
        <div class="card slide-up">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-wallet2"></i>
                    <span id="account-title">è´¦æˆ·æ€»è§ˆ</span>
                </h2>
                <div class="last-update" id="account-update">-</div>
            </div>
            <div class="card-body">
                <div id="accountLoading" class="loading-overlay">
                    <div class="spinner"></div>
                </div>
                <div id="accountStats" class="stats-grid" style="display: none;">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>

        <!-- Trading Panel and Positions Side by Side -->
        <div class="trading-layout">
            <!-- Trading Panel -->
            <div class="card slide-up trading-panel-wrapper" style="margin-bottom: 0;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="bi bi-currency-exchange"></i>
                        äº¤æ˜“é¢æ¿
                    </h2>
                </div>
                <div class="card-body">
                    <form id="trade-form">
                        <div class="form-group">
                            <label class="form-label">äº¤æ˜“å¯¹</label>
                            <select class="form-control" id="symbol" required>
                                <option value="">åŠ è½½ä¸­...</option>
                            </select>
                        </div>
                    <div class="form-group">
                        <div class="d-flex justify-between align-center" style="margin-bottom: var(--spacing-sm);">
                            <label class="form-label" style="margin-bottom: 0;">
                                å½“å‰ä»·æ ¼: <span id="current-price-display" class="font-mono" style="color: var(--primary-blue); font-weight: 600; margin-left: 8px;">--</span>
                            </label>
                            <button type="button" class="btn btn-sm btn-ghost" onclick="refreshPrice()" style="padding: 4px 8px; min-width: auto;">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <input type="number" class="form-control" id="current-price" step="0.00000001" placeholder="è¾“å…¥é™ä»·ä»·æ ¼ï¼ˆå¯é€‰ï¼‰">
                        <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                            ä¸Šæ–¹æ˜¾ç¤ºå®æ—¶åˆçº¦ä»·æ ¼ï¼Œä¸‹æ–¹å¯è¾“å…¥é™ä»·å•ä»·æ ¼
                        </small>
                    </div>
                        <div class="form-group">
                            <label class="form-label">æ–¹å‘</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                <button type="button" class="btn btn-success" id="long-btn" onclick="selectPositionSide('LONG')" style="width: 100%;">
                                    <i class="bi bi-arrow-up-circle"></i> åšå¤š
                                </button>
                                <button type="button" class="btn btn-secondary" id="short-btn" onclick="selectPositionSide('SHORT')" style="width: 100%;">
                                    <i class="bi bi-arrow-down-circle"></i> åšç©º
                                </button>
                            </div>
                            <input type="hidden" id="position-side" value="LONG">
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ æ†å€æ•°</label>
                            <select class="form-control" id="leverage" required>
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="5">5x</option>
                                <option value="10" selected>10x</option>
                                <option value="20">20x</option>
                                <option value="50">50x</option>
                                <option value="100">100x</option>
                                <option value="125">125x</option>
                            </select>
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                æ æ†è¶Šé«˜ï¼Œé£é™©è¶Šå¤§ï¼Œè¯·è°¨æ…é€‰æ‹©
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ•°é‡</label>
                            <input type="number" class="form-control" id="quantity" step="0.00000001" required placeholder="è¯·è¾“å…¥æ•°é‡">
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                é¢„è®¡ä¿è¯é‡‘: <span id="estimated-margin" class="font-mono">0.00</span> USDT
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ­¢æŸä»·ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="number" class="form-control" id="stop-loss-price" step="0.00000001" placeholder="è®¾ç½®æ­¢æŸä»·æ ¼">
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                å½“ä»·æ ¼è¾¾åˆ°æ­¢æŸä»·æ—¶å°†è‡ªåŠ¨å¹³ä»“
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æ­¢ç›ˆä»·ï¼ˆå¯é€‰ï¼‰</label>
                            <input type="number" class="form-control" id="take-profit-price" step="0.00000001" placeholder="è®¾ç½®æ­¢ç›ˆä»·æ ¼">
                            <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                å½“ä»·æ ¼è¾¾åˆ°æ­¢ç›ˆä»·æ—¶å°†è‡ªåŠ¨å¹³ä»“
                            </small>
                        </div>
                        <div style="margin-top: var(--spacing-xl);">
                            <button type="button" class="btn btn-primary" style="width: 100%;" onclick="openPosition()">
                                <i class="bi bi-play-circle"></i> å¼€ä»“
                            </button>
                        </div>
                    </form>
                    <div id="trade-result" style="margin-top: 16px;"></div>
                </div>
            </div>

            <!-- Right Column: Positions and Recent Trades -->
            <div class="positions-trades-wrapper">
                <!-- Open Positions -->
                <div class="card slide-up positions-card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <div style="display: flex; gap: var(--spacing-lg); align-items: center; flex: 1;">
                            <h2 class="card-title" id="tabPositionsTitle" onclick="showPositionsTab('positions')" style="cursor: pointer; margin: 0; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); transition: all var(--transition-base); opacity: 1;">
                                <i class="bi bi-briefcase"></i>
                                <span id="positions-title">æŒä»“ä¸­</span>
                            </h2>
                            <h2 class="card-title" id="tabOrdersTitle" onclick="showPositionsTab('orders')" style="cursor: pointer; margin: 0; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-md); transition: all var(--transition-base); opacity: 0.6;">
                                <i class="bi bi-hourglass-split"></i>
                                <span id="orders-title">æœªæˆäº¤è®¢å•</span>
                            </h2>
                        </div>
                        <div class="d-flex align-center gap-md">
                            <span class="badge badge-info" id="positionCount" style="display: none;">0 ä¸ªæŒä»“</span>
                            <span class="badge badge-warning" id="orderCount" style="display: none;">0 ä¸ªè®¢å•</span>
                            <div class="last-update" id="positions-update">-</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- æŒä»“ä¸­æ ‡ç­¾é¡µ -->
                        <div id="positionsTab">
                            <div id="positionsLoading" class="loading-overlay" style="min-height: 200px;">
                                <div class="spinner"></div>
                            </div>
                            <div id="positionsTable" style="display: none;">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>äº¤æ˜“å¯¹</th>
                                                <th>æ–¹å‘</th>
                                                <th>æ æ†</th>
                                                <th>å¼€ä»“ä»·</th>
                                                <th>å½“å‰ä»·</th>
                                                <th>æ•°é‡</th>
                                                <th>ä¿è¯é‡‘</th>
                                                <th>æœªå®ç°ç›ˆäº</th>
                                                <th>ROI</th>
                                                <th>æ­¢æŸä»·</th>
                                                <th>æ­¢ç›ˆä»·</th>
                                                <th>å¼€ä»“æ—¶é—´</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="positionsBody">
                                            <!-- åŠ¨æ€åŠ è½½ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="positionsEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <div class="empty-state-text">æš‚æ— æŒä»“</div>
                                <p class="text-sm text-secondary" style="margin-top: 8px;">ç³»ç»Ÿä¼šæ¯30åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æŠ•èµ„å»ºè®®å¹¶å¼€ä»“</p>
                            </div>
                        </div>
                        
                        <!-- æœªæˆäº¤è®¢å•æ ‡ç­¾é¡µ -->
                        <div id="ordersTab" style="display: none;">
                            <div id="ordersLoading" class="loading-overlay" style="min-height: 200px;">
                                <div class="spinner"></div>
                            </div>
                            <div id="ordersTable" style="display: none;">
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>äº¤æ˜“å¯¹</th>
                                                <th>æ–¹å‘</th>
                                                <th>è®¢å•ç±»å‹</th>
                                                <th>æ æ†</th>
                                                <th>å§”æ‰˜ä»·æ ¼</th>
                                                <th>æ•°é‡</th>
                                                <th>å·²æˆäº¤</th>
                                                <th>ä¿è¯é‡‘</th>
                                                <th>æ­¢æŸä»·</th>
                                                <th>æ­¢ç›ˆä»·</th>
                                                <th>çŠ¶æ€</th>
                                                <th>åˆ›å»ºæ—¶é—´</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ordersBody">
                                            <!-- åŠ¨æ€åŠ è½½ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="ordersEmpty" class="empty-state" style="display: none;">
                                <div class="empty-state-icon">â³</div>
                                <div class="empty-state-text">æš‚æ— æœªæˆäº¤è®¢å•</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Trades -->
                <div class="card slide-up trades-card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="bi bi-clock-history"></i>
                            <span id="trades-title">æœ€è¿‘äº¤æ˜“è®°å½•</span>
                        </h2>
                        <div class="last-update" id="trades-update">-</div>
                    </div>
                    <div class="card-body">
                        <div id="tradesLoading" class="loading-overlay" style="min-height: 200px;">
                            <div class="spinner"></div>
                        </div>
                        <div id="tradesTable" style="display: none;">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>äº¤æ˜“å¯¹</th>
                                            <th>æ–¹å‘</th>
                                            <th>æ æ†</th>
                                            <th>ä»·æ ¼</th>
                                            <th>æ•°é‡</th>
                                            <th>å·²å®ç°ç›ˆäº</th>
                                            <th>ROI</th>
                                            <th>æ‰‹ç»­è´¹</th>
                                            <th>æ—¶é—´</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tradesBody">
                                        <!-- åŠ¨æ€åŠ è½½ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="tradesEmpty" class="empty-state" style="display: none;">
                            <div class="empty-state-icon">ğŸ“œ</div>
                            <div class="empty-state-text">æš‚æ— äº¤æ˜“è®°å½•</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        const API_BASE = '/api/futures';
        let currentSymbol = 'BTC/USDT';
        let currentPrice = 0;
        let symbols = [];

        // åŠ è½½äº¤æ˜“å¯¹åˆ—è¡¨
        async function loadSymbols() {
            try {
                // ä»APIè·å–äº¤æ˜“å¯¹åˆ—è¡¨ï¼ˆä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
                const response = await fetch('/api/futures/symbols');
                const data = await response.json();
                
                if (data.success && data.symbols && data.symbols.length > 0) {
                    symbols = data.symbols;
                    
                    const symbolSelect = document.getElementById('symbol');
                    symbolSelect.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
                    
                    // è®¾ç½®é»˜è®¤äº¤æ˜“å¯¹
                    currentSymbol = symbols[0];
                    symbolSelect.value = currentSymbol;
                    await refreshPrice();
                } else {
                    console.warn('æœªè·å–åˆ°äº¤æ˜“å¯¹åˆ—è¡¨ï¼Œä½¿ç”¨é»˜è®¤å€¼');
                    symbols = ['BTC/USDT', 'ETH/USDT'];
                    const symbolSelect = document.getElementById('symbol');
                    symbolSelect.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
                    currentSymbol = symbols[0];
                    symbolSelect.value = currentSymbol;
                    await refreshPrice();
                }
            } catch (error) {
                console.error('åŠ è½½äº¤æ˜“å¯¹å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å€¼
                symbols = ['BTC/USDT', 'ETH/USDT'];
                const symbolSelect = document.getElementById('symbol');
                symbolSelect.innerHTML = symbols.map(s => `<option value="${s}">${s}</option>`).join('');
                currentSymbol = symbols[0];
                symbolSelect.value = currentSymbol;
                showToast('åŠ è½½äº¤æ˜“å¯¹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼', 'warning');
            }
        }

        // é€‰æ‹©äº¤æ˜“å¯¹
        document.getElementById('symbol').addEventListener('change', async function(e) {
            currentSymbol = e.target.value;
            // åˆ‡æ¢äº¤æ˜“å¯¹æ—¶ç«‹å³åˆ·æ–°ä»·æ ¼
            const priceDisplay = document.getElementById('current-price-display');
            priceDisplay.textContent = 'åŠ è½½ä¸­...';
            await refreshPrice();
        });

        // é€‰æ‹©æ–¹å‘
        function selectPositionSide(side) {
            document.getElementById('position-side').value = side;
            const longBtn = document.getElementById('long-btn');
            const shortBtn = document.getElementById('short-btn');
            
            if (side === 'LONG') {
                longBtn.classList.remove('btn-secondary');
                longBtn.classList.add('btn-success');
                shortBtn.classList.remove('btn-danger');
                shortBtn.classList.add('btn-secondary');
            } else {
                longBtn.classList.remove('btn-success');
                longBtn.classList.add('btn-secondary');
                shortBtn.classList.remove('btn-secondary');
                shortBtn.classList.add('btn-danger');
            }
        }

        // åˆ·æ–°ä»·æ ¼
        async function refreshPrice() {
            const symbol = document.getElementById('symbol').value;
            if (!symbol) {
                document.getElementById('current-price-display').textContent = '--';
                currentPrice = 0;
                updateEstimatedMargin();
                return;
            }

            const priceDisplay = document.getElementById('current-price-display');
            
            try {
                let price = null;
                
                // ä½¿ç”¨åç«¯APIè·å–åˆçº¦ä»·æ ¼ï¼ˆé¿å…CORSé—®é¢˜ï¼‰
                try {
                    const response = await fetch(`/api/futures/price/${encodeURIComponent(symbol)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.price) {
                            price = parseFloat(data.price);
                            console.log(`âœ… ä»åç«¯APIè·å– ${symbol} åˆçº¦ä»·æ ¼ (${data.source}): ${price}`);
                        }
                    }
                } catch (e) {
                    console.warn('ä»åç«¯åˆçº¦APIè·å–å¤±è´¥ï¼Œå°è¯•ç°è´§ä»·æ ¼API:', e);
                }
                
                // å¦‚æœåˆçº¦ä»·æ ¼è·å–å¤±è´¥ï¼Œå›é€€åˆ°ç°è´§ä»·æ ¼API
                if (!price || price === 0) {
                    try {
                        const response = await fetch(`/api/prices?symbol=${encodeURIComponent(symbol)}`);
                        const data = await response.json();
                        
                        if (data.success && data.prices && data.prices[symbol]) {
                            price = parseFloat(data.prices[symbol]);
                            console.log(`âœ… ä»æœ¬åœ°APIè·å– ${symbol} ä»·æ ¼ï¼ˆç°è´§ï¼‰: ${price}`);
                        }
                    } catch (e) {
                        console.warn('ä»æœ¬åœ°ä»·æ ¼APIè·å–å¤±è´¥:', e);
                    }
                }
                
                if (price && price > 0) {
                    currentPrice = price;
                    priceDisplay.textContent = formatPrice(currentPrice);
                    priceDisplay.style.color = 'var(--primary-blue)'; // æ¢å¤æˆåŠŸé¢œè‰²
                    updateEstimatedMargin();
                } else {
                    priceDisplay.textContent = 'è·å–å¤±è´¥';
                    priceDisplay.style.color = 'var(--danger-red)';
                    currentPrice = 0;
                    showToast(`æ— æ³•è·å– ${symbol} çš„åˆçº¦ä»·æ ¼ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•`, 'error');
                }
            } catch (error) {
                console.error('è·å–ä»·æ ¼å¤±è´¥:', error);
                priceDisplay.textContent = 'è·å–å¤±è´¥';
                priceDisplay.style.color = 'var(--danger-red)';
                currentPrice = 0;
                showToast('è·å–ä»·æ ¼å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é¢„è®¡ä¿è¯é‡‘
        function updateEstimatedMargin() {
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const leverage = parseInt(document.getElementById('leverage').value) || 1;
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä»·æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰å®æ—¶ä»·æ ¼
            const userPrice = parseFloat(document.getElementById('current-price').value) || currentPrice;
            
            if (userPrice > 0 && quantity > 0) {
                const margin = (userPrice * quantity) / leverage;
                document.getElementById('estimated-margin').textContent = margin.toFixed(2);
            } else {
                document.getElementById('estimated-margin').textContent = '0.00';
            }
        }

        // ç›‘å¬æ•°é‡ã€æ æ†å’Œä»·æ ¼è¾“å…¥å˜åŒ–
        document.getElementById('quantity').addEventListener('input', updateEstimatedMargin);
        document.getElementById('leverage').addEventListener('change', updateEstimatedMargin);
        document.getElementById('current-price').addEventListener('input', updateEstimatedMargin);

        // å¼€ä»“
        async function openPosition() {
            const symbol = document.getElementById('symbol').value;
            const positionSide = document.getElementById('position-side').value;
            const quantity = parseFloat(document.getElementById('quantity').value);
            const leverage = parseInt(document.getElementById('leverage').value);
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ä»·æ ¼ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰å®æ—¶ä»·æ ¼
            const userPrice = parseFloat(document.getElementById('current-price').value);
            const entryPrice = userPrice && userPrice > 0 ? userPrice : currentPrice;
            const stopLossPrice = document.getElementById('stop-loss-price').value ? parseFloat(document.getElementById('stop-loss-price').value) : null;
            const takeProfitPrice = document.getElementById('take-profit-price').value ? parseFloat(document.getElementById('take-profit-price').value) : null;

            // éªŒè¯
            if (!symbol) {
                showToast('è¯·é€‰æ‹©äº¤æ˜“å¯¹', 'error');
                return;
            }
            if (!quantity || quantity <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡', 'error');
                return;
            }
            if (!entryPrice || entryPrice <= 0) {
                showToast('è¯·å…ˆè·å–å½“å‰ä»·æ ¼æˆ–è¾“å…¥é™ä»·', 'error');
                return;
            }

            const estimatedMargin = ((entryPrice * quantity) / leverage).toFixed(2);
            const priceType = userPrice && userPrice > 0 ? 'é™ä»·' : 'å¸‚ä»·';
            
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const openConfirmMsg = `
                <div style="margin-bottom: 12px;">
                    <strong>äº¤æ˜“å¯¹:</strong> ${symbol}<br>
                    <strong>æ–¹å‘:</strong> ${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}<br>
                    <strong>æ•°é‡:</strong> ${quantity}<br>
                    <strong>è®¢å•ç±»å‹:</strong> ${priceType}<br>
                    ${priceType === 'é™ä»·' ? `<strong>é™ä»·:</strong> ${formatPrice(entryPrice)}<br>` : ''}
                    <strong>æ æ†:</strong> ${leverage}x<br>
                    <strong>é¢„è®¡ä¿è¯é‡‘:</strong> ${estimatedMargin} USDT
                </div>
            `;
            const confirmed = await showConfirmDialog(
                `ç¡®å®šè¦${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}å—ï¼Ÿ`,
                openConfirmMsg,
                'info'
            );
            if (!confirmed) return;

            try {
                // å¦‚æœç”¨æˆ·è¾“å…¥äº†ä»·æ ¼ï¼Œåˆ™ä¼ é€’é™ä»·å‚æ•°
                const limitPrice = userPrice && userPrice > 0 ? userPrice : null;
                
                const response = await fetch(`${API_BASE}/open`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        account_id: 2,
                        symbol: symbol,
                        position_side: positionSide,
                        quantity: quantity,
                        leverage: leverage,
                        limit_price: limitPrice,
                        stop_loss_price: stopLossPrice,
                        take_profit_price: takeProfitPrice,
                        source: 'manual'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é™ä»·å•ï¼ˆä»dataæˆ–data.dataä¸­è·å–ï¼‰
                    const orderType = data.order_type || data.data?.order_type;
                    const orderStatus = data.status || data.data?.status;
                    
                    if (orderType === 'LIMIT' && orderStatus === 'PENDING') {
                        // é™ä»·å•æœªæˆäº¤
                        const limitPrice = data.limit_price || data.data?.limit_price;
                        const currentPrice = data.current_price || data.data?.current_price;
                        const limitMsg = `é™ä»·å•å·²åˆ›å»º\n` +
                            `äº¤æ˜“å¯¹: ${symbol}\n` +
                            `æ–¹å‘: ${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}\n` +
                            `æ•°é‡: ${quantity}\n` +
                            `é™ä»·: ${formatPrice(limitPrice)}\n` +
                            `å½“å‰ä»·: ${formatPrice(currentPrice)}\n` +
                            `æ æ†: ${leverage}x\n` +
                            `çŠ¶æ€: æœªæˆäº¤ï¼Œç­‰å¾…ä»·æ ¼è¾¾åˆ°é™ä»·`;
                        showToast(limitMsg, 'info');
                    } else {
                        // å¸‚ä»·å•ç«‹å³æˆäº¤
                        const entryPrice = data.entry_price || data.data?.entry_price;
                        const margin = data.margin || data.data?.margin;
                        const successMsg = `å¼€ä»“æˆåŠŸï¼å·²æˆäº¤\n` +
                            `äº¤æ˜“å¯¹: ${symbol}\n` +
                            `æ–¹å‘: ${positionSide === 'LONG' ? 'åšå¤š' : 'åšç©º'}\n` +
                            `æ•°é‡: ${quantity}\n` +
                            `å¼€ä»“ä»·: ${formatPrice(entryPrice)}\n` +
                            `æ æ†: ${leverage}x\n` +
                            `ä¿è¯é‡‘: ${formatLargeNumber(margin || 0)} USDT\n` +
                            `çŠ¶æ€: å·²æˆäº¤`;
                        showToast(successMsg, 'success');
                    }
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('quantity').value = '';
                    document.getElementById('current-price').value = '';
                    document.getElementById('stop-loss-price').value = '';
                    document.getElementById('take-profit-price').value = '';
                    updateEstimatedMargin();
                    // åˆ·æ–°æ•°æ®
                    await loadData();
                } else {
                    showToast('å¼€ä»“å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('å¼€ä»“å¤±è´¥:', error);
                showToast('å¼€ä»“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, type = 'warning') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const iconConfig = {
                    'warning': { icon: 'exclamation-triangle-fill', color: 'var(--warning-yellow)' },
                    'danger': { icon: 'x-circle-fill', color: 'var(--danger-red)' },
                    'info': { icon: 'info-circle-fill', color: 'var(--info-blue)' }
                };
                const config = iconConfig[type] || iconConfig['warning'];
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-title">
                                <div class="modal-icon" style="background: linear-gradient(135deg, ${type === 'warning' ? 'rgba(245, 158, 11, 0.2)' : type === 'danger' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(59, 130, 246, 0.2)'} 0%, ${type === 'warning' ? 'rgba(245, 158, 11, 0.1)' : type === 'danger' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)'} 100%); border-color: ${type === 'warning' ? 'rgba(245, 158, 11, 0.3)' : type === 'danger' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)'};">
                                    <i class="bi bi-${config.icon}" style="font-size: 24px; color: ${config.color};"></i>
                                </div>
                                <span>${title}</span>
                            </div>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel-btn" style="min-width: 100px;">
                                <i class="bi bi-x-circle"></i> å–æ¶ˆ
                            </button>
                            <button class="btn btn-danger" id="modal-confirm-btn" style="min-width: 100px;">
                                <i class="bi bi-check-circle"></i> ç¡®å®š
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const cancelBtn = overlay.querySelector('#modal-cancel-btn');
                const confirmBtn = overlay.querySelector('#modal-confirm-btn');
                const dialog = overlay.querySelector('.modal-dialog');
                
                const closeModal = (result) => {
                    dialog.style.animation = 'slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                    overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                    setTimeout(() => {
                        overlay.remove();
                        resolve(result);
                    }, 300);
                };
                
                cancelBtn.addEventListener('click', () => closeModal(false));
                confirmBtn.addEventListener('click', () => closeModal(true));
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(false);
                    }
                });
                
                // ESCé”®å…³é—­
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            });
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œï¼Œå¹¶è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            const escapedMessage = message
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n/g, '<br>');
            
            // æ ¹æ®ç±»å‹é€‰æ‹©å›¾æ ‡å’Œé¢œè‰²
            const iconMap = {
                'success': { icon: 'check-circle-fill', color: 'var(--success-green)', bg: 'rgba(16, 185, 129, 0.15)' },
                'error': { icon: 'x-circle-fill', color: 'var(--danger-red)', bg: 'rgba(239, 68, 68, 0.15)' },
                'info': { icon: 'info-circle-fill', color: 'var(--info-blue)', bg: 'rgba(59, 130, 246, 0.15)' }
            };
            const iconConfig = iconMap[type] || iconMap['info'];
            
            // è§£ææ¶ˆæ¯ï¼Œæå–æ ‡é¢˜å’Œå†…å®¹
            const lines = message.split('\n');
            const title = lines[0];
            const content = lines.slice(1).join('<br>');
            
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        border-radius: 50%; 
                        background: ${iconConfig.bg}; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        flex-shrink: 0;
                        animation: pulse 0.6s ease-out;
                    ">
                        <i class="bi bi-${iconConfig.icon}" style="font-size: 22px; color: ${iconConfig.color};"></i>
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="
                            font-weight: 600; 
                            font-size: 15px; 
                            color: var(--text-primary); 
                            margin-bottom: ${content ? '6px' : '0'};
                            line-height: 1.4;
                        ">${title}</div>
                        ${content ? `<div style="
                            font-size: 13px; 
                            color: var(--text-secondary); 
                            line-height: 1.6; 
                            white-space: normal;
                            margin-top: 4px;
                        ">${content}</div>` : ''}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: rgba(139, 148, 158, 0.1); 
                        border: none; 
                        color: var(--text-secondary); 
                        cursor: pointer; 
                        padding: 4px; 
                        width: 24px; 
                        height: 24px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center; 
                        flex-shrink: 0;
                        border-radius: 4px;
                        transition: all var(--transition-fast);
                    " onmouseover="this.style.background='rgba(139, 148, 158, 0.2)'; this.style.color='var(--text-primary)'" onmouseout="this.style.background='rgba(139, 148, 158, 0.1)'; this.style.color='var(--text-secondary)'">
                        <i class="bi bi-x" style="font-size: 14px;"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // æ ¹æ®æ¶ˆæ¯é•¿åº¦è°ƒæ•´æ˜¾ç¤ºæ—¶é—´ï¼ˆå¤šè¡Œæ¶ˆæ¯æ˜¾ç¤ºæ›´é•¿æ—¶é—´ï¼‰
            const displayTime = message.split('\n').length > 3 ? 7000 : 5000;
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 400);
            }, displayTime);
        }

        // æ ¼å¼åŒ–ä»·æ ¼
        function formatPrice(price) {
            if (!price && price !== 0) return '-';
            const num = parseFloat(price);
            if (num >= 1000) return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (num >= 1) return num.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
            return num.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
        }

        // æ ¼å¼åŒ–å¤§é¢æ•°å­—
        function formatLargeNumber(num) {
            if (!num && num !== 0) return '-';
            const absNum = Math.abs(num);
            if (absNum >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (absNum >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (absNum >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toFixed(2)}`;
        }

        // åˆ‡æ¢æŒä»“é¢æ¿æ ‡ç­¾é¡µ
        function showPositionsTab(tab) {
            const positionsTab = document.getElementById('positionsTab');
            const ordersTab = document.getElementById('ordersTab');
            const positionsTitle = document.getElementById('tabPositionsTitle');
            const ordersTitle = document.getElementById('tabOrdersTitle');
            
            if (tab === 'positions') {
                positionsTab.style.display = 'block';
                ordersTab.style.display = 'none';
                positionsTitle.style.opacity = '1';
                ordersTitle.style.opacity = '0.6';
                document.getElementById('positionCount').style.display = 'inline-flex';
                document.getElementById('orderCount').style.display = 'none';
            } else {
                positionsTab.style.display = 'none';
                ordersTab.style.display = 'block';
                positionsTitle.style.opacity = '0.6';
                ordersTitle.style.opacity = '1';
                document.getElementById('positionCount').style.display = 'none';
                document.getElementById('orderCount').style.display = 'inline-flex';
                loadOrders();
            }
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadData() {
            await Promise.all([
                loadAccount(),
                loadPositions(),
                loadTrades()
            ]);
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è®¢å•æ ‡ç­¾é¡µï¼Œä¹ŸåŠ è½½è®¢å•
            const ordersTab = document.getElementById('ordersTab');
            if (ordersTab && ordersTab.style.display !== 'none') {
                await loadOrders();
            }
            updateLastUpdateTime();
        }

        // åŠ è½½è´¦æˆ·ä¿¡æ¯
        async function loadAccount() {
            try {
                const response = await fetch(`${API_BASE}/account/2`);
                const data = await response.json();

                if (data.success) {
                    const account = data.data;
                    const accountStats = document.getElementById('accountStats');
                    const accountTitle = document.getElementById('account-title');

                    accountStats.innerHTML = `
                        <div class="stat-card">
                            <div class="stat-label">è´¦æˆ·ä½™é¢</div>
                            <div class="stat-value">${formatLargeNumber(account.current_balance)}</div>
                            <div class="stat-change">å¯ç”¨: ${formatLargeNumber(account.available_balance)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å†»ç»“ä¿è¯é‡‘</div>
                            <div class="stat-value">${formatLargeNumber(account.frozen_balance)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æœªå®ç°ç›ˆäº</div>
                            <div class="stat-value ${account.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${account.unrealized_pnl >= 0 ? '+' : ''}${formatLargeNumber(account.unrealized_pnl)}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">æ€»æƒç›Š</div>
                            <div class="stat-value">${formatLargeNumber(account.total_equity)}</div>
                            <div class="stat-change ${account.total_profit_loss_pct >= 0 ? 'positive' : 'negative'}">
                                æ”¶ç›Šç‡: ${account.total_profit_loss_pct >= 0 ? '+' : ''}${account.total_profit_loss_pct.toFixed(2)}%
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å·²å®ç°ç›ˆäº</div>
                            <div class="stat-value ${account.realized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${account.realized_pnl >= 0 ? '+' : ''}${formatLargeNumber(account.realized_pnl)}
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">äº¤æ˜“ç»Ÿè®¡</div>
                            <div class="stat-value">${account.total_trades || 0}</div>
                            <div class="stat-change">èƒœç‡: ${(account.win_rate || 0).toFixed(1)}%</div>
                        </div>
                    `;

                    // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæ•°é‡
                    accountTitle.textContent = `è´¦æˆ·æ€»è§ˆ [6]`;

                    document.getElementById('accountLoading').style.display = 'none';
                    accountStats.style.display = 'grid';
                    document.getElementById('account-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    throw new Error(data.message || 'åŠ è½½è´¦æˆ·å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½è´¦æˆ·å¤±è´¥:', error);
                document.getElementById('accountLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½è´¦æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æŒä»“
        async function loadPositions() {
            try {
                const response = await fetch(`${API_BASE}/positions?account_id=2&status=open`);
                const data = await response.json();

                const positionsBody = document.getElementById('positionsBody');
                const positionsTable = document.getElementById('positionsTable');
                const positionsEmpty = document.getElementById('positionsEmpty');
                const positionCount = document.getElementById('positionCount');
                const positionsLoading = document.getElementById('positionsLoading');
                const positionsTitle = document.getElementById('positions-title');

                positionsLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    positionsBody.innerHTML = data.data.map(pos => `
                        <tr>
                            <td><strong>${pos.symbol}</strong></td>
                            <td><span class="badge ${pos.position_side === 'LONG' ? 'badge-success' : 'badge-danger'}">${pos.position_side === 'LONG' ? 'å¤š' : 'ç©º'}</span></td>
                            <td><span class="badge badge-info">${pos.leverage || 1}x</span></td>
                            <td class="font-mono">$${formatPrice(pos.entry_price)}</td>
                            <td class="font-mono">$${pos.current_price ? formatPrice(pos.current_price) : '--'}</td>
                            <td>${pos.quantity || '--'}</td>
                            <td>${formatLargeNumber(pos.margin || 0)}</td>
                            <td class="pnl ${pos.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${pos.unrealized_pnl >= 0 ? '+' : ''}${formatLargeNumber(pos.unrealized_pnl || 0)}
                            </td>
                            <td class="pnl ${pos.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${pos.unrealized_pnl_pct >= 0 ? '+' : ''}${(pos.unrealized_pnl_pct || 0).toFixed(2)}%
                            </td>
                            <td class="font-mono text-sm">
                                ${pos.stop_loss_price ? '$' + formatPrice(pos.stop_loss_price) : '--'}
                            </td>
                            <td class="font-mono text-sm">
                                ${pos.take_profit_price ? '$' + formatPrice(pos.take_profit_price) : '--'}
                            </td>
                            <td class="text-sm text-secondary">${pos.open_time ? new Date(pos.open_time).toLocaleString('zh-CN') : '--'}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="closePosition(${pos.position_id || pos.id})">
                                    <i class="bi bi-x-circle"></i> å¹³ä»“
                                </button>
                            </td>
                        </tr>
                    `).join('');

                    const count = data.data.length;
                    positionCount.textContent = `${count} ä¸ªæŒä»“`;
                    positionsTitle.textContent = `æŒä»“ä¸­ [${count}]`;
                    positionsTable.style.display = 'block';
                    positionsEmpty.style.display = 'none';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    positionCount.textContent = '0 ä¸ªæŒä»“';
                    positionsTitle.textContent = 'æŒä»“ä¸­ [0]';
                    positionsTable.style.display = 'none';
                    positionsEmpty.style.display = 'block';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                console.error('åŠ è½½æŒä»“å¤±è´¥:', error);
                document.getElementById('positionsLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½æŒä»“å¤±è´¥', 'error');
            }
        }

        // åŠ è½½æœªæˆäº¤è®¢å•
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}/orders?account_id=2&status=PENDING`);
                const data = await response.json();

                const ordersBody = document.getElementById('ordersBody');
                const ordersTable = document.getElementById('ordersTable');
                const ordersEmpty = document.getElementById('ordersEmpty');
                const ordersLoading = document.getElementById('ordersLoading');
                const orderCount = document.getElementById('orderCount');
                const ordersTitle = document.getElementById('orders-title');

                ordersLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    // åŒæ—¶è·å–éƒ¨åˆ†æˆäº¤çš„è®¢å•
                    try {
                        const partialResponse = await fetch(`${API_BASE}/orders?account_id=2&status=PARTIALLY_FILLED`);
                        const partialData = await partialResponse.json();
                        const allOrders = [...data.data, ...(partialData.success && partialData.data ? partialData.data : [])];

                        ordersBody.innerHTML = allOrders.map(order => {
                            // åªæ˜¾ç¤º"å¤š"æˆ–"ç©º"
                            const sideText = order.side.includes('LONG') ? 'å¤š' : 
                                            order.side.includes('SHORT') ? 'ç©º' : 
                                            order.side === 'BUY' ? 'å¤š' : 'ç©º';
                            const sideClass = order.side.includes('LONG') || order.side === 'BUY' ? 'badge-success' : 'badge-danger';
                            const orderTypeText = order.order_type === 'MARKET' ? 'å¸‚ä»·' : 
                                                order.order_type === 'LIMIT' ? 'é™ä»·' :
                                                order.order_type === 'STOP_MARKET' ? 'æ­¢æŸå¸‚ä»·' :
                                                order.order_type === 'TAKE_PROFIT_MARKET' ? 'æ­¢ç›ˆå¸‚ä»·' : order.order_type;
                            const statusText = order.status === 'PENDING' ? 'å¾…æˆäº¤' :
                                             order.status === 'PARTIALLY_FILLED' ? 'éƒ¨åˆ†æˆäº¤' : order.status;
                            const statusClass = order.status === 'PENDING' ? 'badge-warning' :
                                              order.status === 'PARTIALLY_FILLED' ? 'badge-info' : 'badge-neutral';
                            const fillProgress = order.quantity > 0 ? ((order.executed_quantity || 0) / order.quantity * 100).toFixed(1) : 0;

                            return `
                                <tr>
                                    <td><strong>${order.symbol}</strong></td>
                                    <td><span class="badge ${sideClass}">${sideText}</span></td>
                                    <td><span class="badge badge-neutral">${orderTypeText}</span></td>
                                    <td><span class="badge badge-info">${order.leverage || 1}x</span></td>
                                    <td class="font-mono">${order.price ? '$' + formatPrice(order.price) : 'å¸‚ä»·'}</td>
                                    <td>${order.quantity || '--'}</td>
                                    <td class="text-sm">
                                        ${order.executed_quantity || 0} / ${order.quantity || 0}
                                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">
                                            ${fillProgress}%
                                        </div>
                                    </td>
                                    <td>${formatLargeNumber(order.margin || 0)}</td>
                                    <td class="font-mono text-sm">
                                        ${order.stop_loss_price ? '<span style="color: var(--danger-red);">$' + formatPrice(order.stop_loss_price) + '</span>' : '--'}
                                    </td>
                                    <td class="font-mono text-sm">
                                        ${order.take_profit_price ? '<span style="color: var(--success-green);">$' + formatPrice(order.take_profit_price) + '</span>' : '--'}
                                    </td>
                                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                                    <td class="text-sm text-secondary">${order.created_at ? new Date(order.created_at).toLocaleString('zh-CN') : '--'}</td>
                                    <td>
                                        ${order.status === 'PENDING' || order.status === 'PARTIALLY_FILLED' ? `
                                            <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.order_id}')">
                                                <i class="bi bi-x-circle"></i> æ’¤å•
                                            </button>
                                        ` : '--'}
                                    </td>
                                </tr>
                            `;
                        }).join('');

                        const count = allOrders.length;
                        orderCount.textContent = `${count} ä¸ªè®¢å•`;
                        ordersTitle.textContent = `æœªæˆäº¤è®¢å• [${count}]`;
                        orderCount.style.display = 'inline-flex';
                        ordersTable.style.display = 'block';
                        ordersEmpty.style.display = 'none';
                    } catch (e) {
                        // å¦‚æœè·å–éƒ¨åˆ†æˆäº¤è®¢å•å¤±è´¥ï¼Œåªæ˜¾ç¤ºå¾…æˆäº¤è®¢å•
                        const count = data.data.length;
                        orderCount.textContent = `${count} ä¸ªè®¢å•`;
                        ordersTitle.textContent = `æœªæˆäº¤è®¢å• [${count}]`;
                        orderCount.style.display = 'inline-flex';
                        ordersTable.style.display = 'block';
                        ordersEmpty.style.display = 'none';
                    }
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    orderCount.textContent = '0 ä¸ªè®¢å•';
                    ordersTitle.textContent = 'æœªæˆäº¤è®¢å• [0]';
                    orderCount.style.display = 'inline-flex';
                    ordersTable.style.display = 'none';
                    ordersEmpty.style.display = 'block';
                    document.getElementById('positions-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                console.error('åŠ è½½æœªæˆäº¤è®¢å•å¤±è´¥:', error);
                document.getElementById('ordersLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½æœªæˆäº¤è®¢å•å¤±è´¥', 'error');
            }
        }

        // æ’¤é”€è®¢å•
        async function cancelOrder(orderId) {
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = await showConfirmDialog(
                'ç¡®å®šè¦æ’¤é”€è¿™ä¸ªè®¢å•å—ï¼Ÿ',
                'æ’¤é”€åï¼Œå†»ç»“çš„ä¿è¯é‡‘å°†è¢«é‡Šæ”¾å›å¯ç”¨ä½™é¢ã€‚',
                'warning'
            );
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/orders/${encodeURIComponent(orderId)}?account_id=2`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('è®¢å•å·²æ’¤é”€', 'success');
                    await loadData(); // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
                } else {
                    showToast('æ’¤é”€è®¢å•å¤±è´¥: ' + (data.message || data.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('æ’¤é”€è®¢å•å¤±è´¥:', error);
                showToast('æ’¤é”€è®¢å•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½äº¤æ˜“è®°å½•ï¼ˆä»futures_tradesè¡¨è·å–ï¼‰
        async function loadTrades() {
            try {
                const response = await fetch(`${API_BASE}/trades?account_id=2&limit=50`);
                const data = await response.json();

                const tradesBody = document.getElementById('tradesBody');
                const tradesTable = document.getElementById('tradesTable');
                const tradesEmpty = document.getElementById('tradesEmpty');
                const tradesLoading = document.getElementById('tradesLoading');
                const tradesTitle = document.getElementById('trades-title');

                tradesLoading.style.display = 'none';

                if (data.success && data.data && data.data.length > 0) {
                    // åªæ˜¾ç¤ºå¹³ä»“äº¤æ˜“ï¼ˆCLOSE_LONG æˆ– CLOSE_SHORTï¼‰ï¼Œå¹¶æŒ‰æ—¶é—´å€’åºæ’åˆ—
                    const closeTrades = data.data
                        .filter(t => t.side && (t.side.includes('CLOSE')))
                        .sort((a, b) => {
                            // æŒ‰äº¤æ˜“æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                            const timeA = new Date(a.trade_time).getTime();
                            const timeB = new Date(b.trade_time).getTime();
                            return timeB - timeA;
                        });
                    const recentTrades = closeTrades.slice(0, 20);

                    tradesBody.innerHTML = recentTrades.map(trade => {
                        const isLong = trade.side === 'CLOSE_LONG';
                        const sideText = isLong ? 'å¤š' : 'ç©º';
                        const sideBadge = isLong ? 'badge-success' : 'badge-danger';
                        
                        return `
                        <tr>
                            <td><strong>${trade.symbol}</strong></td>
                            <td><span class="badge ${sideBadge}">${sideText}</span></td>
                            <td><span class="badge badge-info">${trade.leverage || 1}x</span></td>
                            <td class="text-sm">
                                <div>å¼€: <span class="font-mono">$${trade.entry_price ? formatPrice(trade.entry_price) : '--'}</span></div>
                                <div class="text-secondary">å¹³: <span class="font-mono">$${formatPrice(trade.price)}</span></div>
                            </td>
                            <td>${trade.quantity || '--'}</td>
                            <td class="pnl ${trade.realized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${trade.realized_pnl >= 0 ? '+' : ''}${formatLargeNumber(trade.realized_pnl || 0)}
                            </td>
                            <td class="pnl ${trade.pnl_pct >= 0 ? 'pnl-positive' : 'pnl-negative'}">
                                ${trade.pnl_pct >= 0 ? '+' : ''}${(trade.pnl_pct || 0).toFixed(2)}%
                            </td>
                            <td class="text-sm">${formatLargeNumber(trade.fee || 0)}</td>
                            <td class="text-sm text-secondary">${trade.trade_time ? new Date(trade.trade_time).toLocaleString('zh-CN') : '--'}</td>
                        </tr>
                    `;
                    }).join('');

                    const count = closeTrades.length;
                    tradesTitle.textContent = `æœ€è¿‘äº¤æ˜“è®°å½• [${count}]`;
                    tradesTable.style.display = 'block';
                    tradesEmpty.style.display = 'none';
                    document.getElementById('trades-update').textContent = new Date().toLocaleTimeString('zh-CN');
                } else {
                    tradesTitle.textContent = 'æœ€è¿‘äº¤æ˜“è®°å½• [0]';
                    tradesTable.style.display = 'none';
                    tradesEmpty.style.display = 'block';
                    document.getElementById('trades-update').textContent = new Date().toLocaleTimeString('zh-CN');
                }
            } catch (error) {
                console.error('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥:', error);
                document.getElementById('tradesLoading').innerHTML = `<div class="empty-state-text">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                showToast('åŠ è½½äº¤æ˜“è®°å½•å¤±è´¥', 'error');
            }
        }

        // å¹³ä»“
        async function closePosition(positionId) {
            // éªŒè¯positionId
            if (!positionId || positionId === 'undefined' || positionId === undefined) {
                console.error('å¹³ä»“å¤±è´¥: positionIdæ— æ•ˆ', positionId);
                showToast('å¹³ä»“å¤±è´¥: æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            // ç¡®ä¿positionIdæ˜¯æ•°å­—
            positionId = parseInt(positionId);
            if (isNaN(positionId) || positionId <= 0) {
                console.error('å¹³ä»“å¤±è´¥: positionIdä¸æ˜¯æœ‰æ•ˆçš„æ•°å­—', positionId);
                showToast('å¹³ä»“å¤±è´¥: æŒä»“IDæ— æ•ˆ', 'error');
                return;
            }
            
            // ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
            const confirmed = await showConfirmDialog(
                'ç¡®å®šè¦å¹³ä»“å—ï¼Ÿ',
                'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå¹³ä»“åå°†è®¡ç®—å·²å®ç°ç›ˆäºå¹¶é‡Šæ”¾ä¿è¯é‡‘ã€‚',
                'warning'
            );
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/close/${positionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        close_quantity: null,
                        reason: 'manual' 
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    // å¦‚æœå“åº”ä¸æ˜¯JSONï¼Œå°è¯•è·å–æ–‡æœ¬
                    const text = await response.text();
                    console.error('å¹³ä»“å“åº”ä¸æ˜¯JSON:', text);
                    showToast('å¹³ä»“å¤±è´¥: æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„å“åº”', 'error');
                    return;
                }

                if (!response.ok) {
                    // HTTPé”™è¯¯çŠ¶æ€ç 
                    const errorMsg = data.detail || data.message || `HTTP ${response.status}: ${response.statusText}`;
                    console.error('å¹³ä»“å¤±è´¥:', data);
                    showToast('å¹³ä»“å¤±è´¥: ' + errorMsg, 'error');
                    return;
                }

                if (data.success) {
                    // ç¾åŒ–å¹³ä»“æˆåŠŸæç¤º
                    const closeData = data.data || {};
                    const realizedPnl = closeData.realized_pnl || 0;
                    const pnlPct = closeData.pnl_pct || 0;
                    const roi = closeData.roi || 0;
                    const symbol = closeData.symbol || '';
                    const closePrice = closeData.close_price || 0;
                    const entryPrice = closeData.entry_price || 0;
                    const positionSide = closeData.position_side || '';
                    const closeQuantity = closeData.close_quantity || 0;
                    
                    const pnlColor = realizedPnl >= 0 ? 'var(--success-green)' : 'var(--danger-red)';
                    const pnlSign = realizedPnl >= 0 ? '+' : '';
                    
                    // åˆ›å»ºè‡ªå®šä¹‰çš„ç¾åŒ–å¹³ä»“æˆåŠŸæç¤ºæ¡†
                    const toast = document.createElement('div');
                    toast.className = 'toast success';
                    const isProfit = realizedPnl >= 0;
                    const profitIcon = isProfit ? 'bi-trending-up' : 'bi-trending-down';
                    
                    toast.innerHTML = `
                        <div style="
                            position: relative;
                            overflow: hidden;
                        ">
                            <!-- èƒŒæ™¯è£…é¥° -->
                            <div style="
                                position: absolute;
                                top: -50px;
                                right: -50px;
                                width: 150px;
                                height: 150px;
                                background: ${isProfit ? 'radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%)' : 'radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%)'};
                                border-radius: 50%;
                                pointer-events: none;
                            "></div>
                            
                            <div style="display: flex; align-items: flex-start; gap: var(--spacing-lg); position: relative; z-index: 1;">
                                <!-- å›¾æ ‡åŒºåŸŸ -->
                                <div style="
                                    width: 56px; 
                                    height: 56px; 
                                    border-radius: 16px; 
                                    background: ${isProfit ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%)' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%)'}; 
                                    border: 2px solid ${isProfit ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'};
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    flex-shrink: 0;
                                    animation: pulse 0.6s ease-out;
                                    box-shadow: 0 4px 12px ${isProfit ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                ">
                                    <i class="bi ${profitIcon}" style="font-size: 28px; color: ${pnlColor};"></i>
                                </div>
                                
                                <!-- å†…å®¹åŒºåŸŸ -->
                                <div style="flex: 1; min-width: 0;">
                                    <!-- æ ‡é¢˜ -->
                                    <div style="
                                        font-weight: 700; 
                                        font-size: 18px; 
                                        color: var(--text-primary); 
                                        margin-bottom: 12px;
                                        line-height: 1.3;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                        <span>å¹³ä»“æˆåŠŸ</span>
                                        <span style="
                                            font-size: 12px;
                                            padding: 2px 8px;
                                            border-radius: 12px;
                                            background: ${isProfit ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                                            color: ${pnlColor};
                                            font-weight: 600;
                                        ">${isProfit ? 'ç›ˆåˆ©' : 'äºæŸ'}</span>
                                    </div>
                                    
                                    <!-- è¯¦ç»†ä¿¡æ¯ -->
                                    <div style="
                                        background: rgba(139, 148, 158, 0.05);
                                        border-radius: 12px;
                                        padding: 12px;
                                        margin-bottom: 12px;
                                    ">
                                        <div style="
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 8px;
                                            font-size: 13px;
                                            color: var(--text-secondary);
                                        ">
                                            <div><span style="color: var(--text-tertiary);">äº¤æ˜“å¯¹:</span> <strong style="color: var(--text-primary);">${symbol}</strong></div>
                                            <div><span style="color: var(--text-tertiary);">æ–¹å‘:</span> <strong style="color: var(--text-primary);">${positionSide === 'LONG' ? 'å¤š' : 'ç©º'}</strong></div>
                                            <div><span style="color: var(--text-tertiary);">æ•°é‡:</span> <strong style="color: var(--text-primary);">${closeQuantity}</strong></div>
                                            <div><span style="color: var(--text-tertiary);">æ æ†:</span> <strong style="color: var(--text-primary);">${closeData.leverage || '--'}x</strong></div>
                                        </div>
                                        
                                        <div style="
                                            margin-top: 10px;
                                            padding-top: 10px;
                                            border-top: 1px solid var(--border-default);
                                            display: grid;
                                            grid-template-columns: 1fr 1fr;
                                            gap: 8px;
                                        ">
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 2px;">å¼€ä»“ä»·</div>
                                                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); font-family: var(--font-mono);">${formatPrice(entryPrice)}</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 2px;">å¹³ä»“ä»·</div>
                                                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); font-family: var(--font-mono);">${formatPrice(closePrice)}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- ç›ˆäºä¿¡æ¯å¡ç‰‡ -->
                                    <div style="
                                        background: ${isProfit ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%)' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%)'};
                                        border: 1px solid ${isProfit ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'};
                                        border-radius: 12px;
                                        padding: 14px;
                                        display: grid;
                                        grid-template-columns: repeat(3, 1fr);
                                        gap: 12px;
                                    ">
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">å·²å®ç°ç›ˆäº</div>
                                            <div style="font-size: 18px; font-weight: 700; color: ${pnlColor}; font-family: var(--font-mono);">
                                                ${pnlSign}${formatLargeNumber(realizedPnl)}
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">USDT</div>
                                        </div>
                                        <div style="text-align: center; border-left: 1px solid var(--border-default); border-right: 1px solid var(--border-default); padding: 0 12px;">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">æ”¶ç›Šç‡</div>
                                            <div style="font-size: 18px; font-weight: 700; color: ${pnlColor}; font-family: var(--font-mono);">
                                                ${pnlSign}${pnlPct.toFixed(2)}%
                                            </div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">ROI</div>
                                            <div style="font-size: 18px; font-weight: 700; color: ${pnlColor}; font-family: var(--font-mono);">
                                                ${pnlSign}${roi.toFixed(2)}%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å…³é—­æŒ‰é’® -->
                                <button onclick="this.parentElement.parentElement.remove()" style="
                                    background: rgba(139, 148, 158, 0.1); 
                                    border: none; 
                                    color: var(--text-secondary); 
                                    cursor: pointer; 
                                    padding: 6px; 
                                    width: 28px; 
                                    height: 28px; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center; 
                                    flex-shrink: 0;
                                    border-radius: 6px;
                                    transition: all var(--transition-fast);
                                    position: absolute;
                                    top: 0;
                                    right: 0;
                                " onmouseover="this.style.background='rgba(139, 148, 158, 0.2)'; this.style.color='var(--text-primary)'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='rgba(139, 148, 158, 0.1)'; this.style.color='var(--text-secondary)'; this.style.transform='scale(1)'">
                                    <i class="bi bi-x" style="font-size: 16px;"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.style.animation = 'slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                        toast.style.opacity = '0';
                        setTimeout(() => toast.remove(), 400);
                    }, 8000);
                    
                    await loadData();
                } else {
                    const errorMsg = data.message || data.detail || data.error || 'æœªçŸ¥é”™è¯¯';
                    console.error('å¹³ä»“å¤±è´¥:', data);
                    showToast('å¹³ä»“å¤±è´¥: ' + errorMsg, 'error');
                }
            } catch (error) {
                console.error('å¹³ä»“è¯·æ±‚å¤±è´¥:', error);
                showToast('å¹³ä»“å¤±è´¥: ' + (error.message || 'ç½‘ç»œé”™è¯¯'), 'error');
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadData();
            showToast('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');
        }

        // åˆå§‹åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            loadData();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(loadData, 30000);
            // æ¯10ç§’åˆ·æ–°ä»·æ ¼
            setInterval(refreshPrice, 10000);
        });
    </script>
</body>
</html>
