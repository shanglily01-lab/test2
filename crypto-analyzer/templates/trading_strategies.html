<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易策略 - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; margin-top: var(--spacing-xs); }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        
        /* 策略类型标签页 */
        .strategy-type-tabs { display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-xl); border-bottom: 2px solid var(--border-default); }
        .strategy-type-tab { padding: var(--spacing-md) var(--spacing-xl); background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--text-secondary); cursor: pointer; font-size: 15px; font-weight: 600; transition: all var(--transition-base); margin-bottom: -2px; display: flex; align-items: center; gap: var(--spacing-sm); }
        .strategy-type-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .strategy-type-tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: transparent; }
        
        /* 策略内容区域 */
        .strategy-content { display: none; }
        .strategy-content.active { display: block; }
        
        /* 卡片样式 */
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: 0; }
        
        /* 占位内容 */
        .placeholder-content { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .placeholder-icon { font-size: 64px; margin-bottom: var(--spacing-lg); opacity: 0.5; }
        .placeholder-text { font-size: 16px; margin-bottom: var(--spacing-sm); }
        .placeholder-subtext { font-size: 13px; color: var(--text-tertiary); }
        
        /* 表单样式 */
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-sm); }
        .form-label .required { color: var(--danger-red); margin-left: 2px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: var(--font-family); transition: all var(--transition-base); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(43, 111, 237, 0.1); }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .form-row { display: flex; gap: var(--spacing-lg); flex-wrap: wrap; }
        .form-row > .form-section { flex: 1; min-width: 300px; }
        .form-section { background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); }
        .form-section-title { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-sm); border-bottom: 1px solid var(--border-default); display: flex; align-items: center; gap: var(--spacing-sm); }
        
        /* 单选按钮组 */
        .radio-group { display: flex; gap: var(--spacing-md); flex-wrap: wrap; }
        .radio-option { display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-md); background: var(--bg-secondary); border: 2px solid var(--border-default); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); flex: 1; min-width: 120px; }
        .radio-option:hover { border-color: var(--primary-blue); background: var(--bg-hover); }
        .radio-option input[type="radio"] { width: 18px; height: 18px; cursor: pointer; }
        .radio-option input[type="radio"]:checked + label { color: var(--primary-blue); font-weight: 600; }
        .radio-option:has(input[type="radio"]:checked) { border-color: var(--primary-blue); background: rgba(43, 111, 237, 0.1); }
        .radio-label { cursor: pointer; font-size: 14px; color: var(--text-primary); }
        
        /* 复选框组 */
        .checkbox-group { display: flex; flex-direction: column; gap: var(--spacing-sm); }
        .checkbox-option { display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-secondary); border: 1px solid var(--border-default); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
        .checkbox-option:hover { border-color: var(--primary-blue); background: var(--bg-hover); }
        .checkbox-option input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .checkbox-option:has(input[type="checkbox"]:checked) { border-color: var(--primary-blue); background: rgba(43, 111, 237, 0.1); }
        .checkbox-label { cursor: pointer; font-size: 14px; color: var(--text-primary); }
        
        /* Modal弹框样式 */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); z-index: 10000; display: none; align-items: flex-start; justify-content: center; padding: var(--spacing-xl); overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal-container { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); width: 100%; max-width: 1400px; max-height: 90vh; margin: auto; display: flex; flex-direction: column; box-shadow: var(--shadow-xl); }
        .modal-header { padding: var(--spacing-lg) var(--spacing-xl); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-md); transition: all var(--transition-base); }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-body { padding: var(--spacing-xl); overflow-y: auto; flex: 1; }
        .modal-footer { padding: var(--spacing-lg) var(--spacing-xl); border-top: 1px solid var(--border-default); display: flex; justify-content: flex-end; gap: var(--spacing-md); flex-shrink: 0; }
        
        /* 多选下拉框 */
        .multi-select-wrapper { position: relative; }
        .multi-select-display { padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); min-height: 44px; display: flex; flex-wrap: wrap; gap: var(--spacing-sm); align-items: center; cursor: pointer; }
        .multi-select-tag { display: inline-flex; align-items: center; gap: var(--spacing-xs); padding: var(--spacing-xs) var(--spacing-sm); background: var(--primary-blue); color: white; border-radius: var(--radius-sm); font-size: 12px; }
        .multi-select-tag .remove { cursor: pointer; margin-left: 4px; }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-md); margin-top: var(--spacing-xs); max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
        .multi-select-dropdown.show { display: block; }
        .multi-select-item { padding: var(--spacing-sm) var(--spacing-md); cursor: pointer; transition: background var(--transition-fast); }
        .multi-select-item:hover { background: var(--bg-hover); }
        .multi-select-item input[type="checkbox"] { margin-right: var(--spacing-sm); }
        
        /* 策略列表 */
        .strategy-list { margin-bottom: var(--spacing-xl); }
        .strategy-item { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-md); transition: all var(--transition-base); }
        .strategy-item:hover { border-color: var(--primary-blue); box-shadow: var(--shadow-md); }
        .strategy-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
        .strategy-item-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .strategy-item-actions { display: flex; gap: var(--spacing-sm); }
        .strategy-item-body { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md); }
        .strategy-item-field-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
        .strategy-item-field-value { font-size: 14px; color: var(--text-primary); }
        
        /* 按钮样式 */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 500; line-height: 1; text-decoration: none; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); white-space: nowrap; }
        .btn-primary { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .btn-primary:hover { background: var(--primary-blue-hover); border-color: var(--primary-blue-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-muted); }
        .btn-success { background: var(--success-green); color: white; border-color: var(--success-green); }
        .btn-success:hover { background: #059669; border-color: #059669; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-danger { background: var(--danger-red); color: white; border-color: var(--danger-red); }
        .btn-danger:hover { background: #DC2626; border-color: #DC2626; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-sm { padding: var(--spacing-sm) var(--spacing-md); font-size: 12px; }
        .btn-detail { padding: 4px 8px; font-size: 11px; background: var(--primary-blue); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; transition: all var(--transition-base); }
        .btn-detail:hover { background: var(--primary-blue-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        
        /* 自定义提示框 */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: var(--spacing-md); max-width: 400px; }
        .toast { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow-xl); display: flex; align-items: flex-start; gap: var(--spacing-md); animation: slideInRight 0.3s ease-out; min-width: 320px; }
        .toast.success { border-left: 4px solid var(--success-green); }
        .toast.error { border-left: 4px solid var(--danger-red); }
        .toast.warning { border-left: 4px solid var(--warning-yellow); }
        .toast.info { border-left: 4px solid var(--info-blue); }
        .toast-icon { font-size: 24px; flex-shrink: 0; margin-top: 2px; }
        .toast.success .toast-icon { color: var(--success-green); }
        .toast.error .toast-icon { color: var(--danger-red); }
        .toast.warning .toast-icon { color: var(--warning-yellow); }
        .toast.info .toast-icon { color: var(--info-blue); }
        .toast-content { flex: 1; }
        .toast-title { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs); }
        .toast-message { font-size: 14px; color: var(--text-secondary); line-height: 1.5; white-space: pre-line; }
        .toast-close { background: none; border: none; color: var(--text-tertiary); cursor: pointer; font-size: 20px; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-sm); transition: all var(--transition-fast); flex-shrink: 0; }
        .toast-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast.hiding { animation: slideOutRight 0.3s ease-out forwards; }
        
        /* 自定义确认对话框 */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .confirm-modal-dialog {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 0;
            min-width: 400px;
            max-width: 500px;
            box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 0, 0, 0.4);
            animation: slideUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        @keyframes slideUpModal {
            from {
                transform: translateY(20px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .confirm-modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-default);
        }
        .confirm-modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .confirm-modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .confirm-modal-body {
            padding: var(--spacing-xl);
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 15px;
        }
        .confirm-modal-footer {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-top: 1px solid var(--border-default);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            background: var(--bg-secondary);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container { padding: var(--spacing-md); }
            .header-content { flex-direction: column; align-items: flex-start; }
            .strategy-type-tabs { flex-direction: column; }
            .strategy-type-tab { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- 提示框容器 -->
    <div id="toastContainer" class="toast-container"></div>
    
    <script>
        // 自定义提示框函数
        function showToast(message, type = 'info', duration = 3000) {
            let container = document.getElementById('toastContainer');
            if (!container) {
                // 如果容器不存在，创建一个
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const titles = {
                success: '成功',
                error: '错误',
                warning: '警告',
                info: '提示'
            };
            
            toast.innerHTML = `
                <i class="bi ${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="bi-x"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // 自动关闭
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('hiding');
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);
            }
            
            return toast;
        }
        
        // 兼容旧的 alert 调用
        function showAlert(message, type = 'info') {
            showToast(message, type, 4000);
        }
    </script>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div>
                    <h1 class="header-title">
                        <i class="bi bi-diagram-3"></i>
                        交易策略
                    </h1>
                    <p class="header-subtitle">管理您的现货和合约交易策略配置</p>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-container">
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/technical-signals" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> 技术信号
                </a>
                <a href="/paper_trading" class="nav-link">
                    <i class="bi bi-journals"></i> 模拟现货
                </a>
                <a href="/futures_trading" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> 模拟合约
                </a>
                <a href="/trading-strategies" class="nav-link active">
                    <i class="bi bi-diagram-3"></i> 交易策略
                </a>
                <a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF 数据
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> 企业金库
                </a>
                <a href="/blockchain_gas" class="nav-link">
                    <i class="bi bi-lightning-charge"></i> Gas统计
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> 数据管理
                </a>
            </div>
        </nav>

        <!-- Strategy Type Tabs -->
        <div class="strategy-type-tabs">
            <button class="strategy-type-tab active" onclick="switchStrategyType('spot', event)">
                <i class="bi bi-currency-exchange"></i>
                现货交易策略
            </button>
            <button class="strategy-type-tab" onclick="switchStrategyType('futures', event)">
                <i class="bi bi-graph-up-arrow"></i>
                合约交易策略
            </button>
            <button class="strategy-type-tab" onclick="switchStrategyType('execution', event)">
                <i class="bi bi-list-check"></i>
                策略执行清单
            </button>
        </div>

        <!-- Spot Trading Strategy Content -->
        <div id="spotStrategyContent" class="strategy-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="bi bi-currency-exchange"></i>
                        现货交易策略
                    </h2>
                </div>
                <div class="card-body">
                    <div class="placeholder-content">
                        <div class="placeholder-icon">
                            <i class="bi bi-currency-exchange"></i>
                        </div>
                        <div class="placeholder-text">现货交易策略配置</div>
                        <div class="placeholder-subtext">此部分功能正在开发中，敬请期待...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Futures Trading Strategy Content -->
        <div id="futuresStrategyContent" class="strategy-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="bi bi-graph-up-arrow"></i>
                        合约交易策略
                    </h2>
                    <button class="btn btn-primary" onclick="showAddStrategyModal()">
                        <i class="bi bi-plus-circle"></i>
                        添加策略
                    </button>
                </div>
                <div class="card-body">
                    <!-- 策略列表 -->
                    <div class="strategy-list" id="futuresStrategyList">
                        <!-- 策略项将通过JavaScript动态加载 -->
                    </div>
                    
                    <!-- 策略列表将在这里显示 -->
                    
        <!-- 策略编辑Modal弹框 -->
        <div class="modal-overlay" id="strategyModal">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">
                        <i class="bi bi-plus-circle"></i>
                        新建合约交易策略
                    </h3>
                    <button class="modal-close" onclick="closeStrategyModal()" type="button">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="strategyForm" onsubmit="saveStrategy(event)">
                            <!-- 策略基本信息 -->
                            <div class="form-group">
                                <label class="form-label">策略名称<span class="required">*</span></label>
                                <input type="text" class="form-input" id="strategyName" placeholder="例如：EMA多空策略" required>
                            </div>
                            
                            <!-- 买入和卖出条件（并排显示） -->
                            <div class="form-row">
                                <!-- 买入条件 -->
                                <div class="form-section" style="flex: 1;">
                                    <div class="form-section-title">
                                        <i class="bi bi-arrow-down-circle" style="color: var(--success-green);"></i>
                                        买入条件
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">交易方向<span class="required">*</span></label>
                                        <div class="checkbox-group" style="flex-direction: row; flex-wrap: wrap;">
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="buyDirectionLong" name="buyDirection" value="long" onchange="updatePriceOptions()">
                                                <label for="buyDirectionLong" class="checkbox-label">
                                                    <i class="bi bi-arrow-up-circle" style="color: var(--success-green);"></i>
                                                    做多
                                                </label>
                                            </div>
                                            <div class="checkbox-option">
                                                <input type="checkbox" id="buyDirectionShort" name="buyDirection" value="short" onchange="updatePriceOptions()">
                                                <label for="buyDirectionShort" class="checkbox-label">
                                                    <i class="bi bi-arrow-down-circle" style="color: var(--danger-red);"></i>
                                                    做空
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">交易倍数<span class="required">*</span></label>
                                        <div class="radio-group" style="flex-direction: row; flex-wrap: wrap;">
                                            <div class="radio-option">
                                                <input type="radio" id="leverage5" name="leverage" value="5" checked>
                                                <label for="leverage5" class="radio-label">X5</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="leverage10" name="leverage" value="10">
                                                <label for="leverage10" class="radio-label">X10</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="leverage20" name="leverage" value="20">
                                                <label for="leverage20" class="radio-label">X20</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="leverage30" name="leverage" value="30">
                                                <label for="leverage30" class="radio-label">X30</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="leverage50" name="leverage" value="50">
                                                <label for="leverage50" class="radio-label">X50</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="leverage100" name="leverage" value="100">
                                                <label for="leverage100" class="radio-label">X100</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">买入信号<span class="required">*</span></label>
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px; display: block;">
                                            <strong>EMA(9,26)交叉信号：</strong>向上穿越=做多信号，向下穿越=做空信号
                                        </small>
                                        <div class="radio-group">
                                            <div class="radio-option">
                                                <input type="radio" id="buySignalEma5m" name="buySignals" value="ema_5m" onchange="autoUpdateDirection('buy')">
                                                <label for="buySignalEma5m" class="radio-label">EMA 5分钟</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="buySignalEma15m" name="buySignals" value="ema_15m" checked onchange="autoUpdateDirection('buy')">
                                                <label for="buySignalEma15m" class="radio-label">EMA 15分钟</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="buySignalEma1h" name="buySignals" value="ema_1h" onchange="autoUpdateDirection('buy')">
                                                <label for="buySignalEma1h" class="radio-label">EMA 1小时</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="buySignalMaEma10" name="buySignals" value="ma_ema10" onchange="autoUpdateDirection('buy')">
                                                <label for="buySignalMaEma10" class="radio-label">MA/EMA 10 10</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="buySignalMaEma5" name="buySignals" value="ma_ema5" onchange="autoUpdateDirection('buy')">
                                                <label for="buySignalMaEma5" class="radio-label">MA/EMA 5 5</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div id="buyVolumeOptions" style="display: block;">
                                            <!-- 做多成交量 -->
                                            <div style="margin-bottom: 16px;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                    <input type="checkbox" id="buyVolumeLongEnabled" name="buyVolumeLongEnabled" onchange="toggleBuyVolumeLongOptions()">
                                                    <label for="buyVolumeLongEnabled" class="checkbox-label" style="margin: 0; font-weight: 500;">启用做多成交量条件</label>
                                                </div>
                                                <div id="buyVolumeLongOptions" style="display: none;">
                                                    <label class="form-label">做多成交量条件<span class="required">*</span></label>
                                                    <div class="radio-group">
                                                        <div class="radio-option">
                                                            <input type="radio" id="buyVolumeLong_lt1" name="buyVolumeLong" value="<1">
                                                            <label for="buyVolumeLong_lt1" class="radio-label">&lt;1倍</label>
                                                        </div>
                                                        <div class="radio-option">
                                                            <input type="radio" id="buyVolumeLong_1_2" name="buyVolumeLong" value="1-2">
                                                            <label for="buyVolumeLong_1_2" class="radio-label">1~2倍</label>
                                                        </div>
                                                        <div class="radio-option">
                                                            <input type="radio" id="buyVolumeLong_gt2" name="buyVolumeLong" value=">2">
                                                            <label for="buyVolumeLong_gt2" class="radio-label">&gt;2倍</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- 做空成交量 -->
                                            <div>
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                    <input type="checkbox" id="buyVolumeShortEnabled" name="buyVolumeShortEnabled" onchange="toggleBuyVolumeShortOptions()">
                                                    <label for="buyVolumeShortEnabled" class="checkbox-label" style="margin: 0; font-weight: 500;">启用做空成交量条件</label>
                                                </div>
                                                <small style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px; display: block; margin-left: 26px;">
                                                    做空时检查成交量比率。如果不启用，则不检查成交量条件。
                                                </small>
                                                <div id="buyVolumeShortOptions" style="display: none;">
                                                    <label class="form-label">做空成交量条件<span class="required">*</span></label>
                                                    <div class="radio-group">
                                                        <div class="radio-option">
                                                            <input type="radio" id="buyVolumeShort_lt1" name="buyVolumeShort" value="<1">
                                                            <label for="buyVolumeShort_lt1" class="radio-label">&lt;1倍</label>
                                                        </div>
                                                        <div class="radio-option">
                                                            <input type="radio" id="buyVolumeShort_1_2" name="buyVolumeShort" value="1-2">
                                                            <label for="buyVolumeShort_1_2" class="radio-label">1~2倍</label>
                                                        </div>
                                                        <div class="radio-option">
                                                            <input type="radio" id="buyVolumeShort_gt2" name="buyVolumeShort" value=">2">
                                                            <label for="buyVolumeShort_gt2" class="radio-label">&gt;2倍</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" id="ma10Ema10TrendFilter" name="ma10Ema10TrendFilter">
                                            <label for="ma10Ema10TrendFilter" class="checkbox-label" style="margin: 0; font-weight: 500;">启用 MA10/EMA10 同向过滤</label>
                                        </div>
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block; margin-left: 26px;">
                                            <strong>做多时：</strong>要求 EMA10 > MA10（多头趋势）<br>
                                            <strong>做空时：</strong>要求 EMA10 < MA10（空头趋势）<br>
                                            <span style="color: var(--warning-orange); font-weight: 500;">⚠️ 注意：启用此选项可能会过滤掉很多做空信号，如果希望更多做空机会，建议关闭此选项</span>
                                        </small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">信号强度过滤</label>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                                            <div>
                                                <label style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; display: block;">EMA9/26差值最小百分比 (%)</label>
                                                <input type="number" id="minSignalStrength_ema9_26" name="minSignalStrength_ema9_26" 
                                                       step="0.01" min="0" max="10" 
                                                       placeholder="0.08" 
                                                       style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;">
                                                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 4px;">持仓时检查，推荐值：0.08%（过滤弱信号）</small>
                                            </div>
                                            <div>
                                                <label style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; display: block;">MA10/EMA10差值最小百分比 (%)</label>
                                                <input type="number" id="minSignalStrength_ma10_ema10" name="minSignalStrength_ma10_ema10" 
                                                       step="0.01" min="0" max="10" 
                                                       placeholder="0.15" 
                                                       style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px;">
                                                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 4px;">持仓时检查，推荐值：0.15%（过滤弱信号）</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">趋势持续性检查</label>
                                        <input type="number" id="trendConfirmBars" name="trendConfirmBars" 
                                               step="1" min="0" max="10" 
                                               placeholder="2" 
                                               style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; margin-top: 8px;">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">金叉后趋势至少持续此数量的K线才入场（0表示不启用）</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">趋势确认EMA差值阈值（%）</label>
                                        <input type="number" id="trendConfirmEMAThreshold" name="trendConfirmEMAThreshold" 
                                               step="0.01" min="0" max="5" 
                                               placeholder="0.1" 
                                               style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 14px; margin-top: 8px;">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">趋势确认时，EMA差值必须≥此阈值（0表示不启用，建议0.1-0.3%）</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">趋势反转退出机制</label>
                                        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="checkbox" id="exitOnMAFlip" name="exitOnMAFlip">
                                                <label for="exitOnMAFlip" class="checkbox-label" style="margin: 0; font-weight: 500;">MA10/EMA10反转时立即平仓</label>
                                            </div>
                                            <div style="margin-left: 26px; margin-top: 4px;">
                                                <small style="color: var(--text-secondary); font-size: 12px; display: block;">当MA10/EMA10从多头转为空头（或相反）时，立即平仓退出</small>
                                                <input type="number" id="exitOnMAFlipThreshold" name="exitOnMAFlipThreshold" 
                                                       step="0.01" min="0" max="5" 
                                                       placeholder="0.1" 
                                                       style="width: 120px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; margin-top: 4px;">
                                                <small style="color: var(--text-secondary); font-size: 11px; margin-left: 4px;">阈值（%），避免小幅波动触发</small>
                                            </div>
                                            
                                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                                <input type="checkbox" id="exitOnEMAWeak" name="exitOnEMAWeak">
                                                <label for="exitOnEMAWeak" class="checkbox-label" style="margin: 0; font-weight: 500;">EMA信号过弱时平仓</label>
                                            </div>
                                            <div style="margin-left: 26px; margin-top: 4px;">
                                                <small style="color: var(--text-secondary); font-size: 12px; display: block;">当EMA9/26差值小于阈值时，立即平仓退出</small>
                                                <input type="number" id="exitOnEMAWeakThreshold" name="exitOnEMAWeakThreshold" 
                                                       step="0.01" min="0" max="1" 
                                                       placeholder="0.05" 
                                                       style="width: 120px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; margin-top: 4px;">
                                                <small style="color: var(--text-secondary); font-size: 11px; margin-left: 4px;">阈值（%），默认0.05%</small>
                                            </div>
                                            
                                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                                <label class="form-label" style="margin: 0; font-weight: 500;">早期止损（%）</label>
                                            </div>
                                            <div style="margin-left: 0; margin-top: 4px;">
                                                <input type="number" id="earlyStopLossPct" name="earlyStopLossPct" 
                                                       step="0.1" min="0" max="10" 
                                                       placeholder="例如：3" 
                                                       style="width: 120px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 12px; margin-top: 4px;">
                                                <small style="color: var(--text-secondary); font-size: 11px; margin-left: 4px;">基于EMA差值或价格回撤的早期止损（留空表示不启用）</small>
                                                <small style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 4px;">当EMA差值缩小或价格回撤达到此百分比时，触发早期止损（建议2-5%）</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 技术指标过滤器 -->
                                    <div class="form-group" style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-default);">
                                        <label class="form-label" style="font-size: 14px; font-weight: 600; margin-bottom: var(--spacing-md);">
                                            <i class="bi bi-funnel"></i> 技术指标过滤器
                                        </label>
                                        
                                        <!-- RSI过滤器 -->
                                        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default);">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <input type="checkbox" id="rsiFilterEnabled" name="rsiFilterEnabled">
                                                <label for="rsiFilterEnabled" class="checkbox-label" style="margin: 0; font-weight: 500;">启用 RSI 过滤</label>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-left: 26px; margin-top: 8px;">
                                                <div>
                                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">做多时RSI最大值</label>
                                                    <input type="number" class="form-input" id="rsiLongMax" placeholder="70" min="50" max="90" step="1" value="70" style="width: 100%; padding: 6px; font-size: 13px;">
                                                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">做多时RSI需小于此值</small>
                                                </div>
                                                <div>
                                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">做空时RSI最小值</label>
                                                    <input type="number" class="form-input" id="rsiShortMin" placeholder="30" min="10" max="50" step="1" value="30" style="width: 100%; padding: 6px; font-size: 13px;">
                                                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">做空时RSI需大于此值</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- MACD过滤器 -->
                                        <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default);">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <input type="checkbox" id="macdFilterEnabled" name="macdFilterEnabled">
                                                <label for="macdFilterEnabled" class="checkbox-label" style="margin: 0; font-weight: 500;">启用 MACD 过滤</label>
                                            </div>
                                            <div style="margin-left: 26px; margin-top: 8px;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                                    <input type="checkbox" id="macdLongRequirePositive" name="macdLongRequirePositive" checked>
                                                    <label for="macdLongRequirePositive" class="checkbox-label" style="margin: 0; font-size: 13px;">做多时要求MACD柱状图 > 0</label>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 8px;">
                                                    <input type="checkbox" id="macdShortRequireNegative" name="macdShortRequireNegative" checked>
                                                    <label for="macdShortRequireNegative" class="checkbox-label" style="margin: 0; font-size: 13px;">做空时要求MACD柱状图 < 0</label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- KDJ过滤器 -->
                                        <div style="padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default);">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <input type="checkbox" id="kdjFilterEnabled" name="kdjFilterEnabled">
                                                <label for="kdjFilterEnabled" class="checkbox-label" style="margin: 0; font-weight: 500;">启用 KDJ 过滤</label>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-left: 26px; margin-top: 8px;">
                                                <div>
                                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">做多时KDJ K值最大值</label>
                                                    <input type="number" class="form-input" id="kdjLongMaxK" placeholder="80" min="60" max="95" step="1" value="80" style="width: 100%; padding: 6px; font-size: 13px;">
                                                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">做多时KDJ K值需小于此值</small>
                                                </div>
                                                <div>
                                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">做空时KDJ K值最小值</label>
                                                    <input type="number" class="form-input" id="kdjShortMinK" placeholder="20" min="5" max="40" step="1" value="20" style="width: 100%; padding: 6px; font-size: 13px;">
                                                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">做空时KDJ K值需大于此值</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 卖出条件 -->
                                <div class="form-section" style="flex: 1;">
                                    <div class="form-section-title">
                                        <i class="bi bi-arrow-up-circle" style="color: var(--danger-red);"></i>
                                        卖出条件
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">卖出信号<span class="required">*</span></label>
                                        <div class="radio-group">
                                            <div class="radio-option">
                                                <input type="radio" id="sellSignalEma5m" name="sellSignals" value="ema_5m" checked onchange="autoUpdateDirection('sell')">
                                                <label for="sellSignalEma5m" class="radio-label">EMA 5分钟</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="sellSignalEma15m" name="sellSignals" value="ema_15m" onchange="autoUpdateDirection('sell')">
                                                <label for="sellSignalEma15m" class="radio-label">EMA 15分钟</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="sellSignalEma1h" name="sellSignals" value="ema_1h" onchange="autoUpdateDirection('sell')">
                                                <label for="sellSignalEma1h" class="radio-label">EMA 1小时</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="sellSignalMaEma10" name="sellSignals" value="ma_ema10" onchange="autoUpdateDirection('sell')">
                                                <label for="sellSignalMaEma10" class="radio-label">MA/EMA 10 10</label>
                                            </div>
                                            <div class="radio-option">
                                                <input type="radio" id="sellSignalMaEma5" name="sellSignals" value="ma_ema5" onchange="autoUpdateDirection('sell')">
                                                <label for="sellSignalMaEma5" class="radio-label">MA/EMA 5 5</label>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 平仓成交量条件已移除，平仓时不限制成交量 -->
                                </div>
                            </div>

                            <!-- 交易币种 -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="bi bi-currency-exchange"></i>
                                    交易币种
                                </div>
                                <div class="form-group">
                                    <label class="form-label">交易币种<span class="required">*</span></label>
                                    <div id="symbolCheckboxGroup" class="checkbox-group" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: var(--spacing-sm); max-height: 300px; overflow-y: auto; padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-md); border: 1px solid var(--border-default);">
                                        <!-- 币种复选框将通过JavaScript动态加载 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 仓位控制 -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="bi bi-pie-chart"></i>
                                    仓位控制
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">仓位大小<span class="required">*</span></label>
                                        <input type="number" class="form-input" id="positionSize" placeholder="例如：10" min="0.01" max="100" step="0.01" required>
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">占总资金的比例（%）</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">最大持仓数量</label>
                                        <input type="number" class="form-input" id="maxPositions" placeholder="例如：5" min="1" step="1">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                                            同时持有的最大仓位总数（多空合计）。留空则不限制总数，仅按方向限制。
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">最大做多持仓数</label>
                                        <input type="number" class="form-input" id="maxLongPositions" placeholder="例如：2" min="1" step="1">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                                            同时持有的最大做多仓位数量。留空则不限制做多数量。
                                        </small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">最大做空持仓数</label>
                                        <input type="number" class="form-input" id="maxShortPositions" placeholder="例如：2" min="1" step="1">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">
                                            同时持有的最大做空仓位数量。留空则不限制做空数量。
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group" style="width: 100%;">
                                        <small style="color: var(--text-secondary); font-size: 12px; display: block; padding: 8px; background: var(--bg-secondary); border-radius: var(--radius-sm);">
                                            <strong>💡 持仓限制说明：</strong><br>
                                            • 如果设置了"最大持仓数量"，则多空合计不能超过此数量<br>
                                            • 如果设置了"最大做多/做空持仓数"，则分别限制各方向的持仓数<br>
                                            • 建议：设置方向限制（如做多2个、做空2个）比设置总数限制更灵活
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 风险控制 -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="bi bi-shield-exclamation"></i>
                                    风险控制
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">止损（%）</label>
                                        <input type="number" class="form-input" id="stopLoss" placeholder="例如：3" min="0" max="50" step="0.1">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">亏损达到此百分比时自动平仓（建议3-5%）</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">止盈（%）</label>
                                        <input type="number" class="form-input" id="takeProfit" placeholder="例如：5" min="0" max="100" step="0.1">
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block;">盈利达到此百分比时自动平仓（建议5-10%）</small>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <input type="checkbox" id="closeOppositeOnEntry" style="margin-right: 8px;">
                                            开仓前先平掉相反方向持仓
                                        </label>
                                        <small style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block; margin-left: 24px;">
                                            启用后，开多仓前会先平掉所有空仓，开空仓前会先平掉所有多仓。避免同时持有多空仓位，适合趋势跟踪策略。
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 交易价格 -->
                            <div class="form-section">
                                <div class="form-section-title">
                                    <i class="bi bi-currency-dollar"></i>
                                    交易价格
                                </div>
                                
                                <!-- 做多价格选项 -->
                                <div class="form-group" id="longPriceGroup">
                                    <label class="form-label">做多价格<span class="required">*</span></label>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="longPriceMarket" name="longPrice" value="market" checked>
                                            <label for="longPriceMarket" class="radio-label">市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="longPriceMinus0_2" name="longPrice" value="market_minus_0_2">
                                            <label for="longPriceMinus0_2" class="radio-label">-0.2%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="longPriceMinus0_4" name="longPrice" value="market_minus_0_4">
                                            <label for="longPriceMinus0_4" class="radio-label">-0.4%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="longPriceMinus0_6" name="longPrice" value="market_minus_0_6">
                                            <label for="longPriceMinus0_6" class="radio-label">-0.6%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="longPriceMinus0_8" name="longPrice" value="market_minus_0_8">
                                            <label for="longPriceMinus0_8" class="radio-label">-0.8%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="longPriceMinus1" name="longPrice" value="market_minus_1">
                                            <label for="longPriceMinus1" class="radio-label">-1%市价</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 做空价格选项 -->
                                <div class="form-group" id="shortPriceGroup" style="display: none;">
                                    <label class="form-label">做空价格<span class="required">*</span></label>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="shortPriceMarket" name="shortPrice" value="market" checked>
                                            <label for="shortPriceMarket" class="radio-label">市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="shortPricePlus0_2" name="shortPrice" value="market_plus_0_2">
                                            <label for="shortPricePlus0_2" class="radio-label">+0.2%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="shortPricePlus0_4" name="shortPrice" value="market_plus_0_4">
                                            <label for="shortPricePlus0_4" class="radio-label">+0.4%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="shortPricePlus0_6" name="shortPrice" value="market_plus_0_6">
                                            <label for="shortPricePlus0_6" class="radio-label">+0.6%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="shortPricePlus0_8" name="shortPrice" value="market_plus_0_8">
                                            <label for="shortPricePlus0_8" class="radio-label">+0.8%市价</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="shortPricePlus1" name="shortPrice" value="market_plus_1">
                                            <label for="shortPricePlus1" class="radio-label">+1%市价</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStrategyModal()">取消</button>
                    <button type="submit" class="btn btn-primary" onclick="document.getElementById('strategyForm').dispatchEvent(new Event('submit'))">保存策略</button>
                </div>
            </div>
        </div>
                    
                    <!-- 空状态 -->
                    <div class="placeholder-content" id="emptyState">
                        <div class="placeholder-icon">
                            <i class="bi bi-graph-up-arrow"></i>
                        </div>
                        <div class="placeholder-text">暂无策略</div>
                        <div class="placeholder-subtext">点击"添加策略"按钮创建您的第一个合约交易策略</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Execution List Content -->
        <div id="executionListContent" class="strategy-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="bi bi-list-check"></i>
                        策略执行清单
                    </h2>
                    <button class="btn btn-secondary" onclick="refreshExecutionList()">
                        <i class="bi bi-arrow-clockwise"></i>
                        刷新
                    </button>
                </div>
                <div class="card-body">
                    <!-- 筛选器 -->
                    <div style="display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label">市场类型</label>
                            <select class="form-select" id="executionMarketType" onchange="loadExecutionList()">
                                <option value="all">全部类型</option>
                                <option value="test">测试</option>
                                <option value="live">实盘</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label">操作类型</label>
                            <select class="form-select" id="executionActionType" onchange="loadExecutionList()">
                                <option value="all">全部</option>
                                <option value="buy">买入/开仓</option>
                                <option value="sell">卖出/平仓</option>
                                <option value="order">下单</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label">交易对</label>
                            <input type="text" class="form-input" id="executionSymbol" placeholder="例如: BTC/USDT" onchange="loadExecutionList()">
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label">时间范围</label>
                            <select class="form-select" id="executionTimeRange" onchange="loadExecutionList()">
                                <option value="1h">最近1小时</option>
                                <option value="24h">最近24小时</option>
                                <option value="7d">最近7天</option>
                                <option value="30d" selected>最近30天</option>
                                <option value="all">全部</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label class="form-label">状态</label>
                            <select class="form-select" id="executionStatus" onchange="loadExecutionList()">
                                <option value="all">全部</option>
                                <option value="FILLED">已成交</option>
                                <option value="PENDING">待成交</option>
                                <option value="CANCELLED">已取消</option>
                            </select>
                        </div>
                    </div>

                    <!-- 执行结果列表 -->
                    <div id="executionListContainer">
                        <div class="placeholder-content">
                            <div class="placeholder-icon">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <div class="placeholder-text">正在加载执行记录...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let strategies = []; // 存储策略列表
        let availableSymbols = []; // 可用币种列表
        let editingStrategyId = null; // 正在编辑的策略ID
        
        // 切换策略类型
        function switchStrategyType(type, event) {
            // 更新标签页状态
            document.querySelectorAll('.strategy-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // 如果没有event，通过type找到对应的tab
                const tabs = document.querySelectorAll('.strategy-type-tab');
                tabs.forEach(tab => {
                    if (tab.textContent.includes(type === 'spot' ? '现货' : '合约')) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // 更新内容显示
            document.querySelectorAll('.strategy-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (type === 'spot') {
                document.getElementById('spotStrategyContent').classList.add('active');
            } else if (type === 'futures') {
                document.getElementById('futuresStrategyContent').classList.add('active');
                loadStrategies();
            } else if (type === 'execution') {
                document.getElementById('executionListContent').classList.add('active');
                loadExecutionList();
            }
        }

        // 显示添加策略表单（Modal弹框）
        function showAddStrategyModal() {
            const modal = document.getElementById('strategyModal');
            const modalTitle = document.getElementById('modalTitle');
            
            // 更新Modal标题
            if (editingStrategyId !== null && editingStrategyId !== undefined) {
                modalTitle.innerHTML = '<i class="bi bi-pencil"></i> 编辑合约交易策略';
            } else {
                modalTitle.innerHTML = '<i class="bi bi-plus-circle"></i> 新建合约交易策略';
            }
            
            // 显示Modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // 防止背景滚动
            
            loadAvailableSymbols();
            
            // 如果不是编辑模式，初始化默认值
            if (editingStrategyId === null || editingStrategyId === undefined) {
                // 初始化：默认选择做多
                document.getElementById('buyDirectionLong').checked = true;
                // 初始化价格选项
                updatePriceOptions();
            }
        }

        // 关闭策略Modal
        let isClosingModal = false; // 防止递归调用
        function closeStrategyModal() {
            // 防止递归调用
            if (isClosingModal) {
                return;
            }
            isClosingModal = true;
            
            try {
                const modal = document.getElementById('strategyModal');
                if (modal) {
                    modal.classList.remove('show');
                }
                document.body.style.overflow = ''; // 恢复滚动
                
                // 重置表单
                const form = document.getElementById('strategyForm');
                if (form) {
                    form.reset();
                }
                
                // 重置买入成交量选项
                const buyVolumeLongEnabled = document.getElementById('buyVolumeLongEnabled');
                if (buyVolumeLongEnabled) {
                    buyVolumeLongEnabled.checked = false;
                    toggleBuyVolumeLongOptions();
                }
                const buyVolumeShortEnabled = document.getElementById('buyVolumeShortEnabled');
                if (buyVolumeShortEnabled) {
                    buyVolumeShortEnabled.checked = false;
                    toggleBuyVolumeShortOptions();
                }
                // 清除所有买入成交量选项的选择
                document.querySelectorAll('input[name="buyVolumeLong"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[name="buyVolumeShort"]').forEach(radio => radio.checked = false);
                // 清除 MA10/EMA10 同向过滤
                const ma10Ema10Filter = document.getElementById('ma10Ema10TrendFilter');
                if (ma10Ema10Filter) {
                    ma10Ema10Filter.checked = false;
                }
                // 清除信号强度过滤
                const minSignalStrength_ema9_26 = document.getElementById('minSignalStrength_ema9_26');
                if (minSignalStrength_ema9_26) minSignalStrength_ema9_26.value = '';
                const minSignalStrength_ma10_ema10 = document.getElementById('minSignalStrength_ma10_ema10');
                if (minSignalStrength_ma10_ema10) minSignalStrength_ma10_ema10.value = '';
                // 清除趋势持续性检查
                const trendConfirmBars = document.getElementById('trendConfirmBars');
                if (trendConfirmBars) trendConfirmBars.value = '';
                // 清除趋势反转退出机制
                // 清除开仓前先平掉相反方向持仓
                const closeOppositeOnEntry = document.getElementById('closeOppositeOnEntry');
                if (closeOppositeOnEntry) closeOppositeOnEntry.checked = false;
                const exitOnMAFlip = document.getElementById('exitOnMAFlip');
                if (exitOnMAFlip) exitOnMAFlip.checked = false;
                const exitOnMAFlipThreshold = document.getElementById('exitOnMAFlipThreshold');
                if (exitOnMAFlipThreshold) exitOnMAFlipThreshold.value = '';
                const exitOnEMAWeak = document.getElementById('exitOnEMAWeak');
                if (exitOnEMAWeak) exitOnEMAWeak.checked = false;
                const exitOnEMAWeakThreshold = document.getElementById('exitOnEMAWeakThreshold');
                if (exitOnEMAWeakThreshold) exitOnEMAWeakThreshold.value = '';
                const earlyStopLossPct = document.getElementById('earlyStopLossPct');
                if (earlyStopLossPct) earlyStopLossPct.value = '';
                const trendConfirmEMAThreshold = document.getElementById('trendConfirmEMAThreshold');
                if (trendConfirmEMAThreshold) trendConfirmEMAThreshold.value = '';
                
                // 清除风险控制
                const preventDuplicateEntry = document.getElementById('preventDuplicateEntry');
                if (preventDuplicateEntry) preventDuplicateEntry.checked = false;
                const minHoldingTimeHours = document.getElementById('minHoldingTimeHours');
                if (minHoldingTimeHours) minHoldingTimeHours.value = '';
                
                // 清除同方向持仓限制
                const maxLongPositions = document.getElementById('maxLongPositions');
                if (maxLongPositions) maxLongPositions.value = '';
                const maxShortPositions = document.getElementById('maxShortPositions');
                if (maxShortPositions) maxShortPositions.value = '';
                
                // 清除技术指标过滤器
                const rsiFilterEnabled = document.getElementById('rsiFilterEnabled');
                if (rsiFilterEnabled) {
                    rsiFilterEnabled.checked = false;
                    const rsiLongMax = document.getElementById('rsiLongMax');
                    if (rsiLongMax) rsiLongMax.value = '70';
                    const rsiShortMin = document.getElementById('rsiShortMin');
                    if (rsiShortMin) rsiShortMin.value = '30';
                }
                const macdFilterEnabled = document.getElementById('macdFilterEnabled');
                if (macdFilterEnabled) {
                    macdFilterEnabled.checked = false;
                    const macdLongRequirePositive = document.getElementById('macdLongRequirePositive');
                    if (macdLongRequirePositive) macdLongRequirePositive.checked = true;
                    const macdShortRequireNegative = document.getElementById('macdShortRequireNegative');
                    if (macdShortRequireNegative) macdShortRequireNegative.checked = true;
                }
                const kdjFilterEnabled = document.getElementById('kdjFilterEnabled');
                if (kdjFilterEnabled) {
                    kdjFilterEnabled.checked = false;
                    const kdjLongMaxK = document.getElementById('kdjLongMaxK');
                    if (kdjLongMaxK) kdjLongMaxK.value = '80';
                    const kdjShortMinK = document.getElementById('kdjShortMinK');
                    if (kdjShortMinK) kdjShortMinK.value = '20';
                }
                
                editingStrategyId = null;
                updateEmptyState();
            } catch (error) {
                console.error('关闭Modal时出错:', error);
            } finally {
                // 重置递归保护标志（延迟重置，确保所有操作完成）
                setTimeout(() => {
                    isClosingModal = false;
                }, 100);
            }
        }
        
        // 点击Modal背景关闭
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('strategyModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeStrategyModal();
                    }
                });
            }
            
            // ESC键关闭Modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('strategyModal');
                    if (modal && modal.classList.contains('show')) {
                        closeStrategyModal();
                    }
                }
            });
        });

        // 根据交易方向更新价格选项显示
        function updatePriceOptions() {
            const longChecked = document.getElementById('buyDirectionLong').checked;
            const shortChecked = document.getElementById('buyDirectionShort').checked;
            
            // 显示/隐藏做多价格选项
            const longPriceGroup = document.getElementById('longPriceGroup');
            if (longChecked) {
                longPriceGroup.style.display = 'block';
            } else {
                longPriceGroup.style.display = 'none';
            }
            
            // 显示/隐藏做空价格选项
            const shortPriceGroup = document.getElementById('shortPriceGroup');
            if (shortChecked) {
                shortPriceGroup.style.display = 'block';
            } else {
                shortPriceGroup.style.display = 'none';
            }
        }

        // 根据EMA信号自动决定多空方向
        function autoUpdateDirection(type) {
            if (type === 'buy') {
                const buySignal = document.querySelector('input[name="buySignals"]:checked').value;
                // EMA信号通常金叉表示看涨（做多），死叉表示看跌（做空）
                // 这里可以根据实际需求调整逻辑
                // 暂时根据EMA时间周期判断：5m和15m通常用于短期做多，1h用于中期
                if (buySignal === 'ema_5m' || buySignal === 'ema_15m') {
                    // 短期EMA信号，倾向于做多
                    if (!document.getElementById('buyDirectionLong').checked) {
                        document.getElementById('buyDirectionLong').checked = true;
                        updatePriceOptions();
                    }
                } else if (buySignal === 'ema_1h') {
                    // 1小时EMA信号，可以同时支持多空
                    // 不做自动选择，让用户自己决定
                }
            } else if (type === 'sell') {
                const sellSignal = document.querySelector('input[name="sellSignals"]:checked').value;
                // 卖出信号通常用于平仓，不做方向自动选择
            }
        }

        // 切换买入成交量选项显示/隐藏（已废弃，成交量选项始终显示）
        function toggleBuyVolumeOptions() {
            // 不再需要此功能，成交量选项始终显示
        }
        
        // 切换做多成交量选项显示/隐藏
        function toggleBuyVolumeLongOptions() {
            const enabled = document.getElementById('buyVolumeLongEnabled').checked;
            const volumeOptions = document.getElementById('buyVolumeLongOptions');
            if (enabled) {
                volumeOptions.style.display = 'block';
                // 设置必填验证
                document.querySelectorAll('input[name="buyVolumeLong"]').forEach(radio => {
                    radio.required = true;
                });
            } else {
                volumeOptions.style.display = 'none';
                // 清除必填验证和选择
                document.querySelectorAll('input[name="buyVolumeLong"]').forEach(radio => {
                    radio.required = false;
                    radio.checked = false;
                });
            }
        }
        
        // 切换做空成交量选项显示/隐藏
        function toggleBuyVolumeShortOptions() {
            const enabled = document.getElementById('buyVolumeShortEnabled').checked;
            const volumeOptions = document.getElementById('buyVolumeShortOptions');
            if (enabled) {
                volumeOptions.style.display = 'block';
                // 设置必填验证
                document.querySelectorAll('input[name="buyVolumeShort"]').forEach(radio => {
                    radio.required = true;
                });
            } else {
                volumeOptions.style.display = 'none';
                // 清除必填验证和选择
                document.querySelectorAll('input[name="buyVolumeShort"]').forEach(radio => {
                    radio.required = false;
                    radio.checked = false;
                });
            }
        }

        // 加载可用币种（从配置文件/API获取）
        async function loadAvailableSymbols() {
            try {
                // 优先从 /api/config 获取交易对清单（从配置文件读取）
                const configResponse = await fetch('/api/config');
                if (configResponse.ok) {
                    const configData = await configResponse.json();
                    if (configData.symbols && Array.isArray(configData.symbols) && configData.symbols.length > 0) {
                        availableSymbols = configData.symbols;
                    }
                }
                
                // 如果 /api/config 没有数据，尝试从 /api/futures/symbols 获取
                if (availableSymbols.length === 0) {
                    const futuresResponse = await fetch('/api/futures/symbols');
                    if (futuresResponse.ok) {
                        const futuresData = await futuresResponse.json();
                        if (futuresData.success && futuresData.symbols && futuresData.symbols.length > 0) {
                            availableSymbols = futuresData.symbols;
                        }
                    }
                }
                
                // 如果仍然没有数据，尝试从技术信号API获取
                if (availableSymbols.length === 0) {
                    const techResponse = await fetch('/api/technical-signals');
                    if (techResponse.ok) {
                        const techData = await techResponse.json();
                        if (techData.success && techData.data && techData.data.length > 0) {
                            availableSymbols = techData.data.map(item => item.symbol);
                        }
                    }
                }
                
                // 如果仍然没有数据，使用默认列表
                if (availableSymbols.length === 0) {
                    console.warn('无法从API获取币种列表，使用默认列表');
                    availableSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT', 'DOGE/USDT', 'XRP/USDT', 'ADA/USDT', 'AVAX/USDT', 'DOT/USDT', 'MATIC/USDT'];
                }
                
                const symbolCheckboxGroup = document.getElementById('symbolCheckboxGroup');
                symbolCheckboxGroup.innerHTML = '';
                
                // 去重并排序
                availableSymbols = [...new Set(availableSymbols)].sort();
                
                availableSymbols.forEach(symbol => {
                    const checkboxOption = document.createElement('div');
                    checkboxOption.className = 'checkbox-option';
                    checkboxOption.innerHTML = `
                        <input type="checkbox" id="symbol_${symbol.replace('/', '_')}" name="symbols" value="${symbol}">
                        <label for="symbol_${symbol.replace('/', '_')}" class="checkbox-label">${symbol}</label>
                    `;
                    symbolCheckboxGroup.appendChild(checkboxOption);
                });
            } catch (error) {
                console.error('加载币种列表失败:', error);
                // 使用默认列表作为备用
                if (availableSymbols.length === 0) {
                    availableSymbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT', 'SOL/USDT', 'DOGE/USDT', 'XRP/USDT', 'ADA/USDT', 'AVAX/USDT', 'DOT/USDT', 'MATIC/USDT'];
                    const symbolCheckboxGroup = document.getElementById('symbolCheckboxGroup');
                    symbolCheckboxGroup.innerHTML = '';
                    availableSymbols.forEach(symbol => {
                        const checkboxOption = document.createElement('div');
                        checkboxOption.className = 'checkbox-option';
                        checkboxOption.innerHTML = `
                            <input type="checkbox" id="symbol_${symbol.replace('/', '_')}" name="symbols" value="${symbol}">
                            <label for="symbol_${symbol.replace('/', '_')}" class="checkbox-label">${symbol}</label>
                        `;
                        symbolCheckboxGroup.appendChild(checkboxOption);
                    });
                }
            }
        }

        // 保存策略到服务器
        async function saveStrategiesToServer() {
            try {
                const response = await fetch('/api/futures/strategies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(strategies)
                });
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || '保存失败');
                }
                return true;
            } catch (error) {
                console.error('保存策略到服务器失败:', error);
                showToast('保存策略失败: ' + error.message, 'error');
                return false;
            }
        }

        // 保存策略
        async function saveStrategy(event) {
            event.preventDefault();

            const buyVolumeLongRadio = document.querySelector('input[name="buyVolumeLong"]:checked');
            const buyVolumeShortRadio = document.querySelector('input[name="buyVolumeShort"]:checked');
            const buySignalRadio = document.querySelector('input[name="buySignals"]:checked');
            const sellSignalRadio = document.querySelector('input[name="sellSignals"]:checked');
            const longPriceRadio = document.querySelector('input[name="longPrice"]:checked');
            const shortPriceRadio = document.querySelector('input[name="shortPrice"]:checked');

            const buyDirections = Array.from(document.querySelectorAll('input[name="buyDirection"]:checked')).map(cb => cb.value);
            const leverageRadio = document.querySelector('input[name="leverage"]:checked');

            // 判断是否启用了买入成交量条件
            const buyVolumeLongEnabled = document.getElementById('buyVolumeLongEnabled').checked;
            const buyVolumeShortEnabled = document.getElementById('buyVolumeShortEnabled').checked;
            const buyVolumeEnabled = buyVolumeLongEnabled || buyVolumeShortEnabled;

            const formData = {
                name: document.getElementById('strategyName').value,
                buyDirection: buyDirections, // 改为数组，支持多选
                leverage: leverageRadio ? parseInt(leverageRadio.value) : 5, // 交易倍数，默认5
                buySignals: buySignalRadio ? buySignalRadio.value : null, // 改为单选
                buyVolumeEnabled: buyVolumeEnabled,
                buyVolumeLongEnabled: buyVolumeLongEnabled,
                buyVolumeShortEnabled: buyVolumeShortEnabled,
                buyVolumeLong: buyVolumeLongEnabled && buyVolumeLongRadio ? buyVolumeLongRadio.value : null,
                buyVolumeShort: buyVolumeShortEnabled && buyVolumeShortRadio ? buyVolumeShortRadio.value : null,
                sellSignals: sellSignalRadio ? sellSignalRadio.value : null, // 改为单选
                // 平仓成交量已移除，不再限制
                symbols: Array.from(document.querySelectorAll('input[name="symbols"]:checked')).map(cb => cb.value),
                positionSize: parseFloat(document.getElementById('positionSize').value),
                maxPositions: document.getElementById('maxPositions').value ? parseInt(document.getElementById('maxPositions').value) : null,
                maxLongPositions: document.getElementById('maxLongPositions').value ? parseInt(document.getElementById('maxLongPositions').value) : null,
                maxShortPositions: document.getElementById('maxShortPositions').value ? parseInt(document.getElementById('maxShortPositions').value) : null,
                longPrice: longPriceRadio ? longPriceRadio.value : null,
                shortPrice: shortPriceRadio ? shortPriceRadio.value : null,
                stopLoss: document.getElementById('stopLoss').value ? parseFloat(document.getElementById('stopLoss').value) : null,
                takeProfit: document.getElementById('takeProfit').value ? parseFloat(document.getElementById('takeProfit').value) : null,
                closeOppositeOnEntry: document.getElementById('closeOppositeOnEntry') ? document.getElementById('closeOppositeOnEntry').checked : false,
                ma10Ema10TrendFilter: document.getElementById('ma10Ema10TrendFilter').checked,
                minSignalStrength: {
                    ema9_26: document.getElementById('minSignalStrength_ema9_26').value ? parseFloat(document.getElementById('minSignalStrength_ema9_26').value) : 0,
                    ma10_ema10: document.getElementById('minSignalStrength_ma10_ema10').value ? parseFloat(document.getElementById('minSignalStrength_ma10_ema10').value) : 0
                },
                trendConfirmBars: document.getElementById('trendConfirmBars').value ? parseInt(document.getElementById('trendConfirmBars').value) : 0,
                trendConfirmEMAThreshold: document.getElementById('trendConfirmEMAThreshold') && document.getElementById('trendConfirmEMAThreshold').value ? parseFloat(document.getElementById('trendConfirmEMAThreshold').value) : 0,
                exitOnMAFlip: document.getElementById('exitOnMAFlip') ? document.getElementById('exitOnMAFlip').checked : false,
                exitOnMAFlipThreshold: document.getElementById('exitOnMAFlipThreshold') && document.getElementById('exitOnMAFlipThreshold').value ? parseFloat(document.getElementById('exitOnMAFlipThreshold').value) : 0.1,
                exitOnEMAWeak: document.getElementById('exitOnEMAWeak') ? document.getElementById('exitOnEMAWeak').checked : false,
                exitOnEMAWeakThreshold: document.getElementById('exitOnEMAWeakThreshold') && document.getElementById('exitOnEMAWeakThreshold').value ? parseFloat(document.getElementById('exitOnEMAWeakThreshold').value) : 0.05,
                earlyStopLossPct: document.getElementById('earlyStopLossPct') && document.getElementById('earlyStopLossPct').value ? parseFloat(document.getElementById('earlyStopLossPct').value) : null,
                preventDuplicateEntry: document.getElementById('preventDuplicateEntry') ? document.getElementById('preventDuplicateEntry').checked : false,
                minHoldingTimeHours: document.getElementById('minHoldingTimeHours') ? (document.getElementById('minHoldingTimeHours').value ? parseFloat(document.getElementById('minHoldingTimeHours').value) : 0) : 0,
                rsiFilter: {
                    enabled: document.getElementById('rsiFilterEnabled') ? document.getElementById('rsiFilterEnabled').checked : false,
                    longMax: document.getElementById('rsiLongMax') ? parseFloat(document.getElementById('rsiLongMax').value) : 70,
                    shortMin: document.getElementById('rsiShortMin') ? parseFloat(document.getElementById('rsiShortMin').value) : 30
                },
                macdFilter: {
                    enabled: document.getElementById('macdFilterEnabled') ? document.getElementById('macdFilterEnabled').checked : false,
                    longRequirePositive: document.getElementById('macdLongRequirePositive') ? document.getElementById('macdLongRequirePositive').checked : true,
                    shortRequireNegative: document.getElementById('macdShortRequireNegative') ? document.getElementById('macdShortRequireNegative').checked : true
                },
                kdjFilter: {
                    enabled: document.getElementById('kdjFilterEnabled') ? document.getElementById('kdjFilterEnabled').checked : false,
                    longMaxK: document.getElementById('kdjLongMaxK') ? parseFloat(document.getElementById('kdjLongMaxK').value) : 80,
                    shortMinK: document.getElementById('kdjShortMinK') ? parseFloat(document.getElementById('kdjShortMinK').value) : 20
                }
            };
            
            // 验证
            if (buyDirections.length === 0) {
                showToast('请至少选择一个交易方向（做多或做空）', 'warning');
                return;
            }
            
            if (!leverageRadio) {
                showToast('请选择交易倍数', 'warning');
                return;
            }
            
            if (!buySignalRadio) {
                showToast('请选择一个买入信号', 'warning');
                return;
            }
            
            // 如果启用了买入成交量条件，检查对应的子选项
            if (buyVolumeLongEnabled && !buyVolumeLongRadio) {
                showToast('请选择做多成交量条件', 'warning');
                return;
            }
            if (buyVolumeShortEnabled && !buyVolumeShortRadio) {
                showToast('请选择做空成交量条件', 'warning');
                return;
            }
            
            if (!sellSignalRadio) {
                showToast('请选择一个卖出信号', 'warning');
                return;
            }

            // 验证价格选项
            if (buyDirections.includes('long') && !longPriceRadio) {
                showToast('请选择做多价格', 'warning');
                return;
            }
            
            if (buyDirections.includes('short') && !shortPriceRadio) {
                showToast('请选择做空价格', 'warning');
                return;
            }
            
            if (formData.symbols.length === 0) {
                showToast('请至少选择一个交易币种', 'warning');
                return;
            }
            
            // 更新或添加策略
            if (editingStrategyId !== null && editingStrategyId !== undefined) {
                // 编辑模式：更新现有策略
                // 确保 ID 类型一致进行比较
                const index = strategies.findIndex(s => {
                    const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                    const editId = typeof editingStrategyId === 'string' ? parseInt(editingStrategyId) : editingStrategyId;
                    return sId === editId;
                });
                
                if (index !== -1) {
                    formData.id = strategies[index].id; // 保持原始ID
                    formData.enabled = strategies[index].enabled; // 保持原有启用状态
                    strategies[index] = formData;
                    console.log('更新策略:', formData.name, 'ID:', formData.id);
                } else {
                    console.error('编辑模式但未找到策略，ID:', editingStrategyId);
                    showToast('未找到要编辑的策略', 'error');
                    return;
                }
            } else {
                // 新建模式：添加新策略
                formData.id = Date.now(); // 临时ID
                formData.enabled = false;
                strategies.push(formData);
            }
            
            // 保存到服务器
            const saved = await saveStrategiesToServer();
            if (saved) {
                // 刷新显示
                loadStrategies();
                closeStrategyModal(); // closeStrategyModal 已经会重置表单状态
                showToast('策略保存成功！', 'success');
            }
        }

        // 加载策略列表
        async function loadStrategies() {
            try {
                // 从服务器加载策略配置
                const response = await fetch('/api/futures/strategies');
                const result = await response.json();
                
                if (result.success) {
                    strategies = result.data || [];
                } else {
                    strategies = [];
                    console.error('加载策略失败:', result.message);
                }
            } catch (error) {
                console.error('加载策略时出错:', error);
                strategies = [];
                // 如果API失败，尝试从localStorage加载（向后兼容）
                const saved = localStorage.getItem('futuresStrategies');
                if (saved) {
                    try {
                        strategies = JSON.parse(saved);
                        // 如果localStorage有数据，尝试迁移到服务器
                        saveStrategiesToServer();
                    } catch (e) {
                        strategies = [];
                    }
                }
            }
            
            const strategyList = document.getElementById('futuresStrategyList');
            const emptyState = document.getElementById('emptyState');
            
            if (strategies.length === 0) {
                strategyList.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                strategyList.innerHTML = strategies.map(strategy => `
                    <div class="strategy-item">
                        <div class="strategy-item-header">
                            <div class="strategy-item-title">${strategy.name}</div>
                            <div class="strategy-item-actions">
                                <button class="btn btn-sm btn-info" onclick="testStrategy(${strategy.id})" title="测试24小时交易">
                                    <i class="bi bi-graph-up"></i> 测试
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="viewTestHistory(${strategy.id})" title="查看测试历史">
                                    <i class="bi bi-clock-history"></i> 历史
                                </button>
                                <button class="btn btn-sm ${strategy.enabled ? 'btn-success' : 'btn-secondary'}" onclick="toggleStrategy(${strategy.id})">
                                    ${strategy.enabled ? '<i class="bi bi-pause-circle"></i> 暂停' : '<i class="bi bi-play-circle"></i> 启用'}
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="editStrategy(${strategy.id})">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStrategy(${strategy.id})">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="strategy-item-body">
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">交易方向</div>
                                <div class="strategy-item-field-value">
                                    ${Array.isArray(strategy.buyDirection) 
                                        ? strategy.buyDirection.map(dir => 
                                            `<span style="color: ${dir === 'long' ? 'var(--success-green)' : 'var(--danger-red)'}; margin-right: 8px;">
                                                ${dir === 'long' ? '做多' : '做空'}
                                            </span>`
                                        ).join('')
                                        : (strategy.buyDirection === 'long' 
                                            ? '<span style="color: var(--success-green);">做多</span>' 
                                            : '<span style="color: var(--danger-red);">做空</span>')}
                                </div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">交易倍数</div>
                                <div class="strategy-item-field-value">X${strategy.leverage || 5}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">买入信号</div>
                                <div class="strategy-item-field-value">${strategy.buySignals || (Array.isArray(strategy.signals) ? strategy.signals.join(', ') : '未设置')}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">买入成交量</div>
                                <div class="strategy-item-field-value">${strategy.buyVolumeEnabled !== false ?
                                    (() => {
                                        const longText = (strategy.buyVolumeLongEnabled !== false && strategy.buyVolumeLong) ?
                                            `做多: ${strategy.buyVolumeLong}倍` :
                                            (strategy.buyVolumeLongEnabled === false ? '做多: 未启用' : '做多: 未设置');
                                        const shortText = (strategy.buyVolumeShortEnabled !== false && strategy.buyVolumeShort) ?
                                            `做空: ${strategy.buyVolumeShort}倍` :
                                            (strategy.buyVolumeShortEnabled === false ? '做空: 未启用' : '做空: 未设置');
                                        return `${longText}, ${shortText}`;
                                    })() : '未启用'}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">卖出信号</div>
                                <div class="strategy-item-field-value">${strategy.sellSignals || '未设置'}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">交易币种</div>
                                <div class="strategy-item-field-value">${strategy.symbols.join(', ')}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">仓位大小</div>
                                <div class="strategy-item-field-value">${strategy.positionSize}%</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">最大持仓数</div>
                                <div class="strategy-item-field-value">${strategy.maxPositions || '未设置'}</div>
                            </div>
                            ${strategy.maxLongPositions || strategy.maxShortPositions ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">同方向持仓限制</div>
                                    <div class="strategy-item-field-value">
                                        ${strategy.maxLongPositions ? `做多: ${strategy.maxLongPositions}` : ''}
                                        ${strategy.maxLongPositions && strategy.maxShortPositions ? ', ' : ''}
                                        ${strategy.maxShortPositions ? `做空: ${strategy.maxShortPositions}` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">止损</div>
                                <div class="strategy-item-field-value">${strategy.stopLoss ? strategy.stopLoss + '%' : '未设置'}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">止盈</div>
                                <div class="strategy-item-field-value">${strategy.takeProfit ? strategy.takeProfit + '%' : '未设置'}</div>
                            </div>
                            ${strategy.closeOppositeOnEntry ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">开仓前先平相反方向</div>
                                    <div class="strategy-item-field-value">✅ 已启用</div>
                                </div>
                            ` : ''}
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">MA10/EMA10同向过滤</div>
                                <div class="strategy-item-field-value">${strategy.ma10Ema10TrendFilter ? '✅ 已启用' : '❌ 未启用'}</div>
                            </div>
                            ${strategy.rsiFilter && strategy.rsiFilter.enabled ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">RSI过滤</div>
                                    <div class="strategy-item-field-value">✅ 已启用 (做多≤${strategy.rsiFilter.longMax || 70}, 做空≥${strategy.rsiFilter.shortMin || 30})</div>
                                </div>
                            ` : ''}
                            ${strategy.macdFilter && strategy.macdFilter.enabled ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">MACD过滤</div>
                                    <div class="strategy-item-field-value">✅ 已启用</div>
                                </div>
                            ` : ''}
                            ${strategy.kdjFilter && strategy.kdjFilter.enabled ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">KDJ过滤</div>
                                    <div class="strategy-item-field-value">✅ 已启用 (做多K≤${strategy.kdjFilter.longMaxK || 80}, 做空K≥${strategy.kdjFilter.shortMinK || 20})</div>
                                </div>
                            ` : ''}
                            ${strategy.minSignalStrength ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">信号强度过滤（持仓时）</div>
                                    <div class="strategy-item-field-value">EMA9/26: ${strategy.minSignalStrength.ema9_26 || 0}%, MA10/EMA10: ${strategy.minSignalStrength.ma10_ema10 || 0}%</div>
                                </div>
                            ` : ''}
                            ${strategy.trendConfirmBars ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">趋势确认K线数</div>
                                    <div class="strategy-item-field-value">${strategy.trendConfirmBars} 根</div>
                                </div>
                            ` : ''}
                            ${strategy.maxPositions ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">最大持仓数</div>
                                    <div class="strategy-item-field-value">${strategy.maxPositions} 个</div>
                                </div>
                            ` : ''}
                            ${strategy.exitOnMAFlip || strategy.exitOnEMAWeak ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">趋势反转退出</div>
                                    <div class="strategy-item-field-value">
                                        ${strategy.exitOnMAFlip ? '✅ MA10/EMA10反转' : ''}
                                        ${strategy.exitOnMAFlip && strategy.exitOnEMAWeak ? ', ' : ''}
                                        ${strategy.exitOnEMAWeak ? '✅ EMA信号过弱' : ''}
                                    </div>
                                </div>
                            ` : ''}
                            ${strategy.preventDuplicateEntry || strategy.minHoldingTimeHours ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">风险控制</div>
                                    <div class="strategy-item-field-value">
                                        ${strategy.preventDuplicateEntry ? '✅ 防止重复开仓' : ''}
                                        ${strategy.preventDuplicateEntry && strategy.minHoldingTimeHours ? ', ' : ''}
                                        ${strategy.minHoldingTimeHours ? `最小持仓${strategy.minHoldingTimeHours}小时` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">做多价格</div>
                                <div class="strategy-item-field-value">${strategy.longPrice ? getBuyPriceTypeText(strategy.longPrice) : '未设置'}</div>
                            </div>
                            <div class="strategy-item-field">
                                <div class="strategy-item-field-label">做空价格</div>
                                <div class="strategy-item-field-value">${strategy.shortPrice ? getBuyPriceTypeText(strategy.shortPrice) : '未设置'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // 获取交易方式文本
        function getBuyPriceTypeText(type) {
            const types = {
                'market': '市价',
                'market_minus_0_2': '-0.2%市价',
                'market_minus_0_4': '-0.4%市价',
                'market_minus_0_6': '-0.6%市价',
                'market_minus_0_8': '-0.8%市价',
                'market_minus_1': '-1%市价',
                'market_plus_0_2': '+0.2%市价',
                'market_plus_0_4': '+0.4%市价',
                'market_plus_0_6': '+0.6%市价',
                'market_plus_0_8': '+0.8%市价',
                'market_plus_1': '+1%市价',
                'limit': '限价'
            };
            return types[type] || type || '未设置';
        }

        // 切换策略启用状态
        async function toggleStrategy(id) {
            // 确保 ID 类型一致
            const strategyId = typeof id === 'string' ? parseInt(id) : id;
            const strategy = strategies.find(s => {
                const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                return sId === strategyId;
            });
            
            if (strategy) {
                strategy.enabled = !strategy.enabled;
                const saved = await saveStrategiesToServer();
                if (saved) {
                    loadStrategies();
                    
                    // 如果启用策略，立即执行一次
                    if (strategy.enabled) {
                        executeStrategy(strategy);
                    }
                }
            } else {
                showToast('策略未找到', 'error');
            }
        }
        
        // 执行策略
        async function executeStrategy(strategy) {
            try {
                const response = await fetch('/api/strategy/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...strategy,
                        account_id: 2  // 默认账户ID
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('策略执行成功:', result);
                    if (result.results && result.results.length > 0) {
                        showToast(`策略执行成功！\n执行了 ${result.results.length} 个操作`, 'success');
                    }
                } else {
                    console.error('策略执行失败:', result.message);
                }
            } catch (error) {
                console.error('执行策略时出错:', error);
            }
        }

        // 编辑策略
        function editStrategy(id) {
            // 确保 ID 类型一致（转换为数字进行比较）
            const strategyId = typeof id === 'string' ? parseInt(id) : id;
            const strategy = strategies.find(s => {
                const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                return sId === strategyId;
            });
            
            if (!strategy) {
                console.error('策略未找到，ID:', id, '策略列表:', strategies);
                showToast('策略未找到', 'error');
                return;
            }
            
            editingStrategyId = strategy.id; // 使用策略中的原始ID
            console.log('编辑策略:', strategy.name, 'ID:', editingStrategyId);
            
            // 填充表单
            document.getElementById('strategyName').value = strategy.name;
                
            // 买入方向（支持多选）
            const buyDirections = Array.isArray(strategy.buyDirection) ? strategy.buyDirection : (strategy.buyDirection ? [strategy.buyDirection] : (strategy.direction ? [strategy.direction] : ['long']));
            buyDirections.forEach(dir => {
                const checkbox = document.querySelector(`input[name="buyDirection"][value="${dir}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            // 交易倍数
            const leverage = strategy.leverage || 5;
            const leverageRadio = document.querySelector(`input[name="leverage"][value="${leverage}"]`);
            if (leverageRadio) leverageRadio.checked = true;
            
            // 更新价格选项（根据交易方向）
            updatePriceOptions();
            
            // 买入EMA信号（单选）
            const buySignal = strategy.buySignals || (Array.isArray(strategy.signals) ? strategy.signals[0] : strategy.signals) || 'ema_15m';
            const buySignalRadio = document.querySelector(`input[name="buySignals"][value="${buySignal}"]`);
            if (buySignalRadio) buySignalRadio.checked = true;
            
            // 买入成交量（始终显示，根据策略配置设置）
            // 做多成交量
            const buyVolumeLongEnabled = strategy.buyVolumeLongEnabled !== false && (strategy.buyVolumeLong || strategy.buyVolume);
            document.getElementById('buyVolumeLongEnabled').checked = buyVolumeLongEnabled;
            toggleBuyVolumeLongOptions();
            if (buyVolumeLongEnabled) {
                // 兼容旧格式（buyVolume）和新格式（buyVolumeLong）
                const volumeLongValue = String(strategy.buyVolumeLong || strategy.buyVolume || '');
                if (volumeLongValue) {
                    // 尝试精确匹配
                    let buyVolumeLongRadio = document.querySelector(`input[name="buyVolumeLong"][value="${volumeLongValue}"]`);
                    if (!buyVolumeLongRadio) {
                        // 如果精确匹配失败，尝试所有选项
                        document.querySelectorAll('input[name="buyVolumeLong"]').forEach(radio => {
                            if (radio.value === volumeLongValue || String(radio.value) === volumeLongValue) {
                                buyVolumeLongRadio = radio;
                            }
                        });
                    }
                    if (buyVolumeLongRadio) {
                        buyVolumeLongRadio.checked = true;
                    }
                }
            }
            
            // 做空成交量
            const buyVolumeShortEnabled = strategy.buyVolumeShortEnabled !== false && strategy.buyVolumeShort;
            document.getElementById('buyVolumeShortEnabled').checked = buyVolumeShortEnabled;
            toggleBuyVolumeShortOptions();
            if (buyVolumeShortEnabled && strategy.buyVolumeShort) {
                const volumeShortValue = String(strategy.buyVolumeShort);
                // 尝试精确匹配
                let buyVolumeShortRadio = document.querySelector(`input[name="buyVolumeShort"][value="${volumeShortValue}"]`);
                if (!buyVolumeShortRadio) {
                    // 如果精确匹配失败，尝试所有选项
                    document.querySelectorAll('input[name="buyVolumeShort"]').forEach(radio => {
                        if (radio.value === volumeShortValue || String(radio.value) === volumeShortValue) {
                            buyVolumeShortRadio = radio;
                        }
                    });
                }
                if (buyVolumeShortRadio) {
                    buyVolumeShortRadio.checked = true;
                }
            }
            
            // 卖出EMA信号（单选）
            const sellSignal = strategy.sellSignals || 'ema_5m';
            const sellSignalRadio = document.querySelector(`input[name="sellSignals"][value="${sellSignal}"]`);
            if (sellSignalRadio) sellSignalRadio.checked = true;

            // 平仓成交量已移除，不再需要回填

            document.getElementById('positionSize').value = strategy.positionSize;
            document.getElementById('maxPositions').value = strategy.maxPositions || '';
            document.getElementById('maxLongPositions').value = strategy.maxLongPositions || '';
            document.getElementById('maxShortPositions').value = strategy.maxShortPositions || '';
            
            // 止损止盈
            document.getElementById('stopLoss').value = strategy.stopLoss || '';
            document.getElementById('takeProfit').value = strategy.takeProfit || '';
            
            // MA10/EMA10 同向过滤
            document.getElementById('ma10Ema10TrendFilter').checked = strategy.ma10Ema10TrendFilter === true;

            // 信号强度过滤
            if (strategy.minSignalStrength) {
                document.getElementById('minSignalStrength_ema9_26').value = strategy.minSignalStrength.ema9_26 || '';
                document.getElementById('minSignalStrength_ma10_ema10').value = strategy.minSignalStrength.ma10_ema10 || '';
            } else {
                document.getElementById('minSignalStrength_ema9_26').value = '';
                document.getElementById('minSignalStrength_ma10_ema10').value = '';
            }
            
            // 趋势持续性检查
            document.getElementById('trendConfirmBars').value = strategy.trendConfirmBars || '';
            if (document.getElementById('trendConfirmEMAThreshold')) {
                document.getElementById('trendConfirmEMAThreshold').value = strategy.trendConfirmEMAThreshold || '';
            }
            
            // 趋势反转退出机制
            document.getElementById('exitOnMAFlip').checked = strategy.exitOnMAFlip === true;
            if (document.getElementById('exitOnMAFlipThreshold')) {
                document.getElementById('exitOnMAFlipThreshold').value = strategy.exitOnMAFlipThreshold || '0.1';
            }
            document.getElementById('exitOnEMAWeak').checked = strategy.exitOnEMAWeak === true;
            if (document.getElementById('exitOnEMAWeakThreshold')) {
                document.getElementById('exitOnEMAWeakThreshold').value = strategy.exitOnEMAWeakThreshold || '0.05';
            }
            if (document.getElementById('earlyStopLossPct')) {
                document.getElementById('earlyStopLossPct').value = strategy.earlyStopLossPct || '';
            }
            
            // 风险控制
            if (document.getElementById('preventDuplicateEntry')) {
                document.getElementById('preventDuplicateEntry').checked = strategy.preventDuplicateEntry === true;
            }
            if (document.getElementById('minHoldingTimeHours')) {
                document.getElementById('minHoldingTimeHours').value = strategy.minHoldingTimeHours || '';
            }
            if (document.getElementById('closeOppositeOnEntry')) {
                document.getElementById('closeOppositeOnEntry').checked = strategy.closeOppositeOnEntry === true;
            }
            
            // 技术指标过滤器
            if (strategy.rsiFilter) {
                if (document.getElementById('rsiFilterEnabled')) {
                    document.getElementById('rsiFilterEnabled').checked = strategy.rsiFilter.enabled === true;
                    document.getElementById('rsiLongMax').value = strategy.rsiFilter.longMax || 70;
                    document.getElementById('rsiShortMin').value = strategy.rsiFilter.shortMin || 30;
                }
            }
            if (strategy.macdFilter) {
                if (document.getElementById('macdFilterEnabled')) {
                    document.getElementById('macdFilterEnabled').checked = strategy.macdFilter.enabled === true;
                    document.getElementById('macdLongRequirePositive').checked = strategy.macdFilter.longRequirePositive !== false;
                    document.getElementById('macdShortRequireNegative').checked = strategy.macdFilter.shortRequireNegative !== false;
                }
            }
            if (strategy.kdjFilter) {
                if (document.getElementById('kdjFilterEnabled')) {
                    document.getElementById('kdjFilterEnabled').checked = strategy.kdjFilter.enabled === true;
                    document.getElementById('kdjLongMaxK').value = strategy.kdjFilter.longMaxK || 80;
                    document.getElementById('kdjShortMinK').value = strategy.kdjFilter.shortMinK || 20;
                }
            }
            
            // 做多价格
            if (strategy.longPrice) {
                const longPriceRadio = document.querySelector(`input[name="longPrice"][value="${strategy.longPrice}"]`);
                if (longPriceRadio) longPriceRadio.checked = true;
            }
            
            // 做空价格
            if (strategy.shortPrice) {
                const shortPriceRadio = document.querySelector(`input[name="shortPrice"][value="${strategy.shortPrice}"]`);
                if (shortPriceRadio) shortPriceRadio.checked = true;
            }
            
            // 显示Modal表单
            showAddStrategyModal();
            
            // 更新币种选择
            loadAvailableSymbols().then(() => {
                // 清除所有币种选择
                document.querySelectorAll('input[name="symbols"]').forEach(cb => cb.checked = false);
                // 选中策略中的币种
                if (strategy.symbols && Array.isArray(strategy.symbols)) {
                    strategy.symbols.forEach(symbol => {
                        const checkbox = document.getElementById(`symbol_${symbol.replace('/', '_')}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            });
        }

        // 显示自定义确认对话框
        function showConfirmDialog(title, message, type = 'warning') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'confirm-modal-overlay';
                
                const iconConfig = {
                    'warning': { icon: 'exclamation-triangle-fill', color: 'var(--warning-yellow)', bg: 'rgba(245, 158, 11, 0.2)', border: 'rgba(245, 158, 11, 0.3)' },
                    'danger': { icon: 'x-circle-fill', color: 'var(--danger-red)', bg: 'rgba(239, 68, 68, 0.2)', border: 'rgba(239, 68, 68, 0.3)' },
                    'info': { icon: 'info-circle-fill', color: 'var(--info-blue)', bg: 'rgba(59, 130, 246, 0.2)', border: 'rgba(59, 130, 246, 0.3)' }
                };
                const config = iconConfig[type] || iconConfig['warning'];
                
                overlay.innerHTML = `
                    <div class="confirm-modal-dialog">
                        <div class="confirm-modal-header">
                            <div class="confirm-modal-title">
                                <div class="confirm-modal-icon" style="background: linear-gradient(135deg, ${config.bg} 0%, ${config.bg.replace('0.2', '0.1')} 100%); border: 2px solid ${config.border};">
                                    <i class="bi bi-${config.icon}" style="font-size: 24px; color: ${config.color};"></i>
                                </div>
                                <span>${title}</span>
                            </div>
                        </div>
                        <div class="confirm-modal-body">
                            ${message}
                        </div>
                        <div class="confirm-modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel-btn" style="min-width: 100px;">
                                <i class="bi bi-x-circle"></i> 取消
                            </button>
                            <button class="btn btn-danger" id="modal-confirm-btn" style="min-width: 100px;">
                                <i class="bi bi-check-circle"></i> 确定
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const cancelBtn = overlay.querySelector('#modal-cancel-btn');
                const confirmBtn = overlay.querySelector('#modal-confirm-btn');
                const dialog = overlay.querySelector('.confirm-modal-dialog');
                
                const closeModal = (result) => {
                    dialog.style.animation = 'slideUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                    overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                    setTimeout(() => {
                        overlay.remove();
                        resolve(result);
                    }, 300);
                };
                
                cancelBtn.addEventListener('click', () => closeModal(false));
                confirmBtn.addEventListener('click', () => closeModal(true));
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(false);
                    }
                });
                
                // ESC键关闭
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            });
        }

        // 删除策略
        async function deleteStrategy(id) {
            // 确保 ID 类型一致
            const strategyId = typeof id === 'string' ? parseInt(id) : id;
            const strategy = strategies.find(s => {
                const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                return sId === strategyId;
            });
            
            if (!strategy) {
                showToast('策略未找到', 'error');
                return;
            }
            
            // 使用自定义确认对话框
            const confirmed = await showConfirmDialog(
                '删除策略',
                `确定要删除策略 <strong style="color: var(--text-primary);">"${strategy.name}"</strong> 吗？<br><br>此操作不可恢复，请谨慎操作。`,
                'danger'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                // 直接调用 DELETE API 删除策略
                const response = await fetch(`/api/futures/strategies/${strategyId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // 从前端数组中移除
                    strategies = strategies.filter(s => {
                        const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                        return sId !== strategyId;
                    });
                    
                    // 如果删除的是当前正在编辑的策略，重置编辑状态
                    if (editingStrategyId === strategyId) {
                        editingStrategyId = null;
                    }
                    
                    // 重新加载策略列表
                    loadStrategies();
                    showToast(`策略 "${strategy.name}" 已删除`, 'success');
                } else {
                    showToast(result.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除策略失败:', error);
                showToast('删除策略失败: ' + (error.message || '未知错误'), 'error');
            }
        }

        // 测试策略（24小时回测）
        async function testStrategy(id) {
            // 确保 ID 类型一致
            const strategyId = typeof id === 'string' ? parseInt(id) : id;
            const strategy = strategies.find(s => {
                const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                return sId === strategyId;
            });
            
            if (!strategy) {
                showToast('策略不存在', 'error');
                return;
            }
            
            if (!strategy.symbols || strategy.symbols.length === 0) {
                showToast('策略未配置交易币种，无法测试', 'warning');
                return;
            }
            
            // 显示加载提示（优化版）
            const loadingModal = document.createElement('div');
            loadingModal.id = 'testLoadingModal';
            loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(13, 17, 23, 0.85); backdrop-filter: blur(4px); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            loadingModal.innerHTML = `
                <div style="background: var(--bg-card, #1C2128); border: 1px solid var(--border-default, #30363D); border-radius: 16px; padding: 40px 50px; text-align: center; max-width: 500px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); animation: fadeIn 0.3s ease-out;">
                    <div style="margin-bottom: 24px; position: relative; display: inline-block;">
                        <div id="testSpinner" style="width: 48px; height: 48px; border: 4px solid rgba(43, 111, 237, 0.2); border-top-color: var(--primary-blue, #2B6FED); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto;">
                        </div>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 32px; height: 32px; border: 3px solid rgba(43, 111, 237, 0.1); border-top-color: var(--primary-blue, #2B6FED); border-radius: 50%; animation: spin 0.6s linear infinite reverse;">
                        </div>
                    </div>
                    <h3 style="color: var(--text-primary, #E6EDF3); font-size: 18px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="bi bi-graph-up-arrow" style="color: var(--primary-blue, #2B6FED);"></i>
                        正在测试策略
                    </h3>
                    <p style="color: var(--text-secondary, #8B949E); font-size: 14px; margin-bottom: 20px; font-weight: 500;">${strategy.name || '策略测试'}</p>
                    <div style="background: var(--bg-tertiary, #21262D); border-radius: 8px; padding: 14px; margin-top: 20px; border: 1px solid var(--border-default, #30363D);">
                        <div style="color: var(--text-secondary, #8B949E); font-size: 12px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="bi bi-calendar-range" style="font-size: 14px;"></i>
                            测试时间范围
                        </div>
                        <div style="color: var(--text-primary, #E6EDF3); font-size: 14px; font-weight: 600;">最近24小时数据</div>
                    </div>
                    <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-default, #30363D);">
                        <div style="color: var(--text-tertiary, #6E7681); font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                            <i class="bi bi-hourglass-split" style="font-size: 14px; animation: pulse 2s ease-in-out infinite;"></i>
                            <span>正在计算技术指标和模拟交易...</span>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; transform: scale(0.95); }
                        to { opacity: 1; transform: scale(1); }
                    }
                    @keyframes pulse {
                        0%, 100% { opacity: 0.6; }
                        50% { opacity: 1; }
                    }
                </style>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                const response = await fetch('/api/strategy/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(strategy)
                });
                
                const result = await response.json();
                
                // 移除加载模态框
                if (document.body.contains(loadingModal)) {
                    document.body.removeChild(loadingModal);
                }
                
                if (!result.success) {
                    showToast('测试失败：' + (result.error || '未知错误'), 'error');
                    return;
                }
                
                // 显示测试结果
                showTestResults(strategy.name, result.data);
                
            } catch (error) {
                // 移除加载模态框
                if (document.body.contains(loadingModal)) {
                    document.body.removeChild(loadingModal);
                }
                console.error('测试策略失败:', error);
                showToast('测试失败：' + error.message, 'error');
            }
        }

        // 显示测试结果
        function showTestResults(strategyName, results) {
            // 如果已存在模态框，先移除
            const existingModal = document.getElementById('testResultsModal');
            if (existingModal) {
                document.body.removeChild(existingModal);
            }
            
            const modal = document.createElement('div');
            modal.id = 'testResultsModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto;';
            
            // 点击背景关闭
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            let resultsHtml = results.map(result => {
                if (result.error) {
                    return `
                        <div style="margin-bottom: 24px; padding: 20px; background: #fff3cd; border-radius: 10px; border-left: 5px solid #ffc107; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <h5 style="color: #856404; margin: 0 0 12px 0; font-size: 18px; font-weight: 600;">${result.symbol}</h5>
                            <p style="color: #856404; margin: 0; font-size: 15px; line-height: 1.6;">${result.error}</p>
                        </div>
                    `;
                }
                
                const pnlClass = result.total_pnl >= 0 ? 'text-success' : 'text-danger';
                const pnlIcon = result.total_pnl >= 0 ? '▲' : '▼';
                
                // 统计数据
                const buyCount = result.trades ? result.trades.filter(t => t.type === 'BUY').length : 0;
                const sellCount = result.trades ? result.trades.filter(t => t.type === 'SELL').length : 0;
                // 统计盈亏：只统计平仓交易（SELL类型）
                const sellTrades = result.trades ? result.trades.filter(t => t.type === 'SELL') : [];
                const winTrades = sellTrades.filter(t => t.pnl > 0).length;
                const lossTrades = sellTrades.filter(t => t.pnl < 0).length;
                const breakEvenTrades = sellTrades.filter(t => t.pnl === 0 || (t.pnl !== undefined && Math.abs(t.pnl) < 0.01)).length;
                const winRate = (winTrades + lossTrades) > 0 ? ((winTrades / (winTrades + lossTrades)) * 100).toFixed(1) : '0.0';
                
                // 调试信息：检查是否有pnl为0或未定义的情况
                if (sellTrades.length > 0) {
                    const pnlValues = sellTrades.map(t => t.pnl).filter(p => p !== undefined);
                    const hasZeroPnl = sellTrades.some(t => t.pnl === 0 || (t.pnl !== undefined && Math.abs(t.pnl) < 0.01));
                    const hasUndefinedPnl = sellTrades.some(t => t.pnl === undefined || t.pnl === null);
                    console.log('平仓交易统计:', {
                        total: sellTrades.length,
                        win: winTrades,
                        loss: lossTrades,
                        breakEven: breakEvenTrades,
                        hasZeroPnl: hasZeroPnl,
                        hasUndefinedPnl: hasUndefinedPnl,
                        pnlValues: pnlValues.slice(0, 5) // 只显示前5个
                    });
                }
                
                let tradesHtml = '';
                if (result.trades && result.trades.length > 0) {
                    tradesHtml = `
                        <div style="margin-top: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid #dee2e6;">
                                <h6 style="margin: 0; font-size: 16px; font-weight: 600; color: #212529;">交易记录 (共 ${result.trades.length} 笔)</h6>
                                <div style="font-size: 14px; font-weight: 500;">
                                    <span style="color: #28a745; margin-right: 12px; font-weight: 600;">买入: ${buyCount}</span>
                                    <span style="color: #dc3545; margin-right: 12px; font-weight: 600;">平仓: ${sellCount}</span>
                                    <span style="color: ${parseFloat(winRate) >= 50 ? '#28a745' : '#dc3545'}; font-weight: 600;">胜率: ${winRate}%</span>
                                </div>
                            </div>
                            <div style="max-height: 500px; overflow-y: auto; overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px; background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);">
                                <table class="table table-sm table-hover" style="font-size: 13px; margin: 0; min-width: 100%; background: transparent;">
                                    <thead style="position: sticky; top: 0; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); z-index: 10; border-bottom: 2px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        <tr>
                                            <th style="padding: 14px 12px; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">时间</th>
                                            <th style="padding: 14px 12px; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">类型</th>
                                            <th style="padding: 14px 12px; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">方向</th>
                                            <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">价格</th>
                                            <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">数量</th>
                                            <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">盈亏</th>
                                            <th style="padding: 14px 12px; text-align: right; font-weight: 600; color: #212529; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap;">余额</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.trades.map((trade, idx) => `
                                            <tr style="border-bottom: 1px solid #e9ecef; transition: background-color 0.15s ease; background: ${idx % 2 === 0 ? 'white' : '#f8f9fa'};" onmouseover="this.style.backgroundColor='#e9ecef'" onmouseout="this.style.backgroundColor='${idx % 2 === 0 ? 'white' : '#f8f9fa'}'">
                                                <td style="padding: 14px 12px; white-space: nowrap; color: #212529; font-size: 13px; font-weight: 500;">${(() => {
                                                    // 处理时间显示：如果已经是字符串格式（YYYY-MM-DD HH:MM:SS），直接显示
                                                    // 如果是ISO格式或其他格式，转换为本地时间显示
                                                    if (typeof trade.time === 'string') {
                                                        // 如果是 'YYYY-MM-DD HH:MM:SS' 格式，直接显示
                                                        if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(trade.time)) {
                                                            return trade.time;
                                                        }
                                                        // 如果是ISO格式，转换为本地时间
                                                        const date = new Date(trade.time);
                                                        if (!isNaN(date.getTime())) {
                                                            return date.toLocaleString('zh-CN', {
                                                                year: 'numeric',
                                                                month: '2-digit',
                                                                day: '2-digit',
                                                                hour: '2-digit',
                                                                minute: '2-digit',
                                                                second: '2-digit',
                                                                timeZone: 'Asia/Shanghai'
                                                            });
                                                        }
                                                        return trade.time;
                                                    }
                                                    // 如果是Date对象或其他格式
                                                    const date = new Date(trade.time);
                                                    if (!isNaN(date.getTime())) {
                                                        return date.toLocaleString('zh-CN', {
                                                            year: 'numeric',
                                                            month: '2-digit',
                                                            day: '2-digit',
                                                            hour: '2-digit',
                                                            minute: '2-digit',
                                                            second: '2-digit',
                                                            timeZone: 'Asia/Shanghai'
                                                        });
                                                    }
                                                    return trade.time || '-';
                                                })()}</td>
                                                <td style="padding: 14px 12px;">
                                                    <span class="badge ${trade.type === 'BUY' ? 'bg-success' : 'bg-danger'}" style="font-size: 11px; padding: 5px 10px; font-weight: 600; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; background: ${trade.type === 'BUY' ? '#28a745' : '#dc3545'}; color: white; border: none;">
                                                        ${trade.type === 'BUY' ? '买入' : '平仓'}
                                                    </span>
                                                </td>
                                                <td style="padding: 14px 12px;">
                                                    <span style="color: ${trade.direction === 'long' ? '#28a745' : '#dc3545'}; font-weight: 600; font-size: 13px; padding: 4px 8px; background: ${trade.direction === 'long' ? '#d4edda' : '#f8d7da'}; border-radius: 4px; border: 1px solid ${trade.direction === 'long' ? '#c3e6cb' : '#f5c6cb'};">
                                                        ${trade.direction === 'long' ? '做多' : '做空'}
                                                    </span>
                                                </td>
                                                <td style="padding: 14px 12px; text-align: right; font-family: 'Courier New', 'Consolas', monospace; color: #212529; font-size: 13px; font-weight: 600;">${trade.price.toFixed(4)}</td>
                                                <td style="padding: 14px 12px; text-align: right; font-family: 'Courier New', 'Consolas', monospace; color: #212529; font-size: 13px; font-weight: 600;">${trade.quantity.toFixed(4)}</td>
                                                <td style="padding: 14px 12px; text-align: right; font-family: 'Courier New', 'Consolas', monospace; font-weight: 700; font-size: 13px;">
                                                    ${trade.pnl !== undefined && trade.pnl !== null ? `
                                                        <div style="line-height: 1.4;">
                                                            <div style="font-size: 14px; color: ${trade.pnl >= 0 ? '#28a745' : '#dc3545'};">
                                                                ${trade.pnl >= 0 ? '+' : ''}${trade.pnl.toFixed(2)}
                                                            </div>
                                                            <div style="font-size: 11px; color: ${trade.pnl >= 0 ? '#155724' : '#721c24'}; font-weight: 500;">
                                                                ${trade.pnl_pct !== undefined ? `(${trade.pnl_pct >= 0 ? '+' : ''}${trade.pnl_pct.toFixed(2)}%)` : ''}
                                                            </div>
                                                        </div>
                                                    ` : '<span style="color: #6c757d;">-</span>'}
                                                </td>
                                                <td style="padding: 14px 12px; text-align: right; font-family: 'Courier New', 'Consolas', monospace; color: #212529; font-size: 13px; font-weight: 600;">${trade.balance.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${result.debug_info && result.debug_info.length > 0 ? `
                                <details style="margin-top: 20px; text-align: left;" open>
                                    <summary style="cursor: pointer; color: #0066cc; font-weight: 600; font-size: 15px; padding: 14px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 12px; user-select: none; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)'; this.style.borderColor='#adb5bd';" onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'; this.style.borderColor='#dee2e6';">
                                        <span>📋</span>
                                        <span>查看详细调试信息 (${result.debug_info.length}条)</span>
                                    </summary>
                                    <div style="max-height: 500px; overflow-y: auto; overflow-x: auto; background: #1e1e1e; padding: 16px; border-radius: 8px; font-size: 12px; font-family: 'Courier New', 'Consolas', 'Monaco', monospace; border: 1px solid #333; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);">
                                        ${result.debug_info.map((info, idx) => {
                                            let bgColor = '#1e1e1e';
                                            let textColor = '#d4d4d4';
                                            let borderColor = '#333';
                                            
                                            if (info.includes('✅✅✅')) {
                                                bgColor = '#1e3a1e';
                                                textColor = '#4ade80';
                                                borderColor = '#22c55e';
                                            } else if (info.includes('❌❌❌')) {
                                                bgColor = '#3a1e1e';
                                                textColor = '#f87171';
                                                borderColor = '#ef4444';
                                            } else if (info.includes('✅')) {
                                                bgColor = '#1e2a3a';
                                                textColor = '#60a5fa';
                                                borderColor = '#3b82f6';
                                            } else if (info.includes('⚠️')) {
                                                bgColor = '#3a3a1e';
                                                textColor = '#fbbf24';
                                                borderColor = '#f59e0b';
                                            } else if (info.includes('📊')) {
                                                bgColor = '#1e2a3a';
                                                textColor = '#93c5fd';
                                                borderColor = '#60a5fa';
                                            } else if (info.includes('➖➖➖')) {
                                                bgColor = '#2a1e1e';
                                                textColor = '#fca5a5';
                                                borderColor = '#f87171';
                                            } else if (info.includes('➕➕➕')) {
                                                bgColor = '#1e2a1e';
                                                textColor = '#86efac';
                                                borderColor = '#4ade80';
                                            }
                                            
                                            return `<div style="padding: 10px 14px; margin-bottom: 6px; border-left: 4px solid ${borderColor}; background: ${bgColor}; border-radius: 4px; line-height: 1.7; color: ${textColor}; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='${bgColor === '#1e1e1e' ? '#2a2a2a' : bgColor.replace('1e', '2a')}'" onmouseout="this.style.backgroundColor='${bgColor}'">${info}</div>`;
                                        }).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } else {
                    // 分析未交易的原因
                    let reasonHtml = '';
                    if (result.golden_cross_count === 0 && result.death_cross_count === 0) {
                        reasonHtml = `
                            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 10px; border-left: 5px solid #ffc107; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong style="color: #856404; font-size: 16px; display: block; margin-bottom: 12px;">⚠️ 未检测到EMA金叉或死叉信号</strong>
                                <p style="margin: 0; color: #856404; font-size: 14px; line-height: 1.7;">
                                    在24小时的测试期间，没有出现EMA短期均线上穿或下穿长期均线的情况。
                                    这可能是因为：
                                </p>
                                <ul style="margin: 12px 0 0 24px; color: #856404; font-size: 14px; line-height: 1.8;">
                                    <li>市场处于横盘震荡状态</li>
                                    <li>EMA短期和长期均线一直保持同一方向排列</li>
                                    <li>需要调整EMA参数或选择其他时间周期</li>
                                </ul>
                            </div>
                        `;
                    } else if (result.golden_cross_count > 0 && result.trades_count === 0) {
                        reasonHtml = `
                            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border-radius: 10px; border-left: 5px solid #0c5460; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong style="color: #0c5460; font-size: 16px; display: block; margin-bottom: 12px;">ℹ️ 检测到 ${result.golden_cross_count} 个EMA金叉，但未执行交易</strong>
                                <p style="margin: 0; color: #0c5460; font-size: 14px; line-height: 1.7;">
                                    可能的原因：
                                </p>
                                <ul style="margin: 12px 0 0 24px; color: #0c5460; font-size: 14px; line-height: 1.8;">
                                    ${result.buy_volume_enabled ? `<li>成交量条件未满足（${result.buy_volume_long_enabled !== false ? `做多需要: ≥${result.buy_volume_long || result.buy_volume || 'N/A'}倍` : '做多未启用'}，${result.buy_volume_short_enabled !== false ? `做空需要: ${result.buy_volume_short || 'N/A'}` : '做空未启用'}，实际可能不足）</li>` : ''}
                                    ${!result.buy_directions || result.buy_directions.length === 0 ? '<li>未配置交易方向（做多或做空）</li>' : ''}
                                    <li>查看下方调试信息了解详情</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    tradesHtml = `
                        <div style="margin-top: 24px; padding: 24px; text-align: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 2px dashed #adb5bd; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                            <div style="margin-bottom: 16px;">
                                <i class="bi bi-info-circle" style="font-size: 32px; color: #6c757d; display: block; margin-bottom: 12px;"></i>
                                <p style="color: #495057; margin: 0; font-size: 16px; font-weight: 600;">未检测到任何交易信号</p>
                            </div>
                            ${reasonHtml}
                            <div style="margin-top: 20px; font-size: 14px; color: #495057; text-align: left; background: white; padding: 18px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 12px;">
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">K线数据:</strong> <span style="color: #212529; font-weight: 600; font-size: 14px;">${result.klines_count || 0} 条</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">技术指标:</strong> <span style="color: #212529; font-weight: 600; font-size: 14px;">${result.indicators_count || 0} 条</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">匹配数据:</strong> <span style="color: #212529; font-weight: 600; font-size: 14px;">${result.matched_pairs_count || 0} 条</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">EMA金叉:</strong> <span style="color: #28a745; font-weight: 600; font-size: 14px;">${result.golden_cross_count || 0} 次</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">EMA死叉:</strong> <span style="color: #dc3545; font-weight: 600; font-size: 14px;">${result.death_cross_count || 0} 次</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">交易方向:</strong> <span style="color: #212529; font-weight: 600; font-size: 14px;">${result.buy_directions ? result.buy_directions.map(d => d === 'long' ? '做多' : '做空').join(', ') : '未配置'}</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">买入成交量:</strong> <span style="color: #212529; font-weight: 600; font-size: 14px;">${result.buy_volume_enabled ? 
                                        (() => {
                                            const longText = (result.buy_volume_long_enabled !== false && (result.buy_volume_long || result.buy_volume)) ? 
                                                `做多: ≥${result.buy_volume_long || result.buy_volume}倍` : 
                                                (result.buy_volume_long_enabled === false ? '做多: 未启用' : '做多: 未设置');
                                            const shortText = (result.buy_volume_short_enabled !== false && result.buy_volume_short) ? 
                                                `做空: ${(() => {
                                                    if (result.buy_volume_short === '>1') return '>1倍';
                                                    if (result.buy_volume_short === '0.8-1') return '0.8-1倍';
                                                    if (result.buy_volume_short === '0.6-0.8') return '0.6-0.8倍';
                                                    if (result.buy_volume_short === '<0.6') return '<0.6倍';
                                                    return result.buy_volume_short + '倍';
                                                })()}` : 
                                                (result.buy_volume_short_enabled === false ? '做空: 未启用' : '做空: 未设置');
                                            return `${longText}, ${shortText}`;
                                        })() : '未启用'}</span></div>
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 6px;"><strong style="color: #495057; font-size: 13px;">卖出成交量:</strong> <span style="color: #212529; font-weight: 600; font-size: 14px;">${result.sell_volume_enabled ? (() => {
                                        if (result.sell_volume === '>1') return '>1倍';
                                        if (result.sell_volume === '0.8-1') return '0.8-1倍';
                                        if (result.sell_volume === '0.6-0.8') return '0.6-0.8倍';
                                        if (result.sell_volume === '<0.6') return '<0.6倍';
                                        return result.sell_volume ? (result.sell_volume.startsWith('<') ? result.sell_volume + '倍' : '≤' + result.sell_volume + '倍') : '已启用';
                                    })() : '未启用'}</span></div>
                                </div>
                            </div>
                            ${result.debug_info && result.debug_info.length > 0 ? `
                                <details style="margin-top: 20px; text-align: left;" open>
                                    <summary style="cursor: pointer; color: #0066cc; font-weight: 600; font-size: 15px; padding: 14px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 8px; border: 1px solid #dee2e6; margin-bottom: 12px; user-select: none; transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.background='linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%)'; this.style.borderColor='#adb5bd';" onmouseout="this.style.background='linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'; this.style.borderColor='#dee2e6';">
                                        <span>📋</span>
                                        <span>查看详细调试信息 (${result.debug_info.length}条)</span>
                                    </summary>
                                    <div style="max-height: 400px; overflow-y: auto; overflow-x: auto; background: #1e1e1e; padding: 16px; border-radius: 8px; font-size: 12px; font-family: 'Courier New', 'Consolas', 'Monaco', monospace; border: 1px solid #333; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);">
                                        ${result.debug_info.map((info, idx) => {
                                            let bgColor = '#1e1e1e';
                                            let textColor = '#d4d4d4';
                                            let borderColor = '#333';
                                            
                                            if (info.includes('✅✅✅')) {
                                                bgColor = '#1e3a1e';
                                                textColor = '#4ade80';
                                                borderColor = '#22c55e';
                                            } else if (info.includes('❌❌❌')) {
                                                bgColor = '#3a1e1e';
                                                textColor = '#f87171';
                                                borderColor = '#ef4444';
                                            } else if (info.includes('✅')) {
                                                bgColor = '#1e2a3a';
                                                textColor = '#60a5fa';
                                                borderColor = '#3b82f6';
                                            } else if (info.includes('⚠️')) {
                                                bgColor = '#3a3a1e';
                                                textColor = '#fbbf24';
                                                borderColor = '#f59e0b';
                                            } else if (info.includes('📊')) {
                                                bgColor = '#1e2a3a';
                                                textColor = '#93c5fd';
                                                borderColor = '#60a5fa';
                                            }
                                            
                                            return `<div style="padding: 10px 14px; margin-bottom: 6px; border-left: 4px solid ${borderColor}; background: ${bgColor}; border-radius: 4px; line-height: 1.7; color: ${textColor}; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='${bgColor === '#1e1e1e' ? '#2a2a2a' : bgColor.replace('1e', '2a')}'" onmouseout="this.style.backgroundColor='${bgColor}'">${info}</div>`;
                                        }).join('')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `;
                }
                
                return `
                    <div style="margin-bottom: 28px; padding: 24px; background: white; border-radius: 10px; border-left: 5px solid ${result.total_pnl >= 0 ? '#28a745' : '#dc3545'}; box-shadow: 0 3px 6px rgba(0,0,0,0.12);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e9ecef;">
                            <h5 style="margin: 0; color: #212529; font-size: 20px; font-weight: 600;">${result.symbol}</h5>
                            <span class="badge ${result.total_pnl >= 0 ? 'bg-success' : 'bg-danger'}" style="font-size: 16px; padding: 8px 16px; font-weight: 600;">
                                ${pnlIcon} ${result.total_pnl >= 0 ? '+' : ''}${result.total_pnl_pct.toFixed(2)}%
                            </span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="padding: 18px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
                                <div style="color: #6c757d; font-size: 12px; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">初始资金</div>
                                <div style="font-size: 24px; font-weight: 700; color: #212529; margin-bottom: 4px; font-family: 'Courier New', monospace;">${result.initial_balance.toFixed(2)}</div>
                                <div style="color: #6c757d; font-size: 11px; font-weight: 500;">USDT</div>
                            </div>
                            <div style="padding: 18px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
                                <div style="color: #6c757d; font-size: 12px; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">最终资金</div>
                                <div style="font-size: 24px; font-weight: 700; color: #212529; margin-bottom: 4px; font-family: 'Courier New', monospace;">${result.final_balance.toFixed(2)}</div>
                                <div style="color: #6c757d; font-size: 11px; font-weight: 500;">USDT</div>
                            </div>
                            <div style="padding: 18px; background: linear-gradient(135deg, ${result.total_pnl >= 0 ? '#d4edda' : '#f8d7da'} 0%, ${result.total_pnl >= 0 ? '#c3e6cb' : '#f5c6cb'} 100%); border-radius: 10px; border: 2px solid ${result.total_pnl >= 0 ? '#28a745' : '#dc3545'}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                <div style="color: ${result.total_pnl >= 0 ? '#155724' : '#721c24'}; font-size: 12px; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">总盈亏</div>
                                <div style="font-size: 26px; font-weight: 700; font-family: 'Courier New', monospace;" class="${pnlClass}">
                                    ${pnlIcon} ${result.total_pnl >= 0 ? '+' : ''}${result.total_pnl.toFixed(2)}
                                </div>
                                <div style="color: ${result.total_pnl >= 0 ? '#155724' : '#721c24'}; font-size: 11px; font-weight: 500;">${result.total_pnl_pct >= 0 ? '+' : ''}${result.total_pnl_pct.toFixed(2)}%</div>
                            </div>
                            <div style="padding: 18px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
                                <div style="color: #6c757d; font-size: 12px; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">交易次数</div>
                                <div style="font-size: 24px; font-weight: 700; color: #212529; margin-bottom: 4px; font-family: 'Courier New', monospace;">${result.trades_count}</div>
                                <div style="color: #6c757d; font-size: 11px; font-weight: 500;">${buyCount}买/${sellCount}卖</div>
                            </div>
                            <div style="padding: 18px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
                                <div style="color: #6c757d; font-size: 12px; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">未平仓</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${result.open_positions > 0 ? '#ffc107' : '#6c757d'}; margin-bottom: 4px; font-family: 'Courier New', monospace;">${result.open_positions}</div>
                                <div style="color: #6c757d; font-size: 11px; font-weight: 500;">个持仓</div>
                            </div>
                            <div style="padding: 18px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'">
                                <div style="color: #6c757d; font-size: 12px; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">胜率</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${parseFloat(winRate) >= 50 ? '#28a745' : '#dc3545'}; margin-bottom: 4px; font-family: 'Courier New', monospace;">${winRate}%</div>
                                <div style="color: #6c757d; font-size: 11px; font-weight: 500;">${winTrades}胜/${lossTrades}负</div>
                            </div>
                        </div>
                        ${tradesHtml}
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 0; max-width: 1400px; max-height: 95vh; overflow: hidden; width: 100%; box-shadow: 0 12px 24px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px 32px; border-bottom: 2px solid #e9ecef; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: #212529; font-size: 26px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 28px;">📊</span>
                                <span>策略测试结果</span>
                            </h4>
                            <div style="color: #6c757d; font-size: 15px; font-weight: 500; margin-left: 40px;">${strategyName}</div>
                        </div>
                        <button onclick="document.body.removeChild(document.getElementById('testResultsModal'))" style="background: #f8f9fa; border: 1px solid #dee2e6; font-size: 28px; cursor: pointer; color: #495057; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; font-weight: 300;" onmouseover="this.style.background='#dc3545'; this.style.color='white'; this.style.borderColor='#dc3545';" onmouseout="this.style.background='#f8f9fa'; this.style.color='#495057'; this.style.borderColor='#dee2e6';">&times;</button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 24px 32px;">
                        <div style="margin-bottom: 24px; padding: 18px 20px; background: linear-gradient(135deg, #e7f3ff 0%, #d0e7ff 100%); border-radius: 10px; border-left: 5px solid #0066cc; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                            <strong style="color: #004085; font-size: 15px; display: block; margin-bottom: 8px;">📊 测试说明</strong>
                            <p style="margin: 0; color: #004085; font-size: 14px; line-height: 1.7;">
                                基于过去24小时的历史数据，模拟策略交易并计算盈亏。初始资金为 10,000 USDT。测试会根据EMA金叉/死叉信号和成交量条件自动执行买入/卖出操作。
                            </p>
                        </div>
                        ${resultsHtml || '<p style="text-align: center; color: #6c757d; padding: 50px; font-size: 16px;">暂无测试结果</p>'}
                    </div>
                    <div style="padding: 20px 32px; border-top: 2px solid #e9ecef; background: #f8f9fa; text-align: center;">
                        <button onclick="document.body.removeChild(document.getElementById('testResultsModal'))" class="btn btn-primary" style="padding: 12px 48px; font-size: 15px; font-weight: 600; border-radius: 8px; background: #0066cc; border: none; color: white; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#0052a3'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#0066cc'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 添加ESC键关闭功能
            const escHandler = function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('testResultsModal');
                    if (modal) {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', escHandler);
                    }
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // 查看测试历史
        async function viewTestHistory(id) {
            // 确保 ID 类型一致
            const strategyId = typeof id === 'string' ? parseInt(id) : id;
            const strategy = strategies.find(s => {
                const sId = typeof s.id === 'string' ? parseInt(s.id) : s.id;
                return sId === strategyId;
            });
            
            if (!strategy) {
                showToast('策略未找到', 'error');
                return;
            }
            
            const strategyName = strategy.name;
            try {
                const response = await fetch(`/api/strategy/test/history?strategy_id=${strategyId}&page=1&page_size=20`);
                const result = await response.json();
                
                if (!result.success) {
                    showToast('获取测试历史失败：' + (result.error || '未知错误'), 'error');
                    return;
                }
                
                showTestHistoryModal(result.data, result.pagination, strategyId);
            } catch (error) {
                console.error('获取测试历史失败:', error);
                showToast('获取测试历史失败：' + error.message, 'error');
            }
        }

        // 显示测试历史模态框
        function showTestHistoryModal(historyList, pagination, strategyId) {
            const existingModal = document.getElementById('testHistoryModal');
            if (existingModal) {
                document.body.removeChild(existingModal);
            }
            
            const modal = document.createElement('div');
            modal.id = 'testHistoryModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto;';
            
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
            
            const historyHtml = historyList.length > 0 ? historyList.map(item => {
                const pnlClass = (item.total_pnl_percent || 0) >= 0 ? 'text-success' : 'text-danger';
                const pnlIcon = (item.total_pnl_percent || 0) >= 0 ? '▲' : '▼';
                
                return `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;" 
                         onmouseover="this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'" 
                         onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 8px 0; color: #212529; font-size: 18px; font-weight: 600;">${item.strategy_name || '未命名策略'}</h5>
                                <div style="color: #6c757d; font-size: 13px; margin-bottom: 4px;">
                                    <i class="bi bi-calendar"></i> ${item.test_start_time} 至 ${item.test_end_time}
                                </div>
                                <div style="color: #6c757d; font-size: 13px;">
                                    <i class="bi bi-clock"></i> 测试时长: ${item.test_duration_hours ? item.test_duration_hours.toFixed(2) : 'N/A'} 小时
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: 700; color: ${pnlClass === 'text-success' ? '#28a745' : '#dc3545'}; margin-bottom: 4px;">
                                    ${pnlIcon} ${item.total_pnl_percent ? item.total_pnl_percent.toFixed(2) : '0.00'}%
                                </div>
                                <div style="color: #6c757d; font-size: 12px;">
                                    ${item.total_pnl ? (item.total_pnl >= 0 ? '+' : '') + item.total_pnl.toFixed(2) : '0.00'} USDT
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e9ecef;">
                            <div style="text-align: center;">
                                <div style="color: #6c757d; font-size: 11px; margin-bottom: 4px;">交易对</div>
                                <div style="font-size: 16px; font-weight: 600; color: #212529;">${item.total_symbols || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #6c757d; font-size: 11px; margin-bottom: 4px;">总交易</div>
                                <div style="font-size: 16px; font-weight: 600; color: #212529;">${item.total_trades || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #6c757d; font-size: 11px; margin-bottom: 4px;">胜率</div>
                                <div style="font-size: 16px; font-weight: 600; color: ${(item.win_rate || 0) >= 50 ? '#28a745' : '#dc3545'};">${item.win_rate ? item.win_rate.toFixed(1) : '0.0'}%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #6c757d; font-size: 11px; margin-bottom: 4px;">最终余额</div>
                                <div style="font-size: 16px; font-weight: 600; color: #212529;">${item.final_balance ? item.final_balance.toFixed(2) : '0.00'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: #6c757d; font-size: 12px;">
                                <i class="bi bi-info-circle"></i> 测试时间: ${item.created_at || 'N/A'}
                            </div>
                            <button onclick="viewTestDetail(${item.id})" class="btn btn-sm btn-primary" style="padding: 6px 16px; font-size: 13px; border-radius: 6px; background: #0066cc; border: none; color: white; cursor: pointer;">
                                <i class="bi bi-eye"></i> 查看详情
                            </button>
                        </div>
                    </div>
                `;
            }).join('') : '<div style="text-align: center; padding: 50px; color: #6c757d; font-size: 16px;">暂无测试历史记录</div>';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 0; max-width: 1000px; max-height: 90vh; overflow: hidden; width: 100%; box-shadow: 0 12px 24px rgba(0,0,0,0.2); display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 24px 32px; border-bottom: 2px solid #e9ecef; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                        <h4 style="margin: 0; color: #212529; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <i class="bi bi-clock-history"></i>
                            <span>测试历史记录</span>
                        </h4>
                        <button onclick="document.body.removeChild(document.getElementById('testHistoryModal'))" style="background: #f8f9fa; border: 1px solid #dee2e6; font-size: 28px; cursor: pointer; color: #495057; line-height: 1; padding: 0; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; font-weight: 300;" onmouseover="this.style.background='#dc3545'; this.style.color='white'; this.style.borderColor='#dc3545';" onmouseout="this.style.background='#f8f9fa'; this.style.color='#495057'; this.style.borderColor='#dee2e6';">&times;</button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 24px 32px;">
                        ${historyHtml}
                    </div>
                    ${pagination && pagination.total_pages > 1 ? `
                        <div style="padding: 20px 32px; border-top: 2px solid #e9ecef; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: #6c757d; font-size: 14px;">
                                共 ${pagination.total} 条记录，第 ${pagination.page} / ${pagination.total_pages} 页
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadTestHistoryPage(${strategyId}, ${pagination.page - 1})" 
                                        ${pagination.page <= 1 ? 'disabled' : ''} 
                                        class="btn btn-sm btn-secondary" 
                                        style="padding: 6px 16px; font-size: 13px; border-radius: 6px; ${pagination.page <= 1 ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                                    上一页
                                </button>
                                <button onclick="loadTestHistoryPage(${strategyId}, ${pagination.page + 1})" 
                                        ${pagination.page >= pagination.total_pages ? 'disabled' : ''} 
                                        class="btn btn-sm btn-secondary" 
                                        style="padding: 6px 16px; font-size: 13px; border-radius: 6px; ${pagination.page >= pagination.total_pages ? 'opacity: 0.5; cursor: not-allowed;' : 'cursor: pointer;'}">
                                    下一页
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 加载测试历史分页
        async function loadTestHistoryPage(strategyId, page) {
            try {
                const response = await fetch(`/api/strategy/test/history?strategy_id=${strategyId}&page=${page}&page_size=20`);
                const result = await response.json();
                
                if (!result.success) {
                    showToast('获取测试历史失败：' + (result.error || '未知错误'), 'error');
                    return;
                }
                
                showTestHistoryModal(result.data, result.pagination, strategyId);
            } catch (error) {
                console.error('获取测试历史失败:', error);
                showToast('获取测试历史失败：' + error.message, 'error');
            }
        }

        // 查看测试详情
        async function viewTestDetail(testResultId) {
            try {
                const response = await fetch(`/api/strategy/test/history/${testResultId}`);
                const result = await response.json();
                
                if (!result.success) {
                    showToast('获取测试详情失败：' + (result.error || '未知错误'), 'error');
                    return;
                }
                
                // 关闭历史模态框
                const historyModal = document.getElementById('testHistoryModal');
                if (historyModal) {
                    document.body.removeChild(historyModal);
                }
                
                // 显示测试结果（使用已有的showTestResults函数）
                const details = result.data.details || [];
                const testData = details.map(d => {
                    // 优先使用 test_result_data，如果没有则从 debug_info 重建
                    if (d.test_result_data) {
                        // 如果 test_result_data 中没有 debug_info，但数据库中有，则合并
                        if (d.debug_info && (!d.test_result_data.debug_info || d.test_result_data.debug_info.length === 0)) {
                            d.test_result_data.debug_info = Array.isArray(d.debug_info) ? d.debug_info : JSON.parse(d.debug_info || '[]');
                        }
                        return d.test_result_data;
                    } else if (d.debug_info) {
                        // 如果没有 test_result_data，但有 debug_info，创建一个基本结构
                        const debugInfo = Array.isArray(d.debug_info) ? d.debug_info : JSON.parse(d.debug_info || '[]');
                        return {
                            symbol: d.symbol,
                            error: d.error_message,
                            debug_info: debugInfo,
                            trades: [],
                            trades_count: d.trades_count || 0
                        };
                    }
                    return null;
                }).filter(d => d);
                
                if (testData.length > 0) {
                    showTestResults(result.data.main.strategy_name, testData);
                } else {
                    showToast('该测试记录没有详细数据', 'warning');
                }
            } catch (error) {
                console.error('获取测试详情失败:', error);
                showToast('获取测试详情失败：' + error.message, 'error');
            }
        }

        // 更新空状态显示
        function updateEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const strategyList = document.getElementById('futuresStrategyList');
            if (strategies.length === 0 && document.getElementById('addStrategyForm').style.display === 'none') {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        }

        // 加载策略执行清单
        async function loadExecutionList() {
            const container = document.getElementById('executionListContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="placeholder-content"><div class="placeholder-icon"><i class="bi bi-hourglass-split"></i></div><div class="placeholder-text">正在加载执行记录...</div></div>';
            
            try {
                const marketType = document.getElementById('executionMarketType')?.value || 'all';
                const actionType = document.getElementById('executionActionType')?.value || 'all';
                const status = document.getElementById('executionStatus')?.value || 'all';
                const symbol = document.getElementById('executionSymbol')?.value || '';
                const timeRange = document.getElementById('executionTimeRange')?.value || '30d';
                
                // 构建查询参数
                const params = new URLSearchParams();
                if (marketType !== 'all') params.append('market_type', marketType);
                if (actionType !== 'all') params.append('action_type', actionType);
                if (status !== 'all') params.append('status', status);
                if (symbol) params.append('symbol', symbol);
                if (timeRange) params.append('time_range', timeRange);
                
                const response = await fetch(`/api/strategy/execution/list?${params.toString()}`);
                const result = await response.json();
                
                if (!result.success) {
                    container.innerHTML = `<div class="placeholder-content"><div class="placeholder-icon" style="color: var(--danger-red);"><i class="bi bi-exclamation-triangle"></i></div><div class="placeholder-text">加载失败</div><div class="placeholder-subtext">${result.error || '未知错误'}</div></div>`;
                    return;
                }
                
                const executions = result.data || [];
                
                if (executions.length === 0) {
                    container.innerHTML = '<div class="placeholder-content"><div class="placeholder-icon"><i class="bi bi-inbox"></i></div><div class="placeholder-text">暂无执行记录</div><div class="placeholder-subtext">策略执行记录将显示在这里</div></div>';
                    return;
                }
                
                // 渲染执行记录列表
                container.innerHTML = executions.map(item => {
                    const actionIcon = item.action === 'buy' || item.action === 'BUY' || item.action === 'OPEN' || item.action === 'LONG' || item.action === 'SHORT' 
                        ? '<i class="bi bi-arrow-down-circle" style="color: var(--success-green);"></i>' 
                        : '<i class="bi bi-arrow-up-circle" style="color: var(--danger-red);"></i>';
                    const actionText = item.action === 'buy' || item.action === 'BUY' || item.action === 'OPEN' || item.action === 'LONG' 
                        ? '买入/开仓' 
                        : item.action === 'SHORT' ? '做空' : '卖出/平仓';
                    const statusColor = item.status === 'FILLED' ? 'var(--success-green)' : item.status === 'PENDING' ? 'var(--warning-yellow)' : 'var(--text-secondary)';
                    const marketTypeText = item.market_type === 'test' ? '测试' : item.market_type === 'futures' ? '合约' : '现货';
                    
                    return `
                        <div class="strategy-item" style="margin-bottom: var(--spacing-md);">
                            <div class="strategy-item-header">
                                <div class="strategy-item-title">
                                    ${actionIcon} ${actionText} - ${item.symbol || 'N/A'}
                                </div>
                                <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                                    <span style="padding: 4px 12px; background: ${statusColor}20; color: ${statusColor}; border-radius: var(--radius-sm); font-size: 12px; font-weight: 600;">
                                        ${item.status || 'N/A'}
                                    </span>
                                </div>
                            </div>
                            <div class="strategy-item-body">
                                ${item.strategy_name ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">策略名称</div>
                                    <div class="strategy-item-field-value">${item.strategy_name}</div>
                                </div>
                                ` : ''}
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">类型</div>
                                    <div class="strategy-item-field-value">${marketTypeText}</div>
                                </div>
                                ${item.direction ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">方向</div>
                                    <div class="strategy-item-field-value">${item.direction === 'long' ? '做多' : '做空'}</div>
                                </div>
                                ` : ''}
                                ${item.action === 'sell' && item.entry_price ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">开仓价</div>
                                    <div class="strategy-item-field-value">${parseFloat(item.entry_price).toFixed(4)}</div>
                                </div>
                                ` : ''}
                                ${item.action === 'sell' && item.exit_price ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">平仓价</div>
                                    <div class="strategy-item-field-value">${parseFloat(item.exit_price).toFixed(4)}</div>
                                </div>
                                ` : ''}
                                ${item.action === 'buy' ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">价格</div>
                                    <div class="strategy-item-field-value">${item.price ? parseFloat(item.price).toFixed(4) : 'N/A'}</div>
                                </div>
                                ` : ''}
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">数量</div>
                                    <div class="strategy-item-field-value">${item.quantity ? parseFloat(item.quantity).toFixed(4) : 'N/A'}</div>
                                </div>
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">金额</div>
                                    <div class="strategy-item-field-value">${item.amount ? parseFloat(item.amount).toFixed(2) : 'N/A'} USDT</div>
                                </div>
                                ${item.leverage ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">杠杆</div>
                                    <div class="strategy-item-field-value">${item.leverage}x</div>
                                </div>
                                ` : ''}
                                ${item.pnl !== undefined && item.pnl !== null ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">盈亏</div>
                                    <div class="strategy-item-field-value" style="color: ${parseFloat(item.pnl) >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                        ${parseFloat(item.pnl) >= 0 ? '+' : ''}${parseFloat(item.pnl).toFixed(2)} USDT
                                    </div>
                                </div>
                                ` : ''}
                                ${item.fee ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">手续费</div>
                                    <div class="strategy-item-field-value">${parseFloat(item.fee).toFixed(4)} USDT</div>
                                </div>
                                ` : ''}
                                ${item.reason ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">交易原因</div>
                                    <div class="strategy-item-field-value">${item.reason}</div>
                                </div>
                                ` : ''}
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">时间</div>
                                    <div class="strategy-item-field-value">${item.created_at || 'N/A'}</div>
                                </div>
                                ${item.order_source ? `
                                <div class="strategy-item-field">
                                    <div class="strategy-item-field-label">来源</div>
                                    <div class="strategy-item-field-value">${item.order_source}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('加载执行清单失败:', error);
                container.innerHTML = `<div class="placeholder-content"><div class="placeholder-icon" style="color: var(--danger-red);"><i class="bi bi-exclamation-triangle"></i></div><div class="placeholder-text">加载失败</div><div class="placeholder-subtext">${error.message}</div></div>`;
            }
        }
        
        // 刷新执行清单
        function refreshExecutionList() {
            loadExecutionList();
        }

        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            console.log('交易策略页面加载完成');
        });
    </script>
</body>
</html>

