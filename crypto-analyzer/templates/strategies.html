<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>策略管理 - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; margin-top: var(--spacing-xs); }
        .header-actions { display: flex; gap: var(--spacing-md); align-items: center; }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: 0; }
        /* 左右分栏布局 */
        .main-layout { display: flex; gap: var(--spacing-xl); margin-bottom: var(--spacing-xl); min-height: 600px; }
        .strategy-list-panel { flex: 0 0 350px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-lg); display: flex; flex-direction: column; }
        .strategy-list-header { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-default); }
        .strategy-list-items { flex: 1; overflow-y: auto; }
        .strategy-list-item { background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-sm); cursor: pointer; transition: all var(--transition-base); }
        .strategy-list-item:hover { background: var(--bg-hover); border-color: var(--primary-blue); transform: translateX(4px); }
        .strategy-list-item.selected { background: var(--bg-hover); border-color: var(--primary-blue); border-left: 4px solid var(--primary-blue); }
        .strategy-list-item.active { border-left: 4px solid var(--success-green); }
        .strategy-item-name { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs); display: flex; align-items: center; gap: var(--spacing-sm); }
        .strategy-item-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.4; margin-bottom: var(--spacing-sm); }
        .strategy-item-meta { display: flex; gap: var(--spacing-xs); flex-wrap: wrap; }
        .strategy-detail-panel { flex: 1; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-lg); display: flex; flex-direction: column; }
        .strategy-detail-header { margin-bottom: var(--spacing-md); padding-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-default); }
        .strategy-detail-title { font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-sm); }
        .strategy-detail-description { font-size: 13px; color: var(--text-secondary); line-height: 1.6; margin-bottom: var(--spacing-md); }
        .strategy-detail-content { flex: 1; overflow-y: auto; }
        .strategy-detail-section { margin-bottom: var(--spacing-md); }
        .strategy-detail-section-title { font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-sm); padding-bottom: var(--spacing-xs); border-bottom: 1px solid var(--border-default); }
        .strategy-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-sm); }
        .strategy-detail-card { background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-sm); }
        .strategy-detail-card-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 2px; }
        .strategy-detail-card-value { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .strategy-actions-panel { margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-default); display: flex; gap: var(--spacing-sm); flex-wrap: wrap; }
        .strategy-type-tab { transition: all var(--transition-base); }
        .strategy-type-tab:hover { background: var(--bg-hover) !important; }
        .strategy-type-tab.active { background: var(--primary-blue) !important; color: white !important; }
        
        /* 表单样式 */
        .form-group { margin-bottom: var(--spacing-md); }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 13px; font-family: var(--font-family); transition: all var(--transition-base); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(43, 111, 237, 0.1); }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-textarea { min-height: 60px; resize: vertical; }
        .form-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .form-checkbox-label { display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer; font-size: 13px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--spacing-sm); }
        .form-section { background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-md); margin-bottom: var(--spacing-md); }
        .form-section-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-sm); padding-bottom: var(--spacing-xs); border-bottom: 1px solid var(--border-default); }
        
        /* 标签页样式 */
        .config-tabs { display: flex; gap: var(--spacing-xs); border-bottom: 2px solid var(--border-default); margin-bottom: var(--spacing-lg); overflow-x: auto; }
        .config-tab { padding: var(--spacing-sm) var(--spacing-md); background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-secondary); cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; transition: all var(--transition-base); margin-bottom: -2px; }
        .config-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .config-tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: transparent; }
        .config-tab-content { display: none; }
        .config-tab-content.active { display: block; }
        
        /* 折叠面板样式 */
        .collapsible-section { margin-bottom: var(--spacing-md); }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
        .collapsible-header:hover { background: var(--bg-hover); border-color: var(--primary-blue); }
        .collapsible-header.active { border-color: var(--primary-blue); background: rgba(43, 111, 237, 0.05); }
        .collapsible-title { font-size: 14px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .collapsible-icon { transition: transform var(--transition-base); }
        .collapsible-header.active .collapsible-icon { transform: rotate(180deg); }
        .collapsible-content { display: none; padding: var(--spacing-md); background: var(--bg-secondary); border: 1px solid var(--border-default); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); }
        .collapsible-content.active { display: block; }
        .form-help-text { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }
        .edit-mode-toggle { display: flex; justify-content: flex-end; margin-bottom: var(--spacing-md); }
        .save-actions { display: flex; gap: var(--spacing-sm); justify-content: flex-end; margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-default); }
        .readonly-field { background: var(--bg-secondary); color: var(--text-secondary); }
        
        /* 模态框样式 */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-dialog { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: 0; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-xl); animation: slideUp var(--transition-slow) ease-out; }
        .modal-header { padding: var(--spacing-xl); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 20px; font-weight: 700; color: var(--text-primary); }
        .modal-close { background: transparent; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: var(--radius-md); transition: all var(--transition-base); }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-body { padding: var(--spacing-xl); }
        .modal-footer { padding: var(--spacing-xl); border-top: 1px solid var(--border-default); display: flex; justify-content: flex-end; gap: var(--spacing-md); }
        
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; }
        .badge-success { background: var(--success-green-bg); color: var(--success-green); }
        .badge-danger { background: var(--danger-red-bg); color: var(--danger-red); }
        .badge-warning { background: var(--warning-yellow-bg); color: var(--warning-yellow); }
        .badge-info { background: var(--primary-blue-light); color: var(--primary-blue); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .risk-aggressive { background: rgba(239, 68, 68, 0.2); color: var(--danger-red); }
        .risk-balanced { background: rgba(245, 158, 11, 0.2); color: var(--warning-yellow); }
        .risk-conservative { background: rgba(16, 185, 129, 0.2); color: var(--success-green); }
        .strategy-actions { display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-xs); padding: var(--spacing-sm) var(--spacing-md); font-size: 13px; font-weight: 500; line-height: 1; text-decoration: none; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); white-space: nowrap; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-blue-hover); border-color: var(--primary-blue-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-success { background: var(--success-green); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #DC2626; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--border-muted); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border-color: transparent; }
        .btn-ghost:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
        .btn-sm { padding: var(--spacing-xs) var(--spacing-sm); font-size: 11px; }
        .btn-info { background: var(--info-blue); color: white; }
        .btn-info:hover:not(:disabled) { background: #2563EB; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-warning { background: var(--warning-yellow); color: white; }
        .btn-warning:hover:not(:disabled) { background: #D97706; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .loading { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .loading::after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .error-message { background: var(--danger-red-bg); color: var(--danger-red); padding: var(--spacing-lg); border-radius: var(--radius-md); margin: var(--spacing-xl) 0; border: 1px solid var(--danger-red); }
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg); box-shadow: var(--shadow-xl); z-index: 1000; min-width: 300px; animation: slideInRight 0.3s ease-out; }
        .toast.success { border-left: 4px solid var(--success-green); }
        .toast.error { border-left: 4px solid var(--danger-red); }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-up { animation: slideUp var(--transition-slow) ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .strategy-detail { margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-default); }
        .detail-row { display: flex; justify-content: space-between; padding: var(--spacing-sm) 0; font-size: 13px; }
        .detail-label { color: var(--text-secondary); }
        .detail-value { color: var(--text-primary); font-weight: 500; }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-layout { flex-direction: column; }
            .strategy-list-panel { flex: 1; max-height: 300px; }
            .strategy-detail-panel { min-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <img src="/static/images/logo/alphaflow-logo-icon.svg" alt="AlphaFlow" style="height: 36px; width: auto;">
                        <div>
                            <h1 class="header-title" style="margin: 0;">
                                <i class="bi bi-diagram-3"></i>
                                策略管理
                            </h1>
                            <p class="header-subtitle">智能量化策略 · 风险评估 · 收益优化</p>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-info" onclick="showMungerQuotes()" title="查看查理·芒格投资智慧">
                        <i class="bi bi-quote"></i> 芒格名言
                    </button>
                    <button class="btn btn-ghost" onclick="loadStrategies()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-container slide-up">
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/paper_trading" class="nav-link">
                    <i class="bi bi-journals"></i> 模拟现货
                </a>
                <a href="/futures_trading" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> 模拟合约
                </a>
                <a href="/strategies" class="nav-link active">
                    <i class="bi bi-diagram-3"></i> 策略管理
                </a>
                <a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF 数据
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> 企业金库
                </a>
                <a href="/blockchain_gas" class="nav-link">
                    <i class="bi bi-lightning-charge"></i> Gas统计
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> 数据管理
                </a>
            </div>
        </nav>

        <!-- Loading State -->
        <div id="loadingState" class="loading">正在加载策略数据</div>

        <!-- Error State -->
        <div id="errorState" class="error-message" style="display: none;"></div>

        <!-- Main Content -->
        <div id="mainContent" style="display: none;">
            <div class="main-layout">
                <!-- 左侧：策略列表 -->
                <div class="strategy-list-panel">
                    <div class="strategy-list-header">
                        <i class="bi bi-list-ul"></i> 策略列表
                    </div>
                    <!-- 策略类型切换标签 -->
                    <div style="margin-bottom: var(--spacing-md); display: flex; gap: var(--spacing-xs); background: var(--bg-tertiary); padding: var(--spacing-xs); border-radius: var(--radius-md);">
                        <button class="strategy-type-tab active" id="spotTab" onclick="switchStrategyType('spot')" style="flex: 1; padding: var(--spacing-sm); background: var(--primary-blue); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 600;">
                            <i class="bi bi-currency-exchange"></i> 现货策略
                        </button>
                        <button class="strategy-type-tab" id="futuresTab" onclick="switchStrategyType('futures')" style="flex: 1; padding: var(--spacing-sm); background: transparent; color: var(--text-secondary); border: none; border-radius: var(--radius-sm); cursor: pointer; font-size: 12px; font-weight: 600;">
                            <i class="bi bi-graph-up-arrow"></i> 合约策略
                        </button>
                    </div>
                    <div style="margin-bottom: var(--spacing-md); display: flex; flex-direction: column; gap: var(--spacing-sm);">
                        <button class="btn btn-primary" onclick="showCreateStrategyModal()" style="width: 100%; justify-content: center;">
                            <i class="bi bi-plus-circle"></i> 创建策略
                        </button>
                        <button class="btn btn-primary" onclick="showBacktestModal()" style="width: 100%; justify-content: center;" title="策略回测">
                            <i class="bi bi-graph-up"></i> 回测
                        </button>
                        <button class="btn btn-success" onclick="showAutoGenerateModal()" style="width: 100%; justify-content: center;" title="AI自动生成策略">
                            <i class="bi bi-magic"></i> AI生成策略
                        </button>
                    </div>
                    <div class="strategy-list-items" id="strategyListItems">
                        <!-- 策略列表项将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 右侧：策略详细描述 -->
                <div class="strategy-detail-panel" id="strategyDetailPanel">
                    <div class="empty-state" id="emptyDetailState">
                        <i class="bi bi-info-circle" style="font-size: 48px; color: var(--text-tertiary); margin-bottom: var(--spacing-md);"></i>
                        <div style="color: var(--text-secondary);">请从左侧选择一个策略查看详细信息</div>
                    </div>
                    <div id="strategyDetailContent" style="display: none;">
                        <div class="strategy-detail-header">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm); flex-wrap: wrap; gap: var(--spacing-sm);">
                                <div class="strategy-detail-title" id="detailTitle">
                                    <!-- 策略名称 -->
                                </div>
                                <div style="display: flex; gap: var(--spacing-xs); align-items: center; flex-wrap: wrap;">
                                    <div class="edit-mode-toggle" id="editModeToggle" style="margin-bottom: 0;">
                                        <button class="btn btn-secondary btn-sm" id="editModeBtn" onclick="toggleEditMode()">
                                            <i class="bi bi-pencil"></i> 编辑
                                        </button>
                                    </div>
                                    <button class="btn btn-primary btn-sm" id="backtestBtn" onclick="showBacktestModal()">
                                        <i class="bi bi-graph-up"></i> 回测
                                    </button>
                                    <button class="btn btn-info btn-sm" id="optimalPointsBtn" onclick="showOptimalPointsModal()">
                                        <i class="bi bi-bullseye"></i> 买卖点
                                    </button>
                                    <button class="btn btn-warning btn-sm" id="pricePredictionBtn" onclick="showPricePredictionModal()">
                                        <i class="bi bi-crystal-ball"></i> 预测
                                    </button>
                                    <button class="btn btn-secondary btn-sm" id="tradeDiagnosticBtn" onclick="showTradeDiagnosticModal()">
                                        <i class="bi bi-clipboard-check"></i> 诊断
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="strategy-detail-content" id="detailContent">
                            <!-- 配置标签页 -->
                            <div class="config-tabs" id="configTabs" style="display: none;">
                                <button class="config-tab active" onclick="switchConfigTab('basic')" data-tab="basic">
                                    <i class="bi bi-gear"></i> 基础配置
                                </button>
                                <button class="config-tab" onclick="switchConfigTab('risk')" data-tab="risk">
                                    <i class="bi bi-shield-exclamation"></i> 风险控制
                                </button>
                                <button class="config-tab" onclick="switchConfigTab('advanced')" data-tab="advanced">
                                    <i class="bi bi-sliders"></i> 高级功能
                                </button>
                            </div>
                            
                            <!-- 标签页内容 -->
                            <div id="configTabContents">
                                <!-- 详细内容 - 可编辑表单 -->
                            </div>
                        </div>
                        <div class="save-actions" id="saveActions" style="display: none;">
                            <button class="btn btn-secondary" onclick="cancelEdit()">
                                <i class="bi bi-x-circle"></i> 取消
                            </button>
                            <button class="btn btn-primary" onclick="saveStrategyConfig()">
                                <i class="bi bi-check-circle"></i> 保存配置
                            </button>
                        </div>
                        <div class="strategy-actions-panel" id="detailActions">
                            <!-- 操作按钮 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 策略回测模态框 -->
    <div id="backtestModal" class="modal-overlay" onclick="if(event.target === this) hideBacktestModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-graph-up"></i> 策略回测
                </div>
                <button class="modal-close" onclick="hideBacktestModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">策略名称 <span style="color: var(--danger-red);">*</span></label>
                    <select class="form-select" id="backtestStrategyName" required>
                        <option value="">请选择策略</option>
                    </select>
                    <div class="form-help-text">选择要回测的策略</div>
                </div>
                <div class="form-group">
                    <label class="form-label">交易对 <span style="color: var(--danger-red);">*</span></label>
                    <input type="text" class="form-input" id="backtestSymbol" placeholder="BNB/USDT" required>
                    <div class="form-help-text">例如: BNB/USDT, BTC/USDT, ETH/USDT</div>
                </div>
                <div class="form-group">
                    <label class="form-label">市场类型</label>
                    <select class="form-select" id="backtestMarketType">
                        <option value="spot" selected>现货</option>
                        <option value="futures">合约</option>
                    </select>
                    <div class="form-help-text">选择回测的市场类型</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">开始日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="backtestStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">结束日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="backtestEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">初始资金 (USDT)</label>
                    <input type="number" class="form-input" id="backtestInitialBalance" value="10000" step="100" min="1000">
                </div>
                <div id="backtestResult" style="display: none; margin-top: var(--spacing-xl);">
                    <div class="form-section">
                        <div class="form-section-title">回测结果</div>
                        <div class="strategy-detail-grid" id="backtestMetrics">
                            <!-- 回测指标 -->
                        </div>
                        <div style="margin-top: var(--spacing-lg);">
                            <div class="form-section-title" style="font-size: 14px;">交易记录</div>
                            <div style="max-height: 300px; overflow-y: auto; margin-top: var(--spacing-md);">
                                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border-default);">
                                            <th style="padding: var(--spacing-sm); text-align: left;">时间</th>
                                            <th style="padding: var(--spacing-sm); text-align: left;">操作</th>
                                            <th style="padding: var(--spacing-sm); text-align: right;">价格</th>
                                            <th style="padding: var(--spacing-sm); text-align: right;">盈亏</th>
                                        </tr>
                                    </thead>
                                    <tbody id="backtestTrades">
                                        <!-- 交易记录 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="backtestLoading" style="display: none; text-align: center; padding: var(--spacing-xl);">
                    <div class="loading">正在回测中，请稍候...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideBacktestModal()">
                    <i class="bi bi-x-circle"></i> 关闭
                </button>
                <button class="btn btn-primary" onclick="runBacktest()">
                    <i class="bi bi-play-circle"></i> 开始回测
                </button>
            </div>
        </div>
    </div>

    <!-- AI自动生成策略模态框 -->
    <div id="autoGenerateModal" class="modal-overlay" onclick="if(event.target === this) hideAutoGenerateModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-magic"></i> AI自动生成策略
                </div>
                <button class="modal-close" onclick="hideAutoGenerateModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                        <i class="bi bi-info-circle" style="color: var(--primary-blue);"></i>
                        <strong>功能说明</strong>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                        系统将使用遗传算法分析历史数据，自动优化策略参数（维度权重、风险配置、交易规则等），生成表现优秀的交易策略。
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">基础策略（可选）</label>
                    <select class="form-select" id="autoGenBaseStrategy">
                        <option value="">从头开始生成</option>
                    </select>
                    <div class="form-help-text">选择基础策略将基于该策略进行优化，否则完全随机生成</div>
                </div>
                <div class="form-group">
                    <label class="form-label">交易对 <span style="color: var(--danger-red);">*</span></label>
                    <input type="text" class="form-input" id="autoGenSymbol" placeholder="BNB/USDT" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">训练开始日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="autoGenStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">训练结束日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="autoGenEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">市场类型</label>
                    <select class="form-select" id="autoGenMarketType">
                        <option value="spot" selected>现货</option>
                        <option value="futures">合约</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">种群大小</label>
                        <input type="number" class="form-input" id="autoGenPopulationSize" value="20" min="10" max="50">
                        <div class="form-help-text">每代策略数量（越大越慢但效果可能更好）</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">迭代代数</label>
                        <input type="number" class="form-input" id="autoGenGenerations" value="10" min="5" max="20">
                        <div class="form-help-text">优化迭代次数（越多越慢但效果可能更好）</div>
                    </div>
                </div>
                <div id="autoGenResult" style="display: none; margin-top: var(--spacing-xl);">
                    <div class="form-section">
                        <div class="form-section-title">生成结果</div>
                        <div id="autoGenResultContent">
                            <!-- 结果内容 -->
                        </div>
                    </div>
                </div>
                <div id="autoGenLoading" style="display: none; text-align: center; padding: var(--spacing-xl);">
                    <div class="loading">正在生成策略，这可能需要几分钟时间...</div>
                    <div style="margin-top: var(--spacing-md); font-size: 12px; color: var(--text-secondary);">
                        <div id="autoGenProgress">准备中...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideAutoGenerateModal()">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button class="btn btn-success" onclick="startAutoGenerate()">
                    <i class="bi bi-play-circle"></i> 开始生成
                </button>
            </div>
        </div>
    </div>

    <!-- AI找买卖点模态框 -->
    <div id="optimalPointsModal" class="modal-overlay" onclick="if(event.target === this) hideOptimalPointsModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-bullseye"></i> AI寻找最佳买卖点
                </div>
                <button class="modal-close" onclick="hideOptimalPointsModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                        <i class="bi bi-info-circle" style="color: var(--primary-blue);"></i>
                        <strong>功能说明</strong>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                        系统将分析历史数据，使用技术分析、局部极值识别、支撑阻力位等方法，找出最佳的买入和卖出时机。
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">交易对 <span style="color: var(--danger-red);">*</span></label>
                    <input type="text" class="form-input" id="optimalPointsSymbol" placeholder="BNB/USDT" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">开始日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="optimalPointsStartDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">结束日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="optimalPointsEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">市场类型</label>
                    <select class="form-select" id="optimalPointsMarketType">
                        <option value="spot" selected>现货</option>
                        <option value="futures">合约</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">回看周期</label>
                        <input type="number" class="form-input" id="optimalPointsLookback" value="20" min="10" max="50">
                        <div class="form-help-text">用于识别局部极值的周期</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">最小盈利 (%)</label>
                        <input type="number" class="form-input" id="optimalPointsMinProfit" value="5" step="0.5" min="1" max="50">
                        <div class="form-help-text">过滤盈利太小的交易对</div>
                    </div>
                </div>
                <div id="optimalPointsResult" style="display: none; margin-top: var(--spacing-xl);">
                    <div class="form-section">
                        <div class="form-section-title">分析结果</div>
                        <div style="margin-bottom: var(--spacing-md);">
                            <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md);">
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">最佳买点</div>
                                        <div style="font-size: 18px; font-weight: 600; color: var(--success-green);" id="optimalBuyCount">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">最佳卖点</div>
                                        <div style="font-size: 18px; font-weight: 600; color: var(--danger-red);" id="optimalSellCount">0</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">交易机会</div>
                                        <div style="font-size: 18px; font-weight: 600; color: var(--primary-blue);" id="optimalPairsCount">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                            <div>
                                <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-md);">最佳买点 (前10个)</div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <div id="optimalBuyPointsList">
                                        <!-- 买点列表 -->
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-md);">最佳卖点 (前10个)</div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <div id="optimalSellPointsList">
                                        <!-- 卖点列表 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: var(--spacing-lg);">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-md);">最佳交易对 (前10个)</div>
                            <div style="max-height: 400px; overflow-y: auto;">
                                <div id="optimalPairsList">
                                    <!-- 交易对列表 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="optimalPointsLoading" style="display: none; text-align: center; padding: var(--spacing-xl);">
                    <div class="loading">正在分析历史数据，寻找最佳买卖点...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideOptimalPointsModal()">
                    <i class="bi bi-x-circle"></i> 关闭
                </button>
                <button class="btn btn-info" onclick="startOptimalPointsAnalysis()">
                    <i class="bi bi-search"></i> 开始分析
                </button>
            </div>
        </div>
    </div>

    <!-- 价格走势预测模态框 -->
    <div id="pricePredictionModal" class="modal-overlay" onclick="if(event.target === this) hidePricePredictionModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-crystal-ball"></i> 价格走势预测
                </div>
                <button class="modal-close" onclick="hidePricePredictionModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                        <i class="bi bi-info-circle" style="color: var(--primary-blue);"></i>
                        <strong>功能说明</strong>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                        系统将分析过去7天的价格走势，使用趋势分析、技术指标、价格模式识别等方法，预测未来3天的价格走势。
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">交易对 <span style="color: var(--danger-red);">*</span></label>
                    <input type="text" class="form-input" id="predictionSymbol" placeholder="BNB/USDT" required>
                </div>
                <div class="form-group">
                    <label class="form-label">市场类型</label>
                    <select class="form-select" id="predictionMarketType">
                        <option value="spot" selected>现货</option>
                        <option value="futures">合约</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">预测天数</label>
                    <select class="form-select" id="predictionDaysAhead">
                        <option value="1">1天</option>
                        <option value="2">2天</option>
                        <option value="3" selected>3天</option>
                        <option value="5">5天</option>
                        <option value="7">7天</option>
                    </select>
                    <div class="form-help-text">预测未来多少天的走势</div>
                </div>
                <div id="predictionResult" style="display: none; margin-top: var(--spacing-xl);">
                    <div class="form-section">
                        <div class="form-section-title">预测结果</div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md);">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">当前价格</div>
                                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); font-family: var(--font-mono);" id="predictionCurrentPrice">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">预测价格</div>
                                    <div style="font-size: 18px; font-weight: 600; color: var(--primary-blue); font-family: var(--font-mono);" id="predictionFuturePrice">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">预测变化</div>
                                    <div style="font-size: 18px; font-weight: 600; font-family: var(--font-mono);" id="predictionChange">0%</div>
                                </div>
                            </div>
                            <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-muted);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">预测方向</div>
                                        <div style="font-size: 16px; font-weight: 600;" id="predictionDirection">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">置信度</div>
                                        <div style="font-size: 16px; font-weight: 600; color: var(--primary-blue);" id="predictionConfidence">-</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">当前趋势</div>
                                        <div style="font-size: 16px; font-weight: 600;" id="predictionTrend">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">交易建议</div>
                            <div id="predictionRecommendation">
                                <!-- 建议内容 -->
                            </div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">未来价格预测点</div>
                            <div id="predictionPointsList">
                                <!-- 预测点列表 -->
                            </div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">关键价位</div>
                            <div id="predictionKeyLevels">
                                <!-- 关键价位 -->
                            </div>
                        </div>
                        <div id="predictionRisks" style="display: none;">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm); color: var(--danger-red);">⚠️ 风险提示</div>
                            <div id="predictionRisksList">
                                <!-- 风险列表 -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="predictionLoading" style="display: none; text-align: center; padding: var(--spacing-xl);">
                    <div class="loading">正在分析过去7天的价格走势，预测未来走势...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hidePricePredictionModal()">
                    <i class="bi bi-x-circle"></i> 关闭
                </button>
                <button class="btn btn-warning" onclick="startPricePrediction()">
                    <i class="bi bi-search"></i> 开始预测
                </button>
            </div>
        </div>
    </div>

    <!-- 交易诊断模态框 -->
    <div id="tradeDiagnosticModal" class="modal-overlay" onclick="if(event.target === this) hideTradeDiagnosticModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-clipboard-check"></i> 交易诊断
                </div>
                <button class="modal-close" onclick="hideTradeDiagnosticModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                        <i class="bi bi-info-circle" style="color: var(--primary-blue);"></i>
                        <strong>功能说明</strong>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                        系统将分析您指定时间的交易操作，评估买入/卖出时机的合理性，包括技术指标、市场环境、价格位置等多个维度的分析。
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">交易对 <span style="color: var(--danger-red);">*</span></label>
                    <input type="text" class="form-input" id="diagnosticSymbol" placeholder="ORDI/USDT" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">交易日期 <span style="color: var(--danger-red);">*</span></label>
                        <input type="date" class="form-input" id="diagnosticDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">交易时间 <span style="color: var(--danger-red);">*</span></label>
                        <input type="time" class="form-input" id="diagnosticTime" value="12:00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">交易类型</label>
                    <select class="form-select" id="diagnosticTradeType">
                        <option value="buy" selected>买入</option>
                        <option value="sell">卖出</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">市场类型</label>
                    <select class="form-select" id="diagnosticMarketType">
                        <option value="spot" selected>现货</option>
                        <option value="futures">合约</option>
                    </select>
                </div>
                <div id="diagnosticResult" style="display: none; margin-top: var(--spacing-xl);">
                    <div class="form-section">
                        <div class="form-section-title">诊断结果</div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">交易价格</div>
                                    <div style="font-size: 18px; font-weight: 600; color: var(--text-primary); font-family: var(--font-mono);" id="diagnosticTradePrice">$0.00</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">综合评分</div>
                                    <div style="font-size: 18px; font-weight: 600; color: var(--primary-blue);" id="diagnosticScore">0</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">诊断结论</div>
                                    <div style="font-size: 18px; font-weight: 600;" id="diagnosticConclusion">-</div>
                                </div>
                            </div>
                            <div style="padding-top: var(--spacing-md); border-top: 1px solid var(--border-muted);">
                                <div style="font-size: 14px; color: var(--text-primary);" id="diagnosticDescription">-</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">时机分析</div>
                                <div id="diagnosticTiming">-</div>
                            </div>
                            <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">市场环境</div>
                                <div id="diagnosticMarket">-</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                            <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">技术指标</div>
                                <div id="diagnosticIndicators">-</div>
                            </div>
                            <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md);">
                                <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">价格位置</div>
                                <div id="diagnosticPricePosition">-</div>
                            </div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">后续表现</div>
                            <div id="diagnosticPerformance">-</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm);">诊断建议</div>
                            <div id="diagnosticRecommendations">-</div>
                        </div>
                        <div id="diagnosticIssues" style="display: none;">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm); color: var(--danger-red);">⚠️ 主要问题</div>
                            <div id="diagnosticIssuesList">-</div>
                        </div>
                        <div id="diagnosticAdvantages" style="display: none;">
                            <div class="form-section-title" style="font-size: 14px; margin-bottom: var(--spacing-sm); color: var(--success-green);">✅ 主要优点</div>
                            <div id="diagnosticAdvantagesList">-</div>
                        </div>
                    </div>
                </div>
                <div id="diagnosticLoading" style="display: none; text-align: center; padding: var(--spacing-xl);">
                    <div class="loading">正在分析交易操作...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideTradeDiagnosticModal()">
                    <i class="bi bi-x-circle"></i> 关闭
                </button>
                <button class="btn btn-primary" onclick="startTradeDiagnostic()">
                    <i class="bi bi-search"></i> 开始诊断
                </button>
            </div>
        </div>
    </div>

    <!-- 创建策略模态框 -->
    <div id="createStrategyModal" class="modal-overlay" onclick="if(event.target === this) hideCreateStrategyModal()">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="bi bi-plus-circle"></i> 创建新策略
                </div>
                <button class="modal-close" onclick="hideCreateStrategyModal()">
                    <i class="bi bi-x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">策略类型 <span style="color: var(--danger-red);">*</span></label>
                    <select class="form-select" id="newStrategyType" required>
                        <option value="spot" selected>现货策略</option>
                        <option value="futures">合约策略</option>
                    </select>
                    <div class="form-help-text">选择策略适用的市场类型</div>
                </div>
                <div class="form-group">
                    <label class="form-label">策略名称 <span style="color: var(--danger-red);">*</span></label>
                    <input type="text" class="form-input" id="newStrategyName" placeholder="my_strategy" required>
                    <div class="form-help-text">只能包含字母、数字和下划线</div>
                </div>
                <div class="form-group">
                    <label class="form-label">策略描述</label>
                    <textarea class="form-textarea" id="newStrategyDesc" placeholder="输入策略描述..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">基于模板</label>
                    <select class="form-select" id="newStrategyTemplate">
                        <option value="">从头创建（使用默认配置）</option>
                        <option value="balanced" selected>平衡策略 (推荐)</option>
                        <option value="conservative">保守策略</option>
                        <option value="aggressive">激进策略</option>
                    </select>
                    <div class="form-help-text">选择模板将复制该策略的所有配置，然后可以进一步编辑</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideCreateStrategyModal()">
                    <i class="bi bi-x-circle"></i> 取消
                </button>
                <button class="btn btn-primary" onclick="createStrategy()">
                    <i class="bi bi-check-circle"></i> 创建策略
                </button>
            </div>
        </div>
    </div>

    <script>
        let allStrategies = [];
        let activeStrategyName = null;

        // 显示加载状态
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
        }

        // 显示错误
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorState').textContent = `错误: ${message}`;
            document.getElementById('mainContent').style.display = 'none';
        }

        // 显示内容
        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <i class="bi ${type === 'success' ? 'bi-check-circle-fill' : 'bi-x-circle-fill'}" style="font-size: 20px; color: ${type === 'success' ? 'var(--success-green)' : 'var(--danger-red)'};"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 获取风险等级标签
        function getRiskLabel(level) {
            const labels = {
                'aggressive': '激进',
                'balanced': '平衡',
                'conservative': '保守'
            };
            return labels[level] || level;
        }

        // 获取风险等级类名
        function getRiskClass(level) {
            return `risk-${level}`;
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // 加载策略列表
        async function loadStrategies() {
            showLoading();
            try {
                const response = await fetch('/api/strategies/list');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    allStrategies = data.strategies || [];
                    activeStrategyName = data.active_strategy || null;
                    updateStrategiesList(allStrategies);
                    // 如果有策略，默认选择第一个
                    if (allStrategies.length > 0 && !selectedStrategyName) {
                        selectStrategy(allStrategies[0].name);
                    }
                    showContent();
                } else {
                    throw new Error(data.message || '获取策略列表失败');
                }
            } catch (error) {
                console.error('加载策略列表失败:', error);
                showError(error.message || '加载策略列表失败，请稍后重试');
            }
        }

        let selectedStrategyName = null;
        let currentStrategyType = 'spot'; // 'spot' 或 'futures'

        // 切换策略类型（现货/合约）
        function switchStrategyType(type) {
            currentStrategyType = type;
            
            // 更新标签样式
            const spotTab = document.getElementById('spotTab');
            const futuresTab = document.getElementById('futuresTab');
            if (spotTab && futuresTab) {
                if (type === 'spot') {
                    spotTab.classList.add('active');
                    futuresTab.classList.remove('active');
                    spotTab.style.background = 'var(--primary-blue)';
                    spotTab.style.color = 'white';
                    futuresTab.style.background = 'transparent';
                    futuresTab.style.color = 'var(--text-secondary)';
                } else {
                    futuresTab.classList.add('active');
                    spotTab.classList.remove('active');
                    futuresTab.style.background = 'var(--primary-blue)';
                    futuresTab.style.color = 'white';
                    spotTab.style.background = 'transparent';
                    spotTab.style.color = 'var(--text-secondary)';
                }
            }
            
            // 更新策略列表显示
            updateStrategiesList(allStrategies);
            
            // 如果当前选中的策略不属于当前类型，清空选择
            if (selectedStrategyName) {
                const selectedStrategy = allStrategies.find(s => s.name === selectedStrategyName);
                if (selectedStrategy && !isStrategyOfType(selectedStrategy, type)) {
                    selectedStrategyName = null;
                    const emptyState = document.getElementById('emptyDetailState');
                    const detailContent = document.getElementById('strategyDetailContent');
                    if (emptyState) emptyState.style.display = 'block';
                    if (detailContent) detailContent.style.display = 'none';
                }
            }
        }

        // 判断策略是否属于指定类型
        function isStrategyOfType(strategy, type) {
            const tags = strategy.tags || [];
            if (type === 'futures') {
                return tags.includes('futures') || tags.includes('合约') || strategy.name.toLowerCase().includes('futures') || strategy.name.toLowerCase().includes('合约');
            } else {
                return !tags.includes('futures') && !tags.includes('合约') && !strategy.name.toLowerCase().includes('futures') && !strategy.name.toLowerCase().includes('合约');
            }
        }

        // 更新策略列表（左侧）
        function updateStrategiesList(strategies) {
            const listContainer = document.getElementById('strategyListItems');
            if (!listContainer) return;

            // 根据当前类型过滤策略
            const filteredStrategies = strategies.filter(s => isStrategyOfType(s, currentStrategyType));

            if (!filteredStrategies || filteredStrategies.length === 0) {
                const typeLabel = currentStrategyType === 'futures' ? '合约' : '现货';
                listContainer.innerHTML = `<div class="empty-state" style="text-align: center; padding: var(--spacing-xl);">暂无${typeLabel}策略，点击"创建策略"按钮创建新策略</div>`;
                return;
            }

            listContainer.innerHTML = filteredStrategies.map(strategy => {
                const isActive = strategy.is_active || strategy.name === activeStrategyName;
                const isSelected = strategy.name === selectedStrategyName;
                const riskClass = getRiskClass(strategy.risk_level);
                const riskLabel = getRiskLabel(strategy.risk_level);
                const tags = strategy.tags || [];
                const marketType = tags.includes('futures') || tags.includes('合约') ? '合约' : '现货';

                return `
                    <div class="strategy-list-item ${isSelected ? 'selected' : ''} ${isActive ? 'active' : ''}" 
                         onclick="selectStrategy('${strategy.name}')">
                        <div class="strategy-item-name">
                            ${strategy.name}
                            ${isActive ? '<span class="badge badge-success" style="margin-left: auto;">已激活</span>' : ''}
                        </div>
                        <div class="strategy-item-desc">${strategy.description || '暂无描述'}</div>
                        <div class="strategy-item-meta">
                            <span class="badge ${riskClass}">${riskLabel}</span>
                            <span class="badge badge-info" style="margin-left: var(--spacing-xs);">${marketType}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 选择策略并显示详情
        async function selectStrategy(name) {
            selectedStrategyName = name;
            // 更新列表选中状态
            updateStrategiesList(allStrategies);
            
            // 加载并显示策略详情
            await loadStrategyDetail(name);
        }

        // 加载策略详情
        async function loadStrategyDetail(name) {
            try {
                const response = await fetch(`/api/strategies/detail/${name}`);
                const data = await response.json();
                
                if (data.success) {
                    const strategy = data.strategy;
                    displayStrategyDetail(strategy);
                } else {
                    showToast(data.message || '获取策略详情失败', 'error');
                }
            } catch (error) {
                console.error('获取策略详情失败:', error);
                showToast('获取策略详情失败', 'error');
            }
        }

        let isEditMode = false;
        let currentStrategyData = null;

        // 显示策略详情
        function displayStrategyDetail(strategy) {
            currentStrategyData = strategy;
            isEditMode = false;
            
            const emptyState = document.getElementById('emptyDetailState');
            const detailContent = document.getElementById('strategyDetailContent');
            const detailTitle = document.getElementById('detailTitle');
            const detailContentArea = document.getElementById('detailContent');
            const detailActions = document.getElementById('detailActions');
            const editModeBtn = document.getElementById('editModeBtn');
            const saveActions = document.getElementById('saveActions');

            if (emptyState) emptyState.style.display = 'none';
            if (detailContent) detailContent.style.display = 'block';
            if (saveActions) saveActions.style.display = 'none';

            const isActive = strategy.is_active || strategy.name === activeStrategyName;
            const isDefault = ['conservative', 'balanced', 'aggressive'].includes(strategy.name);
            const riskClass = getRiskClass(strategy.risk_profile?.level || strategy.risk_level);
            const riskLabel = getRiskLabel(strategy.risk_profile?.level || strategy.risk_level);

            // 标题
            if (detailTitle) {
                detailTitle.innerHTML = `
                    ${strategy.name}
                    ${isActive ? '<span class="badge badge-success" style="margin-left: var(--spacing-md);">已激活</span>' : ''}
                `;
            }

            // 编辑按钮
            if (editModeBtn) {
                if (isDefault) {
                    editModeBtn.disabled = true;
                    editModeBtn.title = '默认策略不可编辑';
                    editModeBtn.innerHTML = '<i class="bi bi-lock"></i> 默认策略（受保护）';
                } else {
                    editModeBtn.disabled = false;
                    editModeBtn.title = '';
                    editModeBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑配置';
                }
            }

            // 生成表单内容
            if (detailContentArea) {
                const configTabContents = document.getElementById('configTabContents');
                if (configTabContents) {
                    configTabContents.innerHTML = generateStrategyForm(strategy, isEditMode, isDefault);
                } else {
                    detailContentArea.innerHTML = generateStrategyForm(strategy, isEditMode, isDefault);
                }
                
                // 显示标签页
                const configTabs = document.getElementById('configTabs');
                if (configTabs) {
                    configTabs.style.display = 'flex';
                }
            }

            // 操作按钮
            if (detailActions) {
                let actionsHtml = '';
                
                if (!isActive) {
                    actionsHtml += `
                        <button class="btn btn-success" onclick="activateStrategy('${strategy.name}')">
                            <i class="bi bi-play-circle"></i> 激活策略
                        </button>
                    `;
                } else {
                    actionsHtml += `
                        <button class="btn btn-secondary" onclick="deactivateStrategy('${strategy.name}')" title="当前已激活">
                            <i class="bi bi-pause-circle"></i> 已激活
                        </button>
                    `;
                }

                if (!isDefault) {
                    actionsHtml += `
                        <button class="btn btn-danger" onclick="deleteStrategy('${strategy.name}')">
                            <i class="bi bi-trash"></i> 删除策略
                        </button>
                    `;
                }

                detailActions.innerHTML = actionsHtml;
            }
        }

        // 生成策略配置表单
        function generateStrategyForm(strategy, editMode, isDefault) {
            const dw = strategy.dimension_weights || {};
            const rp = strategy.risk_profile || {};
            const tr = strategy.trading_rules || {};
            const tc = strategy.technical_config || {};
            const tags = strategy.tags || [];
            const description = strategy.description || '';
            
            // 判断是否为合约策略
            const isFutures = tags.includes('futures') || tags.includes('合约') || 
                             strategy.name.toLowerCase().includes('futures') || 
                             strategy.name.toLowerCase().includes('合约');

            let html = '';

            // 策略类型提示
            if (isFutures) {
                html += `
                    <div class="form-section" style="background: rgba(43, 111, 237, 0.1); border-color: var(--primary-blue);">
                        <div class="form-section-title" style="color: var(--primary-blue);">
                            <i class="bi bi-graph-up-arrow"></i> 合约策略配置
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6; padding: var(--spacing-sm);">
                            <p>此策略专为合约交易设计，已启用以下合约特性：</p>
                            <ul style="margin: var(--spacing-sm) 0; padding-left: var(--spacing-lg);">
                                <li>允许做空交易（${rp.allow_short ? '已启用' : '未启用'}）</li>
                                <li>最大杠杆倍数：${rp.max_leverage || 1.0}x</li>
                                <li>更关注资金费率指标（权重：${dw.funding_rate || 15.0}%）</li>
                                <li>更严格的风险控制（止损：${rp.stop_loss || 5.0}%，仓位：${rp.max_position_size || 20.0}%）</li>
                            </ul>
                        </div>
                    </div>
                `;
            }


            // 获取新配置数据
            const autoStopLoss = strategy.auto_stop_loss || {};
            const dcaConfig = strategy.dca_config || {};
            const riskAlert = strategy.risk_alert || {};
            const discipline = strategy.discipline || {};

            // 使用标签页组织内容
            let basicHtml = '';
            let riskHtml = '';
            let advancedHtml = '';

            // ========== 基础配置标签页 ==========
            
            // 描述
            basicHtml += `
                <div class="form-section">
                    <div class="form-section-title">策略描述</div>
                    <div class="form-group">
                        <label class="form-label">描述</label>
                        <textarea class="form-textarea" id="strategy_description" ${editMode && !isDefault ? '' : 'readonly'} placeholder="输入策略描述...">${escapeHtml(description)}</textarea>
                    </div>
                </div>
            `;

            // 维度权重
            basicHtml += `
                <div class="form-section">
                    <div class="form-section-title">维度权重配置</div>
                    <div class="form-help-text">各维度权重总和应为100%</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">技术指标权重 (%)</label>
                            <input type="number" class="form-input" id="dw_technical" value="${dw.technical || 40}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'} oninput="updateWeightTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hyperliquid权重 (%)</label>
                            <input type="number" class="form-input" id="dw_hyperliquid" value="${dw.hyperliquid || 20}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'} oninput="updateWeightTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">新闻情绪权重 (%)</label>
                            <input type="number" class="form-input" id="dw_news" value="${dw.news || 15}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'} oninput="updateWeightTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">资金费率权重 (%)</label>
                            <input type="number" class="form-input" id="dw_funding_rate" value="${dw.funding_rate || 15}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'} oninput="updateWeightTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">以太坊链上数据权重 (%)</label>
                            <input type="number" class="form-input" id="dw_ethereum" value="${dw.ethereum || 10}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'} oninput="updateWeightTotal()">
                        </div>
                    </div>
                    <div class="form-help-text" id="weightTotal">权重总和: <span id="weightTotalValue">100.0</span>%</div>
                </div>
            `;

            // 交易规则
            basicHtml += `
                <div class="form-section">
                    <div class="form-section-title">交易规则</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Hyperliquid最少钱包数</label>
                            <input type="number" class="form-input" id="tr_hyperliquid_min_wallets" value="${tr.hyperliquid_min_wallets || 3}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hyperliquid最小金额 (USD)</label>
                            <input type="number" class="form-input" id="tr_hyperliquid_min_amount" value="${tr.hyperliquid_min_amount || 50000}" step="1000" min="0" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hyperliquid最小净流入 (USD)</label>
                            <input type="number" class="form-input" id="tr_hyperliquid_min_net_flow" value="${tr.hyperliquid_min_net_flow || 100000}" step="1000" min="0" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">RSI超卖阈值</label>
                            <input type="number" class="form-input" id="tr_rsi_oversold" value="${tr.rsi_oversold || 30}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">RSI超买阈值</label>
                            <input type="number" class="form-input" id="tr_rsi_overbought" value="${tr.rsi_overbought || 70}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">新闻情绪阈值</label>
                            <input type="number" class="form-input" id="tr_news_sentiment_threshold" value="${tr.news_sentiment_threshold || 0.6}" step="0.01" min="0" max="1" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">最少新闻数量</label>
                            <input type="number" class="form-input" id="tr_news_min_count" value="${tr.news_min_count || 3}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">极端资金费率阈值</label>
                            <input type="number" class="form-input" id="tr_funding_rate_extreme" value="${tr.funding_rate_extreme || 0.01}" step="0.001" min="0" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">最少同意维度数</label>
                            <input type="number" class="form-input" id="tr_min_dimensions_agree" value="${tr.min_dimensions_agree || 3}" step="1" min="1" max="5" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                    </div>
                </div>
            `;

            // 技术指标配置
            if (tc && Object.keys(tc).length > 0) {
                basicHtml += `
                    <div class="form-section">
                        <div class="form-section-title">技术指标配置</div>
                        <div class="form-help-text">技术指标权重总和应为100%</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">RSI权重 (%)</label>
                                <input type="number" class="form-input" id="tc_rsi_weight" value="${tc.rsi_weight || 25}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">MACD权重 (%)</label>
                                <input type="number" class="form-input" id="tc_macd_weight" value="${tc.macd_weight || 25}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">布林带权重 (%)</label>
                                <input type="number" class="form-input" id="tc_bollinger_weight" value="${tc.bollinger_weight || 20}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">EMA权重 (%)</label>
                                <input type="number" class="form-input" id="tc_ema_weight" value="${tc.ema_weight || 15}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">成交量权重 (%)</label>
                                <input type="number" class="form-input" id="tc_volume_weight" value="${tc.volume_weight || 15}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">RSI周期</label>
                                <input type="number" class="form-input" id="tc_rsi_period" value="${tc.rsi_period || 14}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">MACD快线</label>
                                <input type="number" class="form-input" id="tc_macd_fast" value="${tc.macd_fast || 12}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">MACD慢线</label>
                                <input type="number" class="form-input" id="tc_macd_slow" value="${tc.macd_slow || 26}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">MACD信号线</label>
                                <input type="number" class="form-input" id="tc_macd_signal" value="${tc.macd_signal || 9}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">EMA短期</label>
                                <input type="number" class="form-input" id="tc_ema_short" value="${tc.ema_short || 20}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">EMA长期</label>
                                <input type="number" class="form-input" id="tc_ema_long" value="${tc.ema_long || 50}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">布林带周期</label>
                                <input type="number" class="form-input" id="tc_bb_period" value="${tc.bb_period || 20}" step="1" min="1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">布林带标准差</label>
                                <input type="number" class="form-input" id="tc_bb_std" value="${tc.bb_std || 2}" step="0.1" min="0.1" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 标签
            basicHtml += `
                <div class="form-section">
                    <div class="form-section-title">标签</div>
                    <div class="form-group">
                        <label class="form-label">标签（用逗号分隔）</label>
                        <input type="text" class="form-input" id="strategy_tags" value="${tags.join(', ')}" ${editMode && !isDefault ? '' : 'readonly'} placeholder="例如: 平衡, 中等风险, 推荐">
                    </div>
                </div>
            `;

            // ========== 风险控制标签页 ==========
            
            // 风险配置
            riskHtml += `
                <div class="form-section">
                    <div class="form-section-title">风险配置</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">风险等级</label>
                            <select class="form-select" id="rp_level" ${editMode && !isDefault ? '' : 'disabled'}>
                                <option value="conservative" ${(rp.level || 'balanced') === 'conservative' ? 'selected' : ''}>保守</option>
                                <option value="balanced" ${(rp.level || 'balanced') === 'balanced' ? 'selected' : ''}>平衡</option>
                                <option value="aggressive" ${(rp.level || 'balanced') === 'aggressive' ? 'selected' : ''}>激进</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">最大仓位比例 (%)</label>
                            <input type="number" class="form-input" id="rp_max_position_size" value="${rp.max_position_size || 20}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">止损比例 (%)</label>
                            <input type="number" class="form-input" id="rp_stop_loss" value="${rp.stop_loss || 5}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">止盈比例 (%)</label>
                            <input type="number" class="form-input" id="rp_take_profit" value="${rp.take_profit || 15}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">最小信号强度 (0-100)</label>
                            <input type="number" class="form-input" id="rp_min_signal_strength" value="${rp.min_signal_strength || 60}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                        </div>
                        <div class="form-group">
                            <label class="form-label">最大杠杆倍数</label>
                            <input type="number" class="form-input" id="rp_max_leverage" value="${rp.max_leverage || 1}" step="0.1" min="1" max="${isFutures ? '10' : '1'}" ${editMode && !isDefault ? '' : 'readonly'}>
                            <div class="form-help-text">${isFutures ? '合约策略建议使用3-5倍杠杆，现货策略为1倍（无杠杆）' : '现货策略固定为1倍（无杠杆）'}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox-label">
                            <input type="checkbox" class="form-checkbox" id="rp_allow_short" ${rp.allow_short ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                            <span>允许做空${isFutures ? '（合约策略推荐启用）' : '（现货策略通常不启用）'}</span>
                        </label>
                    </div>
                </div>
            `;

            // 1. 自动止损配置（使用折叠面板）
            riskHtml += `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="bi bi-shield-exclamation"></i> 自动止损设置
                            <span style="font-size: 11px; color: var(--text-tertiary); margin-left: var(--spacing-sm);">${isFutures ? '（合约策略）' : '（现货策略）'}</span>
                        </div>
                        <i class="bi bi-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="asl_enabled" ${autoStopLoss.enabled !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>启用自动止损</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="asl_auto_set_on_buy" ${autoStopLoss.auto_set_on_buy !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>买入时自动设置止损</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">止损方式</label>
                                <select class="form-select" id="asl_use_percentage" ${editMode && !isDefault ? '' : 'disabled'}>
                                    <option value="true" ${autoStopLoss.use_percentage !== false ? 'selected' : ''}>百分比止损</option>
                                    <option value="false" ${autoStopLoss.use_percentage === false ? 'selected' : ''}>固定价格止损</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">止损百分比 (%)</label>
                                <input type="number" class="form-input" id="asl_stop_loss_percentage" value="${autoStopLoss.stop_loss_percentage || 5.0}" step="0.1" min="0.1" max="50" ${editMode && !isDefault ? '' : 'readonly'}>
                                <div class="form-help-text">${isFutures ? '合约建议: 3-8%' : '现货建议: 5-10%'}</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">固定止损价格</label>
                                <input type="number" class="form-input" id="asl_stop_loss_price" value="${autoStopLoss.stop_loss_price || ''}" step="0.01" min="0" ${editMode && !isDefault ? '' : 'readonly'} placeholder="留空则使用百分比">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="asl_trailing_stop" ${autoStopLoss.trailing_stop ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>启用移动止损（追踪止损）</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">移动止损百分比 (%)</label>
                                <input type="number" class="form-input" id="asl_trailing_stop_percentage" value="${autoStopLoss.trailing_stop_percentage || 2.0}" step="0.1" min="0.1" max="10" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">最小止损距离 (%)</label>
                                <input type="number" class="form-input" id="asl_min_stop_loss_distance" value="${autoStopLoss.min_stop_loss_distance || 1.0}" step="0.1" min="0.1" max="5" ${editMode && !isDefault ? '' : 'readonly'}>
                                <div class="form-help-text">防止止损设置过近</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 3. 风险预警配置（使用折叠面板）
            riskHtml += `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="bi bi-exclamation-triangle"></i> 风险预警系统
                            <span style="font-size: 11px; color: var(--text-tertiary); margin-left: var(--spacing-sm);">${isFutures ? '（合约策略）' : '（现货策略）'}</span>
                        </div>
                        <i class="bi bi-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="ra_enabled" ${riskAlert.enabled !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>启用风险预警</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">亏损预警阈值 (%)</label>
                                <input type="number" class="form-input" id="ra_loss_alert_threshold" value="${riskAlert.loss_alert_threshold || 5.0}" step="0.1" min="0" max="50" ${editMode && !isDefault ? '' : 'readonly'}>
                                <div class="form-help-text">持仓亏损超过此值时预警</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">严重亏损阈值 (%)</label>
                                <input type="number" class="form-input" id="ra_loss_critical_threshold" value="${riskAlert.loss_critical_threshold || 10.0}" step="0.1" min="0" max="50" ${editMode && !isDefault ? '' : 'readonly'}>
                                <div class="form-help-text">持仓亏损超过此值时严重预警</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">仓位过大预警 (%)</label>
                                <input type="number" class="form-input" id="ra_position_size_alert" value="${riskAlert.position_size_alert || 25.0}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">单日最大亏损预警 (%)</label>
                                <input type="number" class="form-input" id="ra_max_daily_loss_alert" value="${riskAlert.max_daily_loss_alert || 5.0}" step="0.1" min="0" max="50" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">波动率预警阈值 (%)</label>
                                <input type="number" class="form-input" id="ra_volatility_threshold" value="${riskAlert.volatility_threshold || 10.0}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="ra_volatility_alert" ${riskAlert.volatility_alert !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>启用波动率预警</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="ra_notify_on_alert" ${riskAlert.notify_on_alert !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>预警时发送通知</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;

            // ========== 高级功能标签页 ==========
            
            // 2. 分批建仓配置（使用折叠面板）
            advancedHtml += `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="bi bi-layers"></i> 分批建仓助手
                            <span style="font-size: 11px; color: var(--text-tertiary); margin-left: var(--spacing-sm);">${isFutures ? '（合约策略）' : '（现货策略）'}</span>
                        </div>
                        <i class="bi bi-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="dca_enabled" ${dcaConfig.enabled ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>启用分批建仓</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">建仓策略</label>
                                <select class="form-select" id="dca_strategy_type" ${editMode && !isDefault ? '' : 'disabled'}>
                                    <option value="pyramid" ${(dcaConfig.strategy_type || 'pyramid') === 'pyramid' ? 'selected' : ''}>金字塔式（下跌时加仓）</option>
                                    <option value="grid" ${dcaConfig.strategy_type === 'grid' ? 'selected' : ''}>网格交易（固定间隔）</option>
                                    <option value="dca" ${dcaConfig.strategy_type === 'dca' ? 'selected' : ''}>定投策略（时间间隔）</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">总仓位大小 (%)</label>
                                <input type="number" class="form-input" id="dca_total_position_size" value="${dcaConfig.total_position_size || 20.0}" step="0.1" min="1" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">分批次数</label>
                                <input type="number" class="form-input" id="dca_num_batches" value="${dcaConfig.num_batches || 3}" step="1" min="2" max="10" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">价格间隔 (%) - 用逗号分隔，如: 5,10,15</label>
                            <input type="text" class="form-input" id="dca_price_intervals" value="${(dcaConfig.price_intervals || []).join(',')}" ${editMode && !isDefault ? '' : 'readonly'} placeholder="例如: 5,10,15">
                            <div class="form-help-text">每下跌指定百分比时买入一批（网格和金字塔策略）</div>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="dca_wait_for_confirmation" ${dcaConfig.wait_for_confirmation !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>等待趋势确认后再买入</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">确认信号类型</label>
                            <select class="form-select" id="dca_confirmation_signal" ${editMode && !isDefault ? '' : 'disabled'}>
                                <option value="rsi_oversold" ${(dcaConfig.confirmation_signal || 'rsi_oversold') === 'rsi_oversold' ? 'selected' : ''}>RSI超卖</option>
                                <option value="support_level" ${dcaConfig.confirmation_signal === 'support_level' ? 'selected' : ''}>支撑位确认</option>
                                <option value="trend_reversal" ${dcaConfig.confirmation_signal === 'trend_reversal' ? 'selected' : ''}>趋势反转</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            // 4. 交易纪律配置（使用折叠面板）
            advancedHtml += `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible(this)">
                        <div class="collapsible-title">
                            <i class="bi bi-shield-check"></i> 交易纪律检查
                            <span style="font-size: 11px; color: var(--text-tertiary); margin-left: var(--spacing-sm);">${isFutures ? '（合约策略）' : '（现货策略）'}</span>
                        </div>
                        <i class="bi bi-chevron-down collapsible-icon"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="td_enabled" ${discipline.enabled !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>启用交易纪律检查</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">每天最大情绪化交易次数</label>
                                <input type="number" class="form-input" id="td_max_emotion_trades_per_day" value="${discipline.max_emotion_trades_per_day || 3}" step="1" min="0" max="20" ${editMode && !isDefault ? '' : 'readonly'}>
                                <div class="form-help-text">超过此次数将触发警告</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">两次交易最小间隔 (分钟)</label>
                                <input type="number" class="form-input" id="td_min_time_between_trades" value="${discipline.min_time_between_trades || 60}" step="1" min="0" max="1440" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="td_require_plan_before_trade" ${discipline.require_plan_before_trade !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>交易前需要制定计划</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="td_check_deviation_from_plan" ${discipline.check_deviation_from_plan !== false ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>检查偏离交易计划</span>
                            </label>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">最大偏离百分比 (%)</label>
                                <input type="number" class="form-input" id="td_max_deviation_percentage" value="${discipline.max_deviation_percentage || 10.0}" step="0.1" min="0" max="100" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                            <div class="form-group">
                                <label class="form-label">违反纪律后冷却期 (小时)</label>
                                <input type="number" class="form-input" id="td_cooldown_period" value="${discipline.cooldown_period || 24}" step="1" min="0" max="168" ${editMode && !isDefault ? '' : 'readonly'}>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-checkbox-label">
                                <input type="checkbox" class="form-checkbox" id="td_auto_lock_on_violation" ${discipline.auto_lock_on_violation ? 'checked' : ''} ${editMode && !isDefault ? '' : 'disabled'}>
                                <span>违反纪律时自动锁定交易</span>
                            </label>
                        </div>
                    </div>
                </div>
            `;

            // 5. 策略回测
            advancedHtml += `
                <div class="form-section" style="background: rgba(43, 111, 237, 0.05); border-left: 3px solid var(--primary-blue);">
                    <div class="form-section-title">
                        <i class="bi bi-graph-up"></i> 策略回测
                        <span style="font-size: 11px; color: var(--text-tertiary); margin-left: var(--spacing-sm);">${isFutures ? '（合约策略）' : '（现货策略）'}</span>
                    </div>
                    <div style="padding: var(--spacing-md);">
                        <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            使用历史数据回测策略表现，验证策略有效性。支持现货和合约策略的回测。
                        </p>
                        <button class="btn btn-primary" onclick="showBacktestModal()" style="width: 100%;">
                            <i class="bi bi-play-circle"></i> 开始回测
                        </button>
                    </div>
                </div>
            `;

            // 基本信息（只读）
            advancedHtml += `
                <div class="form-section">
                    <div class="form-section-title">基本信息</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">创建时间</label>
                            <input type="text" class="form-input readonly-field" value="${formatDate(strategy.created_at)}" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">更新时间</label>
                            <input type="text" class="form-input readonly-field" value="${formatDate(strategy.updated_at)}" readonly>
                        </div>
                    </div>
                </div>
            `;

            // 组合所有标签页内容
            html = `
                <div class="config-tab-content active" id="tab-basic">
                    ${basicHtml}
                </div>
                <div class="config-tab-content" id="tab-risk">
                    ${riskHtml}
                </div>
                <div class="config-tab-content" id="tab-advanced">
                    ${advancedHtml}
                </div>
            `;

            return html;
        }

        // 切换配置标签页
        function switchConfigTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的active状态
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            const targetContent = document.getElementById(`tab-${tabName}`);
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // 激活选中的标签
            const targetTab = document.querySelector(`.config-tab[data-tab="${tabName}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
        }

        // 切换折叠面板
        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const isActive = header.classList.contains('active');
            
            // 关闭所有其他折叠面板（可选，如果希望只打开一个）
            // document.querySelectorAll('.collapsible-header').forEach(h => {
            //     if (h !== header) {
            //         h.classList.remove('active');
            //         h.nextElementSibling.classList.remove('active');
            //     }
            // });
            
            if (isActive) {
                header.classList.remove('active');
                content.classList.remove('active');
            } else {
                header.classList.add('active');
                content.classList.add('active');
            }
        }

        // 转义HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 更新权重总和
        function updateWeightTotal() {
            const technical = parseFloat(document.getElementById('dw_technical')?.value || 0);
            const hyperliquid = parseFloat(document.getElementById('dw_hyperliquid')?.value || 0);
            const news = parseFloat(document.getElementById('dw_news')?.value || 0);
            const funding_rate = parseFloat(document.getElementById('dw_funding_rate')?.value || 0);
            const ethereum = parseFloat(document.getElementById('dw_ethereum')?.value || 0);
            
            const total = technical + hyperliquid + news + funding_rate + ethereum;
            const totalElement = document.getElementById('weightTotalValue');
            if (totalElement) {
                totalElement.textContent = total.toFixed(1);
                totalElement.style.color = Math.abs(total - 100) < 0.1 ? 'var(--success-green)' : 'var(--danger-red)';
            }
        }

        // 激活策略
        async function activateStrategy(name) {
            try {
                const response = await fetch(`/api/strategies/activate/${name}`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`策略 "${name}" 已激活`, 'success');
                    activeStrategyName = name;
                    loadStrategies();
                    // 如果当前选中的是这个策略，刷新详情
                    if (selectedStrategyName === name) {
                        loadStrategyDetail(name);
                    }
                } else {
                    showToast(data.message || '激活失败', 'error');
                }
            } catch (error) {
                console.error('激活策略失败:', error);
                showToast('激活策略失败', 'error');
            }
        }

        // 查看策略详情（已废弃，使用selectStrategy代替）
        async function viewStrategy(name) {
            selectStrategy(name);
        }

        // 切换编辑模式
        function toggleEditMode() {
            if (!currentStrategyData) return;
            
            const isDefault = ['conservative', 'balanced', 'aggressive'].includes(currentStrategyData.name);
            if (isDefault) {
                showToast('默认策略不可编辑', 'error');
                return;
            }

            isEditMode = !isEditMode;
            const editModeBtn = document.getElementById('editModeBtn');
            const saveActions = document.getElementById('saveActions');
            const detailContentArea = document.getElementById('detailContent');

            if (isEditMode) {
                // 进入编辑模式
                if (editModeBtn) {
                    editModeBtn.innerHTML = '<i class="bi bi-eye"></i> 查看模式';
                    editModeBtn.classList.remove('btn-secondary');
                    editModeBtn.classList.add('btn-primary');
                }
                if (saveActions) saveActions.style.display = 'flex';
                // 重新生成表单（可编辑）
                if (detailContentArea && currentStrategyData) {
                    detailContentArea.innerHTML = generateStrategyForm(currentStrategyData, true, false);
                    updateWeightTotal(); // 初始化权重总和显示
                }
            } else {
                // 退出编辑模式
                if (editModeBtn) {
                    editModeBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑配置';
                    editModeBtn.classList.remove('btn-primary');
                    editModeBtn.classList.add('btn-secondary');
                }
                if (saveActions) saveActions.style.display = 'none';
                // 重新加载策略数据
                loadStrategyDetail(currentStrategyData.name);
            }
        }

        // 取消编辑
        function cancelEdit() {
            isEditMode = false;
            const editModeBtn = document.getElementById('editModeBtn');
            const saveActions = document.getElementById('saveActions');

            if (editModeBtn) {
                editModeBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑配置';
                editModeBtn.classList.remove('btn-primary');
                editModeBtn.classList.add('btn-secondary');
            }
            if (saveActions) saveActions.style.display = 'none';
            
            // 重新加载策略数据
            if (currentStrategyData) {
                loadStrategyDetail(currentStrategyData.name);
            }
        }

        // 保存策略配置
        async function saveStrategyConfig() {
            if (!currentStrategyData) return;

            const isDefault = ['conservative', 'balanced', 'aggressive'].includes(currentStrategyData.name);
            if (isDefault) {
                showToast('默认策略不可编辑', 'error');
                return;
            }

            try {
                // 收集表单数据
                const updateData = {
                    description: document.getElementById('strategy_description')?.value || '',
                    dimension_weights: {
                        technical: parseFloat(document.getElementById('dw_technical')?.value || 0),
                        hyperliquid: parseFloat(document.getElementById('dw_hyperliquid')?.value || 0),
                        news: parseFloat(document.getElementById('dw_news')?.value || 0),
                        funding_rate: parseFloat(document.getElementById('dw_funding_rate')?.value || 0),
                        ethereum: parseFloat(document.getElementById('dw_ethereum')?.value || 0)
                    },
                    risk_profile: {
                        level: document.getElementById('rp_level')?.value || 'balanced',
                        max_position_size: parseFloat(document.getElementById('rp_max_position_size')?.value || 20),
                        stop_loss: parseFloat(document.getElementById('rp_stop_loss')?.value || 5),
                        take_profit: parseFloat(document.getElementById('rp_take_profit')?.value || 15),
                        min_signal_strength: parseFloat(document.getElementById('rp_min_signal_strength')?.value || 60),
                        allow_short: document.getElementById('rp_allow_short')?.checked || false,
                        max_leverage: parseFloat(document.getElementById('rp_max_leverage')?.value || 1)
                    },
                    trading_rules: {
                        hyperliquid_min_wallets: parseInt(document.getElementById('tr_hyperliquid_min_wallets')?.value || 3),
                        hyperliquid_min_amount: parseFloat(document.getElementById('tr_hyperliquid_min_amount')?.value || 50000),
                        hyperliquid_min_net_flow: parseFloat(document.getElementById('tr_hyperliquid_min_net_flow')?.value || 100000),
                        rsi_oversold: parseFloat(document.getElementById('tr_rsi_oversold')?.value || 30),
                        rsi_overbought: parseFloat(document.getElementById('tr_rsi_overbought')?.value || 70),
                        news_sentiment_threshold: parseFloat(document.getElementById('tr_news_sentiment_threshold')?.value || 0.6),
                        news_min_count: parseInt(document.getElementById('tr_news_min_count')?.value || 3),
                        funding_rate_extreme: parseFloat(document.getElementById('tr_funding_rate_extreme')?.value || 0.01),
                        min_dimensions_agree: parseInt(document.getElementById('tr_min_dimensions_agree')?.value || 3)
                    },
                    tags: (document.getElementById('strategy_tags')?.value || '').split(',').map(t => t.trim()).filter(t => t.length > 0)
                };

                // 验证维度权重总和
                const weightTotal = updateData.dimension_weights.technical + 
                                  updateData.dimension_weights.hyperliquid + 
                                  updateData.dimension_weights.news + 
                                  updateData.dimension_weights.funding_rate + 
                                  updateData.dimension_weights.ethereum;
                
                if (Math.abs(weightTotal - 100) > 0.1) {
                    if (!confirm(`维度权重总和为 ${weightTotal.toFixed(1)}%，不等于100%。是否继续保存？系统会自动标准化。`)) {
                        return;
                    }
                }

                // 如果有技术指标配置，也收集
                const tc_rsi_weight = document.getElementById('tc_rsi_weight');
                if (tc_rsi_weight && !tc_rsi_weight.disabled) {
                    updateData.technical_config = {
                        rsi_weight: parseFloat(document.getElementById('tc_rsi_weight')?.value || 25),
                        macd_weight: parseFloat(document.getElementById('tc_macd_weight')?.value || 25),
                        bollinger_weight: parseFloat(document.getElementById('tc_bollinger_weight')?.value || 20),
                        ema_weight: parseFloat(document.getElementById('tc_ema_weight')?.value || 15),
                        volume_weight: parseFloat(document.getElementById('tc_volume_weight')?.value || 15),
                        rsi_period: parseInt(document.getElementById('tc_rsi_period')?.value || 14),
                        macd_fast: parseInt(document.getElementById('tc_macd_fast')?.value || 12),
                        macd_slow: parseInt(document.getElementById('tc_macd_slow')?.value || 26),
                        macd_signal: parseInt(document.getElementById('tc_macd_signal')?.value || 9),
                        ema_short: parseInt(document.getElementById('tc_ema_short')?.value || 20),
                        ema_long: parseInt(document.getElementById('tc_ema_long')?.value || 50),
                        bb_period: parseInt(document.getElementById('tc_bb_period')?.value || 20),
                        bb_std: parseFloat(document.getElementById('tc_bb_std')?.value || 2)
                    };
                }

                // 收集自动止损配置
                const asl_enabled = document.getElementById('asl_enabled');
                if (asl_enabled) {
                    updateData.auto_stop_loss = {
                        enabled: document.getElementById('asl_enabled')?.checked || false,
                        auto_set_on_buy: document.getElementById('asl_auto_set_on_buy')?.checked || false,
                        use_percentage: document.getElementById('asl_use_percentage')?.value === 'true',
                        stop_loss_percentage: parseFloat(document.getElementById('asl_stop_loss_percentage')?.value || 5.0),
                        stop_loss_price: document.getElementById('asl_stop_loss_price')?.value ? parseFloat(document.getElementById('asl_stop_loss_price').value) : null,
                        trailing_stop: document.getElementById('asl_trailing_stop')?.checked || false,
                        trailing_stop_percentage: parseFloat(document.getElementById('asl_trailing_stop_percentage')?.value || 2.0),
                        min_stop_loss_distance: parseFloat(document.getElementById('asl_min_stop_loss_distance')?.value || 1.0)
                    };
                }

                // 收集分批建仓配置
                const dca_enabled = document.getElementById('dca_enabled');
                if (dca_enabled) {
                    const priceIntervalsStr = document.getElementById('dca_price_intervals')?.value || '';
                    const priceIntervals = priceIntervalsStr.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                    
                    updateData.dca_config = {
                        enabled: document.getElementById('dca_enabled')?.checked || false,
                        strategy_type: document.getElementById('dca_strategy_type')?.value || 'pyramid',
                        total_position_size: parseFloat(document.getElementById('dca_total_position_size')?.value || 20.0),
                        num_batches: parseInt(document.getElementById('dca_num_batches')?.value || 3),
                        batch_weights: null, // 暂时不支持手动设置，使用自动分配
                        price_intervals: priceIntervals.length > 0 ? priceIntervals : null,
                        time_intervals: null, // 暂时不支持时间间隔
                        wait_for_confirmation: document.getElementById('dca_wait_for_confirmation')?.checked !== false,
                        confirmation_signal: document.getElementById('dca_confirmation_signal')?.value || 'rsi_oversold'
                    };
                }

                // 收集风险预警配置
                const ra_enabled = document.getElementById('ra_enabled');
                if (ra_enabled) {
                    updateData.risk_alert = {
                        enabled: document.getElementById('ra_enabled')?.checked !== false,
                        loss_alert_threshold: parseFloat(document.getElementById('ra_loss_alert_threshold')?.value || 5.0),
                        loss_critical_threshold: parseFloat(document.getElementById('ra_loss_critical_threshold')?.value || 10.0),
                        position_size_alert: parseFloat(document.getElementById('ra_position_size_alert')?.value || 25.0),
                        max_daily_loss_alert: parseFloat(document.getElementById('ra_max_daily_loss_alert')?.value || 5.0),
                        volatility_alert: document.getElementById('ra_volatility_alert')?.checked !== false,
                        volatility_threshold: parseFloat(document.getElementById('ra_volatility_threshold')?.value || 10.0),
                        notify_on_alert: document.getElementById('ra_notify_on_alert')?.checked !== false
                    };
                }

                // 收集交易纪律配置
                const td_enabled = document.getElementById('td_enabled');
                if (td_enabled) {
                    updateData.discipline = {
                        enabled: document.getElementById('td_enabled')?.checked !== false,
                        max_emotion_trades_per_day: parseInt(document.getElementById('td_max_emotion_trades_per_day')?.value || 3),
                        min_time_between_trades: parseInt(document.getElementById('td_min_time_between_trades')?.value || 60),
                        require_plan_before_trade: document.getElementById('td_require_plan_before_trade')?.checked !== false,
                        check_deviation_from_plan: document.getElementById('td_check_deviation_from_plan')?.checked !== false,
                        max_deviation_percentage: parseFloat(document.getElementById('td_max_deviation_percentage')?.value || 10.0),
                        auto_lock_on_violation: document.getElementById('td_auto_lock_on_violation')?.checked || false,
                        cooldown_period: parseInt(document.getElementById('td_cooldown_period')?.value || 24)
                    };
                }

                // 发送更新请求
                const response = await fetch(`/api/strategies/update/${currentStrategyData.name}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                
                if (data.success) {
                    showToast(`策略 "${currentStrategyData.name}" 配置已保存`, 'success');
                    // 退出编辑模式并刷新
                    isEditMode = false;
                    await loadStrategyDetail(currentStrategyData.name);
                    // 刷新列表
                    loadStrategies();
                } else {
                    showToast(data.detail || data.message || '保存失败', 'error');
                }
            } catch (error) {
                console.error('保存策略配置失败:', error);
                showToast('保存策略配置失败: ' + error.message, 'error');
            }
        }

        // 编辑策略（已废弃，使用toggleEditMode代替）
        function editStrategy(name) {
            selectStrategy(name);
            setTimeout(() => toggleEditMode(), 100);
        }

        // 停用策略
        async function deactivateStrategy(name) {
            showToast('停用功能开发中，请激活其他策略来替换当前策略', 'error');
        }

        // 删除策略
        async function deleteStrategy(name) {
            // 检查是否为默认策略
            if (['conservative', 'balanced', 'aggressive'].includes(name)) {
                showToast('默认策略不可删除', 'error');
                return;
            }

            if (!confirm(`确定要删除策略 "${name}" 吗？此操作不可恢复。`)) {
                return;
            }
            try {
                const response = await fetch(`/api/strategies/delete/${name}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`策略 "${name}" 已删除`, 'success');
                    // 如果删除的是当前选中的策略，清空详情
                    if (selectedStrategyName === name) {
                        selectedStrategyName = null;
                        document.getElementById('emptyDetailState').style.display = 'block';
                        document.getElementById('strategyDetailContent').style.display = 'none';
                    }
                    loadStrategies();
                } else {
                    showToast(data.message || '删除失败', 'error');
                }
            } catch (error) {
                console.error('删除策略失败:', error);
                showToast('删除策略失败', 'error');
            }
        }

        // 显示创建策略模态框
        function showCreateStrategyModal() {
            const modal = document.getElementById('createStrategyModal');
            if (modal) {
                // 清空表单
                document.getElementById('newStrategyName').value = '';
                document.getElementById('newStrategyDesc').value = '';
                document.getElementById('newStrategyTemplate').value = 'balanced';
                // 根据当前选中的策略类型设置默认值
                const strategyType = document.getElementById('newStrategyType');
                if (strategyType) {
                    strategyType.value = currentStrategyType;
                }
                modal.classList.add('active');
            }
        }

        // 隐藏创建策略模态框
        function hideCreateStrategyModal() {
            const modal = document.getElementById('createStrategyModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 创建策略
        async function createStrategy() {
            const name = document.getElementById('newStrategyName').value.trim();
            const description = document.getElementById('newStrategyDesc').value.trim();
            const template = document.getElementById('newStrategyTemplate').value;
            const strategyType = document.getElementById('newStrategyType').value; // 'spot' 或 'futures'

            // 验证策略名称
            if (!name) {
                showToast('请输入策略名称', 'error');
                return;
            }

            // 验证名称格式（只能包含字母、数字和下划线）
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                showToast('策略名称只能包含字母、数字和下划线', 'error');
                return;
            }

            // 根据策略类型设置tags
            const tags = strategyType === 'futures' ? ['futures', '合约'] : ['spot', '现货'];

            try {
                if (template) {
                    // 从模板复制策略
                    const response = await fetch('/api/strategies/copy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            source: template,
                            dest: name,
                            description: description || `基于 ${template} 的${strategyType === 'futures' ? '合约' : '现货'}策略`,
                            tags: tags
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(`策略 "${name}" 创建成功`, 'success');
                        hideCreateStrategyModal();
                        // 刷新策略列表
                        await loadStrategies();
                        // 切换到对应的策略类型标签页
                        if (strategyType === 'futures') {
                            switchStrategyType('futures');
                        } else {
                            switchStrategyType('spot');
                        }
                        // 自动选中新创建的策略
                        setTimeout(() => {
                            selectStrategy(name);
                        }, 300);
                    } else {
                        showToast(data.detail || data.message || '创建策略失败', 'error');
                    }
                } else {
                    // 从头创建策略（根据策略类型使用不同的默认配置）
                    const isFutures = strategyType === 'futures';
                    const defaultConfig = {
                        dimension_weights: {
                            technical: 40.0,
                            hyperliquid: 20.0,
                            news: 15.0,
                            // 合约策略更关注资金费率
                            funding_rate: isFutures ? 20.0 : 15.0,
                            ethereum: isFutures ? 5.0 : 10.0
                        },
                        risk_profile: {
                            level: 'balanced',
                            max_position_size: isFutures ? 15.0 : 20.0, // 合约策略仓位更小
                            stop_loss: isFutures ? 3.0 : 5.0, // 合约策略止损更严格
                            take_profit: isFutures ? 10.0 : 15.0, // 合约策略止盈更保守
                            min_signal_strength: isFutures ? 65.0 : 60.0, // 合约策略信号要求更高
                            allow_short: isFutures, // 合约策略默认允许做空
                            max_leverage: isFutures ? 3.0 : 1.0 // 合约策略默认3倍杠杆
                        },
                        trading_rules: {
                            hyperliquid_min_wallets: 3,
                            hyperliquid_min_amount: 50000.0,
                            hyperliquid_min_net_flow: 100000.0,
                            rsi_oversold: 30.0,
                            rsi_overbought: 70.0,
                            news_sentiment_threshold: 0.6,
                            news_min_count: 3,
                            // 合约策略对资金费率更敏感
                            funding_rate_extreme: isFutures ? 0.005 : 0.01,
                            min_dimensions_agree: isFutures ? 4 : 3 // 合约策略需要更多维度同意
                        }
                    };
                    
                    // 调整维度权重总和为100
                    const weightTotal = defaultConfig.dimension_weights.technical + 
                                      defaultConfig.dimension_weights.hyperliquid + 
                                      defaultConfig.dimension_weights.news + 
                                      defaultConfig.dimension_weights.funding_rate + 
                                      defaultConfig.dimension_weights.ethereum;
                    if (Math.abs(weightTotal - 100) > 0.01) {
                        // 按比例调整
                        const scale = 100 / weightTotal;
                        defaultConfig.dimension_weights.technical *= scale;
                        defaultConfig.dimension_weights.hyperliquid *= scale;
                        defaultConfig.dimension_weights.news *= scale;
                        defaultConfig.dimension_weights.funding_rate *= scale;
                        defaultConfig.dimension_weights.ethereum *= scale;
                    }

                    const response = await fetch('/api/strategies/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description || `${strategyType === 'futures' ? '合约' : '现货'}策略`,
                            dimension_weights: defaultConfig.dimension_weights,
                            risk_profile: defaultConfig.risk_profile,
                            trading_rules: defaultConfig.trading_rules,
                            tags: tags
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showToast(`策略 "${name}" 创建成功`, 'success');
                        hideCreateStrategyModal();
                        // 刷新策略列表
                        await loadStrategies();
                        // 切换到对应的策略类型标签页
                        if (strategyType === 'futures') {
                            switchStrategyType('futures');
                        } else {
                            switchStrategyType('spot');
                        }
                        // 自动选中新创建的策略
                        setTimeout(() => {
                            selectStrategy(name);
                        }, 300);
                    } else {
                        showToast(data.detail || data.message || '创建策略失败', 'error');
                    }
                }
            } catch (error) {
                console.error('创建策略失败:', error);
                showToast('创建策略失败: ' + error.message, 'error');
            }
        }

        // 按ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('createStrategyModal');
                if (modal && modal.classList.contains('active')) {
                    hideCreateStrategyModal();
                }
            }
        });

        // 显示回测模态框
        function showBacktestModal() {
            const modal = document.getElementById('backtestModal');
            const strategySelect = document.getElementById('backtestStrategyName');
            const resultDiv = document.getElementById('backtestResult');
            const loadingDiv = document.getElementById('backtestLoading');
            
            if (modal) {
                // 加载策略列表到下拉框
                if (strategySelect && allStrategies) {
                    strategySelect.innerHTML = '<option value="">请选择策略</option>';
                    allStrategies.forEach(strategy => {
                        const option = document.createElement('option');
                        option.value = strategy.name;
                        option.textContent = `${strategy.name}${strategy.active ? ' (激活中)' : ''}`;
                        if (currentStrategyData && strategy.name === currentStrategyData.name) {
                            option.selected = true;
                        }
                        strategySelect.appendChild(option);
                    });
                }
                
                // 如果当前有选中的策略，自动选择
                if (currentStrategyData && strategySelect) {
                    strategySelect.value = currentStrategyData.name;
                }
                
                // 设置默认日期（最近一个月）
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 1);
                
                document.getElementById('backtestEndDate').value = endDate.toISOString().split('T')[0];
                document.getElementById('backtestStartDate').value = startDate.toISOString().split('T')[0];
                
                // 清空结果
                if (resultDiv) resultDiv.style.display = 'none';
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                modal.classList.add('active');
            }
        }

        // 隐藏回测模态框
        function hideBacktestModal() {
            const modal = document.getElementById('backtestModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 执行回测
        async function runBacktest() {
            const strategyName = document.getElementById('backtestStrategyName').value.trim();
            const symbol = document.getElementById('backtestSymbol').value.trim();
            const startDate = document.getElementById('backtestStartDate').value;
            const endDate = document.getElementById('backtestEndDate').value;
            const initialBalance = parseFloat(document.getElementById('backtestInitialBalance').value) || 10000;
            const marketType = document.getElementById('backtestMarketType').value || 'spot';

            // 验证输入
            if (!strategyName) {
                showToast('请选择策略', 'error');
                return;
            }

            if (!symbol) {
                showToast('请输入交易对', 'error');
                return;
            }
            if (!startDate || !endDate) {
                showToast('请选择日期范围', 'error');
                return;
            }
            if (new Date(endDate) <= new Date(startDate)) {
                showToast('结束日期必须晚于开始日期', 'error');
                return;
            }
            
            // 检查日期范围（不能超过365天）
            const daysDiff = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24);
            if (daysDiff > 365) {
                showToast('回测时间范围不能超过365天', 'error');
                return;
            }

            const resultDiv = document.getElementById('backtestResult');
            const loadingDiv = document.getElementById('backtestLoading');
            const backtestBtn = document.querySelector('#backtestModal .modal-footer .btn-primary');

            // 显示加载状态
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (resultDiv) resultDiv.style.display = 'none';
            if (backtestBtn) backtestBtn.disabled = true;

            try {
                const response = await fetch('/api/strategies/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        strategy_name: strategyName,
                        symbol: symbol,
                        start_date: startDate,
                        end_date: endDate,
                        initial_balance: initialBalance,
                        market_type: marketType
                    })
                });

                const data = await response.json();

                if (loadingDiv) loadingDiv.style.display = 'none';

                if (data.success && data.backtest_result) {
                    const result = data.backtest_result;
                    
                    // 显示指标
                    const metricsDiv = document.getElementById('backtestMetrics');
                    if (metricsDiv) {
                        metricsDiv.innerHTML = `
                            <div class="strategy-detail-card">
                                <div class="strategy-detail-card-label">总收益率</div>
                                <div class="strategy-detail-card-value" style="color: ${result.total_return >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                    ${result.total_return >= 0 ? '+' : ''}${result.total_return}%
                                </div>
                            </div>
                            <div class="strategy-detail-card">
                                <div class="strategy-detail-card-label">最终权益</div>
                                <div class="strategy-detail-card-value">${result.final_equity.toFixed(2)} USDT</div>
                            </div>
                            <div class="strategy-detail-card">
                                <div class="strategy-detail-card-label">总交易次数</div>
                                <div class="strategy-detail-card-value">${result.total_trades}</div>
                            </div>
                            <div class="strategy-detail-card">
                                <div class="strategy-detail-card-label">胜率</div>
                                <div class="strategy-detail-card-value" style="color: ${result.win_rate >= 50 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                    ${result.win_rate}%
                                </div>
                            </div>
                            <div class="strategy-detail-card">
                                <div class="strategy-detail-card-label">最大回撤</div>
                                <div class="strategy-detail-card-value" style="color: var(--danger-red);">
                                    -${result.max_drawdown}%
                                </div>
                            </div>
                            <div class="strategy-detail-card">
                                <div class="strategy-detail-card-label">盈亏比</div>
                                <div class="strategy-detail-card-value">${result.profit_factor}</div>
                            </div>
                        `;
                    }

                    // 显示交易记录
                    const tradesTbody = document.getElementById('backtestTrades');
                    if (tradesTbody && result.trades) {
                        tradesTbody.innerHTML = result.trades.map(trade => {
                            const pnl = trade.pnl || 0;
                            const pnlPct = trade.pnl_pct || 0;
                            return `
                                <tr style="border-bottom: 1px solid var(--border-muted);">
                                    <td style="padding: var(--spacing-sm); color: var(--text-secondary);">
                                        ${new Date(trade.timestamp).toLocaleString('zh-CN')}
                                    </td>
                                    <td style="padding: var(--spacing-sm);">${trade.action}</td>
                                    <td style="padding: var(--spacing-sm); text-align: right; font-family: var(--font-mono);">
                                        ${trade.price.toFixed(4)}
                                    </td>
                                    <td style="padding: var(--spacing-sm); text-align: right; font-family: var(--font-mono); color: ${pnl >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                        ${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }

                    if (resultDiv) resultDiv.style.display = 'block';
                } else {
                    showToast(data.detail || data.message || '回测失败', 'error');
                }
            } catch (error) {
                console.error('回测失败:', error);
                showToast('回测失败: ' + error.message, 'error');
                if (loadingDiv) loadingDiv.style.display = 'none';
            } finally {
                if (backtestBtn) backtestBtn.disabled = false;
            }
        }

        // 显示AI生成策略模态框
        function showAutoGenerateModal() {
            const modal = document.getElementById('autoGenerateModal');
            const baseStrategySelect = document.getElementById('autoGenBaseStrategy');
            const resultDiv = document.getElementById('autoGenResult');
            const loadingDiv = document.getElementById('autoGenLoading');
            
            if (modal) {
                // 加载策略列表
                if (baseStrategySelect && allStrategies) {
                    baseStrategySelect.innerHTML = '<option value="">从头开始生成</option>';
                    allStrategies.forEach(strategy => {
                        const option = document.createElement('option');
                        option.value = strategy.name;
                        option.textContent = `${strategy.name}${strategy.active ? ' (激活中)' : ''}`;
                        baseStrategySelect.appendChild(option);
                    });
                }
                
                // 设置默认日期（最近3个月）
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 3);
                
                document.getElementById('autoGenEndDate').value = endDate.toISOString().split('T')[0];
                document.getElementById('autoGenStartDate').value = startDate.toISOString().split('T')[0];
                
                // 清空结果
                if (resultDiv) resultDiv.style.display = 'none';
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                modal.classList.add('active');
            }
        }

        // 隐藏AI生成策略模态框
        function hideAutoGenerateModal() {
            const modal = document.getElementById('autoGenerateModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 开始自动生成策略
        async function startAutoGenerate() {
            const baseStrategy = document.getElementById('autoGenBaseStrategy').value.trim();
            const symbol = document.getElementById('autoGenSymbol').value.trim();
            const startDate = document.getElementById('autoGenStartDate').value;
            const endDate = document.getElementById('autoGenEndDate').value;
            const marketType = document.getElementById('autoGenMarketType').value || 'spot';
            const populationSize = parseInt(document.getElementById('autoGenPopulationSize').value) || 20;
            const generations = parseInt(document.getElementById('autoGenGenerations').value) || 10;

            // 验证输入
            if (!symbol) {
                showToast('请输入交易对', 'error');
                return;
            }
            if (!startDate || !endDate) {
                showToast('请选择日期范围', 'error');
                return;
            }
            if (new Date(endDate) <= new Date(startDate)) {
                showToast('结束日期必须晚于开始日期', 'error');
                return;
            }
            
            const daysDiff = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24);
            if (daysDiff < 30) {
                showToast('训练数据至少需要30天', 'error');
                return;
            }
            if (daysDiff > 365) {
                showToast('训练数据不能超过365天', 'error');
                return;
            }

            const resultDiv = document.getElementById('autoGenResult');
            const loadingDiv = document.getElementById('autoGenLoading');
            const progressDiv = document.getElementById('autoGenProgress');
            const generateBtn = document.querySelector('#autoGenerateModal .modal-footer .btn-success');

            // 显示加载状态
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (resultDiv) resultDiv.style.display = 'none';
            if (generateBtn) generateBtn.disabled = true;

            try {
                // 更新进度
                if (progressDiv) {
                    progressDiv.textContent = '正在初始化优化器...';
                }

                const response = await fetch('/api/strategies/auto-generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_strategy_name: baseStrategy || null,
                        symbol: symbol,
                        start_date: startDate,
                        end_date: endDate,
                        initial_balance: 10000,
                        market_type: marketType,
                        population_size: populationSize,
                        generations: generations
                    })
                });

                const data = await response.json();

                if (loadingDiv) loadingDiv.style.display = 'none';

                if (data.success) {
                    // 显示结果
                    const resultContent = document.getElementById('autoGenResultContent');
                    if (resultContent) {
                        const metrics = data.metrics || {};
                        resultContent.innerHTML = `
                            <div style="background: var(--success-green); color: white; padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: var(--spacing-sm);">
                                    <i class="bi bi-check-circle"></i> 策略生成成功！
                                </div>
                                <div style="font-size: 14px;">策略名称: <strong>${data.strategy_name}</strong></div>
                                <div style="font-size: 14px;">优化分数: <strong>${data.score.toFixed(2)}</strong></div>
                                <div style="font-size: 14px;">迭代代数: <strong>${data.generation + 1}</strong></div>
                            </div>
                            <div class="strategy-detail-grid">
                                <div class="strategy-detail-card">
                                    <div class="strategy-detail-card-label">总收益率</div>
                                    <div class="strategy-detail-card-value" style="color: ${metrics.total_return >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                        ${metrics.total_return >= 0 ? '+' : ''}${metrics.total_return || 0}%
                                    </div>
                                </div>
                                <div class="strategy-detail-card">
                                    <div class="strategy-detail-card-label">胜率</div>
                                    <div class="strategy-detail-card-value" style="color: ${metrics.win_rate >= 50 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                        ${metrics.win_rate || 0}%
                                    </div>
                                </div>
                                <div class="strategy-detail-card">
                                    <div class="strategy-detail-card-label">最大回撤</div>
                                    <div class="strategy-detail-card-value" style="color: var(--danger-red);">
                                        -${metrics.max_drawdown || 0}%
                                    </div>
                                </div>
                                <div class="strategy-detail-card">
                                    <div class="strategy-detail-card-label">盈亏比</div>
                                    <div class="strategy-detail-card-value">${metrics.profit_factor || 0}</div>
                                </div>
                            </div>
                            <div style="margin-top: var(--spacing-md);">
                                <button class="btn btn-primary" onclick="hideAutoGenerateModal(); loadStrategies(); setTimeout(() => { selectStrategy('${data.strategy_name}'); }, 300);" style="width: 100%;">
                                    <i class="bi bi-eye"></i> 查看生成的策略
                                </button>
                            </div>
                        `;
                    }
                    if (resultDiv) resultDiv.style.display = 'block';
                    showToast('策略生成成功！', 'success');
                } else {
                    showToast(data.detail || data.message || '生成策略失败', 'error');
                }
            } catch (error) {
                console.error('生成策略失败:', error);
                showToast('生成策略失败: ' + error.message, 'error');
                if (loadingDiv) loadingDiv.style.display = 'none';
            } finally {
                if (generateBtn) generateBtn.disabled = false;
            }
        }

        // 显示AI找买卖点模态框
        function showOptimalPointsModal() {
            const modal = document.getElementById('optimalPointsModal');
            const resultDiv = document.getElementById('optimalPointsResult');
            const loadingDiv = document.getElementById('optimalPointsLoading');
            
            if (modal) {
                // 设置默认日期（最近3个月）
                const endDate = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 3);
                
                document.getElementById('optimalPointsEndDate').value = endDate.toISOString().split('T')[0];
                document.getElementById('optimalPointsStartDate').value = startDate.toISOString().split('T')[0];
                
                // 清空结果
                if (resultDiv) resultDiv.style.display = 'none';
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                modal.classList.add('active');
            }
        }

        // 隐藏AI找买卖点模态框
        function hideOptimalPointsModal() {
            const modal = document.getElementById('optimalPointsModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 开始分析最佳买卖点
        async function startOptimalPointsAnalysis() {
            const symbol = document.getElementById('optimalPointsSymbol').value.trim();
            const startDate = document.getElementById('optimalPointsStartDate').value;
            const endDate = document.getElementById('optimalPointsEndDate').value;
            const marketType = document.getElementById('optimalPointsMarketType').value || 'spot';
            const lookback = parseInt(document.getElementById('optimalPointsLookback').value) || 20;
            const minProfit = parseFloat(document.getElementById('optimalPointsMinProfit').value) || 5;

            // 验证输入
            if (!symbol) {
                showToast('请输入交易对', 'error');
                return;
            }
            if (!startDate || !endDate) {
                showToast('请选择日期范围', 'error');
                return;
            }
            if (new Date(endDate) <= new Date(startDate)) {
                showToast('结束日期必须晚于开始日期', 'error');
                return;
            }
            
            const daysDiff = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24);
            if (daysDiff < 7) {
                showToast('分析时间范围至少需要7天', 'error');
                return;
            }
            if (daysDiff > 365) {
                showToast('分析时间范围不能超过365天', 'error');
                return;
            }

            const resultDiv = document.getElementById('optimalPointsResult');
            const loadingDiv = document.getElementById('optimalPointsLoading');
            const analyzeBtn = document.querySelector('#optimalPointsModal .modal-footer .btn-info');

            // 显示加载状态
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (resultDiv) resultDiv.style.display = 'none';
            if (analyzeBtn) analyzeBtn.disabled = true;

            try {
                const response = await fetch('/api/strategies/optimal-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        start_date: startDate,
                        end_date: endDate,
                        market_type: marketType,
                        lookback_period: lookback,
                        min_profit_pct: minProfit
                    })
                });

                const data = await response.json();

                if (loadingDiv) loadingDiv.style.display = 'none';

                if (data.success) {
                    // 更新统计
                    document.getElementById('optimalBuyCount').textContent = data.buy_points.length;
                    document.getElementById('optimalSellCount').textContent = data.sell_points.length;
                    document.getElementById('optimalPairsCount').textContent = data.total_opportunities;

                    // 显示买点列表（包含对应的卖点和收益）
                    const buyPointsList = document.getElementById('optimalBuyPointsList');
                    if (buyPointsList && data.buy_points) {
                        buyPointsList.innerHTML = data.buy_points.slice(0, 10).map((point, idx) => {
                            const timestamp = new Date(point.timestamp).toLocaleString('zh-CN');
                            const hasSell = point.optimal_sell && point.expected_profit_pct > 0;
                            return `
                                <div style="background: var(--bg-tertiary); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--success-green);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <div style="font-weight: 600; color: var(--success-green);">买点 #${idx + 1}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">评分: ${point.score}</div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${timestamp}</div>
                                    <div style="font-family: var(--font-mono); font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">$${point.price.toFixed(4)}</div>
                                    ${point.reasons ? `<div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px;">${point.reasons.join(', ')}</div>` : ''}
                                    ${hasSell ? `
                                        <div style="border-top: 1px solid var(--border-muted); padding-top: 6px; margin-top: 6px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                                <div style="font-size: 11px; color: var(--text-secondary);">最佳卖点:</div>
                                                <div style="font-size: 14px; font-weight: 700; color: var(--success-green);">+${point.expected_profit_pct}%</div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">${new Date(point.optimal_sell.timestamp).toLocaleString('zh-CN')}</div>
                                            <div style="font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--danger-red);">$${point.optimal_sell.price.toFixed(4)}</div>
                                            ${point.duration_days ? `<div style="font-size: 10px; color: var(--text-tertiary); margin-top: 2px;">持仓: ${point.duration_days} 天</div>` : ''}
                                        </div>
                                    ` : `
                                        <div style="border-top: 1px solid var(--border-muted); padding-top: 6px; margin-top: 6px;">
                                            <div style="font-size: 11px; color: var(--text-tertiary);">暂无匹配的卖点</div>
                                        </div>
                                    `}
                                </div>
                            `;
                        }).join('');
                    }

                    // 显示卖点列表（包含对应的买点和收益）
                    const sellPointsList = document.getElementById('optimalSellPointsList');
                    if (sellPointsList && data.sell_points) {
                        sellPointsList.innerHTML = data.sell_points.slice(0, 10).map((point, idx) => {
                            const timestamp = new Date(point.timestamp).toLocaleString('zh-CN');
                            const hasBuy = point.optimal_buy && point.expected_profit_pct > 0;
                            return `
                                <div style="background: var(--bg-tertiary); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--danger-red);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                        <div style="font-weight: 600; color: var(--danger-red);">卖点 #${idx + 1}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">评分: ${point.score}</div>
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${timestamp}</div>
                                    <div style="font-family: var(--font-mono); font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">$${point.price.toFixed(4)}</div>
                                    ${point.reasons ? `<div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px;">${point.reasons.join(', ')}</div>` : ''}
                                    ${hasBuy ? `
                                        <div style="border-top: 1px solid var(--border-muted); padding-top: 6px; margin-top: 6px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                                <div style="font-size: 11px; color: var(--text-secondary);">对应买点:</div>
                                                <div style="font-size: 14px; font-weight: 700; color: var(--success-green);">+${point.expected_profit_pct}%</div>
                                            </div>
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">${new Date(point.optimal_buy.timestamp).toLocaleString('zh-CN')}</div>
                                            <div style="font-family: var(--font-mono); font-size: 12px; font-weight: 600; color: var(--success-green);">$${point.optimal_buy.price.toFixed(4)}</div>
                                            ${point.duration_days ? `<div style="font-size: 10px; color: var(--text-tertiary); margin-top: 2px;">持仓: ${point.duration_days} 天</div>` : ''}
                                        </div>
                                    ` : `
                                        <div style="border-top: 1px solid var(--border-muted); padding-top: 6px; margin-top: 6px;">
                                            <div style="font-size: 11px; color: var(--text-tertiary);">暂无匹配的买点</div>
                                        </div>
                                    `}
                                </div>
                            `;
                        }).join('');
                    }

                    // 显示交易对列表
                    const pairsList = document.getElementById('optimalPairsList');
                    if (pairsList && data.optimal_pairs) {
                        pairsList.innerHTML = data.optimal_pairs.map((pair, idx) => {
                            const buyTime = new Date(pair.buy.timestamp).toLocaleString('zh-CN');
                            const sellTime = new Date(pair.sell.timestamp).toLocaleString('zh-CN');
                            return `
                                <div style="background: var(--bg-tertiary); padding: var(--spacing-md); border-radius: var(--radius-md); margin-bottom: var(--spacing-md);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                                        <div style="font-weight: 600;">交易对 #${idx + 1}</div>
                                        <div style="font-size: 18px; font-weight: 700; color: var(--success-green);">+${pair.profit_pct}%</div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                                        <div style="border-left: 3px solid var(--success-green); padding-left: var(--spacing-sm);">
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">买入</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${buyTime}</div>
                                            <div style="font-family: var(--font-mono); font-weight: 600; color: var(--success-green);">$${pair.buy.price.toFixed(4)}</div>
                                        </div>
                                        <div style="border-left: 3px solid var(--danger-red); padding-left: var(--spacing-sm);">
                                            <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 2px;">卖出</div>
                                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${sellTime}</div>
                                            <div style="font-family: var(--font-mono); font-weight: 600; color: var(--danger-red);">$${pair.sell.price.toFixed(4)}</div>
                                        </div>
                                    </div>
                                    ${pair.duration_days ? `<div style="font-size: 11px; color: var(--text-tertiary); margin-top: var(--spacing-sm);">持仓时长: ${pair.duration_days} 天</div>` : ''}
                                </div>
                            `;
                        }).join('');
                    }

                    if (resultDiv) resultDiv.style.display = 'block';
                } else {
                    showToast(data.detail || data.message || '分析失败', 'error');
                }
            } catch (error) {
                console.error('分析失败:', error);
                showToast('分析失败: ' + error.message, 'error');
                if (loadingDiv) loadingDiv.style.display = 'none';
            } finally {
                if (analyzeBtn) analyzeBtn.disabled = false;
            }
        }

        // 显示价格预测模态框
        function showPricePredictionModal() {
            const modal = document.getElementById('pricePredictionModal');
            const resultDiv = document.getElementById('predictionResult');
            const loadingDiv = document.getElementById('predictionLoading');
            
            if (modal) {
                // 清空结果
                if (resultDiv) resultDiv.style.display = 'none';
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                modal.classList.add('active');
            }
        }

        // 隐藏价格预测模态框
        function hidePricePredictionModal() {
            const modal = document.getElementById('pricePredictionModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 开始价格预测
        async function startPricePrediction() {
            const symbol = document.getElementById('predictionSymbol').value.trim();
            const marketType = document.getElementById('predictionMarketType').value || 'spot';
            const daysAheadInput = document.getElementById('predictionDaysAhead').value;
            const daysAhead = parseInt(daysAheadInput) || 3;

            // 验证输入
            if (!symbol) {
                showToast('请输入交易对', 'error');
                return;
            }
            
            // 验证days_ahead
            if (isNaN(daysAhead) || daysAhead < 1 || daysAhead > 7) {
                showToast('预测天数必须在1-7天之间', 'error');
                return;
            }

            const resultDiv = document.getElementById('predictionResult');
            const loadingDiv = document.getElementById('predictionLoading');
            const predictBtn = document.querySelector('#pricePredictionModal .modal-footer .btn-warning');

            // 显示加载状态
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (resultDiv) resultDiv.style.display = 'none';
            if (predictBtn) predictBtn.disabled = true;

            try {
                const response = await fetch('/api/strategies/price-prediction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        market_type: marketType,
                        days_ahead: daysAhead
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: '请求失败' }));
                    console.error('API错误:', errorData);
                    
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    
                    // 显示详细的错误信息
                    let errorMsg = '预测失败';
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            errorMsg = errorData.detail.map(e => {
                                const field = e.loc ? e.loc.slice(1).join('.') : '未知字段';
                                return `${field}: ${e.msg}`;
                            }).join('; ');
                        } else if (typeof errorData.detail === 'string') {
                            errorMsg = errorData.detail;
                        } else {
                            errorMsg = JSON.stringify(errorData.detail);
                        }
                    }
                    showToast(errorMsg, 'error');
                    return;
                }

                const data = await response.json();

                if (loadingDiv) loadingDiv.style.display = 'none';

                if (data.success) {
                    // 更新主要指标
                    document.getElementById('predictionCurrentPrice').textContent = `$${data.current_price.toFixed(4)}`;
                    document.getElementById('predictionFuturePrice').textContent = `$${data.prediction.predicted_price.toFixed(4)}`;
                    
                    const changePct = data.prediction.price_change_pct;
                    const changeEl = document.getElementById('predictionChange');
                    changeEl.textContent = `${changePct >= 0 ? '+' : ''}${changePct}%`;
                    changeEl.style.color = changePct >= 0 ? 'var(--success-green)' : 'var(--danger-red)';
                    
                    // 预测方向
                    const directionMap = {
                        'upward': { text: '📈 上涨', color: 'var(--success-green)' },
                        'downward': { text: '📉 下跌', color: 'var(--danger-red)' },
                        'neutral': { text: '➡️ 震荡', color: 'var(--text-secondary)' }
                    };
                    const direction = directionMap[data.prediction.direction] || directionMap['neutral'];
                    const directionEl = document.getElementById('predictionDirection');
                    directionEl.textContent = direction.text;
                    directionEl.style.color = direction.color;
                    
                    // 置信度
                    document.getElementById('predictionConfidence').textContent = `${data.confidence}%`;
                    
                    // 当前趋势
                    const trend = data.current_trend;
                    const trendText = trend.direction === 'upward' ? '📈 上升' : trend.direction === 'downward' ? '📉 下降' : '➡️ 中性';
                    document.getElementById('predictionTrend').textContent = trendText;
                    
                    // 交易建议
                    const rec = data.recommendation;
                    const recEl = document.getElementById('predictionRecommendation');
                    const actionColors = {
                        'BUY': 'var(--success-green)',
                        'SELL': 'var(--danger-red)',
                        'HOLD': 'var(--text-secondary)',
                        'HOLD_BUY': 'var(--success-green)',
                        'HOLD_SELL': 'var(--danger-red)'
                    };
                    recEl.innerHTML = `
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <div style="font-size: 16px; font-weight: 600; color: ${actionColors[rec.action] || 'var(--text-primary)'};">
                                ${rec.action === 'BUY' ? '🟢 买入' : rec.action === 'SELL' ? '🔴 卖出' : rec.action === 'HOLD_BUY' ? '🟡 轻仓买入' : rec.action === 'HOLD_SELL' ? '🟡 谨慎观望' : '⚪ 观望'}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">风险等级: ${rec.risk_level}</div>
                        </div>
                        <div style="font-size: 14px; color: var(--text-primary); line-height: 1.6;">${rec.advice}</div>
                    `;
                    
                    // 预测点列表
                    const pointsList = document.getElementById('predictionPointsList');
                    if (pointsList && data.prediction_points) {
                        pointsList.innerHTML = data.prediction_points.map(point => {
                            const timestamp = new Date(point.timestamp).toLocaleString('zh-CN');
                            return `
                                <div style="background: var(--bg-secondary); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm); border-left: 3px solid var(--primary-blue);">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">第${point.day}天</div>
                                            <div style="font-size: 11px; color: var(--text-tertiary);">${timestamp}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-family: var(--font-mono); font-weight: 600; color: var(--text-primary);">$${point.predicted_price.toFixed(4)}</div>
                                            <div style="font-size: 12px; color: ${point.price_change_pct >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                                ${point.price_change_pct >= 0 ? '+' : ''}${point.price_change_pct}%
                                            </div>
                                            <div style="font-size: 10px; color: var(--text-tertiary);">置信度: ${point.confidence}%</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                    
                    // 关键价位
                    const keyLevels = data.key_levels;
                    const keyLevelsEl = document.getElementById('predictionKeyLevels');
                    if (keyLevelsEl) {
                        keyLevelsEl.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--spacing-md);">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">支撑位</div>
                                    <div style="font-family: var(--font-mono); font-weight: 600; color: var(--success-green);">$${keyLevels.support.toFixed(4)}</div>
                                    <div style="font-size: 11px; color: var(--text-tertiary);">距离: ${keyLevels.support_distance_pct}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">当前价</div>
                                    <div style="font-family: var(--font-mono); font-weight: 600; color: var(--text-primary);">$${keyLevels.current_price.toFixed(4)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">阻力位</div>
                                    <div style="font-family: var(--font-mono); font-weight: 600; color: var(--danger-red);">$${keyLevels.resistance.toFixed(4)}</div>
                                    <div style="font-size: 11px; color: var(--text-tertiary);">距离: ${keyLevels.resistance_distance_pct}%</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 风险提示
                    if (data.risk_factors && data.risk_factors.length > 0) {
                        const risksEl = document.getElementById('predictionRisks');
                        const risksListEl = document.getElementById('predictionRisksList');
                        if (risksEl && risksListEl) {
                            risksListEl.innerHTML = data.risk_factors.map(risk => `
                                <div style="padding: var(--spacing-sm); margin-bottom: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-sm); border-left: 3px solid var(--danger-red);">
                                    <div style="font-size: 13px; color: var(--text-primary);">${risk}</div>
                                </div>
                            `).join('');
                            risksEl.style.display = 'block';
                        }
                    } else {
                        const risksEl = document.getElementById('predictionRisks');
                        if (risksEl) risksEl.style.display = 'none';
                    }

                    if (resultDiv) resultDiv.style.display = 'block';
                } else {
                    showToast(data.detail || data.message || '预测失败', 'error');
                }
            } catch (error) {
                console.error('预测失败:', error);
                showToast('预测失败: ' + error.message, 'error');
                if (loadingDiv) loadingDiv.style.display = 'none';
            } finally {
                if (predictBtn) predictBtn.disabled = false;
            }
        }

        // 显示交易诊断模态框
        function showTradeDiagnosticModal() {
            const modal = document.getElementById('tradeDiagnosticModal');
            const resultDiv = document.getElementById('diagnosticResult');
            const loadingDiv = document.getElementById('diagnosticLoading');
            
            if (modal) {
                // 清空结果
                if (resultDiv) resultDiv.style.display = 'none';
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                // 设置默认日期为前天
                const dateInput = document.getElementById('diagnosticDate');
                if (dateInput) {
                    const twoDaysAgo = new Date();
                    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
                    dateInput.value = twoDaysAgo.toISOString().split('T')[0];
                }
                
                modal.classList.add('active');
            }
        }

        // 隐藏交易诊断模态框
        function hideTradeDiagnosticModal() {
            const modal = document.getElementById('tradeDiagnosticModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 开始交易诊断
        async function startTradeDiagnostic() {
            const symbol = document.getElementById('diagnosticSymbol').value.trim();
            const date = document.getElementById('diagnosticDate').value;
            const time = document.getElementById('diagnosticTime').value;
            const tradeType = document.getElementById('diagnosticTradeType').value || 'buy';
            const marketType = document.getElementById('diagnosticMarketType').value || 'spot';

            // 验证输入
            if (!symbol) {
                showToast('请输入交易对', 'error');
                return;
            }
            if (!date || !time) {
                showToast('请选择交易日期和时间', 'error');
                return;
            }

            // 构建时间字符串
            const tradeTime = `${date}T${time}:00`;

            const resultDiv = document.getElementById('diagnosticResult');
            const loadingDiv = document.getElementById('diagnosticLoading');
            const diagnosticBtn = document.querySelector('#tradeDiagnosticModal .modal-footer .btn-primary');

            // 显示加载状态
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (resultDiv) resultDiv.style.display = 'none';
            if (diagnosticBtn) diagnosticBtn.disabled = true;

            try {
                const response = await fetch('/api/strategies/trade-diagnostic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        trade_time: tradeTime,
                        trade_type: tradeType,
                        market_type: marketType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: '请求失败' }));
                    console.error('API错误:', errorData);
                    
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    
                    let errorMsg = '诊断失败';
                    if (errorData.detail) {
                        if (Array.isArray(errorData.detail)) {
                            errorMsg = errorData.detail.map(e => {
                                const field = e.loc ? e.loc.slice(1).join('.') : '未知字段';
                                return `${field}: ${e.msg}`;
                            }).join('; ');
                        } else if (typeof errorData.detail === 'string') {
                            errorMsg = errorData.detail;
                        }
                    }
                    showToast(errorMsg, 'error');
                    return;
                }

                const data = await response.json();

                if (loadingDiv) loadingDiv.style.display = 'none';

                if (data.success) {
                    // 更新主要指标
                    document.getElementById('diagnosticTradePrice').textContent = `$${data.trade_price.toFixed(4)}`;
                    document.getElementById('diagnosticScore').textContent = `${data.diagnosis.overall_score}分`;
                    document.getElementById('diagnosticConclusion').textContent = data.diagnosis.conclusion;
                    document.getElementById('diagnosticDescription').textContent = data.diagnosis.description;
                    
                    // 时机分析
                    const timing = data.timing_analysis;
                    document.getElementById('diagnosticTiming').innerHTML = `
                        <div style="font-size: 13px; color: var(--text-primary); margin-bottom: var(--spacing-sm);">
                            ${timing.assessment}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            买入前24h: <span style="color: ${timing.price_change_before_24h_pct >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                ${timing.price_change_before_24h_pct >= 0 ? '+' : ''}${timing.price_change_before_24h_pct}%
                            </span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            买入后24h: <span style="color: ${timing.price_change_after_24h_pct >= 0 ? 'var(--success-green)' : 'var(--danger-red)'};">
                                ${timing.price_change_after_24h_pct >= 0 ? '+' : ''}${timing.price_change_after_24h_pct}%
                            </span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: var(--spacing-sm);">
                            时机评分: <strong style="color: var(--primary-blue);">${timing.score}分</strong>
                        </div>
                    `;
                    
                    // 市场环境
                    const market = data.market_analysis;
                    document.getElementById('diagnosticMarket').innerHTML = `
                        <div style="font-size: 13px; color: var(--text-primary); margin-bottom: var(--spacing-sm);">
                            趋势: <strong>${market.trend === 'uptrend' ? '📈 上涨' : market.trend === 'downtrend' ? '📉 下跌' : '➡️ 震荡'}</strong>
                            <span style="font-size: 11px; color: var(--text-secondary);">(${market.trend_strength})</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            波动率: ${market.volatility}% <span style="font-size: 11px;">(${market.volatility_level})</span>
                        </div>
                    `;
                    
                    // 技术指标
                    const indicators = data.indicator_analysis;
                    document.getElementById('diagnosticIndicators').innerHTML = `
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: var(--spacing-sm);">
                            指标评分: <strong style="color: var(--primary-blue);">${indicators.score}分</strong>
                        </div>
                        ${indicators.signals.length > 0 ? `
                            <div style="font-size: 12px; color: var(--text-primary);">
                                ${indicators.signals.map(s => `<div style="margin-bottom: 4px;">• ${s}</div>`).join('')}
                            </div>
                        ` : '<div style="font-size: 12px; color: var(--text-tertiary);">无明确信号</div>'}
                        ${indicators.rsi ? `<div style="font-size: 11px; color: var(--text-tertiary); margin-top: var(--spacing-sm);">RSI: ${indicators.rsi}</div>` : ''}
                    `;
                    
                    // 价格位置
                    const pricePos = data.price_position_analysis;
                    document.getElementById('diagnosticPricePosition').innerHTML = `
                        <div style="font-size: 13px; color: var(--text-primary); margin-bottom: var(--spacing-sm);">
                            位置: <strong>${pricePos.position}</strong>
                            <span style="font-size: 11px; color: var(--text-secondary);">(${pricePos.position_pct}%)</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            近期高点: $${pricePos.recent_high.toFixed(4)}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            近期低点: $${pricePos.recent_low.toFixed(4)}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: var(--spacing-sm);">
                            位置评分: <strong style="color: var(--primary-blue);">${pricePos.score}分</strong>
                        </div>
                    `;
                    
                    // 后续表现
                    const performance = data.performance_analysis;
                    if (performance.available) {
                        const perf = performance.performance;
                        document.getElementById('diagnosticPerformance').innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: var(--spacing-sm);">
                                ${Object.entries(perf).map(([period, data]) => `
                                    <div style="text-align: center; padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-sm);">
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">${period}</div>
                                        <div style="font-family: var(--font-mono); font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">
                                            $${data.price.toFixed(4)}
                                        </div>
                                        <div style="font-size: 12px; color: ${data.profit ? 'var(--success-green)' : 'var(--danger-red)'};">
                                            ${data.change_pct >= 0 ? '+' : ''}${data.change_pct}%
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        document.getElementById('diagnosticPerformance').innerHTML = `
                            <div style="font-size: 13px; color: var(--text-tertiary);">${performance.message || '数据不足，无法分析后续表现'}</div>
                        `;
                    }
                    
                    // 建议
                    document.getElementById('diagnosticRecommendations').innerHTML = `
                        <div style="font-size: 13px; color: var(--text-primary); line-height: 1.8;">
                            ${data.recommendations.map(rec => `<div style="margin-bottom: var(--spacing-sm);">• ${rec}</div>`).join('')}
                        </div>
                    `;
                    
                    // 问题和优点
                    if (data.diagnosis.issues && data.diagnosis.issues.length > 0) {
                        document.getElementById('diagnosticIssuesList').innerHTML = `
                            <div style="font-size: 13px; color: var(--text-primary);">
                                ${data.diagnosis.issues.map(issue => `<div style="margin-bottom: var(--spacing-sm); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-sm); border-left: 3px solid var(--danger-red);">• ${issue}</div>`).join('')}
                            </div>
                        `;
                        document.getElementById('diagnosticIssues').style.display = 'block';
                    } else {
                        document.getElementById('diagnosticIssues').style.display = 'none';
                    }
                    
                    if (data.diagnosis.advantages && data.diagnosis.advantages.length > 0) {
                        document.getElementById('diagnosticAdvantagesList').innerHTML = `
                            <div style="font-size: 13px; color: var(--text-primary);">
                                ${data.diagnosis.advantages.map(adv => `<div style="margin-bottom: var(--spacing-sm); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius-sm); border-left: 3px solid var(--success-green);">• ${adv}</div>`).join('')}
                            </div>
                        `;
                        document.getElementById('diagnosticAdvantages').style.display = 'block';
                    } else {
                        document.getElementById('diagnosticAdvantages').style.display = 'none';
                    }

                    if (resultDiv) resultDiv.style.display = 'block';
                } else {
                    showToast(data.detail || data.message || '诊断失败', 'error');
                }
            } catch (error) {
                console.error('诊断失败:', error);
                showToast('诊断失败: ' + error.message, 'error');
                if (loadingDiv) loadingDiv.style.display = 'none';
            } finally {
                if (diagnosticBtn) diagnosticBtn.disabled = false;
            }
        }

        // 查理·芒格名言数据
        const mungerQuotes = [
            {
                quote: "我只是想知道我将来会死在哪里，这样我就永远不去那个地方。",
                strategy: "避免错误比追求正确更重要。在投资中，识别并避开高风险信号，设置严格止损，保护本金是第一要务。"
            },
            {
                quote: "在生活中，避免愚蠢比追求聪明更重要。",
                strategy: "避免常见的投资错误：不要追涨杀跌、不要FOMO、不要频繁交易、不要过度杠杆。冷静思考，理性决策。"
            },
            {
                quote: "耐心是投资者的美德。",
                strategy: "长期持有优质资产，避免因短期波动而做出冲动决策。设置最小持仓时间，需要多个时间周期确认趋势后再行动。"
            },
            {
                quote: "多元化是无知的保护伞。",
                strategy: "适度多元化，但不要过度分散。只持有3-5个最优质的币种，避免持有高度相关的资产，对最有把握的机会加大仓位。"
            },
            {
                quote: "如果你想得到某样东西，最可靠的办法是让自己配得上它。",
                strategy: "不断提升投资能力，只投资自己理解的领域。专注于主流币种，记录和分析每次交易，根据历史表现持续优化策略。"
            },
            {
                quote: "在别人贪婪时恐惧，在别人恐惧时贪婪。",
                strategy: "逆向思维，市场情绪极端时反向操作。恐慌指数极低且技术指标超卖时买入，贪婪指数极高且技术指标超买时卖出。"
            },
            {
                quote: "复利是世界第八大奇迹。",
                strategy: "长期复利增长，避免频繁交易损耗。将利润再投资，降低交易频率，控制交易成本，追求稳健的长期收益。"
            }
        ];
        let currentMungerQuoteIndex = 0;

        // 显示芒格名言模态框
        function showMungerQuotes() {
            const modal = document.getElementById('mungerQuotesModal');
            if (!modal) return;
            
            // 重置到第一条
            currentMungerQuoteIndex = 0;
            displayMungerQuote(0);
            
            modal.classList.add('active');
        }

        // 关闭芒格名言模态框
        function hideMungerQuotes() {
            const modal = document.getElementById('mungerQuotesModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // 显示芒格名言
        function displayMungerQuote(index) {
            if (index < 0) index = mungerQuotes.length - 1;
            if (index >= mungerQuotes.length) index = 0;
            currentMungerQuoteIndex = index;

            const quote = mungerQuotes[index];
            const quoteElement = document.getElementById('mungerQuote');
            const strategyElement = document.getElementById('mungerQuoteStrategyText');
            
            if (quoteElement) {
                // 淡出效果
                quoteElement.style.opacity = '0';
                setTimeout(() => {
                    quoteElement.innerHTML = `"${quote.quote}"`;
                    if (strategyElement) {
                        strategyElement.textContent = quote.strategy;
                    }
                    const indexElement = document.getElementById('mungerQuoteIndex');
                    if (indexElement) {
                        indexElement.textContent = `${index + 1} / ${mungerQuotes.length}`;
                    }
                    // 淡入效果
                    quoteElement.style.opacity = '1';
                }, 150);
            }
        }

        // 上一条名言
        function previousMungerQuote() {
            displayMungerQuote(currentMungerQuoteIndex - 1);
        }

        // 下一条名言
        function nextMungerQuote() {
            displayMungerQuote(currentMungerQuoteIndex + 1);
        }

        // 刷新名言（随机显示）
        function refreshMungerQuote() {
            const randomIndex = Math.floor(Math.random() * mungerQuotes.length);
            displayMungerQuote(randomIndex);
        }

        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            loadStrategies();
        });
    </script>

    <!-- 芒格名言模态框 -->
    <div id="mungerQuotesModal" class="modal-overlay" onclick="if(event.target === this) hideMungerQuotes()">
        <div class="modal-dialog" style="max-width: 700px;" onclick="event.stopPropagation()">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(43, 111, 237, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%); border-bottom: 1px solid rgba(43, 111, 237, 0.2);">
                <div class="modal-title" style="display: flex; align-items: center; gap: 12px;">
                    <i class="bi bi-quote" style="color: var(--primary-blue); font-size: 24px;"></i>
                    <span>查理·芒格投资智慧</span>
                </div>
                <button class="modal-close" onclick="hideMungerQuotes()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 32px;">
                <div id="mungerQuoteContainer" style="position: relative; min-height: 200px;">
                    <div id="mungerQuote" style="font-size: 18px; line-height: 1.8; color: var(--text-primary); margin-bottom: 24px; font-style: italic; text-align: center; padding: 24px; background: rgba(43, 111, 237, 0.05); border-radius: var(--radius-lg); border-left: 4px solid var(--primary-blue); transition: opacity 0.3s ease-in-out;">
                        "加载中..."
                    </div>
                    <div id="mungerQuoteAuthor" style="text-align: right; color: var(--text-secondary); font-size: 14px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(43, 111, 237, 0.2);">
                        <span style="font-weight: 600;">— 查理·芒格 (Charlie Munger)</span>
                    </div>
                    <div id="mungerQuoteStrategy" style="margin-top: 24px; padding: 16px; background: rgba(43, 111, 237, 0.05); border-radius: var(--radius-md); border-left: 3px solid var(--primary-blue);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            <i class="bi bi-lightbulb" style="color: var(--warning-yellow);"></i>
                            策略启示：
                        </div>
                        <div id="mungerQuoteStrategyText" style="font-size: 14px; color: var(--text-primary); line-height: 1.8;"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-default);">
                    <button class="btn btn-ghost" onclick="previousMungerQuote()" title="上一条">
                        <i class="bi bi-chevron-left"></i> 上一条
                    </button>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <span id="mungerQuoteIndex" style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">1 / 7</span>
                        <button class="btn btn-ghost btn-sm" onclick="refreshMungerQuote()" title="随机刷新">
                            <i class="bi bi-shuffle"></i>
                        </button>
                    </div>
                    <button class="btn btn-ghost" onclick="nextMungerQuote()" title="下一条">
                        下一条 <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-default);">
                <button class="btn btn-primary" onclick="hideMungerQuotes()">
                    关闭
                </button>
            </div>
        </div>
    </div>
</body>
</html>
