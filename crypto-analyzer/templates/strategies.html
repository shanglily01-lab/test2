<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•èµ„ç­–ç•¥ç®¡ç† - Crypto Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 28px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .sidebar h2 {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .strategy-list {
            list-style: none;
        }

        .strategy-item {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e2e8f0;
        }

        .strategy-item:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .strategy-item.active {
            border-color: #667eea;
            background: #edf2f7;
        }

        .strategy-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .strategy-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .strategy-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-active {
            background: #48bb78;
            color: white;
        }

        .badge-conservative {
            background: #4299e1;
            color: white;
        }

        .badge-balanced {
            background: #ed8936;
            color: white;
        }

        .badge-aggressive {
            background: #f56565;
            color: white;
        }

        .strategy-desc {
            font-size: 13px;
            color: #718096;
            margin-top: 4px;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            gap: 8px;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .weight-slider {
            margin-bottom: 16px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-value {
            font-weight: 600;
            color: #667eea;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        .weight-total {
            text-align: right;
            font-size: 14px;
            color: #718096;
            margin-top: 8px;
            padding: 8px;
            background: #f7fafc;
            border-radius: 6px;
        }

        .weight-total.valid {
            color: #48bb78;
        }

        .weight-total.invalid {
            color: #f56565;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .comparison-table th {
            font-weight: 600;
            color: #2d3748;
            background: #f7fafc;
        }

        .comparison-table td {
            color: #4a5568;
        }

        .test-panel {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .test-result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-score {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 12px 0;
        }

        .result-recommendation {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 8px;
        }

        .rec-strong-buy {
            background: #48bb78;
            color: white;
        }

        .rec-buy {
            background: #68d391;
            color: white;
        }

        .rec-hold {
            background: #ed8936;
            color: white;
        }

        .rec-sell {
            background: #fc8181;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 968px) {
            .content {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æŠ•èµ„ç­–ç•¥ç®¡ç†</h1>
            <p>æ ¹æ®ä½ çš„é£é™©åå¥½å’Œäº¤æ˜“é£æ ¼ï¼Œè‡ªå®šä¹‰åˆ†æç³»ç»Ÿçš„è¡Œä¸º</p>
            <div class="controls">
                <button class="btn btn-primary" onclick="showCreateModal()">
                    â• åˆ›å»ºæ–°ç­–ç•¥
                </button>
                <button class="btn btn-secondary" onclick="copyStrategy()">
                    ğŸ“‹ å¤åˆ¶ç­–ç•¥
                </button>
                <button class="btn btn-secondary" onclick="compareStrategies()">
                    ğŸ“Š å¯¹æ¯”ç­–ç•¥
                </button>
                <button class="btn" onclick="refreshData()" style="background: #4a5568; color: white;">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
        </div>

        <div class="content">
            <div class="sidebar">
                <h2>æˆ‘çš„ç­–ç•¥</h2>
                <ul class="strategy-list" id="strategyList">
                    <!-- åŠ¨æ€åŠ è½½ -->
                </ul>
            </div>

            <div class="main-content">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('edit')">ğŸ“ ç¼–è¾‘ç­–ç•¥</button>
                    <button class="tab" onclick="switchTab('test')">ğŸ§ª æµ‹è¯•ç­–ç•¥</button>
                    <button class="tab" onclick="switchTab('info')">â„¹ï¸ ç­–ç•¥ä¿¡æ¯</button>
                </div>

                <div id="editTab" class="tab-content active">
                    <div id="editContent">
                        <p style="color: #718096; text-align: center; padding: 40px;">
                            è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç­–ç•¥è¿›è¡Œç¼–è¾‘
                        </p>
                    </div>
                </div>

                <div id="testTab" class="tab-content">
                    <h3 style="margin-bottom: 16px;">ç­–ç•¥æµ‹è¯•</h3>
                    <p style="color: #718096; margin-bottom: 20px;">
                        è¾“å…¥æ¨¡æ‹Ÿçš„å„ç»´åº¦å¾—åˆ†ï¼ŒæŸ¥çœ‹ç­–ç•¥ä¼šç»™å‡ºä»€ä¹ˆå»ºè®®
                    </p>

                    <div class="test-panel">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æŠ€æœ¯æŒ‡æ ‡å¾—åˆ† (0-100)</label>
                                <input type="number" class="form-input" id="testTechnical"
                                       value="75" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hyperliquidå¾—åˆ† (0-100)</label>
                                <input type="number" class="form-input" id="testHyperliquid"
                                       value="85" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æ–°é—»æƒ…ç»ªå¾—åˆ† (0-100)</label>
                                <input type="number" class="form-input" id="testNews"
                                       value="60" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">èµ„é‡‘è´¹ç‡å¾—åˆ† (0-100)</label>
                                <input type="number" class="form-input" id="testFundingRate"
                                       value="70" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ä»¥å¤ªåŠé“¾ä¸Šå¾—åˆ† (0-100)</label>
                                <input type="number" class="form-input" id="testEthereum"
                                       value="65" min="0" max="100">
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="testStrategy()" style="width: 100%; margin-top: 16px;">
                            ğŸ§ª è¿è¡Œæµ‹è¯•
                        </button>

                        <div id="testResult"></div>
                    </div>
                </div>

                <div id="infoTab" class="tab-content">
                    <div id="infoContent">
                        <p style="color: #718096; text-align: center; padding: 40px;">
                            è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç­–ç•¥æŸ¥çœ‹è¯¦æƒ…
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç­–ç•¥æ¨¡æ€æ¡† -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">åˆ›å»ºæ–°ç­–ç•¥</div>
            <div class="form-group">
                <label class="form-label">ç­–ç•¥åç§°*</label>
                <input type="text" class="form-input" id="newStrategyName" placeholder="my_strategy">
            </div>
            <div class="form-group">
                <label class="form-label">ç­–ç•¥æè¿°</label>
                <input type="text" class="form-input" id="newStrategyDesc" placeholder="æˆ‘çš„è‡ªå®šä¹‰ç­–ç•¥">
            </div>
            <div class="form-group">
                <label class="form-label">åŸºäºæ¨¡æ¿</label>
                <select class="form-input" id="newStrategyTemplate">
                    <option value="">ä»å¤´åˆ›å»º</option>
                    <option value="balanced" selected>å¹³è¡¡ç­–ç•¥ (æ¨è)</option>
                    <option value="conservative">ä¿å®ˆç­–ç•¥</option>
                    <option value="aggressive">æ¿€è¿›ç­–ç•¥</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="hideCreateModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createStrategy()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        let currentStrategy = null;
        let allStrategies = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            loadStrategies();
        };

        // åŠ è½½ç­–ç•¥åˆ—è¡¨
        async function loadStrategies() {
            try {
                const response = await fetch('/api/strategies/list');
                const data = await response.json();

                if (data.success) {
                    allStrategies = data.strategies;
                    renderStrategyList(data.strategies);
                }
            } catch (error) {
                console.error('åŠ è½½ç­–ç•¥å¤±è´¥:', error);
                showAlert('åŠ è½½ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“ç­–ç•¥åˆ—è¡¨
        function renderStrategyList(strategies) {
            const list = document.getElementById('strategyList');
            list.innerHTML = '';

            strategies.forEach(strategy => {
                const item = document.createElement('li');
                item.className = 'strategy-item';
                if (strategy.is_active) {
                    item.classList.add('active');
                }

                let badgeClass = 'badge-balanced';
                if (strategy.risk_level === 'conservative') badgeClass = 'badge-conservative';
                if (strategy.risk_level === 'aggressive') badgeClass = 'badge-aggressive';

                item.innerHTML = `
                    <div class="strategy-name">
                        ${strategy.name}
                        ${strategy.is_active ? '<span class="strategy-badge badge-active">âœ“ æ¿€æ´»</span>' : ''}
                        <span class="strategy-badge ${badgeClass}">${strategy.risk_level}</span>
                    </div>
                    <div class="strategy-desc">${strategy.description || 'æ— æè¿°'}</div>
                `;

                item.onclick = () => selectStrategy(strategy.name);
                list.appendChild(item);
            });
        }

        // é€‰æ‹©ç­–ç•¥
        async function selectStrategy(name) {
            try {
                const response = await fetch(`/api/strategies/detail/${name}`);
                const data = await response.json();

                if (data.success) {
                    currentStrategy = data.strategy;
                    renderStrategyEditor(data.strategy);
                    renderStrategyInfo(data.strategy);

                    // æ›´æ–°UI
                    document.querySelectorAll('.strategy-item').forEach(item => {
                        item.classList.remove('selected');
                        if (item.textContent.includes(name)) {
                            item.classList.add('selected');
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç­–ç•¥è¯¦æƒ…å¤±è´¥:', error);
                showAlert('åŠ è½½ç­–ç•¥è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“ç­–ç•¥ç¼–è¾‘å™¨
        function renderStrategyEditor(strategy) {
            const isDefault = ['conservative', 'balanced', 'aggressive'].includes(strategy.name);
            const content = document.getElementById('editContent');

            let html = '';

            if (isDefault) {
                html += '<div class="alert alert-info">âš ï¸ é»˜è®¤ç­–ç•¥ä¸å¯ç¼–è¾‘ï¼Œè¯·å…ˆå¤åˆ¶åä¿®æ”¹</div>';
            }

            html += `
                <div class="form-group">
                    <label class="form-label">ç­–ç•¥æè¿°</label>
                    <input type="text" class="form-input" id="editDesc"
                           value="${strategy.description}" ${isDefault ? 'disabled' : ''}>
                </div>

                <h3 style="margin: 32px 0 16px 0;">ç»´åº¦æƒé‡é…ç½®</h3>
                <p style="color: #718096; margin-bottom: 20px; font-size: 14px;">
                    è°ƒæ•´å„æ•°æ®æºåœ¨æœ€ç»ˆå†³ç­–ä¸­çš„é‡è¦æ€§ï¼ˆæ€»å’Œåº”ä¸º100%ï¼‰
                </p>

                <div class="weight-slider">
                    <div class="slider-header">
                        <label class="form-label">æŠ€æœ¯æŒ‡æ ‡</label>
                        <span class="slider-value" id="techValue">${strategy.dimension_weights.technical}%</span>
                    </div>
                    <input type="range" id="techSlider" min="0" max="100"
                           value="${strategy.dimension_weights.technical}"
                           oninput="updateWeight('tech')" ${isDefault ? 'disabled' : ''}>
                </div>

                <div class="weight-slider">
                    <div class="slider-header">
                        <label class="form-label">Hyperliquidèªæ˜é’±</label>
                        <span class="slider-value" id="hyperValue">${strategy.dimension_weights.hyperliquid}%</span>
                    </div>
                    <input type="range" id="hyperSlider" min="0" max="100"
                           value="${strategy.dimension_weights.hyperliquid}"
                           oninput="updateWeight('hyper')" ${isDefault ? 'disabled' : ''}>
                </div>

                <div class="weight-slider">
                    <div class="slider-header">
                        <label class="form-label">æ–°é—»æƒ…ç»ª</label>
                        <span class="slider-value" id="newsValue">${strategy.dimension_weights.news}%</span>
                    </div>
                    <input type="range" id="newsSlider" min="0" max="100"
                           value="${strategy.dimension_weights.news}"
                           oninput="updateWeight('news')" ${isDefault ? 'disabled' : ''}>
                </div>

                <div class="weight-slider">
                    <div class="slider-header">
                        <label class="form-label">èµ„é‡‘è´¹ç‡</label>
                        <span class="slider-value" id="fundingValue">${strategy.dimension_weights.funding_rate}%</span>
                    </div>
                    <input type="range" id="fundingSlider" min="0" max="100"
                           value="${strategy.dimension_weights.funding_rate}"
                           oninput="updateWeight('funding')" ${isDefault ? 'disabled' : ''}>
                </div>

                <div class="weight-slider">
                    <div class="slider-header">
                        <label class="form-label">ä»¥å¤ªåŠé“¾ä¸Šæ•°æ®</label>
                        <span class="slider-value" id="ethValue">${strategy.dimension_weights.ethereum}%</span>
                    </div>
                    <input type="range" id="ethSlider" min="0" max="100"
                           value="${strategy.dimension_weights.ethereum}"
                           oninput="updateWeight('eth')" ${isDefault ? 'disabled' : ''}>
                </div>

                <div class="weight-total" id="weightTotal">
                    æƒé‡æ€»å’Œ: <strong>100%</strong>
                </div>

                <h3 style="margin: 32px 0 16px 0;">é£é™©æ§åˆ¶</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">é£é™©ç­‰çº§</label>
                        <select class="form-input" id="editRiskLevel" ${isDefault ? 'disabled' : ''}>
                            <option value="conservative" ${strategy.risk_profile.level === 'conservative' ? 'selected' : ''}>ä¿å®ˆ</option>
                            <option value="balanced" ${strategy.risk_profile.level === 'balanced' ? 'selected' : ''}>å¹³è¡¡</option>
                            <option value="aggressive" ${strategy.risk_profile.level === 'aggressive' ? 'selected' : ''}>æ¿€è¿›</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æœ€å¤§ä»“ä½ (%)</label>
                        <input type="number" class="form-input" id="editPosition"
                               value="${strategy.risk_profile.max_position_size}"
                               min="1" max="100" ${isDefault ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ­¢æŸ (%)</label>
                        <input type="number" class="form-input" id="editStopLoss"
                               value="${strategy.risk_profile.stop_loss}"
                               min="0" max="50" ${isDefault ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ­¢ç›ˆ (%)</label>
                        <input type="number" class="form-input" id="editTakeProfit"
                               value="${strategy.risk_profile.take_profit}"
                               min="0" max="100" ${isDefault ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æœ€å°ä¿¡å·å¼ºåº¦</label>
                        <input type="number" class="form-input" id="editMinSignal"
                               value="${strategy.risk_profile.min_signal_strength}"
                               min="0" max="100" ${isDefault ? 'disabled' : ''}>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æœ€å¤§æ æ†</label>
                        <input type="number" class="form-input" id="editMaxLeverage"
                               value="${strategy.risk_profile.max_leverage}"
                               min="1" max="10" ${isDefault ? 'disabled' : ''}>
                    </div>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="editAllowShort"
                               ${strategy.risk_profile.allow_short ? 'checked' : ''}
                               ${isDefault ? 'disabled' : ''}>
                        <label>å…è®¸åšç©º</label>
                    </div>
                </div>

                ${!isDefault ? `
                    <div style="display: flex; gap: 12px; margin-top: 32px;">
                        <button class="btn btn-primary" onclick="saveStrategy()">ğŸ’¾ ä¿å­˜ç­–ç•¥</button>
                        <button class="btn btn-secondary" onclick="activateCurrentStrategy()">âœ“ æ¿€æ´»æ­¤ç­–ç•¥</button>
                        <button class="btn btn-danger" onclick="deleteCurrentStrategy()">ğŸ—‘ï¸ åˆ é™¤ç­–ç•¥</button>
                    </div>
                ` : `
                    <div style="margin-top: 32px;">
                        <button class="btn btn-secondary" onclick="copyStrategy()">ğŸ“‹ å¤åˆ¶æ­¤ç­–ç•¥</button>
                    </div>
                `}
            `;

            content.innerHTML = html;
        }

        // æ›´æ–°æƒé‡æ˜¾ç¤º
        function updateWeight(type) {
            const sliders = {
                tech: document.getElementById('techSlider'),
                hyper: document.getElementById('hyperSlider'),
                news: document.getElementById('newsSlider'),
                funding: document.getElementById('fundingSlider'),
                eth: document.getElementById('ethSlider')
            };

            const values = {
                tech: document.getElementById('techValue'),
                hyper: document.getElementById('hyperValue'),
                news: document.getElementById('newsValue'),
                funding: document.getElementById('fundingValue'),
                eth: document.getElementById('ethValue')
            };

            // æ›´æ–°å½“å‰å€¼æ˜¾ç¤º
            values[type].textContent = sliders[type].value + '%';

            // è®¡ç®—æ€»å’Œ
            let total = 0;
            Object.keys(sliders).forEach(key => {
                total += parseFloat(sliders[key].value);
            });

            const totalEl = document.getElementById('weightTotal');
            totalEl.innerHTML = `æƒé‡æ€»å’Œ: <strong>${total.toFixed(1)}%</strong>`;

            if (Math.abs(total - 100) < 0.1) {
                totalEl.className = 'weight-total valid';
            } else {
                totalEl.className = 'weight-total invalid';
            }
        }

        // æ¸²æŸ“ç­–ç•¥ä¿¡æ¯
        function renderStrategyInfo(strategy) {
            const content = document.getElementById('infoContent');
            const createdAt = new Date(strategy.created_at).toLocaleString('zh-CN');
            const updatedAt = new Date(strategy.updated_at).toLocaleString('zh-CN');

            content.innerHTML = `
                <h3>åŸºæœ¬ä¿¡æ¯</h3>
                <table class="comparison-table">
                    <tr>
                        <th>ç­–ç•¥åç§°</th>
                        <td>${strategy.name}</td>
                    </tr>
                    <tr>
                        <th>æè¿°</th>
                        <td>${strategy.description || 'æ— '}</td>
                    </tr>
                    <tr>
                        <th>é£é™©ç­‰çº§</th>
                        <td>${strategy.risk_profile.level}</td>
                    </tr>
                    <tr>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <td>${createdAt}</td>
                    </tr>
                    <tr>
                        <th>æ›´æ–°æ—¶é—´</th>
                        <td>${updatedAt}</td>
                    </tr>
                </table>

                <h3 style="margin-top: 32px;">ç»´åº¦æƒé‡</h3>
                <table class="comparison-table">
                    <tr>
                        <th>ç»´åº¦</th>
                        <th>æƒé‡</th>
                    </tr>
                    <tr>
                        <td>æŠ€æœ¯æŒ‡æ ‡</td>
                        <td>${strategy.dimension_weights.technical}%</td>
                    </tr>
                    <tr>
                        <td>Hyperliquidèªæ˜é’±</td>
                        <td>${strategy.dimension_weights.hyperliquid}%</td>
                    </tr>
                    <tr>
                        <td>æ–°é—»æƒ…ç»ª</td>
                        <td>${strategy.dimension_weights.news}%</td>
                    </tr>
                    <tr>
                        <td>èµ„é‡‘è´¹ç‡</td>
                        <td>${strategy.dimension_weights.funding_rate}%</td>
                    </tr>
                    <tr>
                        <td>ä»¥å¤ªåŠé“¾ä¸Šæ•°æ®</td>
                        <td>${strategy.dimension_weights.ethereum}%</td>
                    </tr>
                </table>

                <h3 style="margin-top: 32px;">é£é™©æ§åˆ¶</h3>
                <table class="comparison-table">
                    <tr>
                        <th>å‚æ•°</th>
                        <th>å€¼</th>
                    </tr>
                    <tr>
                        <td>æœ€å¤§ä»“ä½</td>
                        <td>${strategy.risk_profile.max_position_size}%</td>
                    </tr>
                    <tr>
                        <td>æ­¢æŸ</td>
                        <td>${strategy.risk_profile.stop_loss}%</td>
                    </tr>
                    <tr>
                        <td>æ­¢ç›ˆ</td>
                        <td>${strategy.risk_profile.take_profit}%</td>
                    </tr>
                    <tr>
                        <td>æœ€å°ä¿¡å·å¼ºåº¦</td>
                        <td>${strategy.risk_profile.min_signal_strength}</td>
                    </tr>
                    <tr>
                        <td>æœ€å¤§æ æ†</td>
                        <td>${strategy.risk_profile.max_leverage}x</td>
                    </tr>
                    <tr>
                        <td>å…è®¸åšç©º</td>
                        <td>${strategy.risk_profile.allow_short ? 'æ˜¯' : 'å¦'}</td>
                    </tr>
                </table>
            `;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`button[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // ä¿å­˜ç­–ç•¥
        async function saveStrategy() {
            if (!currentStrategy) return;

            const data = {
                description: document.getElementById('editDesc').value,
                dimension_weights: {
                    technical: parseFloat(document.getElementById('techSlider').value),
                    hyperliquid: parseFloat(document.getElementById('hyperSlider').value),
                    news: parseFloat(document.getElementById('newsSlider').value),
                    funding_rate: parseFloat(document.getElementById('fundingSlider').value),
                    ethereum: parseFloat(document.getElementById('ethSlider').value)
                },
                risk_profile: {
                    level: document.getElementById('editRiskLevel').value,
                    max_position_size: parseFloat(document.getElementById('editPosition').value),
                    stop_loss: parseFloat(document.getElementById('editStopLoss').value),
                    take_profit: parseFloat(document.getElementById('editTakeProfit').value),
                    min_signal_strength: parseFloat(document.getElementById('editMinSignal').value),
                    max_leverage: parseFloat(document.getElementById('editMaxLeverage').value),
                    allow_short: document.getElementById('editAllowShort').checked
                }
            };

            try {
                const response = await fetch(`/api/strategies/update/${currentStrategy.name}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('ç­–ç•¥ä¿å­˜æˆåŠŸ!', 'success');
                    await loadStrategies();
                    await selectStrategy(currentStrategy.name);
                } else {
                    showAlert('ä¿å­˜å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜ç­–ç•¥å¤±è´¥:', error);
                showAlert('ä¿å­˜ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // æ¿€æ´»å½“å‰ç­–ç•¥
        async function activateCurrentStrategy() {
            if (!currentStrategy) return;

            try {
                const response = await fetch(`/api/strategies/activate/${currentStrategy.name}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('ç­–ç•¥å·²æ¿€æ´»!', 'success');
                    await loadStrategies();
                } else {
                    showAlert('æ¿€æ´»å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ¿€æ´»ç­–ç•¥å¤±è´¥:', error);
                showAlert('æ¿€æ´»ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤å½“å‰ç­–ç•¥
        async function deleteCurrentStrategy() {
            if (!currentStrategy) return;

            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç­–ç•¥ "${currentStrategy.name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/strategies/delete/${currentStrategy.name}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('ç­–ç•¥å·²åˆ é™¤', 'success');
                    currentStrategy = null;
                    await loadStrategies();
                    document.getElementById('editContent').innerHTML =
                        '<p style="color: #718096; text-align: center; padding: 40px;">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªç­–ç•¥è¿›è¡Œç¼–è¾‘</p>';
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ç­–ç•¥å¤±è´¥:', error);
                showAlert('åˆ é™¤ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // æµ‹è¯•ç­–ç•¥
        async function testStrategy() {
            if (!currentStrategy) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­–ç•¥', 'error');
                return;
            }

            const scores = {
                technical: parseFloat(document.getElementById('testTechnical').value),
                hyperliquid: parseFloat(document.getElementById('testHyperliquid').value),
                news: parseFloat(document.getElementById('testNews').value),
                funding_rate: parseFloat(document.getElementById('testFundingRate').value),
                ethereum: parseFloat(document.getElementById('testEthereum').value)
            };

            try {
                const response = await fetch(`/api/strategies/test/${currentStrategy.name}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(scores)
                });

                const result = await response.json();

                if (result.success) {
                    renderTestResult(result.result);
                } else {
                    showAlert('æµ‹è¯•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æµ‹è¯•ç­–ç•¥å¤±è´¥:', error);
                showAlert('æµ‹è¯•ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“æµ‹è¯•ç»“æœ
        function renderTestResult(result) {
            const rec = result.recommendation;
            let recClass = 'rec-hold';
            if (rec.action.includes('å¼ºçƒˆä¹°å…¥')) recClass = 'rec-strong-buy';
            else if (rec.action.includes('ä¹°å…¥')) recClass = 'rec-buy';
            else if (rec.action.includes('å–å‡º')) recClass = 'rec-sell';

            const html = `
                <div class="test-result">
                    <h3>æµ‹è¯•ç»“æœ</h3>
                    <div class="result-score">${result.total_score} / 100</div>
                    <p><strong>ä¿¡å·å¼ºåº¦:</strong> ${result.signal_strength}</p>
                    <p><strong>æ“ä½œå»ºè®®:</strong>
                        <span class="result-recommendation ${recClass}">${rec.action}</span>
                    </p>
                    <p><strong>å»ºè®®ä»“ä½:</strong> ${rec.position_size_pct}%</p>
                    <p><strong>æ­¢æŸ/æ­¢ç›ˆ:</strong> ${rec.stop_loss_pct}% / ${rec.take_profit_pct}%</p>
                    <p><strong>é£é™©æ”¶ç›Šæ¯”:</strong> ${result.risk_reward_ratio}</p>
                    <p><strong>å…¥åœºç­–ç•¥:</strong> ${rec.entry_strategy}</p>

                    <h4 style="margin-top: 20px;">å†³ç­–åŸå› :</h4>
                    <ul style="margin-left: 20px;">
                        ${result.reasons.map(r => `<li>${r}</li>`).join('')}
                    </ul>
                </div>
            `;

            document.getElementById('testResult').innerHTML = html;
        }

        // åˆ›å»ºç­–ç•¥ç›¸å…³
        function showCreateModal() {
            document.getElementById('createModal').classList.add('active');
        }

        function hideCreateModal() {
            document.getElementById('createModal').classList.remove('active');
        }

        async function createStrategy() {
            const name = document.getElementById('newStrategyName').value.trim();
            const description = document.getElementById('newStrategyDesc').value.trim();
            const template = document.getElementById('newStrategyTemplate').value;

            if (!name) {
                showAlert('è¯·è¾“å…¥ç­–ç•¥åç§°', 'error');
                return;
            }

            try {
                if (template) {
                    // ä»æ¨¡æ¿å¤åˆ¶
                    const response = await fetch('/api/strategies/copy', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            source: template,
                            dest: name,
                            description: description || `åŸºäº ${template} çš„ç­–ç•¥`
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        showAlert('ç­–ç•¥åˆ›å»ºæˆåŠŸ!', 'success');
                        hideCreateModal();
                        await loadStrategies();
                        await selectStrategy(name);
                    } else {
                        showAlert('åˆ›å»ºå¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                } else {
                    // TODO: ä»å¤´åˆ›å»º
                    showAlert('ä»å¤´åˆ›å»ºåŠŸèƒ½å¼€å‘ä¸­', 'info');
                }
            } catch (error) {
                console.error('åˆ›å»ºç­–ç•¥å¤±è´¥:', error);
                showAlert('åˆ›å»ºç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // å¤åˆ¶ç­–ç•¥
        async function copyStrategy() {
            if (!currentStrategy) {
                showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­–ç•¥', 'error');
                return;
            }

            const newName = prompt('è¾“å…¥æ–°ç­–ç•¥åç§°:', currentStrategy.name + '_copy');
            if (!newName) return;

            try {
                const response = await fetch('/api/strategies/copy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        source: currentStrategy.name,
                        dest: newName,
                        description: `ä» ${currentStrategy.name} å¤åˆ¶`
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('ç­–ç•¥å¤åˆ¶æˆåŠŸ!', 'success');
                    await loadStrategies();
                    await selectStrategy(newName);
                } else {
                    showAlert('å¤åˆ¶å¤±è´¥: ' + (result.detail || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('å¤åˆ¶ç­–ç•¥å¤±è´¥:', error);
                showAlert('å¤åˆ¶ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // å¯¹æ¯”ç­–ç•¥
        async function compareStrategies() {
            const selected = ['conservative', 'balanced', 'aggressive'];
            if (currentStrategy && !selected.includes(currentStrategy.name)) {
                selected.push(currentStrategy.name);
            }

            try {
                const response = await fetch('/api/strategies/compare', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(selected)
                });

                const result = await response.json();

                if (result.success) {
                    renderComparison(result.comparison);
                } else {
                    showAlert('å¯¹æ¯”å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('å¯¹æ¯”ç­–ç•¥å¤±è´¥:', error);
                showAlert('å¯¹æ¯”ç­–ç•¥å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“å¯¹æ¯”ç»“æœ
        function renderComparison(comparison) {
            const names = Object.keys(comparison);

            let html = '<h3>ç­–ç•¥å¯¹æ¯”</h3>';
            html += '<table class="comparison-table"><tr><th>é¡¹ç›®</th>';
            names.forEach(name => {
                html += `<th>${name}</th>`;
            });
            html += '</tr>';

            // ç»´åº¦æƒé‡
            const dimensions = ['technical', 'hyperliquid', 'news', 'funding_rate', 'ethereum'];
            const dimNames = ['æŠ€æœ¯æŒ‡æ ‡', 'Hyperliquid', 'æ–°é—»æƒ…ç»ª', 'èµ„é‡‘è´¹ç‡', 'ä»¥å¤ªåŠé“¾ä¸Š'];

            dimensions.forEach((dim, i) => {
                html += `<tr><td>${dimNames[i]}</td>`;
                names.forEach(name => {
                    html += `<td>${comparison[name].dimension_weights[dim]}%</td>`;
                });
                html += '</tr>';
            });

            // é£é™©æ§åˆ¶
            html += '<tr style="background: #f7fafc;"><td colspan="' + (names.length + 1) + '"><strong>é£é™©æ§åˆ¶</strong></td></tr>';

            const risks = {
                'max_position_size': 'æœ€å¤§ä»“ä½',
                'stop_loss': 'æ­¢æŸ',
                'take_profit': 'æ­¢ç›ˆ',
                'max_leverage': 'æœ€å¤§æ æ†',
                'min_signal_strength': 'æœ€å°ä¿¡å·å¼ºåº¦'
            };

            Object.keys(risks).forEach(key => {
                html += `<tr><td>${risks[key]}</td>`;
                names.forEach(name => {
                    let value = comparison[name].risk_profile[key];
                    if (key === 'max_leverage') value += 'x';
                    else if (key !== 'min_signal_strength') value += '%';
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });

            html += '</table>';

            // æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
            const modal = document.getElementById('createModal');
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
                <div class="modal-header">ç­–ç•¥å¯¹æ¯”</div>
                ${html}
                <div class="modal-footer">
                    <button class="btn" onclick="hideCreateModal()">å…³é—­</button>
                </div>
            `;
            modal.classList.add('active');
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadStrategies();
            if (currentStrategy) {
                selectStrategy(currentStrategy.name);
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' :
                             type === 'error' ? 'alert-error' : 'alert-info';

            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '2000';
            alert.style.minWidth = '300px';

            document.body.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s';
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        }
    </script>
</body>
</html>
