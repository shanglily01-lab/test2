<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技术信号 - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: 0; }
        .filters { display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); flex-wrap: wrap; }
        .select-input { padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--radius-md); border: 1px solid var(--border-default); background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px; }
        .tabs { display: flex; gap: var(--spacing-sm); border-bottom: 2px solid var(--border-default); margin-bottom: var(--spacing-lg); }
        .tab { padding: var(--spacing-md) var(--spacing-xl); background: transparent; color: var(--text-secondary); border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 14px; font-weight: 600; transition: all var(--transition-base); position: relative; top: 2px; }
        .tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border-default); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        thead { background: var(--bg-tertiary); border-bottom: 2px solid var(--border-default); }
        th { padding: var(--spacing-md) var(--spacing-lg); text-align: left; font-weight: 600; color: #E6EDF3; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: var(--spacing-lg); border-bottom: 1px solid var(--border-default); color: #E6EDF3; font-size: 13px; }
        tbody tr:hover { background: var(--bg-hover); }
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
        .badge-success { background: var(--success-green-bg); color: var(--success-green); }
        .badge-danger { background: var(--danger-red-bg); color: var(--danger-red); }
        .badge-info { background: var(--primary-blue-light); color: var(--primary-blue); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .badge-warning { background: var(--warning-yellow-bg); color: var(--warning-yellow); }
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg); }
        .indicator-card { background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg); }
        .indicator-name { font-size: 14px; color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
        .indicator-value { font-size: 24px; font-weight: 700; color: var(--text-primary); font-family: var(--font-mono); }
        .loading { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 500; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-primary:hover { background: var(--primary-blue-hover); }
        .btn-detail {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            padding: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        .btn-detail:hover {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
            color: white;
        }
        .signal-strong-buy { color: var(--success-green); }
        .signal-buy { color: #4ADE80; }
        .signal-hold { color: var(--text-secondary); }
        .signal-sell { color: #FB7185; }
        .signal-strong-sell { color: var(--danger-red); }
        
        /* 趋势样式 */
        .trend-strong-up { background: #065F46; color: #10B981; }
        .trend-up { background: #047857; color: #34D399; }
        .trend-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .trend-down { background: #7F1D1D; color: #FB7185; }
        .trend-strong-down { background: #991B1B; color: var(--danger-red); }
        
        /* 实时价格样式 - 优化显示，无边框 */
        .realtime-price {
            margin-top: 6px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .realtime-price strong {
            font-family: var(--font-mono);
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
        }
        .realtime-price small {
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .realtime-price.price-updated {
            animation: priceFlash 0.6s ease;
        }
        @keyframes priceFlash {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* 模态框样式 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 9999;
            animation: fadeIn var(--transition-base) ease-in;
            padding: var(--spacing-xl);
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-container {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp var(--transition-slow) ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .modal-body {
            padding: var(--spacing-xl);
        }
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }
        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .analysis-section {
            margin-bottom: var(--spacing-xl);
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-default);
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .score-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }
        .score-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        .score-value {
            font-size: 28px;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-primary);
        }
        .price-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .price-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }
        .price-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        .price-value {
            font-size: 18px;
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--text-primary);
        }
        .reasons-list, .risks-list {
            list-style: none;
            padding: 0;
        }
        .reasons-list li, .risks-list li {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-left: 3px solid var(--primary-blue);
            border-radius: var(--radius-sm);
        }
        .risks-list li {
            border-left-color: var(--warning-yellow);
        }
        .indicator-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }
        .indicator-detail-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }
        .indicator-detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        .indicator-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }
        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
            flex-wrap: wrap;
        }
        /* 已移除：旧的带蓝色边框的realtime-price样式（用于模态框中的价格显示，已不再使用） */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="header-title">
                <i class="bi bi-graph-up-arrow"></i>
                技术信号分析
            </h1>
            <p class="header-subtitle">实时监控技术指标，捕捉交易信号</p>
        </div>

        <div class="nav-container">
            <nav class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/technical-signals" class="nav-link active">
                    <i class="bi bi-graph-up-arrow"></i> 技术信号
                </a>
                <a href="/paper_trading" class="nav-link">
                    <i class="bi bi-journals"></i> 模拟现货
                </a>
                <a href="/futures_trading" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> 模拟合约
                </a>
                <a href="/strategies" class="nav-link">
                    <i class="bi bi-diagram-3"></i> 策略管理
                </a>
                <a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF 数据
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> 企业金库
                </a>
                <a href="/blockchain_gas" class="nav-link">
                    <i class="bi bi-lightning-charge"></i> Gas统计
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> 数据管理
                </a>
            </nav>
        </div>

        <!-- 技术指标概览 -->
        <div class="card" id="indicatorsCard" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-bar-chart"></i>
                    <span id="selectedSymbol">技术指标详情</span>
                </h2>
            </div>
            <div class="card-body">
                <div class="indicator-grid" id="indicatorsGrid"></div>
            </div>
        </div>

        <!-- 交易信号列表和超卖超买信号 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-bell"></i>
                    交易信号
                </h2>
            </div>
            <div class="card-body">
                <!-- 标签页 -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('trend')" id="tabTrend">
                        <i class="bi bi-graph-up-arrow"></i> 趋势判断
                    </button>
                    <button class="tab" onclick="switchTab('technical')" id="tabTechnical">
                        <i class="bi bi-bar-chart"></i> 技术信号
                    </button>
                    <button class="tab" onclick="switchTab('futures')" id="tabFutures">
                        <i class="bi bi-currency-exchange"></i> 合约信号
                    </button>
                </div>
                
                <!-- 趋势判断标签页内容 -->
                <div id="tabContentTrend" class="tab-content active">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>交易对</th>
                                    <th>5分钟</th>
                                    <th>15分钟</th>
                                    <th>1小时</th>
                                    <th>1天</th>
                                    <th>综合评估</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="trendAnalysisTableBody">
                                <tr>
                                    <td colspan="7" class="loading">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 技术信号标签页内容 -->
                <div id="tabContentTechnical" class="tab-content">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>交易对</th>
                                    <th>价格</th>
                                    <th>15分钟</th>
                                    <th>1小时</th>
                                    <th>1天</th>
                                    <th>综合评分</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="technicalSignalsTableBody">
                                <tr>
                                    <td colspan="7" class="loading">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 合约信号标签页内容 -->
                <div id="tabContentFutures" class="tab-content">
                    <div class="filters" style="margin-bottom: var(--spacing-lg);">
                        <button class="btn btn-primary" onclick="loadFuturesSignals()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
            </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>交易对</th>
                                <th>价格</th>
                                <th>信号</th>
                                <th>信号评分</th>
                                <th>资金费率</th>
                                <th>多空比</th>
                                <th>持仓量变化</th>
                                <th>5分钟技术指标</th>
                                <th>15分钟技术指标</th>
                                <th>1小时技术指标</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="futuresSignalsTableBody">
                            <tr>
                                <td colspan="11" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细分析模态框 -->
    <div id="detailedAnalysisModal" class="modal-overlay" onclick="if(event.target === this) closeDetailedAnalysis()">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span id="modalSymbolTitle">详细分析</span>
                </h2>
                <button class="modal-close" onclick="closeDetailedAnalysis()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="detailedAnalysisContent">
                <div class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = '';
        let currentTimeframe = '1h';
        
        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的active状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            if (tabName === 'trend') {
                document.getElementById('tabContentTrend').classList.add('active');
                document.getElementById('tabTrend').classList.add('active');
                // 切换到趋势判断时自动加载数据
                loadTrendAnalysis();
            } else if (tabName === 'technical') {
                document.getElementById('tabContentTechnical').classList.add('active');
                document.getElementById('tabTechnical').classList.add('active');
                // 切换到技术信号时自动加载数据
                loadTechnicalSignals();
            } else if (tabName === 'futures') {
                document.getElementById('tabContentFutures').classList.add('active');
                document.getElementById('tabFutures').classList.add('active');
                // 切换到合约信号时自动加载数据
                loadFuturesSignals();
            }
        }

        // 格式化数字
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            return Number(num).toFixed(decimals);
        }
        
        // 格式化价格（针对不同交易对使用不同小数位数）
        function formatPrice(price, symbol) {
            if (price === null || price === undefined) return '-';
            // DOGE保留4位小数（支持多种格式：DOGE/USDT, DOGEUSDT, DOGE等）
            if (symbol) {
                const symbolUpper = symbol.toUpperCase();
                if (symbolUpper.includes('DOGE')) {
                    return Number(price).toFixed(4);
                }
            }
            // 其他币种默认2位小数
            return Number(price).toFixed(2);
        }

        // 格式化信号
        function formatSignal(signal) {
            const signals = {
                'STRONG_BUY': { text: '强烈买入', class: 'signal-strong-buy' },
                'BUY': { text: '买入', class: 'signal-buy' },
                'HOLD': { text: '持有', class: 'signal-hold' },
                'SELL': { text: '卖出', class: 'signal-sell' },
                'STRONG_SELL': { text: '强烈卖出', class: 'signal-strong-sell' }
            };
            const s = signals[signal] || { text: signal, class: 'signal-hold' };
            return `<span class="${s.class}">${s.text}</span>`;
        }

        // 格式化时间
        function formatTime(timeStr) {
            if (!timeStr) return '-';
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN');
        }
        
        // 格式化大数字
        function formatLargeNumber(num) {
            if (num === null || num === undefined) return '-';
            if (num >= 1e9) {
                return (num / 1e9).toFixed(2) + 'B';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(2) + 'M';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(2) + 'K';
            }
            return formatNumber(num, 2);
        }

        // 加载技术指标数据
        // 显示技术指标详情
        function displayIndicatorDetails(data) {
            document.getElementById('selectedSymbol').textContent = `${data.symbol} - 技术指标详情`;
            document.getElementById('indicatorsCard').style.display = 'block';
            
            const grid = document.getElementById('indicatorsGrid');
            grid.innerHTML = `
                <div class="indicator-card">
                    <div class="indicator-name">技术评分</div>
                    <div class="indicator-value">${formatNumber(data.technical_score)}</div>
                    <div>${formatSignal(data.technical_signal)}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">RSI</div>
                    <div class="indicator-value">${formatNumber(data.rsi?.value)}</div>
                    <div>${data.rsi?.signal || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">MACD</div>
                    <div class="indicator-value">${formatNumber(data.macd?.value)}</div>
                    <div>${data.macd?.trend || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">布林带位置</div>
                    <div class="indicator-value">${data.bollinger_bands?.position || '-'}</div>
                    <div>宽度: ${formatNumber(data.bollinger_bands?.width)}%</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">EMA趋势</div>
                    <div class="indicator-value">${data.ema?.trend || '-'}</div>
                    <div>短期: ${formatNumber(data.ema?.short)} | 长期: ${formatNumber(data.ema?.long)}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">KDJ</div>
                    <div class="indicator-value">K:${formatNumber(data.kdj?.k)} D:${formatNumber(data.kdj?.d)} J:${formatNumber(data.kdj?.j)}</div>
                    <div>${data.kdj?.signal || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">成交量</div>
                    <div class="indicator-value">${formatNumber(data.volume?.volume_ratio, 2)}x</div>
                    <div>${data.volume?.signal || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">更新时间</div>
                    <div class="indicator-value" style="font-size: 14px;">${formatTime(data.updated_at)}</div>
                </div>
            `;
        }

        // 加载单个交易对的指标详情
        async function loadIndicatorDetails(symbol) {
            // 使用默认timeframe（1h），因为信号列表TAB已删除
            const timeframe = '1h';
            currentSymbol = symbol;
            
            try {
                // 同时获取技术指标和综合交易信号
                // 对symbol进行URL编码，处理斜杠
                const encodedSymbol = encodeURIComponent(symbol);
                const [indicatorsResponse, signalResponse] = await Promise.all([
                    fetch(`/api/technical-indicators?symbol=${encodeURIComponent(symbol)}&timeframe=${timeframe}`),
                    fetch(`/api/signals/${encodedSymbol}?timeframe=${timeframe}`).catch(() => null)
                ]);
                
                const indicatorsData = await indicatorsResponse.json();
                let signalData = null;
                if (signalResponse) {
                    try {
                        signalData = await signalResponse.json();
                    } catch (e) {
                        console.warn('获取综合信号失败:', e);
                    }
                }
                
                displayIndicatorDetails(indicatorsData, signalData);
            } catch (error) {
                console.error('加载指标详情失败:', error);
                alert('加载详情失败: ' + error.message);
            }
        }
        
        // 显示详细分析模态框
        function showDetailedAnalysis(symbol, indicatorsData, signalData, priceData) {
            const modal = document.getElementById('detailedAnalysisModal');
            const modalContent = document.getElementById('detailedAnalysisContent');
            
            // 获取实时价格
            let currentPrice = null;
            let maxPrice = null;
            let minPrice = null;
            let spreadPct = null;
            let totalVolume = null;
            let exchangesCount = null;
            let change24h = null;
            let change24hAbs = null;
            let high24h = null;
            let low24h = null;
            let volume24h = null;
            
            if (priceData && priceData.price) {
                currentPrice = parseFloat(priceData.price);
                maxPrice = priceData.max_price ? parseFloat(priceData.max_price) : null;
                minPrice = priceData.min_price ? parseFloat(priceData.min_price) : null;
                spreadPct = priceData.spread_pct ? parseFloat(priceData.spread_pct) : null;
                totalVolume = priceData.total_volume ? parseFloat(priceData.total_volume) : null;
                exchangesCount = priceData.exchanges || null;
                
                // 从details中获取24小时数据
                if (priceData.details && priceData.details.length > 0) {
                    const firstDetail = priceData.details[0];
                    change24h = firstDetail.change_24h !== undefined ? parseFloat(firstDetail.change_24h) : null;
                    high24h = firstDetail.high_24h !== undefined ? parseFloat(firstDetail.high_24h) : null;
                    low24h = firstDetail.low_24h !== undefined ? parseFloat(firstDetail.low_24h) : null;
                    volume24h = firstDetail.volume_24h !== undefined ? parseFloat(firstDetail.volume_24h) : null;
                }
                
                // 如果没有details，尝试直接从priceData获取
                if (change24h === null && priceData.change_24h !== undefined) {
                    change24h = parseFloat(priceData.change_24h);
                }
                if (high24h === null && priceData.high_24h !== undefined) {
                    high24h = parseFloat(priceData.high_24h);
                }
                if (low24h === null && priceData.low_24h !== undefined) {
                    low24h = parseFloat(priceData.low_24h);
                }
                if (volume24h === null && priceData.volume_24h !== undefined) {
                    volume24h = parseFloat(priceData.volume_24h);
                }
                
                // 计算24小时涨跌绝对值
                if (change24h !== null && currentPrice !== null) {
                    change24hAbs = (currentPrice * change24h / 100);
                }
            } else if (signalData && signalData.price && signalData.price.current) {
                currentPrice = parseFloat(signalData.price.current);
            }
            
            let html = `
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-currency-dollar"></i>
                        实时价格
                    </h3>
                    <div class="realtime-price">
                        <div class="realtime-price-label">
                            <i class="bi bi-circle-fill price-update-indicator"></i>
                            实时价格（每5秒更新）
                        </div>
                        <div class="realtime-price-value" id="realtime-price-value" data-old-price="${currentPrice || 0}" data-symbol="${symbol || ''}">
                            ${currentPrice ? formatPrice(currentPrice, symbol || '') + ' USDT' : '加载中...'}
                        </div>
                        <div class="realtime-price-change" id="realtime-price-change" style="margin-top: var(--spacing-sm);">
                            <span style="color: var(--text-secondary); font-size: 12px;">
                                价格变动: <span id="price-change-text">-</span>
                            </span>
                        </div>
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-default);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--spacing-md); font-size: 12px;">
                                ${change24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时涨跌</div>
                                    <div style="color: ${change24h >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}; font-weight: 600; font-size: 14px;">
                                        ${change24h >= 0 ? '+' : ''}${formatNumber(change24h)}%
                                    </div>
                                    ${change24hAbs !== null ? `
                                    <div style="color: var(--text-secondary); font-size: 11px; margin-top: 2px;">
                                        ${change24hAbs >= 0 ? '+' : ''}${formatNumber(change24hAbs)} USDT
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                                ${high24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时最高</div>
                                    <div style="color: var(--success-green); font-weight: 600;">${formatNumber(high24h)}</div>
                                </div>
                                ` : ''}
                                ${low24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时最低</div>
                                    <div style="color: var(--danger-red); font-weight: 600;">${formatNumber(low24h)}</div>
                                </div>
                                ` : ''}
                                ${volume24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时成交量</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${formatLargeNumber(volume24h)}</div>
                                </div>
                                ` : ''}
                                ${maxPrice && minPrice ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">跨交易所价差</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${spreadPct ? formatNumber(spreadPct, 3) + '%' : '-'}</div>
                                </div>
                                ` : ''}
                            </div>
                            ${exchangesCount ? `
                                <div style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: 11px;">
                                    数据来源: ${exchangesCount} 个交易所
                                    ${totalVolume ? ` | 总成交量: ${formatLargeNumber(totalVolume)}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-graph-up"></i>
                        综合评分
                    </h3>
                    <div class="score-grid">
            `;
            
            if (signalData && signalData.score) {
                html += `
                    <div class="score-item">
                        <div class="score-label">综合评分</div>
                        <div class="score-value" style="color: ${signalData.score.total >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">
                            ${signalData.score.total >= 0 ? '+' : ''}${formatNumber(signalData.score.total)}
                        </div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">技术指标评分</div>
                        <div class="score-value">${formatNumber(signalData.score.technical)}</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">新闻情绪评分</div>
                        <div class="score-value">${formatNumber(signalData.score.news)}</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">置信度</div>
                        <div class="score-value" style="color: ${signalData.confidence >= 70 ? 'var(--success-green)' : signalData.confidence >= 50 ? 'var(--warning-yellow)' : 'var(--text-secondary)'}">
                            ${formatNumber(signalData.confidence)}%
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="score-item">
                        <div class="score-label">技术评分</div>
                        <div class="score-value">${formatNumber(indicatorsData.technical_score)}</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">信号</div>
                        <div class="score-value">${formatSignal(indicatorsData.technical_signal)}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-currency-dollar"></i>
                        价格建议
                    </h3>
                    <div class="price-info">
            `;
            
            // 优先使用凯利公式建议（如果合约信号数据中有）
            const kellyAdvice = signalData?.kelly_advice || (indicatorsData?.kelly_advice ? indicatorsData.kelly_advice : null);
            
            // 如果有凯利公式建议，优先使用（即使仓位为0也显示，因为包含了止损止盈价格）
            if (kellyAdvice && kellyAdvice.entry_price && kellyAdvice.stop_loss && kellyAdvice.take_profit) {
                // 使用凯利公式建议
                const displayPrice = currentPrice || kellyAdvice.entry_price;
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">${formatPrice(displayPrice, symbol)} USDT</div>
                    </div>
                    ${kellyAdvice.position_pct > 0 ? `
                    <div class="price-item">
                        <div class="price-label">建议仓位（凯利公式）</div>
                        <div class="price-value" style="color: var(--primary-blue); font-size: 20px;">${formatNumber(kellyAdvice.position_pct)}%</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            胜率: ${formatNumber(kellyAdvice.win_rate)}% | 盈亏比: ${formatNumber(kellyAdvice.profit_loss_ratio)}:1
                        </div>
                    </div>
                    ` : `
                    <div class="price-item">
                        <div class="price-label">凯利公式评估</div>
                        <div class="price-value" style="color: var(--text-secondary); font-size: 14px;">${kellyAdvice.recommendation || '不建议开仓'}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            胜率: ${formatNumber(kellyAdvice.win_rate)}% | 盈亏比: ${formatNumber(kellyAdvice.profit_loss_ratio)}:1
                        </div>
                    </div>
                    `}
                    <div class="price-item">
                        <div class="price-label">建议入场价</div>
                        <div class="price-value" style="color: var(--primary-blue)">${formatPrice(kellyAdvice.entry_price, symbol)} USDT</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">止损价</div>
                        <div class="price-value" style="color: var(--danger-red)">${formatPrice(kellyAdvice.stop_loss, symbol)} USDT</div>
                        ${displayPrice && kellyAdvice.stop_loss ? `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                距离: ${formatNumber(Math.abs((displayPrice - kellyAdvice.stop_loss) / displayPrice * 100))}%
                            </div>
                        ` : ''}
                    </div>
                    <div class="price-item">
                        <div class="price-label">止盈价</div>
                        <div class="price-value" style="color: var(--success-green)">${formatPrice(kellyAdvice.take_profit, symbol)} USDT</div>
                        ${displayPrice && kellyAdvice.take_profit ? `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                距离: ${formatNumber(Math.abs((kellyAdvice.take_profit - displayPrice) / displayPrice * 100))}%
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (signalData && signalData.price) {
                // 使用实时价格或信号中的价格
                const displayPrice = currentPrice || signalData.price.current;
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">${formatPrice(displayPrice, symbol)} USDT</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">建议入场价</div>
                        <div class="price-value" style="color: var(--primary-blue)">${formatPrice(signalData.price.entry, symbol)} USDT</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">止损价</div>
                        <div class="price-value" style="color: var(--danger-red)">${formatPrice(signalData.price.stop_loss, symbol)} USDT</div>
                        ${displayPrice && signalData.price.stop_loss ? `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                距离: ${formatNumber(Math.abs((displayPrice - signalData.price.stop_loss) / displayPrice * 100))}%
                            </div>
                        ` : ''}
                    </div>
                    <div class="price-item">
                        <div class="price-label">止盈价</div>
                        <div class="price-value" style="color: var(--success-green)">${formatPrice(signalData.price.take_profit, symbol)} USDT</div>
                        ${displayPrice && signalData.price.take_profit ? `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                距离: ${formatNumber(Math.abs((signalData.price.take_profit - displayPrice) / displayPrice * 100))}%
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (currentPrice) {
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">${formatPrice(currentPrice, symbol)} USDT</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">-</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-bar-chart"></i>
                        技术指标详细分析
                    </h3>
                    <div class="indicator-detail">
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">RSI (相对强弱指标)</div>
                            <div class="indicator-detail-value">${formatNumber(indicatorsData.rsi?.value)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.rsi?.signal === 'oversold' ? '超卖，可能反弹' : 
                                  indicatorsData.rsi?.signal === 'overbought' ? '超买，可能回调' : 
                                  '中性区域'}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">MACD</div>
                            <div class="indicator-detail-value">${indicatorsData.macd?.trend || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.macd?.trend === 'bullish_cross' ? '金叉，看涨信号' : 
                                  indicatorsData.macd?.trend === 'bearish_cross' ? '死叉，看跌信号' : 
                                  '中性'}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">布林带位置</div>
                            <div class="indicator-detail-value">${indicatorsData.bollinger_bands?.position || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                上轨: ${formatNumber(indicatorsData.bollinger_bands?.upper)} | 
                                下轨: ${formatNumber(indicatorsData.bollinger_bands?.lower)}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">EMA趋势</div>
                            <div class="indicator-detail-value">${indicatorsData.ema?.trend || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                短期: ${formatNumber(indicatorsData.ema?.short)} | 
                                长期: ${formatNumber(indicatorsData.ema?.long)}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">KDJ指标</div>
                            <div class="indicator-detail-value">
                                K:${formatNumber(indicatorsData.kdj?.k)} 
                                D:${formatNumber(indicatorsData.kdj?.d)} 
                                J:${formatNumber(indicatorsData.kdj?.j)}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.kdj?.signal || '-'}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">成交量</div>
                            <div class="indicator-detail-value">${formatNumber(indicatorsData.volume?.volume_ratio, 2)}x</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.volume?.signal === 'high' ? '成交量放大' : '正常'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (signalData && signalData.reasons && signalData.reasons.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-lightbulb"></i>
                            推荐理由
                        </h3>
                        <ul class="reasons-list">
                `;
                signalData.reasons.forEach(reason => {
                    html += `<li>${reason}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            if (signalData && signalData.risks && signalData.risks.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-exclamation-triangle"></i>
                            风险提示
                        </h3>
                        <ul class="risks-list">
                `;
                signalData.risks.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            if (signalData && signalData.action) {
                html += `
                    <div class="analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-arrow-right-circle"></i>
                            操作建议
                        </h3>
                        <div style="background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-md);">
                                ${formatSignal(signalData.action)}
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                                置信度: ${formatNumber(signalData.confidence)}%
                            </div>
                            ${signalData.position ? `
                                <div style="color: var(--text-secondary); font-size: 13px;">
                                    <div>建议仓位: ${formatNumber(signalData.position.recommended_size * 100)}%</div>
                                    <div>最大亏损: ${formatNumber(signalData.position.max_loss_pct)}%</div>
                                    <div>目标收益: ${formatNumber(signalData.position.max_profit_pct)}%</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        

        // 加载EMA信号
        // 加载超卖超买信号
        // 加载技术信号
        async function loadTechnicalSignals() {
            try {
                const tbody = document.getElementById('technicalSignalsTableBody');
                // 每次刷新都更新表格内容，确保价格等数据能及时更新
                // 不显示"加载中"提示，直接更新数据，避免闪烁
                
                const response = await fetch('/api/technical-signals');
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    
                    data.data.forEach(item => {
                        const indicators15m = item['15m'];
                        const indicators1h = item['1h'];
                        const indicators1d = item['1d'];
                        
                        // 计算综合评分（15m、1h和1d的平均值）
                        let overallScore = 0;
                        let count = 0;
                        if (indicators15m && indicators15m.technical_score !== null) {
                            overallScore += indicators15m.technical_score;
                            count++;
                        }
                        if (indicators1h && indicators1h.technical_score !== null) {
                            overallScore += indicators1h.technical_score;
                            count++;
                        }
                        if (indicators1d && indicators1d.technical_score !== null) {
                            overallScore += indicators1d.technical_score;
                            count++;
                        }
                        const avgScore = count > 0 ? overallScore / count : 0;
                        
                        // 格式化价格显示
                        let priceHtml = '<span class="text-muted" style="font-size: 13px;">-</span>';
                        if (item.current_price !== null && item.current_price !== undefined) {
                            const priceClass = item.change_24h >= 0 ? 'signal-buy' : 'signal-sell';
                            const changeIcon = item.change_24h >= 0 ? '▲' : '▼';
                            priceHtml = `
                                <strong>${formatPrice(item.current_price, item.symbol)}</strong>
                                ${item.change_24h !== null && item.change_24h !== undefined 
                                    ? `<small class="${priceClass}">${changeIcon} ${item.change_24h >= 0 ? '+' : ''}${formatNumber(item.change_24h, 2)}%</small>`
                                    : ''}
                            `;
                        }
                        
                        // 格式化15分钟指标
                        const formatIndicators = (ind) => {
                            if (!ind) return '<span class="text-muted">-</span>';
                            
                            let html = '<div style="font-size: 12px; line-height: 1.6;">';
                            
                            // RSI
                            if (ind.rsi_value !== null) {
                                const rsiClass = ind.rsi_value > 70 ? 'signal-sell' : ind.rsi_value < 30 ? 'signal-buy' : '';
                                html += `<div>RSI: <span class="${rsiClass}">${formatNumber(ind.rsi_value, 1)}</span></div>`;
                            }
                            
                            // MACD
                            if (ind.macd_trend) {
                                const macdClass = ind.macd_trend === 'bullish_cross' ? 'signal-buy' : ind.macd_trend === 'bearish_cross' ? 'signal-sell' : '';
                                const macdText = ind.macd_trend === 'bullish_cross' ? '金叉' : ind.macd_trend === 'bearish_cross' ? '死叉' : '中性';
                                html += `<div>MACD: <span class="${macdClass}">${macdText}</span></div>`;
                            }
                            
                            // EMA
                            if (ind.ema_trend) {
                                const emaClass = ind.ema_trend === 'bullish' ? 'signal-buy' : ind.ema_trend === 'bearish' ? 'signal-sell' : '';
                                const emaText = ind.ema_trend === 'bullish' ? '看涨' : ind.ema_trend === 'bearish' ? '看跌' : '中性';
                                html += `<div>EMA: <span class="${emaClass}">${emaText}</span></div>`;
                            }
                            
                            // BOLL
                            if (ind.bb_position) {
                                const bbText = {
                                    'above_upper': '上轨',
                                    'middle': '中轨',
                                    'below_lower': '下轨'
                                }[ind.bb_position] || ind.bb_position;
                                const bbClass = ind.bb_position === 'below_lower' ? 'signal-buy' : ind.bb_position === 'above_upper' ? 'signal-sell' : '';
                                html += `<div>BOLL: <span class="${bbClass}">${bbText}</span></div>`;
                            }
                            
                            // 技术评分
                            if (ind.technical_score !== null) {
                                const scoreClass = ind.technical_score >= 60 ? 'signal-buy' : ind.technical_score <= 40 ? 'signal-sell' : '';
                                html += `<div style="margin-top: 4px; font-weight: 600;">评分: <span class="${scoreClass}">${formatNumber(ind.technical_score, 1)}</span></div>`;
                            }
                            
                            html += '</div>';
                            return html;
                        };
                        
                        // 综合评分样式
                        let scoreClass = '';
                        let scoreText = '';
                        if (avgScore >= 75) {
                            scoreClass = 'signal-strong-buy';
                            scoreText = '强烈买入';
                        } else if (avgScore >= 60) {
                            scoreClass = 'signal-buy';
                            scoreText = '买入';
                        } else if (avgScore >= 40) {
                            scoreClass = 'signal-hold';
                            scoreText = '持有';
                        } else if (avgScore >= 25) {
                            scoreClass = 'signal-sell';
                            scoreText = '卖出';
                        } else {
                            scoreClass = 'signal-strong-sell';
                            scoreText = '强烈卖出';
                        }
                        
                        html += `
                            <tr>
                                <td><strong>${item.symbol}</strong></td>
                                <td>
                                    <div class="realtime-price">
                                        ${priceHtml}
                                    </div>
                                </td>
                                <td>${formatIndicators(indicators15m)}</td>
                                <td>${formatIndicators(indicators1h)}</td>
                                <td>${formatIndicators(indicators1d)}</td>
                                <td>
                                    <div style="text-align: center;">
                                        <div class="${scoreClass}" style="font-weight: 600; font-size: 13px; margin-bottom: 4px;">${scoreText}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${formatNumber(avgScore, 1)}</div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn-detail" onclick="event.stopPropagation(); showDetailedAnalysisModal('${item.symbol}')" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                } else {
                    // 显示更详细的提示信息
                    let emptyMessage = '暂无技术信号数据';
                    if (data.success && data.data && data.data.length === 0) {
                        emptyMessage = '暂无技术信号数据（可能15m、1h或1d时间周期的数据尚未生成，请等待缓存更新）';
                    } else if (!data.success) {
                        emptyMessage = `加载失败: ${data.detail || data.message || '未知错误'}`;
                    }
                    tbody.innerHTML = `<tr><td colspan="7" class="empty-state">${emptyMessage}</td></tr>`;
                }
            } catch (error) {
                console.error('加载技术信号失败:', error);
                document.getElementById('technicalSignalsTableBody').innerHTML = 
                    `<tr><td colspan="7" class="empty-state">加载失败: ${error.message || '请稍后重试'}</td></tr>`;
            }
        }

        // 已移除：loadOversoldOverboughtSignals 函数（超买超卖信号功能已移除）

        // 加载趋势分析数据
        async function loadTrendAnalysis() {
            try {
                const tbody = document.getElementById('trendAnalysisTableBody');
                // 每次刷新都更新表格内容，确保价格等数据能及时更新
                // 不显示"加载中"提示，直接更新数据，避免闪烁
                
                const response = await fetch('/api/trend-analysis');
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    
                    data.data.forEach(item => {
                        const trend5m = item['5m'];
                        const trend15m = item['15m'];
                        const trend1h = item['1h'];
                        const trend1d = item['1d'];
                        
                        // 计算综合评估（包含5m）
                        let overallScore = 0;
                        let count = 0;
                        if (trend5m) { overallScore += trend5m.trend_score; count++; }
                        if (trend15m) { overallScore += trend15m.trend_score; count++; }
                        if (trend1h) { overallScore += trend1h.trend_score; count++; }
                        if (trend1d) { overallScore += trend1d.trend_score; count++; }
                        const avgScore = count > 0 ? overallScore / count : 50;
                        
                        let overallTrend = 'SIDEWAYS';
                        let overallText = '震荡';
                        let overallClass = 'trend-neutral';
                        if (avgScore >= 75) {
                            overallTrend = 'STRONG_UPTREND';
                            overallText = '强烈上涨';
                            overallClass = 'trend-strong-up';
                        } else if (avgScore >= 60) {
                            overallTrend = 'UPTREND';
                            overallText = '上涨';
                            overallClass = 'trend-up';
                        } else if (avgScore >= 45) {
                            overallTrend = 'SIDEWAYS';
                            overallText = '震荡';
                            overallClass = 'trend-neutral';
                        } else if (avgScore >= 30) {
                            overallTrend = 'DOWNTREND';
                            overallText = '下跌';
                            overallClass = 'trend-down';
                        } else {
                            overallTrend = 'STRONG_DOWNTREND';
                            overallText = '强烈下跌';
                            overallClass = 'trend-strong-down';
                        }
                        
                        // 格式化价格显示（优化样式，无边框）
                        let priceHtml = '<span class="text-muted" style="font-size: 13px;">-</span>';
                        if (item.current_price !== null && item.current_price !== undefined) {
                            const priceClass = item.change_24h >= 0 ? 'signal-buy' : 'signal-sell';
                            const changeIcon = item.change_24h >= 0 ? '▲' : '▼';
                            priceHtml = `
                                <strong>${formatPrice(item.current_price, item.symbol)}</strong>
                                ${item.change_24h !== null && item.change_24h !== undefined 
                                    ? `<small class="${priceClass}">${changeIcon} ${item.change_24h >= 0 ? '+' : ''}${formatNumber(item.change_24h, 2)}%</small>`
                                    : ''}
                            `;
                        }
                        
                        html += `
                            <tr data-symbol="${item.symbol}">
                                <td>
                                    <strong>${item.symbol}</strong>
                                    <div id="price-${item.symbol.replace('/', '-')}" class="realtime-price">
                                        ${priceHtml}
                                    </div>
                                </td>
                                <td>${formatTrendCell(trend5m)}</td>
                                <td>${formatTrendCell(trend15m)}</td>
                                <td>${formatTrendCell(trend1h)}</td>
                                <td>${formatTrendCell(trend1d)}</td>
                                <td>
                                    <span class="badge ${overallClass}">${overallText}</span>
                                    <br><small style="color: #666;">评分: ${avgScore.toFixed(1)}</small>
                                </td>
                                <td>
                                    <button class="btn-detail" onclick="event.stopPropagation(); showDetailedAnalysisModal('${item.symbol}')" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="empty-state">暂无数据</td></tr>';
                }
            } catch (error) {
                console.error('加载趋势分析失败:', error);
                document.getElementById('trendAnalysisTableBody').innerHTML = 
                    '<tr><td colspan="7" class="empty-state">加载失败，请稍后重试</td></tr>';
            }
        }
        
        // 格式化趋势单元格
        function formatTrendCell(trend) {
            if (!trend) {
                return '<span class="text-muted">-</span>';
            }
            
            let priceInfo = '';
            if (trend.price_change_pct !== undefined && trend.price_change_pct !== null) {
                const priceClass = trend.price_change_pct >= 0 ? 'signal-buy' : 'signal-sell';
                priceInfo = `<br><small style="color: #666;">价格变化: <span class="${priceClass}">${trend.price_change_pct >= 0 ? '+' : ''}${formatNumber(trend.price_change_pct, 2)}%</span>`;
                if (trend.volume_change_pct !== undefined && trend.volume_change_pct !== null) {
                    const volumeClass = trend.volume_change_pct >= 0 ? 'signal-buy' : 'signal-sell';
                    priceInfo += ` | 成交量变化: <span class="${volumeClass}">${trend.volume_change_pct >= 0 ? '+' : ''}${formatNumber(trend.volume_change_pct, 2)}%</span>`;
                }
                priceInfo += '</small>';
            }
            
            return `
                <div>
                    <span class="badge ${trend.trend_class}">${trend.trend_text}</span>
                    <br><small style="color: #666;">
                        评分: ${trend.trend_score} | 
                        RSI: ${formatNumber(trend.rsi_value, 1)} | 
                        置信度: ${trend.confidence}%
                    </small>
                    ${priceInfo}
                </div>
            `;
        }

        // 格式化技术指标显示（带方向箭头）
        function formatIndicatorCell(indicators) {
            if (!indicators || !indicators.directions) {
                return '<span class="text-muted">-</span>';
            }
            
            const dirs = indicators.directions;
            const vals = indicators.values;
            
            // 方向箭头
            const getDirectionIcon = (direction) => {
                if (direction === 'up') return '<span class="signal-buy">↑</span>';
                if (direction === 'down') return '<span class="signal-sell">↓</span>';
                if (direction === 'neutral') return '<span class="text-muted">→</span>';
                return '<span class="text-muted">-</span>';
            };
            
            // 综合评估
            const overall = dirs.overall || 'neutral';
            const overallText = overall === 'up' ? '看涨' : overall === 'down' ? '看跌' : '中性';
            const overallClass = overall === 'up' ? 'signal-buy' : overall === 'down' ? 'signal-sell' : 'text-muted';
            
            let html = '<div style="font-size: 12px; line-height: 1.6;">';
            let hasAnyIndicator = false;
            
            // RSI
            if (dirs.rsi && dirs.rsi.direction) {
                const rsiValue = (vals && vals.rsi_value !== null && vals.rsi_value !== undefined) 
                    ? formatNumber(vals.rsi_value, 1) 
                    : '-';
                html += `<div>RSI: ${rsiValue} ${getDirectionIcon(dirs.rsi.direction)}</div>`;
                hasAnyIndicator = true;
            }
            
            // EMA
            if (dirs.ema && dirs.ema.direction) {
                html += `<div>EMA: ${getDirectionIcon(dirs.ema.direction)}</div>`;
                hasAnyIndicator = true;
            }
            
            // MACD
            if (dirs.macd && dirs.macd.direction) {
                html += `<div>MACD: ${getDirectionIcon(dirs.macd.direction)}</div>`;
                hasAnyIndicator = true;
            }
            
            // BOLL
            if (dirs.boll && dirs.boll.direction) {
                html += `<div>BOLL: ${getDirectionIcon(dirs.boll.direction)}</div>`;
                hasAnyIndicator = true;
            }
            
            // 如果没有显示任何指标，返回默认值
            if (!hasAnyIndicator) {
                return '<span class="text-muted">-</span>';
            }
            
            // 综合评估
            html += `<div style="margin-top: 4px; font-weight: 600; border-top: 1px solid #eee; padding-top: 4px;">
                <span class="${overallClass}">${overallText}</span>
            </div>`;
            
            html += '</div>';
            return html;
        }
        
        // 加载合约信号
        async function loadFuturesSignals() {
            try {
                const tbody = document.getElementById('futuresSignalsTableBody');
                tbody.innerHTML = '<tr><td colspan="11" class="loading">加载中...</td></tr>';
                
                const response = await fetch('/api/futures-signals');
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    let html = '';
                    
                    data.data.forEach(signal => {
                        // 格式化价格显示
                        let priceHtml = '<span class="text-muted">-</span>';
                        if (signal.current_price !== null && signal.current_price !== undefined) {
                            const priceClass = signal.price_change_24h >= 0 ? 'signal-buy' : 'signal-sell';
                            priceHtml = `
                                <div class="realtime-price" id="price-${signal.symbol.replace('/', '-')}">
                                    <strong style="font-size: 16px;">${formatPrice(signal.current_price, signal.symbol)}</strong>
                                    ${signal.price_change_24h !== null && signal.price_change_24h !== undefined 
                                        ? `<br><small class="${priceClass}">${signal.price_change_24h >= 0 ? '+' : ''}${formatNumber(signal.price_change_24h, 2)}%</small>`
                                        : ''}
                                </div>
                            `;
                        }
                        
                        html += `
                            <tr data-symbol="${signal.symbol}">
                                <td><strong>${signal.symbol}</strong></td>
                                <td>${priceHtml}</td>
                                <td>
                                    <span class="badge ${signal.signal_class}">${signal.signal_text}</span>
                                </td>
                                <td class="${signal.signal_score >= 0 ? 'signal-buy' : 'signal-sell'}" style="font-weight: 600;">
                                    ${signal.signal_score >= 0 ? '+' : ''}${formatNumber(signal.signal_score, 1)}
                                </td>
                                <td>
                                    ${signal.funding_rate !== null && signal.funding_rate !== undefined 
                                        ? `<span class="${signal.funding_rate > 0 ? 'signal-buy' : signal.funding_rate < 0 ? 'signal-sell' : ''}">${formatNumber(signal.funding_rate, 4)}%</span>`
                                        : '<span class="text-muted">-</span>'}
                                </td>
                                <td>
                                    ${signal.long_short_ratio !== null && signal.long_short_ratio !== undefined 
                                        ? `${formatNumber(signal.long_short_ratio, 2)}`
                                        : '<span class="text-muted">-</span>'}
                                </td>
                                <td>
                                    ${signal.oi_change_pct !== null && signal.oi_change_pct !== undefined 
                                        ? `<span class="${signal.oi_change_pct >= 0 ? 'signal-buy' : 'signal-sell'}">${signal.oi_change_pct >= 0 ? '+' : ''}${formatNumber(signal.oi_change_pct, 2)}%</span>`
                                        : '<span class="text-muted">-</span>'}
                                </td>
                                <td style="min-width: 120px;">${formatIndicatorCell(signal.indicators_5m)}</td>
                                <td style="min-width: 120px;">${formatIndicatorCell(signal.indicators_15m)}</td>
                                <td style="min-width: 120px;">${formatIndicatorCell(signal.indicators_1h)}</td>
                                <td>
                                    <button class="btn-detail" onclick="event.stopPropagation(); showDetailedAnalysisModal('${signal.symbol}')" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="12" class="empty-state">暂无合约信号数据</td></tr>';
                }
            } catch (error) {
                console.error('加载合约信号失败:', error);
                document.getElementById('futuresSignalsTableBody').innerHTML = 
                    '<tr><td colspan="12" class="empty-state">加载失败，请稍后重试</td></tr>';
            }
        }
        
        // 更新合约信号的实时价格
        async function updateFuturesPrices() {
            try {
                const tbody = document.getElementById('futuresSignalsTableBody');
                const rows = tbody.querySelectorAll('tr[data-symbol]');
                
                if (rows.length === 0) return;
                
                // 收集所有交易对
                const symbols = Array.from(rows).map(row => row.getAttribute('data-symbol'));
                
                // 批量获取价格
                const response = await fetch(`/api/realtime-prices?symbols=${symbols.join(',')}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    // 更新每个交易对的价格
                    rows.forEach(row => {
                        const symbol = row.getAttribute('data-symbol');
                        const priceInfo = data.data[symbol];
                        const priceCell = row.querySelector(`#price-${symbol.replace('/', '-')}`);
                        
                        if (priceInfo && priceCell) {
                            const oldPrice = parseFloat(priceCell.querySelector('strong')?.textContent.replace(/,/g, '') || '0');
                            const newPrice = priceInfo.price;
                            
                            if (oldPrice > 0 && newPrice !== oldPrice) {
                                // 价格变化，添加动画效果
                                priceCell.classList.add('price-updated');
                                setTimeout(() => priceCell.classList.remove('price-updated'), 500);
                            }
                            
                            const priceClass = priceInfo.change_24h >= 0 ? 'signal-buy' : 'signal-sell';
                            // 从row中获取symbol
                            const symbol = row.getAttribute('data-symbol');
                            priceCell.innerHTML = `
                                <strong style="font-size: 16px;">${formatPrice(newPrice, symbol)}</strong>
                                ${priceInfo.change_24h !== null && priceInfo.change_24h !== undefined 
                                    ? `<br><small class="${priceClass}">${priceInfo.change_24h >= 0 ? '+' : ''}${formatNumber(priceInfo.change_24h, 2)}%</small>`
                                    : ''}
                            `;
                        }
                    });
                }
            } catch (error) {
                // 静默失败，不影响主功能
            }
        }

        // 已移除：实时价格更新功能（不再需要，定时刷新会更新所有数据包括价格）

        // 初始化
        async function init() {
            // 加载初始数据（趋势判断作为默认TAB）
            await loadTrendAnalysis();
            
            // 设置定时刷新（每30秒刷新一次，包含价格和指标数据）
            // 无论当前在哪个标签页，都刷新所有数据，确保数据是最新的
            setInterval(() => {
                loadTrendAnalysis();
            }, 30000); // 每30秒刷新趋势分析
            
            setInterval(() => {
                loadTechnicalSignals();
            }, 30000); // 每30秒刷新技术信号
            
            setInterval(() => {
                loadFuturesSignals();
            }, 30000); // 每30秒刷新合约信号
            
            // 实时价格更新（每5秒更新一次价格，不影响其他数据）
            setInterval(() => {
                updateFuturesPrices();
            }, 5000); // 每5秒更新价格
        }

        // 带超时的fetch请求
        async function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('请求超时');
                }
                throw error;
            }
        }

        // 显示详细分析模态框
        async function showDetailedAnalysisModal(symbol) {
            const modal = document.getElementById('detailedAnalysisModal');
            const modalTitle = document.getElementById('modalSymbolTitle');
            const modalContent = document.getElementById('detailedAnalysisContent');
            // 使用默认timeframe（1h），因为信号列表TAB已删除
            const timeframe = '1h';
            
            modalTitle.textContent = `${symbol} - 详细分析`;
            modalContent.innerHTML = '<div class="loading">加载中...</div>';
            modal.classList.add('active');
            
            try {
                // 对symbol进行URL编码，处理斜杠
                const encodedSymbol = encodeURIComponent(symbol);
                
                // 第一步：快速加载技术指标（从缓存读取，很快）
                let indicatorsData = null;
                try {
                    const indicatorsResponse = await fetchWithTimeout(
                        `/api/technical-indicators?symbol=${encodeURIComponent(symbol)}&timeframe=${timeframe}`,
                        3000
                    );
                    if (indicatorsResponse.ok) {
                        indicatorsData = await indicatorsResponse.json();
                        // 先显示技术指标数据，让用户看到内容
                        showDetailedAnalysis(symbol, indicatorsData, null, null);
                    }
                } catch (e) {
                    console.warn('获取技术指标失败:', e);
                    modalContent.innerHTML = `<div class="empty-state">加载技术指标失败: ${e.message}</div>`;
                    return;
                }
                
                // 第二步：异步加载信号和价格数据（这些可能较慢，但不阻塞显示）
                let signalData = null;
                let priceData = null;
                let futuresSignalData = null;  // 合约信号数据（包含凯利公式建议）
                
                // 并行加载信号和价格，设置合理的超时时间
                // 使用 Promise.allSettled 确保即使某个请求失败也不影响其他请求
                const loadPromises = [
                    fetchWithTimeout(`/api/signals/${encodedSymbol}?timeframe=${timeframe}`, 15000)
                        .then(res => {
                            if (res.ok) {
                                return res.json();
                            }
                            return null;
                        })
                        .then(data => {
                            if (data) {
                                signalData = data;
                            }
                        })
                        .catch(e => {
                            console.warn('获取综合信号失败（已超时或出错）:', e.message);
                            // 不抛出错误，继续执行
                        }),
                    
                    // 获取合约信号数据（包含凯利公式建议）
                    fetchWithTimeout(`/api/futures-signals`, 10000)
                        .then(res => {
                            if (res.ok) {
                                return res.json();
                            }
                            return null;
                        })
                        .then(data => {
                            if (data && data.success && data.data) {
                                // 找到对应交易对的合约信号数据
                                const futuresSignal = data.data.find(item => item.symbol === symbol);
                                if (futuresSignal) {
                                    futuresSignalData = futuresSignal;
                                }
                            }
                        })
                        .catch(e => {
                            console.warn('获取合约信号失败（已超时或出错）:', e.message);
                            // 不抛出错误，继续执行
                        }),
                    
                    fetchWithTimeout(`/api/price/${encodedSymbol}`, 8000)
                        .then(res => {
                            if (res.ok) {
                                return res.json();
                            }
                            return null;
                        })
                        .then(data => {
                            if (data) {
                                priceData = data;
                            }
                        })
                        .catch(e => {
                            console.warn('获取实时价格失败（已超时或出错）:', e.message);
                            // 不抛出错误，继续执行
                        })
                ];
                
                // 使用 allSettled 等待所有请求完成（无论成功或失败）
                await Promise.allSettled(loadPromises);
                
                // 如果合约信号数据中有凯利公式建议，将其合并到signalData中
                if (futuresSignalData && futuresSignalData.kelly_advice) {
                    if (!signalData) {
                        signalData = {};
                    }
                    signalData.kelly_advice = futuresSignalData.kelly_advice;
                    // 如果有价格数据，也合并进去
                    if (futuresSignalData.current_price) {
                        if (!signalData.price) {
                            signalData.price = {};
                        }
                        signalData.price.current = futuresSignalData.current_price;
                    }
                }
                
                // 更新显示，包含所有已加载的数据（即使某些数据缺失）
                showDetailedAnalysis(symbol, indicatorsData, signalData, priceData);
                
                // 启动实时价格更新（每5秒更新一次）
                if (window.priceUpdateInterval) {
                    clearInterval(window.priceUpdateInterval);
                }
                window.priceUpdateInterval = setInterval(async () => {
                    try {
                        const encodedSymbol = encodeURIComponent(symbol);
                        const priceRes = await fetchWithTimeout(`/api/price/${encodedSymbol}`, 3000);
                        if (priceRes && priceRes.ok) {
                            const newPriceData = await priceRes.json();
                            updateRealTimePrice(newPriceData);
                        }
                    } catch (e) {
                        console.warn('更新实时价格失败:', e);
                    }
                }, 5000);
            } catch (error) {
                console.error('加载详情失败:', error);
                modalContent.innerHTML = `<div class="empty-state">加载失败: ${error.message}</div>`;
            }
        }
        
        // 更新实时价格
        function updateRealTimePrice(priceData) {
            const priceElement = document.getElementById('realtime-price-value');
            const changeElement = document.getElementById('realtime-price-change');
            if (priceElement && priceData && priceData.price) {
                const currentPrice = parseFloat(priceData.price);
                const oldPrice = parseFloat(priceElement.dataset.oldPrice || currentPrice);
                const change = currentPrice - oldPrice;
                const changePct = oldPrice > 0 ? (change / oldPrice * 100) : 0;
                
                const symbol = priceElement.dataset.symbol || '';
                priceElement.textContent = formatPrice(currentPrice, symbol) + ' USDT';
                priceElement.dataset.oldPrice = currentPrice;
                
                if (changeElement) {
                    const changeClass = change >= 0 ? 'signal-buy' : 'signal-sell';
                    changeElement.innerHTML = `
                        <span class="${changeClass}">
                            ${change >= 0 ? '+' : ''}${formatNumber(change)} 
                            (${change >= 0 ? '+' : ''}${formatNumber(changePct)}%)
                        </span>
                    `;
                }
                
                // 添加闪烁效果提示价格更新
                priceElement.style.animation = 'none';
                setTimeout(() => {
                    priceElement.style.animation = 'priceUpdate 0.5s ease-out';
                }, 10);
            }
        }
        
        // 关闭模态框时清除价格更新定时器
        function closeDetailedAnalysis() {
            const modal = document.getElementById('detailedAnalysisModal');
            modal.classList.remove('active');
            if (window.priceUpdateInterval) {
                clearInterval(window.priceUpdateInterval);
                window.priceUpdateInterval = null;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

