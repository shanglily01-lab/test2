<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技术信号 - AlphaFlow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); }
        .card-body { padding: 0; }
        .filters { display: flex; gap: var(--spacing-md); margin-bottom: var(--spacing-lg); flex-wrap: wrap; }
        .select-input { padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--radius-md); border: 1px solid var(--border-default); background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px; }
        .tabs { display: flex; gap: var(--spacing-sm); border-bottom: 2px solid var(--border-default); margin-bottom: var(--spacing-lg); }
        .tab { padding: var(--spacing-md) var(--spacing-xl); background: transparent; color: var(--text-secondary); border: none; border-bottom: 2px solid transparent; cursor: pointer; font-size: 14px; font-weight: 600; transition: all var(--transition-base); position: relative; top: 2px; }
        .tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); background: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border-default); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        thead { background: var(--bg-tertiary); border-bottom: 2px solid var(--border-default); }
        th { padding: var(--spacing-md) var(--spacing-lg); text-align: left; font-weight: 600; color: #E6EDF3; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: var(--spacing-lg); border-bottom: 1px solid var(--border-default); color: #E6EDF3; font-size: 13px; }
        tbody tr:hover { background: var(--bg-hover); }
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
        .badge-success { background: var(--success-green-bg); color: var(--success-green); }
        .badge-danger { background: var(--danger-red-bg); color: var(--danger-red); }
        .badge-info { background: var(--primary-blue-light); color: var(--primary-blue); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .badge-warning { background: var(--warning-yellow-bg); color: var(--warning-yellow); }
        .indicator-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg); }
        .indicator-card { background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg); }
        .indicator-name { font-size: 14px; color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
        .indicator-value { font-size: 24px; font-weight: 700; color: var(--text-primary); font-family: var(--font-mono); }
        .loading { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 500; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); }
        .btn-primary { background: var(--primary-blue); color: white; }
        .btn-primary:hover { background: var(--primary-blue-hover); }
        .signal-strong-buy { color: var(--success-green); }
        .signal-buy { color: #4ADE80; }
        .signal-hold { color: var(--text-secondary); }
        .signal-sell { color: #FB7185; }
        .signal-strong-sell { color: var(--danger-red); }
        
        /* 模态框样式 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 9999;
            animation: fadeIn var(--transition-base) ease-in;
            padding: var(--spacing-xl);
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-container {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp var(--transition-slow) ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .modal-body {
            padding: var(--spacing-xl);
        }
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: all var(--transition-base);
        }
        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .analysis-section {
            margin-bottom: var(--spacing-xl);
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-default);
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .score-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            text-align: center;
        }
        .score-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        .score-value {
            font-size: 28px;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-primary);
        }
        .price-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        .price-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }
        .price-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        .price-value {
            font-size: 18px;
            font-weight: 600;
            font-family: var(--font-mono);
            color: var(--text-primary);
        }
        .reasons-list, .risks-list {
            list-style: none;
            padding: 0;
        }
        .reasons-list li, .risks-list li {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: var(--bg-tertiary);
            border-left: 3px solid var(--primary-blue);
            border-radius: var(--radius-sm);
        }
        .risks-list li {
            border-left-color: var(--warning-yellow);
        }
        .indicator-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }
        .indicator-detail-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }
        .indicator-detail-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
        }
        .indicator-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: var(--font-mono);
        }
        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
            flex-wrap: wrap;
        }
        .realtime-price {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-card) 100%);
            border: 2px solid var(--primary-blue);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            position: relative;
        }
        .realtime-price-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        .realtime-price-value {
            font-size: 32px;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        .realtime-price-change {
            font-size: 14px;
            font-weight: 600;
        }
        .price-update-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success-green);
            border-radius: 50%;
            margin-left: var(--spacing-xs);
            animation: pulse 2s infinite;
        }
        @keyframes priceUpdate {
            0% { background-color: var(--bg-tertiary); }
            50% { background-color: rgba(43, 111, 237, 0.2); }
            100% { background-color: var(--bg-tertiary); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="header-title">
                <i class="bi bi-graph-up-arrow"></i>
                技术信号分析
            </h1>
            <p class="header-subtitle">实时监控技术指标，捕捉交易信号</p>
        </div>

        <div class="nav-container">
            <nav class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/technical-signals" class="nav-link active">
                    <i class="bi bi-graph-up-arrow"></i> 技术信号
                </a>
                <a href="/paper_trading" class="nav-link">
                    <i class="bi bi-journals"></i> 模拟现货
                </a>
                <a href="/futures_trading" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> 模拟合约
                </a>
                <a href="/strategies" class="nav-link">
                    <i class="bi bi-diagram-3"></i> 策略管理
                </a>
                <a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF 数据
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> 企业金库
                </a>
                <a href="/blockchain_gas" class="nav-link">
                    <i class="bi bi-lightning-charge"></i> Gas统计
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> 数据管理
                </a>
            </nav>
        </div>

        <!-- 技术指标概览 -->
        <div class="card" id="indicatorsCard" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-bar-chart"></i>
                    <span id="selectedSymbol">技术指标详情</span>
                </h2>
            </div>
            <div class="card-body">
                <div class="indicator-grid" id="indicatorsGrid"></div>
            </div>
        </div>

        <!-- 交易信号列表和超卖超买信号 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-bell"></i>
                    交易信号
                </h2>
            </div>
            <div class="card-body">
                <!-- 标签页 -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('signals')" id="tabSignals">
                        <i class="bi bi-list-ul"></i> 信号列表
                    </button>
                    <button class="tab" onclick="switchTab('oversold')" id="tabOversold">
                        <i class="bi bi-exclamation-triangle"></i> 超卖超买信号
                    </button>
                </div>
                
                <!-- 信号列表标签页内容 -->
                <div id="tabContentSignals" class="tab-content active">
                    <!-- 筛选器 -->
                    <div class="filters" style="margin-bottom: var(--spacing-lg);">
                        <select id="symbolFilter" class="select-input">
                            <option value="">所有交易对</option>
                        </select>
                        <select id="timeframeFilter" class="select-input">
                            <option value="1h">1小时</option>
                            <option value="5m">5分钟</option>
                            <option value="15m">15分钟</option>
                            <option value="4h">4小时</option>
                            <option value="1d">1天</option>
                        </select>
                        <select id="signalFilter" class="select-input">
                            <option value="">所有信号</option>
                            <option value="STRONG_BUY">强烈买入</option>
                            <option value="BUY">买入</option>
                            <option value="HOLD">持有</option>
                            <option value="SELL">卖出</option>
                            <option value="STRONG_SELL">强烈卖出</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadData()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>交易对</th>
                                    <th>时间周期</th>
                                    <th>技术评分</th>
                                    <th>信号</th>
                                    <th>RSI</th>
                                    <th>MACD</th>
                                    <th>EMA</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="signalsTableBody">
                                <tr>
                                    <td colspan="9" class="loading">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 超卖超买信号标签页内容 -->
                <div id="tabContentOversold" class="tab-content">
                    <div class="filters" style="margin-bottom: var(--spacing-lg);">
                        <select id="oversoldOverboughtTimeframe" class="select-input">
                            <option value="1h">1小时</option>
                            <option value="5m">5分钟</option>
                            <option value="15m">15分钟</option>
                            <option value="4h">4小时</option>
                            <option value="1d">1天</option>
                        </select>
                        <select id="oversoldOverboughtType" class="select-input">
                            <option value="all">全部</option>
                            <option value="oversold">超卖</option>
                            <option value="overbought">超买</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadOversoldOverboughtSignals()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>交易对</th>
                                    <th>时间周期</th>
                                    <th>RSI值</th>
                                    <th>状态</th>
                                    <th>技术评分</th>
                                    <th>信号</th>
                                    <th>更新时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="oversoldOverboughtTableBody">
                                <tr>
                                    <td colspan="8" class="loading">加载中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- EMA信号历史 -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="bi bi-lightning"></i>
                    EMA信号历史
                </h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>交易对</th>
                                <th>周期</th>
                                <th>信号类型</th>
                                <th>信号强度</th>
                                <th>价格</th>
                                <th>EMA配置</th>
                                <th>成交量比率</th>
                                <th>价格变动</th>
                            </tr>
                        </thead>
                        <tbody id="emaSignalsTableBody">
                            <tr>
                                <td colspan="9" class="loading">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细分析模态框 -->
    <div id="detailedAnalysisModal" class="modal-overlay" onclick="if(event.target === this) closeDetailedAnalysis()">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="bi bi-graph-up-arrow"></i>
                    <span id="modalSymbolTitle">详细分析</span>
                </h2>
                <button class="modal-close" onclick="closeDetailedAnalysis()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body" id="detailedAnalysisContent">
                <div class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = '';
        let currentTimeframe = '1h';
        
        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的active状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            if (tabName === 'signals') {
                document.getElementById('tabContentSignals').classList.add('active');
                document.getElementById('tabSignals').classList.add('active');
            } else if (tabName === 'oversold') {
                document.getElementById('tabContentOversold').classList.add('active');
                document.getElementById('tabOversold').classList.add('active');
            }
        }

        // 格式化数字
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            return Number(num).toFixed(decimals);
        }

        // 格式化信号
        function formatSignal(signal) {
            const signals = {
                'STRONG_BUY': { text: '强烈买入', class: 'signal-strong-buy' },
                'BUY': { text: '买入', class: 'signal-buy' },
                'HOLD': { text: '持有', class: 'signal-hold' },
                'SELL': { text: '卖出', class: 'signal-sell' },
                'STRONG_SELL': { text: '强烈卖出', class: 'signal-strong-sell' }
            };
            const s = signals[signal] || { text: signal, class: 'signal-hold' };
            return `<span class="${s.class}">${s.text}</span>`;
        }

        // 格式化时间
        function formatTime(timeStr) {
            if (!timeStr) return '-';
            const date = new Date(timeStr);
            return date.toLocaleString('zh-CN');
        }
        
        // 格式化大数字
        function formatLargeNumber(num) {
            if (num === null || num === undefined) return '-';
            if (num >= 1e9) {
                return (num / 1e9).toFixed(2) + 'B';
            } else if (num >= 1e6) {
                return (num / 1e6).toFixed(2) + 'M';
            } else if (num >= 1e3) {
                return (num / 1e3).toFixed(2) + 'K';
            }
            return formatNumber(num, 2);
        }

        // 加载技术指标数据
        async function loadIndicators() {
            try {
                const timeframe = document.getElementById('timeframeFilter').value;
                const symbol = document.getElementById('symbolFilter').value;
                const signalFilter = document.getElementById('signalFilter').value;
                
                let url = `/api/technical-indicators?timeframe=${timeframe}`;
                if (symbol) {
                    url = `/api/technical-indicators?symbol=${symbol}&timeframe=${timeframe}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('signalsTableBody');
                
                if (symbol && data.symbol) {
                    // 单个交易对的详细数据
                    displayIndicatorDetails(data);
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">请选择"所有交易对"查看列表</td></tr>';
                } else if (data.indicators) {
                    // 所有交易对的列表
                    document.getElementById('indicatorsCard').style.display = 'none';
                    let html = '';
                    data.indicators.forEach(indicator => {
                        if (signalFilter && indicator.technical_signal !== signalFilter) return;
                        html += `
                            <tr onclick="loadIndicatorDetails('${indicator.symbol}')" style="cursor: pointer;">
                                <td><strong>${indicator.symbol}</strong></td>
                                <td>${timeframe}</td>
                                <td>${formatNumber(indicator.technical_score)}</td>
                                <td>${formatSignal(indicator.technical_signal)}</td>
                                <td>${formatNumber(indicator.rsi_value)}</td>
                                <td>${indicator.macd_trend || '-'}</td>
                                <td>${indicator.ema_trend || '-'}</td>
                                <td>${formatTime(indicator.updated_at)}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showDetailedAnalysisModal('${indicator.symbol}')">
                                        查看详情
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html || '<tr><td colspan="9" class="empty-state">暂无数据</td></tr>';
                }
            } catch (error) {
                console.error('加载技术指标失败:', error);
                document.getElementById('signalsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="empty-state">加载失败，请稍后重试</td></tr>';
            }
        }

        // 显示技术指标详情
        function displayIndicatorDetails(data) {
            document.getElementById('selectedSymbol').textContent = `${data.symbol} - 技术指标详情`;
            document.getElementById('indicatorsCard').style.display = 'block';
            
            const grid = document.getElementById('indicatorsGrid');
            grid.innerHTML = `
                <div class="indicator-card">
                    <div class="indicator-name">技术评分</div>
                    <div class="indicator-value">${formatNumber(data.technical_score)}</div>
                    <div>${formatSignal(data.technical_signal)}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">RSI</div>
                    <div class="indicator-value">${formatNumber(data.rsi?.value)}</div>
                    <div>${data.rsi?.signal || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">MACD</div>
                    <div class="indicator-value">${formatNumber(data.macd?.value)}</div>
                    <div>${data.macd?.trend || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">布林带位置</div>
                    <div class="indicator-value">${data.bollinger_bands?.position || '-'}</div>
                    <div>宽度: ${formatNumber(data.bollinger_bands?.width)}%</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">EMA趋势</div>
                    <div class="indicator-value">${data.ema?.trend || '-'}</div>
                    <div>短期: ${formatNumber(data.ema?.short)} | 长期: ${formatNumber(data.ema?.long)}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">KDJ</div>
                    <div class="indicator-value">K:${formatNumber(data.kdj?.k)} D:${formatNumber(data.kdj?.d)} J:${formatNumber(data.kdj?.j)}</div>
                    <div>${data.kdj?.signal || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">成交量</div>
                    <div class="indicator-value">${formatNumber(data.volume?.volume_ratio, 2)}x</div>
                    <div>${data.volume?.signal || '-'}</div>
                </div>
                <div class="indicator-card">
                    <div class="indicator-name">更新时间</div>
                    <div class="indicator-value" style="font-size: 14px;">${formatTime(data.updated_at)}</div>
                </div>
            `;
        }

        // 加载单个交易对的指标详情
        async function loadIndicatorDetails(symbol) {
            const timeframe = document.getElementById('timeframeFilter').value;
            document.getElementById('symbolFilter').value = symbol;
            currentSymbol = symbol;
            
            try {
                // 同时获取技术指标和综合交易信号
                // 对symbol进行URL编码，处理斜杠
                const encodedSymbol = encodeURIComponent(symbol);
                const [indicatorsResponse, signalResponse] = await Promise.all([
                    fetch(`/api/technical-indicators?symbol=${encodeURIComponent(symbol)}&timeframe=${timeframe}`),
                    fetch(`/api/signals/${encodedSymbol}?timeframe=${timeframe}`).catch(() => null)
                ]);
                
                const indicatorsData = await indicatorsResponse.json();
                let signalData = null;
                if (signalResponse) {
                    try {
                        signalData = await signalResponse.json();
                    } catch (e) {
                        console.warn('获取综合信号失败:', e);
                    }
                }
                
                displayIndicatorDetails(indicatorsData, signalData);
            } catch (error) {
                console.error('加载指标详情失败:', error);
                alert('加载详情失败: ' + error.message);
            }
        }
        
        // 显示详细分析模态框
        function showDetailedAnalysis(symbol, indicatorsData, signalData, priceData) {
            const modal = document.getElementById('detailedAnalysisModal');
            const modalContent = document.getElementById('detailedAnalysisContent');
            
            // 获取实时价格
            let currentPrice = null;
            let maxPrice = null;
            let minPrice = null;
            let spreadPct = null;
            let totalVolume = null;
            let exchangesCount = null;
            let change24h = null;
            let change24hAbs = null;
            let high24h = null;
            let low24h = null;
            let volume24h = null;
            
            if (priceData && priceData.price) {
                currentPrice = parseFloat(priceData.price);
                maxPrice = priceData.max_price ? parseFloat(priceData.max_price) : null;
                minPrice = priceData.min_price ? parseFloat(priceData.min_price) : null;
                spreadPct = priceData.spread_pct ? parseFloat(priceData.spread_pct) : null;
                totalVolume = priceData.total_volume ? parseFloat(priceData.total_volume) : null;
                exchangesCount = priceData.exchanges || null;
                
                // 从details中获取24小时数据
                if (priceData.details && priceData.details.length > 0) {
                    const firstDetail = priceData.details[0];
                    change24h = firstDetail.change_24h !== undefined ? parseFloat(firstDetail.change_24h) : null;
                    high24h = firstDetail.high_24h !== undefined ? parseFloat(firstDetail.high_24h) : null;
                    low24h = firstDetail.low_24h !== undefined ? parseFloat(firstDetail.low_24h) : null;
                    volume24h = firstDetail.volume_24h !== undefined ? parseFloat(firstDetail.volume_24h) : null;
                }
                
                // 如果没有details，尝试直接从priceData获取
                if (change24h === null && priceData.change_24h !== undefined) {
                    change24h = parseFloat(priceData.change_24h);
                }
                if (high24h === null && priceData.high_24h !== undefined) {
                    high24h = parseFloat(priceData.high_24h);
                }
                if (low24h === null && priceData.low_24h !== undefined) {
                    low24h = parseFloat(priceData.low_24h);
                }
                if (volume24h === null && priceData.volume_24h !== undefined) {
                    volume24h = parseFloat(priceData.volume_24h);
                }
                
                // 计算24小时涨跌绝对值
                if (change24h !== null && currentPrice !== null) {
                    change24hAbs = (currentPrice * change24h / 100);
                }
            } else if (signalData && signalData.price && signalData.price.current) {
                currentPrice = parseFloat(signalData.price.current);
            }
            
            let html = `
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-currency-dollar"></i>
                        实时价格
                    </h3>
                    <div class="realtime-price">
                        <div class="realtime-price-label">
                            <i class="bi bi-circle-fill price-update-indicator"></i>
                            实时价格（每5秒更新）
                        </div>
                        <div class="realtime-price-value" id="realtime-price-value" data-old-price="${currentPrice || 0}">
                            ${currentPrice ? formatNumber(currentPrice) + ' USDT' : '加载中...'}
                        </div>
                        <div class="realtime-price-change" id="realtime-price-change" style="margin-top: var(--spacing-sm);">
                            <span style="color: var(--text-secondary); font-size: 12px;">
                                价格变动: <span id="price-change-text">-</span>
                            </span>
                        </div>
                        <div style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--border-default);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--spacing-md); font-size: 12px;">
                                ${change24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时涨跌</div>
                                    <div style="color: ${change24h >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}; font-weight: 600; font-size: 14px;">
                                        ${change24h >= 0 ? '+' : ''}${formatNumber(change24h)}%
                                    </div>
                                    ${change24hAbs !== null ? `
                                    <div style="color: var(--text-secondary); font-size: 11px; margin-top: 2px;">
                                        ${change24hAbs >= 0 ? '+' : ''}${formatNumber(change24hAbs)} USDT
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                                ${high24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时最高</div>
                                    <div style="color: var(--success-green); font-weight: 600;">${formatNumber(high24h)}</div>
                                </div>
                                ` : ''}
                                ${low24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时最低</div>
                                    <div style="color: var(--danger-red); font-weight: 600;">${formatNumber(low24h)}</div>
                                </div>
                                ` : ''}
                                ${volume24h !== null ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">24小时成交量</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${formatLargeNumber(volume24h)}</div>
                                </div>
                                ` : ''}
                                ${maxPrice && minPrice ? `
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">跨交易所价差</div>
                                    <div style="color: var(--text-primary); font-weight: 600;">${spreadPct ? formatNumber(spreadPct, 3) + '%' : '-'}</div>
                                </div>
                                ` : ''}
                            </div>
                            ${exchangesCount ? `
                                <div style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: 11px;">
                                    数据来源: ${exchangesCount} 个交易所
                                    ${totalVolume ? ` | 总成交量: ${formatLargeNumber(totalVolume)}` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-graph-up"></i>
                        综合评分
                    </h3>
                    <div class="score-grid">
            `;
            
            if (signalData && signalData.score) {
                html += `
                    <div class="score-item">
                        <div class="score-label">综合评分</div>
                        <div class="score-value" style="color: ${signalData.score.total >= 0 ? 'var(--success-green)' : 'var(--danger-red)'}">
                            ${signalData.score.total >= 0 ? '+' : ''}${formatNumber(signalData.score.total)}
                        </div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">技术指标评分</div>
                        <div class="score-value">${formatNumber(signalData.score.technical)}</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">新闻情绪评分</div>
                        <div class="score-value">${formatNumber(signalData.score.news)}</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">置信度</div>
                        <div class="score-value" style="color: ${signalData.confidence >= 70 ? 'var(--success-green)' : signalData.confidence >= 50 ? 'var(--warning-yellow)' : 'var(--text-secondary)'}">
                            ${formatNumber(signalData.confidence)}%
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div class="score-item">
                        <div class="score-label">技术评分</div>
                        <div class="score-value">${formatNumber(indicatorsData.technical_score)}</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">信号</div>
                        <div class="score-value">${formatSignal(indicatorsData.technical_signal)}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-currency-dollar"></i>
                        价格建议
                    </h3>
                    <div class="price-info">
            `;
            
            if (signalData && signalData.price) {
                // 使用实时价格或信号中的价格
                const displayPrice = currentPrice || signalData.price.current;
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">${formatNumber(displayPrice)} USDT</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">建议入场价</div>
                        <div class="price-value" style="color: var(--primary-blue)">${formatNumber(signalData.price.entry)} USDT</div>
                    </div>
                    <div class="price-item">
                        <div class="price-label">止损价</div>
                        <div class="price-value" style="color: var(--danger-red)">${formatNumber(signalData.price.stop_loss)} USDT</div>
                        ${displayPrice && signalData.price.stop_loss ? `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                距离: ${formatNumber(Math.abs((displayPrice - signalData.price.stop_loss) / displayPrice * 100))}%
                            </div>
                        ` : ''}
                    </div>
                    <div class="price-item">
                        <div class="price-label">止盈价</div>
                        <div class="price-value" style="color: var(--success-green)">${formatNumber(signalData.price.take_profit)} USDT</div>
                        ${displayPrice && signalData.price.take_profit ? `
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                                距离: ${formatNumber(Math.abs((signalData.price.take_profit - displayPrice) / displayPrice * 100))}%
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (currentPrice) {
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">${formatNumber(currentPrice)} USDT</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="price-item">
                        <div class="price-label">当前价格</div>
                        <div class="price-value">-</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3 class="section-title">
                        <i class="bi bi-bar-chart"></i>
                        技术指标详细分析
                    </h3>
                    <div class="indicator-detail">
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">RSI (相对强弱指标)</div>
                            <div class="indicator-detail-value">${formatNumber(indicatorsData.rsi?.value)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.rsi?.signal === 'oversold' ? '超卖，可能反弹' : 
                                  indicatorsData.rsi?.signal === 'overbought' ? '超买，可能回调' : 
                                  '中性区域'}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">MACD</div>
                            <div class="indicator-detail-value">${indicatorsData.macd?.trend || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.macd?.trend === 'bullish_cross' ? '金叉，看涨信号' : 
                                  indicatorsData.macd?.trend === 'bearish_cross' ? '死叉，看跌信号' : 
                                  '中性'}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">布林带位置</div>
                            <div class="indicator-detail-value">${indicatorsData.bollinger_bands?.position || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                上轨: ${formatNumber(indicatorsData.bollinger_bands?.upper)} | 
                                下轨: ${formatNumber(indicatorsData.bollinger_bands?.lower)}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">EMA趋势</div>
                            <div class="indicator-detail-value">${indicatorsData.ema?.trend || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                短期: ${formatNumber(indicatorsData.ema?.short)} | 
                                长期: ${formatNumber(indicatorsData.ema?.long)}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">KDJ指标</div>
                            <div class="indicator-detail-value">
                                K:${formatNumber(indicatorsData.kdj?.k)} 
                                D:${formatNumber(indicatorsData.kdj?.d)} 
                                J:${formatNumber(indicatorsData.kdj?.j)}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.kdj?.signal || '-'}
                            </div>
                        </div>
                        <div class="indicator-detail-item">
                            <div class="indicator-detail-label">成交量</div>
                            <div class="indicator-detail-value">${formatNumber(indicatorsData.volume?.volume_ratio, 2)}x</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${indicatorsData.volume?.signal === 'high' ? '成交量放大' : '正常'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (signalData && signalData.reasons && signalData.reasons.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-lightbulb"></i>
                            推荐理由
                        </h3>
                        <ul class="reasons-list">
                `;
                signalData.reasons.forEach(reason => {
                    html += `<li>${reason}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            if (signalData && signalData.risks && signalData.risks.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-exclamation-triangle"></i>
                            风险提示
                        </h3>
                        <ul class="risks-list">
                `;
                signalData.risks.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
                html += `
                        </ul>
                    </div>
                `;
            }
            
            if (signalData && signalData.action) {
                html += `
                    <div class="analysis-section">
                        <h3 class="section-title">
                            <i class="bi bi-arrow-right-circle"></i>
                            操作建议
                        </h3>
                        <div style="background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); padding: var(--spacing-lg);">
                            <div style="font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-md);">
                                ${formatSignal(signalData.action)}
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                                置信度: ${formatNumber(signalData.confidence)}%
                            </div>
                            ${signalData.position ? `
                                <div style="color: var(--text-secondary); font-size: 13px;">
                                    <div>建议仓位: ${formatNumber(signalData.position.recommended_size * 100)}%</div>
                                    <div>最大亏损: ${formatNumber(signalData.position.max_loss_pct)}%</div>
                                    <div>目标收益: ${formatNumber(signalData.position.max_profit_pct)}%</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            modalContent.innerHTML = html;
            modal.classList.add('active');
        }
        

        // 加载EMA信号
        async function loadEmaSignals() {
            try {
                const symbol = document.getElementById('symbolFilter').value;
                let url = '/api/ema-signals?limit=50';
                if (symbol) {
                    url += `&symbol=${symbol}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                const tbody = document.getElementById('emaSignalsTableBody');
                
                if (data.signals && data.signals.length > 0) {
                    let html = '';
                    data.signals.forEach(signal => {
                        const signalClass = signal.signal_type === 'BUY' ? 'badge-success' : 'badge-danger';
                        html += `
                            <tr>
                                <td>${formatTime(signal.timestamp)}</td>
                                <td><strong>${signal.symbol}</strong></td>
                                <td>${signal.timeframe}</td>
                                <td><span class="badge ${signalClass}">${signal.signal_type}</span></td>
                                <td><span class="badge badge-info">${signal.signal_strength}</span></td>
                                <td>${formatNumber(signal.price)}</td>
                                <td>${signal.ema_config}</td>
                                <td>${formatNumber(signal.volume_ratio, 2)}x</td>
                                <td class="${signal.price_change_pct >= 0 ? 'signal-buy' : 'signal-sell'}">
                                    ${signal.price_change_pct >= 0 ? '+' : ''}${formatNumber(signal.price_change_pct)}%
                                </td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" class="empty-state">暂无EMA信号</td></tr>';
                }
            } catch (error) {
                console.error('加载EMA信号失败:', error);
                document.getElementById('emaSignalsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="empty-state">加载失败，请稍后重试</td></tr>';
            }
        }

        // 加载超卖超买信号
        async function loadOversoldOverboughtSignals() {
            try {
                const timeframe = document.getElementById('oversoldOverboughtTimeframe').value;
                const type = document.getElementById('oversoldOverboughtType').value;
                
                const response = await fetch(`/api/technical-indicators?timeframe=${timeframe}`);
                const data = await response.json();
                
                const tbody = document.getElementById('oversoldOverboughtTableBody');
                
                if (data.indicators && data.indicators.length > 0) {
                    // 筛选超卖超买信号
                    let filtered = data.indicators.filter(indicator => {
                        const rsi = indicator.rsi?.value;
                        if (!rsi) return false;
                        
                        if (type === 'oversold') {
                            return rsi < 30; // RSI < 30 为超卖
                        } else if (type === 'overbought') {
                            return rsi > 70; // RSI > 70 为超买
                        } else {
                            return rsi < 30 || rsi > 70; // 全部：超卖或超买
                        }
                    });
                    
                    // 按RSI值排序（超卖从小到大，超买从大到小）
                    filtered.sort((a, b) => {
                        const rsiA = a.rsi?.value || 50;
                        const rsiB = b.rsi?.value || 50;
                        if (type === 'oversold') {
                            return rsiA - rsiB; // 超卖：从小到大
                        } else if (type === 'overbought') {
                            return rsiB - rsiA; // 超买：从大到小
                        } else {
                            // 全部：超卖在前（从小到大），超买在后（从大到小）
                            if (rsiA < 30 && rsiB < 30) return rsiA - rsiB;
                            if (rsiA > 70 && rsiB > 70) return rsiB - rsiA;
                            if (rsiA < 30) return -1;
                            if (rsiB < 30) return 1;
                            return rsiB - rsiA;
                        }
                    });
                    
                    if (filtered.length > 0) {
                        let html = '';
                        filtered.forEach(indicator => {
                            const rsi = indicator.rsi?.value;
                            const isOversold = rsi < 30;
                            const isOverbought = rsi > 70;
                            const statusClass = isOversold ? 'badge-success' : 'badge-danger';
                            const statusText = isOversold ? '超卖' : '超买';
                            
                            html += `
                                <tr>
                                    <td><strong>${indicator.symbol}</strong></td>
                                    <td>${indicator.timeframe}</td>
                                    <td class="${isOversold ? 'signal-buy' : 'signal-sell'}" style="font-weight: 600;">
                                        ${formatNumber(rsi, 2)}
                                    </td>
                                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                                    <td>${formatNumber(indicator.technical_score)}</td>
                                    <td>${formatSignal(indicator.technical_signal)}</td>
                                    <td>${formatTime(indicator.updated_at)}</td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); showDetailedAnalysisModal('${indicator.symbol}')">
                                            查看详情
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        tbody.innerHTML = html;
                    } else {
                        tbody.innerHTML = `<tr><td colspan="8" class="empty-state">暂无${type === 'oversold' ? '超卖' : type === 'overbought' ? '超买' : '超卖/超买'}信号</td></tr>`;
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无数据</td></tr>';
                }
            } catch (error) {
                console.error('加载超卖超买信号失败:', error);
                document.getElementById('oversoldOverboughtTableBody').innerHTML = 
                    '<tr><td colspan="8" class="empty-state">加载失败，请稍后重试</td></tr>';
            }
        }

        // 加载所有数据
        async function loadData() {
            await Promise.all([
                loadIndicators(),
                loadEmaSignals()
            ]);
        }

        // 初始化
        async function init() {
            // 加载交易对列表
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                const symbolSelect = document.getElementById('symbolFilter');
                config.symbols.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    symbolSelect.appendChild(option);
                });
            } catch (error) {
                console.error('加载配置失败:', error);
            }
            
            // 加载数据
            await Promise.all([
                loadData(),
                loadOversoldOverboughtSignals()
            ]);
            
            // 设置自动刷新
            setInterval(loadData, 60000); // 每60秒刷新一次
            setInterval(loadOversoldOverboughtSignals, 60000); // 每60秒刷新超卖超买信号
            
            // 添加筛选器变化监听
            document.getElementById('oversoldOverboughtTimeframe').addEventListener('change', loadOversoldOverboughtSignals);
            document.getElementById('oversoldOverboughtType').addEventListener('change', loadOversoldOverboughtSignals);
        }

        // 带超时的fetch请求
        async function fetchWithTimeout(url, timeout = 5000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('请求超时');
                }
                throw error;
            }
        }

        // 显示详细分析模态框
        async function showDetailedAnalysisModal(symbol) {
            const modal = document.getElementById('detailedAnalysisModal');
            const modalTitle = document.getElementById('modalSymbolTitle');
            const modalContent = document.getElementById('detailedAnalysisContent');
            const timeframe = document.getElementById('timeframeFilter').value;
            
            modalTitle.textContent = `${symbol} - 详细分析`;
            modalContent.innerHTML = '<div class="loading">加载中...</div>';
            modal.classList.add('active');
            
            try {
                // 对symbol进行URL编码，处理斜杠
                const encodedSymbol = encodeURIComponent(symbol);
                
                // 第一步：快速加载技术指标（从缓存读取，很快）
                let indicatorsData = null;
                try {
                    const indicatorsResponse = await fetchWithTimeout(
                        `/api/technical-indicators?symbol=${encodeURIComponent(symbol)}&timeframe=${timeframe}`,
                        3000
                    );
                    if (indicatorsResponse.ok) {
                        indicatorsData = await indicatorsResponse.json();
                        // 先显示技术指标数据，让用户看到内容
                        showDetailedAnalysis(symbol, indicatorsData, null, null);
                    }
                } catch (e) {
                    console.warn('获取技术指标失败:', e);
                    modalContent.innerHTML = `<div class="empty-state">加载技术指标失败: ${e.message}</div>`;
                    return;
                }
                
                // 第二步：异步加载信号和价格数据（这些可能较慢，但不阻塞显示）
                let signalData = null;
                let priceData = null;
                
                // 并行加载信号和价格，设置合理的超时时间
                // 使用 Promise.allSettled 确保即使某个请求失败也不影响其他请求
                const loadPromises = [
                    fetchWithTimeout(`/api/signals/${encodedSymbol}?timeframe=${timeframe}`, 15000)
                        .then(res => {
                            if (res.ok) {
                                return res.json();
                            }
                            return null;
                        })
                        .then(data => {
                            if (data) {
                                signalData = data;
                            }
                        })
                        .catch(e => {
                            console.warn('获取综合信号失败（已超时或出错）:', e.message);
                            // 不抛出错误，继续执行
                        }),
                    
                    fetchWithTimeout(`/api/price/${encodedSymbol}`, 8000)
                        .then(res => {
                            if (res.ok) {
                                return res.json();
                            }
                            return null;
                        })
                        .then(data => {
                            if (data) {
                                priceData = data;
                            }
                        })
                        .catch(e => {
                            console.warn('获取实时价格失败（已超时或出错）:', e.message);
                            // 不抛出错误，继续执行
                        })
                ];
                
                // 使用 allSettled 等待所有请求完成（无论成功或失败）
                await Promise.allSettled(loadPromises);
                
                // 更新显示，包含所有已加载的数据（即使某些数据缺失）
                showDetailedAnalysis(symbol, indicatorsData, signalData, priceData);
                
                // 启动实时价格更新（每5秒更新一次）
                if (window.priceUpdateInterval) {
                    clearInterval(window.priceUpdateInterval);
                }
                window.priceUpdateInterval = setInterval(async () => {
                    try {
                        const encodedSymbol = encodeURIComponent(symbol);
                        const priceRes = await fetchWithTimeout(`/api/price/${encodedSymbol}`, 3000);
                        if (priceRes && priceRes.ok) {
                            const newPriceData = await priceRes.json();
                            updateRealTimePrice(newPriceData);
                        }
                    } catch (e) {
                        console.warn('更新实时价格失败:', e);
                    }
                }, 5000);
            } catch (error) {
                console.error('加载详情失败:', error);
                modalContent.innerHTML = `<div class="empty-state">加载失败: ${error.message}</div>`;
            }
        }
        
        // 更新实时价格
        function updateRealTimePrice(priceData) {
            const priceElement = document.getElementById('realtime-price-value');
            const changeElement = document.getElementById('realtime-price-change');
            if (priceElement && priceData && priceData.price) {
                const currentPrice = parseFloat(priceData.price);
                const oldPrice = parseFloat(priceElement.dataset.oldPrice || currentPrice);
                const change = currentPrice - oldPrice;
                const changePct = oldPrice > 0 ? (change / oldPrice * 100) : 0;
                
                priceElement.textContent = formatNumber(currentPrice) + ' USDT';
                priceElement.dataset.oldPrice = currentPrice;
                
                if (changeElement) {
                    const changeClass = change >= 0 ? 'signal-buy' : 'signal-sell';
                    changeElement.innerHTML = `
                        <span class="${changeClass}">
                            ${change >= 0 ? '+' : ''}${formatNumber(change)} 
                            (${change >= 0 ? '+' : ''}${formatNumber(changePct)}%)
                        </span>
                    `;
                }
                
                // 添加闪烁效果提示价格更新
                priceElement.style.animation = 'none';
                setTimeout(() => {
                    priceElement.style.animation = 'priceUpdate 0.5s ease-out';
                }, 10);
            }
        }
        
        // 关闭模态框时清除价格更新定时器
        function closeDetailedAnalysis() {
            const modal = document.getElementById('detailedAnalysisModal');
            modal.classList.remove('active');
            if (window.priceUpdateInterval) {
                clearInterval(window.priceUpdateInterval);
                window.priceUpdateInterval = null;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

