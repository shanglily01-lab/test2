<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模拟现货交易 - AlphaFlow</title>
    <style>
        /* AlphaFlow - Multi-Dimensional Crypto Intelligence Platform */
        :root {
            --primary-blue: #2B6FED; --primary-blue-hover: #1E5DD6; --primary-blue-light: #EBF3FF; --primary-blue-dark: #1A4BA8;
            --secondary-purple: #7C3AED; --secondary-orange: #F97316;
            --success-green: #10B981; --success-green-bg: #D1FAE5; --danger-red: #EF4444; --danger-red-bg: #FEE2E2;
            --warning-yellow: #F59E0B; --warning-yellow-bg: #FEF3C7; --info-blue: #3B82F6;
            --bg-primary: #0D1117; --bg-secondary: #161B22; --bg-tertiary: #21262D; --bg-card: #1C2128; --bg-hover: #2A3038;
            --text-primary: #E6EDF3; --text-secondary: #8B949E; --text-tertiary: #6E7681; --text-disabled: #484F58;
            --border-default: #30363D; --border-muted: #21262D; --border-subtle: #1C2128;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15); --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.25); --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-full: 9999px;
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 12px; --spacing-lg: 16px; --spacing-xl: 24px; --spacing-2xl: 32px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1); --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); line-height: 1.6; font-size: 14px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1600px; margin: 0 auto; padding: var(--spacing-xl); }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-default); padding: var(--spacing-lg) var(--spacing-xl); margin-bottom: var(--spacing-xl); border-radius: var(--radius-lg); }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-sm); display: flex; align-items: center; gap: var(--spacing-md); }
        .header-subtitle { color: var(--text-secondary); font-size: 13px; }
        .header-actions { display: flex; gap: var(--spacing-md); align-items: center; flex-wrap: wrap; }
        .nav-container { background: rgba(44, 68, 100, 0.85); border-radius: var(--radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--border-default); }
        .nav-links { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; font-size: 16px; }
        .nav-link { padding: 0.75rem 1.5rem; background: transparent; color: var(--text-secondary); text-decoration: none; border-radius: var(--radius-md); transition: all var(--transition-base); font-weight: 600; font-size: 16px; border: 1px solid transparent; }
        .nav-link:hover { background: var(--bg-hover); color: var(--text-primary); border-color: var(--border-default); }
        .nav-link.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        /* Signal Dropdown Styles */
        .signal-dropdown { position: relative; }
        .signal-btn { position: relative; }
        .signal-badge { position: absolute; top: -4px; right: -4px; background: var(--danger-red); color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: 700; min-width: 18px; text-align: center; line-height: 1.4; box-shadow: 0 2px 4px rgba(239, 68, 68, 0.4); animation: pulse-badge 2s ease-in-out infinite; }
        @keyframes pulse-badge { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .signal-dropdown-menu { position: absolute; top: calc(100% + 8px); background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); min-width: 320px; max-width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000; display: none; padding: var(--spacing-md); }
        .signal-dropdown-menu::-webkit-scrollbar { width: 6px; }
        .signal-dropdown-menu::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .signal-dropdown-menu::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
        .signal-dropdown-menu::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        .signal-dropdown-menu.show { display: block; animation: slideDown var(--transition-base) ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .signal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: var(--spacing-md); margin-bottom: var(--spacing-md); border-bottom: 1px solid var(--border-default); }
        .signal-header h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0; display: flex; align-items: center; gap: var(--spacing-sm); }
        .signal-table-container { overflow-x: auto; }
        .signal-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .signal-table thead { background: var(--bg-tertiary); }
        .signal-table th { padding: var(--spacing-sm) var(--spacing-md); text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--border-default); white-space: nowrap; }
        .signal-table th:first-child { width: 60px; }
        .signal-table td { padding: var(--spacing-sm) var(--spacing-md); border-bottom: 1px solid var(--border-default); color: var(--text-primary); }
        .signal-table tbody tr { cursor: pointer; transition: all var(--transition-fast); }
        .signal-table tbody tr:hover { background: var(--bg-hover); }
        .signal-table tbody tr:last-child td { border-bottom: none; }
        .signal-symbol { font-weight: 700; font-size: 13px; color: var(--text-primary); }
        .signal-strength-badge { font-size: 10px; padding: 2px 6px; }
        .signal-price { font-family: var(--font-mono); color: var(--success-green); font-weight: 600; }
        .signal-time { font-size: 11px; color: var(--text-secondary); }
        .signal-empty { text-align: center; padding: var(--spacing-xl); color: var(--text-secondary); font-size: 13px; }
        .signal-loading { text-align: center; padding: var(--spacing-xl); color: var(--text-secondary); font-size: 13px; }
        .badge-warning { background: var(--warning-yellow-bg); color: var(--warning-yellow); }
        .card { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); transition: all var(--transition-base); display: flex; flex-direction: column; }
        .card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .card-header { padding-bottom: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-bottom: 1px solid var(--border-default); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm); user-select: none; }
        .card-title:hover { background: var(--bg-hover) !important; }
        .card-body { padding: 0; flex: 1; min-height: 0; }
        .card-body::-webkit-scrollbar { width: 6px; }
        .card-body::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        .card-body::-webkit-scrollbar-thumb { background: var(--border-default); border-radius: 3px; }
        .card-body::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-xl); }
        .stat-card { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-default); border-radius: var(--radius-lg); padding: var(--spacing-xl); text-align: center; transition: all var(--transition-base); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, var(--primary-blue), var(--secondary-purple)); opacity: 0; transition: opacity var(--transition-base); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); border-color: var(--primary-blue); }
        .stat-card:hover::before { opacity: 1; }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm); font-weight: 600; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: var(--spacing-xs); font-family: var(--font-mono); }
        .stat-change { font-size: 13px; color: var(--text-secondary); }
        .stat-change.positive { color: var(--success-green); }
        .stat-change.negative { color: var(--danger-red); }
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border-default); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        thead { background: var(--bg-tertiary); border-bottom: 2px solid var(--border-default); }
        th { padding: var(--spacing-md) var(--spacing-lg); text-align: left; font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: var(--spacing-lg); border-bottom: 1px solid var(--border-default); color: var(--text-primary); font-size: 13px; }
        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color var(--transition-fast); }
        tbody tr:hover { background: var(--bg-hover); }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--spacing-sm); padding: var(--spacing-md) var(--spacing-xl); font-size: 14px; font-weight: 500; line-height: 1; text-decoration: none; border: 1px solid transparent; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-base); white-space: nowrap; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: var(--spacing-xs) var(--spacing-md); font-size: 12px; }
        .btn-primary { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
        .btn-primary:hover:not(:disabled) { background: var(--primary-blue-hover); border-color: var(--primary-blue-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-success { background: var(--success-green); color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-danger { background: var(--danger-red); color: white; }
        .btn-danger:hover:not(:disabled) { background: #DC2626; transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-default); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-hover); border-color: var(--border-muted); }
        .btn-ghost { background: transparent; color: var(--text-secondary); border-color: transparent; }
        .btn-ghost:hover:not(:disabled) { background: var(--bg-hover); color: var(--text-primary); }
        .btn-sm { padding: var(--spacing-sm) var(--spacing-md); font-size: 12px; }
        .badge { display: inline-flex; align-items: center; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; letter-spacing: 0.3px; text-transform: uppercase; }
        .badge-success { background: var(--success-green-bg); color: var(--success-green); }
        .badge-danger { background: var(--danger-red-bg); color: var(--danger-red); }
        .badge-info { background: var(--primary-blue-light); color: var(--primary-blue); }
        .badge-neutral { background: var(--bg-tertiary); color: var(--text-secondary); }
        .price { font-family: var(--font-mono); font-weight: 600; font-size: 16px; }
        .position-card { background: var(--bg-card); border: 1px solid var(--border-default); border-left-width: 4px; border-radius: var(--radius-md); padding: calc(var(--spacing-lg) * 0.7); margin-bottom: calc(var(--spacing-md) * 0.7); transition: all var(--transition-base); }
        .position-card:hover { border-color: var(--border-muted); box-shadow: var(--shadow-md); }
        .position-card.long { border-left-color: var(--success-green); }
        .position-card.pending-buy { border-left-color: var(--primary-blue); background: linear-gradient(135deg, var(--bg-card) 0%, rgba(43, 111, 237, 0.05) 100%); }
        .position-card.pending-sell { border-left-color: var(--warning-yellow); background: linear-gradient(135deg, var(--bg-card) 0%, rgba(245, 158, 11, 0.05) 100%); }
        .pending-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; background: var(--bg-tertiary); border-radius: var(--radius-full); font-size: 11px; font-weight: 600; margin-left: 8px; }
        .pending-badge.pending-buy { color: var(--primary-blue); background: rgba(43, 111, 237, 0.1); }
        .pending-badge.pending-sell { color: var(--warning-yellow); background: rgba(245, 158, 11, 0.1); }
        .pnl-positive { color: var(--success-green); }
        .pnl-negative { color: var(--danger-red); }
        .status-indicator { display: inline-flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-full); font-size: 12px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .status-dot.online { background: var(--success-green); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .empty-state { text-align: center; padding: var(--spacing-2xl); color: var(--text-secondary); }
        .empty-state-icon { font-size: 48px; margin-bottom: var(--spacing-lg); opacity: 0.5; }
        .empty-state-text { font-size: 15px; margin-bottom: var(--spacing-sm); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); }
        .text-success { color: var(--success-green); } .text-danger { color: var(--danger-red); }
        .d-flex { display: flex; } .align-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-sm { gap: var(--spacing-sm); } .gap-md { gap: var(--spacing-md); }
        .mb-sm { margin-bottom: var(--spacing-sm); } .mb-lg { margin-bottom: var(--spacing-lg); } .mb-xs { margin-bottom: var(--spacing-xs); }
        .font-mono { font-family: var(--font-mono); }
        .text-xs { font-size: 11px; } .text-sm { font-size: 13px; } .text-lg { font-size: 18px; } .text-2xl { font-size: 24px; }
        .w-full { width: 100%; }
        /* Form Styles */
        .form-group { margin-bottom: var(--spacing-lg); }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: var(--spacing-sm); }
        .form-control { width: 100%; padding: var(--spacing-md); background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: var(--font-family); transition: all var(--transition-base); }
        .form-control:focus { outline: none; border-color: var(--primary-blue); background: var(--bg-card); box-shadow: 0 0 0 3px rgba(43, 111, 237, 0.1); }
        .form-control:disabled, .form-control[readonly] { opacity: 0.6; cursor: not-allowed; background: var(--bg-secondary); }
        select.form-control { cursor: pointer; }
        input[type="number"].form-control { font-family: var(--font-mono); }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary-blue); }
        .fade-in { animation: fadeIn var(--transition-base) ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp var(--transition-slow) ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpModal { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        @media (max-width: 768px) {
            .container { padding: var(--spacing-md); }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md); }
            .stat-value { font-size: 20px; }
            th, td { padding: var(--spacing-sm); }
            .main-content { grid-template-columns: 1fr !important; }
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-dialog {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-tertiary) 100%);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            padding: 0;
            min-width: 400px;
            max-width: 500px;
            box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 0, 0, 0.4);
            animation: slideUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }
        .modal-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-default);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%);
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        .modal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            border: 2px solid rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .modal-body {
            padding: var(--spacing-xl);
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 14px;
        }
        .modal-footer {
            padding: var(--spacing-lg) var(--spacing-xl);
            border-top: 1px solid var(--border-default);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
            background: var(--bg-secondary);
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="d-flex justify-between align-center">
                <div>
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <img src="/static/images/logo/alphaflow-logo-icon.svg" alt="AlphaFlow" style="height: 36px; width: auto;">
                        <div>
                            <h1 class="header-title" style="margin: 0;">
                                <i class="bi bi-journals"></i>
                                模拟现货交易
                            </h1>
                            <p class="header-subtitle">无风险练习现货交易策略</p>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-md">
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-container slide-up">
            <div class="nav-links">
                <a href="/" class="nav-link">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/dashboard" class="nav-link">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
                <a href="/technical-signals" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> 技术信号
                </a>
                <a href="/paper_trading" class="nav-link active">
                    <i class="bi bi-journals"></i> 现货交易
                </a>
                <a href="/futures_trading" class="nav-link">
                    <i class="bi bi-graph-up-arrow"></i> U本位合约
                </a>
                <a href="/coin_futures_trading" class="nav-link">
                    <i class="bi bi-currency-bitcoin"></i> 币本位合约
                </a>
                <a href="/live_trading" class="nav-link">
                    <i class="bi bi-currency-exchange"></i> 实盘合约
                </a>
                <a href="#" class="nav-link" style="opacity: 0.5; cursor: not-allowed;" onclick="event.preventDefault(); showToast('实盘现货功能开发中...', 'info')">
                    <i class="bi bi-cart-check"></i> 实盘现货
                </a>
                <a href="/futures_review" class="nav-link">
                    <i class="bi bi-journal-check"></i> 复盘(24H)
                </a>
<a href="/etf_data" class="nav-link">
                    <i class="bi bi-pie-chart"></i> ETF 数据
                </a>
                <a href="/corporate_treasury" class="nav-link">
                    <i class="bi bi-building"></i> 企业金库
                </a>
                <a href="/blockchain_gas" class="nav-link">
                    <i class="bi bi-lightning-charge"></i> Gas统计
                </a>
                <a href="/data_management" class="nav-link">
                    <i class="bi bi-database"></i> 数据管理
                </a>
            </div>
        </nav>

        <!-- Account Stats -->
        <div class="stats-grid" style="grid-template-columns: repeat(5, minmax(250px, 1fr));">
            <!-- 交易信号卡片 -->
            <div class="signal-dropdown" style="position: relative;">
                <div class="stat-card" style="cursor: pointer;" onclick="toggleSignalDropdown(event)">
                    <div class="stat-label">
                        <i class="bi bi-lightning-charge-fill" style="color: var(--success-green); margin-right: 4px;"></i>
                        交易信号
                        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); loadEMASignals();" style="float: right; padding: 2px 6px; min-width: auto;">
                            <i class="bi bi-arrow-clockwise" style="font-size: 11px;"></i>
                        </button>
                    </div>
                    <div class="stat-value" id="signal-count-display">0</div>
                    <div class="stat-change" id="signal-count-text">
                        <span id="buy-count" style="color: var(--success-green);">买入: 0</span> | 
                        <span id="sell-count" style="color: var(--danger-red);">卖出: 0</span>
                    </div>
                    <span class="signal-badge" id="nav-signal-count" style="display: none;">0</span>
                </div>
                <div class="signal-dropdown-menu" id="signal-dropdown-menu" style="left: 0; right: auto; min-width: 600px; max-width: 800px;">
                    <div class="signal-header">
                        <h3><i class="bi bi-lightning-charge-fill" style="color: var(--success-green);"></i> 4小时内EMA信号</h3>
                        <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                            <button class="btn btn-sm" id="filter-buy-btn" onclick="filterSignals('BUY')" style="padding: 4px 12px; background: var(--success-green); color: white; border: none;">
                                买入
                            </button>
                            <button class="btn btn-sm btn-ghost" id="filter-sell-btn" onclick="filterSignals('SELL')" style="padding: 4px 12px;">
                                卖出
                            </button>
                            <button class="btn btn-sm btn-ghost" id="filter-all-btn" onclick="filterSignals('ALL')" style="padding: 4px 12px;">
                                全部
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="loadEMASignals()" style="padding: 4px 8px;">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    <div class="signal-table-container">
                        <div id="nav-signal-list" class="signal-loading">加载中...</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">总权益 (USDT)</div>
                <div class="stat-value" id="total-equity">0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">可用余额 (USDT)</div>
                <div class="stat-value" id="current-balance">0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">总盈亏 (USDT)</div>
                <div class="stat-value pnl" id="total-pnl">0.00</div>
                <div class="stat-change" id="total-pnl-pct">(0.00%)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">胜率</div>
                <div class="stat-value" id="win-rate">0.00%</div>
                <div class="stat-change">
                    <span id="winning-trades">0</span> 赢 / <span id="losing-trades">0</span> 亏
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" style="display: grid; grid-template-columns: 608px 1fr; gap: 24px; height: calc(100vh - 380px);">
            <!-- Trading Panel -->
            <div style="display: flex; flex-direction: column; height: 100%;">
                <div class="card" id="tradingPanelCard" style="display: flex; flex-direction: column; height: 100%;">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="bi bi-currency-exchange"></i>
                            交易面板
                        </h2>
                    </div>
                    <div class="card-body" style="overflow-y: auto;">
                        <form id="trade-form">
                            <div class="form-group">
                                <label class="form-label">交易对</label>
                                <select class="form-control" id="symbol" required>
                                    <option value="">加载中...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <div class="d-flex justify-between align-center" style="margin-bottom: var(--spacing-sm);">
                                    <label class="form-label" style="margin-bottom: 0;">当前价格</label>
                                    <button type="button" class="btn btn-sm btn-ghost" onclick="refreshPrice(true)" style="padding: 4px 8px; min-width: auto;">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <input type="text" class="form-control" id="current-price" readonly>
                                <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                    点击刷新获取最新价格
                                </small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">订单类型</label>
                                <div class="d-flex gap-sm" style="margin-bottom: var(--spacing-sm);">
                                    <button type="button" class="btn btn-primary w-full" id="btnMarket" onclick="selectOrderType('MARKET')">
                                        <i class="bi bi-lightning-charge"></i> 市价单
                                    </button>
                                    <button type="button" class="btn btn-ghost w-full" id="btnLimit" onclick="selectOrderType('LIMIT')">
                                        <i class="bi bi-clock"></i> 限价单
                                    </button>
                                </div>
                            </div>
                            <div class="form-group" id="limitPriceGroup" style="display: none;">
                                <label class="form-label">限价</label>
                                <input type="number" class="form-control" id="limitPrice" step="0.00000001" placeholder="请输入限价">
                                <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                    限价单将在价格达到设定价格时自动成交
                                </small>
                            </div>
                            <div class="form-group" id="stopLossTakeProfitGroup" style="display: none;">
                                <label class="form-label">止盈止损（可选）</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                                    <div>
                                        <input type="number" class="form-control" id="pendingStopLoss" step="0.00000001" placeholder="止损价格">
                                        <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">止损</small>
                                    </div>
                                    <div>
                                        <input type="number" class="form-control" id="pendingTakeProfit" step="0.00000001" placeholder="止盈价格">
                                        <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">止盈</small>
                                    </div>
                                </div>
                                <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                    订单成交后自动设置持仓的止盈止损价格
                                </small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">数量</label>
                                <input type="number" class="form-control" id="quantity" step="0.00000001" required>
                                <small class="text-secondary text-xs" style="display: block; margin-top: 4px;">
                                    预计金额: <span id="estimated-amount" class="font-mono">0.00</span> USDT
                                </small>
                            </div>
                            <div style="margin-top: var(--spacing-lg);">
                                <button type="button" class="btn btn-success" style="width: 100%;" onclick="placeTrade('BUY')">
                                    <i class="bi bi-arrow-up-circle"></i> 买入
                                </button>
                            </div>
                        </form>
                        <div id="trade-result" style="margin-top: 16px;"></div>
                    </div>
                </div>

            </div>

            <!-- Positions & Trades -->
            <div style="display: flex; flex-direction: column; height: 100%;">
                <!-- Combined Card with Tab Headers -->
                <div class="card" id="positionsPanelCard" style="display: flex; flex-direction: column; height: 100%;">
                    <div class="card-header">
                        <div style="display: flex; gap: var(--spacing-md); align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" id="tabPositionsTitle" onclick="showTab('positions')" style="font-size: 14px; font-weight: 600; padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-md); box-shadow: var(--shadow-md);">
                                <i class="bi bi-briefcase"></i> 当前持仓
                            </button>
                            <button class="btn btn-secondary" id="tabHistoryTitle" onclick="showTab('history')" style="font-size: 14px; font-weight: 600; padding: var(--spacing-md) var(--spacing-xl); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); opacity: 0.7;">
                                <i class="bi bi-clock-history"></i> 历史交易
                            </button>
                        </div>
                    </div>
                    <div class="card-body" id="positionsCardBody" style="overflow-y: auto; overflow-x: hidden; padding: var(--spacing-md); flex: 1;">
                        <!-- Positions Content (模拟持仓) -->
                        <div id="positionsTab">
                        <div id="positions-list">
                            <div class="empty-state">
                                <div class="empty-state-text">加载中...</div>
                            </div>
                        </div>
                    </div>
                        <!-- History Content (模拟历史) -->
                        <div id="historyTab" style="display: none;">
                        <div id="trades-list">
                            <div class="empty-state">
                                <div class="empty-state-text">加载中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSymbol = 'BTC/USDT';
        let currentPrice = 0;
        let selectedOrderType = 'MARKET';  // MARKET 或 LIMIT
        
        // 选择订单类型
        function selectOrderType(type) {
            selectedOrderType = type;
            const btnMarket = document.getElementById('btnMarket');
            const btnLimit = document.getElementById('btnLimit');
            const limitPriceGroup = document.getElementById('limitPriceGroup');
            
            if (type === 'MARKET') {
                btnMarket.className = 'btn btn-primary w-full';
                btnLimit.className = 'btn btn-ghost w-full';
                if (limitPriceGroup) limitPriceGroup.style.display = 'none';
                const stopLossTakeProfitGroup = document.getElementById('stopLossTakeProfitGroup');
                if (stopLossTakeProfitGroup) stopLossTakeProfitGroup.style.display = 'none';
            } else {
                btnMarket.className = 'btn btn-ghost w-full';
                btnLimit.className = 'btn btn-primary w-full';
                if (limitPriceGroup) limitPriceGroup.style.display = 'block';
                const stopLossTakeProfitGroup = document.getElementById('stopLossTakeProfitGroup');
                if (stopLossTakeProfitGroup) stopLossTakeProfitGroup.style.display = 'block';
            }
        }
        // 自动买入/卖出功能已移除，使用限价单代替
        let positionsMap = {}; // 存储持仓数据，key为symbol，value为持仓对象
        let pendingOrders = []; // 存储待成交订单（从数据库加载）
        
        // 从数据库加载待成交订单
        async function loadPendingOrdersFromDB() {
            try {
                const response = await fetch('/api/paper-trading/pending-orders?executed=false');
                const data = await response.json();
                
                if (!response.ok) {
                    pendingOrders = [];
                    return;
                }
                
                if (data.success && data.orders) {
                    pendingOrders = data.orders.map(order => ({
                        id: order.order_id,
                        order_id: order.order_id,
                        type: order.side,
                        symbol: order.symbol,
                        quantity: parseFloat(order.quantity) || 0,
                        triggerPrice: parseFloat(order.trigger_price) || 0,
                        frozenAmount: parseFloat(order.frozen_amount) || 0,
                        frozenQuantity: parseFloat(order.frozen_quantity) || 0,
                        status: order.status || 'PENDING',
                        executed: order.executed === true || order.executed === 1 || order.executed === 'true',
                        stopLossPrice: order.stop_loss_price ? parseFloat(order.stop_loss_price) : null,
                        takeProfitPrice: order.take_profit_price ? parseFloat(order.take_profit_price) : null,
                        createdAt: order.created_at
                    }));
                    // 自动买入/卖出功能已移除
                } else {
                    pendingOrders = [];
                }
            } catch (error) {
                pendingOrders = [];
            }
        }
        
        // 恢复自动交易状态（已移除，使用限价单代替）
        function restoreAutoTradingState() {
            // 功能已移除，不再需要恢复自动交易状态
        }
        
        // 创建待成交订单（保存到数据库）
        async function createPendingOrder(type, symbol, quantity, triggerPrice, stopLossPrice = null, takeProfitPrice = null) {
            const orderId = `${type}_${symbol}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            try {
                const requestBody = {
                        order_id: orderId,
                        symbol: symbol,
                        side: type,
                        quantity: quantity,
                        trigger_price: triggerPrice,
                        order_source: 'auto'
                };
                
                // 添加止盈止损价格（如果设置了）
                if (stopLossPrice && stopLossPrice > 0) {
                    requestBody.stop_loss_price = stopLossPrice;
                }
                if (takeProfitPrice && takeProfitPrice > 0) {
                    requestBody.take_profit_price = takeProfitPrice;
                }
                
                const response = await fetch('/api/paper-trading/pending-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    showResult(`创建待成交订单失败: ${data.detail || data.message || '未知错误'}`, 'danger');
                    return null;
                }
                
                if (data.success) {
                    // 重新加载待成交订单列表
                    await loadPendingOrdersFromDB();
                    // 如果待成交订单标签页可见，刷新显示
                    const pendingTab = document.getElementById('pendingTab');
                    if (pendingTab && pendingTab.style.display !== 'none') {
                        await loadPendingOrders();
                    }
                    return { id: orderId, order_id: orderId, type, symbol, quantity, triggerPrice };
                } else {
                    showResult(`创建待成交订单失败: ${data.message || data.detail || '未知错误'}`, 'danger');
                    return null;
                }
            } catch (error) {
                showResult(`创建待成交订单失败: ${error.message}`, 'danger');
                return null;
            }
        }
        
        // 更新待成交订单止盈止损
        async function updatePendingOrderStopLossTakeProfit(orderId, type, price) {
            const priceValue = price && price.trim() !== '' ? parseFloat(price) : null;
            
            const requestData = {
                order_id: orderId
            };
            
            // 获取当前订单的止盈止损值
            const stopLossInput = document.getElementById(`pending_stop_loss_${orderId}`);
            const takeProfitInput = document.getElementById(`pending_take_profit_${orderId}`);
            
            if (type === 'stop_loss') {
                requestData.stop_loss_price = priceValue;
                // 保留原有的止盈
                if (takeProfitInput && takeProfitInput.value) {
                    requestData.take_profit_price = parseFloat(takeProfitInput.value);
                }
            } else if (type === 'take_profit') {
                requestData.take_profit_price = priceValue;
                // 保留原有的止损
                if (stopLossInput && stopLossInput.value) {
                    requestData.stop_loss_price = parseFloat(stopLossInput.value);
                }
            }
            
            try {
                const response = await fetch('/api/paper-trading/pending-order/stop-loss-take-profit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult(`${type === 'stop_loss' ? '止损' : '止盈'}已更新`, 'success');
                    // 刷新订单列表
                    setTimeout(() => {
                        loadPendingOrders();
                    }, 300);
                } else {
                    showResult('更新失败: ' + (data.message || data.detail || '未知错误'), 'danger');
                    // 恢复原值
                    if (type === 'stop_loss' && stopLossInput) {
                        stopLossInput.value = stopLossInput.defaultValue || '';
                    } else if (type === 'take_profit' && takeProfitInput) {
                        takeProfitInput.value = takeProfitInput.defaultValue || '';
                    }
                }
            } catch (error) {
                showResult('更新失败: ' + error.message, 'danger');
                // 恢复原值
                if (type === 'stop_loss' && stopLossInput) {
                    stopLossInput.value = stopLossInput.defaultValue || '';
                } else if (type === 'take_profit' && takeProfitInput) {
                    takeProfitInput.value = takeProfitInput.defaultValue || '';
                }
            }
        }
        
        // 清除待成交订单止损
        async function clearPendingOrderStopLoss(orderId) {
            const takeProfitInput = document.getElementById(`pending_take_profit_${orderId}`);
            const requestData = {
                order_id: orderId,
                stop_loss_price: null
            };
            
            // 保留原有的止盈
            if (takeProfitInput && takeProfitInput.value) {
                requestData.take_profit_price = parseFloat(takeProfitInput.value);
            }
            
            try {
                const response = await fetch('/api/paper-trading/pending-order/stop-loss-take-profit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult('止损已清除', 'success');
                    setTimeout(() => {
                        loadPendingOrders();
                    }, 300);
                } else {
                    showResult('清除失败: ' + (data.message || data.detail || '未知错误'), 'danger');
                }
            } catch (error) {
                showResult('清除失败: ' + error.message, 'danger');
            }
        }
        
        // 清除待成交订单止盈
        async function clearPendingOrderTakeProfit(orderId) {
            const stopLossInput = document.getElementById(`pending_stop_loss_${orderId}`);
            const requestData = {
                order_id: orderId,
                take_profit_price: null
            };
            
            // 保留原有的止损
            if (stopLossInput && stopLossInput.value) {
                requestData.stop_loss_price = parseFloat(stopLossInput.value);
            }
            
            try {
                const response = await fetch('/api/paper-trading/pending-order/stop-loss-take-profit', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult('止盈已清除', 'success');
                    setTimeout(() => {
                        loadPendingOrders();
                    }, 300);
                } else {
                    showResult('清除失败: ' + (data.message || data.detail || '未知错误'), 'danger');
                }
            } catch (error) {
                showResult('清除失败: ' + error.message, 'danger');
            }
        }
        
        // 撤单并解冻资金/数量（软删除，状态改为DELETED）
        async function cancelPendingOrder(orderId, silent = false) {
            // 先尝试从前端数组获取订单信息（用于显示和关闭自动交易功能）
            const order = pendingOrders.find(o => (o.order_id === orderId || o.id === orderId) && o.status !== 'DELETED');
            
            try {
                // 使用查询参数而不是路径参数，避免orderId中包含斜杠导致路由解析错误
                const response = await fetch(`/api/paper-trading/pending-order?order_id=${encodeURIComponent(orderId)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // HTTP错误（400, 500等）
                    if (!silent) {
                        showResult(data.detail || data.message || '撤单失败', 'danger');
                    }
                    return false;
                }
                
                if (data.success) {
                    // 撤单成功
                    // 显示撤单成功消息（如果不是静默模式）
                    if (!silent) {
                        const orderInfo = order ? `${order.symbol} ${order.type === 'BUY' ? '买入' : '卖出'}` : '订单';
                        showResult(`已撤单: ${orderInfo}订单`, 'success');
                    }
                    
                    // 重新加载待成交订单
                    await loadPendingOrdersFromDB();
                    loadPendingOrders();
                    loadPositions();
                    return true;
                } else {
                    // 后端返回失败
                    if (!silent) {
                        showResult(data.message || data.detail || '撤单失败', 'danger');
                    }
                    return false;
                }
            } catch (error) {
                if (!silent) {
                    showResult('撤单失败: ' + error.message, 'danger');
                }
                return false;
            }
        }

        // 格式化价格
        function formatPrice(price) {
            if (!price) return '-';
            const num = parseFloat(price);
            if (num >= 1000) return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (num >= 1) return num.toLocaleString('en-US', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
            return num.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
        }

        // 切换标签页
        function showTab(tab) {
            const tabPositionsTitle = document.getElementById('tabPositionsTitle');
            const tabHistoryTitle = document.getElementById('tabHistoryTitle');
            const positionsTab = document.getElementById('positionsTab');
            const historyTab = document.getElementById('historyTab');

            // 重置所有标签样式
            [tabPositionsTitle, tabHistoryTitle].forEach(title => {
                if (title) {
                    title.className = 'btn btn-secondary';
                    title.style.opacity = '0.7';
                    title.style.boxShadow = 'var(--shadow-sm)';
                }
            });

            // 隐藏所有内容
            if (positionsTab) positionsTab.style.display = 'none';
            if (historyTab) historyTab.style.display = 'none';

            if (tab === 'positions') {
                tabPositionsTitle.className = 'btn btn-primary';
                tabPositionsTitle.style.opacity = '1';
                tabPositionsTitle.style.boxShadow = 'var(--shadow-md)';
                positionsTab.style.display = 'block';
            } else if (tab === 'history') {
                tabHistoryTitle.className = 'btn btn-primary';
                tabHistoryTitle.style.opacity = '1';
                tabHistoryTitle.style.boxShadow = 'var(--shadow-md)';
                historyTab.style.display = 'block';
                loadTrades(); // 加载交易历史
            }
        }

        // 同步面板高度
        function syncPanelHeights() {
            const tradingPanel = document.getElementById('tradingPanelCard');
            const positionsPanel = document.getElementById('positionsPanelCard');
            
            if (tradingPanel && positionsPanel) {
                // 等待DOM渲染完成
                setTimeout(() => {
                    const tradingHeight = tradingPanel.offsetHeight;
                    // 设置固定高度
                    positionsPanel.style.height = tradingHeight + 'px';
                    positionsPanel.style.maxHeight = tradingHeight + 'px';
                    positionsPanel.style.minHeight = tradingHeight + 'px';
                    
                    // 计算card-body的可用高度
                    // 获取card的实际padding（通过getComputedStyle）
                    const cardStyle = window.getComputedStyle(positionsPanel);
                    const paddingTop = parseFloat(cardStyle.paddingTop);
                    const paddingBottom = parseFloat(cardStyle.paddingBottom);
                    const totalPadding = paddingTop + paddingBottom;
                    
                    const positionsHeader = positionsPanel.querySelector('.card-header');
                    if (positionsHeader) {
                        const headerStyle = window.getComputedStyle(positionsHeader);
                        const headerHeight = positionsHeader.offsetHeight;
                        const headerMarginBottom = parseFloat(headerStyle.marginBottom);
                        const totalHeaderSpace = headerHeight + headerMarginBottom;
                        
                        // 可用高度 = 总高度 - 上下padding - header及其margin
                        const availableHeight = tradingHeight - totalPadding - totalHeaderSpace;
                        const cardBody = document.getElementById('positionsCardBody');
                        if (cardBody) {
                            cardBody.style.height = availableHeight + 'px';
                            cardBody.style.maxHeight = availableHeight + 'px';
                            cardBody.style.minHeight = availableHeight + 'px';
                        }
                    }
                }, 100);
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化标签页标题样式（默认显示当前持仓）
            const tabPositionsTitle = document.getElementById('tabPositionsTitle');
            const tabPendingTitle = document.getElementById('tabPendingTitle');
            const tabHistoryTitle = document.getElementById('tabHistoryTitle');
            if (tabPositionsTitle && tabPendingTitle && tabHistoryTitle) {
                tabPositionsTitle.className = 'btn btn-primary';
                tabPositionsTitle.style.opacity = '1';
                tabPositionsTitle.style.boxShadow = 'var(--shadow-md)';
                tabPendingTitle.className = 'btn btn-secondary';
                tabPendingTitle.style.opacity = '0.7';
                tabPendingTitle.style.boxShadow = 'var(--shadow-sm)';
                tabHistoryTitle.className = 'btn btn-secondary';
                tabHistoryTitle.style.opacity = '0.7';
                tabHistoryTitle.style.boxShadow = 'var(--shadow-sm)';
            }
            
            // 同步面板高度
            syncPanelHeights();
            // 窗口大小改变时重新同步
            window.addEventListener('resize', syncPanelHeights);
            
            // 从数据库加载待成交订单
            loadPendingOrdersFromDB();
            
            // 先加载持仓数据，再加载交易对（这样切换时能立即填充数量）
            refreshData().then(() => {
            loadSymbols();
            });

            // 定期检查并执行待成交订单
            setInterval(() => {
                checkAndExecutePendingOrders();
            }, 5000); // 每5秒检查一次
            
            // 定期刷新持仓、账户等数据（每5秒）
            setInterval(() => {
                refreshData();
            }, 5000);
            
            // 定期更新持仓价格（每2秒，更频繁的价格更新）
            setInterval(() => {
                updatePositionPrices();
            }, 2000);
            
            // 定期更新持仓市值并检测止盈止损（每5秒）
            setInterval(async () => {
                try {
                    const response = await fetch('/api/paper-trading/update-positions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        // 检查是否有持仓被平仓（通过比较持仓数量）
                        const positionsResponse = await fetch('/api/paper-trading/spot-v2/positions');
                        const positionsData = await positionsResponse.json();
                        const currentCount = positionsData.positions ? positionsData.positions.length : 0;
                        const container = document.getElementById('positions-list');
                        const existingCount = container ? container.querySelectorAll('.position-card[data-symbol]').length : 0;
                        
                        // 如果持仓数量发生变化，才重新加载整个列表
                        if (currentCount !== existingCount) {
                            await loadPositions();
                        } else {
                            // 否则只更新价格和盈亏
                            await updatePositionPrices();
                        }
                    }
                } catch (error) {
                }
            }, 5000);
            
            // 初始化时加载信号数量（4小时内）
            (async () => {
                try {
                    const response = await fetch('/api/ema-signals?limit=100&hours=4');
                    const data = await response.json();
                    const signalCountDisplay = document.getElementById('signal-count-display');
                    const buyCountElement = document.getElementById('buy-count');
                    const sellCountElement = document.getElementById('sell-count');
                    const navCountBadge = document.getElementById('nav-signal-count');
                    
                    if (data.success && data.data && data.data.length > 0) {
                        // 前端再次过滤，确保只显示4小时内的信号
                        const now = new Date();
                        const fourHoursAgo = new Date(now.getTime() - 4 * 60 * 60 * 1000);
                        
                        allSignals = data.data.filter(signal => {
                            if (!signal.timestamp) return false;
                            const signalTime = new Date(signal.timestamp);
                            return signalTime >= fourHoursAgo;
                        });
                        const buySignals = allSignals.filter(s => s.signal_type === 'BUY');
                        const sellSignals = allSignals.filter(s => s.signal_type === 'SELL');
                        const totalCount = allSignals.length;
                        
                        signalCountDisplay.textContent = totalCount;
                        buyCountElement.textContent = `买入: ${buySignals.length}`;
                        sellCountElement.textContent = `卖出: ${sellSignals.length}`;
                        signalCountDisplay.style.color = totalCount >= 10 ? 'var(--success-green)' : (totalCount >= 5 ? 'var(--warning-yellow)' : 'var(--text-primary)');
                        
                        if (navCountBadge) {
                            navCountBadge.textContent = totalCount;
                            navCountBadge.style.display = 'inline-block';
                        }
                    } else {
                        allSignals = [];
                        signalCountDisplay.textContent = '0';
                        buyCountElement.textContent = '买入: 0';
                        sellCountElement.textContent = '卖出: 0';
                        signalCountDisplay.style.color = 'var(--text-secondary)';
                    }
                } catch (error) {
                }
            })();

            document.getElementById('symbol').addEventListener('change', function() {
                currentSymbol = this.value;
                // 切换交易对时不强制刷新，优先使用缓存，提升响应速度
                refreshPrice(false);
                // 如果该交易对有持仓，自动填充数量
                fillQuantityFromPosition();
                // 切换交易对时重置自动买入和自动卖出状态
                // 自动买入/卖出功能已移除，使用限价单代替
                
                // 更新持仓显示和待成交订单
                loadPositions();
                loadPendingOrders();
            });

            document.getElementById('quantity').addEventListener('input', async function() {
                const quantity = parseFloat(this.value) || 0;
                const amount = quantity * currentPrice;
                document.getElementById('estimated-amount').textContent = amount.toFixed(2);
            });

            // 自动买入/卖出功能已移除，使用限价单代替

            // 定期更新信号数量（4小时内，不展开菜单）
            setInterval(async () => {
                try {
                    const response = await fetch('/api/ema-signals?limit=100&hours=4');
                    const data = await response.json();
                    const navCountBadge = document.getElementById('nav-signal-count');
                    if (data.success && data.data && data.data.length > 0) {
                        // 前端再次过滤，确保只显示4小时内的信号
                        const now = new Date();
                        const fourHoursAgo = new Date(now.getTime() - 4 * 60 * 60 * 1000);
                        
                        allSignals = data.data.filter(signal => {
                            if (!signal.timestamp) return false;
                            const signalTime = new Date(signal.timestamp);
                            return signalTime >= fourHoursAgo;
                        });
                        const buySignals = allSignals.filter(s => s.signal_type === 'BUY');
                        const sellSignals = allSignals.filter(s => s.signal_type === 'SELL');
                        const totalCount = allSignals.length;
                        
                        const signalCountDisplay = document.getElementById('signal-count-display');
                        const buyCountElement = document.getElementById('buy-count');
                        const sellCountElement = document.getElementById('sell-count');
                        
                        signalCountDisplay.textContent = totalCount;
                        buyCountElement.textContent = `买入: ${buySignals.length}`;
                        sellCountElement.textContent = `卖出: ${sellSignals.length}`;
                        signalCountDisplay.style.color = totalCount >= 10 ? 'var(--success-green)' : (totalCount >= 5 ? 'var(--warning-yellow)' : 'var(--text-primary)');
                        
                        if (navCountBadge) {
                            navCountBadge.textContent = totalCount;
                            navCountBadge.style.display = 'inline-block';
                        }
                    } else {
                        allSignals = [];
                        const signalCountDisplay = document.getElementById('signal-count-display');
                        const buyCountElement = document.getElementById('buy-count');
                        const sellCountElement = document.getElementById('sell-count');
                        
                        signalCountDisplay.textContent = '0';
                        buyCountElement.textContent = '买入: 0';
                        sellCountElement.textContent = '卖出: 0';
                        signalCountDisplay.style.color = 'var(--text-secondary)';
                        
                        if (navCountBadge) {
                            navCountBadge.style.display = 'none';
                        }
                    }
                } catch (error) {
                }
            }, 30000);
        });

        // 加载交易对
        async function loadSymbols() {
            try {
                const response = await fetch('/api/paper-trading/symbols');
                const data = await response.json();

                const symbolSelect = document.getElementById('symbol');
                symbolSelect.innerHTML = '';

                if (data.symbols && data.symbols.length > 0) {
                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = symbol;
                        symbolSelect.appendChild(option);
                    });

                    currentSymbol = data.symbols[0];
                    refreshPrice(true);
                    // 如果该交易对有持仓，自动填充数量
                    fillQuantityFromPosition();
                } else {
                    symbolSelect.innerHTML = '<option value="">暂无可用交易对</option>';
                }
            } catch (error) {
            }
        }

        // 刷新数据
        // 存储持仓价格历史（用于价格变化动画）
        let positionPriceHistory = {};
        
        // 更新持仓价格（不重新加载整个持仓列表）
        async function updatePositionPrices() {
            try {
                const container = document.getElementById('positions-list');
                if (!container) {
                    return;
                }
                
                // 获取所有持仓卡片
                const positionCards = container.querySelectorAll('.position-card[data-symbol]');
                
                if (positionCards.length === 0) {
                    // 如果没有持仓，尝试重新加载一次
                    await loadPositions();
                    return;
                }
                
                // 为每个持仓更新价格和盈亏（不重新渲染整个列表）
                await Promise.all(Array.from(positionCards).map(async (card) => {
                    const symbol = card.getAttribute('data-symbol');
                    if (!symbol) return;
                    
                    try {
                        // 获取实时价格（强制刷新）
                        const priceUrl = `/api/paper-trading/price?symbol=${encodeURIComponent(symbol)}&force_refresh=true`;
                        const priceResponse = await fetch(priceUrl);
                        if (priceResponse.ok) {
                            const priceData = await priceResponse.json();
                            if (priceData.price && priceData.price > 0) {
                                const currentPrice = parseFloat(priceData.price);
                                
                                // 从持仓映射表获取持仓信息
                                const position = positionsMap[symbol];
                                if (!position) return;
                                
                                // 计算实时盈亏
                                const quantity = parseFloat(position.quantity) || 0;
                                const avgEntryPrice = parseFloat(position.avg_entry_price) || 0;
                                
                                let unrealizedPnl = 0;
                                let unrealizedPnlPct = 0;
                                let marketValue = 0;
                                
                                if (currentPrice > 0 && avgEntryPrice > 0 && quantity > 0) {
                                    marketValue = currentPrice * quantity;
                                    unrealizedPnl = (currentPrice - avgEntryPrice) * quantity;
                                    const cost = avgEntryPrice * quantity;
                                    if (cost > 0) {
                                        unrealizedPnlPct = (unrealizedPnl / cost) * 100;
                                    }
                                }
                                
                                // 更新价格显示
                                const priceElement = card.querySelector('.current-price-display[data-symbol="' + symbol + '"]');
                                if (priceElement) {
                                    const oldPrice = priceElement.textContent;
                                    priceElement.textContent = formatPrice(currentPrice);
                                    // 更新价格颜色
                                    if (currentPrice > avgEntryPrice) {
                                        priceElement.style.color = 'var(--success-green)';
                                    } else if (currentPrice < avgEntryPrice) {
                                        priceElement.style.color = 'var(--danger-red)';
                                    } else {
                                        priceElement.style.color = 'var(--text-secondary)';
                                    }
                                }
                                
                                // 更新盈亏显示
                                const pnlElements = card.querySelectorAll('.pnl-positive, .pnl-negative');
                                pnlElements.forEach(el => {
                                    if (el.textContent.includes('USDT')) {
                                        el.textContent = `${unrealizedPnl >= 0 ? '+' : ''}${unrealizedPnl.toFixed(2)} USDT`;
                                        el.className = unrealizedPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                                    } else if (el.textContent.includes('%')) {
                                        el.textContent = `${unrealizedPnlPct >= 0 ? '+' : ''}${unrealizedPnlPct.toFixed(2)}%`;
                                        el.className = unrealizedPnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                                    }
                                });
                                
                                // 更新市值显示
                                const marketValueElements = card.querySelectorAll('.text-sm.text-secondary');
                                marketValueElements.forEach(el => {
                                    if (el.textContent.includes('市值:')) {
                                        el.innerHTML = el.innerHTML.replace(/市值: [\d.]+ USDT/, `市值: ${marketValue.toFixed(2)} USDT`);
                                    }
                                });
                                
                                // 更新持仓映射表
                                positionsMap[symbol] = {
                                    ...position,
                                    current_price: currentPrice,
                                    unrealized_pnl: unrealizedPnl,
                                    unrealized_pnl_pct: unrealizedPnlPct,
                                    market_value: marketValue
                                };
                            }
                        }
                    } catch (e) {
                        // 静默处理单个持仓更新失败，不影响其他持仓
                    }
                }));
            } catch (error) {
                // 静默处理更新失败
            }
        }
        
        async function refreshData() {
            await Promise.all([
                loadAccountInfo(),
                loadPositions(),
                loadTrades()
            ]);
            // 刷新持仓后，如果当前交易对有持仓，更新数量
            fillQuantityFromPosition();
            // 数据加载完成后重新同步面板高度
            setTimeout(syncPanelHeights, 150);
        }

        // 加载账户信息
        async function loadAccountInfo() {
            try {
                const response = await fetch('/api/paper-trading/account');
                const data = await response.json();

                if (data.account) {
                    const acc = data.account;
                    document.getElementById('total-equity').textContent = acc.total_equity.toFixed(2);
                    document.getElementById('current-balance').textContent = acc.current_balance.toFixed(2);

                    const pnl = acc.total_profit_loss;
                    const pnlPct = acc.total_profit_loss_pct;
                    const pnlElement = document.getElementById('total-pnl');
                    pnlElement.textContent = pnl.toFixed(2);
                    pnlElement.className = 'stat-value pnl ' + (pnl >= 0 ? 'pnl-positive' : 'pnl-negative');

                    const pnlPctElement = document.getElementById('total-pnl-pct');
                    pnlPctElement.textContent = `(${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}%)`;
                    pnlPctElement.className = 'stat-change ' + (pnl >= 0 ? 'pnl-positive' : 'pnl-negative');

                    document.getElementById('win-rate').textContent = acc.win_rate.toFixed(2) + '%';
                    document.getElementById('winning-trades').textContent = acc.winning_trades;
                    document.getElementById('losing-trades').textContent = acc.losing_trades;
                }
            } catch (error) {
            }
        }

        // 加载持仓（优化：直接使用API返回的价格，无需额外请求）
        async function loadPositions() {
            try {
                const response = await fetch('/api/paper-trading/spot-v2/positions');
                const data = await response.json();

                const container = document.getElementById('positions-list');

                // 更新持仓映射表
                positionsMap = {};
                const positions = data.positions || [];

                // 直接使用API返回的价格和计算好的盈亏数据，无需额外请求
                const positionsWithPrices = positions.map(pos => {
                    const currentPrice = parseFloat(pos.current_price) || 0;
                    const quantity = parseFloat(pos.quantity) || 0;
                    const avgEntryPrice = parseFloat(pos.avg_entry_price) || 0;

                    // 优先使用后端计算的值（已经考虑了实时价格）
                    const unrealizedPnl = parseFloat(pos.unrealized_pnl) || 0;
                    const unrealizedPnlPct = parseFloat(pos.unrealized_pnl_pct) || 0;
                    const marketValue = parseFloat(pos.market_value) || 0;

                    const updatedPos = {
                        ...pos,
                        current_price: currentPrice,
                        unrealized_pnl: unrealizedPnl,
                        unrealized_pnl_pct: unrealizedPnlPct,
                        market_value: marketValue
                    };

                    positionsMap[pos.symbol] = updatedPos;
                    return updatedPos;
                });
                
                let htmlContent = '';
                
                // 显示实际持仓（只显示已成交的持仓，不显示任何待成交订单信息）
                if (positionsWithPrices.length > 0) {
                    htmlContent += positionsWithPrices.map(pos => {
                        const pnlClass = pos.unrealized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        const cardClass = pos.unrealized_pnl >= 0 ? 'long' : 'short';
                        
                        // 根据现价与成本价的关系确定颜色
                        let priceColor = 'var(--text-secondary)'; // 默认颜色
                        if (pos.current_price > 0 && pos.avg_entry_price > 0) {
                            if (pos.current_price > pos.avg_entry_price) {
                                priceColor = 'var(--success-green)'; // 上涨：绿色
                            } else if (pos.current_price < pos.avg_entry_price) {
                                priceColor = 'var(--danger-red)'; // 下跌：红色
                            }
                        }
                        
                        return `
                            <div class="position-card ${cardClass}" style="margin-bottom: 12px; padding: 16px; border: 1px solid var(--border-default); border-radius: var(--radius-md);" data-symbol="${pos.symbol}">
                                <div class="d-flex justify-between align-center" style="margin-bottom: 8px;">
                                    <div>
                                    <strong class="text-lg">${pos.symbol}</strong>
                                    </div>
                                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 8px;">
                                        <span class="${pnlClass} font-mono" style="font-size: 16px; font-weight: 600;">${pos.unrealized_pnl >= 0 ? '+' : ''}${pos.unrealized_pnl.toFixed(2)} USDT</span>
                                        <button type="button" class="btn btn-danger" style="width: 120px; padding: 6px 12px; font-size: 12px; min-width: 120px;" onclick="sellPosition('${pos.symbol}', ${pos.quantity})">
                                            <i class="bi bi-arrow-down-circle"></i> 市价卖出
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-secondary" style="margin-bottom: 8px;">
                                    数量: ${pos.quantity} | 成本: ${formatPrice(pos.avg_entry_price)} | 现价: <span class="current-price-display" data-symbol="${pos.symbol}" style="color: ${priceColor}; font-weight: 600; transition: color 0.3s ease;">${formatPrice(pos.current_price)}</span>
                                </div>
                                <div class="text-sm text-secondary" style="margin-bottom: 12px;">
                                    市值: ${pos.market_value.toFixed(2)} USDT | 收益率: <span class="${pnlClass}">${pos.unrealized_pnl_pct >= 0 ? '+' : ''}${pos.unrealized_pnl_pct.toFixed(2)}%</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 12px; border-top: 1px solid var(--border-default);">
                                    <div>
                                        <div class="text-secondary text-xs mb-xs">止损价格</div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" 
                                                   id="stopLoss_${pos.symbol}" 
                                                   value="${pos.stop_loss_price || ''}" 
                                                   placeholder="未设置"
                                                   step="0.01"
                                                   style="flex: 1; padding: 6px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 12px;"
                                                   onchange="updatePaperStopLossTakeProfit('${pos.symbol}', 'stop_loss', this.value)">
                                            <button class="btn btn-xs btn-ghost" onclick="clearPaperStopLoss('${pos.symbol}')" title="清除止损">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="text-secondary text-xs mb-xs">止盈价格</div>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" 
                                                   id="takeProfit_${pos.symbol}" 
                                                   value="${pos.take_profit_price || ''}" 
                                                   placeholder="未设置"
                                                   step="0.01"
                                                   style="flex: 1; padding: 6px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 12px;"
                                                   onchange="updatePaperStopLossTakeProfit('${pos.symbol}', 'take_profit', this.value)">
                                            <button class="btn btn-xs btn-ghost" onclick="clearPaperTakeProfit('${pos.symbol}')" title="清除止盈">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // 如果没有持仓，显示空状态（不显示任何待成交订单，待成交订单只在"待成交"标签页显示）
                if (htmlContent === '') {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无持仓</div></div>';
                } else {
                    container.innerHTML = htmlContent;
                }

                // 动态计算并更新总盈亏统计
                updateTotalPnlStats(positionsWithPrices, data.stats);
            } catch (error) {
            }
        }

        // 动态更新总盈亏统计
        function updateTotalPnlStats(positions, stats) {
            // 计算未实现盈亏总和
            const totalUnrealizedPnl = positions.reduce((sum, pos) => sum + (parseFloat(pos.unrealized_pnl) || 0), 0);

            // 获取已实现盈亏（从stats获取）
            const totalRealizedPnl = parseFloat(stats?.total_pnl) || 0;

            // 总盈亏 = 已实现 + 未实现
            const totalPnl = totalRealizedPnl + totalUnrealizedPnl;

            // 更新总盈亏显示
            const pnlElement = document.getElementById('total-pnl');
            if (pnlElement) {
                pnlElement.textContent = totalPnl.toFixed(2);
                pnlElement.className = 'stat-value pnl ' + (totalPnl >= 0 ? 'pnl-positive' : 'pnl-negative');
            }

            // 计算总盈亏百分比（基于初始余额10000）
            const initialBalance = 10000;
            const totalPnlPct = (totalPnl / initialBalance) * 100;

            const pnlPctElement = document.getElementById('total-pnl-pct');
            if (pnlPctElement) {
                pnlPctElement.textContent = `(${totalPnlPct >= 0 ? '+' : ''}${totalPnlPct.toFixed(2)}%)`;
                pnlPctElement.className = 'stat-change ' + (totalPnlPct >= 0 ? 'positive' : 'negative');
            }
        }
        
        // 根据当前交易对填充数量
        function fillQuantityFromPosition() {
            const quantityInput = document.getElementById('quantity');
            if (currentSymbol && positionsMap[currentSymbol]) {
                const position = positionsMap[currentSymbol];
                quantityInput.value = parseFloat(position.quantity) || '';
                // 触发input事件以更新预计金额
                quantityInput.dispatchEvent(new Event('input'));
            }
        }

        // 加载待成交订单（显示）
        async function loadPendingOrders() {
            const container = document.getElementById('pending-orders-list');
            if (!container) {
                return;
            }
            
            // 从数据库重新加载
            await loadPendingOrdersFromDB();
            
            // 过滤出未执行的订单，且状态不是DELETED
            const activeOrders = pendingOrders.filter(o => {
                // 确保订单存在且未执行
                const notExecuted = !o.executed || o.executed === false || o.executed === 0;
                // 确保状态不是DELETED
                const notDeleted = o.status !== 'DELETED' && o.status !== 'deleted';
                return notExecuted && notDeleted;
            });
            
            
            if (activeOrders.length > 0) {
                // 获取所有订单的当前价格
                Promise.all(activeOrders.map(async (order) => {
                    try {
                        const response = await fetch(`/api/paper-trading/price?symbol=${encodeURIComponent(order.symbol)}`);
                        const data = await response.json();
                        order.currentPrice = data.price || 0;
                        
                        // 判断状态
                        if (order.type === 'BUY') {
                            order.status = order.currentPrice < order.triggerPrice ? '等待触发' : '价格未达到';
                            order.frozenAmount = order.quantity * order.triggerPrice;
                        } else {
                            order.status = order.currentPrice > order.triggerPrice ? '等待触发' : '价格未达到';
                            const position = positionsMap[order.symbol];
                            order.frozenQuantity = position ? Math.min(order.quantity, position.quantity) : order.quantity;
                        }
                    } catch (error) {
                        order.currentPrice = 0;
                        order.status = '获取价格失败';
                    }
                    return order;
                })).then(orders => {
                    if (!orders || orders.length === 0) {
                        container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无待成交订单</div></div>';
                        return;
                    }
                    // 格式化订单状态
                    function formatOrderStatus(status) {
                        if (!status) return '未知';
                        const statusMap = {
                            'PENDING': '待成交',
                            'FILLED': '已成交',
                            'CANCELLED': '已取消',
                            'REJECTED': '已拒绝',
                            'PARTIALLY_FILLED': '部分成交',
                            'DELETED': '已删除',
                            '等待触发': '等待触发',
                            '价格未达到': '价格未达到',
                            '获取价格失败': '获取价格失败'
                        };
                        return statusMap[status] || status;
                    }
                    // 格式化止盈止损信息
                    function formatStopLossTakeProfit(stopLossPrice, takeProfitPrice) {
                        const parts = [];
                        if (stopLossPrice && stopLossPrice > 0) {
                            parts.push(`<span class="text-danger" title="止损价格">止损: ${formatPrice(stopLossPrice)}</span>`);
                        }
                        if (takeProfitPrice && takeProfitPrice > 0) {
                            parts.push(`<span class="text-success" title="止盈价格">止盈: ${formatPrice(takeProfitPrice)}</span>`);
                        }
                        if (parts.length === 0) {
                            return '<span class="text-secondary">止盈止损: 未设置</span>';
                        }
                        return '<span class="text-secondary">止盈止损: </span>' + parts.join(' | ');
                    }
                    
                    container.innerHTML = orders.map(order => {
                        const sideClass = order.type === 'BUY' ? 'badge-success' : 'badge-danger';
                        const sideText = order.type === 'BUY' ? '待买入' : '待卖出';
                        const frozenInfo = order.type === 'BUY' 
                            ? `冻结资金: <span class="font-mono" style="color: var(--warning-yellow);">${order.frozenAmount ? order.frozenAmount.toFixed(2) : '0.00'} USDT</span>`
                            : `冻结数量: <span class="font-mono" style="color: var(--warning-yellow);">${order.frozenQuantity || order.quantity}</span>`;
                        
                        return `
                            <div class="position-card ${order.type === 'BUY' ? 'pending-buy' : 'pending-sell'}" style="margin-bottom: 8px;">
                                <div class="d-flex justify-between align-center" style="margin-bottom: 4px;">
                                    <div>
                                        <span class="badge ${sideClass}">${sideText}</span>
                                        <strong class="text-lg" style="margin-left: 8px;">${order.symbol}</strong>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <span class="text-sm text-secondary">${formatOrderStatus(order.status) || '等待触发'}</span>
                                        <button class="btn btn-sm btn-danger" onclick="cancelPendingOrder('${order.order_id || order.id}')" style="padding: 4px 12px; font-size: 12px; min-width: auto;">
                                            <i class="bi bi-x-circle"></i> 撤单
                                        </button>
                                    </div>
                                </div>
                                <div class="text-sm text-secondary" style="margin-bottom: 3px;">
                                    数量: ${order.quantity} | 触发价格: ${formatPrice(order.triggerPrice)} | 当前价格: ${formatPrice(order.currentPrice)}
                                </div>
                                <div class="text-sm text-secondary" style="margin-bottom: 3px;">
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span>止盈止损:</span>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <input type="number" 
                                                   id="pending_stop_loss_${order.order_id || order.id}" 
                                                   value="${order.stopLossPrice || ''}" 
                                                   placeholder="止损"
                                                   step="0.00000001"
                                                   style="width: 90px; padding: 4px 6px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 11px;"
                                                   onchange="updatePendingOrderStopLossTakeProfit('${order.order_id || order.id}', 'stop_loss', this.value)">
                                            <button class="btn btn-xs btn-ghost" onclick="clearPendingOrderStopLoss('${order.order_id || order.id}')" title="清除止损" style="padding: 2px 6px; font-size: 10px;">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 4px;">
                                            <input type="number" 
                                                   id="pending_take_profit_${order.order_id || order.id}" 
                                                   value="${order.takeProfitPrice || ''}" 
                                                   placeholder="止盈"
                                                   step="0.00000001"
                                                   style="width: 90px; padding: 4px 6px; background: var(--bg-tertiary); border: 1px solid var(--border-default); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 11px;"
                                                   onchange="updatePendingOrderStopLossTakeProfit('${order.order_id || order.id}', 'take_profit', this.value)">
                                            <button class="btn btn-xs btn-ghost" onclick="clearPendingOrderTakeProfit('${order.order_id || order.id}')" title="清除止盈" style="padding: 2px 6px; font-size: 10px;">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-secondary">
                                    ${frozenInfo}
                                </div>
                            </div>
                        `;
                    }).join('');
                }).catch(error => {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">加载订单失败: ' + error.message + '</div></div>';
                });
            } else {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无待成交订单</div></div>';
            }
        }

        // 加载已取消订单
        async function loadCancelledOrders() {
            const container = document.getElementById('cancelled-orders-list');
            if (!container) {
                return;
            }

            container.innerHTML = '<div class="empty-state"><div class="empty-state-text">加载中...</div></div>';

            try {
                const response = await fetch('/api/paper-trading/cancelled-orders?limit=50');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">加载失败</div></div>';
                    return;
                }

                const orders = data.orders || [];

                if (orders.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无已取消订单</div></div>';
                    return;
                }

                // 格式化订单状态
                function formatCancelledStatus(status) {
                    const statusMap = {
                        'CANCELLED': '已取消',
                        'EXPIRED': '已过期'
                    };
                    return statusMap[status] || status;
                }

                container.innerHTML = orders.map(order => {
                    const sideClass = order.side === 'BUY' ? 'badge-success' : 'badge-danger';
                    const sideText = order.side === 'BUY' ? '买入' : '卖出';
                    const statusClass = order.status === 'EXPIRED' ? 'text-warning' : 'text-secondary';

                    return `
                        <div class="position-card" style="margin-bottom: 8px; opacity: 0.7;">
                            <div class="d-flex justify-between align-center" style="margin-bottom: 4px;">
                                <div>
                                    <span class="badge ${sideClass}">${sideText}</span>
                                    <strong class="text-lg" style="margin-left: 8px;">${order.symbol}</strong>
                                </div>
                                <span class="${statusClass}" style="font-size: 12px;">${formatCancelledStatus(order.status)}</span>
                            </div>
                            <div class="text-sm text-secondary" style="margin-bottom: 3px;">
                                数量: ${order.quantity} | 触发价格: ${formatPrice(order.trigger_price)}
                            </div>
                            <div class="text-sm text-secondary" style="margin-bottom: 3px;">
                                止损: ${order.stop_loss_price ? formatPrice(order.stop_loss_price) : '-'} | 止盈: ${order.take_profit_price ? formatPrice(order.take_profit_price) : '-'}
                            </div>
                            <div class="text-sm text-secondary">
                                创建: ${order.created_at || '-'} | 取消: ${order.updated_at || '-'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-text">加载失败: ' + error.message + '</div></div>';
            }
        }

        // 检查并执行待成交订单
        async function checkAndExecutePendingOrders() {
            // 从数据库重新加载待成交订单
            await loadPendingOrdersFromDB();
            const activeOrders = pendingOrders.filter(o => !o.executed && o.status !== 'DELETED');
            
            for (const order of activeOrders) {
                try {
                    // 获取当前价格
                    const response = await fetch(`/api/paper-trading/price?symbol=${encodeURIComponent(order.symbol)}`);
                    const data = await response.json();
                    const currentPrice = data.price || 0;
                    
                    if (currentPrice === 0) continue;
                    
                    let shouldExecute = false;
                    
                    if (order.type === 'BUY' && currentPrice < order.triggerPrice) {
                        shouldExecute = true;
                    } else if (order.type === 'SELL' && currentPrice > order.triggerPrice) {
                        shouldExecute = true;
                    }
                    
                    if (shouldExecute) {
                        // 执行订单
                        try {
                            const tradeResponse = await fetch('/api/paper-trading/order', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    symbol: order.symbol,
                                    side: order.type,
                                    quantity: order.quantity,
                                    order_type: 'MARKET',
                                    pending_order_id: order.order_id || order.id  // 传递待成交订单ID，用于精确匹配
                                })
                            });

                            const tradeData = await tradeResponse.json();

                            if (tradeResponse.ok && tradeData.success) {
                                showResult(`自动${order.type === 'BUY' ? '买入' : '卖出'}成功: ${tradeData.message}`, 'success');
                                
                                // 自动买入/卖出功能已移除
                                
                                // 重新加载待成交订单（数据库会自动标记为已执行）
                                await loadPendingOrdersFromDB();
                                setTimeout(refreshData, 500);
                            }
                        } catch (error) {
                            // 执行订单失败，静默处理
                        }
                    }
                } catch (error) {
                    // 检查订单价格失败，静默处理
                }
            }
            
            // 更新待成交订单显示
            const pendingTab = document.getElementById('pendingTab');
            if (pendingTab && pendingTab.style.display !== 'none') {
                loadPendingOrders();
            }
        }

        // 加载交易历史（仅显示已平仓的交易）
        async function loadTrades() {
            const container = document.getElementById('trades-list');
            if (!container) {
                return;
            }

            container.innerHTML = '<div class="empty-state"><div class="empty-state-text">加载中...</div></div>';

            try {
                const response = await fetch('/api/paper-trading/closed-trades');
                const data = await response.json();

                if (data.trades && data.trades.length > 0) {
                    // 格式化交易类型
                    function formatOrderSource(orderSource) {
                        if (!orderSource) return '<span class="badge badge-info">手动</span>';
                        const sourceMap = {
                            'manual': '<span class="badge badge-info">手动</span>',
                            'signal': '<span class="badge badge-secondary">信号</span>',
                            'auto': '<span class="badge badge-secondary">自动</span>',
                            'stop_loss': '<span class="badge badge-danger">止损</span>',
                            'take_profit': '<span class="badge badge-success">止盈</span>',
                            'STOP_LOSS': '<span class="badge badge-danger">止损</span>',
                            'TAKE_PROFIT': '<span class="badge badge-success">止盈</span>'
                        };
                        return sourceMap[orderSource] || `<span class="badge badge-info">${orderSource}</span>`;
                    }
                    
                    // 格式化订单状态
                    function formatOrderStatus(status) {
                        if (!status) return '未知';
                        const statusMap = {
                            'PENDING': '待成交',
                            'FILLED': '已成交',
                            'CANCELLED': '已取消',
                            'REJECTED': '已拒绝',
                            'PARTIALLY_FILLED': '部分成交',
                            'DELETED': '已删除',
                            '等待触发': '等待触发',
                            '价格未达到': '价格未达到',
                            '获取价格失败': '获取价格失败'
                        };
                        return statusMap[status] || status;
                    }
                    
                    // 格式化订单类型
                    function formatOrderType(orderType) {
                        if (!orderType) return '未知';
                        const typeMap = {
                            'MARKET': '市价',
                            'LIMIT': '限价',
                            'STOP_MARKET': '止损市价',
                            'TAKE_PROFIT_MARKET': '止盈市价',
                            'STOP_LOSS': '止损',
                            'TAKE_PROFIT': '止盈'
                        };
                        return typeMap[orderType] || orderType;
                    }
                    
                    // 格式化止盈止损信息
                    function formatStopLossTakeProfit(stopLossPrice, takeProfitPrice, orderSource) {
                        const parts = [];
                        
                        // 如果是止损或止盈触发的交易，先显示触发信息
                        if (orderSource === 'stop_loss' || orderSource === 'STOP_LOSS') {
                            parts.push('<span class="text-danger" title="止损触发">止损触发</span>');
                        } else if (orderSource === 'take_profit' || orderSource === 'TAKE_PROFIT') {
                            parts.push('<span class="text-success" title="止盈触发">止盈触发</span>');
                        }
                        
                        // 显示原来设置的止盈止损价格
                        const priceParts = [];
                        if (stopLossPrice && stopLossPrice > 0) {
                            priceParts.push(`<span class="text-danger" title="止损价格">止损: ${formatPrice(stopLossPrice)}</span>`);
                        }
                        if (takeProfitPrice && takeProfitPrice > 0) {
                            priceParts.push(`<span class="text-success" title="止盈价格">止盈: ${formatPrice(takeProfitPrice)}</span>`);
                        }
                        
                        // 如果既没有触发信息，也没有价格信息，显示未设置
                        if (parts.length === 0 && priceParts.length === 0) {
                            return '<span class="text-secondary">止盈止损: 未设置</span>';
                        }
                        
                        // 组合显示：触发信息 + 价格信息
                        let result = '';
                        if (parts.length > 0) {
                            result = parts.join(' | ');
                            if (priceParts.length > 0) {
                                result += ' | ' + priceParts.join(' | ');
                            }
                        } else {
                            result = '<span class="text-secondary">止盈止损: </span>' + priceParts.join(' | ');
                        }
                        
                        return result;
                    }
                    
                    container.innerHTML = data.trades.map(trade => {
                        // 已平仓交易显示
                        const pnlClass = trade.realized_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                        const pnlIcon = trade.realized_pnl >= 0 ? '📈' : '📉';
                        const costPrice = trade.cost_price || 0;
                        const sellPrice = trade.price || 0;
                        const totalAmount = (trade.total_amount || 0).toFixed(2);

                        return `
                            <div style="padding: 12px; border-bottom: 1px solid var(--border-default); background: var(--bg-secondary);">
                                <div class="d-flex justify-between align-center">
                                    <div>
                                        <span class="badge badge-primary">平仓</span>
                                        <strong style="margin-left: 8px;">${trade.symbol || '-'}</strong>
                                        ${formatOrderSource(trade.order_source)}
                                    </div>
                                    <span class="text-sm text-secondary">${trade.trade_time || '-'}</span>
                                </div>
                                <div class="text-sm" style="margin-top: 6px;">
                                    <span class="text-secondary">数量:</span> <strong>${trade.quantity || 0}</strong>
                                </div>
                                <div class="text-sm" style="margin-top: 3px;">
                                    <span class="text-secondary">成本价:</span> <strong>${formatPrice(costPrice)}</strong>
                                    <span class="text-secondary" style="margin-left: 12px;">卖出价:</span> <strong>${formatPrice(sellPrice)}</strong>
                                </div>
                                <div class="text-sm" style="margin-top: 3px;">
                                    <span class="text-secondary">卖出总额:</span> ${totalAmount} USDT
                                </div>
                                <div class="text-sm ${pnlClass}" style="margin-top: 6px; font-weight: bold;">
                                    ${pnlIcon} 盈亏: ${trade.realized_pnl >= 0 ? '+' : ''}${(trade.realized_pnl || 0).toFixed(2)} USDT (${trade.pnl_pct >= 0 ? '+' : ''}${(trade.pnl_pct || 0).toFixed(2)}%)
                                </div>
                                <div class="text-sm text-secondary" style="margin-top: 3px;">
                                    ${formatStopLossTakeProfit(trade.stop_loss_price, trade.take_profit_price, trade.order_source)}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-text">暂无已平仓交易记录</div></div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-text">加载失败: ${error.message}</div></div>`;
            }
        }

        // 价格缓存（避免重复请求）
        let paperPriceCache = {};
        let paperPriceCacheTime = {};
        const PAPER_PRICE_CACHE_DURATION = 5000; // 5秒缓存

        // 刷新价格（优化：使用缓存）
        async function refreshPrice(forceRefresh = false) {
            if (!currentSymbol || currentSymbol === '') return;

            const priceInput = document.getElementById('current-price');
            
            // 检查缓存（除非强制刷新）
            if (!forceRefresh) {
                const now = Date.now();
                if (paperPriceCache[currentSymbol] && paperPriceCacheTime[currentSymbol] && (now - paperPriceCacheTime[currentSymbol]) < PAPER_PRICE_CACHE_DURATION) {
                    const cachedPrice = paperPriceCache[currentSymbol];
                    currentPrice = cachedPrice;
                    priceInput.value = formatPrice(cachedPrice);
                    
                    const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                    document.getElementById('estimated-amount').textContent = (quantity * cachedPrice).toFixed(2);
                    return;
                }
            }

            priceInput.value = '加载中...';

            try {
                const url = `/api/paper-trading/price?symbol=${encodeURIComponent(currentSymbol)}${forceRefresh ? '&force_refresh=true' : ''}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.price || data.price === 0) {
                    throw new Error(`${currentSymbol} 暂无价格数据`);
                }

                const oldPrice = currentPrice;
                currentPrice = data.price;
                
                // 更新缓存
                paperPriceCache[currentSymbol] = currentPrice;
                paperPriceCacheTime[currentSymbol] = Date.now();
                
                priceInput.value = formatPrice(currentPrice);

                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                document.getElementById('estimated-amount').textContent = (quantity * currentPrice).toFixed(2);

                // 自动买入/卖出功能已移除，使用限价单代替
                
                // 如果持仓列表可见，刷新持仓显示（更新待买入/待卖出状态）
                const positionsTab = document.getElementById('positionsTab');
                const pendingTab = document.getElementById('pendingTab');
                if (positionsTab && positionsTab.style.display !== 'none') {
                    loadPositions();
                }
                if (pendingTab && pendingTab.style.display !== 'none') {
                    loadPendingOrders();
                }
            } catch (error) {
                priceInput.value = '加载失败';
                showResult(error.message, 'danger');
            }
        }

        // 自动买入/卖出功能已移除，使用限价单代替

        // 显示自定义确认对话框
        function showConfirmDialog(title, message, type = 'warning') {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                
                const iconConfig = {
                    'warning': { icon: 'exclamation-triangle-fill', color: 'var(--warning-yellow)' },
                    'danger': { icon: 'x-circle-fill', color: 'var(--danger-red)' },
                    'info': { icon: 'info-circle-fill', color: 'var(--info-blue)' }
                };
                const config = iconConfig[type] || iconConfig['warning'];
                
                overlay.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-header">
                            <div class="modal-title">
                                <div class="modal-icon" style="background: linear-gradient(135deg, ${type === 'warning' ? 'rgba(245, 158, 11, 0.2)' : type === 'danger' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(59, 130, 246, 0.2)'} 0%, ${type === 'warning' ? 'rgba(245, 158, 11, 0.1)' : type === 'danger' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(59, 130, 246, 0.1)'} 100%); border-color: ${type === 'warning' ? 'rgba(245, 158, 11, 0.3)' : type === 'danger' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)'};">
                                    <i class="bi bi-${config.icon}" style="font-size: 24px; color: ${config.color};"></i>
                                </div>
                                <span>${title}</span>
                            </div>
                        </div>
                        <div class="modal-body">
                            ${message}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" id="modal-cancel-btn" style="min-width: 100px;">
                                <i class="bi bi-x-circle"></i> 取消
                            </button>
                            <button class="btn btn-danger" id="modal-confirm-btn" style="min-width: 100px;">
                                <i class="bi bi-check-circle"></i> 确定
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(overlay);
                
                const cancelBtn = overlay.querySelector('#modal-cancel-btn');
                const confirmBtn = overlay.querySelector('#modal-confirm-btn');
                const dialog = overlay.querySelector('.modal-dialog');
                
                const closeModal = (result) => {
                    dialog.style.animation = 'slideUpModal 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
                    overlay.style.animation = 'fadeIn 0.2s ease-out reverse';
                    setTimeout(() => {
                        overlay.remove();
                        resolve(result);
                    }, 300);
                };
                
                cancelBtn.addEventListener('click', () => closeModal(false));
                confirmBtn.addEventListener('click', () => closeModal(true));
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal(false);
                    }
                });
                
                // ESC键关闭
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            });
        }

        // 卖出持仓（市价卖出）
        async function sellPosition(symbol, quantity) {
            if (!symbol || !quantity || quantity <= 0) {
                showResult('无效的持仓信息', 'danger');
                return;
            }
            
            // 获取当前价格
            let currentPrice = 0;
            try {
                const priceResponse = await fetch(`/api/paper-trading/price?symbol=${encodeURIComponent(symbol)}&force_refresh=true`);
                if (priceResponse.ok) {
                    const priceData = await priceResponse.json();
                    if (priceData.price && priceData.price > 0) {
                        currentPrice = parseFloat(priceData.price);
                    }
                }
            } catch (e) {
                showResult('获取当前价格失败', 'danger');
                return;
            }
            
            if (currentPrice <= 0) {
                showResult('无法获取当前价格，请稍后重试', 'danger');
                return;
            }
            
            // 确认对话框
            const confirmed = await showConfirmDialog(
                '确定要市价卖出吗？',
                `<div style="margin-bottom: 12px;">
                    <strong>交易对:</strong> ${symbol}<br>
                    <strong>数量:</strong> ${quantity}<br>
                    <strong>当前价格:</strong> ${formatPrice(currentPrice)}<br>
                    <strong>预计金额:</strong> ${(quantity * currentPrice).toFixed(2)} USDT<br>
                    <strong>订单类型:</strong> 市价单
                </div>`,
                'warning'
            );
            
            if (!confirmed) return;
            
            // 执行卖出
            try {
                const response = await fetch('/api/paper-trading/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        side: 'SELL',
                        quantity: quantity,
                        order_type: 'MARKET'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`市价卖出成功: ${symbol} ${quantity}`, 'success');
                    // 刷新数据
                    setTimeout(() => {
                        refreshData();
                    }, 500);
                } else {
                    showResult('卖出失败: ' + (data.message || data.detail || '未知错误'), 'danger');
                }
            } catch (error) {
                showResult('卖出失败: ' + error.message, 'danger');
            }
        }

        // 下单
        async function placeTrade(side) {
            const symbol = document.getElementById('symbol').value;
            const quantity = parseFloat(document.getElementById('quantity').value);

            if (!quantity || quantity <= 0) {
                showResult('请输入有效的数量', 'danger');
                return;
            }

            // 检查是否是限价单
            const limitPrice = parseFloat(document.getElementById('limitPrice')?.value || 0);
            if (selectedOrderType === 'LIMIT' && limitPrice > 0) {
                // 限价单：创建待成交订单
                try {
                    // 获取止盈止损价格
                    const stopLossPrice = document.getElementById('pendingStopLoss')?.value ? parseFloat(document.getElementById('pendingStopLoss').value) : null;
                    const takeProfitPrice = document.getElementById('pendingTakeProfit')?.value ? parseFloat(document.getElementById('pendingTakeProfit').value) : null;
                    
                    await createPendingOrder(side, symbol, quantity, limitPrice, stopLossPrice, takeProfitPrice);
                    showResult(`已创建限价${side === 'BUY' ? '买入' : '卖出'}订单: 价格 ${formatPrice(limitPrice)}，数量 ${quantity}`, 'success');
                    document.getElementById('quantity').value = '';
                    document.getElementById('limitPrice').value = '';
                    const pendingStopLossInput = document.getElementById('pendingStopLoss');
                    const pendingTakeProfitInput = document.getElementById('pendingTakeProfit');
                    if (pendingStopLossInput) pendingStopLossInput.value = '';
                    if (pendingTakeProfitInput) pendingTakeProfitInput.value = '';
                    document.getElementById('estimated-amount').textContent = '0.00';
                    await loadPendingOrders();
                    setTimeout(refreshData, 500);
                    return;
                } catch (error) {
                    showResult('创建限价单失败: ' + error.message, 'danger');
                        return;
                    }
            }

            // 价格满足条件或未设置触发价格，立即执行交易（市价单）
            try {
                const response = await fetch('/api/paper-trading/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        side: side,
                        quantity: quantity,
                        order_type: 'MARKET'
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showResult(data.message, 'success');
                    document.getElementById('quantity').value = '';
                    document.getElementById('estimated-amount').textContent = '0.00';
                    setTimeout(refreshData, 500);
                } else {
                    showResult(data.detail || '下单失败', 'danger');
                }
            } catch (error) {
                showResult('下单失败: ' + error.message, 'danger');
            }
        }

        // 显示结果消息（右下角提示）
        // 更新止盈止损（模拟现货）
        async function updatePaperStopLossTakeProfit(symbol, type, value) {
            if (!value || value === '') {
                return; // 空值不处理，由清除按钮处理
            }
            
            const price = parseFloat(value);
            if (isNaN(price) || price <= 0) {
                showResult('价格无效', 'danger');
                return;
            }
            
            try {
                // 先获取当前持仓信息，保留另一个字段的值
                const positionsResponse = await fetch('/api/paper-trading/positions');
                const positionsData = await positionsResponse.json();
                let currentStopLoss = null;
                let currentTakeProfit = null;
                
                if (positionsData.positions) {
                    const position = positionsData.positions.find(p => p.symbol === symbol);
                    if (position) {
                        currentStopLoss = position.stop_loss_price || null;
                        currentTakeProfit = position.take_profit_price || null;
                    }
                }
                
                // 构建请求数据，保留另一个字段
                const requestData = {
                    symbol: symbol
                };
                
                        if (type === 'stop_loss') {
                    requestData.stop_loss_price = price;
                    // 保留原有的止盈
                    if (currentTakeProfit !== null && currentTakeProfit !== undefined) {
                        requestData.take_profit_price = currentTakeProfit;
                    }
                } else if (type === 'take_profit') {
                    requestData.take_profit_price = price;
                    // 保留原有的止损
                    if (currentStopLoss !== null && currentStopLoss !== undefined) {
                        requestData.stop_loss_price = currentStopLoss;
                    }
                }
                
                const response = await fetch('/api/paper-trading/position/update-stop-loss-take-profit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult(`${type === 'stop_loss' ? '止损' : '止盈'}已更新`, 'success');
                    await loadPositions();
                } else {
                    showResult(data.detail || '更新失败', 'danger');
                    // 刷新持仓以恢复原值
                    await loadPositions();
                }
            } catch (error) {
                showResult('更新失败: ' + error.message, 'danger');
                await loadPositions();
            }
        }
        
        // 清除止损（模拟现货）
        async function clearPaperStopLoss(symbol) {
            try {
                const positionsResponse = await fetch('/api/paper-trading/positions');
                const positionsData = await positionsResponse.json();
                let takeProfit = null;
                if (positionsData.positions) {
                    const position = positionsData.positions.find(p => p.symbol === symbol);
                    if (position) {
                        takeProfit = position.take_profit_price || null;
                    }
                }
                
                const response = await fetch('/api/paper-trading/position/update-stop-loss-take-profit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        stop_loss_price: null,
                        take_profit_price: takeProfit
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult('止损已清除', 'success');
                    await loadPositions();
                } else {
                    showResult(data.detail || '清除失败', 'danger');
                }
            } catch (error) {
                showResult('清除失败: ' + error.message, 'danger');
            }
        }
        
        // 清除止盈（模拟现货）
        async function clearPaperTakeProfit(symbol) {
            try {
                const positionsResponse = await fetch('/api/paper-trading/positions');
                const positionsData = await positionsResponse.json();
                let stopLoss = null;
                if (positionsData.positions) {
                    const position = positionsData.positions.find(p => p.symbol === symbol);
                    if (position) {
                        stopLoss = position.stop_loss_price || null;
                    }
                }
                
                const response = await fetch('/api/paper-trading/position/update-stop-loss-take-profit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        stop_loss_price: stopLoss,
                        take_profit_price: null
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showResult('止盈已清除', 'success');
                    await loadPositions();
                } else {
                    showResult(data.detail || '清除失败', 'danger');
                }
            } catch (error) {
                showResult('清除失败: ' + error.message, 'danger');
            }
        }

        function showResult(message, type) {
            // 创建固定定位的提示框
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'var(--success-green-bg)' : 'var(--danger-red-bg)';
            const textColor = type === 'success' ? 'var(--success-green)' : 'var(--danger-red)';
            
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 16px;
                background: ${bgColor};
                color: ${textColor};
                border-radius: var(--radius-md);
                font-size: 13px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;
            
            // 添加动画样式（如果还没有）
            if (!document.getElementById('toast-animation-style')) {
                const style = document.createElement('style');
                style.id = 'toast-animation-style';
                style.textContent = `
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // 3秒后自动移除
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 切换信号下拉菜单
        function toggleSignalDropdown(event) {
            event.stopPropagation();
            const menu = document.getElementById('signal-dropdown-menu');
            const isShowing = menu.classList.contains('show');
            
            if (!isShowing) {
                menu.classList.add('show');
                loadEMASignals();
                // 点击外部关闭
                setTimeout(() => {
                    document.addEventListener('click', function closeOnOutsideClick(e) {
                        if (!menu.contains(e.target) && !e.target.closest('.signal-btn')) {
                            menu.classList.remove('show');
                            document.removeEventListener('click', closeOnOutsideClick);
                        }
                    }, { once: true });
                }, 0);
            } else {
                menu.classList.remove('show');
            }
        }

        // 格式化时间
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            const now = new Date();
            const diffMinutes = Math.floor((now - date) / 1000 / 60);
            
            if (diffMinutes < 1) return '刚刚';
            if (diffMinutes < 60) return `${diffMinutes}分钟前`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}小时前`;
            
            return date.toLocaleString('zh-CN', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }

        let allSignals = []; // 存储所有信号
        let currentFilter = 'ALL'; // 当前筛选类型

        // 筛选信号
        function filterSignals(type) {
            currentFilter = type;
            
            // 更新按钮样式
            document.getElementById('filter-buy-btn').className = type === 'BUY' ? 'btn btn-sm' : 'btn btn-sm btn-ghost';
            document.getElementById('filter-sell-btn').className = type === 'SELL' ? 'btn btn-sm' : 'btn btn-sm btn-ghost';
            document.getElementById('filter-all-btn').className = type === 'ALL' ? 'btn btn-sm' : 'btn btn-sm btn-ghost';
            
            if (type === 'BUY') {
                document.getElementById('filter-buy-btn').style.background = 'var(--success-green)';
                document.getElementById('filter-buy-btn').style.color = 'white';
                document.getElementById('filter-buy-btn').style.border = 'none';
                document.getElementById('filter-sell-btn').style.background = 'transparent';
                document.getElementById('filter-all-btn').style.background = 'transparent';
            } else if (type === 'SELL') {
                document.getElementById('filter-sell-btn').style.background = 'var(--danger-red)';
                document.getElementById('filter-sell-btn').style.color = 'white';
                document.getElementById('filter-sell-btn').style.border = 'none';
                document.getElementById('filter-buy-btn').style.background = 'transparent';
                document.getElementById('filter-all-btn').style.background = 'transparent';
            } else {
                document.getElementById('filter-all-btn').style.background = 'var(--primary-blue)';
                document.getElementById('filter-all-btn').style.color = 'white';
                document.getElementById('filter-all-btn').style.border = 'none';
                document.getElementById('filter-buy-btn').style.background = 'transparent';
                document.getElementById('filter-sell-btn').style.background = 'transparent';
            }
            
            renderSignals();
        }

        // 渲染信号表格
        function renderSignals() {
            const navContainer = document.getElementById('nav-signal-list');
            
            // 根据筛选类型过滤信号
            let filteredSignals = allSignals;
            if (currentFilter === 'BUY') {
                filteredSignals = allSignals.filter(s => s.signal_type === 'BUY');
            } else if (currentFilter === 'SELL') {
                filteredSignals = allSignals.filter(s => s.signal_type === 'SELL');
            }
            
            if (filteredSignals.length > 0) {
                navContainer.innerHTML = `
                    <table class="signal-table">
                        <thead>
                            <tr>
                                <th>类型</th>
                                <th>币种</th>
                                <th>时间周期</th>
                                <th>价格</th>
                                <th>涨跌幅</th>
                                <th>成交量</th>
                                <th>强度</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSignals.map(signal => {
                        const strengthMap = { 'strong': '强', 'medium': '中', 'weak': '弱' };
                                const badgeMap = { 
                                    'strong': 'badge-danger', 
                                    'medium': 'badge-warning', 
                                    'weak': 'badge-info' 
                                };
                        const strength = strengthMap[signal.signal_strength] || '未知';
                        const badgeClass = badgeMap[signal.signal_strength] || 'badge-neutral';
                                const price = formatPrice(signal.price || 0);
                                const priceChange = signal.price_change_pct || 0;
                                const priceChangeClass = priceChange >= 0 ? 'pnl-positive' : 'pnl-negative';
                                const volumeMultiple = signal.volume_multiple || signal.volume_ratio || 0;
                                const volumeType = signal.volume_type || (volumeMultiple > 1 ? '放量' : '缩量');
                                const volumeTypeClass = volumeType === '放量' ? 'badge-success' : 'badge-secondary';
                                const signalTypeClass = signal.signal_type === 'BUY' ? 'badge-success' : 'badge-danger';
                                const signalTypeText = signal.signal_type === 'BUY' ? '买入' : '卖出';

                        return `
                                    <tr onclick="selectSymbolFromSignal('${signal.symbol}'); document.getElementById('signal-dropdown-menu').classList.remove('show');">
                                        <td><span class="badge ${signalTypeClass}">${signalTypeText}</span></td>
                                        <td><span class="signal-symbol">${signal.symbol}</span></td>
                                        <td><span class="text-secondary">${signal.timeframe || '15m'}</span></td>
                                        <td><span class="signal-price">$${price}</span></td>
                                        <td><span class="${priceChangeClass}" style="font-weight: 600;">${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%</span></td>
                                        <td>
                                            <span class="text-secondary font-mono">×${volumeMultiple.toFixed(2)}</span>
                                        </td>
                                        <td><span class="badge ${badgeClass} signal-strength-badge">${strength}</span></td>
                                        <td><span class="signal-time">${formatTime(signal.timestamp)}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                } else {
                navContainer.innerHTML = `<div class="signal-empty"><i class="bi bi-inbox" style="font-size: 24px; opacity: 0.5; margin-bottom: 8px; display: block;"></i>4小时内暂无${currentFilter === 'BUY' ? '买入' : currentFilter === 'SELL' ? '卖出' : ''}信号</div>`;
            }
        }

        // 加载EMA信号（4小时内）
        async function loadEMASignals() {
            try {
                // 使用 /api/ema-signals 获取4小时内的所有信号
                const response = await fetch('/api/ema-signals?limit=100&hours=4');
                const data = await response.json();

                const navContainer = document.getElementById('nav-signal-list');
                const navCountBadge = document.getElementById('nav-signal-count');

                if (data.success && data.data && data.data.length > 0) {
                    // 前端再次过滤，确保只显示4小时内的信号
                    const now = new Date();
                    const fourHoursAgo = new Date(now.getTime() - 4 * 60 * 60 * 1000);
                    
                    allSignals = data.data.filter(signal => {
                        if (!signal.timestamp) return false;
                        const signalTime = new Date(signal.timestamp);
                        return signalTime >= fourHoursAgo;
                    });
                    
                    // 统计买入和卖出信号数量
                    const buySignals = allSignals.filter(s => s.signal_type === 'BUY');
                    const sellSignals = allSignals.filter(s => s.signal_type === 'SELL');
                    const totalCount = allSignals.length;
                    
                    // 更新信号卡片显示
                    const signalCountDisplay = document.getElementById('signal-count-display');
                    const buyCountElement = document.getElementById('buy-count');
                    const sellCountElement = document.getElementById('sell-count');
                    
                    signalCountDisplay.textContent = totalCount;
                    buyCountElement.textContent = `买入: ${buySignals.length}`;
                    sellCountElement.textContent = `卖出: ${sellSignals.length}`;
                    
                    signalCountDisplay.style.color = totalCount >= 10 ? 'var(--success-green)' : (totalCount >= 5 ? 'var(--warning-yellow)' : 'var(--text-primary)');
                    
                    // 更新导航栏徽章（如果存在）
                    if (navCountBadge) {
                        navCountBadge.textContent = totalCount;
                        navCountBadge.style.display = 'inline-block';
                    }

                    // 渲染信号表格（默认显示全部）
                    currentFilter = 'ALL';
                    document.getElementById('filter-all-btn').style.background = 'var(--primary-blue)';
                    document.getElementById('filter-all-btn').style.color = 'white';
                    document.getElementById('filter-all-btn').style.border = 'none';
                    renderSignals();
                } else {
                    // 无信号
                    allSignals = [];
                    const signalCountDisplay = document.getElementById('signal-count-display');
                    const buyCountElement = document.getElementById('buy-count');
                    const sellCountElement = document.getElementById('sell-count');
                    
                    signalCountDisplay.textContent = '0';
                    buyCountElement.textContent = '买入: 0';
                    sellCountElement.textContent = '卖出: 0';
                    signalCountDisplay.style.color = 'var(--text-secondary)';
                    
                    if (navCountBadge) {
                        navCountBadge.style.display = 'none';
                    }
                    navContainer.innerHTML = '<div class="signal-empty"><i class="bi bi-inbox" style="font-size: 24px; opacity: 0.5; margin-bottom: 8px; display: block;"></i>4小时内暂无交易信号</div>';
                }
            } catch (error) {
                const navContainer = document.getElementById('nav-signal-list');
                navContainer.innerHTML = '<div class="signal-empty">加载失败，请刷新重试</div>';
            }
        }

        // 从信号中选择交易对
        function selectSymbolFromSignal(symbol) {
            const symbolSelect = document.getElementById('symbol');
            for (let option of symbolSelect.options) {
                if (option.value === symbol) {
                    symbolSelect.value = symbol;
                    currentSymbol = symbol;
                    refreshPrice(true);
                    // 如果该交易对有持仓，自动填充数量
                    fillQuantityFromPosition();
                    document.getElementById('trade-form').scrollIntoView({ behavior: 'smooth' });
                    break;
                }
            }
        }
    </script>
</body>
</html>