<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿé…ç½® - åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .settings-card {
            background: #16213e;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .setting-item {
            background: #0f3460;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .setting-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4ecca3;
        }

        .setting-description {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }

        .btn-primary {
            background-color: #4ecca3;
            border-color: #4ecca3;
            color: #000;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: #3dbb8f;
            border-color: #3dbb8f;
        }

        .alert {
            border-radius: 8px;
        }

        .strategy-option {
            background: #1a1a2e;
            border: 2px solid #4ecca3;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .strategy-option:hover {
            background: #0f3460;
        }

        .strategy-option.active {
            background: #4ecca3;
            color: #000;
        }

        .strategy-option input[type="radio"] {
            margin-right: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4ecca3;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .navbar {
            background-color: #16213e !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .navbar-brand {
            color: #4ecca3 !important;
            font-weight: 700;
        }

        .nav-link {
            color: #eee !important;
        }

        .nav-link:hover {
            color: #4ecca3 !important;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ğŸ“Š åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿ</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">ä»ªè¡¨ç›˜</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/system-settings">ç³»ç»Ÿé…ç½®</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1 class="mb-4">âš™ï¸ ç³»ç»Ÿé…ç½®</h1>

        <!-- æç¤ºä¿¡æ¯ -->
        <div id="alertContainer"></div>

        <!-- åˆ†æ‰¹å»ºä»“ç­–ç•¥é…ç½® -->
        <div class="settings-card">
            <div class="setting-item">
                <div class="setting-header">ğŸ“ˆ åˆ†æ‰¹å»ºä»“ç­–ç•¥</div>
                <div class="setting-description">
                    é€‰æ‹©åˆ†æ‰¹å»ºä»“ä½¿ç”¨çš„ç­–ç•¥ç±»å‹ï¼ˆéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰
                </div>

                <div class="mb-3">
                    <div class="strategy-option" id="strategyV2">
                        <input type="radio" name="strategy" value="kline_pullback" id="strategyKline">
                        <label for="strategyKline" style="cursor: pointer;">
                            <strong>V2: Kçº¿å›è°ƒç­–ç•¥</strong> (æ¨è)
                            <div class="small text-muted mt-1">
                                ç­‰å¾…15M/5Måå‘Kçº¿å›è°ƒç¡®è®¤ååˆ†3æ‰¹å»ºä»“ï¼Œ60åˆ†é’Ÿçª—å£
                            </div>
                        </label>
                    </div>

                    <div class="strategy-option" id="strategyV1">
                        <input type="radio" name="strategy" value="price_percentile" id="strategyPrice">
                        <label for="strategyPrice" style="cursor: pointer;">
                            <strong>V1: ä»·æ ¼åˆ†ä½æ•°ç­–ç•¥</strong>
                            <div class="small text-muted mt-1">
                                åŸºäºæ»šåŠ¨çª—å£ä»·æ ¼ç™¾åˆ†ä½åŠ¨æ€å…¥åœºï¼Œ30åˆ†é’Ÿçª—å£
                            </div>
                        </label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="updateStrategy()">
                    ğŸ’¾ ä¿å­˜ç­–ç•¥è®¾ç½®
                </button>
            </div>
        </div>

        <!-- Big4è¿‡æ»¤å™¨é…ç½® -->
        <div class="settings-card">
            <div class="setting-item">
                <div class="setting-header">ğŸ” Big4å¸‚åœºè¶‹åŠ¿è¿‡æ»¤å™¨</div>
                <div class="setting-description">
                    å¯ç”¨åï¼Œç³»ç»Ÿä¼šæ ¹æ®BTC/ETH/BNB/SOLçš„æ•´ä½“è¶‹åŠ¿è¿‡æ»¤äº¤æ˜“ä¿¡å·ï¼ˆéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆï¼‰
                </div>

                <div class="d-flex align-items-center mb-3">
                    <label class="toggle-switch me-3">
                        <input type="checkbox" id="big4Toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="big4Status">Loading...</span>
                </div>

                <button class="btn btn-primary" onclick="updateBig4()">
                    ğŸ’¾ ä¿å­˜è¿‡æ»¤å™¨è®¾ç½®
                </button>
            </div>
        </div>

        <!-- å½“å‰é…ç½®çŠ¶æ€ -->
        <div class="settings-card">
            <div class="setting-item">
                <div class="setting-header">ğŸ“‹ å½“å‰é…ç½®çŠ¶æ€</div>
                <div class="setting-description">
                    æ˜¾ç¤ºå½“å‰æ•°æ®åº“ä¸­ä¿å­˜çš„é…ç½®
                </div>

                <pre id="currentSettings" style="background: #0f3460; padding: 15px; border-radius: 8px; color: #4ecca3;">
Loading...
                </pre>

                <button class="btn btn-secondary" onclick="loadSettings()">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = '/api/system';

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHTML;

            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 3000);
        }

        // åŠ è½½é…ç½®
        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                const result = await response.json();

                if (result.success) {
                    const data = result.data;

                    // æ›´æ–°åˆ†æ‰¹å»ºä»“ç­–ç•¥
                    const strategy = data.batch_entry_strategy.value;
                    if (strategy === 'kline_pullback') {
                        document.getElementById('strategyKline').checked = true;
                        document.getElementById('strategyV2').classList.add('active');
                        document.getElementById('strategyV1').classList.remove('active');
                    } else {
                        document.getElementById('strategyPrice').checked = true;
                        document.getElementById('strategyV1').classList.add('active');
                        document.getElementById('strategyV2').classList.remove('active');
                    }

                    // æ›´æ–°Big4è¿‡æ»¤å™¨
                    const big4Enabled = data.big4_filter_enabled.value === 'true';
                    document.getElementById('big4Toggle').checked = big4Enabled;
                    document.getElementById('big4Status').textContent = big4Enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨';

                    // æ›´æ–°å½“å‰é…ç½®æ˜¾ç¤º
                    document.getElementById('currentSettings').textContent = JSON.stringify(data, null, 2);
                } else {
                    showAlert('åŠ è½½é…ç½®å¤±è´¥', 'danger');
                }
            } catch (error) {
                showAlert('åŠ è½½é…ç½®å‡ºé”™: ' + error.message, 'danger');
            }
        }

        // æ›´æ–°ç­–ç•¥
        async function updateStrategy() {
            const strategy = document.querySelector('input[name="strategy"]:checked').value;

            try {
                const response = await fetch(`${API_BASE}/batch-entry-strategy`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ strategy })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`âœ… ${result.message}<br><small>${result.data.note}</small>`, 'success');
                    loadSettings();
                } else {
                    showAlert('æ›´æ–°å¤±è´¥', 'danger');
                }
            } catch (error) {
                showAlert('æ›´æ–°å‡ºé”™: ' + error.message, 'danger');
            }
        }

        // æ›´æ–°Big4è¿‡æ»¤å™¨
        async function updateBig4() {
            const enabled = document.getElementById('big4Toggle').checked;

            try {
                const response = await fetch(`${API_BASE}/big4-filter`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(`âœ… ${result.message}<br><small>${result.data.note}</small>`, 'success');
                    document.getElementById('big4Status').textContent = enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ å·²ç¦ç”¨';
                    loadSettings();
                } else {
                    showAlert('æ›´æ–°å¤±è´¥', 'danger');
                }
            } catch (error) {
                showAlert('æ›´æ–°å‡ºé”™: ' + error.message, 'danger');
            }
        }

        // ç­–ç•¥é€‰é¡¹ç‚¹å‡»äº‹ä»¶
        document.getElementById('strategyV2').addEventListener('click', function() {
            document.getElementById('strategyKline').checked = true;
            this.classList.add('active');
            document.getElementById('strategyV1').classList.remove('active');
        });

        document.getElementById('strategyV1').addEventListener('click', function() {
            document.getElementById('strategyPrice').checked = true;
            this.classList.add('active');
            document.getElementById('strategyV2').classList.remove('active');
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadSettings();
    </script>
</body>
</html>
