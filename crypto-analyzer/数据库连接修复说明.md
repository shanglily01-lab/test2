# æ•°æ®åº“è¿æ¥ä¿®å¤è¯´æ˜

## é—®é¢˜åŸå› 

`cache_update_service.py` ä¸­ä½¿ç”¨äº† `self.db_service.get_connection()`ï¼Œä½† `DatabaseService` ç±»åªæä¾› `get_session()` æ–¹æ³•ï¼ˆåŸºäºSQLAlchemyï¼‰ã€‚

é”™è¯¯ä¿¡æ¯ï¼š
```
'DatabaseService' object has no attribute 'get_connection'
```

## å·²ä¿®å¤çš„æ–¹æ³•ï¼ˆå†™å…¥æ–¹æ³•ï¼‰âœ…

æ‰€æœ‰å†™å…¥æ–¹æ³•å·²å®Œå…¨ä¿®å¤ï¼Œä½¿ç”¨ SQLAlchemy session å’Œ text() åŒ…è£…ï¼š

1. âœ… `_upsert_price_stats` - ä»·æ ¼ç»Ÿè®¡å†™å…¥
2. âœ… `_upsert_technical_indicators` - æŠ€æœ¯æŒ‡æ ‡å†™å…¥
3. âœ… `_upsert_hyperliquid_aggregation` - Hyperliquidèšåˆå†™å…¥
4. âœ… `_upsert_news_sentiment` - æ–°é—»æƒ…ç»ªå†™å…¥
5. âœ… `_upsert_funding_rate_stats` - èµ„é‡‘è´¹ç‡å†™å…¥
6. âœ… `_upsert_recommendation` - æŠ•èµ„å»ºè®®å†™å…¥

### ä¿®å¤æ¨¡å¼

```python
# ä¿®å¤å‰
def _upsert_xxx(self, **kwargs):
    conn = self.db_service.get_connection()
    cursor = conn.cursor()
    sql = """ INSERT ... %(param)s ... """
    cursor.execute(sql, kwargs)
    conn.commit()

# ä¿®å¤å
def _upsert_xxx(self, **kwargs):
    session = None
    try:
        session = self.db_service.get_session()
        sql = text(""" INSERT ... :param ... """)
        session.execute(sql, kwargs)
        session.commit()
    except Exception as e:
        if session:
            session.rollback()
        logger.error(...)
    finally:
        if session:
            session.close()
```

## éƒ¨åˆ†ä¿®å¤çš„æ–¹æ³•ï¼ˆè¯»å–æ–¹æ³•ï¼‰âš ï¸

ä»¥ä¸‹è¯»å–æ–¹æ³•å·²éƒ¨åˆ†ä¿®å¤ï¼Œä½†å¯ä»¥æš‚æ—¶è¿”å›Noneä¸å½±å“ç³»ç»Ÿè¿è¡Œï¼š

1. âš ï¸ `_get_cached_technical_data` - å·²ä¿®å¤ âœ…
2. âš ï¸ `_get_cached_news_data` - éœ€è¦ä¿®å¤
3. âš ï¸ `_get_cached_funding_data` - éœ€è¦ä¿®å¤
4. âš ï¸ `_get_cached_hyperliquid_data` - éœ€è¦ä¿®å¤
5. âš ï¸ `_get_cached_price_stats` - éœ€è¦ä¿®å¤

**æ³¨æ„**ï¼šè¿™äº›è¯»å–æ–¹æ³•åªåœ¨ `update_recommendations_cache()` ä¸­ä½¿ç”¨ã€‚å¦‚æœå®ƒä»¬è¿”å›Noneï¼Œç³»ç»Ÿä¼šå›é€€åˆ°å®æ—¶è®¡ç®—ï¼Œç¼“å­˜å†™å…¥åŠŸèƒ½ä¸å—å½±å“ã€‚

## æµ‹è¯•æ­¥éª¤

### 1. åˆ›å»ºç¼ºå¤±çš„è¡¨

```bash
mysql -u root -pTonny@1000 binance-data < scripts/migrations/002_create_missing_tables.sql
```

### 2. æµ‹è¯•ç¼“å­˜æ›´æ–°

```bash
cd crypto-analyzer
venv\Scripts\activate
python scripts/ç®¡ç†/update_cache_manual.py
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… ä¸å†å‡ºç° `'DatabaseService' object has no attribute 'get_connection'` é”™è¯¯
- âœ… æ‰€æœ‰6ä¸ªç¼“å­˜è¡¨éƒ½èƒ½æˆåŠŸå†™å…¥æ•°æ®
- âœ… çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
  ```
  âœ… ä»·æ ¼ç»Ÿè®¡ç¼“å­˜æ›´æ–°å®Œæˆ - 16 ä¸ªå¸ç§
  âœ… æŠ€æœ¯æŒ‡æ ‡ç¼“å­˜æ›´æ–°å®Œæˆ - 16 ä¸ªå¸ç§
  âœ… Hyperliquidèšåˆç¼“å­˜æ›´æ–°å®Œæˆ - 16 ä¸ªå¸ç§
  âœ… æ–°é—»æƒ…ç»ªèšåˆæ›´æ–°å®Œæˆ - 16 ä¸ªå¸ç§
  âœ… èµ„é‡‘è´¹ç‡ç»Ÿè®¡æ›´æ–°å®Œæˆ - 16 ä¸ªå¸ç§
  âœ… æŠ•èµ„å»ºè®®ç¼“å­˜æ›´æ–°å®Œæˆ - 16 ä¸ªå¸ç§
  ```

### 3. éªŒè¯æ•°æ®åº“

```sql
-- æ£€æŸ¥æ‰€æœ‰è¡¨æ˜¯å¦æœ‰æ•°æ®
SELECT COUNT(*) FROM price_stats_24h;
SELECT COUNT(*) FROM technical_indicators_cache;
SELECT COUNT(*) FROM hyperliquid_symbol_aggregation;
SELECT COUNT(*) FROM news_sentiment_aggregation;
SELECT COUNT(*) FROM funding_rate_stats;
SELECT COUNT(*) FROM investment_recommendations_cache;

-- åº”è¯¥æ¯ä¸ªè¡¨éƒ½æœ‰ > 0 æ¡æ•°æ®
```

## åç»­ä¼˜åŒ–å»ºè®®

### 1. å®Œæ•´ä¿®å¤æ‰€æœ‰è¯»å–æ–¹æ³•

å°†å‰©ä½™çš„4ä¸ªè¯»å–æ–¹æ³•æŒ‰ç…§ `_get_cached_technical_data` çš„æ¨¡å¼ä¿®å¤ï¼š

```python
def _get_cached_xxx(self, symbol: str) -> Optional[dict]:
    session = None
    try:
        session = self.db_service.get_session()
        sql = text("SELECT * FROM xxx WHERE symbol = :symbol")
        result = session.execute(sql, {"symbol": symbol}).fetchone()
        if not result:
            return None
        result_dict = dict(result._mapping) if hasattr(result, '_mapping') else dict(result)
        return result_dict
    except Exception as e:
        logger.warning(f"è¯»å–ç¼“å­˜å¤±è´¥: {e}")
        return None
    finally:
        if session:
            session.close()
```

### 2. ä½¿ç”¨è¿æ¥æ± 

SQLAlchemy å·²ç»å†…ç½®äº†è¿æ¥æ± ï¼Œä½†å¯ä»¥è°ƒæ•´å‚æ•°ï¼š

```python
# åœ¨ db_service.py ä¸­
self.engine = create_engine(
    db_uri,
    pool_size=20,  # å¢åŠ è¿æ¥æ± å¤§å°
    max_overflow=30,  # å¢åŠ æº¢å‡ºè¿æ¥æ•°
    pool_pre_ping=True
)
```

### 3. æ·»åŠ ç¼“å­˜æœ‰æ•ˆæœŸæ£€æŸ¥

åœ¨è¯»å–ç¼“å­˜æ—¶æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼š

```python
if result_dict.get('updated_at'):
    age = (datetime.now() - result_dict['updated_at']).total_seconds()
    if age > 600:  # 10åˆ†é’Ÿ
        return None  # ç¼“å­˜è¿‡æœŸï¼Œå›é€€åˆ°å®æ—¶è®¡ç®—
```

## æ–‡ä»¶å¤‡ä»½

ä¿®å¤å‰çš„åŸå§‹æ–‡ä»¶å·²å¤‡ä»½ï¼š
```
app/services/cache_update_service.py.backup
```

å¦‚éœ€æ¢å¤ï¼š
```bash
cp app/services/cache_update_service.py.backup app/services/cache_update_service.py
```

## æ€»ç»“

âœ… **ä¸»è¦é—®é¢˜å·²è§£å†³**ï¼šæ‰€æœ‰å†™å…¥æ–¹æ³•éƒ½å·²æ­£ç¡®ä¿®å¤
âš ï¸ **æ¬¡è¦ä¼˜åŒ–**ï¼šè¯»å–æ–¹æ³•å¯ä»¥åç»­å®Œå–„
ğŸš€ **å¯ä»¥ç»§ç»­ä½¿ç”¨**ï¼šç¼“å­˜æ›´æ–°åŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ

ä¿®å¤åï¼Œè¿è¡Œ `python scripts/ç®¡ç†/update_cache_manual.py` åº”è¯¥ä¸å†æŠ¥é”™ï¼Œæ‰€æœ‰ç¼“å­˜è¡¨éƒ½èƒ½æ­£å¸¸å†™å…¥æ•°æ®ã€‚
