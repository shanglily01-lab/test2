# 交易方向控制功能 - 使用指南

## ✅ 已完成的功能

系统已添加完整的**交易方向控制**功能，支持通过前端页面或命令行脚本灵活控制是否允许做多或做空。

## 📋 功能特点

1. **前端可视化控制** - 通过Web界面一键开关
2. **命令行快速管理** - 使用脚本快速切换模式
3. **实时生效** - 配置修改后立即生效（最长延迟5分钟）
4. **智能过滤** - 自动拒绝被禁止方向的交易信号

## 🌐 方法1: 前端页面控制（推荐）

### 访问设置页面

1. 打开浏览器访问：`http://your-server-ip:port/system-settings`
2. 找到 **"🎯 交易方向控制"** 卡片
3. 使用开关按钮控制：
   - **📈 允许做多 (LONG)** - 启用/禁用做多交易
   - **📉 允许做空 (SHORT)** - 启用/禁用做空交易
4. 点击 **"💾 保存交易方向设置"** 按钮

### 状态提示

系统会实时显示当前状态：
- ✅ 允许做多 + ✅ 允许做空 - 正常双向交易
- ✅ 允许做多 + ❌ 禁止做空 - 仅做多模式
- ❌ 禁止做多 + ✅ 允许做空 - 仅做空模式
- ❌ 禁止做多 + ❌ 禁止做空 - 不执行任何交易

## 💻 方法2: 命令行脚本控制

### 查看当前设置
```bash
python set_trading_direction.py status
```

### 快速切换模式
```bash
# 仅做多模式（禁用做空）
python set_trading_direction.py only-long

# 仅做空模式（禁用做多）
python set_trading_direction.py only-short

# 启用双向交易
python set_trading_direction.py enable-both

# 禁用所有交易
python set_trading_direction.py disable-both
```

### 单独控制
```bash
# 启用/禁用做多
python set_trading_direction.py enable-long
python set_trading_direction.py disable-long

# 启用/禁用做空
python set_trading_direction.py enable-short
python set_trading_direction.py disable-short
```

## 🔧 技术实现

### 数据库配置
设置存储在 `adaptive_params` 表：
- `allow_long`: 1=允许做多, 0=禁止做多
- `allow_short`: 1=允许做空, 0=禁止做空

### API接口
- **GET** `/api/system/trading-direction` - 获取当前设置
- **PUT** `/api/system/trading-direction` - 更新设置

### 过滤逻辑
在 `smart_trader_service.py` 的 `execute_trade()` 方法中：
```python
# 检查交易方向是否允许
if not self.opt_config.is_direction_allowed(side):
    logger.warning(f"[SIGNAL_REJECT] {symbol} {side} - 系统已禁止{direction_name}")
    return False
```

## 📊 日志示例

当方向被禁止时，系统会记录：

```
[SIGNAL_REJECT] BTC/USDT SHORT - 系统已禁止做空
[SIGNAL_REJECT] ETH/USDT LONG - 系统已禁止做多
```

## 🎯 使用场景

### 1. 牛市策略
在明显上涨行情中，禁用做空，专注做多：
```bash
python set_trading_direction.py only-long
```

### 2. 熊市策略
在明显下跌行情中，禁用做多，只做空：
```bash
python set_trading_direction.py only-short
```

### 3. 风险控制
当某个方向持续亏损时，暂时禁用该方向：
- 做多连续亏损 → 禁用做多
- 做空连续亏损 → 禁用做空

### 4. 策略测试
测试纯多头或纯空头策略效果

### 5. 市场休息
临时暂停某个或所有方向的交易

## ⚠️ 注意事项

1. ✅ **实时生效** - 无需重启服务
2. ✅ **不影响持仓** - 仅过滤新信号，不影响已开仓位
3. ✅ **默认双向** - 初始状态两个方向都允许
4. ⚠️ **缓存延迟** - 配置会被缓存5分钟，最长延迟5分钟
5. ⚠️ **禁用所有** - 如果两个方向都禁止，系统将不执行任何交易

## 📁 相关文件

### 脚本文件
- `add_direction_settings.py` - 初始化设置（仅需运行一次）
- `set_trading_direction.py` - 方向管理脚本（日常使用）

### 代码文件
- `app/services/optimization_config.py` - 配置读取逻辑
- `app/api/system_settings_api.py` - API接口实现
- `smart_trader_service.py` - 交易过滤逻辑
- `templates/system_settings.html` - 前端界面

## 🚀 快速开始

1. **初始化设置**（仅首次需要）:
   ```bash
   python add_direction_settings.py
   ```

2. **通过前端管理**:
   - 访问 `/system-settings` 页面
   - 使用开关按钮控制
   - 点击保存

3. **或使用命令行**:
   ```bash
   python set_trading_direction.py only-long  # 设为仅做多
   python set_trading_direction.py status     # 查看状态
   ```

---

**提示**: 推荐使用前端页面进行可视化管理，更直观方便！
