# 15分钟K线数据回填指南
## Quick Start Guide for 15m K-line Data Backfill

---

## 前置条件 / Prerequisites

1. **Windows 本地环境** - 数据库在 Windows 本地
2. **Python 环境** - 已安装 Python 3.9+
3. **依赖安装** - 已运行 `pip install -r requirements.txt`
4. **数据库运行** - MySQL 服务正在运行
5. **配置文件** - `config.yaml` 已正确配置

---

## 运行步骤 / Steps to Run

### 1. 打开命令行 / Open Command Prompt

在项目根目录打开 Windows 命令行或 PowerShell:

```bash
cd C:\path\to\crypto-analyzer
```

### 2. 运行回填脚本 / Run Backfill Script

```bash
python scripts/backfill_15m_data.py
```

---

## 脚本功能 / Script Features

- **采集范围**: 最近 5 小时（20条 15分钟 K线）
- **数据源**: Binance（优先）→ Gate.io（备用）
- **币种数量**: 根据 config.yaml 中的 symbols 配置
- **自动去重**: 检查已存在的数据，避免重复插入
- **数据验证**: 完成后自动验证数据充足性

---

## 预期输出 / Expected Output

```
================================================================================
🔄 回填最近5小时的 15分钟 K线数据
================================================================================

📊 监控币种: 16 个
   - BTC/USDT
   - ETH/USDT
   ...

⏰ 时间范围: 最近 5 小时
📈 时间周期: 15m
🏦 交易所: Binance, Gate.io
📦 预计采集: 16 币种 × 20 条 = 320 条数据

✅ 数据库服务初始化成功

================================================================================
开始采集数据...
================================================================================

📊 处理 BTC/USDT...
   ✓ Binance: 获取 20 条数据
   ✅ 保存 20 条新数据到数据库

📊 处理 ETH/USDT...
   ✓ Binance: 获取 20 条数据
   ✅ 保存 20 条新数据到数据库

...

================================================================================
📊 数据回填完成
================================================================================

✅ 成功保存: 320 条数据
❌ 失败: 0 个币种

================================================================================
🔍 数据验证
================================================================================

币种             15m数据量     状态
--------------------------------------------------
BTC/USDT         20           ⚠️  接近
ETH/USDT         20           ⚠️  接近
...

================================================================================
✅ 回填完成！现在可以运行 EMA 信号监控了
================================================================================

💡 下一步:
   1. 运行测试: python test_ema_signal.py
   2. 启动监控: python app/scheduler.py
```

---

## 数据说明 / Data Notes

### 为什么只有20条数据？/ Why Only 20 Records?

- **5小时 = 20个15分钟周期**
- EMA 信号需要 **至少31条** K线数据
- **解决方案**:
  1. 继续运行 scheduler 自动采集（推荐）
  2. 手动延长回填时间范围到 8小时（需修改脚本 `limit=32`）

### 后续数据采集 / Ongoing Collection

启动调度器后，系统会自动:
- **每15分钟** 采集一次 15m K线数据
- 逐渐积累到 31+ 条数据
- EMA 信号监控自动启用

```bash
python app/scheduler.py
```

---

## 常见问题 / Troubleshooting

### 1. 数据库连接失败

```
❌ 错误: (2003, "Can't connect to MySQL server...")
```

**解决方案**:
- 检查 MySQL 服务是否启动
- 检查 `config.yaml` 中的数据库配置
- 确认防火墙未阻止连接

### 2. API 限流

```
⚠️  未能获取数据
```

**解决方案**:
- 脚本已内置 0.5秒延迟
- 如频繁失败，手动增加延迟时间（修改 `await asyncio.sleep(0.5)` → `1.0`）

### 3. 依赖缺失

```
ModuleNotFoundError: No module named 'xxx'
```

**解决方案**:
```bash
pip install -r requirements.txt
```

---

## 验证数据 / Verify Data

运行检查脚本确认数据已保存:

```bash
python scripts/check_klines_data.py
```

应该看到:
```
✅ 15m: XXX 条记录
```

---

## 后续步骤 / Next Steps

1. **测试 EMA 信号**:
   ```bash
   python test_ema_signal.py
   ```

2. **启动调度器**（持续采集）:
   ```bash
   python app/scheduler.py
   ```

3. **等待数据积累**:
   - 运行 2-3 小时后，数据量达到 31+ 条
   - EMA 信号监控自动生效

---

## 手动扩展回填范围（可选）/ Extend Backfill Range (Optional)

如需立即获得 31+ 条数据，修改脚本:

**文件**: `scripts/backfill_15m_data.py`

**修改行 83**:
```python
# 从:
limit=20  # 最近20条（5小时）

# 改为:
limit=35  # 最近35条（8.75小时）
```

重新运行脚本即可获得充足数据。

---

## 技术支持 / Support

如遇到问题:
1. 查看日志输出的错误信息
2. 运行诊断脚本: `python scripts/diagnose_kline_query.py`
3. 检查数据库表结构: `python scripts/check_klines_data.py`

---

**最后更新**: 2025-10-28
**脚本版本**: v1.0
