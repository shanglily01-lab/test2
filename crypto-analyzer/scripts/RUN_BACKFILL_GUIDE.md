# 15分钟K线数据回填指南
## Quick Start Guide for 15m K-line Data Backfill

---

## 前置条件 / Prerequisites

1. **Windows 本地环境** - 数据库在 Windows 本地
2. **Python 环境** - 已安装 Python 3.9+
3. **依赖安装** - 已运行 `pip install -r requirements.txt`
4. **数据库运行** - MySQL 服务正在运行
5. **配置文件** - `config.yaml` 已正确配置

---

## 运行步骤 / Steps to Run

### 1. 打开命令行 / Open Command Prompt

在项目根目录打开 Windows 命令行或 PowerShell:

```bash
cd C:\path\to\crypto-analyzer
```

### 2. 运行回填脚本 / Run Backfill Script

```bash
python scripts/backfill_15m_data.py
```

---

## 脚本功能 / Script Features

- **采集范围**: 最近 10 小时（40条 15分钟 K线）
- **数据源**: Binance（优先）→ Gate.io（备用）
- **币种数量**: 根据 config.yaml 中的 symbols 配置
- **自动去重**: 检查已存在的数据，避免重复插入
- **数据验证**: 完成后自动验证数据充足性
- **立即可用**: 40条数据已满足 EMA(31条) 需求

---

## 预期输出 / Expected Output

```
================================================================================
🔄 回填最近5小时的 15分钟 K线数据
================================================================================

📊 监控币种: 16 个
   - BTC/USDT
   - ETH/USDT
   ...

⏰ 时间范围: 最近 10 小时
📈 时间周期: 15m
🏦 交易所: Binance, Gate.io
📦 预计采集: 16 币种 × 40 条 = 640 条数据

✅ 数据库服务初始化成功

================================================================================
开始采集数据...
================================================================================

📊 处理 BTC/USDT...
   ✓ Binance: 获取 40 条数据
   ✅ 保存 40 条新数据到数据库

📊 处理 ETH/USDT...
   ✓ Binance: 获取 40 条数据
   ✅ 保存 40 条新数据到数据库

...

================================================================================
📊 数据回填完成
================================================================================

✅ 成功保存: 640 条数据
❌ 失败: 0 个币种

================================================================================
🔍 数据验证
================================================================================

币种             15m数据量     状态
--------------------------------------------------
BTC/USDT         40           ✅ 充足
ETH/USDT         40           ✅ 充足
...

================================================================================
✅ 回填完成！现在可以运行 EMA 信号监控了
================================================================================

💡 下一步:
   1. 运行测试: python test_ema_signal.py
   2. 启动监控: python app/scheduler.py
```

---

## 数据说明 / Data Notes

### 数据充足性 / Data Sufficiency

- **10小时 = 40个15分钟周期**
- EMA 信号需要 **至少31条** K线数据
- **40条数据已满足需求** ✅
- 立即可以启用 EMA 信号监控，无需等待

### 后续数据采集 / Ongoing Collection

启动调度器后，系统会自动:
- **每15分钟** 采集一次 15m K线数据
- 持续更新保持数据最新
- EMA 信号监控持续运行

```bash
python app/scheduler.py
```

---

## 常见问题 / Troubleshooting

### 1. 数据库连接失败

```
❌ 错误: (2003, "Can't connect to MySQL server...")
```

**解决方案**:
- 检查 MySQL 服务是否启动
- 检查 `config.yaml` 中的数据库配置
- 确认防火墙未阻止连接

### 2. API 限流

```
⚠️  未能获取数据
```

**解决方案**:
- 脚本已内置 0.5秒延迟
- 如频繁失败，手动增加延迟时间（修改 `await asyncio.sleep(0.5)` → `1.0`）

### 3. 依赖缺失

```
ModuleNotFoundError: No module named 'xxx'
```

**解决方案**:
```bash
pip install -r requirements.txt
```

---

## 验证数据 / Verify Data

运行检查脚本确认数据已保存:

```bash
python scripts/check_klines_data.py
```

应该看到:
```
✅ 15m: XXX 条记录
```

---

## 后续步骤 / Next Steps

1. **测试 EMA 信号**:
   ```bash
   python test_ema_signal.py
   ```

2. **启动调度器**（持续采集）:
   ```bash
   python app/scheduler.py
   ```

3. **等待数据积累**:
   - 运行 2-3 小时后，数据量达到 31+ 条
   - EMA 信号监控自动生效

---

## 扩展数据范围（可选）/ Extend Data Range (Optional)

如需更多历史数据用于回测或分析，可修改脚本:

**文件**: `scripts/backfill_15m_data.py`

**修改行 84 和 98**:
```python
# 当前:
limit=40  # 最近40条（10小时）

# 可改为更大值，例如:
limit=100  # 最近100条（25小时，约1天）
limit=200  # 最近200条（50小时，约2天）
```

注意：更大的 limit 可能增加 API 请求时间。

---

## 技术支持 / Support

如遇到问题:
1. 查看日志输出的错误信息
2. 运行诊断脚本: `python scripts/diagnose_kline_query.py`
3. 检查数据库表结构: `python scripts/check_klines_data.py`

---

**最后更新**: 2025-10-28
**脚本版本**: v1.0
