# 合约K线数据补采集脚本使用说明

## 功能说明

`backfill_klines.py` 用于补采集合约历史K线数据到数据库。

### 特点

- ✅ 支持多时间周期：`5m`、`15m`、`1h`、`1d`
- ✅ 自动读取 `config.yaml` 中的所有交易对
- ✅ 从 Binance Futures API 获取数据
- ✅ 智能分批请求（避免API限制）
- ✅ 自动去重（使用 `ON DUPLICATE KEY UPDATE`）
- ✅ 进度显示和数据验证

## 使用方法

### 1. 基本用法

```bash
# 补采集最近10天数据（默认）
python scripts/init/backfill_klines.py

# 补采集最近30天数据
python scripts/init/backfill_klines.py --days 30

# 补采集最近7天数据
python scripts/init/backfill_klines.py --days 7

# 查看帮助
python scripts/init/backfill_klines.py --help
```

### 2. 指定配置文件

```bash
# 使用自定义配置文件
python scripts/init/backfill_klines.py --config my_config.yaml --days 15
```

## 数据说明

### 数据存储

- **表名**：`kline_data`
- **exchange 字段**：`binance_futures`（用于区分现货/合约数据）
- **去重机制**：基于 `(symbol, exchange, timeframe, timestamp)` 唯一键

### 数据量估算

| 时间周期 | 每天数据量 | 10天数据量 | 30天数据量 |
|---------|-----------|-----------|-----------|
| 5m      | 288条     | 2,880条   | 8,640条   |
| 15m     | 96条      | 960条     | 2,880条   |
| 1h      | 24条      | 240条     | 720条     |
| 1d      | 1条       | 10条      | 30条      |

**总计（每个交易对）**：
- 10天：约 4,090条
- 30天：约 12,270条

**所有交易对（21个）**：
- 10天：约 85,890条
- 30天：约 257,670条

## 运行示例

```
================================================================================
[INFO] 合约K线数据补采集脚本
   补采集天数: 最近 10 天
   时间周期: 5m, 15m, 1h, 1d
   数据源: Binance Futures API
================================================================================

[OK] 从配置文件读取到 21 个交易对
   交易对: BTC/USDT, ETH/USDT, BNB/USDT...
[OK] 数据库连接成功: binance-data@localhost:3306

================================================================================
[START] 开始补采集最近 10 天的合约K线数据
   时间周期: 5m, 15m, 1h, 1d
   交易对数量: 21
================================================================================

[1/21] 处理交易对: BTC/USDT
--------------------------------------------------------------------------------

  [TIMEFRAME] 5m
   [FETCH] BTC/USDT 5m: 需要获取约 2880 条数据 (分 2 次请求)
      批次 1/2: 获取 1500 条，总计 1500 条
      批次 2/2: 获取 1380 条，总计 2880 条
   [OK] 成功获取 2880 条数据
      时间范围: 2025-12-16 12:00:00 ~ 2025-12-26 12:00:00
      最新价格: $89,234.50
   [SAVE] 保存完成: 2880 条数据写入数据库

...（省略其他交易对）

================================================================================
[SUCCESS] 补采集完成
================================================================================
总耗时: 123.45 秒
总共获取: 85890 条K线数据
成功保存: 85890 条新数据
平均速度: 695.67 条/秒
================================================================================

[VERIFY] 验证数据完整性...
================================================================================

[SYMBOL] BTC/USDT:
   [OK] 5m   |  2880 条 | 覆盖  10 天 | 2025-12-16 ~ 2025-12-26
   [OK] 15m  |   960 条 | 覆盖  10 天 | 2025-12-16 ~ 2025-12-26
   [OK] 1h   |   240 条 | 覆盖  10 天 | 2025-12-16 ~ 2025-12-26
   [OK] 1d   |    10 条 | 覆盖  10 天 | 2025-12-16 ~ 2025-12-26

...（其他交易对验证结果）
```

## 注意事项

### 1. 环境要求

- Python 3.8+
- 依赖包：`pymysql`, `requests`, `pyyaml`, `python-dotenv`
- 数据库：MySQL 5.7+
- 网络：能访问 Binance API（`fapi.binance.com`）

### 2. 配置要求

- `.env` 文件必须存在且包含数据库密码
- `config.yaml` 中必须配置交易对列表

### 3. API限制

- Binance API 单次最多返回 1500 条数据
- 脚本自动分批请求，无需手动处理
- 请求间有延迟（0.2-0.5秒），避免触发限流

### 4. 数据安全

- 使用 `ON DUPLICATE KEY UPDATE` 自动去重
- 可以多次运行补全缺失数据，不会重复插入
- 重复数据会更新而不是新增

## 常见问题

### Q1: 连接数据库失败

```
[ERROR] 数据库连接失败: (1045, "Access denied for user 'root'@'localhost' (using password: NO)")
```

**解决方案**：检查 `.env` 文件是否存在且包含正确的 `DB_PASSWORD`

### Q2: 获取数据失败

```
[ERROR] 网络请求失败: HTTPSConnectionPool...
```

**解决方案**：
1. 检查网络连接
2. 确认能访问 `https://fapi.binance.com`
3. 如使用代理，检查代理配置

### Q3: 数据不完整

**解决方案**：重新运行脚本补全缺失数据，脚本会自动跳过已存在的数据

### Q4: Windows中文乱码

这是Windows终端编码问题，不影响脚本功能。数据依然正常保存到数据库。

## 相关脚本

- `fetch_initial_klines.py` - 初始化数据采集（旧版，仅支持1h）
- `add_entry_signal_type.py` - 数据库迁移脚本
- `add_entry_signal_type.sql` - SQL迁移脚本

## 技术支持

如遇问题，请检查：
1. 日志输出中的具体错误信息
2. 数据库连接配置
3. 网络连接状态
4. Binance API可用性

## 更新日志

### v1.0.0 (2025-12-26)

- ✅ 支持 5m、15m、1h、1d 四个时间周期
- ✅ 自动从 config.yaml 读取交易对
- ✅ 智能分批请求（避免API限制）
- ✅ 自动去重机制
- ✅ 完整的进度显示和验证
- ✅ 支持 .env 环境变量配置
