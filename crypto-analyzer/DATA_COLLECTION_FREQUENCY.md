# 数据采集与缓存更新频率配置

## 📊 当前配置总览

本系统已针对**数据及时性**进行优化，确保投资决策基于最新市场数据。

---

## 🔄 数据采集频率

### 1. 现货价格数据 (Binance + Gate.io)

| 时间周期 | 采集频率 | 延迟 | 说明 |
|---------|---------|------|------|
| **1分钟K线** | ⚡ 每1分钟 | <10秒 | 实时价格跟踪 |
| **5分钟K线** | 每5分钟 | <30秒 | 短期趋势分析 |
| 1小时K线 | 每1小时 | <1分钟 | 中期趋势分析 |
| 1天K线 | 每天00:05 | 5分钟 | 长期趋势分析 |

**及时性评估**: ✅ **优秀**
- 1分钟K线每分钟更新，确保价格数据几乎实时
- 包含：开盘价、最高价、最低价、收盘价、成交量、**成交额(quote_volume)**

---

### 2. 合约数据 (Binance Futures)

| 数据类型 | 采集频率 | 延迟 | 说明 |
|---------|---------|------|------|
| **合约价格** | ⚡ 每1分钟 | <10秒 | 实时合约价格 |
| **资金费率** | ⚡ 每1分钟 | <10秒 | 市场情绪指标 |
| **持仓量** | ⚡ 每1分钟 | <10秒 | 市场活跃度 |
| **多空比** | ⚡ 每1分钟 | <10秒 | 交易者情绪 |
| 合约K线 | ⚡ 每1分钟 | <10秒 | 技术分析 |

**及时性评估**: ✅ **优秀**
- 所有合约数据每分钟更新，捕捉市场情绪变化

---

### 3. 新闻与情绪数据

| 数据类型 | 采集频率 | 延迟 | 说明 |
|---------|---------|------|------|
| 加密新闻 | 每15分钟 | <1分钟 | 重大事件追踪 |
| 新闻情绪分析 | 每15分钟 | <1分钟 | 市场情绪评估 |

**及时性评估**: ✅ **良好**
- 15分钟频率足够捕捉重大新闻
- 可选优化：调整为每5-10分钟（如需要）

---

### 4. Hyperliquid 聪明钱追踪

| 数据类型 | 采集频率 | 延迟 | 说明 |
|---------|---------|------|------|
| 聪明钱排行榜 | 每天02:00 | 2小时 | 发现高盈利交易者 |
| **钱包监控** | 每30分钟 | <5分钟 | 追踪聪明钱动向 |

**及时性评估**: ⚠️ **可优化**
- 钱包监控30分钟更新，对于快速市场可能略慢
- **建议优化**: 改为每10-15分钟

---

### 5. Ethereum 链上聪明钱

| 数据类型 | 采集频率 | 延迟 | 说明 |
|---------|---------|------|------|
| 5分钟链上交易 | 每5分钟 | <1分钟 | 短期聪明钱活动 |
| 1小时链上交易 | 每1小时 | <5分钟 | 中期趋势 |
| 1天链上交易 | 每天00:10 | 10分钟 | 长期趋势 |

**及时性评估**: ✅ **良好**
- 5分钟频率能捕捉链上大额交易

---

## 🚀 缓存更新频率 (性能优化)

### 为什么需要缓存？
原始数据→计算分析→存储缓存→API快速响应
- 直接查询：5-15秒 ❌
- 缓存查询：<500ms ✅

### 缓存更新策略

| 缓存类型 | 更新频率 | 数据延迟 | 内容 |
|---------|---------|---------|------|
| **价格统计缓存** | ⚡ 每1分钟 | 1-2分钟 | 24h价格、涨跌幅、成交量 |
| **分析缓存** | ⚡ 每5分钟 | 5-6分钟 | 技术指标、投资建议 |
| Hyperliquid缓存 | 每10分钟 | 10-11分钟 | 聪明钱净流入、多空比 |

#### 详细说明：

**1. 价格统计缓存 (每1分钟)**
- 表：`price_stats_24h`
- 内容：当前价格、24h涨跌幅、24h最高/最低、成交量
- 延迟：**1-2分钟**
- 评估：✅ **优秀** - 基本实时

**2. 分析缓存 (每5分钟)**
包含以下表：
- `technical_indicators_cache` - RSI、MACD、EMA、布林带
- `news_sentiment_aggregation` - 新闻情绪评分
- `funding_rate_stats` - 资金费率统计
- `investment_recommendations_cache` - 🎯 **投资建议（含ETF因素）**

- 延迟：**5-6分钟**
- 评估：✅ **良好** - 技术分析不需要秒级更新

**3. Hyperliquid缓存 (每10分钟)**
- 表：`hyperliquid_symbol_aggregation`
- 内容：聪明钱净流入、活跃钱包、平均盈亏
- 延迟：**10-11分钟**
- 评估：✅ **可接受** - 聪明钱动向相对稳定

---

## ⚡ 数据流时间线（最坏情况）

以BTC投资建议为例：

```
现在时间: 14:00:00
├─ 14:00:10  现货价格采集 (1分钟K线)
├─ 14:00:15  合约数据采集 (资金费率、持仓量)
├─ 14:01:00  价格统计缓存更新
├─ 14:05:00  分析缓存更新 (技术指标+投资建议)
│              ↓ 包含ETF因素评分
└─ 14:05:30  用户刷新Dashboard看到最新建议

总延迟: 5分30秒
```

**实际情况更快**：
- 如果14:04:00采集了数据
- 14:05:00缓存更新
- 总延迟只有1-2分钟

---

## 📈 及时性优化建议

### 当前配置已经很优秀，但如果需要更极致的及时性：

### 🎯 高频交易场景（可选优化）

| 优化项 | 当前 | 建议 | 提升 |
|-------|------|------|------|
| 分析缓存 | 5分钟 | **3分钟** | 延迟从5分钟→3分钟 |
| Hyperliquid监控 | 30分钟 | **15分钟** | 更快捕捉聪明钱 |
| 新闻采集 | 15分钟 | **10分钟** | 更快获取重大新闻 |

### 实施方法：

修改 `app/scheduler.py`:

```python
# 当前：每5分钟
schedule.every(5).minutes.do(
    lambda: asyncio.run(self.update_analysis_cache())
)

# 优化：改为每3分钟
schedule.every(3).minutes.do(
    lambda: asyncio.run(self.update_analysis_cache())
)
```

---

## 🔍 监控数据及时性

### 方法1：查看日志
```bash
# 查看最近的缓存更新日志
tail -f logs/app.log | grep "缓存更新"
```

### 方法2：Dashboard显示
- 页面右上角显示："最后更新: 14:05:23"
- 如果超过10分钟未更新，说明调度器可能停止

### 方法3：手动触发更新
```bash
# 立即更新所有缓存（包括ETF投资建议）
python update_recommendations_with_etf.py
```

---

## 💡 关键结论

### ✅ 当前配置评估：**优秀**

**数据及时性**：
- 价格数据：**1-2分钟延迟** ⚡
- 技术分析：**5-6分钟延迟** ✅
- 投资建议：**5-6分钟延迟** ✅（包含ETF因素）

**对投资决策的影响**：
- ✅ 价格几乎实时（1分钟更新）
- ✅ 技术指标5分钟更新足够（RSI、MACD变化较慢）
- ✅ 投资建议综合多维度，5分钟频率合理
- ✅ ETF数据每日更新（ETF本身T+1结算）

**性能与及时性平衡**：
- API响应：<500ms ⚡
- 数据库负载：低
- CPU占用：<5%
- 数据延迟：5-6分钟 ✅

### 🎯 推荐配置（无需修改）

**当前配置已经很好！** 除非你需要：
1. 高频交易（秒级决策）→ 建议改为3分钟缓存
2. 极端市场波动监控 → 建议改为1分钟缓存（⚠️ 性能开销大）

---

## 📞 常见问题

**Q: 为什么投资建议不是实时的？**
A: 投资建议综合6个维度（技术+新闻+资金费率+Hyperliquid+以太坊+ETF），需要计算时间。5分钟更新已经足够及时。

**Q: 我看到价格变了，但建议没变？**
A: 正常现象。价格每1分钟更新，但投资建议每5分钟更新。小幅价格波动不会立即改变投资建议。

**Q: ETF数据多久更新一次？**
A: ETF原始数据每日采集（交易日），汇总后投资建议每5分钟重新计算一次（使用最新的ETF汇总数据）。

**Q: 如何确认系统正在运行？**
A: 查看Dashboard右上角"最后更新"时间，应该在5-10分钟内。

**Q: 紧急情况下如何立即更新？**
A: 运行 `python update_recommendations_with_etf.py` 立即更新BTC和ETH的投资建议。

---

**最后更新**: 2025-10-27
**系统版本**: v2.0 (含ETF集成)
