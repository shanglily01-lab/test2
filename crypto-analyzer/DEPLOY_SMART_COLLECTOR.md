# 智能采集器部署指南

**日期**: 2026-01-23
**目的**: 将数据采集服务升级为智能分层策略，节省93.5%采集资源

---

## 当前状态

服务器上正在运行旧的 `FastFuturesCollector`：

```bash
ps aux | grep fast_collector
# 找到进程ID: <pid>

tail -f /tmp/fast_collector.log
# 显示: 每5分钟采集6835条K线（浪费95.6%）
```

---

## 部署步骤

### 1. 拉取最新代码

```bash
cd /home/test2/crypto-analyzer
git pull origin master
```

### 2. 停止旧服务

```bash
# 查找进程
ps aux | grep fast_collector_service.py

# 停止进程（替换<pid>为实际进程号）
kill <pid>

# 确认已停止
ps aux | grep fast_collector_service.py
```

### 3. 启动新服务

```bash
# 启动智能采集服务
nohup python fast_collector_service.py > /tmp/smart_collector.log 2>&1 &

# 查看进程
ps aux | grep fast_collector_service.py
```

### 4. 验证效果

```bash
# 实时查看日志
tail -f /tmp/smart_collector.log
```

**预期日志输出**:

**第1次采集（首次启动，采集所有周期）**:
```
🧠 开始智能数据采集周期（分层策略）
目标: 45 个交易对
✅ 采集 5m K线 (每个交易对1条，距上次 首次)...
   成功获取 45 条 5m K线
✅ 采集 15m K线 (每个交易对1条，距上次 首次)...
   成功获取 45 条 15m K线
✅ 采集 1h K线 (每个交易对100条，距上次 首次)...
   成功获取 4500 条 1h K线
✅ 采集 1d K线 (每个交易对50条，距上次 首次)...
   成功获取 2250 条 1d K线
✓ 保存 6840 条K线数据，影响 6840 行
✓ 采集周期完成，耗时 4.5 秒
  本次采集: 5m, 15m, 1h, 1d
  总K线数: 6840
```

**第2次采集（5分钟后，只采集5m）**:
```
【第 2 次采集】
🧠 开始智能数据采集周期（分层策略）
目标: 45 个交易对
✅ 采集 5m K线 (每个交易对1条，距上次 5分钟)...
   成功获取 45 条 5m K线
⏭️  跳过 15m K线 (距上次仅 5分钟，无需采集)
⏭️  跳过 1h K线 (距上次仅 5分钟，无需采集)
⏭️  跳过 1d K线 (距上次仅 5分钟，无需采集)
✓ 保存 45 条K线数据，影响 45 行
✓ 采集周期完成，耗时 0.8 秒
  本次采集: 5m
  总K线数: 45
  ⚡ 智能跳过 3 个周期，节省 75% 采集资源
```

**第3次采集（15分钟后，采集5m+15m）**:
```
【第 3 次采集】
🧠 开始智能数据采集周期（分层策略）
目标: 45 个交易对
✅ 采集 5m K线 (每个交易对1条，距上次 5分钟)...
   成功获取 45 条 5m K线
✅ 采集 15m K线 (每个交易对1条，距上次 15分钟)...
   成功获取 45 条 15m K线
⏭️  跳过 1h K线 (距上次仅 15分钟，无需采集)
⏭️  跳过 1d K线 (距上次仅 15分钟，无需采集)
✓ 保存 90 条K线数据，影响 90 行
✓ 采集周期完成，耗时 1.2 秒
  本次采集: 5m, 15m
  总K线数: 90
  ⚡ 智能跳过 2 个周期，节省 50% 采集资源
```

---

## 对比验证

### 旧服务（每次6840条）
```
【第 1 次采集】
成功获取 45 条 5m K线
成功获取 45 条 15m K线
成功获取 4500 条 1h K线
成功获取 2245 条 1d K线
✓ 保存 6835 条K线数据

【第 2 次采集】（5分钟后）
成功获取 45 条 5m K线
成功获取 45 条 15m K线        ← 浪费（15m未更新）
成功获取 4500 条 1h K线       ← 浪费（1h未更新）
成功获取 2245 条 1d K线       ← 浪费（1d未更新）
✓ 保存 6835 条K线数据         ← 其中6790条是无效的
```

### 新服务（智能采集）
```
【第 1 次采集】
采集 5m, 15m, 1h, 1d → 6840条

【第 2 次采集】（5分钟后）
采集 5m → 45条                ← 节省6795条
跳过 15m, 1h, 1d

【第 3 次采集】（15分钟后）
采集 5m, 15m → 90条           ← 节省6750条
跳过 1h, 1d
```

---

## 性能监控

### 数据库查询

```sql
-- 查看最近1小时的K线采集量
SELECT
    timeframe,
    COUNT(*) as count,
    COUNT(DISTINCT symbol) as symbols,
    MAX(created_at) as latest
FROM kline_data
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
AND exchange = 'binance_futures'
GROUP BY timeframe
ORDER BY timeframe;
```

**旧服务（1小时 = 12次采集）**:
```
timeframe | count  | symbols | latest
----------|--------|---------|-------------------
5m        | 540    | 45      | 2026-01-23 09:55
15m       | 540    | 45      | 2026-01-23 09:55  ← 浪费450条
1h        | 54000  | 45      | 2026-01-23 09:55  ← 浪费49500条
1d        | 27000  | 45      | 2026-01-23 09:55  ← 浪费26955条
```

**新服务（1小时 = 12次检查，智能采集）**:
```
timeframe | count  | symbols | latest
----------|--------|---------|-------------------
5m        | 540    | 45      | 2026-01-23 09:55  ← 12次采集
15m       | 180    | 45      | 2026-01-23 09:55  ← 4次采集
1h        | 4500   | 45      | 2026-01-23 09:55  ← 1次采集
1d        | 0      | 0       | NULL              ← 0次采集（未到1天）
```

### 日志文件大小

```bash
# 旧日志（每5分钟6840条）
ls -lh logs/fast_collector_*.log
# 预期: 每天约100MB

# 新日志（智能跳过）
ls -lh logs/smart_collector_*.log
# 预期: 每天约10MB（节省90%）
```

---

## 回滚方案

如果发现问题，可以快速回滚：

```bash
# 1. 停止新服务
kill <pid>

# 2. 恢复旧代码
git checkout HEAD~1 fast_collector_service.py

# 3. 启动旧服务
nohup python fast_collector_service.py > /tmp/fast_collector.log 2>&1 &
```

---

## 常见问题

### Q1: 会不会漏掉K线数据？

**A**: 不会。每个时间周期都会在正确的时间采集：
- 5m: 每5分钟
- 15m: 每15分钟
- 1h: 每1小时
- 1d: 每1天

### Q2: 首次启动会采集所有历史数据吗？

**A**: 是的。首次启动时：
- 5m: 1条
- 15m: 1条
- 1h: 100条
- 1d: 50条

之后按照智能策略采集。

### Q3: 如果服务重启，会重复采集吗？

**A**: 会的，因为采集时间存储在内存中。但这是可以接受的：
1. 重启不频繁
2. `ON DUPLICATE KEY UPDATE` 确保数据不会重复
3. 仅首次采集会多一些，之后恢复智能模式

### Q4: 超级大脑会受影响吗？

**A**: 完全不会。超级大脑读取的K线数据完整性不变，只是采集策略更智能了。

---

## 成功标志

部署成功后，应该看到：

✅ 日志显示 "🧠 智能数据采集周期"
✅ 大部分采集周期显示 "⏭️ 跳过"
✅ 显示 "⚡ 智能跳过 X 个周期，节省 XX% 采集资源"
✅ 每小时采集量从82,080条降至7,470条
✅ 数据库K线数据持续更新（无中断）
✅ 超级大脑正常工作（无异常）

---

**部署时间**: 2026-01-23
**预期停机**: < 1分钟（仅服务重启）
**风险等级**: 低
**回滚时间**: < 1分钟
