# 模拟盘数据重置脚本使用说明

## 功能说明

`reset_paper_trading.py` 脚本用于清空模拟盘的所有数据并重置账户资金到初始状态。

## 清理的数据

此脚本会清空以下数据：

1. **模拟盘持仓数据** (`futures_positions`)
   - 所有未平仓和已平仓的持仓记录

2. **模拟盘交易历史** (`futures_trades`)
   - 所有历史交易记录

3. **模拟盘订单数据** (`futures_orders`)
   - 所有订单记录（包括已成交、已取消、待成交）

4. **回测数据** (`backtest_results`, `backtest_trades`)
   - 所有回测结果和回测交易明细

5. **策略资金管理记录** (`strategy_capital_management`)
   - 所有策略的资金分配记录

6. **账户资金重置**
   - 余额重置为初始值
   - 可用资金重置为初始值
   - 冻结资金清零
   - 总盈亏清零
   - 交易统计清零（总交易数、胜率等）

## 使用方法

### 1. 基本使用（默认值）

```bash
python reset_paper_trading.py
```

- 默认账户ID: 1
- 默认初始资金: 10,000 USDT

### 2. 指定账户ID

```bash
python reset_paper_trading.py --account-id 1
```

### 3. 指定初始资金

```bash
python reset_paper_trading.py --initial-balance 50000
```

将账户资金重置为 50,000 USDT

### 4. 同时指定账户ID和初始资金

```bash
python reset_paper_trading.py --account-id 1 --initial-balance 50000
```

### 5. 跳过确认提示（自动化脚本）

```bash
python reset_paper_trading.py --yes
```

⚠️ **警告**：使用 `--yes` 参数会跳过确认提示，直接执行清理操作，请谨慎使用！

## 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--account-id` | 整数 | 1 | 要重置的账户ID |
| `--initial-balance` | 浮点数 | 10000.0 | 重置后的初始资金（USDT） |
| `--yes` | 标志 | False | 跳过确认提示，直接执行 |

## 执行示例

### 示例1：交互式重置（推荐）

```bash
$ python reset_paper_trading.py

======================================================================
  ⚠️  警告：此操作将清空所有模拟盘数据！
======================================================================

将要删除的数据包括：
  1. 模拟盘持仓数据 (futures_positions)
  2. 模拟盘交易历史 (futures_trades)
  3. 模拟盘订单数据 (futures_orders)
  4. 回测结果数据 (backtest_results, backtest_trades)
  5. 策略资金管理记录 (strategy_capital_management)
  6. 重置账户资金为初始值

此操作不可恢复！

确定要继续吗？(yes/no): yes

======================================================================
  开始重置模拟盘数据
======================================================================

账户ID: 1
初始资金: 10000.0 USDT
时间: 2025-12-11 06:00:00

1. 清空模拟盘持仓数据...
   ✓ 已删除 5 条持仓记录
2. 清空模拟盘交易历史...
   ✓ 已删除 120 条交易记录
3. 清空模拟盘订单数据...
   ✓ 已删除 150 条订单记录
4. 清空回测数据...
   ✓ 已删除 800 条回测交易记录
   ✓ 已删除 10 条回测结果
5. 清空策略资金管理记录...
   ✓ 已删除 3 条资金管理记录
6. 重置账户资金...
   ✓ 账户资金已重置为 10000.0 USDT

======================================================================
  ✅ 模拟盘数据重置完成！
======================================================================

数据清理汇总：
  • 持仓记录: 5 条
  • 交易记录: 120 条
  • 订单记录: 150 条
  • 回测结果: 10 条
  • 回测交易: 800 条
  • 资金管理: 3 条

账户状态：
  • 账户ID: 1
  • 当前余额: 10000.0 USDT
  • 可用资金: 10000.0 USDT
  • 冻结资金: 0 USDT

提示：重启交易服务以确保数据同步。
```

### 示例2：使用自定义初始资金

```bash
python reset_paper_trading.py --initial-balance 100000
```

将账户资金重置为 100,000 USDT

### 示例3：自动化执行（脚本中调用）

```bash
python reset_paper_trading.py --account-id 1 --initial-balance 10000 --yes
```

## 注意事项

### ⚠️ 重要警告

1. **数据不可恢复**：此操作会永久删除所有模拟盘数据，请确保已备份重要数据！

2. **影响范围**：
   - ✅ 只影响模拟盘数据
   - ✅ 不影响实盘数据
   - ✅ 不影响策略配置
   - ✅ 不影响市场数据

3. **执行前确认**：
   - 确保当前没有运行中的交易策略
   - 确保没有未平仓的重要持仓
   - 建议在维护窗口执行

### 📋 最佳实践

1. **执行前备份**（可选）
   ```bash
   # 备份数据库
   mysqldump -u admin -p binance-data > backup_$(date +%Y%m%d_%H%M%S).sql
   ```

2. **执行后重启服务**
   ```bash
   # 重启交易服务
   sudo systemctl restart crypto-analyzer
   ```

3. **验证重置结果**
   - 登录Web界面查看账户余额
   - 检查持仓列表是否为空
   - 检查交易历史是否已清空

## 故障排除

### 问题1：脚本执行失败

**错误信息**：`❌ 重置失败: ...`

**解决方法**：
1. 检查数据库连接配置（config.yaml）
2. 确保数据库服务正在运行
3. 检查数据库用户权限

### 问题2：账户不存在

**错误信息**：`⚠️ 警告：账户ID X 不存在，尝试创建...`

**说明**：脚本会自动创建不存在的账户

### 问题3：外键约束错误

**错误信息**：`Cannot delete or update a parent row: a foreign key constraint fails`

**解决方法**：
- 脚本已处理外键关联（先删除子表数据）
- 如果仍然出错，请检查数据库完整性

## 恢复操作

如果误操作需要恢复数据：

1. **从备份恢复**（如果有备份）
   ```bash
   mysql -u admin -p binance-data < backup_YYYYMMDD_HHMMSS.sql
   ```

2. **重新初始化**（如果没有备份）
   - 账户资金已重置，但无法恢复历史数据
   - 需要重新开始交易积累数据

## 相关文件

- 脚本文件: `reset_paper_trading.py`
- 配置文件: `config.yaml`
- 数据库: `binance-data`

## 技术支持

如有问题，请检查：
1. 日志文件中的错误信息
2. 数据库连接状态
3. 配置文件正确性

---

**最后更新**: 2025-12-11
