# 评分系统优化说明

**优化时间**: 2026-02-08
**原因**: 评分标准过于严格，导致优质做多/做空机会无法开仓
**目标**: 提高开仓率，同时保持信号质量

---

## 问题分析

### 优化前的问题

根据实际日志分析：

**BTC/USDT LONG** - 明显的做多趋势，但总分仅5/42 (11.9%)
- Big4: BULLISH强度16，但得分0
- 5H趋势: 0分
- 15M信号: 0分
- 量价配合: 1分
- 技术指标: 4分
- **结果**: ❌ 不可开仓 (阈值26分)

**APT/USDT LONG** - Big4强势看多，但总分仅20/42 (47.6%)
- Big4: 5分 ✅
- 5H趋势: 0分
- 15M信号: 9分
- 量价配合: 0分
- 技术指标: 6分
- **结果**: ❌ 不可开仓 (阈值26分)

### 核心问题

1. **阈值过高**: 26/42 (62%) 太难达到
2. **5H趋势过严**: 需要连续3根同向K线（15小时）
3. **15M信号过严**: 需要8根中≥6根阳线/阴线
4. **缺乏容错**: 稍微不完美的信号就0分

---

## 优化方案

### 1. 降低开仓阈值 ✅

```python
# 优化前
self.min_score_to_trade = 26  # 62%

# 优化后
self.min_score_to_trade = 18  # 43%
```

**效果**: 降低8分 (19%)，大幅提高开仓率

---

### 2. 优化5H趋势评分 ✅

#### 优化前（连续3根）

```python
# 统计最近3根K线
bull_count = sum(1 for k in klines_5h[:3] if k['close'] > k['open'])

if position_side == 'LONG':
    if bull_count == 3:  # 连续3根阳线（15小时）
        return 6.0
    elif bull_count == 2:
        return 3.0
    # 其他: 0分
```

**问题**: 连续3根5H阳线（15小时）趋势都走完了，入场太晚

#### 优化后（5根中有N根）

```python
# 统计最近5根K线（25小时窗口）
bull_count = sum(1 for k in klines_5h[:5] if k['close'] > k['open'])

if position_side == 'LONG':
    if bull_count >= 4:  # 5根中≥4根阳线
        return 6.0
    elif bull_count >= 3:  # 5根中≥3根阳线
        return 4.0  # 之前3分，现在4分
    elif bull_count >= 2:  # 5根中≥2根阳线（新增）
        return 2.0
```

**效果**:
- 不要求连续，允许中间有阴线
- 扩大观察窗口到25小时
- 降低门槛：2根阳线也给2分

---

### 3. 优化15M信号评分 ✅

#### 优化前

```python
# 最近8根15M K线（2小时）
if position_side == 'LONG':
    if bull_count >= 6:  # ≥6根阳线
        return 14.0
    elif bull_count >= 5:  # ≥5根阳线
        return 9.0
    elif bull_count >= 4:  # ≥4根阳线
        return 5.0
    # 其他: 0分
```

**问题**: 8根中需要≥6根阳线才满分，太难达到

#### 优化后

```python
if position_side == 'LONG':
    if bull_count >= 6:
        return 14.0
    elif bull_count >= 5:
        return 10.0  # 优化: 9→10
    elif bull_count >= 4:
        return 7.0   # 优化: 5→7
    elif bull_count >= 3:  # 新增
        return 4.0
```

**效果**:
- 5根阳线从9分提高到10分
- 4根阳线从5分提高到7分
- 3根阳线也给4分（新增）
- 更容易获得中等分数

---

## 优化前后对比

### BTC/USDT LONG 案例

假设：
- Big4: BULLISH强度16
- 5H: 5根中有3根阳线
- 15M: 8根中有4根阳线
- 量价: 1分
- 技术指标: 4分

#### 优化前

| 项目 | 得分 | 原因 |
|------|------|------|
| Big4 | 5分 | BULLISH强度16 ✅ |
| 5H趋势 | 0分 | 需要连续3根，但只有3/5 ❌ |
| 15M信号 | 5分 | 4根阳线 |
| 量价配合 | 1分 | |
| 技术指标 | 4分 | |
| **总分** | **15/42** | **36%** ❌ |
| **阈值** | 26分 (62%) | **不可开仓** |

#### 优化后

| 项目 | 得分 | 原因 |
|------|------|------|
| Big4 | 5分 | BULLISH强度16 ✅ |
| 5H趋势 | 4分 | 5根中有3根阳线 ✅ |
| 15M信号 | 7分 | 4根阳线（优化：5→7）✅ |
| 量价配合 | 1分 | |
| 技术指标 | 4分 | |
| **总分** | **21/42** | **50%** ✅ |
| **阈值** | 18分 (43%) | **可以开仓** |

**改善**: 15分 → 21分 (+40%)，从不可开仓变为可开仓！

---

### APT/USDT LONG 案例

假设：
- Big4: 5分
- 5H: 5根中有2根阳线（之前0分）
- 15M: 9分（5根阳线，之前9分现在10分）
- 量价: 0分
- 技术指标: 6分

#### 优化前
- 总分: 5 + 0 + 9 + 0 + 6 = **20/42 (48%)** ❌

#### 优化后
- 总分: 5 + 2 + 10 + 0 + 6 = **23/42 (55%)** ✅

**改善**: 20分 → 23分 (+15%)，可以开仓

---

## 预期效果

### 开仓率提升

| 指标 | 优化前 | 优化后 | 变化 |
|------|--------|--------|------|
| **开仓阈值** | 26分 (62%) | 18分 (43%) | -8分 (-19%) |
| **5H给分难度** | 很难 | 中等 | ↓↓ |
| **15M给分难度** | 很难 | 较容易 | ↓↓ |
| **预计开仓率** | ~10% | ~30-40% | **+3-4倍** |

### 信号质量保障

虽然降低了阈值，但核心质量保障依然有效：

1. **Big4否决权**: Big4方向不一致仍然0分
2. **最低要求**: 仍需18分（43%），不是无门槛
3. **多维度**: 仍需多个维度配合才能达标

**最低开仓组合示例**:
- Big4: 5分 + 5H: 4分 + 15M: 7分 + 技术指标: 2分 = 18分 ✅
- Big4: 5分 + 5H: 2分 + 15M: 10分 + 量价: 1分 = 18分 ✅

---

## 风险评估

### 潜在风险

1. **假信号增加**
   - 降低阈值可能带来更多假信号
   - **缓解**: 仍有43%门槛，不是无限制

2. **盈亏比下降**
   - 更多边缘信号可能盈亏比较差
   - **缓解**: Big4和15M主导权重仍在

3. **频繁交易**
   - 开仓率提升可能导致过度交易
   - **缓解**: 最多10个仓位限制

### 监控指标

优化后需密切监控：

1. **胜率变化**
   - 目标: 保持≥55%
   - 警戒: <50%需要调整

2. **盈亏比**
   - 目标: 保持≥0.7:1
   - 警戒: <0.6:1需要调整

3. **开仓率**
   - 目标: 提升到20-40%
   - 警戒: >60%可能过度交易

---

## 回滚方案

如果优化效果不佳，快速回滚：

```python
# 回滚到优化前参数
self.min_score_to_trade = 26  # 恢复原阈值

# 5H趋势评分（恢复连续3根）
if len(klines_5h) < 3:
    return 0.0
bull_count = sum(1 for k in klines_5h[:3] if k['close'] > k['open'])
if bull_count == 3:
    return 6.0
elif bull_count == 2:
    return 3.0

# 15M信号评分（恢复原逻辑）
if bull_count >= 6:
    return 14.0
elif bull_count >= 5:
    return 9.0
elif bull_count >= 4:
    return 5.0
```

---

## 下一步行动

1. ✅ **已完成**: 代码优化并提交
2. ⏳ **进行中**: 观察实际运行效果（24-48小时）
3. ⏳ **待执行**: 根据实盘数据微调参数

**观察要点**:
- 开仓频率是否提升
- 胜率是否保持稳定
- 盈亏比是否下降
- BTC等主流币是否能及时入场

---

**优化完成时间**: 2026-02-08
**生效时间**: 重启服务后立即生效
**评估周期**: 48小时
