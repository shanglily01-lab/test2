# 交易方向控制功能

## 功能说明

系统已添加**交易方向控制**功能，可以灵活控制是否允许做多或做空。

当某个方向被禁止时，系统会自动过滤掉该方向的所有交易信号，不会执行开仓操作。

## 配置位置

设置存储在 `adaptive_params` 表中：
- `allow_long`: 是否允许做多 (1=允许, 0=禁止)
- `allow_short`: 是否允许做空 (1=允许, 0=禁止)

## 使用方法

### 方法1: 使用管理脚本（推荐）

```bash
# 查看当前设置
python set_trading_direction.py status

# 启用/禁用做多
python set_trading_direction.py enable-long
python set_trading_direction.py disable-long

# 启用/禁用做空
python set_trading_direction.py enable-short
python set_trading_direction.py disable-short

# 同时控制
python set_trading_direction.py enable-both    # 启用做多和做空
python set_trading_direction.py disable-both   # 禁用做多和做空

# 仅做多模式（禁用做空）
python set_trading_direction.py only-long

# 仅做空模式（禁用做多）
python set_trading_direction.py only-short
```

### 方法2: 直接修改数据库

```sql
-- 禁止做多
UPDATE adaptive_params SET param_value = 0 WHERE param_key = 'allow_long';

-- 禁止做空
UPDATE adaptive_params SET param_value = 0 WHERE param_key = 'allow_short';

-- 启用做多
UPDATE adaptive_params SET param_value = 1 WHERE param_key = 'allow_long';

-- 启用做空
UPDATE adaptive_params SET param_value = 1 WHERE param_key = 'allow_short';
```

## 工作原理

1. **系统启动时**: 从数据库加载 `allow_long` 和 `allow_short` 配置
2. **信号产生时**: 在执行交易前，检查该方向是否被允许
3. **方向被禁止**: 如果方向被禁止，系统会记录日志并拒绝交易
4. **实时生效**: 配置修改后，下一个交易信号会立即使用新配置

## 日志示例

当做空被禁止时，系统会输出：
```
[SIGNAL_REJECT] BTC/USDT SHORT - 系统已禁止做空
```

当做多被禁止时，系统会输出：
```
[SIGNAL_REJECT] BTC/USDT LONG - 系统已禁止做多
```

## 应用场景

1. **单边行情**: 在明显的牛市中，可以禁用做空，只做多
2. **风险控制**: 在某个方向表现不佳时，暂时禁用该方向
3. **策略测试**: 测试纯多头或纯空头策略的效果
4. **市场休息**: 临时关闭某个方向的交易

## 相关文件

- `add_direction_settings.py` - 初始化设置脚本（仅需运行一次）
- `set_trading_direction.py` - 方向设置管理脚本（日常使用）
- `app/services/optimization_config.py` - 配置读取逻辑
- `smart_trader_service.py` - 方向过滤逻辑

## 注意事项

1. ✅ 配置实时生效，无需重启服务
2. ✅ 不影响已开仓位，仅过滤新信号
3. ✅ 默认两个方向都允许
4. ⚠️ 如果两个方向都禁止，系统将不会执行任何交易
5. ⚠️ 配置会被缓存5分钟，最长可能有5分钟延迟
