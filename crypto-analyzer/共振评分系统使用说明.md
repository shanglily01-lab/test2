# 🎯 代币共振评分系统使用说明

## 📋 系统架构

```
┌─────────────────┐
│  config.yaml    │  交易对配置文件
└────────┬────────┘
         │ 同步
         ▼
┌─────────────────────────────────────────────────┐
│           MySQL数据库                            │
│                                                  │
│  ┌──────────────────┐    ┌──────────────────┐  │
│  │ trading_symbols  │    │coin_kline_scores │  │
│  │ (交易对配置表)    │    │  (评分结果表)     │  │
│  └────────┬─────────┘    └─────────▲────────┘  │
│           │                         │           │
│           │  每5分钟自动计算         │           │
│           └────────┐   ┌────────────┘           │
│                    ▼   │                        │
│          ┌──────────────────────┐               │
│          │  MySQL EVENT调度      │               │
│          │  存储过程自动执行      │               │
│          └──────────────────────┘               │
└─────────────────────────────────────────────────┘
         ▲                         │
         │ 查询                    │ 计算
         │                         ▼
┌─────────────────┐      ┌──────────────────┐
│   前端/查询      │      │   kline_data     │
│   query_*.py    │      │  (K线数据表)      │
└─────────────────┘      └──────────────────┘
```

## 🚀 快速开始

### 1. 初始化数据库

```bash
# 在MySQL中执行（创建表、存储过程、定时任务）
mysql -u root -p binance-data < setup_mysql_score_scheduler.sql
```

### 2. 同步交易对配置

```bash
# 把config.yaml中的交易对同步到数据库
python sync_symbols_to_db.py
```

### 3. 首次手动更新（可选）

```sql
-- 在MySQL中执行，立即计算一次所有代币评分
CALL update_all_coin_scores();
```

### 4. 查询评分

```bash
# 查询Top 30做多机会
python query_coin_scores.py --top 30

# 查询Top 30做空机会
python query_coin_scores.py --bottom 30

# 查询所有LONG方向代币
python query_coin_scores.py --direction LONG --limit 50
```

## 📊 数据表说明

### 1. trading_symbols（交易对配置表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| symbol | VARCHAR(20) | 交易对（如BTC/USDT） |
| exchange | VARCHAR(20) | 交易所（binance_futures） |
| enabled | TINYINT(1) | 是否启用（1=是，0=否） |

**作用：** 存储需要计算评分的交易对列表，从config.yaml同步而来。

### 2. coin_kline_scores（评分结果表）

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | VARCHAR(20) | 交易对 |
| total_score | INT | 总分（1H + 15M + 5M加分） |
| main_score | INT | 主分（1H + 15M） |
| five_m_bonus | INT | 5M反向加分 |
| h1_score | INT | 1H评分 |
| h1_bullish_count | INT | 1H阳线数 |
| h1_bearish_count | INT | 1H阴线数 |
| h1_level | VARCHAR(10) | 1H级别（强多/中多/弱多等） |
| m15_score | INT | 15M评分 |
| m15_bullish_count | INT | 15M阳线数 |
| m15_bearish_count | INT | 15M阴线数 |
| m15_level | VARCHAR(10) | 15M级别 |
| m5_bullish_count | INT | 5M阳线数 |
| m5_bearish_count | INT | 5M阴线数 |
| direction | VARCHAR(10) | 方向（LONG/SHORT/NEUTRAL） |
| strength_level | VARCHAR(10) | 强度（strong/medium/weak） |
| updated_at | TIMESTAMP | 最后更新时间 |

**作用：** 存储每个代币的实时评分结果，供前端快速查询。

## 🔧 核心组件

### MySQL存储过程

#### 1. `calculate_coin_score(symbol)`
计算单个代币的K线评分

```sql
-- 手动计算某个代币
CALL calculate_coin_score('BTC/USDT');
```

#### 2. `update_all_coin_scores()`
批量更新所有代币的评分

```sql
-- 手动触发全量更新
CALL update_all_coin_scores();
```

### MySQL定时任务

```sql
-- 事件名称
update_coin_scores_every_5min

-- 执行频率
每5分钟自动执行一次

-- 查看事件状态
SHOW EVENTS;

-- 停止定时任务
ALTER EVENT update_coin_scores_every_5min DISABLE;

-- 启动定时任务
ALTER EVENT update_coin_scores_every_5min ENABLE;
```

## 📈 评分规则

### 计算逻辑

```
1. 1H评分 = (1H阳线数 - 1H阴线数) × 5
   级别：强多(≥20)、中多(≥10)、弱多(>0)、中性(0)、弱空(<0)、中空(≤-10)、强空(≤-20)

2. 15M评分 = (15M阳线数 - 15M阴线数) × 5
   级别：同上

3. 主分 = 1H评分 + 15M评分

4. 5M反向加分：
   - 主趋势多头（主分>0）：
     * 全阴回调（3根阴） = +10分
     * 部分阴回调（2根阴） = +5分
   - 主趋势空头（主分<0）：
     * 全阳反弹（3根阳） = +10分
     * 部分阳反弹（2根阳） = +5分

5. 总分 = 主分 + 5M反向加分

6. 方向判断：
   - 总分 > 15  → LONG（强多）
   - 总分 > 5   → LONG（中多）
   - 总分 < -15 → SHORT（强空）
   - 总分 < -5  → SHORT（中空）
   - 其他       → NEUTRAL（中性）

7. 强度判断：
   - |总分| > 15 → strong
   - |总分| > 5  → medium
   - 其他        → weak
```

## 🔍 查询示例

### SQL查询

```sql
-- 1. Top 20做多机会（强多）
SELECT symbol, total_score, h1_score, m15_score, direction, strength_level
FROM coin_kline_scores
WHERE direction = 'LONG' AND strength_level = 'strong'
ORDER BY total_score DESC
LIMIT 20;

-- 2. Top 20做空机会（强空）
SELECT symbol, total_score, h1_score, m15_score, direction, strength_level
FROM coin_kline_scores
WHERE direction = 'SHORT' AND strength_level = 'strong'
ORDER BY total_score ASC
LIMIT 20;

-- 3. 查看最近更新时间
SELECT symbol, total_score, direction, updated_at
FROM coin_kline_scores
ORDER BY updated_at DESC
LIMIT 10;

-- 4. 市场情绪统计
SELECT
    direction,
    strength_level,
    COUNT(*) as count
FROM coin_kline_scores
GROUP BY direction, strength_level
ORDER BY direction, strength_level;
```

### Python查询

```bash
# 查询Top 30做多
python query_coin_scores.py --top 30

# 查询Top 30做空
python query_coin_scores.py --bottom 30

# 查询所有LONG，显示50个
python query_coin_scores.py --direction LONG --limit 50

# 查询所有代币，显示前100
python query_coin_scores.py --limit 100
```

## ⚙️ 配置调整

### 修改更新频率

```sql
-- 停止当前事件
DROP EVENT IF EXISTS update_coin_scores_every_5min;

-- 创建新的10分钟间隔事件
CREATE EVENT update_coin_scores_every_10min
ON SCHEDULE EVERY 10 MINUTE
STARTS CURRENT_TIMESTAMP
ON COMPLETION PRESERVE
ENABLE
DO
    CALL update_all_coin_scores();
```

### 添加/删除交易对

```bash
# 1. 修改config.yaml，添加或删除交易对
# 2. 重新同步
python sync_symbols_to_db.py
```

或直接在数据库操作：

```sql
-- 添加新交易对
INSERT INTO trading_symbols (symbol, exchange, enabled)
VALUES ('NEWCOIN/USDT', 'binance_futures', 1);

-- 禁用某个交易对（不删除评分）
UPDATE trading_symbols SET enabled = 0 WHERE symbol = 'OLDCOIN/USDT';

-- 启用某个交易对
UPDATE trading_symbols SET enabled = 1 WHERE symbol = 'OLDCOIN/USDT';
```

## 🎯 共振检查

### 配置文件（config.yaml）

```yaml
resonance_filter:
  enabled: true              # 启用共振过滤
  min_symbol_score: 15       # 代币最低15分
  min_big4_score: 10         # Big4最低10分
  require_same_direction: true  # 必须同向
  resonance_threshold: 25    # 共振总分≥25
```

### Python查询共振

```python
from app.services.kline_score_calculator import KlineScoreCalculator
from app.services.resonance_checker import ResonanceChecker

# 1. 从数据库查询代币评分
# SELECT * FROM coin_kline_scores WHERE symbol = 'RAY/USDT'

# 2. 计算Big4评分
big4_score = get_big4_score()  # 实现见big4_trend_analyzer

# 3. 检查共振
checker = ResonanceChecker()
result = checker.check_resonance('RAY/USDT', symbol_score, big4_score)

if result['passed']:
    print(f"✅ 共振通过: {result['reason']}")
else:
    print(f"❌ 共振失败: {result['reason']}")
```

## 📝 维护命令

```sql
-- 查看定时任务状态
SHOW EVENTS;

-- 查看存储过程
SHOW PROCEDURE STATUS WHERE Db = 'binance-data';

-- 查看表结构
DESC coin_kline_scores;
DESC trading_symbols;

-- 清空评分表（重新计算）
TRUNCATE TABLE coin_kline_scores;
CALL update_all_coin_scores();

-- 检查最后更新时间
SELECT MAX(updated_at) as last_update FROM coin_kline_scores;
```

## 🐛 故障排查

### 1. 定时任务未执行

```sql
-- 检查event_scheduler是否开启
SHOW VARIABLES LIKE 'event_scheduler';

-- 如果是OFF，开启它
SET GLOBAL event_scheduler = ON;

-- 检查事件状态
SHOW EVENTS;
```

### 2. 评分表无数据

```bash
# 1. 检查交易对配置表
mysql> SELECT COUNT(*) FROM trading_symbols;

# 2. 如果为空，同步交易对
python sync_symbols_to_db.py

# 3. 手动执行一次更新
mysql> CALL update_all_coin_scores();
```

### 3. 评分长时间未更新

```sql
-- 查看最后更新时间
SELECT symbol, updated_at
FROM coin_kline_scores
ORDER BY updated_at DESC
LIMIT 10;

-- 如果长时间未更新，检查K线数据
SELECT COUNT(*) FROM kline_data
WHERE symbol = 'BTC/USDT'
  AND timeframe = '1h'
  AND open_time > DATE_SUB(NOW(), INTERVAL 1 DAY);
```

## 📌 总结

**优势：**
- ✅ 全自动：MySQL定时任务，无需额外进程
- ✅ 高效：预计算结果，查询极快
- ✅ 可靠：数据库层面保证，不会丢失
- ✅ 灵活：SQL直接查询，易于集成

**适用场景：**
- 实时显示市场热度
- 筛选做多/做空机会
- 共振检查的数据源
- 前端快速查询展示
