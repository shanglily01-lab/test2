# 🎯 V2评分系统集成说明

## 📋 集成概述

V2评分系统已成功集成到 `smart_trader_service.py`，现在所有交易信号都会经过V2评分过滤，只有符合评分标准的信号才会被执行。

## 🔧 已修改的文件

### 1. smart_trader_service.py

**修改位置1**: 第29行 - 添加导入
```python
from app.services.signal_score_v2_service import SignalScoreV2Service
```

**修改位置2**: 第67行 - 初始化V2服务变量
```python
# 初始化V2评分服务（基于数据库预计算评分）
self.score_v2_service = None  # 延迟初始化，在_load_config中创建
```

**修改位置3**: 第235-249行 - 在_load_config方法中初始化V2服务
```python
# 8. 初始化V2评分服务
try:
    score_v2_config = config.get('signals', {}).get('resonance_filter', {})
    self.score_v2_service = SignalScoreV2Service(self.db_config, score_v2_config)

    if score_v2_config.get('enabled', True):
        logger.info(f"   ✅ V2评分过滤已启用:")
        logger.info(f"      代币最低评分: {score_v2_config.get('min_symbol_score', 15)}")
        logger.info(f"      Big4最低评分: {score_v2_config.get('min_big4_score', 10)}")
        logger.info(f"      要求方向一致: {score_v2_config.get('require_same_direction', True)}")
        logger.info(f"      共振阈值: {score_v2_config.get('resonance_threshold', 25)}")
    else:
        logger.info(f"   ⚠️  V2评分过滤已禁用")
except Exception as v2_error:
    logger.warning(f"   ⚠️  V2评分服务初始化失败: {v2_error}, 将继续使用传统信号过滤")
    self.score_v2_service = None
```

**修改位置4**: 第700-710行 - 在analyze方法中添加V2评分过滤
```python
# 🔥 新增: V2评分过滤
if self.score_v2_service:
    filter_result = self.score_v2_service.check_score_filter(symbol, side)
    if not filter_result['passed']:
        logger.info(f"🚫 {symbol} V2评分过滤: {filter_result['reason']}")
        return None
    else:
        # 评分通过，记录详细信息
        coin_score = filter_result.get('coin_score')
        if coin_score:
            logger.info(f"✅ {symbol} V2评分通过: 总分{coin_score['total_score']:+d} 方向{coin_score['direction']} 强度{coin_score['strength_level']}")
```

## ⚙️ 配置说明

V2评分过滤通过 `config.yaml` 中的 `resonance_filter` 部分进行配置：

```yaml
signals:
  resonance_filter:
    enabled: true              # 是否启用V2评分过滤
    min_symbol_score: 15       # 代币最低评分（绝对值）
    min_big4_score: 10         # Big4最低评分（绝对值）
    require_same_direction: true  # 是否要求方向一致
    resonance_threshold: 25    # 共振总分阈值（绝对值之和）
```

### 配置参数详解

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | bool | true | 是否启用V2评分过滤。false时所有信号直接通过 |
| `min_symbol_score` | int | 15 | 代币最低评分（绝对值）。评分低于此值的信号会被拒绝 |
| `min_big4_score` | int | 10 | Big4最低评分（绝对值）。如果有Big4数据，低于此值会被拒绝 |
| `require_same_direction` | bool | true | 是否要求代币、Big4、信号三者方向一致 |
| `resonance_threshold` | int | 25 | 共振总分阈值。代币评分+Big4评分必须>=此值 |

## 🚀 工作流程

### 信号过滤流程

```
1. SmartDecisionBrain.analyze() 生成原始信号
   ↓
2. 传统过滤（黑名单、信号矛盾、高风险位置）
   ↓
3. 🆕 V2评分过滤
   ├─ 获取代币评分（从coin_kline_scores表）
   ├─ 获取Big4评分（从big4_kline_scores表，可选）
   ├─ 检查代币评分是否达标
   ├─ 检查Big4评分是否达标（如果有）
   ├─ 检查方向是否一致
   └─ 检查共振总分是否达标
   ↓
4. 通过所有过滤，返回信号
```

### 过滤规则优先级

1. **代币评分不达标** - 最高优先级，直接拒绝
2. **Big4评分不达标** - 如果有Big4数据
3. **方向不一致** - 如果启用require_same_direction
4. **共振总分不达标** - 如果有Big4数据

## 📊 实际效果

### 示例1: 高分做多信号通过

```
输入: SOMI/USDT, 方向=LONG, 原始评分=120分
代币评分: +75分（强多）
结果: ✅ 通过
原因: SOMI/USDT 评分75达标（>=15），方向LONG匹配
```

### 示例2: 低分信号被拒绝

```
输入: BTC/USDT, 方向=LONG, 原始评分=85分
代币评分: +10分（中多）
结果: ❌ 拒绝
原因: BTC/USDT 评分10不达标（需>=15）
```

### 示例3: 方向不匹配被拒绝

```
输入: SOMI/USDT, 方向=SHORT, 原始评分=90分
代币评分: +75分（强多）
结果: ❌ 拒绝
原因: SOMI/USDT 方向不匹配：评分方向LONG vs 信号SHORT
```

## 🔍 日志示例

### 启动时日志

```
2026-02-15 19:41:32 | INFO     | ✅ V2评分过滤已启用:
2026-02-15 19:41:32 | INFO     |    代币最低评分: 15
2026-02-15 19:41:32 | INFO     |    Big4最低评分: 10
2026-02-15 19:41:32 | INFO     |    要求方向一致: True
2026-02-15 19:41:32 | INFO     |    共振阈值: 25
```

### 过滤通过日志

```
2026-02-15 19:45:12 | INFO     | ✅ SOMI/USDT V2评分通过: 总分+75 方向LONG 强度strong
```

### 过滤拒绝日志

```
2026-02-15 19:45:15 | INFO     | 🚫 BTC/USDT V2评分过滤: BTC/USDT 评分10不达标（需>=15）
2026-02-15 19:45:18 | INFO     | 🚫 SOMI/USDT V2评分过滤: SOMI/USDT 方向不匹配：评分方向LONG vs 信号SHORT
```

## 📝 测试验证

运行测试脚本验证集成：

```bash
# 测试V2评分系统
python test_signal_score_v2.py

# 测试集成到smart_trader
python test_v2_integration.py

# 查询当前评分
python query_coin_scores.py --top 30
```

## 🐛 故障排查

### 问题1: V2评分服务初始化失败

**现象**: 启动日志显示 "⚠️ V2评分服务初始化失败"

**原因**:
- config.yaml中没有resonance_filter配置
- 数据库连接失败

**解决**:
```yaml
# 在config.yaml中添加配置
signals:
  resonance_filter:
    enabled: true
    min_symbol_score: 15
    # ... 其他配置
```

### 问题2: 所有信号都被拒绝

**现象**: 日志显示 "🚫 {symbol} V2评分过滤: {symbol} 没有评分数据"

**原因**: coin_kline_scores表为空

**解决**:
```bash
# 手动触发评分更新
python trigger_score_update.py

# 或者等待MySQL定时任务自动更新（每5分钟）
```

### 问题3: Big4评分缺失警告

**现象**: 日志显示 "⚠️ 没有Big4评分数据，仅检查代币评分"

**原因**: big4_kline_scores表不存在

**解决**:
- 这是正常的，V2服务会自动降级为仅检查代币评分
- 如果需要Big4功能，需要创建对应的表和调度

## 🎯 优势对比

### V2评分系统 vs 传统信号过滤

| 特性 | 传统过滤 | V2评分过滤 |
|------|----------|-----------|
| 数据来源 | 实时计算 | 预计算数据库 |
| 响应速度 | 慢（每次计算） | 快（直接查询） |
| 过滤精度 | 基于单一信号 | 基于多周期共振 |
| 市场感知 | 无 | 有（市场情绪） |
| 可配置性 | 低 | 高（config.yaml） |

## 📌 注意事项

1. **评分数据更新频率**: MySQL定时任务每5分钟更新一次，信号可能有最多5分钟的延迟
2. **Big4表可选**: 如果没有Big4表，V2服务会自动降级为仅检查代币评分
3. **配置生效时间**: 修改config.yaml后需要重启smart_trader_service
4. **数据库依赖**: V2评分服务依赖数据库，如果数据库连接失败会禁用V2过滤
5. **向后兼容**: 如果V2服务初始化失败，会自动退回到传统过滤模式

## ✅ 集成完成

V2评分系统已完全集成到 smart_trader_service.py，所有交易信号都会经过严格的评分过滤，确保只执行高质量的交易机会！
