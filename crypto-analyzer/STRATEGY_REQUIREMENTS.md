# 交易策略需求文档 v3

> 根据用户反馈整理的策略需求，请审阅确认后开始开发。

---

## 一、当前策略问题总结

| 问题 | 描述 | 解决方案 |
|------|------|----------|
| 信号滞后 | EMA金叉/死叉确认时已错过最佳入场点 | 增加信号强度判断，强信号立即市价入场 |
| 趋势尾部入场 | 差值最大时往往是反转前兆 | 开仓后监控强度变化，减弱则平仓 |
| 方向判断错误 | 行情自适应有延迟 | 移除行情自适应，用EMA+MA方向一致性判断 |
| 止损止盈死板 | 固定百分比不适应不同行情 | 信号反转立即平仓，不依赖固定止损 |
| **止盈过早** | 没有获取到最大盈利就平仓了 | 使用移动止盈（跟踪止盈），保护利润的同时让盈利奔跑 |
| **止损不及时** | 亏损没有及时止住 | 实时监控价格，触发止损立即市价平仓 |

---

## 二、开仓信号设计

### 2.1 信号类型
只使用以下两种信号源：
- **EMA 9/26 15分钟周期**（主信号）
- **EMA 9/26 5分钟周期**（辅助确认）

### 2.2 信号强度要求
```
信号强度 = |EMA9 - EMA26| / EMA26 × 100%

最小开仓强度阈值：0.15%

规则：信号强度 < 0.15% → 不开仓（即使金叉/死叉也不开）
```

### 2.3 开仓条件（4种场景）

#### 场景1：金叉/死叉开仓
```
条件：
1. EMA9 上穿/下穿 EMA26（金叉/死叉）
2. 信号强度 >= 0.15%
3. EMA方向 与 MA方向 一致
4. 不需要看成交量

执行：市价单立即开仓
```

#### 场景2：强信号立即开仓
```
条件：
1. 金叉/死叉刚形成
2. 信号强度 >= 0.5%（高强度）
3. EMA方向 与 MA方向 一致
4. 不需要看成交量

执行：市价单立即开仓（不等待确认）
```

#### 场景3：连续趋势开仓
```
条件：
1. 已处于趋势中（EMA9 > EMA26 或 EMA9 < EMA26）
2. 15M EMA差值放大
3. 5M EMA差值 连续3根K线 放大
4. 未发生反转信号
5. 不需要看成交量

执行：市价开仓
监控：开仓后30分钟检查强度，连续减弱则平仓
```

#### 场景4：震荡区间反向开仓
```
条件：
1. 连续4根K线为阳线或阴线
2. 这4根K线的最高价与最低价差值 < 0.5%（横盘震荡）
3. 成交量条件：
   - 连续阳线 → 成交量缩量（预示上涨乏力）→ 做空
   - 连续阴线 → 成交量放量（预示抛压释放）→ 做多

执行：市价开仓

成交量判断：
- 缩量：当前K线成交量 < 前4根K线平均成交量的80%
- 放量：当前K线成交量 > 前4根K线平均成交量的120%
```

### 2.4 EMA+MA方向一致性过滤（所有场景必须满足）
```
检查项：
- EMA9 vs EMA26 方向
- 价格 vs MA10 位置

规则：
- 做多：EMA9 > EMA26 且 价格 > MA10
- 做空：EMA9 < EMA26 且 价格 < MA10
- 方向不一致 → 不开仓
```

---

## 三、平仓信号设计

### 3.1 强制平仓条件

| 条件 | 说明 | 优先级 |
|------|------|--------|
| 金叉/死叉反转 | 持多仓遇死叉 / 持空仓遇金叉，立即平仓 | 最高 |
| 趋势反转 | EMA方向反转，立即平仓 | 最高 |
| 强度持续减弱 | 开仓30分钟后，连续检测强度减弱 | 高 |
| 保底止损 | 亏损达到-2.5% | 中 |
| 保底止盈 | 盈利达到+4% | 中 |

### 3.2 平仓逻辑详解

#### 3.2.1 金叉/死叉反转平仓
```
规则：
- 持有多仓 + 检测到死叉 → 立即市价平仓（不论强度）
- 持有空仓 + 检测到金叉 → 立即市价平仓（不论强度）

原因：趋势已经反转，不等待
```

#### 3.2.2 趋势反转平仓
```
规则：
- 持有多仓 + EMA9 < EMA26 → 立即平仓
- 持有空仓 + EMA9 > EMA26 → 立即平仓
```

#### 3.2.3 强度减弱平仓（连续趋势开仓专用）
```
监控逻辑：
- 开仓后等待30分钟
- 每5分钟检查一次EMA差值
- 如果连续3次差值减小 → 平仓

示例：
开仓强度: 0.5%
30min后: 0.48% (减弱)
35min后: 0.45% (减弱)
40min后: 0.42% (减弱) → 触发平仓
```

### 3.3 止损设计（改进版）

#### 问题：止损不及时
当前问题：价格快速下跌时，止损执行慢，导致亏损扩大。

#### 改进方案：实时止损
```
硬止损：-2.5%（绝对止损线，必须执行）

执行逻辑：
1. 开仓后立即在交易所设置止损单（STOP_MARKET）
2. 由交易所自动触发，不依赖本地程序监控
3. 本地程序每分钟检查一次作为备份

优势：
- 交易所止损单实时触发，不受网络延迟影响
- 即使程序崩溃，止损单仍然有效
```

### 3.4 止盈设计（改进版）

#### 问题：止盈过早
当前问题：固定止盈在+4%时平仓，但趋势可能继续，错过更大利润。

#### 改进方案：移动止盈（跟踪止盈）
```
触发条件：浮盈达到 +1.5% 后启动移动止盈

移动止盈逻辑：
1. 记录最高浮盈（做多）或最低浮盈（做空）
2. 从最高点回撤 1% 时平仓

示例（做多）：
- 入场价: 100
- 浮盈达到 +1.5% (101.5) → 启动移动止盈
- 价格涨到 103 (+3%) → 记录最高点 103
- 价格涨到 105 (+5%) → 更新最高点 105
- 价格回落到 103.95 (从最高点回撤1%) → 触发平仓
- 最终盈利: +3.95%（而不是固定+4%就平）

示例（趋势延续）：
- 入场价: 100
- 价格涨到 110 (+10%) → 最高点 110
- 价格回落到 108.9 (回撤1%) → 平仓
- 最终盈利: +8.9%（远超固定止盈）
```

#### 保底止盈
```
最大止盈：+8%（无论如何都平仓，防止贪婪）

说明：即使移动止盈未触发，盈利达到8%也强制平仓
```

### 3.5 止损止盈参数汇总
```
| 类型 | 参数 | 说明 |
|------|------|------|
| 硬止损 | -2.5% | 交易所止损单，实时触发 |
| 移动止盈启动 | +1.5% | 浮盈超过此值启动跟踪 |
| 移动止盈回撤 | 1% | 从最高点回撤此值平仓 |
| 最大止盈 | +8% | 保底止盈，强制平仓 |
```

---

## 四、信号过滤器

### 4.1 必须启用的过滤器

| 过滤器 | 规则 | 说明 |
|--------|------|------|
| 信号强度 | 差值 >= 0.15% | 过滤弱信号 |
| EMA+MA一致 | 方向必须一致 | 过滤假信号 |

### 4.2 关闭的过滤器

| 过滤器 | 状态 | 原因 |
|--------|------|------|
| RSI | 关闭 | 简化逻辑 |
| MACD | 关闭 | 简化逻辑 |
| KDJ | 关闭 | 简化逻辑 |
| 成交量 | 仅震荡场景启用 | 金叉/死叉/趋势开仓不需要 |

---

## 五、多周期配合

### 5.1 时间周期
- **主周期**：15分钟（金叉/死叉信号源）
- **辅助周期**：5分钟（连续趋势确认，需连续3根K线）

### 5.2 连续趋势开仓的多周期逻辑
```
条件：
- 15M EMA差值正在放大
- 5M EMA差值 连续3根K线 放大
- 两个周期方向一致

任一周期发生反转 → 平仓
```

---

## 六、执行方式

### 6.1 订单类型
| 场景 | 订单类型 | 原因 |
|------|----------|------|
| 金叉/死叉开仓 | 市价单 | 信号确认后立即执行 |
| 强信号开仓 | 市价单 | 不错过强趋势 |
| 连续趋势开仓 | 市价单 | 趋势放大时快速入场 |
| 震荡反向开仓 | 市价单 | 预判反转需快速 |
| 所有平仓 | 市价单 | 平仓必须快 |

### 6.2 开仓后监控
```
连续趋势开仓后：
- 等待30分钟
- 每5分钟检查强度
- 连续3次减弱则平仓

其他开仓后：
- 实时监控金叉/死叉反转
- 反转立即平仓
```

---

## 七、确认参数

| 参数 | 确认值 |
|------|--------|
| 最小开仓强度阈值 | 0.15% |
| 高强度阈值（立即开仓） | 0.5% |
| 震荡区间判断幅度 | 0.5% |
| 连续K线数（震荡判断） | 4根 |
| 5M连续放大K线数（趋势开仓） | 3根 |
| 强度减弱监控开始时间 | 30分钟 |
| 强度减弱连续次数 | 3次 |
| 硬止损 | -2.5%（交易所止损单） |
| 移动止盈启动阈值 | +1.5% |
| 移动止盈回撤 | 1% |
| 最大止盈 | +8% |
| 成交量缩量阈值 | <80% (前4根均值) |
| 成交量放量阈值 | >120% (前4根均值) |

| 杠杆倍数 | 默认10X，可选5X/20X |
| 单笔开仓金额 | 账户资金总量的5% |

---

## 八、策略执行流程图

```
┌─────────────────────────────────────────────────────────────┐
│                      每分钟执行                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  1. 获取 EMA9/26 数据（15M + 5M）+ MA10 + 成交量            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 检查是否有持仓                                           │
│     ├─ 有持仓 → 检查平仓条件                                 │
│     │    ├─ 金叉/死叉反转？ → 立即平仓                       │
│     │    ├─ 趋势反转？ → 立即平仓                            │
│     │    ├─ 强度连续减弱？（连续趋势开仓专用）→ 平仓         │
│     │    └─ 触发止损/止盈？ → 平仓                           │
│     │                                                        │
│     └─ 无持仓 → 检查开仓条件                                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 开仓条件检查（按优先级）                                  │
│     ├─ 检查 EMA+MA 方向一致性（必须满足）                    │
│     │                                                        │
│     ├─ 场景1: 金叉/死叉 + 强度>=0.15% → 市价开仓            │
│     ├─ 场景2: 金叉/死叉 + 强度>=0.5% → 立即市价开仓         │
│     ├─ 场景3: 15M放大 + 5M连续3根放大 → 市价开仓            │
│     └─ 场景4: 4根同向K线 + 幅度<0.5% + 成交量条件           │
│              → 反向市价开仓                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 开仓后设置                                               │
│     ├─ 设置保底止损(-2.5%)止盈(+4%)                         │
│     └─ 如果是连续趋势开仓 → 启动30分钟后强度监控             │
└─────────────────────────────────────────────────────────────┘
```

---

## 九、与现有系统的差异

| 功能 | 当前实现 | 新需求 |
|------|----------|--------|
| 信号强度过滤 | 有，但弱信号也可能开仓 | 强度<0.15%绝对不开仓 |
| EMA/MA一致性 | 可选 | 必须一致才开仓 |
| 震荡反向开仓 | 无 | 新增（含成交量判断） |
| 5M连续趋势确认 | 无 | 新增（连续3根K线放大） |
| 开仓后强度监控 | 无 | 新增（30分钟后监控） |
| 金叉反转平仓 | 有，但会检查强度 | 不检查强度，直接平仓 |
| 行情自适应 | 有 | 移除 |
| 限价单 | 支持 | 全部改为市价单 |
| 成交量过滤 | 可选 | 仅震荡场景启用 |

---

## 十、确认清单

请确认以下事项：

- [ ] 开仓逻辑已理解并确认
- [ ] 平仓逻辑已理解并确认
- [ ] 参数已填写完成（杠杆、金额）
- [ ] 同意移除行情自适应
- [ ] 同意全部使用市价单
- [ ] 同意开始开发

**确认签字**：____________________
**日期**：____________________

---

> 确认后我将开始实现新策略逻辑。
