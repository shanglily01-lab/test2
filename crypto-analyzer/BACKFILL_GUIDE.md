# åŽ†å²æ•°æ®å›žå¡«æŒ‡å—

## ðŸ“– æ¦‚è¿°

`backfill_historical_data.py` è„šæœ¬ç”¨äºŽå›žå¡«æŒ‡å®šæ—¥æœŸèŒƒå›´çš„åŽ†å² Kçº¿æ•°æ®å’Œä»·æ ¼æ•°æ®ã€‚

## ðŸŽ¯ åŠŸèƒ½ç‰¹æ€§

- âœ… æ”¯æŒå¤šä¸ªæ—¶é—´å‘¨æœŸï¼š1åˆ†é’Ÿã€5åˆ†é’Ÿã€15åˆ†é’Ÿã€1å°æ—¶
- âœ… æ”¯æŒå¤šä¸ªäº¤æ˜“æ‰€ï¼šBinanceã€Gate.io
- âœ… è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“
- âœ… æ•°æ®éªŒè¯åŠŸèƒ½
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
- âœ… è‡ªåŠ¨å¤„ç† API é™åˆ¶å’Œå»¶è¿Ÿ

## ðŸ“… é»˜è®¤é…ç½®

```python
START_DATE = '2025-10-29'  # å¼€å§‹æ—¥æœŸ
END_DATE = '2025-11-04'    # ç»“æŸæ—¥æœŸ
TIMEFRAMES = ['1m', '5m', '15m', '1h']  # æ—¶é—´å‘¨æœŸ
```

## ðŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1ï¼šç›´æŽ¥è¿è¡Œï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰

```bash
cd crypto-analyzer
python backfill_historical_data.py
```

è¿™å°†å›žå¡« **2025-10-29 ~ 2025-11-04** çš„æ•°æ®ã€‚

### æ–¹æ³• 2ï¼šè‡ªå®šä¹‰æ—¥æœŸèŒƒå›´

ç¼–è¾‘è„šæœ¬ä¸­çš„é…ç½®ï¼š

```python
# ä¿®æ”¹ backfill_historical_data.py ç¬¬ 254-256 è¡Œ
START_DATE = '2025-11-01'  # æ”¹ä¸ºä½ éœ€è¦çš„å¼€å§‹æ—¥æœŸ
END_DATE = '2025-11-05'    # æ”¹ä¸ºä½ éœ€è¦çš„ç»“æŸæ—¥æœŸ
TIMEFRAMES = ['15m', '1h']  # åªå›žå¡« 15åˆ†é’Ÿå’Œ1å°æ—¶æ•°æ®
```

ç„¶åŽè¿è¡Œï¼š
```bash
python backfill_historical_data.py
```

## ðŸ“Š æ‰§è¡Œæµç¨‹

è„šæœ¬æ‰§è¡Œåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

### é˜¶æ®µ 1ï¼šå›žå¡« Kçº¿æ•°æ®

```
====================================================
æ—¶é—´å‘¨æœŸ: 1m
====================================================
[1/16] BTC/USDT
  æ­£åœ¨ä»Ž binance èŽ·å–æ•°æ®...
  âœ“ binance ä¿å­˜ 678 æ ¹Kçº¿
  âœ“ BTC/USDT æ€»è®¡ä¿å­˜ 678 æ ¹Kçº¿

[2/16] ETH/USDT
  æ­£åœ¨ä»Ž binance èŽ·å–æ•°æ®...
  âœ“ binance ä¿å­˜ 678 æ ¹Kçº¿
  âœ“ ETH/USDT æ€»è®¡ä¿å­˜ 678 æ ¹Kçº¿
...
```

### é˜¶æ®µ 2ï¼šèŽ·å–å½“å‰ä»·æ ¼æ•°æ®

```
====================================================
å¼€å§‹èŽ·å–å½“å‰ä»·æ ¼æ•°æ®
====================================================
[1/16] BTC/USDT
  âœ“ [binance] ä»·æ ¼: $43,250.00 (24h: +2.30%)
  âœ“ [gate] ä»·æ ¼: $43,248.50 (24h: +2.28%)
```

### é˜¶æ®µ 3ï¼šéªŒè¯æ•°æ®

```
====================================================
éªŒè¯å›žå¡«æ•°æ®
====================================================
æ—¶é—´å‘¨æœŸ: 1m
------------------------------------------------------------
  BTC/USDT [binance]: 678 æ ¹Kçº¿ (10-29 00:00 ~ 11-04 23:59)
  ETH/USDT [binance]: 678 æ ¹Kçº¿ (10-29 00:00 ~ 11-04 23:59)
```

## ðŸ“ æ—¥å¿—æ–‡ä»¶

æ—¥å¿—ä¼šä¿å­˜åˆ°ï¼š
```
logs/backfill_2025-11-05.log
```

æ—¥å¿—åŒ…å«ï¼š
- æ¯ä¸ªå¸å¯¹çš„èŽ·å–è¿›åº¦
- ä¿å­˜çš„Kçº¿æ•°é‡
- é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æžœæœ‰ï¼‰
- æœ€ç»ˆç»Ÿè®¡

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. API é™åˆ¶

- è„šæœ¬å·²åŒ…å«å»¶è¿Ÿæœºåˆ¶ï¼ˆæ¯ä¸ªè¯·æ±‚é—´éš” 0.5-1 ç§’ï¼‰
- å¦‚æžœé‡åˆ° API é™åˆ¶é”™è¯¯ï¼Œè¯·å¢žåŠ å»¶è¿Ÿæ—¶é—´

ä¿®æ”¹å»¶è¿Ÿï¼š
```python
# ç¬¬ 157 è¡Œå’Œç¬¬ 171 è¡Œ
await asyncio.sleep(1)  # æ”¹ä¸º 2 æˆ–æ›´å¤§çš„å€¼
```

### 2. æ•°æ®é‡ä¼°ç®—

| æ—¶é—´å‘¨æœŸ | 6å¤©æ•°æ®é‡ | é¢„è®¡æ—¶é—´ |
|---------|----------|---------|
| 1åˆ†é’Ÿ | ~8,640æ ¹/å¸å¯¹ | è¾ƒé•¿ |
| 5åˆ†é’Ÿ | ~1,728æ ¹/å¸å¯¹ | ä¸­ç­‰ |
| 15åˆ†é’Ÿ | ~576æ ¹/å¸å¯¹ | è¾ƒå¿« |
| 1å°æ—¶ | ~144æ ¹/å¸å¯¹ | å¾ˆå¿« |

**å»ºè®®**ï¼š
- é¦–æ¬¡å›žå¡«å»ºè®®åªé€‰æ‹©å¿…éœ€çš„æ—¶é—´å‘¨æœŸï¼ˆå¦‚ 15m, 1hï¼‰
- å¦‚æžœéœ€è¦ 1åˆ†é’Ÿæ•°æ®ï¼Œå¯ä»¥åˆ†æ‰¹æ¬¡å›žå¡«

### 3. æ•°æ®åº“è¿žæŽ¥

ç¡®ä¿ï¼š
- MySQL æœåŠ¡æ­£åœ¨è¿è¡Œ
- `config.yaml` ä¸­çš„æ•°æ®åº“é…ç½®æ­£ç¡®
- æ•°æ®åº“ç”¨æˆ·æœ‰å†™å…¥æƒé™

### 4. äº¤æ˜“æ‰€æ”¯æŒ

è„šæœ¬ä¼šè‡ªåŠ¨å°è¯•ä»Žä»¥ä¸‹äº¤æ˜“æ‰€èŽ·å–æ•°æ®ï¼š
1. **Binance**ï¼ˆä¼˜å…ˆï¼‰
2. **Gate.io**ï¼ˆå¤‡é€‰ï¼‰

å¦‚æžœæŸä¸ªå¸å¯¹åœ¨ Binance ä¸Šä¸å¯ç”¨ï¼Œä¼šè‡ªåŠ¨å°è¯• Gate.ioã€‚

## ðŸ”§ é«˜çº§é…ç½®

### åªå›žå¡«ç‰¹å®šå¸å¯¹

ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ç¬¬ 31 è¡Œï¼š

```python
# åŽŸä»£ç 
self.symbols = self.config.get('symbols', ['BTC/USDT', 'ETH/USDT'])

# æ”¹ä¸ºåªå›žå¡«ç‰¹å®šå¸å¯¹
self.symbols = ['BTC/USDT', 'ETH/USDT', 'SOL/USDT']
```

### è°ƒæ•´ API å¹¶å‘æ•°

å¦‚æžœç½‘ç»œæ¡ä»¶å¥½ï¼Œå¯ä»¥å¢žåŠ å¹¶å‘ï¼š

åœ¨ `backfill_klines` æ–¹æ³•ä¸­æ·»åŠ å¹¶å‘å¤„ç†ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰

### è‡ªå®šä¹‰æ•°æ®éªŒè¯

ä¿®æ”¹ `verify_data` æ–¹æ³•æ¥å¢žåŠ æ›´å¤šéªŒè¯é€»è¾‘ï¼Œä¾‹å¦‚ï¼š
- æ£€æŸ¥æ•°æ®è¿žç»­æ€§
- æ£€æŸ¥ä»·æ ¼å¼‚å¸¸
- ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

## ðŸ“ˆ é¢„æœŸç»“æžœ

æˆåŠŸè¿è¡ŒåŽï¼Œæ•°æ®åº“ä¸­ä¼šæœ‰ï¼š

### kline_data è¡¨

```sql
SELECT symbol, timeframe, exchange, COUNT(*) as count
FROM kline_data
WHERE open_time >= UNIX_TIMESTAMP('2025-10-29') * 1000
  AND open_time < UNIX_TIMESTAMP('2025-11-05') * 1000
GROUP BY symbol, timeframe, exchange
ORDER BY symbol, timeframe;
```

### ç¤ºä¾‹è¾“å‡ºï¼š

| symbol | timeframe | exchange | count |
|--------|-----------|----------|-------|
| BTC/USDT | 1m | binance | 8,640 |
| BTC/USDT | 5m | binance | 1,728 |
| BTC/USDT | 15m | binance | 576 |
| BTC/USDT | 1h | binance | 144 |
| ETH/USDT | 1m | binance | 8,640 |
| ... | ... | ... | ... |

## ðŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šè¿žæŽ¥è¶…æ—¶

**é”™è¯¯ä¿¡æ¯**ï¼š
```
RequestTimeout: binance GET https://api.binance.com/api/v3/klines
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿žæŽ¥
- ä½¿ç”¨ VPNï¼ˆå¦‚æžœåœ¨å—é™åœ°åŒºï¼‰
- å¢žåŠ å»¶è¿Ÿæ—¶é—´

### é—®é¢˜ 2ï¼šæŸäº›å¸å¯¹æ— æ•°æ®

**é”™è¯¯ä¿¡æ¯**ï¼š
```
âŠ— NEWCOIN/USDT æœªä¿å­˜ä»»ä½•æ•°æ®
```

**åŽŸå› **ï¼š
- è¯¥å¸å¯¹å¯èƒ½åœ¨å›žå¡«æ—¥æœŸèŒƒå›´å†…å°šæœªä¸Šçº¿
- äº¤æ˜“æ‰€ä¸æ”¯æŒè¯¥å¸å¯¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å¸å¯¹åœ¨äº¤æ˜“æ‰€çš„ä¸Šçº¿æ—¥æœŸ
- ä»Ž `config.yaml` çš„ `symbols` åˆ—è¡¨ä¸­ç§»é™¤

### é—®é¢˜ 3ï¼šæ•°æ®é‡å¤

**çŽ°è±¡**ï¼š
æ•°æ®åº“ä¸­æœ‰é‡å¤çš„Kçº¿è®°å½•

**åŽŸå› **ï¼š
- å¤šæ¬¡è¿è¡Œå›žå¡«è„šæœ¬

**è§£å†³æ–¹æ¡ˆ**ï¼š
æ•°æ®åº“ä¼šè‡ªåŠ¨å¤„ç†ï¼ˆä½¿ç”¨ UNIQUE KEYï¼‰ï¼Œé‡å¤æ•°æ®ä¼šè¢«å¿½ç•¥æˆ–æ›´æ–°ã€‚

### é—®é¢˜ 4ï¼šå†…å­˜ä¸è¶³

**é”™è¯¯ä¿¡æ¯**ï¼š
```
MemoryError
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å‡å°‘ä¸€æ¬¡å›žå¡«çš„æ—¶é—´èŒƒå›´
- åˆ†æ‰¹æ¬¡å›žå¡«ï¼ˆå¦‚æ¯æ¬¡å›žå¡«1-2å¤©ï¼‰

## ðŸ“š ç›¸å…³æ–‡ä»¶

- [app/collectors/price_collector.py](app/collectors/price_collector.py) - ä»·æ ¼æ•°æ®é‡‡é›†å™¨
- [app/database/db_service.py](app/database/db_service.py) - æ•°æ®åº“æœåŠ¡
- [config.yaml](config.yaml) - é…ç½®æ–‡ä»¶

## âœ… éªŒè¯æ•°æ®

è¿è¡Œè¯Šæ–­è„šæœ¬æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®ï¼š

```bash
python diagnose_ema_signals.py
```

æŸ¥çœ‹ "æ­¥éª¤ 3/6: æ£€æŸ¥ 15åˆ†é’Ÿ Kçº¿æ•°æ®" éƒ¨åˆ†ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š

```
âœ“ BTC/USDT:
    æ•°æ®é‡: 576 æ¡ (éœ€è¦è‡³å°‘ 31 æ¡)
    æ—¶é—´èŒƒå›´: 144.0 å°æ—¶
    æœ€æ–°æ•°æ®: 5.2 åˆ†é’Ÿå‰
```

## ðŸŽ‰ æˆåŠŸæ ‡å¿—

å½“çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºæ—¶ï¼Œè¡¨ç¤ºå›žå¡«æˆåŠŸï¼š

```
====================================================
âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼
====================================================
```

æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ç¡®è®¤ï¼š
- æ¯ä¸ªå¸å¯¹éƒ½æœ‰æ•°æ®ä¿å­˜
- é”™è¯¯æ•°é‡ä¸º 0 æˆ–å¾ˆå°‘
- éªŒè¯é˜¶æ®µæ˜¾ç¤ºé¢„æœŸçš„æ•°æ®é‡

---

**æç¤º**ï¼šé¦–æ¬¡å›žå¡«å»ºè®®å…ˆä½¿ç”¨è¾ƒçŸ­çš„æ—¥æœŸèŒƒå›´ï¼ˆå¦‚1-2å¤©ï¼‰æµ‹è¯•ï¼Œç¡®è®¤æ— è¯¯åŽå†å›žå¡«å®Œæ•´èŒƒå›´ã€‚
