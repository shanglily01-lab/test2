# 破位系统集成文档

## 概述

破位系统已成功集成到 `SmartDecisionBrain`，提供完整的Big4破位检测、信号加权、持仓管理和收敛机制。

## 核心功能

### 1. Big4破位检测
- 自动检测 BTC/ETH/BNB/SOL 的破位信号
- 基于三大特征验证：24H极值、无影线、成交量
- 加权评分：BTC 40%, ETH 30%, BNB 15%, SOL 15%

### 2. 信号加权
- **同向信号**：根据破位强度加分 +20~+50
  - 强度 90+: +50分
  - 强度 80-90: +40分
  - 强度 70-80: +30分
  - 强度 <70: +20分

- **反向信号**：根据破位强度降分 -20~-50
  - 强度 90+: 完全阻止反向开仓
  - 强度 80+: 评分<90时阻止
  - 强度 70+: 评分<80时阻止

### 3. 持仓管理
- **自动平反向持仓**：
  - 强度 90+: 无条件平掉所有反向仓位
  - 强度 80+: 平掉亏损的反向仓位
  - 强度 70+: 平掉大幅亏损的反向仓位（>5%保证金）

- **调整同向止损**：
  - 强度 90+: 放宽止损到 1.5%
  - 强度 80+: 放宽止损到 1.2%

### 4. 收敛机制
- **时间收敛**：
  - 最大有效期：4小时
  - 开仓窗口：30分钟

- **数量收敛**：
  - 强度 90+: 最多5次开仓
  - 强度 80-90: 最多4次开仓
  - 强度 70-80: 最多3次开仓

- **价格收敛**：
  - 价格反转超过1%则破位失效

- **趋势收敛**：
  - 趋势反向移动2%则停止信号

## 使用方法

### 初始化

```python
from app.services.smart_decision_brain import SmartDecisionBrain

# 初始化（需要提供exchange以启用破位系统）
db_config = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'your_password',
    'database': 'binance-data'
}

brain = SmartDecisionBrain(db_config, exchange=exchange)
```

### 检测破位

```python
# 检测Big4破位（可传入当前持仓）
current_positions = {
    'DOGE/USDT': {
        'side': 'LONG',
        'entry_price': 0.08,
        'quantity': 10000,
        'margin': 800,
        'unrealized_pnl': -50,
        'stop_loss': 0.079
    }
}

breakout_result = brain.check_breakout(current_positions)

if breakout_result['has_breakout']:
    market = breakout_result['market']
    print(f"破位方向: {market['direction']}")
    print(f"破位强度: {market['strength']}")

    # 查看持仓处理结果
    pos_result = breakout_result['position_result']
    print(f"平仓数量: {len(pos_result['closed'])}")
    print(f"调整数量: {len(pos_result['adjusted'])}")
```

### 信号评分（含破位加权）

```python
# 方式1: 自动分析（只做LONG方向）
result = brain.should_trade('WIF/USDT')

# 方式2: 提供基础评分和方向
result = brain.should_trade(
    symbol='DOGE/USDT',
    base_score=75,
    signal_direction='SHORT'
)

print(f"基础分: {result['base_score']}")
print(f"破位加权: {result['breakout_boost']:+d}")
print(f"总分: {result['score']}")
print(f"是否开仓: {result['decision']}")
```

### 查看破位状态

```python
status = brain.get_breakout_status()

if status['active']:
    print(f"破位方向: {status['market']['direction']}")
    print(f"破位强度: {status['market']['strength']}")
    print(f"已开仓: {status['convergence']['opened_count']}")
    print(f"最多开仓: {status['convergence']['max_openings']}")
    print(f"剩余窗口: {status['convergence']['remaining_window']/60}分钟")
```

## 集成要点

### 1. 破位检测周期
建议在主循环中每5分钟检测一次Big4破位：

```python
import time

while True:
    # 检测破位
    breakout_result = brain.check_breakout(current_positions)

    if breakout_result['has_breakout']:
        # 处理破位事件
        handle_breakout(breakout_result)

    # 其他交易逻辑
    # ...

    time.sleep(300)  # 5分钟
```

### 2. 信号生成流程

```python
# 伪代码示例
for symbol in candidate_symbols:
    # 1. 计算基础评分（技术分析）
    base_score = calculate_base_score(symbol)

    # 2. 调用should_trade进行破位加权
    result = brain.should_trade(
        symbol=symbol,
        base_score=base_score,
        signal_direction='SHORT'  # 或 'LONG'
    )

    # 3. 如果通过评分，自动记录开仓
    if result['decision']:
        # 破位系统会自动调用record_opening(symbol)
        execute_trade(symbol, result)
```

### 3. 持仓管理集成

```python
# 定期更新持仓信息
def update_positions():
    positions = {}

    for order in active_orders:
        positions[order['symbol']] = {
            'side': order['side'],
            'entry_price': order['entry_price'],
            'quantity': order['quantity'],
            'margin': order['margin'],
            'unrealized_pnl': order['unrealized_pnl'],
            'stop_loss': order['stop_loss']
        }

    return positions

# 在破位检测时传入持仓
current_positions = update_positions()
breakout_result = brain.check_breakout(current_positions)
```

## 测试

### 单元测试

```bash
# 测试破位系统各组件
python test_breakout_system.py
```

### 集成测试

```bash
# 测试完整集成
python test_breakout_integration.py
```

## 文件结构

```
app/services/
├── big4_breakout_detector.py      # Big4破位检测器
├── breakout_signal_booster.py     # 信号加权器
├── breakout_position_manager.py   # 持仓管理器
├── breakout_convergence.py        # 收敛机制
├── breakout_system.py             # 系统集成
└── smart_decision_brain.py        # 主决策系统（已集成）

test_breakout_system.py            # 单元测试
test_breakout_integration.py       # 集成测试
```

## 配置参数

### 破位检测阈值

```python
# big4_breakout_detector.py
FEATURE_WEIGHTS = {
    'breakout_24h': 40,      # 24H极值权重
    'candle_pattern': 30,    # K线形态权重
    'volume_surge': 30       # 成交量权重
}

THRESHOLDS = {
    'min_score': 70,         # 最低破位评分
    'shadow_ratio': 0.2,     # 影线比例阈值
    'body_ratio': 0.6,       # 实体比例阈值
    'volume_multiplier': 1.5 # 成交量倍数
}
```

### 收敛参数

```python
# breakout_convergence.py
config = {
    'max_duration': 4 * 3600,      # 4小时失效
    'opening_window': 30 * 60,     # 30分钟窗口
    'max_openings_90+': 5,         # 极强破位最多5次
    'max_openings_80_90': 4,       # 强破位最多4次
    'max_openings_70_80': 3,       # 中等破位最多3次
    'reversal_threshold': 0.01,    # 1%反转
    'trend_end_threshold': 0.02    # 2%趋势结束
}
```

## 注意事项

1. **破位检测需要实时K线数据**：
   - 确保exchange接口可用
   - 使用5分钟K线，至少288根（24小时）

2. **破位信号有效期**：
   - 破位信号最长有效4小时
   - 开仓窗口仅30分钟
   - 超时后需要重新检测

3. **同一币种只开一次**：
   - 收敛机制会阻止同一币种重复开仓
   - 即使在开仓窗口内也不会重复

4. **反向信号会被过滤**：
   - 强破位时（80+），反向信号几乎无法通过
   - 需要特别高的基础评分才能覆盖负加权

5. **持仓管理需要完整信息**：
   - 传入的持仓字典必须包含所有必要字段
   - 特别是 `unrealized_pnl` 用于判断是否平仓

## 性能考虑

- **破位检测频率**：建议5分钟一次，不要过于频繁
- **K线数据量**：每次检测需要4个币种 × 288根K线 = 1152根
- **数据库连接**：使用连接池，避免频繁创建连接
- **异步处理**：建议将破位检测放在独立线程

## 未来优化方向

1. **动态参数调整**：
   - 根据市场状况自动调整收敛参数
   - 根据胜率动态调整加权强度

2. **更多时间周期**：
   - 目前只支持5分钟K线
   - 可以考虑15分钟、1小时的破位

3. **更多币种**：
   - 扩展Big4到Big10
   - 增加币种权重配置

4. **机器学习优化**：
   - 使用历史数据训练最优参数
   - 预测破位持续时间

5. **风险控制**：
   - 破位失败的快速止损
   - 多重破位的叠加处理

## 总结

破位系统已完全集成到 `SmartDecisionBrain`，提供：

✅ 自动Big4破位检测
✅ 智能信号加权（同向+分，反向-分）
✅ 自动持仓管理（平反向仓，调同向止损）
✅ 四维收敛机制（时间、数量、价格、趋势）
✅ 完整的测试覆盖

系统已准备就绪，可以投入实盘使用。建议先在模拟环境充分测试，验证各项功能正常后再上线。
